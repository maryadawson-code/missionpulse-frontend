<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOE Builder ‚Äî MissionPulse</title>
<link rel="icon" type="image/png" sizes="32x32" href="MMT_icon_32px.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="mp-rbac.js"></script>
<style>
body{background:#00050F;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
.glow-border{border:1px solid rgba(0,229,250,0.2);box-shadow:0 0 15px rgba(0,229,250,0.03)}
.cui-banner{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#EF4444;font-size:11px;font-weight:700;text-align:center;padding:6px;letter-spacing:1px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:50}
.modal-overlay.show{display:flex}
</style>
</head>
<body class="text-slate-300 min-h-screen">
<!-- CUI Banner -->
<div class="cui-banner">CUI // CONTROLLED UNCLASSIFIED INFORMATION ‚Äî PRICING DATA</div>

<div class="max-w-7xl mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <a href="dashboard.html" class="text-slate-500 hover:text-cyan-400 text-sm">‚Üê Dashboard</a>
        <h1 class="text-2xl font-bold text-white">BOE Builder</h1>
      </div>
      <p class="text-slate-500 text-sm mt-1">Basis of Estimate ‚Äî labor categories, rates, and pricing</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="dataBadge" class="text-xs px-2 py-1 rounded font-mono"></span>
      <button onclick="openAddModal()" class="bg-cyan-500 hover:bg-cyan-400 text-[#00050F] px-4 py-2 rounded-lg text-sm font-semibold mp-edit">+ Add Line Item</button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <div class="bg-[#0A1628] border border-slate-800 rounded-lg p-3 text-center"><div class="text-xl font-bold text-white" id="statItems">0</div><div class="text-xs text-slate-500">Line Items</div></div>
    <div class="bg-[#0A1628] border border-slate-800 rounded-lg p-3 text-center"><div class="text-xl font-bold text-cyan-400" id="statTotal">$0</div><div class="text-xs text-slate-500">Total Value</div></div>
    <div class="bg-[#0A1628] border border-slate-800 rounded-lg p-3 text-center"><div class="text-xl font-bold text-amber-400" id="statAvgRate">$0</div><div class="text-xs text-slate-500">Avg Rate</div></div>
    <div class="bg-[#0A1628] border border-slate-800 rounded-lg p-3 text-center"><div class="text-xl font-bold text-green-400" id="statCLINs">0</div><div class="text-xs text-slate-500">CLINs</div></div>
  </div>

  <!-- Table -->
  <div class="glow-border rounded-xl overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-[#0A1628] text-left text-xs text-slate-400 uppercase tracking-wider">
          <th class="px-4 py-3">CLIN</th>
          <th class="px-4 py-3">Description</th>
          <th class="px-4 py-3">Labor Category</th>
          <th class="px-4 py-3 text-right">Qty</th>
          <th class="px-4 py-3">Unit</th>
          <th class="px-4 py-3 text-right">Unit Price</th>
          <th class="px-4 py-3 text-right">Extended</th>
          <th class="px-4 py-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody" class="divide-y divide-slate-800"></tbody>
      <tfoot>
        <tr class="bg-[#0A1628] border-t border-slate-700">
          <td colspan="6" class="px-4 py-3 text-right text-sm font-bold text-white">TOTAL</td>
          <td class="px-4 py-3 text-right text-sm font-bold text-cyan-400" id="totalValue">$0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <div id="emptyState" class="hidden text-center py-12 text-slate-500">
      <div class="text-3xl mb-2">üí∞</div>
      <p>No pricing line items yet.</p>
      <button onclick="openAddModal()" class="text-cyan-400 hover:text-cyan-300 text-sm mt-2">Add your first line item ‚Üí</button>
    </div>
  </div>
  <div class="text-center mt-8 text-xs text-slate-600">CUI // MISSION MEETS TECH ¬∑ AI GENERATED ‚Äî REQUIRES HUMAN REVIEW</div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="bg-[#0A1628] border border-slate-700 rounded-xl p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-bold text-white mb-4" id="modalTitle">Add Line Item</h3>
    <input type="hidden" id="editId">
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div><label class="block text-xs text-slate-400 mb-1">CLIN</label><input id="fClin" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="0001"></div>
        <div><label class="block text-xs text-slate-400 mb-1">Labor Category</label><input id="fLcat" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Sr. Cloud Engineer"></div>
      </div>
      <div><label class="block text-xs text-slate-400 mb-1">Description</label><input id="fDesc" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Cloud migration support services"></div>
      <div class="grid grid-cols-3 gap-3">
        <div><label class="block text-xs text-slate-400 mb-1">Quantity</label><input id="fQty" type="number" step="0.5" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="2080"></div>
        <div><label class="block text-xs text-slate-400 mb-1">Unit</label>
          <select id="fUnit" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
            <option value="hours">Hours</option><option value="months">Months</option><option value="each">Each</option><option value="lot">Lot</option>
          </select>
        </div>
        <div><label class="block text-xs text-slate-400 mb-1">Unit Price ($)</label><input id="fPrice" type="number" step="0.01" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="185.00"></div>
      </div>
      <div><label class="block text-xs text-slate-400 mb-1">Basis of Estimate</label><textarea id="fBoe" rows="2" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Based on GSA MAS rate + 3 FTEs x 2080 hrs/yr..."></textarea></div>
      <div><label class="block text-xs text-slate-400 mb-1">Notes</label><input id="fNotes" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Optional"></div>
    </div>
    <div class="flex gap-3 mt-5">
      <button onclick="closeModal()" class="flex-1 py-2 rounded-lg text-sm border border-slate-600 text-slate-400 hover:border-slate-400">Cancel</button>
      <button onclick="saveItem()" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-cyan-500 text-[#00050F] hover:bg-cyan-400">Save</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL='https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
var sbClient;try{sbClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON)}catch(e){}

let items=[],companyId=null,isLive=false;
const fmt=n=>'$'+Number(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

const DEMO_DATA=[
  {id:'d1',clin:'0001',description:'Cloud Migration Services',labor_category:'Sr. Cloud Engineer',quantity:2080,unit:'hours',unit_price:195,extended_price:405600,basis_of_estimate:'GSA MAS rate, 1 FTE',notes:''},
  {id:'d2',clin:'0001',description:'Cloud Migration Services',labor_category:'Cloud Architect',quantity:1040,unit:'hours',unit_price:225,extended_price:234000,basis_of_estimate:'GSA MAS rate, 0.5 FTE',notes:''},
  {id:'d3',clin:'0002',description:'Help Desk Support',labor_category:'IT Specialist II',quantity:4160,unit:'hours',unit_price:95,extended_price:395200,basis_of_estimate:'2 FTEs, shift coverage',notes:'24/7 coverage'},
  {id:'d4',clin:'0003',description:'Program Management',labor_category:'Program Manager',quantity:2080,unit:'hours',unit_price:210,extended_price:436800,basis_of_estimate:'1 FTE dedicated PM',notes:''},
];

(async()=>{
  if(!sbClient){useDemoMode();return}
  const{data:{session}}=await sbClient.auth.getSession();
  if(!session){useDemoMode();return}
  const{data:profile}=await sbClient.from('profiles').select('company_id').eq('id',session.user.id).single();
  if(!profile?.company_id){useDemoMode();return}
  companyId=profile.company_id;
  await loadFromSupabase();
})();

async function loadFromSupabase(){
  const{data,error}=await sbClient.from('pricing_items').select('*').order('clin',{ascending:true});
  if(error){useDemoMode();return}
  items=data;isLive=true;
  document.getElementById('dataBadge').textContent='Live ‚Äî Supabase';
  document.getElementById('dataBadge').className='text-xs px-2 py-1 rounded font-mono bg-green-900 text-green-300';
  renderTable();
}

function useDemoMode(){
  items=DEMO_DATA;isLive=false;
  document.getElementById('dataBadge').textContent='Demo Mode';
  document.getElementById('dataBadge').className='text-xs px-2 py-1 rounded font-mono bg-amber-900 text-amber-300';
  renderTable();
}

function updateStats(){
  const total=items.reduce((s,i)=>s+(Number(i.extended_price)||Number(i.unit_price||0)*Number(i.quantity||0)),0);
  const rates=items.map(i=>Number(i.unit_price||0)).filter(r=>r>0);
  const avg=rates.length?rates.reduce((a,b)=>a+b,0)/rates.length:0;
  const clins=[...new Set(items.map(i=>i.clin).filter(Boolean))];
  document.getElementById('statItems').textContent=items.length;
  document.getElementById('statTotal').textContent=fmt(total);
  document.getElementById('statAvgRate').textContent=fmt(avg);
  document.getElementById('statCLINs').textContent=clins.length;
  document.getElementById('totalValue').textContent=fmt(total);
}

function renderTable(){
  updateStats();
  const tbody=document.getElementById('tableBody');
  if(items.length===0){tbody.innerHTML='';document.getElementById('emptyState').classList.remove('hidden');return}
  document.getElementById('emptyState').classList.add('hidden');
  tbody.innerHTML=items.map(i=>{
    const ext=Number(i.extended_price)||Number(i.unit_price||0)*Number(i.quantity||0);
    return `
    <tr class="hover:bg-[#0A1628] transition-colors">
      <td class="px-4 py-3 text-sm font-mono text-cyan-400">${i.clin||'‚Äî'}</td>
      <td class="px-4 py-3 text-sm text-white">${i.description}</td>
      <td class="px-4 py-3 text-sm">${i.labor_category||'‚Äî'}</td>
      <td class="px-4 py-3 text-sm text-right font-mono">${Number(i.quantity||0).toLocaleString()}</td>
      <td class="px-4 py-3 text-sm capitalize">${i.unit||'hours'}</td>
      <td class="px-4 py-3 text-sm text-right font-mono">${fmt(i.unit_price)}</td>
      <td class="px-4 py-3 text-sm text-right font-mono text-white font-semibold">${fmt(ext)}</td>
      <td class="px-4 py-3 text-right">
        <button onclick="editItem('${i.id}')" class="text-slate-500 hover:text-cyan-400 text-xs mr-2">Edit</button>
        <button onclick="deleteItem('${i.id}')" class="text-slate-500 hover:text-red-400 text-xs">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function openAddModal(){
  document.getElementById('modalTitle').textContent='Add Line Item';
  document.getElementById('editId').value='';
  ['fClin','fLcat','fDesc','fQty','fPrice','fBoe','fNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fUnit').value='hours';
  document.getElementById('modal').classList.add('show');
}

function editItem(id){
  const item=items.find(i=>i.id===id);if(!item)return;
  document.getElementById('modalTitle').textContent='Edit Line Item';
  document.getElementById('editId').value=id;
  document.getElementById('fClin').value=item.clin||'';
  document.getElementById('fLcat').value=item.labor_category||'';
  document.getElementById('fDesc').value=item.description||'';
  document.getElementById('fQty').value=item.quantity||'';
  document.getElementById('fUnit').value=item.unit||'hours';
  document.getElementById('fPrice').value=item.unit_price||'';
  document.getElementById('fBoe').value=item.basis_of_estimate||'';
  document.getElementById('fNotes').value=item.notes||'';
  document.getElementById('modal').classList.add('show');
}

function closeModal(){document.getElementById('modal').classList.remove('show')}

async function saveItem(){
  const id=document.getElementById('editId').value;
  const qty=parseFloat(document.getElementById('fQty').value)||0;
  const price=parseFloat(document.getElementById('fPrice').value)||0;
  const row={
    clin:document.getElementById('fClin').value.trim(),
    description:document.getElementById('fDesc').value.trim(),
    labor_category:document.getElementById('fLcat').value.trim(),
    quantity:qty,
    unit:document.getElementById('fUnit').value,
    unit_price:price,
    extended_price:qty*price,
    basis_of_estimate:document.getElementById('fBoe').value.trim(),
    notes:document.getElementById('fNotes').value.trim(),
  };
  if(!row.description){alert('Description is required');return}
  if(isLive){
    row.company_id=companyId;row.updated_at=new Date().toISOString();
    if(id){await sbClient.from('pricing_items').update(row).eq('id',id)}
    else{await sbClient.from('pricing_items').insert(row)}
    await loadFromSupabase();
  }else{
    if(id){const idx=items.findIndex(i=>i.id===id);if(idx>=0)items[idx]={...items[idx],...row}}
    else{items.push({id:'d'+Date.now(),...row})}
    renderTable();
  }
  closeModal();
}

async function deleteItem(id){
  if(!confirm('Delete this line item?'))return;
  if(isLive){await sbClient.from('pricing_items').delete().eq('id',id);await loadFromSupabase()}
  else{items=items.filter(i=>i.id!==id);renderTable()}
}
</script>
</body>
</html>

