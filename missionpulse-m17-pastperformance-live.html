<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Performance | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; }
        body { background: linear-gradient(135deg, #00050F 0%, #001a2c 50%, #00050F 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); backdrop-filter: blur(10px); }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #00E5FA, #00b8d4); color: #00050F; font-weight: 600; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
        .rating-exceptional { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .rating-very-good { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .rating-satisfactory { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .rating-marginal { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
        .rating-unsatisfactory { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .status-active { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status-completed { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .status-expired { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .status-do-not-use { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .tag { background: rgba(0, 229, 250, 0.15); color: #00E5FA; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body class="text-white font-sans">
    <!-- Header -->
    <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-cyan-400 hover:text-cyan-300"><i class="fas fa-arrow-left"></i></a>
                <div>
                    <h1 class="text-xl font-bold text-cyan-400"><i class="fas fa-trophy mr-2"></i>Past Performance Database</h1>
                    <p class="text-xs text-gray-400">Contract History & Reference Management</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="connectionStatus" class="text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400">
                    <i class="fas fa-circle text-[8px] mr-1"></i> Connecting...
                </span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-cyan-400" id="totalContracts">0</div>
                <div class="text-xs text-gray-400">Total Contracts</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-400" id="activeContracts">0</div>
                <div class="text-xs text-gray-400">Active</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-cyan-400" id="totalValue">$0</div>
                <div class="text-xs text-gray-400">Portfolio Value</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-400" id="avgRating">--</div>
                <div class="text-xs text-gray-400">Avg CPARS</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-400" id="primeCount">0</div>
                <div class="text-xs text-gray-400">Prime Contracts</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" onkeyup="filterContracts()" placeholder="Search contracts, clients, NAICS..." class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
            </div>
            <select id="filterAgency" onchange="filterContracts()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Agencies</option>
                <option value="VA">VA</option>
                <option value="DHA">DHA</option>
                <option value="CMS">CMS</option>
                <option value="IHS">IHS</option>
                <option value="HHS">HHS</option>
                <option value="DoD">DoD</option>
            </select>
            <select id="filterStatus" onchange="filterContracts()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Statuses</option>
                <option value="Active">Active</option>
                <option value="Completed">Completed</option>
                <option value="Expired">Expired</option>
            </select>
            <select id="filterRating" onchange="filterContracts()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Ratings</option>
                <option value="Exceptional">Exceptional</option>
                <option value="Very Good">Very Good</option>
                <option value="Satisfactory">Satisfactory</option>
            </select>
            <button onclick="openContractModal()" class="btn-primary px-4 py-2 rounded text-sm">
                <i class="fas fa-plus mr-2"></i>Add Contract
            </button>
        </div>

        <!-- Contracts Grid -->
        <div id="contractsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="glass-card rounded-lg p-8 text-center text-gray-500 col-span-full">
                <i class="fas fa-trophy text-4xl mb-4 opacity-50"></i>
                <p>Loading past performance records...</p>
            </div>
        </div>
    </main>

    <!-- Contract Modal -->
    <div id="contractModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-card rounded-xl max-w-4xl w-full p-6 my-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-file-contract mr-2"></i><span id="modalTitle">Add Past Performance</span></h3>
                <button onclick="closeContractModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="contractForm" onsubmit="saveContract(event)" class="space-y-6">
                <input type="hidden" id="contractId">
                
                <!-- Basic Info -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contract Name <span class="text-red-400">*</span></label>
                        <input type="text" id="contractName" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., VA EHR Support Services">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contract Number</label>
                        <input type="text" id="contractNumber" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., VA118-16-D-1234">
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Client Agency <span class="text-red-400">*</span></label>
                        <input type="text" id="clientAgency" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., Department of Veterans Affairs">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Client Office</label>
                        <input type="text" id="clientOffice" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., OIT">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contract Vehicle</label>
                        <input type="text" id="contractVehicle" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., T4NG, VETS2">
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contract Type</label>
                        <select id="contractType" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="FFP">FFP</option>
                            <option value="T&M">T&M</option>
                            <option value="Cost-Plus">Cost-Plus</option>
                            <option value="CPFF">CPFF</option>
                            <option value="IDIQ">IDIQ</option>
                            <option value="BPA">BPA</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">NAICS Code</label>
                        <input type="text" id="naicsCode" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 541512">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Set-Aside</label>
                        <select id="setAside" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="None">None</option>
                            <option value="Full & Open">Full & Open</option>
                            <option value="SDVOSB">SDVOSB</option>
                            <option value="8(a)">8(a)</option>
                            <option value="HUBZone">HUBZone</option>
                            <option value="WOSB">WOSB</option>
                            <option value="Small Business">Small Business</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Prime/Sub</label>
                        <select id="primeOrSub" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Prime">Prime</option>
                            <option value="Subcontractor">Subcontractor</option>
                            <option value="JV Partner">JV Partner</option>
                            <option value="Teaming">Teaming</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">PoP Start</label>
                        <input type="date" id="popStart" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">PoP End</label>
                        <input type="date" id="popEnd" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Total Contract Value</label>
                        <input type="number" id="totalValue" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 5000000">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Our Value</label>
                        <input type="number" id="ourValue" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 2500000">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">CPARS Rating</label>
                        <select id="cparsRating" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="N/A">N/A</option>
                            <option value="Exceptional">Exceptional</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Satisfactory">Satisfactory</option>
                            <option value="Marginal">Marginal</option>
                            <option value="Unsatisfactory">Unsatisfactory</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Status</label>
                        <select id="contractStatus" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Active">Active</option>
                            <option value="Completed">Completed</option>
                            <option value="Expired">Expired</option>
                            <option value="Do Not Use">Do Not Use</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Relevance Tags (comma separated)</label>
                    <input type="text" id="relevanceTags" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., EHR, Healthcare IT, Cybersecurity, Cloud Migration">
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Key Accomplishments</label>
                    <textarea id="accomplishments" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Quantifiable achievements, metrics, outcomes..."></textarea>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Performance Summary</label>
                    <textarea id="performanceSummary" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Brief narrative for proposal use..."></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeContractModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save Contract</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-xl max-w-lg w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-user-tie mr-2"></i>Reference Contact</h3>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="contactForm" onsubmit="saveContact(event)" class="space-y-4">
                <input type="hidden" id="contactId">
                <input type="hidden" id="contactPPId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name <span class="text-red-400">*</span></label>
                        <input type="text" id="contactName" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Type</label>
                        <select id="contactType" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="COR">COR</option>
                            <option value="CO">CO</option>
                            <option value="PM">PM</option>
                            <option value="COTR">COTR</option>
                            <option value="Technical Lead">Technical Lead</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Title</label>
                    <input type="text" id="contactTitle" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <input type="email" id="contactEmail" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Phone</label>
                        <input type="tel" id="contactPhone" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Organization</label>
                    <input type="text" id="contactOrg" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="contactPrimary" class="rounded">
                    <label for="contactPrimary" class="text-sm text-gray-400">Primary Contact</label>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeContactModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-card rounded-xl max-w-4xl w-full p-6 my-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400" id="detailTitle">Contract Details</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-cyan-500/10 mt-12 py-6 text-center text-xs text-gray-500">
        <p>AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
        <p class="mt-1">MissionPulse v2.0 | Mission Meets Tech | Shield & Pulse UX v8.0</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTc0NjMsImV4cCI6MjA1Mjk5MzQ2M30.GXfKRTONeK0kCHk9WJzJzeG3sEaH15uPlFwczw4MXCg';
        
        let supabase;
        let contracts = [], contacts = [];

        // Demo Data
        const demoContracts = [
            { id: 'pp1', contract_name: 'VA EHR Modernization Support', contract_number: 'VA118-20-D-1234', client_agency: 'VA', client_office: 'OIT', contract_type: 'T&M', naics_code: '541512', set_aside: 'SDVOSB', prime_or_sub: 'Prime', period_of_performance_start: '2020-10-01', period_of_performance_end: '2025-09-30', total_contract_value: 45000000, our_contract_value: 45000000, cpars_rating: 'Exceptional', status: 'Active', relevance_tags: ['EHR', 'Healthcare IT', 'VA', 'Modernization'], key_accomplishments: 'Migrated 50,000 patient records with zero downtime. Achieved 99.9% system uptime. Reduced processing time by 40%.', times_used: 8 },
            { id: 'pp2', contract_name: 'DHA Cybersecurity Operations', contract_number: 'HT0011-19-C-0042', client_agency: 'DHA', client_office: 'J-6', contract_type: 'CPFF', naics_code: '541519', set_aside: 'Full & Open', prime_or_sub: 'Subcontractor', prime_contractor: 'Leidos', period_of_performance_start: '2019-04-01', period_of_performance_end: '2024-03-31', total_contract_value: 120000000, our_contract_value: 28000000, cpars_rating: 'Very Good', status: 'Completed', relevance_tags: ['Cybersecurity', 'DoD', 'Healthcare', 'RMF'], key_accomplishments: 'Achieved ATO for 12 systems. Zero security incidents. Implemented continuous monitoring.', times_used: 12 },
            { id: 'pp3', contract_name: 'CMS Data Analytics Platform', contract_number: 'CMS-75-0000-123', client_agency: 'CMS', client_office: 'OIT', contract_type: 'FFP', naics_code: '541511', set_aside: 'Small Business', prime_or_sub: 'Prime', period_of_performance_start: '2022-01-15', period_of_performance_end: '2027-01-14', total_contract_value: 32000000, our_contract_value: 32000000, cpars_rating: 'Very Good', status: 'Active', relevance_tags: ['Data Analytics', 'Healthcare', 'Cloud', 'AWS'], key_accomplishments: 'Built predictive analytics reducing fraud by $50M annually. Processed 1B+ claims records.', times_used: 5 },
            { id: 'pp4', contract_name: 'IHS Telehealth Implementation', contract_number: 'IHS-283-2021-00567', client_agency: 'IHS', client_office: 'Division of IT', contract_type: 'T&M', naics_code: '541512', set_aside: 'SDVOSB', prime_or_sub: 'Prime', period_of_performance_start: '2021-06-01', period_of_performance_end: '2024-05-31', total_contract_value: 8500000, our_contract_value: 8500000, cpars_rating: 'Exceptional', status: 'Completed', relevance_tags: ['Telehealth', 'Healthcare IT', 'Rural Health', 'Video Conferencing'], key_accomplishments: 'Deployed telehealth to 45 remote clinics. Increased patient access by 300%.', times_used: 3 }
        ];
        const demoContacts = [
            { id: 'c1', past_performance_id: 'pp1', contact_type: 'COR', name: 'James Wilson', title: 'Contracting Officer Representative', email: 'james.wilson@va.gov', phone: '202-555-0101', is_primary: true },
            { id: 'c2', past_performance_id: 'pp1', contact_type: 'PM', name: 'Sarah Chen', title: 'Program Manager', email: 'sarah.chen@va.gov', phone: '202-555-0102', is_primary: false },
            { id: 'c3', past_performance_id: 'pp2', contact_type: 'COR', name: 'Michael Brown', title: 'COR', email: 'michael.brown@health.mil', phone: '703-555-0201', is_primary: true },
            { id: 'c4', past_performance_id: 'pp3', contact_type: 'CO', name: 'Emily Davis', title: 'Contracting Officer', email: 'emily.davis@cms.hhs.gov', phone: '410-555-0301', is_primary: true }
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const [ppRes, contactRes] = await Promise.all([
                    supabase.from('past_performance').select('*').order('created_at', { ascending: false }),
                    supabase.from('past_performance_contacts').select('*')
                ]);
                contracts = ppRes.data?.length ? ppRes.data : demoContracts;
                contacts = contactRes.data?.length ? contactRes.data : demoContacts;
                updateStatus('connected', 'Live');
            } catch (e) {
                console.log('Demo mode:', e.message);
                contracts = demoContracts;
                contacts = demoContacts;
                updateStatus('demo', 'Demo Mode');
            }
            updateStats();
            renderContracts();
        }

        function updateStatus(type, text) {
            const el = document.getElementById('connectionStatus');
            el.className = type === 'connected' 
                ? 'text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400'
                : 'text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            el.innerHTML = `<i class="fas fa-circle text-[8px] mr-1"></i> ${text}`;
        }

        function updateStats() {
            const active = contracts.filter(c => c.status === 'Active').length;
            const totalVal = contracts.reduce((sum, c) => sum + (parseFloat(c.our_contract_value) || 0), 0);
            const primes = contracts.filter(c => c.prime_or_sub === 'Prime').length;
            const rated = contracts.filter(c => c.cpars_rating && c.cpars_rating !== 'N/A');
            const ratingMap = { 'Exceptional': 5, 'Very Good': 4, 'Satisfactory': 3, 'Marginal': 2, 'Unsatisfactory': 1 };
            const avgRating = rated.length ? (rated.reduce((sum, c) => sum + (ratingMap[c.cpars_rating] || 0), 0) / rated.length).toFixed(1) : '--';
            const ratingLabels = { 5: 'Exceptional', 4: 'Very Good', 3: 'Satisfactory', 2: 'Marginal', 1: 'Unsatisfactory' };

            document.getElementById('totalContracts').textContent = contracts.length;
            document.getElementById('activeContracts').textContent = active;
            document.getElementById('totalValue').textContent = '$' + (totalVal / 1000000).toFixed(1) + 'M';
            document.getElementById('avgRating').textContent = avgRating !== '--' ? ratingLabels[Math.round(avgRating)] || avgRating : '--';
            document.getElementById('primeCount').textContent = primes;
        }

        function filterContracts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const agency = document.getElementById('filterAgency').value;
            const status = document.getElementById('filterStatus').value;
            const rating = document.getElementById('filterRating').value;

            const filtered = contracts.filter(c => {
                if (search && !JSON.stringify(c).toLowerCase().includes(search)) return false;
                if (agency && !c.client_agency?.includes(agency)) return false;
                if (status && c.status !== status) return false;
                if (rating && c.cpars_rating !== rating) return false;
                return true;
            });
            renderContracts(filtered);
        }

        function renderContracts(list = contracts) {
            const grid = document.getElementById('contractsGrid');
            if (!list.length) {
                grid.innerHTML = `<div class="glass-card rounded-lg p-8 text-center text-gray-500 col-span-full">
                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                    <p>No contracts found matching your criteria</p>
                </div>`;
                return;
            }

            grid.innerHTML = list.map(c => {
                const statusClass = `status-${c.status?.toLowerCase().replace(/\s+/g, '-')}`;
                const ratingClass = `rating-${c.cpars_rating?.toLowerCase().replace(/\s+/g, '-')}`;
                const tags = c.relevance_tags || [];
                const contactCount = contacts.filter(ct => ct.past_performance_id === c.id).length;

                return `
                    <div class="glass-card rounded-lg p-4 cursor-pointer hover:border-cyan-400/50 transition-all" onclick="showDetail('${c.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-white truncate">${c.contract_name}</h4>
                                <p class="text-xs text-gray-400">${c.contract_number || 'No contract #'}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${statusClass}">${c.status}</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Client:</span>
                                <span class="text-white">${c.client_agency}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Value:</span>
                                <span class="text-cyan-400">$${((c.our_contract_value || 0) / 1000000).toFixed(1)}M</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Role:</span>
                                <span class="text-white">${c.prime_or_sub}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">CPARS:</span>
                                <span class="text-xs px-2 py-1 rounded ${ratingClass}">${c.cpars_rating || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 mt-3">
                            ${tags.slice(0, 3).map(t => `<span class="tag">${t}</span>`).join('')}
                            ${tags.length > 3 ? `<span class="tag">+${tags.length - 3}</span>` : ''}
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-700/50 text-xs text-gray-500">
                            <span><i class="fas fa-user-tie mr-1"></i>${contactCount} contacts</span>
                            <span><i class="fas fa-file-alt mr-1"></i>Used ${c.times_used || 0}x</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDetail(id) {
            const c = contracts.find(x => x.id === id);
            if (!c) return;
            const ppContacts = contacts.filter(ct => ct.past_performance_id === id);
            
            document.getElementById('detailTitle').textContent = c.contract_name;
            document.getElementById('detailContent').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-info-circle mr-2"></i>Contract Info</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Contract #:</span><span>${c.contract_number || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Agency:</span><span>${c.client_agency}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Office:</span><span>${c.client_office || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Type:</span><span>${c.contract_type || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Vehicle:</span><span>${c.contract_vehicle || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">NAICS:</span><span>${c.naics_code || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Set-Aside:</span><span>${c.set_aside || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Role:</span><span>${c.prime_or_sub}${c.prime_contractor ? ` (under ${c.prime_contractor})` : ''}</span></div>
                            </div>
                        </div>
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-dollar-sign mr-2"></i>Financials & Period</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Total Value:</span><span class="text-cyan-400">$${((c.total_contract_value || 0) / 1000000).toFixed(2)}M</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Our Value:</span><span class="text-cyan-400">$${((c.our_contract_value || 0) / 1000000).toFixed(2)}M</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">PoP:</span><span>${c.period_of_performance_start || '?'} to ${c.period_of_performance_end || '?'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-star mr-2"></i>Performance</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-400">CPARS Rating:</span>
                                    <span class="px-2 py-1 rounded rating-${c.cpars_rating?.toLowerCase().replace(/\s+/g, '-')}">${c.cpars_rating || 'N/A'}</span>
                                </div>
                            </div>
                            ${c.key_accomplishments ? `<div class="mt-3 pt-3 border-t border-gray-700/50"><p class="text-xs text-gray-400 mb-1">Key Accomplishments:</p><p class="text-sm">${c.key_accomplishments}</p></div>` : ''}
                            ${c.performance_summary ? `<div class="mt-3 pt-3 border-t border-gray-700/50"><p class="text-xs text-gray-400 mb-1">Summary:</p><p class="text-sm">${c.performance_summary}</p></div>` : ''}
                        </div>
                        <div class="glass-card rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-cyan-400"><i class="fas fa-user-tie mr-2"></i>Reference Contacts</h4>
                                <button onclick="event.stopPropagation(); openContactModal('${id}')" class="text-xs text-cyan-400 hover:text-cyan-300"><i class="fas fa-plus mr-1"></i>Add</button>
                            </div>
                            ${ppContacts.length ? ppContacts.map(ct => `
                                <div class="p-2 bg-gray-800/50 rounded mb-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium">${ct.name}</span>
                                        <span class="text-xs text-gray-400">${ct.contact_type}</span>
                                    </div>
                                    <div class="text-xs text-gray-400">${ct.title || ''}</div>
                                    <div class="text-xs text-cyan-400">${ct.email || ''} ${ct.phone || ''}</div>
                                </div>
                            `).join('') : '<p class="text-sm text-gray-500">No contacts added</p>'}
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-4">
                    ${(c.relevance_tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
                </div>
                <div class="flex gap-3 mt-6 pt-4 border-t border-gray-700">
                    <button onclick="editContract('${id}')" class="btn-primary px-4 py-2 rounded text-sm"><i class="fas fa-edit mr-2"></i>Edit</button>
                    <button onclick="deleteContract('${id}')" class="px-4 py-2 border border-red-500/50 text-red-400 rounded text-sm hover:bg-red-500/10"><i class="fas fa-trash mr-2"></i>Delete</button>
                    <button onclick="copyToProposal('${id}')" class="px-4 py-2 border border-cyan-500/50 text-cyan-400 rounded text-sm hover:bg-cyan-500/10"><i class="fas fa-copy mr-2"></i>Copy for Proposal</button>
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        // Contract CRUD
        function openContractModal() {
            document.getElementById('contractForm').reset();
            document.getElementById('contractId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Past Performance';
            document.getElementById('contractModal').classList.remove('hidden');
        }

        function closeContractModal() {
            document.getElementById('contractModal').classList.add('hidden');
        }

        function editContract(id) {
            closeDetailModal();
            const c = contracts.find(x => x.id === id);
            if (!c) return;
            document.getElementById('contractId').value = c.id;
            document.getElementById('contractName').value = c.contract_name;
            document.getElementById('contractNumber').value = c.contract_number || '';
            document.getElementById('clientAgency').value = c.client_agency;
            document.getElementById('clientOffice').value = c.client_office || '';
            document.getElementById('contractVehicle').value = c.contract_vehicle || '';
            document.getElementById('contractType').value = c.contract_type || 'FFP';
            document.getElementById('naicsCode').value = c.naics_code || '';
            document.getElementById('setAside').value = c.set_aside || 'None';
            document.getElementById('primeOrSub').value = c.prime_or_sub || 'Prime';
            document.getElementById('popStart').value = c.period_of_performance_start || '';
            document.getElementById('popEnd').value = c.period_of_performance_end || '';
            document.getElementById('totalValue').value = c.total_contract_value || '';
            document.getElementById('ourValue').value = c.our_contract_value || '';
            document.getElementById('cparsRating').value = c.cpars_rating || 'N/A';
            document.getElementById('contractStatus').value = c.status || 'Active';
            document.getElementById('relevanceTags').value = (c.relevance_tags || []).join(', ');
            document.getElementById('accomplishments').value = c.key_accomplishments || '';
            document.getElementById('performanceSummary').value = c.performance_summary || '';
            document.getElementById('modalTitle').textContent = 'Edit Past Performance';
            document.getElementById('contractModal').classList.remove('hidden');
        }

        async function saveContract(e) {
            e.preventDefault();
            const id = document.getElementById('contractId').value;
            const data = {
                contract_name: document.getElementById('contractName').value,
                contract_number: document.getElementById('contractNumber').value || null,
                client_agency: document.getElementById('clientAgency').value,
                client_office: document.getElementById('clientOffice').value || null,
                contract_vehicle: document.getElementById('contractVehicle').value || null,
                contract_type: document.getElementById('contractType').value,
                naics_code: document.getElementById('naicsCode').value || null,
                set_aside: document.getElementById('setAside').value,
                prime_or_sub: document.getElementById('primeOrSub').value,
                period_of_performance_start: document.getElementById('popStart').value || null,
                period_of_performance_end: document.getElementById('popEnd').value || null,
                total_contract_value: parseFloat(document.getElementById('totalValue').value) || null,
                our_contract_value: parseFloat(document.getElementById('ourValue').value) || null,
                cpars_rating: document.getElementById('cparsRating').value,
                status: document.getElementById('contractStatus').value,
                relevance_tags: document.getElementById('relevanceTags').value.split(',').map(t => t.trim()).filter(Boolean),
                key_accomplishments: document.getElementById('accomplishments').value || null,
                performance_summary: document.getElementById('performanceSummary').value || null,
                updated_at: new Date().toISOString()
            };

            try {
                if (id) {
                    await supabase.from('past_performance').update(data).eq('id', id);
                    const idx = contracts.findIndex(c => c.id === id);
                    if (idx >= 0) contracts[idx] = { ...contracts[idx], ...data };
                } else {
                    const { data: newPP } = await supabase.from('past_performance').insert([data]).select().single();
                    if (newPP) contracts.unshift(newPP);
                    else contracts.unshift({ id: 'pp' + Date.now(), ...data, times_used: 0 });
                }
            } catch (e) {
                if (id) {
                    const idx = contracts.findIndex(c => c.id === id);
                    if (idx >= 0) contracts[idx] = { ...contracts[idx], ...data };
                } else {
                    contracts.unshift({ id: 'pp' + Date.now(), ...data, times_used: 0 });
                }
            }

            closeContractModal();
            updateStats();
            renderContracts();
        }

        async function deleteContract(id) {
            if (!confirm('Delete this past performance record?')) return;
            try { await supabase.from('past_performance').delete().eq('id', id); } catch (e) {}
            contracts = contracts.filter(c => c.id !== id);
            contacts = contacts.filter(c => c.past_performance_id !== id);
            closeDetailModal();
            updateStats();
            renderContracts();
        }

        // Contact CRUD
        function openContactModal(ppId) {
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('contactPPId').value = ppId;
            document.getElementById('contactModal').classList.remove('hidden');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.add('hidden');
        }

        async function saveContact(e) {
            e.preventDefault();
            const id = document.getElementById('contactId').value;
            const data = {
                past_performance_id: document.getElementById('contactPPId').value,
                contact_type: document.getElementById('contactType').value,
                name: document.getElementById('contactName').value,
                title: document.getElementById('contactTitle').value || null,
                email: document.getElementById('contactEmail').value || null,
                phone: document.getElementById('contactPhone').value || null,
                organization: document.getElementById('contactOrg').value || null,
                is_primary: document.getElementById('contactPrimary').checked
            };

            try {
                if (id) {
                    await supabase.from('past_performance_contacts').update(data).eq('id', id);
                    const idx = contacts.findIndex(c => c.id === id);
                    if (idx >= 0) contacts[idx] = { ...contacts[idx], ...data };
                } else {
                    const { data: newC } = await supabase.from('past_performance_contacts').insert([data]).select().single();
                    if (newC) contacts.push(newC);
                    else contacts.push({ id: 'c' + Date.now(), ...data });
                }
            } catch (e) {
                if (!id) contacts.push({ id: 'c' + Date.now(), ...data });
            }

            closeContactModal();
            showDetail(data.past_performance_id);
        }

        function copyToProposal(id) {
            const c = contracts.find(x => x.id === id);
            if (!c) return;
            const text = `CONTRACT: ${c.contract_name}\nContract #: ${c.contract_number || 'N/A'}\nClient: ${c.client_agency} - ${c.client_office || ''}\nValue: $${((c.our_contract_value || 0) / 1000000).toFixed(2)}M\nPeriod: ${c.period_of_performance_start} to ${c.period_of_performance_end}\nCPARS: ${c.cpars_rating || 'N/A'}\n\nKEY ACCOMPLISHMENTS:\n${c.key_accomplishments || 'N/A'}`;
            navigator.clipboard.writeText(text);
            alert('Past performance copied to clipboard!');
            
            // Increment usage
            c.times_used = (c.times_used || 0) + 1;
            try { supabase.from('past_performance').update({ times_used: c.times_used, last_used_date: new Date().toISOString().split('T')[0] }).eq('id', id); } catch (e) {}
            renderContracts();
        }

        init();
    </script>
</body>
</html>
