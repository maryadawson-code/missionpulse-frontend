<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Intel Capture | MissionPulse</title>
    <link rel="icon" type="image/png" href="MMT_icon_transparent.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mmt-cyan': '#00E5FA',
                        'mmt-navy': '#00050F',
                        'mmt-dark': '#0a0f1a',
                        'shield-green': '#10B981',
                        'alert-amber': '#F59E0B',
                        'alert-red': '#EF4444'
                    },
                    fontFamily: { 'inter': ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
        .glass-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(0,229,250,0.1); }
        .glow-pulse { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 20px rgba(0,229,250,0.3); } to { box-shadow: 0 0 40px rgba(0,229,250,0.6); } }
        .recording-pulse { animation: rec-pulse 1s ease-in-out infinite; }
        @keyframes rec-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .waveform-bar { animation: wave 0.5s ease-in-out infinite alternate; }
        @keyframes wave { from { transform: scaleY(0.3); } to { transform: scaleY(1); } }
    </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="min-h-screen text-white">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 glass-card border-b border-cyan-500/20">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2">
                    <img src="MMT_icon_transparent.png" alt="MMT" class="h-8 w-8">
                    <span class="text-mmt-cyan font-semibold hidden sm:inline">MissionPulse</span>
                </a>
                <span class="text-gray-500">/</span>
                <span class="text-white font-medium">Voice Intel</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400 hidden sm:inline">M29</span>
                <a href="m27-intel-tracker.html" class="text-xs bg-mmt-cyan/20 text-mmt-cyan px-3 py-1 rounded-full hover:bg-mmt-cyan/30 transition">
                    ‚Üí Intel Tracker
                </a>
            </div>
        </div>
    </header>

    <main class="pt-20 pb-8 px-4 max-w-4xl mx-auto">
        <!-- Recording Interface -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-white mb-2">üé§ Voice Intel Capture</h1>
                <p class="text-gray-400 text-sm">Record meetings & seminars ‚Ä¢ AI extracts competitive intel</p>
            </div>

            <!-- Recording Button -->
            <div class="flex flex-col items-center gap-6 mb-8">
                <button id="recordBtn" onclick="toggleRecording()" class="w-32 h-32 rounded-full bg-gradient-to-br from-mmt-cyan/20 to-mmt-cyan/5 border-2 border-mmt-cyan/50 flex items-center justify-center hover:border-mmt-cyan transition-all duration-300 group">
                    <div id="recordIcon" class="text-5xl group-hover:scale-110 transition-transform">üéôÔ∏è</div>
                </button>
                <div id="recordStatus" class="text-gray-400">Tap to start recording</div>
                <div id="recordTimer" class="text-3xl font-mono text-mmt-cyan hidden">00:00</div>
            </div>

            <!-- Waveform Visualization -->
            <div id="waveform" class="hidden h-16 flex items-center justify-center gap-1 mb-6">
                <!-- Dynamic bars added by JS -->
            </div>

            <!-- Meeting Details Form -->
            <div id="detailsForm" class="space-y-4 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Meeting Title</label>
                        <input type="text" id="meetingTitle" placeholder="Q1 Customer Discovery Call" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-mmt-cyan focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Meeting Type</label>
                        <select id="meetingType" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-mmt-cyan focus:outline-none">
                            <option value="customer_meeting">Customer Meeting</option>
                            <option value="industry_event">Industry Event / Conference</option>
                            <option value="competitor_intel">Competitor Intel</option>
                            <option value="internal_strategy">Internal Strategy</option>
                            <option value="partner_call">Partner Call</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Link to Opportunity (Optional)</label>
                    <select id="opportunityLink" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-mmt-cyan focus:outline-none">
                        <option value="">-- No linked opportunity --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Attendees (comma separated)</label>
                    <input type="text" id="attendees" placeholder="John Smith, Jane Doe, ACME Corp Rep" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-mmt-cyan focus:outline-none">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="processRecording()" class="flex-1 bg-gradient-to-r from-mmt-cyan to-cyan-400 text-mmt-navy font-semibold py-3 rounded-lg hover:opacity-90 transition">
                        üß† Process with AI
                    </button>
                    <button onclick="cancelRecording()" class="px-6 py-3 border border-white/20 rounded-lg text-gray-400 hover:text-white hover:border-white/40 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Processing Status -->
        <div id="processingCard" class="glass-card rounded-2xl p-6 mb-6 hidden">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-mmt-cyan/20 flex items-center justify-center">
                    <div class="animate-spin text-2xl">üß†</div>
                </div>
                <div class="flex-1">
                    <div class="text-white font-medium">Processing Recording...</div>
                    <div id="processingStatus" class="text-sm text-gray-400">Transcribing audio...</div>
                </div>
            </div>
            <div class="mt-4 h-2 bg-white/10 rounded-full overflow-hidden">
                <div id="processingBar" class="h-full bg-gradient-to-r from-mmt-cyan to-cyan-400 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Recent Recordings -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">üìã Recent Recordings</h2>
                <span id="recordingCount" class="text-xs bg-white/10 px-2 py-1 rounded-full text-gray-400">0 recordings</span>
            </div>
            <div id="recordingsList" class="space-y-3">
                <!-- Populated by JS -->
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üéß</div>
                    <div>No recordings yet</div>
                    <div class="text-sm">Record your first meeting to capture intel</div>
                </div>
            </div>
        </div>

        <!-- Extracted Intel Preview -->
        <div id="intelPreview" class="glass-card rounded-2xl p-6 mt-6 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">üéØ Extracted Intelligence</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                    <div class="text-blue-400 text-sm font-medium mb-2">Competitor Mentions</div>
                    <div id="competitorMentions" class="text-white">--</div>
                </div>
                <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4">
                    <div class="text-amber-400 text-sm font-medium mb-2">Pain Points</div>
                    <div id="painPoints" class="text-white">--</div>
                </div>
                <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                    <div class="text-green-400 text-sm font-medium mb-2">Action Items</div>
                    <div id="actionItems" class="text-white">--</div>
                </div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="sendToIntelTracker()" class="flex-1 bg-mmt-cyan/20 text-mmt-cyan py-2 rounded-lg hover:bg-mmt-cyan/30 transition">
                    üìä Add to Intel Tracker
                </button>
                <button onclick="exportIntel()" class="px-4 py-2 border border-white/20 rounded-lg text-gray-400 hover:text-white transition">
                    üì• Export
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-4 text-xs text-gray-500 border-t border-white/5">
        <p>AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
        <p class="mt-1">¬© 2025 Mission Meets Tech LLC. CMMC 2.0 Compliant.</p>
    </footer>

    <script>
        // Recording State
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let timerInterval = null;
        let audioBlob = null;

        // Demo recordings data
        let recordings = JSON.parse(localStorage.getItem('mp_voice_recordings') || '[]');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOpportunities();
            renderRecordings();
        });

        // Load opportunities for linking
        async function loadOpportunities() {
            const select = document.getElementById('opportunityLink');
            // Try Supabase first, fallback to demo data
            const demoOpps = [
                { id: '1', title: 'DHA MHS GENESIS Support', agency: 'DHA' },
                { id: '2', title: 'VA EHR Modernization', agency: 'VA' },
                { id: '3', title: 'CMS Data Analytics Platform', agency: 'CMS' }
            ];
            demoOpps.forEach(opp => {
                const option = document.createElement('option');
                option.value = opp.id;
                option.textContent = `${opp.agency}: ${opp.title}`;
                select.appendChild(option);
            });
        }

        // Toggle Recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Start Recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Update UI
                document.getElementById('recordBtn').classList.add('glow-pulse', 'border-red-500');
                document.getElementById('recordBtn').classList.remove('border-mmt-cyan/50');
                document.getElementById('recordIcon').textContent = '‚èπÔ∏è';
                document.getElementById('recordStatus').innerHTML = '<span class="recording-pulse text-red-400">‚óè Recording...</span>';
                document.getElementById('recordTimer').classList.remove('hidden');
                
                // Show waveform
                showWaveform();

                // Start timer
                timerInterval = setInterval(updateTimer, 1000);

            } catch (err) {
                console.error('Microphone access denied:', err);
                alert('Please allow microphone access to record meetings.');
            }
        }

        // Stop Recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(timerInterval);

                // Update UI
                document.getElementById('recordBtn').classList.remove('glow-pulse', 'border-red-500');
                document.getElementById('recordBtn').classList.add('border-mmt-cyan/50');
                document.getElementById('recordIcon').textContent = '‚úÖ';
                document.getElementById('recordStatus').textContent = 'Recording complete! Add details below.';
                document.getElementById('waveform').classList.add('hidden');
                document.getElementById('detailsForm').classList.remove('hidden');
            }
        }

        // Update Timer Display
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recordTimer').textContent = `${mins}:${secs}`;
        }

        // Show Waveform Visualization
        function showWaveform() {
            const waveform = document.getElementById('waveform');
            waveform.classList.remove('hidden');
            waveform.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar w-1 bg-mmt-cyan rounded-full';
                bar.style.height = '100%';
                bar.style.animationDelay = `${i * 0.05}s`;
                waveform.appendChild(bar);
            }
        }

        // Process Recording with AI
        async function processRecording() {
            const title = document.getElementById('meetingTitle').value || 'Untitled Recording';
            const type = document.getElementById('meetingType').value;
            const oppId = document.getElementById('opportunityLink').value;
            const attendees = document.getElementById('attendees').value;

            // Show processing UI
            document.getElementById('detailsForm').classList.add('hidden');
            document.getElementById('processingCard').classList.remove('hidden');

            // Simulate AI processing stages
            const stages = [
                { status: 'Transcribing audio...', progress: 25 },
                { status: 'Analyzing content...', progress: 50 },
                { status: 'Extracting competitor intel...', progress: 75 },
                { status: 'Generating summary...', progress: 90 },
                { status: 'Complete!', progress: 100 }
            ];

            for (const stage of stages) {
                document.getElementById('processingStatus').textContent = stage.status;
                document.getElementById('processingBar').style.width = stage.progress + '%';
                await new Promise(r => setTimeout(r, 800));
            }

            // Generate demo extracted intel
            const extractedIntel = generateDemoIntel(type);

            // Save recording
            const recording = {
                id: Date.now().toString(),
                title: title,
                type: type,
                opportunity_id: oppId || null,
                attendees: attendees.split(',').map(a => a.trim()).filter(a => a),
                duration: document.getElementById('recordTimer').textContent,
                recorded_at: new Date().toISOString(),
                transcription: extractedIntel.transcription,
                ai_summary: extractedIntel.summary,
                competitor_mentions: extractedIntel.competitors,
                pain_points: extractedIntel.painPoints,
                action_items: extractedIntel.actions
            };

            recordings.unshift(recording);
            localStorage.setItem('mp_voice_recordings', JSON.stringify(recordings));

            // Show results
            document.getElementById('processingCard').classList.add('hidden');
            showIntelPreview(extractedIntel);
            renderRecordings();
            resetRecordingUI();
        }

        // Generate Demo Intel (simulates AI extraction)
        function generateDemoIntel(type) {
            const intels = {
                customer_meeting: {
                    transcription: 'Customer discussed challenges with current EHR integration timeline. Mentioned competitor GDIT has been responsive but lacking in MHS GENESIS expertise...',
                    summary: 'Key customer meeting revealing pain points with current vendor delivery timelines and interest in our MHS GENESIS capabilities.',
                    competitors: ['GDIT', 'Leidos'],
                    painPoints: ['EHR integration delays', 'Lack of specialized expertise', 'Budget constraints for FY26'],
                    actions: ['Send MHS GENESIS case studies', 'Schedule technical deep-dive', 'Prepare competitive comparison']
                },
                industry_event: {
                    transcription: 'Panel discussion on VA modernization priorities. Multiple speakers emphasized interoperability requirements and FHIR compliance...',
                    summary: 'Industry event insights on VA priorities and competitive landscape for upcoming EHRM opportunities.',
                    competitors: ['Cerner/Oracle', 'Epic'],
                    painPoints: ['Interoperability gaps', 'Legacy system migration', 'Training and adoption'],
                    actions: ['Research FHIR compliance requirements', 'Update VA capability brief', 'Connect with panel speakers']
                },
                competitor_intel: {
                    transcription: 'Source indicates competitor is struggling with CMMC certification. Their proposal team recently lost key personnel...',
                    summary: 'Valuable competitive intelligence on competitor weaknesses and staffing challenges.',
                    competitors: ['Booz Allen', 'Accenture Federal'],
                    painPoints: ['Competitor CMMC gaps', 'Staff turnover at competitor'],
                    actions: ['Highlight our CMMC readiness in proposals', 'Recruit from competitor', 'Update Black Hat analysis']
                },
                default: {
                    transcription: 'General meeting notes captured...',
                    summary: 'Meeting recorded and processed for intel extraction.',
                    competitors: [],
                    painPoints: ['To be analyzed'],
                    actions: ['Review transcription', 'Identify follow-ups']
                }
            };
            return intels[type] || intels.default;
        }

        // Show Intel Preview
        function showIntelPreview(intel) {
            document.getElementById('intelPreview').classList.remove('hidden');
            document.getElementById('competitorMentions').textContent = intel.competitors.length ? intel.competitors.join(', ') : 'None detected';
            document.getElementById('painPoints').textContent = intel.painPoints.slice(0, 2).join('; ');
            document.getElementById('actionItems').textContent = intel.actions.length + ' items';
        }

        // Render Recordings List
        function renderRecordings() {
            const container = document.getElementById('recordingsList');
            document.getElementById('recordingCount').textContent = recordings.length + ' recordings';

            if (recordings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üéß</div>
                        <div>No recordings yet</div>
                        <div class="text-sm">Record your first meeting to capture intel</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = recordings.slice(0, 5).map(rec => `
                <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition cursor-pointer" onclick="viewRecording('${rec.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-white">${rec.title}</div>
                            <div class="text-sm text-gray-400 mt-1">
                                ${getTypeLabel(rec.type)} ‚Ä¢ ${rec.duration} ‚Ä¢ ${formatDate(rec.recorded_at)}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${rec.competitor_mentions?.length ? `<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">${rec.competitor_mentions.length} competitors</span>` : ''}
                            <span class="text-gray-500">‚Üí</span>
                        </div>
                    </div>
                    ${rec.ai_summary ? `<div class="text-sm text-gray-500 mt-2 line-clamp-2">${rec.ai_summary}</div>` : ''}
                </div>
            `).join('');
        }

        // Helper functions
        function getTypeLabel(type) {
            const labels = {
                customer_meeting: 'üë§ Customer',
                industry_event: 'üé™ Event',
                competitor_intel: 'üéØ Intel',
                internal_strategy: 'üìä Strategy',
                partner_call: 'ü§ù Partner',
                other: 'üìù Other'
            };
            return labels[type] || type;
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function viewRecording(id) {
            const rec = recordings.find(r => r.id === id);
            if (rec) {
                alert(`üìã ${rec.title}\n\n${rec.ai_summary}\n\nCompetitors: ${rec.competitor_mentions?.join(', ') || 'None'}\n\nActions: ${rec.action_items?.join(', ') || 'None'}`);
            }
        }

        function cancelRecording() {
            resetRecordingUI();
            audioBlob = null;
        }

        function resetRecordingUI() {
            document.getElementById('recordIcon').textContent = 'üéôÔ∏è';
            document.getElementById('recordStatus').textContent = 'Tap to start recording';
            document.getElementById('recordTimer').classList.add('hidden');
            document.getElementById('recordTimer').textContent = '00:00';
            document.getElementById('detailsForm').classList.add('hidden');
            document.getElementById('meetingTitle').value = '';
            document.getElementById('attendees').value = '';
        }

        function sendToIntelTracker() {
            window.location.href = 'm27-intel-tracker.html';
        }

        function exportIntel() {
            const data = recordings[0];
            if (data) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `intel_${data.id}.json`;
                a.click();
            }
        }
    </script>
</body>
</html>
