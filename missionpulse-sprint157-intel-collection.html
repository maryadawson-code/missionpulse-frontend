<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Intel Collection | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-navy': '#00050F',
            'cyber-cyan': '#00E5FA',
            'slate-dark': '#0a1628'
          }
        }
      }
    }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .intel-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0, 229, 250, 0.1); }
  </style>
</head>
<body class="min-h-screen text-white">
  <header class="border-b border-slate-800/50 bg-deep-navy/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <div>
          <span class="text-lg font-bold text-white">Intel Collection</span>
          <span class="text-xs text-slate-500 block">Capture Support Intelligence</span>
        </div>
      </div>
      <a href="index.html" class="text-sm text-slate-400 hover:text-cyber-cyan transition-colors">‚Üê Dashboard</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- Auth Check -->
    <div id="authCheck" class="text-center py-12">
      <div class="w-8 h-8 border-2 border-cyber-cyan border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p class="text-slate-400 mt-4">Loading...</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Stats Bar -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-cyber-cyan" id="statTotal">0</p>
          <p class="text-xs text-slate-500">Total Intel</p>
        </div>
        <div class="bg-slate-900/60 border border-violet-500/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-violet-400" id="statCustomer">0</p>
          <p class="text-xs text-slate-500">Customer</p>
        </div>
        <div class="bg-slate-900/60 border border-red-500/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-red-400" id="statCompetitor">0</p>
          <p class="text-xs text-slate-500">Competitor</p>
        </div>
        <div class="bg-slate-900/60 border border-amber-500/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-amber-400" id="statTechnical">0</p>
          <p class="text-xs text-slate-500">Technical</p>
        </div>
        <div class="bg-slate-900/60 border border-emerald-500/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-emerald-400" id="statVerified">0</p>
          <p class="text-xs text-slate-500">Verified</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-3 mb-6">
        <button onclick="openNewIntelModal()" class="px-5 py-2.5 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-bold rounded-lg hover:opacity-90 transition-all flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Intel
        </button>
        
        <select id="filterOpp" onchange="filterIntel()" class="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          <option value="all">All Opportunities</option>
        </select>
        
        <select id="filterType" onchange="filterIntel()" class="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          <option value="all">All Types</option>
          <option value="customer">Customer Intel</option>
          <option value="competitor">Competitor Intel</option>
          <option value="technical">Technical Intel</option>
          <option value="pricing">Pricing Intel</option>
          <option value="relationship">Relationship Intel</option>
          <option value="procurement">Procurement Intel</option>
        </select>
        
        <select id="filterConfidence" onchange="filterIntel()" class="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          <option value="all">All Confidence</option>
          <option value="high">High Confidence</option>
          <option value="medium">Medium Confidence</option>
          <option value="low">Low Confidence</option>
        </select>

        <div class="flex-1"></div>
        
        <div class="relative">
          <input type="text" id="searchIntel" placeholder="Search intel..." onkeyup="filterIntel()" class="pl-9 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm w-64">
          <svg class="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
      </div>

      <!-- Quick Capture Bar -->
      <div class="bg-gradient-to-r from-violet-500/10 to-purple-600/10 border border-violet-500/20 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-4">
          <span class="text-lg">‚ö°</span>
          <input type="text" id="quickCapture" placeholder="Quick capture: Paste intel here and press Enter..." class="flex-1 bg-transparent border-none text-white placeholder-slate-500 focus:outline-none">
          <button onclick="quickSave()" class="px-4 py-1.5 bg-violet-500/20 text-violet-400 rounded-lg text-sm hover:bg-violet-500/30">Save</button>
        </div>
      </div>

      <!-- Intel Grid -->
      <div id="intelGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Intel cards rendered here -->
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-16">
        <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2">No Intel Collected Yet</h3>
        <p class="text-slate-500 text-sm mb-4">Start gathering competitive intelligence for your opportunities</p>
        <button onclick="openNewIntelModal()" class="px-4 py-2 bg-violet-500/20 text-violet-400 rounded-lg text-sm hover:bg-violet-500/30">Add First Intel</button>
      </div>
    </div>

    <!-- New Intel Modal -->
    <div id="intelModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold">Add Intelligence</h3>
          <button onclick="closeModal()" class="text-slate-400 hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Opportunity -->
          <div>
            <label class="text-xs text-slate-500 block mb-1">Opportunity *</label>
            <select id="intelOpp" required class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
              <option value="">Select opportunity...</option>
            </select>
          </div>

          <!-- Type & Source Row -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-500 block mb-1">Intel Type *</label>
              <select id="intelType" required class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
                <option value="">Select type...</option>
                <option value="customer">üë§ Customer Intel</option>
                <option value="competitor">‚öîÔ∏è Competitor Intel</option>
                <option value="technical">üîß Technical Intel</option>
                <option value="pricing">üí∞ Pricing Intel</option>
                <option value="relationship">ü§ù Relationship Intel</option>
                <option value="procurement">üìã Procurement Intel</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1">Source Type</label>
              <select id="sourceType" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
                <option value="internal">Internal Research</option>
                <option value="customer_meeting">Customer Meeting</option>
                <option value="industry_event">Industry Event</option>
                <option value="public_source">Public Source</option>
                <option value="partner">Partner/Teaming</option>
                <option value="foia">FOIA Request</option>
                <option value="sam_gov">SAM.gov</option>
                <option value="linkedin">LinkedIn</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <!-- Source Name -->
          <div>
            <label class="text-xs text-slate-500 block mb-1">Source Name / Contact</label>
            <input type="text" id="sourceName" placeholder="e.g., John Smith (DHA CIO), Industry Day Notes" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          </div>

          <!-- Content -->
          <div>
            <label class="text-xs text-slate-500 block mb-1">Intel Content *</label>
            <textarea id="intelContent" rows="5" required placeholder="Describe the intelligence gathered..." class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm resize-none"></textarea>
          </div>

          <!-- Confidence & Relevance Row -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-slate-500 block mb-1">Confidence Level</label>
              <select id="confidenceLevel" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
                <option value="high">üü¢ High - Verified Source</option>
                <option value="medium" selected>üü° Medium - Likely Accurate</option>
                <option value="low">üî¥ Low - Unverified</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500 block mb-1">Relevance Score (1-100)</label>
              <input type="number" id="relevanceScore" value="50" min="1" max="100" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
            </div>
          </div>

          <!-- Tags -->
          <div>
            <label class="text-xs text-slate-500 block mb-1">Tags (comma separated)</label>
            <input type="text" id="intelTags" placeholder="e.g., incumbent, pricing, technical approach" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          </div>

          <!-- Expiration -->
          <div>
            <label class="text-xs text-slate-500 block mb-1">Intel Expires (optional)</label>
            <input type="date" id="expiresAt" class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm">
          </div>

          <button onclick="saveIntel()" class="w-full py-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-bold rounded-lg hover:opacity-90 transition-all">
            Save Intel
          </button>
        </div>
      </div>
    </div>

    <!-- View Intel Modal -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <span id="viewTypeIcon" class="text-2xl"></span>
            <div>
              <span id="viewTypeBadge" class="text-xs px-2 py-0.5 rounded bg-slate-700"></span>
              <h3 id="viewOppName" class="font-bold mt-1"></h3>
            </div>
          </div>
          <button onclick="closeViewModal()" class="text-slate-400 hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-4">
          <div class="bg-slate-800/50 rounded-lg p-4">
            <p id="viewContent" class="text-sm whitespace-pre-wrap"></p>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
            <div class="bg-slate-800/30 rounded-lg p-3">
              <p class="text-xs text-slate-500">Source</p>
              <p id="viewSource" class="font-medium"></p>
            </div>
            <div class="bg-slate-800/30 rounded-lg p-3">
              <p class="text-xs text-slate-500">Confidence</p>
              <p id="viewConfidence" class="font-medium"></p>
            </div>
            <div class="bg-slate-800/30 rounded-lg p-3">
              <p class="text-xs text-slate-500">Relevance</p>
              <p id="viewRelevance" class="font-medium"></p>
            </div>
            <div class="bg-slate-800/30 rounded-lg p-3">
              <p class="text-xs text-slate-500">Collected</p>
              <p id="viewDate" class="font-medium"></p>
            </div>
          </div>

          <div id="viewTags" class="flex flex-wrap gap-2"></div>

          <div id="viewVerified" class="hidden bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 text-sm text-emerald-400">
            ‚úì Verified
          </div>

          <div class="flex gap-3">
            <button onclick="verifyIntel()" id="verifyBtn" class="flex-1 py-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30 text-sm">
              ‚úì Mark Verified
            </button>
            <button onclick="deleteIntel()" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 text-sm">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-slate-800/50 mt-12">
    <div class="max-w-6xl mx-auto px-6 py-4 text-center text-slate-500 text-xs">AI GENERATED - REQUIRES HUMAN REVIEW</div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1NjcyNTAsImV4cCI6MjA1MzE0MzI1MH0.GRTFxRV7WV67P9sYaIVRwKxVEDALfkWjmUxs4ADB1zs';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let intelData = [];
    let opportunities = [];
    let currentIntelId = null;

    const TYPE_CONFIG = {
      customer: { icon: 'üë§', color: 'violet', label: 'Customer Intel' },
      competitor: { icon: '‚öîÔ∏è', color: 'red', label: 'Competitor Intel' },
      technical: { icon: 'üîß', color: 'amber', label: 'Technical Intel' },
      pricing: { icon: 'üí∞', color: 'emerald', label: 'Pricing Intel' },
      relationship: { icon: 'ü§ù', color: 'blue', label: 'Relationship Intel' },
      procurement: { icon: 'üìã', color: 'cyan', label: 'Procurement Intel' }
    };

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = 'login.html'; return; }
      
      const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
      currentUser = { ...session.user, ...profile };
      
      document.getElementById('authCheck').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      await loadOpportunities();
      await loadIntel();
    }

    async function loadOpportunities() {
      const { data } = await supabase
        .from('opportunities')
        .select('id, name, nickname, agency')
        .order('name');
      
      opportunities = data || [];
      
      // Populate dropdowns
      const options = opportunities.map(o => 
        `<option value="${o.id}">${o.nickname || o.name} (${o.agency})</option>`
      ).join('');
      
      document.getElementById('intelOpp').innerHTML = '<option value="">Select opportunity...</option>' + options;
      document.getElementById('filterOpp').innerHTML = '<option value="all">All Opportunities</option>' + options;
    }

    async function loadIntel() {
      const { data, error } = await supabase
        .from('intel_collection')
        .select(`
          *,
          opportunity:opportunities(name, nickname, agency),
          collector:profiles!intel_collection_collected_by_fkey(full_name)
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading intel:', error);
        intelData = [];
      } else {
        intelData = data || [];
      }

      renderIntel();
      updateStats();
    }

    function renderIntel(filtered = null) {
      const data = filtered || intelData;
      const grid = document.getElementById('intelGrid');
      const emptyState = document.getElementById('emptyState');

      if (data.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');

      grid.innerHTML = data.map(intel => {
        const type = TYPE_CONFIG[intel.intel_type] || TYPE_CONFIG.customer;
        const opp = intel.opportunity;
        const confidence = {
          high: { color: 'emerald', label: 'üü¢ High' },
          medium: { color: 'amber', label: 'üü° Medium' },
          low: { color: 'red', label: 'üî¥ Low' }
        }[intel.confidence_level] || { color: 'slate', label: 'Unknown' };

        return `
          <div class="intel-card bg-slate-900/60 border border-slate-700/50 rounded-xl p-4 cursor-pointer transition-all" onclick="viewIntel('${intel.id}')">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="text-xl">${type.icon}</span>
                <span class="text-xs px-2 py-0.5 rounded bg-${type.color}-500/20 text-${type.color}-400">${type.label}</span>
              </div>
              ${intel.verified_at ? '<span class="text-emerald-400 text-xs">‚úì Verified</span>' : ''}
            </div>
            
            <p class="text-sm font-medium mb-1">${opp?.nickname || opp?.name || 'Unknown Opportunity'}</p>
            <p class="text-xs text-slate-500 mb-3">${opp?.agency || ''}</p>
            
            <p class="text-sm text-slate-300 line-clamp-3 mb-3">${intel.content}</p>
            
            <div class="flex items-center justify-between text-xs">
              <span class="text-${confidence.color}-400">${confidence.label}</span>
              <span class="text-slate-500">${new Date(intel.created_at).toLocaleDateString()}</span>
            </div>
            
            ${intel.tags && intel.tags.length > 0 ? `
              <div class="flex flex-wrap gap-1 mt-2">
                ${intel.tags.slice(0, 3).map(t => `<span class="text-xs px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">${t}</span>`).join('')}
                ${intel.tags.length > 3 ? `<span class="text-xs text-slate-500">+${intel.tags.length - 3}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = intelData.length;
      document.getElementById('statCustomer').textContent = intelData.filter(i => i.intel_type === 'customer').length;
      document.getElementById('statCompetitor').textContent = intelData.filter(i => i.intel_type === 'competitor').length;
      document.getElementById('statTechnical').textContent = intelData.filter(i => i.intel_type === 'technical').length;
      document.getElementById('statVerified').textContent = intelData.filter(i => i.verified_at).length;
    }

    function filterIntel() {
      const oppFilter = document.getElementById('filterOpp').value;
      const typeFilter = document.getElementById('filterType').value;
      const confFilter = document.getElementById('filterConfidence').value;
      const search = document.getElementById('searchIntel').value.toLowerCase();

      let filtered = intelData;

      if (oppFilter !== 'all') {
        filtered = filtered.filter(i => i.opportunity_id === oppFilter);
      }
      if (typeFilter !== 'all') {
        filtered = filtered.filter(i => i.intel_type === typeFilter);
      }
      if (confFilter !== 'all') {
        filtered = filtered.filter(i => i.confidence_level === confFilter);
      }
      if (search) {
        filtered = filtered.filter(i => 
          i.content.toLowerCase().includes(search) ||
          i.source_name?.toLowerCase().includes(search) ||
          i.tags?.some(t => t.toLowerCase().includes(search))
        );
      }

      renderIntel(filtered);
    }

    function openNewIntelModal() {
      document.getElementById('intelModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('intelModal').classList.add('hidden');
      // Reset form
      document.getElementById('intelOpp').value = '';
      document.getElementById('intelType').value = '';
      document.getElementById('sourceType').value = 'internal';
      document.getElementById('sourceName').value = '';
      document.getElementById('intelContent').value = '';
      document.getElementById('confidenceLevel').value = 'medium';
      document.getElementById('relevanceScore').value = 50;
      document.getElementById('intelTags').value = '';
      document.getElementById('expiresAt').value = '';
    }

    async function saveIntel() {
      const oppId = document.getElementById('intelOpp').value;
      const intelType = document.getElementById('intelType').value;
      const content = document.getElementById('intelContent').value.trim();

      if (!oppId || !intelType || !content) {
        alert('Please fill in required fields');
        return;
      }

      const tagsInput = document.getElementById('intelTags').value;
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

      const intel = {
        company_id: currentUser.company_id,
        opportunity_id: oppId,
        intel_type: intelType,
        source_type: document.getElementById('sourceType').value,
        source_name: document.getElementById('sourceName').value.trim() || null,
        content,
        confidence_level: document.getElementById('confidenceLevel').value,
        relevance_score: parseInt(document.getElementById('relevanceScore').value) || 50,
        tags: tags.length > 0 ? tags : null,
        expires_at: document.getElementById('expiresAt').value || null,
        collected_by: currentUser.id
      };

      const { error } = await supabase.from('intel_collection').insert(intel);

      if (error) {
        alert('Failed to save: ' + error.message);
        return;
      }

      closeModal();
      await loadIntel();
    }

    async function quickSave() {
      const content = document.getElementById('quickCapture').value.trim();
      if (!content) return;

      if (opportunities.length === 0) {
        alert('No opportunities available');
        return;
      }

      // Quick save to first opportunity with generic type
      const intel = {
        company_id: currentUser.company_id,
        opportunity_id: opportunities[0].id,
        intel_type: 'customer',
        source_type: 'internal',
        content,
        confidence_level: 'medium',
        relevance_score: 50,
        collected_by: currentUser.id
      };

      const { error } = await supabase.from('intel_collection').insert(intel);

      if (error) {
        alert('Failed to save: ' + error.message);
        return;
      }

      document.getElementById('quickCapture').value = '';
      await loadIntel();
    }

    function viewIntel(id) {
      const intel = intelData.find(i => i.id === id);
      if (!intel) return;

      currentIntelId = id;
      const type = TYPE_CONFIG[intel.intel_type] || TYPE_CONFIG.customer;
      const opp = intel.opportunity;

      document.getElementById('viewTypeIcon').textContent = type.icon;
      document.getElementById('viewTypeBadge').textContent = type.label;
      document.getElementById('viewTypeBadge').className = `text-xs px-2 py-0.5 rounded bg-${type.color}-500/20 text-${type.color}-400`;
      document.getElementById('viewOppName').textContent = opp?.nickname || opp?.name || 'Unknown';
      document.getElementById('viewContent').textContent = intel.content;
      document.getElementById('viewSource').textContent = `${intel.source_type} ${intel.source_name ? '- ' + intel.source_name : ''}`;
      
      const confMap = { high: 'üü¢ High', medium: 'üü° Medium', low: 'üî¥ Low' };
      document.getElementById('viewConfidence').textContent = confMap[intel.confidence_level] || 'Unknown';
      document.getElementById('viewRelevance').textContent = intel.relevance_score + '/100';
      document.getElementById('viewDate').textContent = new Date(intel.created_at).toLocaleDateString();

      // Tags
      const tagsEl = document.getElementById('viewTags');
      if (intel.tags && intel.tags.length > 0) {
        tagsEl.innerHTML = intel.tags.map(t => `<span class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-400">${t}</span>`).join('');
      } else {
        tagsEl.innerHTML = '';
      }

      // Verified status
      const verifiedEl = document.getElementById('viewVerified');
      const verifyBtn = document.getElementById('verifyBtn');
      if (intel.verified_at) {
        verifiedEl.classList.remove('hidden');
        verifiedEl.innerHTML = `‚úì Verified on ${new Date(intel.verified_at).toLocaleDateString()}`;
        verifyBtn.classList.add('hidden');
      } else {
        verifiedEl.classList.add('hidden');
        verifyBtn.classList.remove('hidden');
      }

      document.getElementById('viewModal').classList.remove('hidden');
    }

    function closeViewModal() {
      document.getElementById('viewModal').classList.add('hidden');
      currentIntelId = null;
    }

    async function verifyIntel() {
      if (!currentIntelId) return;

      const { error } = await supabase
        .from('intel_collection')
        .update({ 
          verified_at: new Date().toISOString(),
          verified_by: currentUser.id 
        })
        .eq('id', currentIntelId);

      if (error) {
        alert('Failed to verify: ' + error.message);
        return;
      }

      closeViewModal();
      await loadIntel();
    }

    async function deleteIntel() {
      if (!currentIntelId) return;
      if (!confirm('Delete this intel? This cannot be undone.')) return;

      const { error } = await supabase
        .from('intel_collection')
        .delete()
        .eq('id', currentIntelId);

      if (error) {
        alert('Failed to delete: ' + error.message);
        return;
      }

      closeViewModal();
      await loadIntel();
    }

    // Quick capture on Enter
    document.getElementById('quickCapture')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') quickSave();
    });

    checkAuth();
  </script>
</body>
</html>
