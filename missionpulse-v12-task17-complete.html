<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse v12 | AI Proposal Command Center</title>
    <meta name="description" content="Enterprise proposal management with 11-role RBAC, AI agent swarm, Shipley methodology">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
      
      :root { --mmt-cyan: #00E5FA; --mmt-navy: #00050F; --mmt-slate: #1e293b; --mmt-text: #e2e8f0; }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--mmt-navy); color: var(--mmt-text); min-height: 100vh; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a1628; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(0, 229, 250, 0.12); border-radius: 12px; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
      .animate-slideIn { animation: slideIn 0.3s ease-out; }
      .animate-pulse { animation: pulse 2s infinite; }
      .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
      .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0, 229, 250, 0.15); }
      .typing-dot { animation: pulse 1.4s infinite; }
      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }
      @media print {
        body { background: white !important; color: black !important; }
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        .glass-panel { background: white !important; border: 1px solid #ccc !important; }
      }
    </style>
</head>
<body class="overflow-hidden">
    <div id="root"></div>
    
    <script type="text/babel">
// ============================================================
// MISSIONPULSE v12 - SPRINT 12: EXPORT REPORTS
// CSV Downloads | Print Reports | Export Center
// Â© 2026 Mission Meets Tech
// ============================================================

const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

// ============================================================
// CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzQ2NDMsImV4cCI6MjA1MzUxMDY0M30.Yx8OZQH5Fxx5Ts9DmNoO0aPWF_fFQmQJWSFIohHcA';
const API_BASE_URL = 'https://missionpulse-api.onrender.com';

const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================================
// EXPORT UTILITIES
// ============================================================
const ExportUtils = {
  // Convert data to CSV string
  toCSV: (data, columns) => {
    if (!data || data.length === 0) return '';
    const headers = columns.map(c => c.label).join(',');
    const rows = data.map(row => 
      columns.map(c => {
        let val = row[c.key] ?? '';
        if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
          val = `"${val.replace(/"/g, '""')}"`;
        }
        return val;
      }).join(',')
    ).join('\n');
    return `${headers}\n${rows}`;
  },
  
  // Download CSV file
  downloadCSV: (data, columns, filename) => {
    const csv = ExportUtils.toCSV(data, columns);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  },
  
  // Download JSON file
  downloadJSON: (data, filename) => {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(link.href);
  },
  
  // Format currency
  formatCurrency: (val) => {
    if (!val) return '$0';
    const num = typeof val === 'string' ? parseFloat(val) : val;
    if (num >= 1e9) return `$${(num/1e9).toFixed(1)}B`;
    if (num >= 1e6) return `$${(num/1e6).toFixed(1)}M`;
    if (num >= 1e3) return `$${(num/1e3).toFixed(0)}K`;
    return `$${num.toFixed(0)}`;
  },
  
  // Format date
  formatDate: (date) => {
    if (!date) return 'N/A';
    return new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
};

// ============================================================
// 8 AI AGENTS REGISTRY
// ============================================================
const AI_AGENTS = [
  { id: 'capture', name: 'Capture Intelligence', description: '12-factor win probability scoring', icon: 'target', color: '#00E5FA', isRestricted: false, capabilities: ['Win probability', 'Go/No-Go analysis', 'Competitive positioning'], examplePrompts: ["What's our win probability?", "Should we pursue this?", "Analyze competitive position"] },
  { id: 'strategy', name: 'Strategy Advisor', description: 'Win themes and discriminators', icon: 'activity', color: '#8B5CF6', isRestricted: true, capabilities: ['Win themes', 'Discriminators', 'BLUF development'], examplePrompts: ["Generate 3 win themes", "Key discriminators?", "Draft a BLUF"] },
  { id: 'compliance', name: 'Compliance Guardian', description: 'FAR/DFARS validation', icon: 'shield', color: '#10B981', isRestricted: false, capabilities: ['Requirement extraction', 'Compliance matrix', 'Risk identification'], examplePrompts: ["Check compliance gaps", "Extract L/M requirements", "DFARS clauses?"] },
  { id: 'writer', name: 'Proposal Writer', description: 'Shipley-compliant drafting', icon: 'penTool', color: '#3B82F6', isRestricted: false, capabilities: ['Section drafting', 'Technical writing', 'Past performance'], examplePrompts: ["Draft technical approach", "Write past performance", "Improve this paragraph"] },
  { id: 'pricing', name: 'Pricing Analyst', description: 'BOE and price-to-win', icon: 'calculator', color: '#F59E0B', isRestricted: true, capabilities: ['BOE development', 'Wrap rates', 'Price-to-win'], examplePrompts: ["Generate BOE for 5 FTEs", "Price-to-win?", "Wrap rate analysis"] },
  { id: 'blackhat', name: 'Competitive Intel', description: 'Ghost team simulation', icon: 'ghost', color: '#EF4444', isRestricted: true, capabilities: ['Competitor SWOT', 'Ghost team', 'Incumbent analysis'], examplePrompts: ["Black hat review", "What would competitor propose?", "Incumbent response?"] },
  { id: 'contracts', name: 'Contracts Advisor', description: 'Clause analysis and T&C review', icon: 'scale', color: '#6366F1', isRestricted: false, capabilities: ['Clause analysis', 'T&C review', 'Risk flagging'], examplePrompts: ["Review Section H", "Flag risky terms", "T&Cs to negotiate?"] },
  { id: 'orals', name: 'Orals Coach', description: 'Q&A simulation and coaching', icon: 'mic', color: '#EC4899', isRestricted: false, capabilities: ['Q&A simulation', 'Presentation coaching', 'Response refinement'], examplePrompts: ["Simulate tough questions", "Coach my presentation", "Answer schedule risk?"] }
];

// ============================================================
// CONTEXTS
// ============================================================
const RoleContext = createContext(null);
const DataContext = createContext(null);

// ============================================================
// 11 SHIPLEY ROLES WITH AGENT ACCESS
// ============================================================
const ROLES = [
  { id: 'CEO', name: 'CEO', fullName: 'Mary Womack', icon: 'crown', color: '#fbbf24', bgColor: 'rgba(251, 191, 36, 0.2)', shipleyFunction: 'Executive Approver', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'launch_roi', 'orals', 'frenemy', 'post_award'], agentAccess: ['capture', 'compliance', 'writer', 'contracts', 'orals'], canExport: true },
  { id: 'COO', name: 'COO', fullName: 'David Chen', icon: 'briefcase', color: '#f97316', bgColor: 'rgba(249, 115, 22, 0.2)', shipleyFunction: 'Capture Oversight', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'hitl', 'frenemy', 'launch_roi', 'post_award', 'pricing'], agentAccess: ['capture', 'strategy', 'compliance', 'writer', 'pricing', 'contracts', 'orals'], canExport: true },
  { id: 'CAP', name: 'Capture', fullName: 'Michael Torres', icon: 'target', color: '#f472b6', bgColor: 'rgba(244, 114, 182, 0.2)', shipleyFunction: 'Capture Manager', access: ['dashboard', 'pipeline', 'blackhat', 'strategy', 'warroom', 'frenemy', 'swarm'], agentAccess: ['capture', 'strategy', 'blackhat', 'compliance', 'writer', 'contracts'], canExport: true },
  { id: 'PM', name: 'Proposal Mgr', fullName: 'Lisa Martinez', icon: 'clipboard', color: '#60a5fa', bgColor: 'rgba(96, 165, 250, 0.2)', shipleyFunction: 'Proposal Manager', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'writer', 'hitl', 'launch_roi', 'post_award', 'orals'], agentAccess: ['capture', 'compliance', 'writer', 'contracts', 'orals'], canExport: true },
  { id: 'SA', name: 'Solution Arch', fullName: 'Sarah Chen', icon: 'cpu', color: '#22d3ee', bgColor: 'rgba(34, 211, 238, 0.2)', shipleyFunction: 'Technical Lead', access: ['writer', 'compliance', 'contracts', 'orals', 'swarm'], agentAccess: ['compliance', 'writer', 'contracts', 'orals'], canExport: false },
  { id: 'FIN', name: 'Pricing', fullName: 'Jennifer Park', icon: 'dollarSign', color: '#34d399', bgColor: 'rgba(52, 211, 153, 0.2)', shipleyFunction: 'Volume Lead (Pricing)', access: ['pricing', 'contracts', 'launch_roi', 'swarm'], agentAccess: ['pricing', 'contracts'], canExport: true },
  { id: 'CON', name: 'Compliance', fullName: 'Robert Williams', icon: 'scale', color: '#a78bfa', bgColor: 'rgba(167, 139, 250, 0.2)', shipleyFunction: 'Contracts/Compliance', access: ['compliance', 'contracts', 'swarm', 'hitl'], agentAccess: ['compliance', 'contracts'], canExport: false },
  { id: 'DEL', name: 'Delivery', fullName: 'Amanda Foster', icon: 'users', color: '#fb7185', bgColor: 'rgba(251, 113, 133, 0.2)', shipleyFunction: 'Delivery/Staffing', access: ['swarm', 'writer', 'post_award', 'orals'], agentAccess: ['writer', 'orals'], canExport: false },
  { id: 'QA', name: 'QA Lead', fullName: 'James Thompson', icon: 'checkCircle', color: '#2dd4bf', bgColor: 'rgba(45, 212, 191, 0.2)', shipleyFunction: 'Quality Assurance', access: ['hitl', 'compliance', 'swarm', 'writer'], agentAccess: ['compliance', 'writer'], canExport: false },
  { id: 'Partner', name: 'Partner', fullName: 'External Teammate', icon: 'handshake', color: '#94a3b8', bgColor: 'rgba(148, 163, 184, 0.2)', shipleyFunction: 'Teaming Partner', access: ['swarm', 'writer'], agentAccess: ['writer'], canExport: false, isExternal: true },
  { id: 'Admin', name: 'Admin', fullName: 'System Admin', icon: 'settings', color: '#cbd5e1', bgColor: 'rgba(203, 213, 225, 0.2)', shipleyFunction: 'System Administrator', access: ['admin', 'audit', 'dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'contracts', 'writer', 'blackhat', 'pricing', 'hitl', 'orals', 'frenemy', 'launch_roi', 'post_award'], agentAccess: ['capture', 'strategy', 'compliance', 'writer', 'pricing', 'blackhat', 'contracts', 'orals'], canExport: true }
];

// ============================================================
// MODULE DEFINITIONS
// ============================================================
const MODULES = [
  { id: 'pipeline', name: 'Pipeline Intel', icon: 'filter', color: '#60a5fa', category: 'Strategy' },
  { id: 'warroom', name: 'War Room', icon: 'swords', color: '#818cf8', category: 'Strategy' },
  { id: 'swarm', name: 'Swimlane Board', icon: 'kanban', color: '#2dd4bf', category: 'Strategy' },
  { id: 'compliance', name: 'RFP Shredder', icon: 'fileCheck', color: '#f87171', category: 'Intelligence' },
  { id: 'contracts', name: 'Contract Scanner', icon: 'scale', color: '#a78bfa', category: 'Intelligence' },
  { id: 'writer', name: 'Iron Dome', icon: 'penTool', color: '#c084fc', category: 'Intelligence' },
  { id: 'blackhat', name: 'Black Hat', icon: 'ghost', color: '#fbbf24', category: 'Intelligence', badge: 'PRIVATE' },
  { id: 'pricing', name: 'Pricing Engine', icon: 'calculator', color: '#4ade80', category: 'Delivery', badge: 'CUI' },
  { id: 'hitl', name: 'HITL Gauntlet', icon: 'eye', color: '#fb923c', category: 'Delivery' },
  { id: 'orals', name: 'Orals Studio', icon: 'mic', color: '#f472b6', category: 'Delivery' },
  { id: 'frenemy', name: 'Frenemy Protocol', icon: 'shield', color: '#22d3ee', category: 'Delivery' },
  { id: 'dashboard', name: 'Mission Control', icon: 'activity', color: '#facc15', category: 'Command' },
  { id: 'launch_roi', name: 'Launch & ROI', icon: 'rocket', color: '#e879f9', category: 'Command' },
  { id: 'post_award', name: 'Post-Award', icon: 'archive', color: '#a78bfa', category: 'Command' },
  { id: 'admin', name: 'Admin Settings', icon: 'sliders', color: '#cbd5e1', category: 'Admin', badge: 'ADMIN' },
  { id: 'audit', name: 'Audit Log', icon: 'list', color: '#64748b', category: 'Admin', badge: 'ADMIN' }
];

const MODULE_CATEGORIES = [
  { id: 'Strategy', name: 'Strategy Phase' },
  { id: 'Intelligence', name: 'Intelligence Phase' },
  { id: 'Delivery', name: 'Delivery Phase' },
  { id: 'Command', name: 'Command Center' },
  { id: 'Admin', name: 'Administration' }
];

// ============================================================
// ICON COMPONENT
// ============================================================
const Icon = ({ name, className = 'w-5 h-5', style }) => {
  const icons = {
    crown: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3l3.5 7L12 6l3.5 4L19 3m-14 8v8h14v-8M5 15h14" /></svg>,
    briefcase: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
    target: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
    clipboard: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>,
    cpu: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>,
    dollarSign: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    scale: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>,
    users: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
    checkCircle: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    handshake: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    settings: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    filter: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
    swords: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 6l6 6m0 0l6-6m-6 6v12M4 4l16 16M20 4L4 20" /></svg>,
    kanban: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>,
    fileCheck: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    penTool: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>,
    ghost: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
    calculator: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
    eye: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
    mic: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>,
    shield: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
    activity: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
    rocket: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
    archive: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
    sliders: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>,
    list: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>,
    chevronDown: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
    chevronRight: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
    chevronLeft: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>,
    x: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
    alert: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
    logOut: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
    messageSquare: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
    send: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
    sparkles: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
    download: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
    printer: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
    fileText: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
    table: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
    check: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
  };
  return icons[name] || <span className={className}>?</span>;
};

// ============================================================
// UI COMPONENTS
// ============================================================
const Card = ({ children, className = '' }) => (<div className={`glass-panel p-4 hover-lift ${className}`}>{children}</div>);
const Badge = ({ children, color = '#00E5FA' }) => (<span className="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full" style={{ backgroundColor: `${color}20`, borderColor: `${color}40`, color, border: '1px solid' }}>{children}</span>);

const Button = ({ children, variant = 'default', size = 'md', icon, onClick, disabled, className = '' }) => {
  const variants = {
    default: 'bg-slate-700 hover:bg-slate-600 text-white border-slate-600',
    primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-400 hover:to-teal-400 text-white border-transparent',
    success: 'bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 border-emerald-500/30',
    ghost: 'bg-transparent hover:bg-slate-800 text-slate-400 border-transparent'
  };
  const sizes = { sm: 'px-3 py-1.5 text-xs', md: 'px-4 py-2 text-sm', lg: 'px-6 py-3 text-base' };
  return (
    <button onClick={onClick} disabled={disabled} className={`inline-flex items-center gap-2 font-medium rounded-lg border transition-all ${variants[variant]} ${sizes[size]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>
      {icon && <Icon name={icon} className="w-4 h-4" />}
      {children}
    </button>
  );
};

// ============================================================
// EXPORT BUTTON COMPONENT
// ============================================================
const ExportButton = ({ data, columns, filename, label = 'Export CSV', currentRole }) => {
  const [exported, setExported] = useState(false);
  
  if (!currentRole?.canExport) return null;
  
  const handleExport = () => {
    ExportUtils.downloadCSV(data, columns, filename);
    setExported(true);
    setTimeout(() => setExported(false), 2000);
  };
  
  return (
    <Button variant={exported ? 'success' : 'default'} size="sm" icon={exported ? 'check' : 'download'} onClick={handleExport}>
      {exported ? 'Downloaded!' : label}
    </Button>
  );
};

// ============================================================
// EXPORT CENTER MODULE
// ============================================================
const ExportCenter = ({ opportunities, currentRole }) => {
  const [exportHistory, setExportHistory] = useState([]);
  
  const exportOptions = [
    {
      id: 'pipeline',
      name: 'Pipeline Report',
      description: 'All opportunities with status, value, and win probability',
      icon: 'filter',
      color: '#60a5fa',
      columns: [
        { key: 'title', label: 'Opportunity' },
        { key: 'agency', label: 'Agency' },
        { key: 'ceiling', label: 'Value' },
        { key: 'win_probability', label: 'Win %' },
        { key: 'shipley_phase', label: 'Phase' },
        { key: 'priority', label: 'Priority' },
        { key: 'created_at', label: 'Created' }
      ],
      getData: () => opportunities
    },
    {
      id: 'compliance',
      name: 'Compliance Matrix',
      description: 'FAR/DFARS requirements and compliance status',
      icon: 'shield',
      color: '#10B981',
      columns: [
        { key: 'requirement', label: 'Requirement' },
        { key: 'source', label: 'Source' },
        { key: 'status', label: 'Status' },
        { key: 'assignee', label: 'Assignee' },
        { key: 'due_date', label: 'Due Date' }
      ],
      getData: () => [
        { requirement: 'FAR 52.212-1 Instructions', source: 'Section L', status: 'Complete', assignee: 'Lisa Martinez', due_date: '2026-02-15' },
        { requirement: 'DFARS 252.204-7012 Cybersecurity', source: 'Section H', status: 'In Progress', assignee: 'Robert Williams', due_date: '2026-02-10' },
        { requirement: 'Past Performance Vol III', source: 'Section M', status: 'Draft', assignee: 'Michael Torres', due_date: '2026-02-20' },
        { requirement: 'Small Business Subcontracting', source: 'FAR 19.7', status: 'Not Started', assignee: 'Jennifer Park', due_date: '2026-02-25' },
        { requirement: 'Key Personnel Resumes', source: 'Section L.4', status: 'Complete', assignee: 'Amanda Foster', due_date: '2026-02-08' }
      ]
    },
    {
      id: 'pricing',
      name: 'Pricing Summary',
      description: 'BOE totals, wrap rates, and price-to-win analysis',
      icon: 'calculator',
      color: '#F59E0B',
      restricted: true,
      columns: [
        { key: 'category', label: 'Category' },
        { key: 'labor', label: 'Labor' },
        { key: 'odc', label: 'ODCs' },
        { key: 'total', label: 'Total' },
        { key: 'wrap_rate', label: 'Wrap Rate' }
      ],
      getData: () => [
        { category: 'Year 1', labor: '$1,200,000', odc: '$150,000', total: '$1,350,000', wrap_rate: '2.8' },
        { category: 'Year 2', labor: '$1,250,000', odc: '$160,000', total: '$1,410,000', wrap_rate: '2.8' },
        { category: 'Year 3', labor: '$1,300,000', odc: '$170,000', total: '$1,470,000', wrap_rate: '2.8' },
        { category: 'Total', labor: '$3,750,000', odc: '$480,000', total: '$4,230,000', wrap_rate: '2.8' }
      ]
    },
    {
      id: 'competitors',
      name: 'Competitor Analysis',
      description: 'SWOT analysis and competitive positioning',
      icon: 'ghost',
      color: '#EF4444',
      restricted: true,
      columns: [
        { key: 'competitor', label: 'Competitor' },
        { key: 'strengths', label: 'Strengths' },
        { key: 'weaknesses', label: 'Weaknesses' },
        { key: 'threat_level', label: 'Threat' },
        { key: 'strategy', label: 'Counter Strategy' }
      ],
      getData: () => [
        { competitor: 'Leidos', strengths: 'Incumbent, clearances', weaknesses: 'High cost, innovation debt', threat_level: 'High', strategy: 'Emphasize modernization' },
        { competitor: 'Booz Allen', strengths: 'Agency relationships', weaknesses: 'Stretched resources', threat_level: 'Medium', strategy: 'Highlight availability' },
        { competitor: 'CACI', strengths: 'Technical depth', weaknesses: 'Healthcare IT gaps', threat_level: 'Medium', strategy: 'Showcase HIT experience' }
      ]
    },
    {
      id: 'audit',
      name: 'Audit Log',
      description: 'System activity and user actions',
      icon: 'list',
      color: '#64748b',
      adminOnly: true,
      columns: [
        { key: 'timestamp', label: 'Timestamp' },
        { key: 'user', label: 'User' },
        { key: 'action', label: 'Action' },
        { key: 'module', label: 'Module' },
        { key: 'details', label: 'Details' }
      ],
      getData: () => [
        { timestamp: '2026-01-28 09:15:22', user: 'Mary Womack', action: 'Login', module: 'Auth', details: 'Successful login' },
        { timestamp: '2026-01-28 09:16:45', user: 'Mary Womack', action: 'View', module: 'Pipeline', details: 'Viewed DHA EHR opportunity' },
        { timestamp: '2026-01-28 09:20:11', user: 'Lisa Martinez', action: 'Edit', module: 'Compliance', details: 'Updated requirement status' },
        { timestamp: '2026-01-28 09:25:33', user: 'Michael Torres', action: 'Export', module: 'Export Center', details: 'Downloaded pipeline report' },
        { timestamp: '2026-01-28 09:30:00', user: 'System', action: 'Sync', module: 'Database', details: 'Supabase sync completed' }
      ]
    }
  ];
  
  const handleExport = (option) => {
    const data = option.getData();
    ExportUtils.downloadCSV(data, option.columns, `missionpulse_${option.id}`);
    setExportHistory(prev => [{
      id: Date.now(),
      name: option.name,
      timestamp: new Date().toISOString(),
      rows: data.length
    }, ...prev.slice(0, 9)]);
  };
  
  const availableExports = exportOptions.filter(opt => {
    if (opt.adminOnly && currentRole.id !== 'Admin') return false;
    if (opt.restricted && !['CEO', 'COO', 'CAP', 'FIN', 'Admin'].includes(currentRole.id)) return false;
    return true;
  });

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <Card>
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center">
              <Icon name="download" className="w-6 h-6 text-cyan-400" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">Export Center</h2>
              <p className="text-slate-400 text-sm">Download reports and data exports</p>
            </div>
          </div>
          <Badge color="#00E5FA">{availableExports.length} Reports Available</Badge>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {availableExports.map(option => (
            <div key={option.id} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-cyan-500/30 transition-all">
              <div className="flex items-start gap-3 mb-3">
                <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${option.color}20` }}>
                  <Icon name={option.icon} className="w-5 h-5" style={{ color: option.color }} />
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-white">{option.name}</h3>
                    {option.restricted && <Badge color="#EF4444">Private</Badge>}
                    {option.adminOnly && <Badge color="#8B5CF6">Admin</Badge>}
                  </div>
                  <p className="text-xs text-slate-400 mt-1">{option.description}</p>
                </div>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-xs text-slate-500">{option.columns.length} columns</span>
                <Button variant="primary" size="sm" icon="download" onClick={() => handleExport(option)}>
                  Export
                </Button>
              </div>
            </div>
          ))}
        </div>
      </Card>
      
      {exportHistory.length > 0 && (
        <Card>
          <h3 className="font-semibold text-white mb-4 flex items-center gap-2">
            <Icon name="list" className="w-5 h-5 text-slate-400" />
            Recent Exports
          </h3>
          <div className="space-y-2">
            {exportHistory.map(item => (
              <div key={item.id} className="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                <div className="flex items-center gap-3">
                  <Icon name="check" className="w-4 h-4 text-emerald-400" />
                  <span className="text-sm text-white">{item.name}</span>
                </div>
                <div className="flex items-center gap-4">
                  <span className="text-xs text-slate-400">{item.rows} rows</span>
                  <span className="text-xs text-slate-500">{ExportUtils.formatDate(item.timestamp)}</span>
                </div>
              </div>
            ))}
          </div>
        </Card>
      )}
      
      <Card>
        <h3 className="font-semibold text-white mb-4 flex items-center gap-2">
          <Icon name="printer" className="w-5 h-5 text-slate-400" />
          Print Reports
        </h3>
        <div className="flex gap-3">
          <Button variant="default" icon="printer" onClick={() => window.print()}>
            Print Dashboard
          </Button>
          <Button variant="ghost" icon="fileText">
            Generate PDF (Coming Soon)
          </Button>
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// PIPELINE MODULE WITH EXPORT
// ============================================================
const PipelineModule = ({ opportunities, currentRole }) => {
  const pipelineColumns = [
    { key: 'title', label: 'Opportunity' },
    { key: 'agency', label: 'Agency' },
    { key: 'ceiling', label: 'Value' },
    { key: 'win_probability', label: 'Win %' },
    { key: 'shipley_phase', label: 'Phase' },
    { key: 'priority', label: 'Priority' }
  ];

  const totalValue = opportunities.reduce((sum, o) => sum + (parseFloat(o.ceiling) || 0), 0);
  const avgWinProb = opportunities.length > 0 
    ? (opportunities.reduce((sum, o) => sum + (o.win_probability || 0), 0) / opportunities.length).toFixed(0)
    : 0;

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <Card>
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
              <Icon name="filter" className="w-6 h-6 text-blue-400" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">Pipeline Intelligence</h2>
              <p className="text-slate-400 text-sm">{opportunities.length} active opportunities</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <ExportButton data={opportunities} columns={pipelineColumns} filename="missionpulse_pipeline" label="Export Pipeline" currentRole={currentRole} />
          </div>
        </div>

        <div className="grid grid-cols-3 gap-4 mb-6">
          <div className="p-4 bg-slate-800/50 rounded-lg">
            <p className="text-xs text-slate-400 uppercase mb-1">Total Pipeline</p>
            <p className="text-2xl font-bold text-white">{ExportUtils.formatCurrency(totalValue)}</p>
          </div>
          <div className="p-4 bg-slate-800/50 rounded-lg">
            <p className="text-xs text-slate-400 uppercase mb-1">Avg Win Probability</p>
            <p className="text-2xl font-bold text-cyan-400">{avgWinProb}%</p>
          </div>
          <div className="p-4 bg-slate-800/50 rounded-lg">
            <p className="text-xs text-slate-400 uppercase mb-1">Active Opps</p>
            <p className="text-2xl font-bold text-emerald-400">{opportunities.length}</p>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-slate-700">
                <th className="text-left py-3 px-4 text-xs font-semibold text-slate-400 uppercase">Opportunity</th>
                <th className="text-left py-3 px-4 text-xs font-semibold text-slate-400 uppercase">Agency</th>
                <th className="text-right py-3 px-4 text-xs font-semibold text-slate-400 uppercase">Value</th>
                <th className="text-right py-3 px-4 text-xs font-semibold text-slate-400 uppercase">Win %</th>
                <th className="text-left py-3 px-4 text-xs font-semibold text-slate-400 uppercase">Phase</th>
              </tr>
            </thead>
            <tbody>
              {opportunities.slice(0, 10).map((opp, idx) => (
                <tr key={opp.id || idx} className="border-b border-slate-800 hover:bg-slate-800/30">
                  <td className="py-3 px-4">
                    <p className="font-medium text-white">{opp.title || opp.nickname || 'Untitled'}</p>
                    <p className="text-xs text-slate-500">{opp.solicitation_number || 'No solicitation #'}</p>
                  </td>
                  <td className="py-3 px-4 text-sm text-slate-300">{opp.agency || 'TBD'}</td>
                  <td className="py-3 px-4 text-right font-mono text-sm text-emerald-400">{ExportUtils.formatCurrency(opp.ceiling)}</td>
                  <td className="py-3 px-4 text-right">
                    <span className={`font-semibold ${(opp.win_probability || 0) >= 70 ? 'text-emerald-400' : (opp.win_probability || 0) >= 50 ? 'text-amber-400' : 'text-red-400'}`}>
                      {opp.win_probability || 0}%
                    </span>
                  </td>
                  <td className="py-3 px-4">
                    <Badge color="#60a5fa">{opp.shipley_phase || 'Phase 0'}</Badge>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// DASHBOARD MODULE WITH EXPORT
// ============================================================
const DashboardModule = ({ opportunities, currentRole }) => {
  const stats = useMemo(() => {
    const totalValue = opportunities.reduce((sum, o) => sum + (parseFloat(o.ceiling) || 0), 0);
    const avgWin = opportunities.length > 0 
      ? opportunities.reduce((sum, o) => sum + (o.win_probability || 0), 0) / opportunities.length 
      : 0;
    const phases = [...new Set(opportunities.map(o => o.shipley_phase).filter(Boolean))];
    return { count: opportunities.length, totalValue, avgWin: avgWin.toFixed(0), phases: phases.length };
  }, [opportunities]);

  const summaryColumns = [
    { key: 'metric', label: 'Metric' },
    { key: 'value', label: 'Value' }
  ];
  
  const summaryData = [
    { metric: 'Total Opportunities', value: stats.count },
    { metric: 'Pipeline Value', value: ExportUtils.formatCurrency(stats.totalValue) },
    { metric: 'Avg Win Probability', value: `${stats.avgWin}%` },
    { metric: 'Active Phases', value: stats.phases },
    { metric: 'Report Generated', value: new Date().toLocaleString() }
  ];

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <Card>
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 flex items-center justify-center">
              <Icon name="activity" className="w-6 h-6 text-cyan-400" />
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">Mission Control</h2>
              <p className="text-slate-400 text-sm">Executive Dashboard</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <ExportButton data={summaryData} columns={summaryColumns} filename="missionpulse_summary" label="Export Summary" currentRole={currentRole} />
            {currentRole?.canExport && (
              <Button variant="ghost" size="sm" icon="printer" onClick={() => window.print()}>Print</Button>
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="p-4 bg-gradient-to-br from-blue-500/10 to-blue-500/5 rounded-xl border border-blue-500/20">
            <p className="text-xs text-slate-400 uppercase mb-1">Active Proposals</p>
            <p className="text-3xl font-bold text-white">{stats.count}</p>
          </div>
          <div className="p-4 bg-gradient-to-br from-emerald-500/10 to-emerald-500/5 rounded-xl border border-emerald-500/20">
            <p className="text-xs text-slate-400 uppercase mb-1">Pipeline Value</p>
            <p className="text-3xl font-bold text-emerald-400">{ExportUtils.formatCurrency(stats.totalValue)}</p>
          </div>
          <div className="p-4 bg-gradient-to-br from-cyan-500/10 to-cyan-500/5 rounded-xl border border-cyan-500/20">
            <p className="text-xs text-slate-400 uppercase mb-1">Avg Win Prob</p>
            <p className="text-3xl font-bold text-cyan-400">{stats.avgWin}%</p>
          </div>
          <div className="p-4 bg-gradient-to-br from-purple-500/10 to-purple-500/5 rounded-xl border border-purple-500/20">
            <p className="text-xs text-slate-400 uppercase mb-1">Phases Active</p>
            <p className="text-3xl font-bold text-purple-400">{stats.phases}</p>
          </div>
        </div>

        <div className="bg-slate-800/30 rounded-lg p-4">
          <h3 className="text-sm font-semibold text-white mb-3">Recent Opportunities</h3>
          <div className="space-y-2">
            {opportunities.slice(0, 5).map((opp, idx) => (
              <div key={idx} className="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
                <div>
                  <p className="text-sm font-medium text-white">{opp.title || opp.nickname || 'Untitled'}</p>
                  <p className="text-xs text-slate-400">{opp.agency || 'TBD'}</p>
                </div>
                <div className="text-right">
                  <p className="text-sm font-mono text-emerald-400">{ExportUtils.formatCurrency(opp.ceiling)}</p>
                  <p className="text-xs text-slate-500">{opp.win_probability || 0}% win</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// GENERIC MODULE
// ============================================================
const GenericModule = ({ module, currentRole }) => (
  <div className="p-6 space-y-6 animate-fadeIn">
    <Card>
      <div className="flex items-center gap-3 mb-4">
        <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: `${module.color}20` }}>
          <Icon name={module.icon} className="w-6 h-6" style={{ color: module.color }} />
        </div>
        <div>
          <h2 className="text-xl font-bold text-white">{module.name}</h2>
          <p className="text-slate-400">Use AI Assistant or Export Center for data</p>
        </div>
      </div>
      <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
        <p className="text-sm text-slate-400">
          <Icon name="sparkles" className="w-4 h-4 inline mr-2 text-cyan-400" />
          Click the chat button to ask AI agents about {module.name.toLowerCase()}.
        </p>
      </div>
    </Card>
  </div>
);

// ============================================================
// AI CHAT PANEL
// ============================================================
const AIChatPanel = ({ isOpen, onClose, currentRole, activeModule }) => {
  const [selectedAgent, setSelectedAgent] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [showAgentSelector, setShowAgentSelector] = useState(true);
  const messagesEndRef = useRef(null);

  const accessibleAgents = useMemo(() => AI_AGENTS.filter(agent => currentRole.agentAccess?.includes(agent.id)), [currentRole]);
  
  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const sendMessage = async () => {
    if (!input.trim() || !selectedAgent || isLoading) return;
    const userMessage = { role: 'user', content: input, timestamp: new Date() };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setIsLoading(true);
    
    try {
      const response = await fetch(`${API_BASE_URL}/api/agents/${selectedAgent.id}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: input, conversation_history: messages.map(m => ({ role: m.role, content: m.content })), context: { module: activeModule?.id, role: currentRole.id } })
      });
      if (response.ok) {
        const data = await response.json();
        setMessages(prev => [...prev, { role: 'assistant', content: data.message || data.response || "I've analyzed your request.", agent: selectedAgent, timestamp: new Date() }]);
      } else { throw new Error('API unavailable'); }
    } catch (error) {
      const demoResponses = {
        capture: "Based on 12-factor analysis, I estimate 68% win probability. Key strengths: incumbent knowledge, past performance. Risks: pricing pressure, staffing timeline.",
        strategy: "3 win themes: 1) Proven Mission Understanding, 2) Technical Innovation, 3) Cost-Effective Delivery.",
        compliance: "Identified 47 L/M requirements. 12 are high-risk compliance items.",
        writer: "I can draft your technical approach using Shipley methodology.",
        pricing: "For 5-FTE team over 3 years: $4.2M estimated with 28% wrap rate.",
        blackhat: "Ghost team analysis: Incumbent will emphasize transition advantage.",
        contracts: "Section H has 3 high-risk clauses requiring negotiation.",
        orals: "5 tough questions prepared for your practice session."
      };
      setMessages(prev => [...prev, { role: 'assistant', content: demoResponses[selectedAgent.id] || `Ready to help.`, agent: selectedAgent, timestamp: new Date() }]);
    } finally { setIsLoading(false); }
  };

  const selectAgent = (agent) => {
    setSelectedAgent(agent);
    setShowAgentSelector(false);
    setMessages([{ role: 'assistant', content: `Hi! I'm the ${agent.name}. Try asking: "${agent.examplePrompts[0]}"`, agent, timestamp: new Date() }]);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed right-0 top-0 bottom-6 w-96 bg-slate-900/98 border-l border-slate-700 flex flex-col z-40 animate-slideIn no-print">
      <div className="p-4 border-b border-slate-700 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
            <Icon name="sparkles" className="w-5 h-5 text-white" />
          </div>
          <div><h3 className="font-semibold text-white">AI Assistant</h3><p className="text-xs text-slate-400">{accessibleAgents.length} agents</p></div>
        </div>
        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><Icon name="x" className="w-5 h-5" /></button>
      </div>

      {showAgentSelector ? (
        <div className="flex-1 overflow-y-auto p-4">
          <p className="text-sm text-slate-400 mb-4">Select an AI agent:</p>
          <div className="space-y-2">
            {accessibleAgents.map(agent => (
              <button key={agent.id} onClick={() => selectAgent(agent)} className="w-full p-3 rounded-lg border border-slate-700 hover:border-cyan-500/50 hover:bg-slate-800/50 transition-all text-left">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${agent.color}20` }}>
                    <Icon name={agent.icon} className="w-5 h-5" style={{ color: agent.color }} />
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-white">{agent.name}</p>
                    <p className="text-xs text-slate-400">{agent.description}</p>
                  </div>
                </div>
              </button>
            ))}
          </div>
        </div>
      ) : (
        <>
          <div className="p-3 border-b border-slate-700 bg-slate-800/50">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${selectedAgent.color}20` }}>
                  <Icon name={selectedAgent.icon} className="w-4 h-4" style={{ color: selectedAgent.color }} />
                </div>
                <p className="text-sm font-medium text-white">{selectedAgent.name}</p>
              </div>
              <button onClick={() => setShowAgentSelector(true)} className="text-xs text-cyan-400">Switch</button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] rounded-xl p-3 ${msg.role === 'user' ? 'bg-cyan-500/20 border border-cyan-500/30' : 'bg-slate-800 border border-slate-700'}`}>
                  <p className="text-sm text-slate-200 whitespace-pre-wrap">{msg.content}</p>
                </div>
              </div>
            ))}
            {isLoading && <div className="flex justify-start"><div className="bg-slate-800 border border-slate-700 rounded-xl p-3"><div className="flex gap-1"><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div></div></div></div>}
            <div ref={messagesEndRef} />
          </div>
          <div className="p-4 border-t border-slate-700">
            <div className="flex gap-2">
              <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()} placeholder={`Ask ${selectedAgent?.name}...`} className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500" />
              <button onClick={sendMessage} disabled={!input.trim() || isLoading} className="p-2 bg-cyan-500 hover:bg-cyan-400 disabled:opacity-50 rounded-lg"><Icon name="send" className="w-5 h-5 text-white" /></button>
            </div>
            <p className="text-[10px] text-slate-500 mt-2 text-center">AI GENERATED - REQUIRES HUMAN REVIEW</p>
          </div>
        </>
      )}
    </div>
  );
};

const FloatingChatButton = ({ onClick }) => (
  <button onClick={onClick} className="fixed bottom-10 right-6 w-14 h-14 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-full shadow-lg hover:shadow-cyan-500/30 flex items-center justify-center transition-all hover:scale-110 z-30 no-print">
    <Icon name="messageSquare" className="w-6 h-6 text-white" />
  </button>
);

// ============================================================
// SIDEBAR
// ============================================================
const Sidebar = ({ currentRole, activeModule, onModuleSelect, onRoleChange, onSignOut, userEmail }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [showRoleSwitcher, setShowRoleSwitcher] = useState(false);
  const [expandedCategories, setExpandedCategories] = useState(['Strategy', 'Intelligence', 'Delivery', 'Command']);

  const accessibleModules = useMemo(() => MODULES.filter(m => currentRole.access.includes(m.id)), [currentRole]);
  const modulesByCategory = useMemo(() => {
    const grouped = {};
    MODULE_CATEGORIES.forEach(cat => { grouped[cat.id] = accessibleModules.filter(m => m.category === cat.id); });
    return grouped;
  }, [accessibleModules]);

  return (
    <aside className={`flex-shrink-0 h-screen bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all duration-300 no-print ${collapsed ? 'w-16' : 'w-64'}`}>
      <div className="p-4 border-b border-slate-800">
        <div className="flex items-center justify-between">
          {!collapsed && (
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center"><span className="text-white font-bold text-sm">MP</span></div>
              <div><h1 className="text-sm font-bold text-white">MissionPulse</h1><p className="text-[10px] text-slate-500">v12.0 â¢ Sprint 12</p></div>
            </div>
          )}
          <button onClick={() => setCollapsed(!collapsed)} className="p-1.5 rounded-lg hover:bg-slate-800 text-slate-400"><Icon name={collapsed ? 'chevronRight' : 'chevronLeft'} className="w-4 h-4" /></button>
        </div>
      </div>

      <div className={`p-3 border-b border-slate-800 ${collapsed ? 'text-center' : ''}`}>
        <button onClick={() => setShowRoleSwitcher(!showRoleSwitcher)} className="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-slate-800/50">
          <div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style={{ backgroundColor: currentRole.bgColor }}><Icon name={currentRole.icon} className="w-4 h-4" style={{ color: currentRole.color }} /></div>
          {!collapsed && (<><div className="flex-1 text-left"><p className="text-sm font-medium text-white">{currentRole.fullName}</p><p className="text-xs text-slate-400">{currentRole.canExport ? 'Can Export' : 'View Only'}</p></div><Icon name="chevronDown" className={`w-4 h-4 text-slate-400 ${showRoleSwitcher ? 'rotate-180' : ''}`} /></>)}
        </button>
        {showRoleSwitcher && !collapsed && (
          <div className="mt-2 p-2 bg-slate-800/50 rounded-lg border border-slate-700/50 max-h-64 overflow-y-auto animate-fadeIn">
            {ROLES.map(role => (
              <button key={role.id} onClick={() => { onRoleChange(role); setShowRoleSwitcher(false); }} className={`w-full flex items-center gap-2 p-2 rounded-lg ${currentRole.id === role.id ? 'bg-cyan-500/20 border border-cyan-500/30' : 'hover:bg-slate-700/50'}`}>
                <div className="w-6 h-6 rounded-md flex items-center justify-center" style={{ backgroundColor: role.bgColor }}><Icon name={role.icon} className="w-3 h-3" style={{ color: role.color }} /></div>
                <div className="flex-1 text-left"><p className="text-xs font-medium text-white">{role.name}</p></div>
                {role.canExport && <Icon name="download" className="w-3 h-3 text-emerald-400" />}
              </button>
            ))}
          </div>
        )}
      </div>

      <nav className="flex-1 overflow-y-auto p-3 space-y-1">
        {MODULE_CATEGORIES.map(category => {
          const catModules = modulesByCategory[category.id] || [];
          if (catModules.length === 0) return null;
          const isExpanded = expandedCategories.includes(category.id);
          return (
            <div key={category.id} className="mb-2">
              {!collapsed && (<button onClick={() => setExpandedCategories(prev => prev.includes(category.id) ? prev.filter(c => c !== category.id) : [...prev, category.id])} className="w-full flex items-center justify-between px-2 py-1.5 text-[10px] uppercase font-semibold text-slate-500 hover:text-slate-300"><span>{category.name}</span><Icon name={isExpanded ? 'chevronDown' : 'chevronRight'} className="w-3 h-3" /></button>)}
              {(isExpanded || collapsed) && (
                <div className="space-y-0.5">
                  {catModules.map(mod => {
                    const isActive = activeModule?.id === mod.id;
                    return (
                      <button key={mod.id} onClick={() => onModuleSelect(mod)} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all ${isActive ? 'bg-gradient-to-r from-cyan-500/20 to-transparent border-l-2 border-cyan-400' : 'hover:bg-slate-800/50'}`}>
                        <div className="w-7 h-7 rounded-lg flex items-center justify-center flex-shrink-0" style={{ backgroundColor: isActive ? `${mod.color}30` : `${mod.color}15` }}><Icon name={mod.icon} className="w-3.5 h-3.5" style={{ color: mod.color }} /></div>
                        {!collapsed && <p className={`flex-1 text-left text-sm font-medium ${isActive ? 'text-white' : 'text-slate-300'}`}>{mod.name}</p>}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </nav>

      <div className={`p-3 border-t border-slate-800 ${collapsed ? 'text-center' : ''}`}>
        {!collapsed && userEmail && <p className="text-[10px] text-slate-500 truncate mb-2 px-2">{userEmail}</p>}
        <button onClick={onSignOut} className="w-full flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-red-500/10 text-slate-400 hover:text-red-400"><Icon name="logOut" className="w-4 h-4" />{!collapsed && <span className="text-sm">Sign Out</span>}</button>
      </div>

      <div className={`p-3 border-t border-slate-800 ${collapsed ? 'text-center' : ''}`}>
        <div className="flex items-center gap-2 px-2"><span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse" />{!collapsed && <span className="text-[10px] text-slate-400">Export Ready</span>}</div>
      </div>
    </aside>
  );
};

// ============================================================
// MAIN CONTENT
// ============================================================
const MainContent = ({ activeModule, currentRole, opportunities }) => {
  const renderModule = () => {
    if (!activeModule) {
      return (
        <div className="h-full flex items-center justify-center">
          <div className="text-center">
            <Icon name="activity" className="w-16 h-16 text-cyan-500/30 mx-auto mb-4" />
            <h2 className="text-xl font-semibold text-white mb-2">Select a Module</h2>
            <p className="text-slate-400">{currentRole.access.length} modules available</p>
          </div>
        </div>
      );
    }
    
    switch (activeModule.id) {
      case 'dashboard': return <DashboardModule opportunities={opportunities} currentRole={currentRole} />;
      case 'pipeline': return <PipelineModule opportunities={opportunities} currentRole={currentRole} />;
      case 'admin': return <ExportCenter opportunities={opportunities} currentRole={currentRole} />;
      default: return <GenericModule module={activeModule} currentRole={currentRole} />;
    }
  };

  return (
    <div className="flex-1 flex flex-col overflow-hidden">
      <header className="h-14 bg-slate-900/95 border-b border-slate-800 flex items-center justify-between px-6 no-print">
        <div className="flex items-center gap-4">
          {activeModule && (<><div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${activeModule.color}20` }}><Icon name={activeModule.icon} className="w-4 h-4" style={{ color: activeModule.color }} /></div><h1 className="text-lg font-semibold text-white">{activeModule.name}</h1></>)}
        </div>
        <div className="flex items-center gap-3">
          <Badge color={currentRole.color}>{currentRole.name}</Badge>
          {currentRole.canExport && <Badge color="#10B981">Export Enabled</Badge>}
        </div>
      </header>
      <main className="flex-1 overflow-auto bg-[#00050F]">{renderModule()}</main>
    </div>
  );
};

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [currentRole, setCurrentRole] = useState(ROLES[0]);
  const [activeModule, setActiveModule] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [chatOpen, setChatOpen] = useState(false);
  const [opportunities, setOpportunities] = useState([]);

  useEffect(() => {
    const checkAuth = async () => {
      if (supabase) { const { data: { session } } = await supabase.auth.getSession(); setUser(session?.user || null); }
      setLoading(false);
    };
    checkAuth();
    if (supabase) {
      const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => { setUser(session?.user || null); if (!session) window.location.href = 'login.html'; });
      return () => subscription?.unsubscribe();
    }
  }, []);

  useEffect(() => {
    const fetchData = async () => {
      if (!supabase) return;
      try {
        const { data, error } = await supabase.from('opportunities').select('*').order('created_at', { ascending: false });
        if (!error && data) setOpportunities(data);
      } catch (e) { console.error('Fetch error:', e); }
    };
    fetchData();
  }, []);

  useEffect(() => {
    const savedRole = localStorage.getItem('missionpulse_role');
    const savedModule = localStorage.getItem('missionpulse_module');
    if (savedRole) { const role = ROLES.find(r => r.id === savedRole); if (role) setCurrentRole(role); }
    if (savedModule) { const mod = MODULES.find(m => m.id === savedModule); if (mod) setActiveModule(mod); }
  }, []);

  useEffect(() => { localStorage.setItem('missionpulse_role', currentRole.id); }, [currentRole]);
  useEffect(() => { if (activeModule) localStorage.setItem('missionpulse_module', activeModule.id); }, [activeModule]);

  const handleRoleChange = (newRole) => {
    setCurrentRole(newRole);
    if (activeModule && !newRole.access.includes(activeModule.id)) {
      const firstAccessible = MODULES.find(m => newRole.access.includes(m.id));
      setActiveModule(firstAccessible || null);
    }
  };

  const handleModuleSelect = (mod) => { if (currentRole.access.includes(mod.id)) setActiveModule(mod); };

  const handleSignOut = async () => {
    if (supabase) await supabase.auth.signOut();
    localStorage.removeItem('missionpulse_role');
    localStorage.removeItem('missionpulse_module');
    window.location.href = 'login.html';
  };

  if (loading) return (<div className="h-screen flex items-center justify-center bg-[#00050F]"><div className="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div></div>);

  return (
    <DataContext.Provider value={{ opportunities }}>
      <RoleContext.Provider value={{ currentRole, setCurrentRole: handleRoleChange }}>
        <div className="h-screen flex bg-[#00050F] overflow-hidden">
          <Sidebar currentRole={currentRole} activeModule={activeModule} onModuleSelect={handleModuleSelect} onRoleChange={handleRoleChange} onSignOut={handleSignOut} userEmail={user?.email} />
          <MainContent activeModule={activeModule} currentRole={currentRole} opportunities={opportunities} />
        </div>
        <AIChatPanel isOpen={chatOpen} onClose={() => setChatOpen(false)} currentRole={currentRole} activeModule={activeModule} />
        {!chatOpen && <FloatingChatButton onClick={() => setChatOpen(true)} />}
        <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-50 no-print">
          <span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW â¢ MissionPulse v12.0 â¢ Â© 2026 Mission Meets Tech</span>
        </div>
      </RoleContext.Provider>
    </DataContext.Provider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
