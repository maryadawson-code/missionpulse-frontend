<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse - RFP Shredder</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; color: #F8FAFC; }
    .card { background: #0d1f3c; border: 1px solid rgba(0, 229, 250, 0.3); border-radius: 12px; }
    .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #0891B2 100%); color: #00050F; font-weight: 600; }
    .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
    .glow-text { text-shadow: 0 0 10px rgba(0, 229, 250, 0.5); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .type-shall { border-left: 4px solid #EF4444; }
    .type-should { border-left: 4px solid #F59E0B; }
    .type-may { border-left: 4px solid #10B981; }
    .type-will { border-left: 4px solid #8B5CF6; }
  </style>
</head>
<body class="p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <a href="index.html" class="text-gray-400 hover:text-cyan-400">‚Üê Dashboard</a>
      <h1 class="text-2xl font-bold"><span class="text-cyan-400 glow-text">RFP</span> Shredder</h1>
    </div>
    <div class="flex items-center gap-4">
      <div id="connectionStatus" class="flex items-center gap-2 text-sm">
        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
        <span class="text-gray-400">Connecting...</span>
      </div>
      <select id="opportunityFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm">
        <option value="">Select Opportunity</option>
      </select>
      <button onclick="openAddModal()" class="btn-primary px-4 py-2 rounded-lg">+ Add Requirement</button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-6 gap-4 mb-6">
    <div class="card p-4 text-center">
      <div id="statTotal" class="text-3xl font-bold text-cyan-400">0</div>
      <div class="text-gray-400 text-sm">Total Reqs</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statShall" class="text-3xl font-bold text-red-400">0</div>
      <div class="text-gray-400 text-sm">SHALL</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statMapped" class="text-3xl font-bold text-green-400">0</div>
      <div class="text-gray-400 text-sm">Mapped</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statCompliant" class="text-3xl font-bold text-emerald-400">0</div>
      <div class="text-gray-400 text-sm">Compliant</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statRisks" class="text-3xl font-bold text-amber-400">0</div>
      <div class="text-gray-400 text-sm">Risks</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statProgress" class="text-3xl font-bold text-purple-400">0%</div>
      <div class="text-gray-400 text-sm">Progress</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card p-4 mb-6">
    <div class="flex gap-4">
      <input type="text" id="searchInput" placeholder="Search requirements..." class="flex-1 bg-slate-800 border border-slate-600 rounded px-4 py-2" oninput="filterRequirements()">
      <select id="typeFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2" onchange="filterRequirements()">
        <option value="">All Types</option>
        <option value="shall">SHALL</option>
        <option value="should">SHOULD</option>
        <option value="will">WILL</option>
        <option value="may">MAY</option>
      </select>
      <select id="sectionFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2" onchange="filterRequirements()">
        <option value="">All Sections</option>
        <option value="L">Section L</option>
        <option value="M">Section M</option>
        <option value="C">Section C</option>
      </select>
      <select id="statusFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2" onchange="filterRequirements()">
        <option value="">All Status</option>
        <option value="unmapped">Unmapped</option>
        <option value="mapped">Mapped</option>
        <option value="risk">Has Risk</option>
      </select>
    </div>
  </div>

  <!-- Requirements Grid -->
  <div id="requirementsContainer" class="space-y-3">
    <div class="card p-8 text-center text-gray-500">Select an opportunity to view requirements</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="reqModal" class="modal hidden">
    <div class="card p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="text-xl font-bold text-cyan-400">Add Requirement</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <form id="reqForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="reqId">
        
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Requirement ID *</label>
            <input type="text" id="requirementId" required placeholder="L-001" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">RFP Section</label>
            <select id="rfpSection" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="L">Section L</option>
              <option value="M">Section M</option>
              <option value="C">Section C</option>
              <option value="H">Section H</option>
              <option value="I">Section I</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Type *</label>
            <select id="requirementType" required class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="shall">SHALL</option>
              <option value="should">SHOULD</option>
              <option value="will">WILL</option>
              <option value="may">MAY</option>
            </select>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Requirement Text *</label>
          <textarea id="requirementText" required rows="3" placeholder="The Contractor shall..." class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Priority</label>
            <select id="priority" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Source Page</label>
            <input type="text" id="sourcePage" placeholder="p. 42" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Assigned To</label>
            <input type="text" id="assignedTo" placeholder="Author name..." class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Proposal Section Mapping</label>
          <input type="text" id="proposalSection" placeholder="Technical Approach 2.1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Compliance Response</label>
          <textarea id="complianceResponse" rows="2" placeholder="How we address this requirement..." class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="flex gap-6 mb-4">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="isMapped" class="rounded border-slate-600">
            <span class="text-sm text-gray-400">Mapped to proposal</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="isCompliant" class="rounded border-slate-600">
            <span class="text-sm text-gray-400">Compliant</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="isRisk" class="rounded border-slate-600">
            <span class="text-sm text-gray-400">Risk Flag</span>
          </label>
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-700 rounded-lg hover:bg-slate-600">Cancel</button>
          <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Requirement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-8 text-center text-xs text-gray-500">AI GENERATED - REQUIRES HUMAN REVIEW | MissionPulse ¬© 2026</div>

  <script>
    const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MTcyNjUsImV4cCI6MjA1MjI5MzI2NX0.DACT1xnVtJeHx5tL7_K8y1hOx9NyJE7B6UBhPqwHHx8';
    
    let supabase, allRequirements = [], opportunities = [], editingId = null;

    function initSupabase() {
      if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        updateConnectionStatus(true);
        return true;
      }
      return false;
    }

    function updateConnectionStatus(connected) {
      document.getElementById('connectionStatus').innerHTML = connected 
        ? `<span class="w-2 h-2 rounded-full bg-green-400"></span><span class="text-green-400">Connected</span>`
        : `<span class="w-2 h-2 rounded-full bg-red-400"></span><span class="text-red-400">Disconnected</span>`;
    }

    async function loadOpportunities() {
      try {
        const { data } = await supabase.from('opportunities').select('id, title, name').order('title');
        opportunities = data || [];
        document.getElementById('opportunityFilter').innerHTML = `<option value="">Select Opportunity</option>` + 
          opportunities.map(o => `<option value="${o.id}">${o.title || o.name}</option>`).join('');
      } catch (err) { console.error('Failed to load opportunities:', err); }
    }

    async function loadRequirements() {
      try {
        const oppFilter = document.getElementById('opportunityFilter').value;
        if (!oppFilter) {
          showEmptyState('Select an opportunity to view requirements');
          return;
        }
        
        const { data, error } = await supabase.from('rfp_requirements')
          .select('*')
          .eq('opportunity_id', oppFilter)
          .order('requirement_id');
        if (error) throw error;
        
        allRequirements = data || [];
        filterRequirements();
        updateStats();
      } catch (err) {
        console.error('Failed to load requirements:', err);
        showEmptyState('Failed to load requirements');
      }
    }

    function filterRequirements() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value;
      const sectionFilter = document.getElementById('sectionFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      const filtered = allRequirements.filter(r => {
        const matchesSearch = !search || r.requirement_text?.toLowerCase().includes(search) || r.requirement_id?.toLowerCase().includes(search);
        const matchesType = !typeFilter || r.requirement_type === typeFilter;
        const matchesSection = !sectionFilter || r.rfp_section === sectionFilter;
        const matchesStatus = !statusFilter || 
          (statusFilter === 'unmapped' && !r.is_mapped) ||
          (statusFilter === 'mapped' && r.is_mapped) ||
          (statusFilter === 'risk' && r.is_risk);
        return matchesSearch && matchesType && matchesSection && matchesStatus;
      });
      renderRequirements(filtered);
    }

    function renderRequirements(reqs) {
      const container = document.getElementById('requirementsContainer');
      if (reqs.length === 0) {
        showEmptyState('No requirements found');
        return;
      }
      
      container.innerHTML = reqs.map(r => `
        <div class="card p-4 type-${r.requirement_type || 'shall'} hover:border-cyan-400/50 cursor-pointer" onclick="openEditModal('${r.id}')">
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center gap-3">
              <span class="font-mono text-cyan-400 text-sm">${r.requirement_id || '-'}</span>
              <span class="text-xs px-2 py-0.5 rounded ${getTypeClass(r.requirement_type)}">${(r.requirement_type || 'shall').toUpperCase()}</span>
              ${r.is_risk ? '<span class="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-400">‚ö†Ô∏è RISK</span>' : ''}
            </div>
            <div class="flex items-center gap-2">
              ${r.is_mapped ? '<span class="text-xs text-green-400">‚úì Mapped</span>' : '<span class="text-xs text-gray-500">Unmapped</span>'}
              ${r.is_compliant ? '<span class="text-xs text-emerald-400 ml-2">‚úì Compliant</span>' : ''}
            </div>
          </div>
          
          <p class="text-sm text-gray-300 mb-2">${truncate(r.requirement_text, 200)}</p>
          
          <div class="flex items-center gap-4 text-xs text-gray-500">
            <span>üìã Section ${r.rfp_section || '-'}</span>
            ${r.source_page ? `<span>üìÑ ${r.source_page}</span>` : ''}
            ${r.proposal_section ? `<span class="text-cyan-400">‚Üí ${r.proposal_section}</span>` : ''}
            ${r.assigned_to ? `<span>üë§ ${r.assigned_to}</span>` : ''}
          </div>
          
          ${r.compliance_response ? `<div class="mt-2 text-xs text-gray-400 bg-slate-800 rounded p-2">üí¨ ${truncate(r.compliance_response, 100)}</div>` : ''}
        </div>
      `).join('');
    }

    function showEmptyState(message) {
      document.getElementById('requirementsContainer').innerHTML = `
        <div class="card p-8 text-center text-gray-500">
          <p>${message}</p>
          ${document.getElementById('opportunityFilter').value ? `<button onclick="openAddModal()" class="btn-primary px-4 py-2 rounded-lg mt-4">Add First Requirement</button>` : ''}
        </div>`;
    }

    function getTypeClass(type) {
      return { shall: 'bg-red-500/20 text-red-400', should: 'bg-amber-500/20 text-amber-400', may: 'bg-green-500/20 text-green-400', will: 'bg-purple-500/20 text-purple-400' }[type] || 'bg-gray-500/20 text-gray-400';
    }

    function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : str || ''; }

    function updateStats() {
      const total = allRequirements.length;
      const shall = allRequirements.filter(r => r.requirement_type === 'shall').length;
      const mapped = allRequirements.filter(r => r.is_mapped).length;
      const compliant = allRequirements.filter(r => r.is_compliant).length;
      const risks = allRequirements.filter(r => r.is_risk).length;
      const progress = total > 0 ? Math.round((mapped / total) * 100) : 0;
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statShall').textContent = shall;
      document.getElementById('statMapped').textContent = mapped;
      document.getElementById('statCompliant').textContent = compliant;
      document.getElementById('statRisks').textContent = risks;
      document.getElementById('statProgress').textContent = progress + '%';
    }

    function openAddModal() {
      if (!document.getElementById('opportunityFilter').value) {
        alert('Please select an opportunity first');
        return;
      }
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Requirement';
      document.getElementById('reqForm').reset();
      document.getElementById('reqModal').classList.remove('hidden');
    }

    function openEditModal(id) {
      const req = allRequirements.find(r => r.id === id);
      if (!req) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Requirement';
      document.getElementById('reqId').value = id;
      document.getElementById('requirementId').value = req.requirement_id || '';
      document.getElementById('rfpSection').value = req.rfp_section || 'L';
      document.getElementById('requirementType').value = req.requirement_type || 'shall';
      document.getElementById('requirementText').value = req.requirement_text || '';
      document.getElementById('priority').value = req.priority || 'medium';
      document.getElementById('sourcePage').value = req.source_page || '';
      document.getElementById('assignedTo').value = req.assigned_to || '';
      document.getElementById('proposalSection').value = req.proposal_section || '';
      document.getElementById('complianceResponse').value = req.compliance_response || '';
      document.getElementById('isMapped').checked = req.is_mapped || false;
      document.getElementById('isCompliant').checked = req.is_compliant || false;
      document.getElementById('isRisk').checked = req.is_risk || false;
      document.getElementById('reqModal').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('reqModal').classList.add('hidden'); editingId = null; }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const reqData = {
        requirement_id: document.getElementById('requirementId').value,
        rfp_section: document.getElementById('rfpSection').value,
        requirement_type: document.getElementById('requirementType').value,
        requirement_text: document.getElementById('requirementText').value,
        priority: document.getElementById('priority').value,
        source_page: document.getElementById('sourcePage').value || null,
        assigned_to: document.getElementById('assignedTo').value || null,
        proposal_section: document.getElementById('proposalSection').value || null,
        compliance_response: document.getElementById('complianceResponse').value || null,
        is_mapped: document.getElementById('isMapped').checked,
        is_compliant: document.getElementById('isCompliant').checked,
        is_risk: document.getElementById('isRisk').checked,
        opportunity_id: document.getElementById('opportunityFilter').value,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingId) {
          const { error } = await supabase.from('rfp_requirements').update(reqData).eq('id', editingId);
          if (error) throw error;
        } else {
          reqData.created_at = new Date().toISOString();
          const { error } = await supabase.from('rfp_requirements').insert([reqData]);
          if (error) throw error;
        }
        closeModal();
        await loadRequirements();
      } catch (err) { console.error('Failed to save:', err); alert('Failed to save: ' + err.message); }
    }

    function subscribeToChanges() {
      supabase.channel('rfp_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'rfp_requirements' }, () => loadRequirements()).subscribe();
    }

    document.getElementById('opportunityFilter').addEventListener('change', loadRequirements);

    async function init() {
      if (!initSupabase()) { updateConnectionStatus(false); return; }
      await loadOpportunities();
      subscribeToChanges();
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  </script>
</body>
</html>
