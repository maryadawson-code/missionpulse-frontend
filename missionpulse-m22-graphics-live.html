<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphics & Exhibits Tracker | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: linear-gradient(135deg, #00050F 0%, #000A1A 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); border-radius: 0.75rem; }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .cyan-glow { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
        .status-needed { background: rgba(239, 68, 68, 0.2); color: #FCA5A5; }
        .status-in-progress { background: rgba(245, 158, 11, 0.2); color: #FCD34D; }
        .status-draft { background: rgba(139, 92, 246, 0.2); color: #C4B5FD; }
        .status-review { background: rgba(6, 182, 212, 0.2); color: #67E8F9; }
        .status-approved { background: rgba(16, 185, 129, 0.2); color: #6EE7B7; }
        .type-figure { background: rgba(236, 72, 153, 0.2); color: #F9A8D4; }
        .type-table { background: rgba(99, 102, 241, 0.2); color: #A5B4FC; }
        .type-chart { background: rgba(245, 158, 11, 0.2); color: #FCD34D; }
        .type-diagram { background: rgba(16, 185, 129, 0.2); color: #6EE7B7; }
        .type-photo { background: rgba(139, 92, 246, 0.2); color: #C4B5FD; }
        .type-screenshot { background: rgba(6, 182, 212, 0.2); color: #67E8F9; }
        .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #00B8D4 100%); color: #00050F; font-weight: 600; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .modal-overlay { background: rgba(0, 5, 15, 0.9); backdrop-filter: blur(4px); }
        .progress-bar { background: rgba(0, 229, 250, 0.2); border-radius: 9999px; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #00E5FA, #00B8D4); height: 100%; transition: width 0.3s; }
    </style>
</head>
<body class="text-white font-sans">
    <!-- Sidebar -->
    <div id="missionpulse-sidebar" data-current-page="graphics"></div>
    <script src="missionpulse-nav.js"></script>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 260px;">
        <!-- Header -->
        <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-3xl">üé®</div>
                        <div>
                            <h1 class="text-2xl font-bold text-cyan-400">Graphics & Exhibits Tracker</h1>
                            <p class="text-white/50 text-sm">Manage figures, tables, and visual assets</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="connectionStatus" class="flex items-center gap-2 text-sm">
                            <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                            <span class="text-white/50">Checking...</span>
                        </div>
                        <button onclick="openModal()" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2">
                            <span>+ Add Exhibit</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Opportunity Selector -->
            <div class="mb-6">
                <label class="block text-white/60 text-sm mb-2">Select Opportunity</label>
                <select id="opportunitySelect" onchange="loadExhibits()" class="w-full md:w-96 bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-3 text-white focus:border-cyan-400 focus:outline-none">
                    <option value="">Loading opportunities...</option>
                </select>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
                <div class="glass-card p-4 text-center">
                    <div id="statTotal" class="text-2xl font-bold text-cyan-400">0</div>
                    <div class="text-xs text-white/50">Total Exhibits</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statNeeded" class="text-2xl font-bold text-red-400">0</div>
                    <div class="text-xs text-white/50">Needed</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statInProgress" class="text-2xl font-bold text-yellow-400">0</div>
                    <div class="text-xs text-white/50">In Progress</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statReview" class="text-2xl font-bold text-cyan-400">0</div>
                    <div class="text-xs text-white/50">In Review</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statApproved" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-white/50">Approved</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statPages" class="text-2xl font-bold text-purple-400">0/0</div>
                    <div class="text-xs text-white/50">Pages Used</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="glass-card p-4 mb-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Type:</label>
                        <select id="filterType" onchange="applyFilters()" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white">
                            <option value="">All Types</option>
                            <option value="figure">Figure</option>
                            <option value="table">Table</option>
                            <option value="chart">Chart</option>
                            <option value="diagram">Diagram</option>
                            <option value="photo">Photo</option>
                            <option value="screenshot">Screenshot</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Status:</label>
                        <select id="filterStatus" onchange="applyFilters()" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white">
                            <option value="">All Status</option>
                            <option value="needed">Needed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="draft">Draft</option>
                            <option value="review">In Review</option>
                            <option value="approved">Approved</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Section:</label>
                        <input type="text" id="filterSection" onkeyup="applyFilters()" placeholder="e.g., L.1.2" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white w-32">
                    </div>
                    <div class="ml-auto">
                        <input type="text" id="searchBox" onkeyup="applyFilters()" placeholder="Search exhibits..." class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white w-48">
                    </div>
                </div>
            </div>

            <!-- Exhibits Table -->
            <div class="glass-card cyan-glow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-cyan-500/10 border-b border-cyan-500/20">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Exhibit #</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Title</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Section</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Assigned</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Pages</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Due</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-cyan-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="exhibitsTable" class="divide-y divide-cyan-500/10">
                            <tr><td colspan="9" class="px-4 py-8 text-center text-white/40">Select an opportunity to view exhibits</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Page Budget Summary -->
            <div class="mt-6 glass-card p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/60 text-sm">Page Budget</span>
                    <span id="pageBudgetText" class="text-cyan-400 text-sm">0 / 0 pages</span>
                </div>
                <div class="progress-bar h-3">
                    <div id="pageBudgetBar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t border-cyan-500/20 mt-12">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <p class="text-center text-white/30 text-xs">AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
                <p class="text-center text-white/20 text-xs mt-1">¬© 2025 Mission Meets Tech. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Add/Edit Modal -->
    <div id="exhibitModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-cyan-500/20 flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-bold text-cyan-400">Add Exhibit</h3>
                <button onclick="closeModal()" class="text-white/50 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="exhibitForm" onsubmit="saveExhibit(event)" class="p-6 space-y-4">
                <input type="hidden" id="exhibitId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Exhibit Number *</label>
                        <input type="text" id="exhibitNumber" required placeholder="e.g., Figure 1" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Type *</label>
                        <select id="exhibitType" required class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            <option value="figure">Figure</option>
                            <option value="table">Table</option>
                            <option value="chart">Chart</option>
                            <option value="diagram">Diagram</option>
                            <option value="photo">Photo</option>
                            <option value="screenshot">Screenshot</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-white/60 text-sm mb-1">Title *</label>
                    <input type="text" id="exhibitTitle" required placeholder="Exhibit title" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                </div>

                <div>
                    <label class="block text-white/60 text-sm mb-1">Description</label>
                    <textarea id="exhibitDescription" rows="2" placeholder="Brief description of the exhibit" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Section Reference</label>
                        <input type="text" id="exhibitSection" placeholder="e.g., L.1.2.3" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Status</label>
                        <select id="exhibitStatus" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            <option value="needed">Needed</option>
                            <option value="in-progress">In Progress</option>
                            <option value="draft">Draft</option>
                            <option value="review">In Review</option>
                            <option value="approved">Approved</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Assigned To</label>
                        <input type="text" id="exhibitAssigned" placeholder="Team member name" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Source File</label>
                        <input type="text" id="exhibitSource" placeholder="e.g., graphics/figure1.png" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Page Limit</label>
                        <input type="number" id="exhibitPageLimit" min="0" placeholder="Max pages" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Current Pages</label>
                        <input type="number" id="exhibitCurrentPages" min="0" placeholder="Pages used" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Due Date</label>
                        <input type="date" id="exhibitDueDate" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-white/60 text-sm mb-1">Notes</label>
                    <textarea id="exhibitNotes" rows="2" placeholder="Additional notes" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-cyan-500/20">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border border-cyan-500/30 rounded-lg text-white/70 hover:bg-cyan-500/10">Cancel</button>
                    <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Exhibit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Init
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTMwNjIsImV4cCI6MjA1Mjk4OTA2Mn0.gwBTnfAtsxSFDz96fDPL7HAIYdA5s_9hiv_l0ECWvYc';
        
        let supabase;
        let allExhibits = [];
        let currentOpportunityId = null;
        let isLiveMode = false;

        // Demo Data
        const demoOpportunities = [
            { id: 'demo-1', title: 'DHA DHMSM Support', nickname: 'DHMSM' },
            { id: 'demo-2', title: 'VA EHR Modernization', nickname: 'VA-EHR' },
            { id: 'demo-3', title: 'CMS Data Analytics', nickname: 'CMS-Analytics' }
        ];

        const demoExhibits = [
            { id: 'e1', opportunity_id: 'demo-1', exhibit_number: 'Figure 1', title: 'System Architecture Overview', description: 'High-level architecture diagram', section_reference: 'L.1.2', exhibit_type: 'diagram', status: 'approved', assigned_to: 'Sarah Chen', source_file: 'graphics/arch-overview.png', page_limit: 1, current_pages: 1, due_date: '2025-02-01', notes: 'Final version approved by Tech Lead' },
            { id: 'e2', opportunity_id: 'demo-1', exhibit_number: 'Figure 2', title: 'Data Flow Diagram', description: 'Shows data movement between systems', section_reference: 'L.1.3', exhibit_type: 'diagram', status: 'review', assigned_to: 'Mike Johnson', source_file: 'graphics/data-flow.vsd', page_limit: 1, current_pages: 1, due_date: '2025-02-03', notes: 'Pending security review' },
            { id: 'e3', opportunity_id: 'demo-1', exhibit_number: 'Table 1', title: 'Labor Category Matrix', description: 'Maps labor categories to requirements', section_reference: 'L.2.1', exhibit_type: 'table', status: 'in-progress', assigned_to: 'Lisa Wong', source_file: '', page_limit: 2, current_pages: 1, due_date: '2025-02-05', notes: '' },
            { id: 'e4', opportunity_id: 'demo-1', exhibit_number: 'Figure 3', title: 'Implementation Timeline', description: 'Gantt chart showing phases', section_reference: 'L.3.1', exhibit_type: 'chart', status: 'needed', assigned_to: '', source_file: '', page_limit: 1, current_pages: 0, due_date: '2025-02-07', notes: 'Need PM input' },
            { id: 'e5', opportunity_id: 'demo-1', exhibit_number: 'Figure 4', title: 'Org Chart', description: 'Project team organization', section_reference: 'L.2.2', exhibit_type: 'diagram', status: 'draft', assigned_to: 'Tom Davis', source_file: 'graphics/org-chart-draft.pptx', page_limit: 1, current_pages: 1, due_date: '2025-02-04', notes: 'Waiting on final staffing decisions' },
            { id: 'e6', opportunity_id: 'demo-1', exhibit_number: 'Table 2', title: 'Requirements Traceability Matrix', description: 'Maps requirements to solutions', section_reference: 'L.1.4', exhibit_type: 'table', status: 'in-progress', assigned_to: 'Sarah Chen', source_file: 'tables/rtm.xlsx', page_limit: 3, current_pages: 2, due_date: '2025-02-06', notes: '' },
            { id: 'e7', opportunity_id: 'demo-2', exhibit_number: 'Figure 1', title: 'EHR Integration Architecture', description: 'Shows integration points', section_reference: 'M.1.1', exhibit_type: 'diagram', status: 'needed', assigned_to: '', source_file: '', page_limit: 1, current_pages: 0, due_date: '2025-02-15', notes: '' },
            { id: 'e8', opportunity_id: 'demo-2', exhibit_number: 'Figure 2', title: 'Migration Approach', description: 'Phased migration diagram', section_reference: 'M.1.2', exhibit_type: 'diagram', status: 'in-progress', assigned_to: 'Alex Kim', source_file: '', page_limit: 1, current_pages: 0, due_date: '2025-02-12', notes: '' }
        ];

        // Initialize
        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await loadOpportunities();
            } catch (error) {
                console.error('Init error:', error);
                loadDemoMode();
            }
        }

        async function loadOpportunities() {
            try {
                const { data, error } = await supabase.from('opportunities').select('id, title, nickname').order('title');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    isLiveMode = true;
                    updateConnectionStatus(true);
                    populateOpportunitySelect(data);
                } else {
                    loadDemoMode();
                }
            } catch (error) {
                console.error('Load opportunities error:', error);
                loadDemoMode();
            }
        }

        function loadDemoMode() {
            isLiveMode = false;
            updateConnectionStatus(false);
            populateOpportunitySelect(demoOpportunities);
        }

        function updateConnectionStatus(isLive) {
            const status = document.getElementById('connectionStatus');
            if (isLive) {
                status.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-green-400">Live Database</span>';
            } else {
                status.innerHTML = '<div class="w-2 h-2 rounded-full bg-yellow-500"></div><span class="text-yellow-400">Demo Mode</span>';
            }
        }

        function populateOpportunitySelect(opportunities) {
            const select = document.getElementById('opportunitySelect');
            select.innerHTML = '<option value="">-- Select Opportunity --</option>' + 
                opportunities.map(o => `<option value="${o.id}">${o.nickname || o.title}</option>`).join('');
        }

        async function loadExhibits() {
            const oppId = document.getElementById('opportunitySelect').value;
            if (!oppId) {
                document.getElementById('exhibitsTable').innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-white/40">Select an opportunity to view exhibits</td></tr>';
                updateStats([]);
                return;
            }
            
            currentOpportunityId = oppId;

            if (isLiveMode) {
                try {
                    const { data, error } = await supabase
                        .from('exhibit_graphics')
                        .select('*')
                        .eq('opportunity_id', oppId)
                        .order('sort_order')
                        .order('exhibit_number');
                    
                    if (error) throw error;
                    allExhibits = data || [];
                } catch (error) {
                    console.error('Load exhibits error:', error);
                    allExhibits = demoExhibits.filter(e => e.opportunity_id === oppId);
                }
            } else {
                allExhibits = demoExhibits.filter(e => e.opportunity_id === oppId);
            }

            applyFilters();
        }

        function applyFilters() {
            let filtered = [...allExhibits];
            
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const sectionFilter = document.getElementById('filterSection').value.toLowerCase();
            const search = document.getElementById('searchBox').value.toLowerCase();

            if (typeFilter) filtered = filtered.filter(e => e.exhibit_type === typeFilter);
            if (statusFilter) filtered = filtered.filter(e => e.status === statusFilter);
            if (sectionFilter) filtered = filtered.filter(e => (e.section_reference || '').toLowerCase().includes(sectionFilter));
            if (search) filtered = filtered.filter(e => 
                e.title.toLowerCase().includes(search) || 
                e.exhibit_number.toLowerCase().includes(search) ||
                (e.description || '').toLowerCase().includes(search)
            );

            renderExhibits(filtered);
            updateStats(allExhibits);
        }

        function renderExhibits(exhibits) {
            const tbody = document.getElementById('exhibitsTable');
            
            if (exhibits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-white/40">No exhibits found. Click "Add Exhibit" to create one.</td></tr>';
                return;
            }

            tbody.innerHTML = exhibits.map(e => `
                <tr class="hover:bg-cyan-500/5 transition-colors">
                    <td class="px-4 py-3">
                        <span class="font-mono text-cyan-400 font-semibold">${e.exhibit_number}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-white">${e.title}</div>
                        ${e.description ? `<div class="text-xs text-white/50 mt-0.5">${e.description.substring(0, 60)}${e.description.length > 60 ? '...' : ''}</div>` : ''}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-medium type-${e.exhibit_type}">${capitalize(e.exhibit_type)}</span>
                    </td>
                    <td class="px-4 py-3 font-mono text-sm text-white/70">${e.section_reference || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-medium status-${e.status}">${formatStatus(e.status)}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-white/70">${e.assigned_to || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        ${e.page_limit ? `<span class="${(e.current_pages || 0) > e.page_limit ? 'text-red-400' : 'text-white/70'}">${e.current_pages || 0}/${e.page_limit}</span>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-sm text-white/70">${e.due_date ? formatDate(e.due_date) : '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="editExhibit('${e.id}')" class="text-cyan-400 hover:text-cyan-300 text-sm" title="Edit">‚úèÔ∏è</button>
                            <button onclick="deleteExhibit('${e.id}')" class="text-red-400 hover:text-red-300 text-sm" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(exhibits) {
            document.getElementById('statTotal').textContent = exhibits.length;
            document.getElementById('statNeeded').textContent = exhibits.filter(e => e.status === 'needed').length;
            document.getElementById('statInProgress').textContent = exhibits.filter(e => e.status === 'in-progress' || e.status === 'draft').length;
            document.getElementById('statReview').textContent = exhibits.filter(e => e.status === 'review').length;
            document.getElementById('statApproved').textContent = exhibits.filter(e => e.status === 'approved').length;

            const totalLimit = exhibits.reduce((sum, e) => sum + (e.page_limit || 0), 0);
            const totalUsed = exhibits.reduce((sum, e) => sum + (e.current_pages || 0), 0);
            document.getElementById('statPages').textContent = `${totalUsed}/${totalLimit}`;

            // Update page budget bar
            const percentage = totalLimit > 0 ? Math.min((totalUsed / totalLimit) * 100, 100) : 0;
            document.getElementById('pageBudgetText').textContent = `${totalUsed} / ${totalLimit} pages`;
            document.getElementById('pageBudgetBar').style.width = `${percentage}%`;
            document.getElementById('pageBudgetBar').style.background = percentage > 90 ? 'linear-gradient(90deg, #EF4444, #DC2626)' : 
                percentage > 75 ? 'linear-gradient(90deg, #F59E0B, #D97706)' : 'linear-gradient(90deg, #00E5FA, #00B8D4)';
        }

        function openModal(exhibit = null) {
            document.getElementById('exhibitModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = exhibit ? 'Edit Exhibit' : 'Add Exhibit';
            
            if (exhibit) {
                document.getElementById('exhibitId').value = exhibit.id;
                document.getElementById('exhibitNumber').value = exhibit.exhibit_number;
                document.getElementById('exhibitType').value = exhibit.exhibit_type;
                document.getElementById('exhibitTitle').value = exhibit.title;
                document.getElementById('exhibitDescription').value = exhibit.description || '';
                document.getElementById('exhibitSection').value = exhibit.section_reference || '';
                document.getElementById('exhibitStatus').value = exhibit.status;
                document.getElementById('exhibitAssigned').value = exhibit.assigned_to || '';
                document.getElementById('exhibitSource').value = exhibit.source_file || '';
                document.getElementById('exhibitPageLimit').value = exhibit.page_limit || '';
                document.getElementById('exhibitCurrentPages').value = exhibit.current_pages || '';
                document.getElementById('exhibitDueDate').value = exhibit.due_date || '';
                document.getElementById('exhibitNotes').value = exhibit.notes || '';
            } else {
                document.getElementById('exhibitForm').reset();
                document.getElementById('exhibitId').value = '';
            }
        }

        function closeModal() {
            document.getElementById('exhibitModal').classList.add('hidden');
        }

        async function saveExhibit(event) {
            event.preventDefault();
            
            const exhibitData = {
                opportunity_id: currentOpportunityId,
                exhibit_number: document.getElementById('exhibitNumber').value,
                exhibit_type: document.getElementById('exhibitType').value,
                title: document.getElementById('exhibitTitle').value,
                description: document.getElementById('exhibitDescription').value || null,
                section_reference: document.getElementById('exhibitSection').value || null,
                status: document.getElementById('exhibitStatus').value,
                assigned_to: document.getElementById('exhibitAssigned').value || null,
                source_file: document.getElementById('exhibitSource').value || null,
                page_limit: document.getElementById('exhibitPageLimit').value ? parseInt(document.getElementById('exhibitPageLimit').value) : null,
                current_pages: document.getElementById('exhibitCurrentPages').value ? parseInt(document.getElementById('exhibitCurrentPages').value) : null,
                due_date: document.getElementById('exhibitDueDate').value || null,
                notes: document.getElementById('exhibitNotes').value || null,
                updated_at: new Date().toISOString()
            };

            const exhibitId = document.getElementById('exhibitId').value;

            if (isLiveMode) {
                try {
                    if (exhibitId) {
                        const { error } = await supabase.from('exhibit_graphics').update(exhibitData).eq('id', exhibitId);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.from('exhibit_graphics').insert([exhibitData]);
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert('Error saving exhibit: ' + error.message);
                    return;
                }
            } else {
                // Demo mode - local update
                if (exhibitId) {
                    const idx = allExhibits.findIndex(e => e.id === exhibitId);
                    if (idx !== -1) allExhibits[idx] = { ...allExhibits[idx], ...exhibitData };
                } else {
                    allExhibits.push({ id: 'demo-' + Date.now(), ...exhibitData });
                }
            }

            closeModal();
            loadExhibits();
        }

        function editExhibit(id) {
            const exhibit = allExhibits.find(e => e.id === id);
            if (exhibit) openModal(exhibit);
        }

        async function deleteExhibit(id) {
            if (!confirm('Delete this exhibit?')) return;

            if (isLiveMode) {
                try {
                    const { error } = await supabase.from('exhibit_graphics').delete().eq('id', id);
                    if (error) throw error;
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting exhibit: ' + error.message);
                    return;
                }
            } else {
                allExhibits = allExhibits.filter(e => e.id !== id);
            }

            loadExhibits();
        }

        // Utilities
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatStatus(status) {
            const map = {
                'needed': 'Needed',
                'in-progress': 'In Progress',
                'draft': 'Draft',
                'review': 'In Review',
                'approved': 'Approved'
            };
            return map[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
