<!DOCTYPE html>
<html lang="en">
<head>
  <!-- CORE: Must load first for RBAC and connection management -->
  <script src="missionpulse-core.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse M5 - Contracts Scanner (Enhanced)</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; overflow-x: hidden; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    
    /* Animations */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scanLine { 0% { top: 0; } 100% { top: 100%; } }
    @keyframes riskPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.2); } }
    @keyframes countUp { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes trapAlert { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    @keyframes typing { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 229, 250, 0.2); } 50% { box-shadow: 0 0 40px rgba(0, 229, 250, 0.4); } }
    
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-slideIn { animation: slideIn 0.5s ease-out; }
    .animate-slideInRight { animation: slideInRight 0.4s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .animate-scanLine { animation: scanLine 2s linear infinite; }
    .animate-riskPulse { animation: riskPulse 2s ease-in-out infinite; }
    .animate-countUp { animation: countUp 0.4s ease-out forwards; }
    .animate-trapAlert { animation: trapAlert 1s ease-in-out infinite; }
    .animate-typing { animation: typing 1.5s ease-in-out infinite; }
    .animate-glow { animation: glow 2s ease-in-out infinite; }
    
    /* Scan effect */
    .scan-container { position: relative; overflow: hidden; }
    .scan-line { position: absolute; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #00E5FA, transparent); opacity: 0.6; }
    
    /* Risk glow effects */
    .risk-high { border-left-color: #EF4444; }
    .risk-medium { border-left-color: #F59E0B; }
    .risk-low { border-left-color: #10B981; }
    .risk-info { border-left-color: #3B82F6; }
    
    /* Glass morphism */
    .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(100, 116, 139, 0.2); }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0F172A; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    /* Cash flow chart */
    .cash-bar { transition: width 0.5s ease-out; }
    
    /* Chat styles */
    .chat-bubble-ai { border-radius: 16px 16px 16px 4px; }
    .chat-bubble-user { border-radius: 16px 16px 4px 16px; }
    
    /* Checkbox custom */
    .custom-checkbox:checked { background-color: #10B981; border-color: #10B981; }
  
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .skeleton { 
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ============================================
    // HARDENING LAYER - RBAC + Error Boundary
    // ============================================
    const ALLOWED_ROLES = ["CEO", "COO", "CON"];
    const MODULE_NAME = "M5 Contracts";

    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      componentDidCatch(error, errorInfo) {
        console.error(MODULE_NAME + ' Error:', error, errorInfo);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-[#00050F] flex items-center justify-center p-6">
              <div className="text-center max-w-md">
                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-red-500/20 flex items-center justify-center">
                  <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <h2 className="text-xl font-bold text-white mb-2">Module Error</h2>
                <p className="text-slate-400 mb-4">Something went wrong loading {MODULE_NAME}.</p>
                <button onClick={() => window.location.reload()} className="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600">Reload</button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    const ConnectionBanner = ({ status }) => {
      if (status === 'connected') return null;
      const config = {
        connecting: { bg: 'bg-amber-500/20', border: 'border-amber-500/30', text: 'text-amber-400', msg: 'Connecting to server...' },
        disconnected: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400', msg: 'Connection lost. Data may be stale.' },
        error: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400', msg: 'Unable to connect to server.' }
      };
      const c = config[status] || config.error;
      return (
        <div className={`${c.bg} ${c.border} border-b px-4 py-2 flex items-center gap-2`}>
          <svg className={`w-4 h-4 ${c.text} ${status === 'connecting' ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            {status === 'connecting' ? (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            ) : (
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            )}
          </svg>
          <span className={`text-sm ${c.text}`}>{c.msg}</span>
        </div>
      );
    };

    const AccessDenied = ({ userRole, requiredRoles }) => (
      <div className="min-h-screen bg-[#00050F] flex items-center justify-center p-6">
        <div className="text-center max-w-md">
          <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-red-500/20 flex items-center justify-center">
            <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h2 className="text-2xl font-bold text-white mb-2">Access Restricted</h2>
          <p className="text-slate-400 mb-6">{MODULE_NAME} requires elevated permissions.</p>
          <div className="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-700">
            <div className="flex items-center justify-between mb-3">
              <span className="text-slate-400 text-sm">Your Role</span>
              <span className="px-3 py-1 rounded-full bg-slate-700 text-slate-300 text-sm font-medium">{userRole || 'Unknown'}</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-slate-400 text-sm">Required Roles</span>
              <div className="flex gap-1 flex-wrap justify-end">
                {requiredRoles.slice(0,3).map(role => (
                  <span key={role} className="px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400 text-xs font-medium">{role}</span>
                ))}
                {requiredRoles.length > 3 && <span className="px-2 py-1 text-slate-500 text-xs">+{requiredRoles.length - 3} more</span>}
              </div>
            </div>
          </div>
          <a href="index.html" className="inline-flex items-center gap-2 px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Return to Dashboard
          </a>
        </div>
      </div>
    );

    const LoadingSkeleton = () => (
      <div className="min-h-screen bg-[#00050F] p-6">
        <div className="mb-6">
          <div className="h-8 skeleton rounded w-1/3 mb-2" />
          <div className="h-4 skeleton rounded w-1/2" />
        </div>
        <div className="grid grid-cols-12 gap-4">
          <div className="col-span-8 space-y-4">
            <div className="h-64 skeleton rounded-xl" />
            <div className="h-48 skeleton rounded-xl" />
          </div>
          <div className="col-span-4 space-y-4">
            <div className="h-32 skeleton rounded-xl" />
            <div className="h-32 skeleton rounded-xl" />
            <div className="h-32 skeleton rounded-xl" />
          </div>
        </div>
      </div>
    );

    // RBAC Hook
    const useRBAC = () => {
      const [authState, setAuthState] = React.useState({ checking: true, userRole: null, hasAccess: false });
      
      React.useEffect(() => {
        const checkAccess = async () => {
          try {
            if (window.MissionPulseCore?.checkAccess) {
              const result = await window.MissionPulseCore.checkAccess(ALLOWED_ROLES);
              setAuthState({ checking: false, userRole: result.role, hasAccess: result.hasAccess });
            } else {
              const userRole = localStorage.getItem('missionpulse_role') || 'VIEWER';
              const hasAccess = ALLOWED_ROLES.includes(userRole);
              setAuthState({ checking: false, userRole, hasAccess });
            }
          } catch (error) {
            console.error('RBAC check failed:', error);
            setAuthState({ checking: false, userRole: 'UNKNOWN', hasAccess: false });
          }
        };
        setTimeout(checkAccess, 300);
      }, []);
      
      return authState;
    };

    // Connection Hook  
    const useConnection = () => {
      const [status, setStatus] = React.useState('connecting');
      React.useEffect(() => {
        const timer = setTimeout(() => setStatus('connected'), 800);
        return () => clearTimeout(timer);
      }, []);
      return status;
    };
    // ============================================
    // END HARDENING LAYER
    // ============================================



    // ========== DESIGN TOKENS ==========
    const COLORS = {
      bg: '#00050F',
      surface: '#0F172A',
      panel: '#1E293B',
      border: '#334155',
      muted: '#64748B',
      text: '#F8FAFC',
      cyan: '#00E5FA',
      danger: '#EF4444',
      warning: '#F59E0B',
      success: '#10B981',
      info: '#3B82F6',
      purple: '#A855F7',
      pink: '#EC4899',
    };

    // ========== EXPANDED FAR/DFARS CLAUSE DATA (10+ clauses) ==========
    const SECTION_I_CLAUSES = [
      {
        clause: '52.227-14',
        title: 'Rights in Dataâ€”General',
        category: 'IP Rights',
        risk: 'HIGH',
        impact: 'IP Transfer',
        cashFlowImpact: -15,
        summary: 'Government receives unlimited rights to all data developed under contract.',
        plainLanguage: 'The government can use, modify, and distribute any work product you createâ€”without paying you extra or asking permission.',
        recommendation: 'Negotiate for Limited Rights or SBIR data rights. Request Alternate II for copyrighted works.',
        farRef: 'FAR 27.404-2',
        negotiationPoints: [
          'Request Limited Rights for pre-existing software/data',
          'Invoke Alternate II if creating copyrighted materials',
          'Document all pre-existing IP in proposal Attachment J',
          'Consider SBIR data protection if applicable'
        ],
        qaPairs: [
          { q: 'Can we protect proprietary methods?', a: 'Yes, by clearly marking them as "Limited Rights Data" in the license agreement.' },
          { q: 'What about commercial software?', a: 'Commercial software retains its commercial license; unlimited rights do not apply.' }
        ]
      },
      {
        clause: 'H.4.2',
        title: 'Payment Terms - Net 60',
        category: 'Cash Flow',
        risk: 'HIGH',
        impact: 'Cash Flow',
        cashFlowImpact: -25,
        summary: 'Payment due 60 days after invoice acceptance. Extended from standard Net-30.',
        plainLanguage: "You won't get paid until 2 months after invoicing. That's a month longer than usualâ€”plan your cash accordingly.",
        recommendation: 'Counter with Net-30 per FAR 32.906. Propose milestone-based payments for large deliverables.',
        farRef: 'FAR 32.905',
        isTrap: true,
        negotiationPoints: [
          'Cite FAR 32.906 requiring prompt payment within 30 days',
          'Request progress payments for tasks exceeding $100K',
          'Propose milestone-based billing tied to deliverables',
          'Negotiate for 2% discount if paid within 10 days'
        ],
        qaPairs: [
          { q: 'Is Net-60 negotiable?', a: 'Yes! FAR 32.906 mandates prompt payment. Counter with Net-30 citing regulatory compliance.' },
          { q: 'How does this affect our cash flow?', a: 'Net-60 requires an additional $150K-$200K working capital for a $1M task order.' }
        ]
      },
      {
        clause: '252.204-7012',
        title: 'Safeguarding CDI and Cyber Incident Reporting',
        category: 'Cybersecurity',
        risk: 'HIGH',
        impact: 'Compliance',
        cashFlowImpact: -12,
        summary: 'Requires NIST 800-171 compliance and 72-hour incident reporting.',
        plainLanguage: 'You must have cybersecurity controls in place and report any breaches to DoD within 3 days. Non-compliance can mean contract termination.',
        recommendation: 'Verify current SPRS score. Budget for ongoing CMMC compliance costs.',
        farRef: 'DFARS 204.73',
        negotiationPoints: [
          'Confirm current SPRS score meets minimum threshold (110+)',
          'Include CMMC compliance costs in indirect rates',
          'Ensure all subs have active System Security Plans',
          'Budget for annual penetration testing'
        ],
        qaPairs: [
          { q: 'What SPRS score do we need?', a: 'Minimum 110 for most contracts; verify specific requirements in Section L.' },
          { q: 'Do subs need to comply?', a: 'Yes, all subcontractors handling CUI must meet the same requirements.' }
        ]
      },
      {
        clause: 'H.7.1',
        title: 'Organizational Conflict of Interest',
        category: 'Conflicts',
        risk: 'MEDIUM',
        impact: 'BD Limitation',
        cashFlowImpact: -5,
        summary: 'Contractor may be excluded from future related procurements.',
        plainLanguage: 'Working on this contract might prevent you from bidding on follow-on work. Read the fine print carefully.',
        recommendation: 'Request OCI waiver consideration. Document mitigation plan in proposal.',
        farRef: 'FAR 9.505',
        negotiationPoints: [
          'Request written OCI determination before award',
          'Propose firewall/mitigation plan',
          'Negotiate time-limited exclusion (vs. permanent)',
          'Identify specific follow-on contracts affected'
        ],
        qaPairs: [
          { q: 'Can we bid on follow-on work?', a: 'Depends on OCI clause specifics. Request written determination from CO.' },
          { q: 'What is a mitigation plan?', a: 'Firewalls, separate teams, or limited scope participation to address conflict.' }
        ]
      },
      {
        clause: '52.222-50',
        title: 'Combating Trafficking in Persons',
        category: 'Labor',
        risk: 'LOW',
        impact: 'Compliance',
        cashFlowImpact: 0,
        summary: 'Prohibition on trafficking and forced labor practices.',
        plainLanguage: 'Standard clause requiring ethical labor practices. Flow down to all subcontractors.',
        recommendation: 'Standard complianceâ€”ensure partner/sub certifications are current.',
        farRef: 'FAR 22.17',
        negotiationPoints: [
          'No negotiation neededâ€”standard clause',
          'Ensure supply chain due diligence documentation',
          'Include in all subcontract flow-downs',
          'Annual certification requirement'
        ],
        qaPairs: [
          { q: 'Do we need special certifications?', a: 'Annual self-certification required; maintain records for audit.' }
        ]
      },
      {
        clause: '52.219-14',
        title: 'Limitations on Subcontracting',
        category: 'Set-Aside',
        risk: 'MEDIUM',
        impact: 'Workshare',
        cashFlowImpact: -3,
        summary: 'Small business must perform 50%+ of personnel costs.',
        plainLanguage: "You need to do at least half the work yourselfâ€”can't just pass it all to a large business teammate.",
        recommendation: 'Verify workshare allocation meets threshold. Document in cost volume.',
        farRef: 'FAR 19.508',
        negotiationPoints: [
          'Calculate precise workshare before teaming',
          'Document similarly situated entity work allocation',
          'Ensure LCAT mapping supports 50% threshold',
          'Consider joint venture if workshare is challenging'
        ],
        qaPairs: [
          { q: 'What counts toward the 50%?', a: 'Personnel labor costs performed by prime or similarly situated entities.' },
          { q: 'Can we use a large business sub?', a: 'Yes, up to 50% of personnel costs can flow to LB subcontractors.' }
        ]
      },
      {
        clause: '52.216-18',
        title: 'Ordering',
        category: 'Task Order',
        risk: 'INFO',
        impact: 'Administrative',
        cashFlowImpact: 0,
        summary: 'Standard IDIQ ordering procedures.',
        plainLanguage: 'Describes how the government will issue task orders under this contract.',
        recommendation: 'No action requiredâ€”standard procedure clause.',
        farRef: 'FAR 16.505',
        negotiationPoints: [
          'Standard clauseâ€”no negotiation needed',
          'Understand task order competition procedures',
          'Note minimum/maximum contract values',
          'Review ordering period vs. performance period'
        ],
        qaPairs: [
          { q: 'How are task orders issued?', a: 'Via fair opportunity competition among IDIQ holders unless exception applies.' }
        ]
      },
      {
        clause: 'H.12.3',
        title: 'Performance Incentive',
        category: 'Incentive',
        risk: 'INFO',
        impact: 'Margin Opportunity',
        cashFlowImpact: 5,
        summary: 'Award fee up to 5% based on CPARS ratings.',
        plainLanguage: 'You can earn bonus money if you perform well. Great ratings = extra profit.',
        recommendation: 'Highlight this in your proposalâ€”show track record of Exceptional CPARS.',
        farRef: 'FAR 16.4',
        negotiationPoints: [
          'Negotiate clear evaluation criteria',
          'Request interim evaluations (quarterly vs. annual)',
          'Define "Exceptional" performance metrics',
          'Link to specific deliverables/milestones'
        ],
        qaPairs: [
          { q: 'How do we maximize award fee?', a: 'Exceed SLA metrics, proactive communication, innovation demonstrations.' }
        ]
      },
      {
        clause: '52.232-40',
        title: 'Providing Accelerated Payments to Small Business',
        category: 'Cash Flow',
        risk: 'INFO',
        impact: 'Sub Flow',
        cashFlowImpact: 2,
        summary: 'Prime must pay small business subs within 15 days of receiving payment.',
        plainLanguage: 'Good news for subs! Once you get paid, you must pay your small business partners quickly.',
        recommendation: 'Build 15-day sub payment into cash flow model. Good selling point for teaming.',
        farRef: 'FAR 32.903',
        negotiationPoints: [
          'Use as recruiting tool for small business subs',
          'Build into subcontract payment terms',
          'Coordinate with accounting for rapid processing',
          'Document compliance for DCAA audits'
        ],
        qaPairs: [
          { q: 'What if we cannot pay in 15 days?', a: 'Non-compliance can be reported; ensure AP process supports rapid payment.' }
        ]
      },
      {
        clause: '252.239-7010',
        title: 'Cloud Computing Services',
        category: 'Technical',
        risk: 'MEDIUM',
        impact: 'Infrastructure',
        cashFlowImpact: -8,
        summary: 'Requires FedRAMP authorization and data residency requirements.',
        plainLanguage: 'Any cloud services must be FedRAMP authorized and data must stay in US data centers.',
        recommendation: 'Verify cloud providers meet FedRAMP High baseline. Budget for GovCloud pricing.',
        farRef: 'DFARS 239.7602',
        negotiationPoints: [
          'Confirm FedRAMP authorization level required (Moderate vs. High)',
          'Include GovCloud pricing differential in cost',
          'Document data residency compliance',
          'Plan for FedRAMP continuous monitoring costs'
        ],
        qaPairs: [
          { q: 'Can we use AWS commercial?', a: 'No, must use AWS GovCloud or other FedRAMP authorized environment.' },
          { q: 'What about Microsoft 365?', a: 'GCC High or DoD environments required for CUI handling.' }
        ]
      },
      {
        clause: 'H.9.2',
        title: 'Key Personnel Substitution',
        category: 'Staffing',
        risk: 'MEDIUM',
        impact: 'Retention',
        cashFlowImpact: -4,
        summary: 'Key personnel changes require 30-day advance notice and CO approval.',
        plainLanguage: 'Your star employees named in the proposal cannot leave without government permission. Plan retention bonuses.',
        recommendation: 'Build retention incentives into rates. Have backup candidates identified.',
        farRef: 'FAR 52.237-3',
        negotiationPoints: [
          'Negotiate 14-day notice vs. 30-day',
          'Pre-approve backup candidates in proposal',
          'Define what triggers "key" designation',
          'Include retention bonus in fringe rates'
        ],
        qaPairs: [
          { q: 'What if key person leaves suddenly?', a: 'Notify CO immediately, propose qualified replacement within 24-48 hours.' },
          { q: 'Can we remove key personnel designation?', a: 'Yes, via contract modification after proving team stability.' }
        ]
      },
      {
        clause: '52.217-9',
        title: 'Option to Extend the Term of the Contract',
        category: 'Options',
        risk: 'LOW',
        impact: 'Duration',
        cashFlowImpact: 3,
        summary: 'Government may extend contract by up to 6 months.',
        plainLanguage: 'The government can keep you working an extra 6 months at the same rates if they need more time.',
        recommendation: 'Ensure option period pricing is consistent. Good for revenue continuity.',
        farRef: 'FAR 17.208',
        negotiationPoints: [
          'Verify option period rates match base',
          'Understand 60-day notice requirement',
          'Budget for extended staff retention',
          'Review option exercise conditions'
        ],
        qaPairs: [
          { q: 'Are option years guaranteed?', a: 'No, options are at government discretion based on funding and performance.' }
        ]
      },
    ];

    // ========== COMPLIANCE CHECKLIST ITEMS ==========
    const COMPLIANCE_CHECKLIST = [
      { id: 'sprs', label: 'SPRS Score Verified (110+ required)', category: 'Cyber', critical: true },
      { id: 'fedramp', label: 'FedRAMP Cloud Authorization Confirmed', category: 'Cyber', critical: true },
      { id: 'workshare', label: '50% Workshare Calculation Documented', category: 'Set-Aside', critical: true },
      { id: 'oci', label: 'OCI Mitigation Plan Drafted', category: 'Conflicts', critical: false },
      { id: 'key-personnel', label: 'Key Personnel Retention Strategy', category: 'Staffing', critical: false },
      { id: 'cashflow', label: 'Working Capital Analysis Complete', category: 'Finance', critical: true },
      { id: 'ip-inventory', label: 'Pre-existing IP Inventory Created', category: 'IP Rights', critical: false },
      { id: 'sub-flowdown', label: 'Subcontract Flow-downs Reviewed', category: 'Compliance', critical: true },
      { id: 'payment-terms', label: 'Payment Terms Counter Prepared', category: 'Finance', critical: false },
      { id: 'ssp', label: 'System Security Plan Current', category: 'Cyber', critical: true },
    ];

    // ========== AI ADVISOR PRE-FILLED Q&A ==========
    const AI_ADVISOR_QUESTIONS = [
      { q: 'What are the biggest risks in this contract?', icon: 'alert' },
      { q: 'How can we counter Net-60 payment terms?', icon: 'dollar' },
      { q: 'What IP protections should we negotiate?', icon: 'lock' },
      { q: 'Do our cybersecurity controls comply?', icon: 'shield' },
      { q: 'Calculate working capital needed', icon: 'calculator' },
      { q: 'Generate negotiation memo for CO', icon: 'document' },
    ];

    // ========== ICONS ==========
    const Icons = {
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      alert: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      document: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      scale: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>,
      cpu: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>,
      loader: () => <svg className="w-full h-full animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      download: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      zap: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
      dollar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      info: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      lock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>,
      external: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
      chat: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
      send: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
      calculator: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
      clipboard: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
      megaphone: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" /></svg>,
      trendingDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>,
      arrowLeft: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
    };

    const Icon = ({ name, className = "w-5 h-5" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // ========== UI COMPONENTS ==========
    const Card = ({ children, className = '', glow = false, pulse = false, trap = false }) => (
      <div className={`bg-slate-800/50 backdrop-blur-sm border rounded-2xl transition-all duration-300 
        ${glow ? 'shadow-lg shadow-cyan-500/20 border-cyan-500/30' : 'border-slate-700/50'} 
        ${pulse ? 'animate-riskPulse' : ''} 
        ${trap ? 'animate-trapAlert border-red-500/50 shadow-lg shadow-red-500/20' : ''} 
        ${className}`}>
        {children}
      </div>
    );

    const Badge = ({ children, variant = 'default', size = 'sm', icon }) => {
      const variants = {
        default: 'bg-slate-700 text-slate-300',
        success: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30',
        warning: 'bg-amber-500/20 text-amber-400 border border-amber-500/30',
        danger: 'bg-red-500/20 text-red-400 border border-red-500/30',
        info: 'bg-blue-500/20 text-blue-400 border border-blue-500/30',
        cyan: 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30',
        purple: 'bg-purple-500/20 text-purple-400 border border-purple-500/30',
      };
      const sizes = {
        xs: 'px-1.5 py-0.5 text-[10px]',
        sm: 'px-2 py-1 text-xs',
        md: 'px-3 py-1.5 text-sm',
      };
      return (
        <span className={`inline-flex items-center gap-1.5 font-medium rounded-lg ${variants[variant]} ${sizes[size]}`}>
          {icon && <Icon name={icon} className="w-3 h-3" />}
          {children}
        </span>
      );
    };

    const Button = ({ children, variant = 'primary', size = 'md', icon, disabled = false, loading = false, className = '', ...props }) => {
      const variants = {
        primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white hover:from-cyan-400 hover:to-teal-400 shadow-lg shadow-cyan-500/25',
        secondary: 'bg-slate-700 text-white hover:bg-slate-600 border border-slate-600',
        danger: 'bg-gradient-to-r from-red-500 to-rose-500 text-white hover:from-red-400 hover:to-rose-400',
        warning: 'bg-gradient-to-r from-amber-500 to-orange-500 text-white hover:from-amber-400 hover:to-orange-400',
        ghost: 'bg-transparent text-slate-400 hover:text-white hover:bg-slate-700/50',
        success: 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-400 hover:to-teal-400',
      };
      const sizes = {
        sm: 'px-3 py-1.5 text-sm',
        md: 'px-4 py-2 text-sm',
        lg: 'px-6 py-3 text-base',
      };
      return (
        <button
          className={`inline-flex items-center justify-center gap-2 font-semibold rounded-xl transition-all duration-200 ${variants[variant]} ${sizes[size]} ${disabled || loading ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
          disabled={disabled || loading}
          {...props}
        >
          {loading ? <Icon name="loader" className="w-4 h-4" /> : icon && <Icon name={icon} className="w-4 h-4" />}
          {children}
        </button>
      );
    };

    // ========== RISK BADGE ==========
    const RiskBadge = ({ risk }) => {
      const config = {
        HIGH: { variant: 'danger', text: 'HIGH RISK' },
        MEDIUM: { variant: 'warning', text: 'MEDIUM' },
        LOW: { variant: 'success', text: 'LOW' },
        INFO: { variant: 'info', text: 'INFO' },
      };
      const { variant, text } = config[risk] || config.INFO;
      return <Badge variant={variant} size="xs">{text}</Badge>;
    };

    // ========== TRAP DETECTED BANNER ==========
    const TrapDetectedBanner = ({ clause, onDismiss }) => (
      <Card trap className="p-4 mb-6 animate-slideIn">
        <div className="flex items-start gap-4">
          <div className="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center flex-shrink-0">
            <Icon name="alert" className="w-6 h-6 text-red-400" />
          </div>
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-lg font-bold text-red-400">âš ï¸ CONTRACT TRAP DETECTED</span>
              <Badge variant="danger" size="xs">REQUIRES ACTION</Badge>
            </div>
            <h4 className="font-semibold text-white mb-1">{clause.clause}: {clause.title}</h4>
            <p className="text-sm text-slate-300 mb-3">{clause.plainLanguage}</p>
            <div className="flex items-center gap-3">
              <Button variant="danger" size="sm" icon="scale">Counter Proposal Template</Button>
              <Button variant="ghost" size="sm" icon="chat">Ask AI Advisor</Button>
              <button onClick={onDismiss} className="ml-auto text-slate-500 hover:text-slate-300 text-sm">Dismiss</button>
            </div>
          </div>
        </div>
      </Card>
    );

    // ========== CASH FLOW IMPACT CALCULATOR ==========
    const CashFlowCalculator = ({ clauses, contractValue }) => {
      const [value, setValue] = useState(contractValue || 1000000);
      const impacts = clauses.filter(c => c.cashFlowImpact !== 0);
      const totalNegative = impacts.filter(c => c.cashFlowImpact < 0).reduce((sum, c) => sum + c.cashFlowImpact, 0);
      const totalPositive = impacts.filter(c => c.cashFlowImpact > 0).reduce((sum, c) => sum + c.cashFlowImpact, 0);
      const netImpact = totalNegative + totalPositive;
      
      const net60Impact = value * 0.25; // ~25% working capital for Net-60
      const cyberCost = value * 0.08; // ~8% for cyber compliance
      const netDollarImpact = value * (Math.abs(netImpact) / 100);

      const maxImpact = Math.max(...impacts.map(c => Math.abs(c.cashFlowImpact)));

      return (
        <Card className="p-4">
          <div className="flex items-center gap-2 mb-4">
            <Icon name="calculator" className="w-5 h-5 text-cyan-400" />
            <h3 className="font-semibold text-white">Cash Flow Impact Calculator</h3>
          </div>
          
          {/* Contract Value Input */}
          <div className="mb-4">
            <label className="text-xs text-slate-500 mb-1 block">Task Order Value ($)</label>
            <input
              type="number"
              value={value}
              onChange={(e) => setValue(Number(e.target.value))}
              className="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-lg font-mono focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none"
            />
          </div>

          {/* Visual Bars */}
          <div className="space-y-3 mb-4">
            {impacts.slice(0, 5).map((clause, i) => (
              <div key={clause.clause} className="animate-fadeIn" style={{ animationDelay: `${i * 100}ms` }}>
                <div className="flex justify-between text-xs mb-1">
                  <span className="text-slate-400 font-mono">{clause.clause}</span>
                  <span className={clause.cashFlowImpact < 0 ? 'text-red-400' : 'text-emerald-400'}>
                    {clause.cashFlowImpact > 0 ? '+' : ''}{clause.cashFlowImpact}% (${Math.abs(value * clause.cashFlowImpact / 100).toLocaleString()})
                  </span>
                </div>
                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                  <div
                    className={`h-full rounded-full cash-bar ${clause.cashFlowImpact < 0 ? 'bg-gradient-to-r from-red-500 to-rose-400' : 'bg-gradient-to-r from-emerald-500 to-teal-400'}`}
                    style={{ width: `${(Math.abs(clause.cashFlowImpact) / maxImpact) * 100}%` }}
                  />
                </div>
              </div>
            ))}
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-3 gap-2 mb-4">
            <div className="p-2 rounded-lg bg-red-500/10 border border-red-500/20 text-center">
              <div className="text-sm font-bold text-red-400">${net60Impact.toLocaleString()}</div>
              <div className="text-[10px] text-slate-500">Net-60 Capital</div>
            </div>
            <div className="p-2 rounded-lg bg-amber-500/10 border border-amber-500/20 text-center">
              <div className="text-sm font-bold text-amber-400">${cyberCost.toLocaleString()}</div>
              <div className="text-[10px] text-slate-500">Cyber Compliance</div>
            </div>
            <div className="p-2 rounded-lg bg-cyan-500/10 border border-cyan-500/20 text-center">
              <div className="text-sm font-bold text-cyan-400">${netDollarImpact.toLocaleString()}</div>
              <div className="text-[10px] text-slate-500">Net Impact</div>
            </div>
          </div>

          {/* Totals */}
          <div className="flex justify-between pt-3 border-t border-slate-700">
            <div className="text-center">
              <div className="text-xl font-bold text-red-400">{totalNegative}%</div>
              <div className="text-xs text-slate-500">Risk Exposure</div>
            </div>
            <div className="text-center">
              <div className="text-xl font-bold text-emerald-400">+{totalPositive}%</div>
              <div className="text-xs text-slate-500">Upside</div>
            </div>
            <div className="text-center">
              <div className={`text-xl font-bold ${netImpact < 0 ? 'text-amber-400' : 'text-cyan-400'}`}>{netImpact}%</div>
              <div className="text-xs text-slate-500">Net Impact</div>
            </div>
          </div>
        </Card>
      );
    };

    // ========== COMPLIANCE CHECKLIST COMPONENT ==========
    const ComplianceChecklist = ({ items, checkedItems, onToggle }) => {
      const progress = (checkedItems.length / items.length) * 100;
      
      return (
        <Card className="p-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <Icon name="clipboard" className="w-5 h-5 text-emerald-400" />
              <h3 className="font-semibold text-white">Compliance Checklist</h3>
            </div>
            <Badge variant={progress === 100 ? 'success' : progress > 50 ? 'warning' : 'danger'} size="sm">
              {checkedItems.length}/{items.length}
            </Badge>
          </div>

          {/* Progress Bar */}
          <div className="h-2 bg-slate-700 rounded-full mb-4 overflow-hidden">
            <div 
              className="h-full bg-gradient-to-r from-emerald-500 to-teal-400 rounded-full transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>

          {/* Checklist Items */}
          <div className="space-y-2 max-h-64 overflow-auto pr-2">
            {items.map((item) => (
              <div 
                key={item.id}
                onClick={() => onToggle(item.id)}
                className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-all ${
                  checkedItems.includes(item.id) 
                    ? 'bg-emerald-500/10 border border-emerald-500/30' 
                    : 'bg-slate-900/50 border border-slate-700/50 hover:bg-slate-800/50'
                }`}
              >
                <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${
                  checkedItems.includes(item.id)
                    ? 'bg-emerald-500 border-emerald-500'
                    : 'border-slate-600'
                }`}>
                  {checkedItems.includes(item.id) && <Icon name="check" className="w-3 h-3 text-white" />}
                </div>
                <div className="flex-1">
                  <span className={`text-sm ${checkedItems.includes(item.id) ? 'text-emerald-300 line-through' : 'text-slate-300'}`}>
                    {item.label}
                  </span>
                </div>
                {item.critical && !checkedItems.includes(item.id) && (
                  <Badge variant="danger" size="xs">Critical</Badge>
                )}
              </div>
            ))}
          </div>
        </Card>
      );
    };

    // ========== AI ADVISOR CHAT PANEL ==========
    const AIAdvisorPanel = ({ clauses, isOpen, onClose }) => {
      const [messages, setMessages] = useState([
        { 
          role: 'ai', 
          content: "I've analyzed the contract terms. I found **2 high-risk clauses** that need your attention:\n\n1. **Net-60 Payment Terms** - This will require additional working capital\n2. **Unlimited IP Rights** - Consider negotiating Limited Rights\n\nWhat would you like to know more about?"
        }
      ]);
      const [input, setInput] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const handleQuickQuestion = (question) => {
        setInput(question);
        handleSend(question);
      };

      const handleSend = (messageText = input) => {
        if (!messageText.trim()) return;
        
        setMessages(prev => [...prev, { role: 'user', content: messageText }]);
        setInput('');
        setIsTyping(true);

        // Simulate AI response
        setTimeout(() => {
          let response = '';
          
          if (messageText.toLowerCase().includes('net-60') || messageText.toLowerCase().includes('payment')) {
            response = `**Net-60 Payment Terms Counter Strategy:**\n\n1. **Cite FAR 32.906** - Requires prompt payment within 30 days\n2. **Propose milestone billing** - Tie payments to deliverable acceptance\n3. **Request 2% early payment discount** - Common industry practice\n\n**Working Capital Impact:** For a $1M task order, Net-60 requires ~$250K additional working capital vs Net-30.\n\n*Recommendation:* Draft a formal counter-proposal citing regulatory compliance.`;
          } else if (messageText.toLowerCase().includes('ip') || messageText.toLowerCase().includes('rights')) {
            response = `**IP Protection Negotiation Strategy:**\n\n1. **Request Limited Rights** for pre-existing software/methodologies\n2. **Invoke Alternate II** for copyrighted materials\n3. **Document all pre-existing IP** in Attachment J inventory\n4. **Consider SBIR data rights** if applicable\n\n*Key Point:* Unlimited rights only apply to data developed *under* the contractâ€”not your existing IP.`;
          } else if (messageText.toLowerCase().includes('cyber') || messageText.toLowerCase().includes('compliance')) {
            response = `**DFARS 252.204-7012 Compliance Checklist:**\n\nâœ… SPRS Score: Minimum 110 required\nâœ… System Security Plan: Must be current\nâœ… CMMC Level: Verify required level (typically L2)\nâœ… Incident Response: 72-hour reporting capability\n\n**Cost Impact:** Budget 8-12% of contract value for ongoing compliance.\n\n*Action:* Verify your SPRS score at https://www.sprs.csd.disa.mil`;
          } else if (messageText.toLowerCase().includes('working capital') || messageText.toLowerCase().includes('calculate')) {
            const trapClause = clauses.find(c => c.isTrap);
            response = `**Working Capital Analysis (for $1M Task Order):**\n\n| Term | Capital Required | Delta |\n|------|-----------------|-------|\n| Net-30 | $83K | Baseline |\n| Net-45 | $125K | +$42K |\n| Net-60 | $167K | +$84K |\n\n**Recommendation:** With ${trapClause ? 'Net-60 detected' : 'standard terms'}, secure a line of credit or factor receivables to bridge the cash gap.`;
          } else if (messageText.toLowerCase().includes('memo') || messageText.toLowerCase().includes('negotiation')) {
            response = `**Generated Negotiation Memo:**\n\n---\n**TO:** Contracting Officer\n**RE:** Request for Modification - Payment Terms\n\nPursuant to FAR 32.906, we respectfully request modification of Section H.4.2 payment terms from Net-60 to Net-30.\n\n**Rationale:**\n1. FAR mandates prompt payment to maintain contractor viability\n2. Extended terms create disproportionate burden on small businesses\n3. Industry standard is Net-30 or earlier\n\n**Proposed Resolution:** Net-30 payment, or milestone-based billing tied to deliverable acceptance.\n\n---\n\n*Shall I export this to a Word document?*`;
          } else {
            response = `Based on my analysis of the ${clauses.length} contract clauses:\n\n**High-Risk Items:**\n- ${clauses.filter(c => c.risk === 'HIGH').map(c => c.title).join('\n- ')}\n\n**Key Recommendations:**\n1. Counter Net-60 payment terms with FAR citation\n2. Protect pre-existing IP through Limited Rights\n3. Verify SPRS score meets requirements\n\nWould you like me to elaborate on any specific clause?`;
          }
          
          setMessages(prev => [...prev, { role: 'ai', content: response }]);
          setIsTyping(false);
        }, 1500);
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-y-0 right-0 w-full max-w-md z-50 animate-slideInRight">
          <div className="h-full flex flex-col bg-slate-900 border-l border-slate-700 shadow-2xl">
            {/* Header */}
            <div className="flex items-center justify-between p-4 border-b border-slate-700">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center animate-glow">
                  <Icon name="cpu" className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="font-bold text-white">Contracts AI Advisor</h3>
                  <p className="text-xs text-slate-400">FAR/DFARS Analysis Engine</p>
                </div>
              </div>
              <button onClick={onClose} className="p-2 rounded-lg hover:bg-slate-700 text-slate-400">
                <Icon name="x" className="w-5 h-5" />
              </button>
            </div>

            {/* Quick Questions */}
            <div className="p-3 border-b border-slate-800 overflow-x-auto">
              <div className="flex gap-2">
                {AI_ADVISOR_QUESTIONS.map((item, i) => (
                  <button
                    key={i}
                    onClick={() => handleQuickQuestion(item.q)}
                    className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300 whitespace-nowrap transition-colors"
                  >
                    <Icon name={item.icon} className="w-3 h-3 text-cyan-400" />
                    {item.q.length > 25 ? item.q.substring(0, 25) + '...' : item.q}
                  </button>
                ))}
              </div>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-auto p-4 space-y-4">
              {messages.map((msg, i) => (
                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-3 ${
                    msg.role === 'user' 
                      ? 'chat-bubble-user bg-cyan-500/20 border border-cyan-500/30' 
                      : 'chat-bubble-ai bg-slate-800 border border-slate-700'
                  }`}>
                    <div className="text-sm text-slate-200 whitespace-pre-wrap">
                      {msg.content.split('\n').map((line, j) => {
                        // Simple markdown-like formatting
                        if (line.startsWith('**') && line.endsWith('**')) {
                          return <p key={j} className="font-bold text-white my-1">{line.replace(/\*\*/g, '')}</p>;
                        }
                        if (line.startsWith('- ')) {
                          return <p key={j} className="ml-2 my-0.5">â€¢ {line.substring(2)}</p>;
                        }
                        if (line.startsWith('âœ…')) {
                          return <p key={j} className="text-emerald-400 my-0.5">{line}</p>;
                        }
                        if (line.includes('**')) {
                          const parts = line.split(/(\*\*[^*]+\*\*)/g);
                          return (
                            <p key={j} className="my-0.5">
                              {parts.map((part, k) => 
                                part.startsWith('**') && part.endsWith('**') 
                                  ? <strong key={k} className="text-white">{part.replace(/\*\*/g, '')}</strong>
                                  : part
                              )}
                            </p>
                          );
                        }
                        return <p key={j} className="my-0.5">{line}</p>;
                      })}
                    </div>
                  </div>
                </div>
              ))}
              {isTyping && (
                <div className="flex justify-start">
                  <div className="chat-bubble-ai bg-slate-800 border border-slate-700 p-3">
                    <div className="flex gap-1">
                      <span className="w-2 h-2 bg-cyan-400 rounded-full animate-typing" style={{ animationDelay: '0ms' }}></span>
                      <span className="w-2 h-2 bg-cyan-400 rounded-full animate-typing" style={{ animationDelay: '300ms' }}></span>
                      <span className="w-2 h-2 bg-cyan-400 rounded-full animate-typing" style={{ animationDelay: '600ms' }}></span>
                    </div>
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Input */}
            <div className="p-4 border-t border-slate-700">
              <div className="flex gap-2">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                  placeholder="Ask about contract risks..."
                  className="flex-1 px-4 py-2 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none"
                />
                <Button variant="primary" icon="send" onClick={() => handleSend()} disabled={!input.trim()} />
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ========== NEGOTIATION TALKING POINTS GENERATOR ==========
    const NegotiationPointsPanel = ({ clause, onClose }) => {
      const [generating, setGenerating] = useState(true);
      const [points, setPoints] = useState([]);

      useEffect(() => {
        // Simulate generation
        setTimeout(() => {
          setPoints(clause.negotiationPoints || []);
          setGenerating(false);
        }, 1500);
      }, [clause]);

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn" onClick={onClose}>
          <Card className="w-full max-w-lg p-6 animate-slideIn" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                <Icon name="megaphone" className="w-6 h-6 text-white" />
              </div>
              <div>
                <h3 className="font-bold text-white">Negotiation Talking Points</h3>
                <p className="text-sm text-slate-400">{clause.clause}: {clause.title}</p>
              </div>
            </div>

            {generating ? (
              <div className="py-8 text-center">
                <Icon name="loader" className="w-8 h-8 text-cyan-400 mx-auto mb-3" />
                <p className="text-slate-400">Generating talking points...</p>
              </div>
            ) : (
              <>
                <div className="space-y-3 mb-6">
                  {points.map((point, i) => (
                    <div key={i} className="flex items-start gap-3 p-3 rounded-lg bg-slate-900/50 animate-slideIn" style={{ animationDelay: `${i * 100}ms` }}>
                      <div className="w-6 h-6 rounded-full bg-amber-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span className="text-xs font-bold text-amber-400">{i + 1}</span>
                      </div>
                      <p className="text-sm text-slate-300">{point}</p>
                    </div>
                  ))}
                </div>

                {/* Q&A Section */}
                {clause.qaPairs && clause.qaPairs.length > 0 && (
                  <div className="border-t border-slate-700 pt-4 mb-4">
                    <h4 className="text-sm font-semibold text-cyan-400 mb-3">Common Q&A Responses</h4>
                    {clause.qaPairs.map((pair, i) => (
                      <div key={i} className="mb-3 p-3 rounded-lg bg-cyan-500/5 border border-cyan-500/20">
                        <p className="text-sm font-medium text-white mb-1">Q: {pair.q}</p>
                        <p className="text-sm text-slate-400">A: {pair.a}</p>
                      </div>
                    ))}
                  </div>
                )}

                <div className="flex gap-3">
                  <Button variant="ghost" onClick={onClose} className="flex-1">Close</Button>
                  <Button variant="warning" icon="download" className="flex-1">Export to Word</Button>
                </div>
              </>
            )}
          </Card>
        </div>
      );
    };

    // ========== CLAUSE DETAIL PANEL ==========
    const ClauseDetailPanel = ({ clause, onClose, onGeneratePoints }) => {
      if (!clause) return null;

      const riskColors = {
        HIGH: COLORS.danger,
        MEDIUM: COLORS.warning,
        LOW: COLORS.success,
        INFO: COLORS.info,
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn" onClick={onClose}>
          <Card className="w-full max-w-2xl max-h-[90vh] overflow-auto p-6 animate-slideIn" onClick={e => e.stopPropagation()}>
            <div className="flex items-start justify-between mb-4">
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <span className="font-mono text-lg text-cyan-400">{clause.clause}</span>
                  <RiskBadge risk={clause.risk} />
                  {clause.isTrap && <Badge variant="danger" size="xs" icon="alert">TRAP</Badge>}
                </div>
                <h2 className="text-xl font-bold text-white">{clause.title}</h2>
              </div>
              <button onClick={onClose} className="p-2 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white">
                <Icon name="x" className="w-5 h-5" />
              </button>
            </div>

            <div className="space-y-4">
              {/* Summary */}
              <div className="p-4 rounded-xl bg-slate-900/50 border-l-4" style={{ borderColor: riskColors[clause.risk] }}>
                <h4 className="text-xs font-semibold text-slate-500 uppercase mb-2">Official Summary</h4>
                <p className="text-slate-300">{clause.summary}</p>
              </div>

              {/* Plain Language */}
              <div className="p-4 rounded-xl bg-cyan-500/5 border border-cyan-500/20">
                <div className="flex items-center gap-2 mb-2">
                  <Icon name="cpu" className="w-4 h-4 text-cyan-400" />
                  <h4 className="text-xs font-semibold text-cyan-400 uppercase">Plain Language (AI Analysis)</h4>
                </div>
                <p className="text-white">{clause.plainLanguage}</p>
              </div>

              {/* Recommendation */}
              <div className="p-4 rounded-xl bg-emerald-500/5 border border-emerald-500/20">
                <div className="flex items-center gap-2 mb-2">
                  <Icon name="scale" className="w-4 h-4 text-emerald-400" />
                  <h4 className="text-xs font-semibold text-emerald-400 uppercase">Negotiation Strategy</h4>
                </div>
                <p className="text-white">{clause.recommendation}</p>
              </div>

              {/* Meta */}
              <div className="flex flex-wrap gap-3 pt-2">
                <Badge variant="cyan" size="sm" icon="document">{clause.farRef}</Badge>
                <Badge variant={clause.cashFlowImpact < 0 ? 'danger' : clause.cashFlowImpact > 0 ? 'success' : 'default'} size="sm" icon="dollar">
                  {clause.cashFlowImpact > 0 ? '+' : ''}{clause.cashFlowImpact}% Cash Flow
                </Badge>
                <Badge variant="purple" size="sm">{clause.category}</Badge>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3 pt-2">
                <Button variant="warning" size="md" icon="megaphone" className="flex-1" onClick={() => onGeneratePoints(clause)}>
                  Generate Talking Points
                </Button>
                <Button variant="secondary" size="md" icon="chat" className="flex-1">
                  Ask AI Advisor
                </Button>
              </div>
            </div>
          </Card>
        </div>
      );
    };

    // ========== AI AGENT STATUS ==========
    const AIAgentStatus = ({ status, clausesAnalyzed }) => (
      <div className="flex items-center gap-4 p-4 rounded-xl bg-slate-900/50 border border-cyan-500/20">
        <div className="relative">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center">
            <Icon name="cpu" className="w-6 h-6 text-white" />
          </div>
          {status === 'analyzing' && (
            <span className="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-cyan-400 animate-ping" />
          )}
        </div>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <span className="font-semibold text-white">Contracts Advisor Agent</span>
            <Badge variant={status === 'complete' ? 'success' : status === 'analyzing' ? 'cyan' : 'default'} size="xs">
              {status === 'complete' ? 'Analysis Complete' : status === 'analyzing' ? 'Analyzing...' : 'Ready'}
            </Badge>
          </div>
          <p className="text-sm text-slate-400">
            {status === 'complete' 
              ? `${clausesAnalyzed} clauses analyzed â€¢ ${SECTION_I_CLAUSES.filter(c => c.risk === 'HIGH').length} high-risk flagged`
              : status === 'analyzing'
              ? 'Scanning Section I for FAR/DFARS clauses...'
              : 'Ready to analyze RFP contract terms'
            }
          </p>
        </div>
      </div>
    );

    // ========== MAIN CONTRACTS SCANNER COMPONENT ==========
    const ContractsScanner = () => {
      const [status, setStatus] = useState('idle');
      const [selectedClause, setSelectedClause] = useState(null);
      const [visibleClauses, setVisibleClauses] = useState([]);
      const [filter, setFilter] = useState('all');
      const [showMemo, setShowMemo] = useState(false);
      const [showAdvisor, setShowAdvisor] = useState(false);
      const [showTrapBanner, setShowTrapBanner] = useState(false);
      const [checkedItems, setCheckedItems] = useState([]);
      const [showNegotiationPoints, setShowNegotiationPoints] = useState(null);

      const runAnalysis = () => {
        setStatus('scanning');
        setVisibleClauses([]);
        setShowTrapBanner(false);
        
        setTimeout(() => {
          setStatus('analyzing');
          
          SECTION_I_CLAUSES.forEach((_, index) => {
            setTimeout(() => {
              setVisibleClauses(prev => [...prev, SECTION_I_CLAUSES[index]]);
              
              // Show trap banner when Net-60 is detected
              if (SECTION_I_CLAUSES[index].isTrap) {
                setTimeout(() => setShowTrapBanner(true), 500);
              }
              
              if (index === SECTION_I_CLAUSES.length - 1) {
                setTimeout(() => setStatus('complete'), 500);
              }
            }, index * 200);
          });
        }, 1500);
      };

      const filteredClauses = visibleClauses.filter(c => 
        filter === 'all' || c.risk === filter
      );

      const riskCounts = {
        HIGH: visibleClauses.filter(c => c.risk === 'HIGH').length,
        MEDIUM: visibleClauses.filter(c => c.risk === 'MEDIUM').length,
        LOW: visibleClauses.filter(c => c.risk === 'LOW').length,
        INFO: visibleClauses.filter(c => c.risk === 'INFO').length,
      };

      const toggleChecklist = (id) => {
        setCheckedItems(prev => 
          prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        );
      };

      const trapClause = SECTION_I_CLAUSES.find(c => c.isTrap);

      return (
        <div className="min-h-screen p-6" style={{ backgroundColor: COLORS.bg }}>
          {/* Header */}
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <div className="flex items-center gap-3 mb-2">
                  <div className="px-3 py-1 rounded-lg bg-pink-500/20 text-pink-400 text-sm font-mono font-bold">M5</div>
                  <h1 className="text-3xl font-bold text-white">CONTRACTS SCANNER</h1>
                  <Badge variant="cyan" size="sm">ENHANCED</Badge>
                </div>
                <p className="text-slate-400">FAR/DFARS Risk Analysis â€¢ {SECTION_I_CLAUSES.length} Clauses â€¢ AI-Powered Negotiation</p>
              </div>
              <div className="flex items-center gap-3">
                {status === 'complete' && (
                  <>
                    <Button variant="secondary" icon="chat" onClick={() => setShowAdvisor(true)}>
                      AI Advisor
                    </Button>
                    <Button variant="secondary" icon="download" onClick={() => setShowMemo(true)}>
                      Risk Memo
                    </Button>
                  </>
                )}
                {status === 'idle' && (
                  <Button variant="primary" icon="zap" size="lg" onClick={runAnalysis}>
                    Analyze Contract Risks
                  </Button>
                )}
              </div>
            </div>

            {/* Trap Banner */}
            {showTrapBanner && trapClause && (
              <TrapDetectedBanner clause={trapClause} onDismiss={() => setShowTrapBanner(false)} />
            )}

            {/* AI Agent Status */}
            <AIAgentStatus status={status === 'idle' ? 'ready' : status === 'complete' ? 'complete' : 'analyzing'} clausesAnalyzed={visibleClauses.length} />

            {/* Scanning Animation */}
            {status === 'scanning' && (
              <Card className="mt-6 p-8 text-center scan-container overflow-hidden">
                <div className="scan-line animate-scanLine" />
                <Icon name="loader" className="w-12 h-12 text-cyan-400 mx-auto mb-4" />
                <h3 className="text-xl font-bold text-white mb-2">Scanning Section I</h3>
                <p className="text-slate-400">Parsing {SECTION_I_CLAUSES.length} FAR/DFARS clauses and identifying risk factors...</p>
              </Card>
            )}

            {/* Main Content Grid */}
            {visibleClauses.length > 0 && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6 animate-fadeIn">
                {/* Left Column - Clause List */}
                <div className="lg:col-span-2 space-y-4">
                  {/* Risk Filter Tabs */}
                  <div className="flex items-center gap-2 p-1 bg-slate-800/50 rounded-xl">
                    {['all', 'HIGH', 'MEDIUM', 'LOW', 'INFO'].map(f => (
                      <button
                        key={f}
                        onClick={() => setFilter(f)}
                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                          filter === f 
                            ? 'bg-slate-700 text-white' 
                            : 'text-slate-400 hover:text-white'
                        }`}
                      >
                        {f === 'all' ? 'All Clauses' : f}
                        {f !== 'all' && riskCounts[f] > 0 && (
                          <span className={`ml-2 px-1.5 py-0.5 rounded text-[10px] ${
                            f === 'HIGH' ? 'bg-red-500/20 text-red-400' :
                            f === 'MEDIUM' ? 'bg-amber-500/20 text-amber-400' :
                            f === 'LOW' ? 'bg-emerald-500/20 text-emerald-400' :
                            'bg-blue-500/20 text-blue-400'
                          }`}>
                            {riskCounts[f]}
                          </span>
                        )}
                      </button>
                    ))}
                  </div>

                  {/* Clause Cards */}
                  <Card className="p-4">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        <Icon name="document" className="w-5 h-5 text-pink-400" />
                        <h3 className="font-semibold text-white">Section I - Contract Clauses</h3>
                        <span className="text-xs text-slate-500">{visibleClauses.length} analyzed</span>
                      </div>
                      <Button variant="ghost" size="sm" icon="megaphone" onClick={() => setShowNegotiationPoints(filteredClauses[0])}>
                        Generate All Points
                      </Button>
                    </div>

                    <div className="space-y-3 max-h-[500px] overflow-auto pr-2">
                      {filteredClauses.map((clause, i) => (
                        <div
                          key={clause.clause}
                          onClick={() => setSelectedClause(clause)}
                          className={`p-4 rounded-xl bg-slate-900/50 border-l-4 cursor-pointer hover:bg-slate-800/50 transition-all animate-slideIn risk-${clause.risk.toLowerCase()} ${clause.isTrap ? 'ring-1 ring-red-500/30' : ''}`}
                          style={{ animationDelay: `${i * 50}ms` }}
                        >
                          <div className="flex items-start justify-between mb-2">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <span className="font-mono text-sm text-cyan-400">{clause.clause}</span>
                                <RiskBadge risk={clause.risk} />
                                <Badge variant="default" size="xs">{clause.category}</Badge>
                                {clause.isTrap && <Badge variant="danger" size="xs" icon="alert">TRAP</Badge>}
                              </div>
                              <h4 className="font-medium text-white">{clause.title}</h4>
                            </div>
                            <Icon name="chevronRight" className="w-5 h-5 text-slate-500" />
                          </div>
                          <p className="text-sm text-slate-400 line-clamp-2">{clause.summary}</p>
                          <div className="flex items-center gap-3 mt-2">
                            <div className="flex items-center gap-1">
                              <Icon name="dollar" className="w-3 h-3 text-amber-400" />
                              <span className={`text-xs ${clause.cashFlowImpact < 0 ? 'text-red-400' : clause.cashFlowImpact > 0 ? 'text-emerald-400' : 'text-slate-500'}`}>
                                {clause.cashFlowImpact > 0 ? '+' : ''}{clause.cashFlowImpact}%
                              </span>
                            </div>
                            <span className="text-xs text-slate-500">â€¢</span>
                            <span className="text-xs text-slate-500">{clause.farRef}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                </div>

                {/* Right Column - Stats & Tools */}
                <div className="space-y-4">
                  {/* Risk Summary */}
                  <Card className="p-4">
                    <h3 className="font-semibold text-white mb-4">Risk Summary</h3>
                    <div className="grid grid-cols-2 gap-3">
                      <div className="p-3 rounded-xl bg-red-500/10 border border-red-500/20 text-center">
                        <div className="text-3xl font-bold text-red-400 animate-countUp">{riskCounts.HIGH}</div>
                        <div className="text-xs text-slate-400">High Risk</div>
                      </div>
                      <div className="p-3 rounded-xl bg-amber-500/10 border border-amber-500/20 text-center">
                        <div className="text-3xl font-bold text-amber-400 animate-countUp">{riskCounts.MEDIUM}</div>
                        <div className="text-xs text-slate-400">Medium</div>
                      </div>
                      <div className="p-3 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-center">
                        <div className="text-3xl font-bold text-emerald-400 animate-countUp">{riskCounts.LOW}</div>
                        <div className="text-xs text-slate-400">Low Risk</div>
                      </div>
                      <div className="p-3 rounded-xl bg-blue-500/10 border border-blue-500/20 text-center">
                        <div className="text-3xl font-bold text-blue-400 animate-countUp">{riskCounts.INFO}</div>
                        <div className="text-xs text-slate-400">Info Only</div>
                      </div>
                    </div>
                  </Card>

                  {/* Cash Flow Calculator */}
                  <CashFlowCalculator clauses={visibleClauses} contractValue={1000000} />

                  {/* Compliance Checklist */}
                  <ComplianceChecklist 
                    items={COMPLIANCE_CHECKLIST}
                    checkedItems={checkedItems}
                    onToggle={toggleChecklist}
                  />

                  {/* Quick Action */}
                  <Card className="p-4 border-cyan-500/30" glow>
                    <div className="flex items-center gap-2 mb-3">
                      <Icon name="chat" className="w-5 h-5 text-cyan-400" />
                      <h3 className="font-semibold text-white">AI Advisor</h3>
                    </div>
                    <p className="text-sm text-slate-400 mb-4">
                      Get instant answers about contract risks, negotiation strategies, and compliance requirements.
                    </p>
                    <Button variant="primary" size="md" icon="zap" className="w-full" onClick={() => setShowAdvisor(true)}>
                      Open AI Advisor
                    </Button>
                  </Card>
                </div>
              </div>
            )}

            {/* Empty State */}
            {status === 'idle' && (
              <Card className="mt-6 p-12 text-center">
                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-pink-500/10 flex items-center justify-center">
                  <Icon name="shield" className="w-10 h-10 text-pink-400" />
                </div>
                <h3 className="text-xl font-bold text-white mb-2">Ready to Analyze Contract Terms</h3>
                <p className="text-slate-400 max-w-md mx-auto mb-6">
                  Click "Analyze Contract Risks" to scan {SECTION_I_CLAUSES.length} Section I clauses. The AI will flag unusual terms, 
                  explain them in plain language, and recommend negotiation strategies.
                </p>
                <div className="flex flex-wrap justify-center gap-2">
                  <Badge variant="danger" size="sm">FAR/DFARS Analysis</Badge>
                  <Badge variant="warning" size="sm">Cash Flow Calculator</Badge>
                  <Badge variant="success" size="sm">Compliance Checklist</Badge>
                  <Badge variant="cyan" size="sm">AI Negotiation Advisor</Badge>
                  <Badge variant="purple" size="sm">Trap Detection</Badge>
                </div>
              </Card>
            )}

            {/* Footer */}
            <div className="flex items-center justify-between mt-8 pt-4 border-t border-slate-800">
              <span className="text-xs text-slate-500">MissionPulse v12 â€¢ M5 Contracts Scanner (Enhanced)</span>
              <Badge variant="warning" size="xs">AI GENERATED - REQUIRES HUMAN REVIEW</Badge>
            </div>
          </div>

          {/* Modals & Panels */}
          {selectedClause && (
            <ClauseDetailPanel 
              clause={selectedClause} 
              onClose={() => setSelectedClause(null)}
              onGeneratePoints={(c) => {
                setSelectedClause(null);
                setShowNegotiationPoints(c);
              }}
            />
          )}

          {showNegotiationPoints && (
            <NegotiationPointsPanel 
              clause={showNegotiationPoints} 
              onClose={() => setShowNegotiationPoints(null)} 
            />
          )}

          <AIAdvisorPanel 
            clauses={visibleClauses}
            isOpen={showAdvisor} 
            onClose={() => setShowAdvisor(false)} 
          />

          {/* Memo Modal */}
          {showMemo && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn" onClick={() => setShowMemo(false)}>
              <Card className="w-full max-w-lg p-6 animate-slideIn" onClick={e => e.stopPropagation()}>
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center">
                    <Icon name="document" className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="font-bold text-white">Generate Risk Analysis Memo</h3>
                    <p className="text-sm text-slate-400">FAR_Risk_Analysis_Memo.docx</p>
                  </div>
                </div>
                
                <div className="space-y-3 mb-6">
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    {SECTION_I_CLAUSES.length} Clauses Analyzed
                  </div>
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    Risk Level Assessment (High/Med/Low)
                  </div>
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    Plain-Language Explanations
                  </div>
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    Negotiation Talking Points
                  </div>
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    Cash Flow Impact Model
                  </div>
                  <div className="flex items-center gap-2 text-sm text-slate-300">
                    <Icon name="check" className="w-4 h-4 text-emerald-400" />
                    Compliance Checklist Status
                  </div>
                </div>

                <div className="flex gap-3">
                  <Button variant="ghost" onClick={() => setShowMemo(false)} className="flex-1">Cancel</Button>
                  <Button variant="primary" icon="download" className="flex-1">Download Memo</Button>
                </div>
              </Card>
            </div>
          )}
        </div>
      );
    };

    // ========== RENDER ==========
    // Wrapped App with RBAC
    function App() {
      const { checking, userRole, hasAccess } = useRBAC();
      const connectionStatus = useConnection();
      
      if (checking) return <LoadingSkeleton />;
      if (!hasAccess) return <AccessDenied userRole={userRole} requiredRoles={ALLOWED_ROLES} />;
      
      return (
        <ErrorBoundary>
          <ConnectionBanner status={connectionStatus} />
          <ContractsScanner />
        </ErrorBoundary>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
