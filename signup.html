<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up ‚Äî MissionPulse</title>
<link rel="icon" type="image/png" sizes="32x32" href="MMT_icon_32px.png">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="mp-responsive.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="mp-polish.js"></script>
<style>
  body { background: #00050F; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  .glow-border { border: 1px solid rgba(0,229,250,0.3); box-shadow: 0 0 20px rgba(0,229,250,0.05); }
  .pulse-btn { background: linear-gradient(135deg, #00E5FA 0%, #00B8D4 100%); transition: all 0.2s; }
  .pulse-btn:hover { box-shadow: 0 0 20px rgba(0,229,250,0.4); transform: translateY(-1px); }
  .pulse-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .input-field { background: #0A1628; border: 1px solid #334155; color: #F8FAFC; transition: border-color 0.2s; }
  .input-field:focus { border-color: #00E5FA; outline: none; box-shadow: 0 0 0 2px rgba(0,229,250,0.15); }
  .input-field::placeholder { color: #64748B; }
  .error-msg { color: #EF4444; font-size: 13px; margin-top: 6px; }
  .success-msg { color: #10B981; font-size: 13px; margin-top: 6px; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md">
  <!-- Logo -->
  <div class="text-center mb-8">
    <div class="text-3xl font-bold text-cyan-400 tracking-tight">MISSIONPULSE</div>
    <div class="text-sm text-slate-500 mt-1">Mission Meets Tech</div>
  </div>

  <!-- Signup Card -->
  <div class="glow-border rounded-xl p-8 bg-[#0A1628]">
    <h2 class="text-xl font-bold text-white mb-1">Create your account</h2>
    <p class="text-slate-400 text-sm mb-6">Start your 14-day free trial. No credit card required.</p>

    <!-- Signup Form -->
    <div id="signupForm">
      <div class="mb-4">
        <label class="block text-sm text-slate-300 mb-1.5">Full Name</label>
        <input type="text" id="fullName" placeholder="Mary Womack" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div class="mb-4">
        <label class="block text-sm text-slate-300 mb-1.5">Work Email</label>
        <input type="email" id="email" placeholder="you@company.com" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div class="mb-4">
        <label class="block text-sm text-slate-300 mb-1.5">Password</label>
        <input type="password" id="password" placeholder="Minimum 8 characters" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div class="mb-6">
        <label class="block text-sm text-slate-300 mb-1.5">Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm password" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div id="errorMsg" class="error-msg mb-4 hidden"></div>

      <button id="signupBtn" onclick="handleSignup()" 
        class="pulse-btn w-full py-2.5 rounded-lg text-sm font-semibold text-[#00050F]">
        Create Account
      </button>

      <div class="mt-4 text-center text-sm text-slate-400">
        Already have an account? <a href="login.html" class="text-cyan-400 hover:text-cyan-300">Sign in</a>
      </div>
    </div>

    <!-- Check Email State -->
    <div id="checkEmail" class="hidden text-center py-4">
      <div class="text-4xl mb-4">üì¨</div>
      <h3 class="text-lg font-bold text-white mb-2">Check your email</h3>
      <p class="text-slate-400 text-sm mb-4">We sent a confirmation link to <span id="sentEmail" class="text-cyan-400"></span></p>
      <p class="text-slate-500 text-xs">Click the link in the email to activate your account, then you'll set up your company.</p>
      <a href="login.html" class="inline-block mt-6 text-sm text-cyan-400 hover:text-cyan-300">‚Üê Back to sign in</a>
    </div>

    <!-- Invite Flow -->
    <div id="inviteFlow" class="hidden text-center py-4">
      <div class="text-4xl mb-4">ü§ù</div>
      <h3 class="text-lg font-bold text-white mb-2">You've been invited!</h3>
      <p class="text-slate-400 text-sm mb-4">Your team is waiting for you.</p>
      <button onclick="window.location.href='dashboard.html'" 
        class="pulse-btn px-6 py-2.5 rounded-lg text-sm font-semibold text-[#00050F]">
        Go to Dashboard
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="text-center mt-6 text-xs text-slate-600">
    MISSION. TECHNOLOGY. TRANSFORMATION.<br>
    AI GENERATED ‚Äî REQUIRES HUMAN REVIEW
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
  var sbClient;
  try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) { console.warn('Supabase init failed'); }

  // Check if user already logged in
  (async () => {
    if (!sbClient) return;
    const { data: { session } } = await sbClient.auth.getSession();
    if (session) {
      // Check if they have a company
      const { data: profile } = await sbClient.from('profiles').select('company_id').eq('id', session.user.id).single();
      if (profile?.company_id) {
        window.location.href = 'dashboard.html';
      } else {
        window.location.href = 'company-setup.html';
      }
    }
  })();

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  function hideError() {
    document.getElementById('errorMsg').classList.add('hidden');
  }

  async function handleSignup() {
    hideError();
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validation
    if (!fullName) return showError('Please enter your full name.');
    if (!email) return showError('Please enter your email.');
    if (!password) return showError('Please enter a password.');
    if (password.length < 8) return showError('Password must be at least 8 characters.');
    if (password !== confirmPassword) return showError('Passwords do not match.');

    const btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.textContent = 'Creating account...';

    try {
      // Check for pending invitation
      const { data: invite } = await sbClient
        .from('team_invitations')
        .select('company_id, role')
        .eq('email', email)
        .eq('status', 'pending')
        .single();

      const { data, error } = await sbClient.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: fullName },
          emailRedirectTo: window.location.origin + (invite ? '/dashboard.html' : '/company-setup.html')
        }
      });

      if (error) {
        btn.disabled = false;
        btn.textContent = 'Create Account';
        if (error.message.includes('already registered')) {
          return showError('This email is already registered. Try signing in.');
        }
        return showError(error.message);
      }

      // If there's a pending invite, link to that company
      if (invite && data.user) {
        await sbClient.from('profiles').update({
          company_id: invite.company_id,
          role: invite.role,
          full_name: fullName
        }).eq('id', data.user.id);

        await sbClient.from('team_invitations').update({ status: 'accepted' }).eq('email', email).eq('status', 'pending');

        document.getElementById('signupForm').classList.add('hidden');
        document.getElementById('inviteFlow').classList.remove('hidden');
        return;
      }

      // Normal signup ‚Äî show check email
      document.getElementById('signupForm').classList.add('hidden');
      document.getElementById('checkEmail').classList.remove('hidden');
      document.getElementById('sentEmail').textContent = email;

    } catch (err) {
      console.error('Signup error:', err);
      btn.disabled = false;
      btn.textContent = 'Create Account';
      showError('Something went wrong. Please try again.');
    }
  }

  // Allow Enter key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !document.getElementById('signupForm').classList.contains('hidden')) {
      handleSignup();
    }
  });
</script>
</body>
</html>

