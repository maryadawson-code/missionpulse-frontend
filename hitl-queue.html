<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HITL Queue | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="mp-responsive.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="mp-polish.js"></script>
  <link rel="icon" type="image/png" href="MMT_icon_32px.png">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-navy': '#00050F',
            'cyber-cyan': '#00E5FA',
            'slate-dark': '#0a1628'
          }
        }
      }
    }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .queue-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 229, 250, 0.12); }
    .confidence-bar { height: 4px; border-radius: 2px; transition: width 0.5s; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="min-h-screen text-white">
  <header class="border-b border-slate-800/50 bg-deep-navy/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div>
          <span class="text-lg font-bold text-white">Human-in-the-Loop Queue</span>
          <span class="text-xs text-slate-500 block">AI Output Review &amp; Approval</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="dataSource" class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500">Loading...</span>
        <a href="dashboard-v2.html" class="text-sm text-slate-400 hover:text-cyber-cyan transition-colors">&larr; Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <div id="authCheck" class="text-center py-12">
      <div class="animate-pulse text-slate-500">Authenticating...</div>
    </div>
    <div id="mainContent" class="hidden">
      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Total</p>
          <p class="text-2xl font-bold text-white mt-1" id="statTotal">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Pending</p>
          <p class="text-2xl font-bold text-amber-400 mt-1" id="statPending">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Approved</p>
          <p class="text-2xl font-bold text-emerald-400 mt-1" id="statApproved">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Rejected</p>
          <p class="text-2xl font-bold text-red-400 mt-1" id="statRejected">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Avg Confidence</p>
          <p class="text-2xl font-bold text-cyber-cyan mt-1" id="statAvgConf">0%</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-6">
        <select id="filterStatus" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
          <option value="">All Statuses</option>
          <option value="pending" selected>Pending Review</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="revision">Needs Revision</option>
        </select>
        <select id="filterPriority" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
          <option value="">All Priorities</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <select id="filterAgent" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
          <option value="">All Agents</option>
          <option value="Writer">Writer Agent</option>
          <option value="Compliance">Compliance Agent</option>
          <option value="Pricing">Pricing Agent</option>
          <option value="Strategy">Strategy Agent</option>
        </select>
      </div>

      <!-- Queue Items -->
      <div id="queueContainer" class="space-y-3"></div>
      <div id="emptyState" class="hidden text-center py-16">
        <p class="text-slate-500">No items in the review queue matching your filters.</p>
      </div>
    </div>
  </main>

  <!-- Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-white" id="detailTitle">Review Item</h3>
        <button onclick="closeDetail()" class="text-slate-400 hover:text-white text-xl">&times;</button>
      </div>
      <div class="space-y-4">
        <div class="flex gap-3">
          <span id="detailType" class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300"></span>
          <span id="detailAgent" class="text-xs px-2 py-1 rounded-full bg-violet-500/20 text-violet-300"></span>
          <span id="detailPriority" class="text-xs px-2 py-1 rounded-full"></span>
        </div>
        <div>
          <p class="text-xs text-slate-500 mb-1">AI-Generated Content</p>
          <div id="detailContent" class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 text-sm text-slate-200 whitespace-pre-wrap max-h-60 overflow-y-auto"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-slate-500">Confidence Score</p>
            <div class="flex items-center gap-2 mt-1">
              <div class="flex-1 bg-slate-800 rounded-full h-2">
                <div id="detailConfBar" class="h-2 rounded-full bg-cyber-cyan"></div>
              </div>
              <span id="detailConf" class="text-sm font-bold text-white"></span>
            </div>
          </div>
          <div>
            <p class="text-xs text-slate-500">Evidence Coverage</p>
            <div class="flex items-center gap-2 mt-1">
              <div class="flex-1 bg-slate-800 rounded-full h-2">
                <div id="detailEvidBar" class="h-2 rounded-full bg-emerald-400"></div>
              </div>
              <span id="detailEvid" class="text-sm font-bold text-white"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-800">
        <button onclick="updateStatus(currentDetailId,'rejected')" class="px-4 py-2 text-sm bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 text-red-300 rounded-lg">Reject</button>
        <button onclick="updateStatus(currentDetailId,'revision')" class="px-4 py-2 text-sm bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/30 text-amber-300 rounded-lg">Request Revision</button>
        <button onclick="updateStatus(currentDetailId,'approved')" class="px-4 py-2 text-sm bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/30 text-emerald-300 rounded-lg font-medium">Approve</button>
      </div>
    </div>
  </div>

  <footer class="border-t border-slate-800/30 mt-12 py-4 text-center">
    <p class="text-xs text-slate-600">AI GENERATED &mdash; REQUIRES HUMAN REVIEW &bull; MissionPulse &copy; Mission Meets Tech</p>
  </footer>

<script>
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzQ0NDYsImV4cCI6MjA1MzQxMDQ0Nn0.KmJnSsVJdxFRMPOxFYBxOQZbV5m_s2G8Yn52QLbmCPg';
var sbClient;
try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) { console.warn('Supabase init failed'); }

const DEMO_ITEMS = [
  { id: 'demo-1', section: 'Technical Approach', section_ref: 'L.5.1', content_type: 'narrative', ai_output: 'Our team will leverage a DevSecOps pipeline with continuous ATO monitoring, integrating directly with the DHA Enterprise DevSecOps Environment (eDSE). This approach reduces deployment cycles from quarterly to bi-weekly, maintaining IL5 compliance throughout.', confidence_score: 87, evidence_coverage: 72, status: 'pending', agent_source: 'Writer', priority: 'high', created_at: new Date(Date.now() - 3600000).toISOString() },
  { id: 'demo-2', section: 'Past Performance', section_ref: 'M.2', content_type: 'narrative', ai_output: 'Under Contract W81K04-20-D-0042, our team delivered the MHS Genesis Clinical Decision Support module 3 weeks ahead of schedule, achieving a CPARS rating of Exceptional. This directly parallels the requirement for real-time clinical analytics described in PWS Section C.3.2.', confidence_score: 94, evidence_coverage: 91, status: 'pending', agent_source: 'Writer', priority: 'medium', created_at: new Date(Date.now() - 7200000).toISOString() },
  { id: 'demo-3', section: 'Compliance Check', section_ref: 'FAR 52.204-21', content_type: 'compliance', ai_output: 'FINDING: Section L.5.3 references NIST 800-171 Rev 2 controls but the current Technical Volume only addresses 98 of 110 controls. Missing controls: 3.1.12 (Remote Access), 3.1.20 (External Connections), 3.4.7 (Restrict Software Installation), and 8 others. Recommend immediate gap remediation.', confidence_score: 96, evidence_coverage: 100, status: 'pending', agent_source: 'Compliance', priority: 'critical', created_at: new Date(Date.now() - 1800000).toISOString() },
  { id: 'demo-4', section: 'Pricing Narrative', section_ref: 'Vol III', content_type: 'pricing', ai_output: 'Proposed blended labor rate of $142.50/hr is 8% below the IGCE estimate based on GSA Schedule comparison. FTE allocation: 12 FTE Year 1, ramping to 18 FTE by Year 3. Total ceiling: $24.7M over 5 years (base + 4 options).', confidence_score: 78, evidence_coverage: 65, status: 'pending', agent_source: 'Pricing', priority: 'high', created_at: new Date(Date.now() - 5400000).toISOString() },
  { id: 'demo-5', section: 'Win Theme #2', section_ref: 'Exec Summary', content_type: 'strategy', ai_output: 'Speed-to-ATO Advantage: While competitors average 14 months to achieve ATO in DHA environments, our AMANDA™ platform has demonstrated a 6-month ATO timeline across 3 consecutive DHA programs (W81K04-20, W81K04-21, VA-118-23).', confidence_score: 82, evidence_coverage: 58, status: 'approved', agent_source: 'Strategy', priority: 'medium', created_at: new Date(Date.now() - 86400000).toISOString() },
];

let items = [...DEMO_ITEMS];
let currentDetailId = null;

async function init() {
  let user = null;
  try { if (sbClient) { const { data } = await sbClient.auth.getUser(); user = data?.user; } } catch(e) {}

  document.getElementById('authCheck').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');

  if (user) { await loadFromSupabase(); }
  else { setDataSource('Demo Data', 'text-amber-400'); }

  ['filterStatus','filterPriority','filterAgent'].forEach(id => document.getElementById(id).addEventListener('change', renderQueue));
  renderQueue();
}

function setDataSource(label, cls) {
  const el = document.getElementById('dataSource');
  el.textContent = label;
  el.className = 'text-xs px-2 py-1 rounded bg-slate-800 ' + cls;
}

async function loadFromSupabase() {
  try {
    const { data, error } = await sbClient.from('hitl_queue').select('*').order('created_at', { ascending: false });
    if (!error && data && data.length > 0) {
      items = data;
      setDataSource('Live — Supabase', 'text-emerald-400');
    } else { setDataSource('Demo Data', 'text-amber-400'); }
  } catch(e) { setDataSource('Demo Data', 'text-amber-400'); }
}

const PRIORITY_STYLE = {
  critical: 'bg-red-500/20 text-red-300 border border-red-500/30',
  high: 'bg-amber-500/20 text-amber-300 border border-amber-500/30',
  medium: 'bg-blue-500/20 text-blue-300 border border-blue-500/30',
  low: 'bg-slate-700/50 text-slate-400 border border-slate-600/30'
};
const STATUS_BADGE = {
  pending: 'bg-amber-500/20 text-amber-300',
  approved: 'bg-emerald-500/20 text-emerald-300',
  rejected: 'bg-red-500/20 text-red-300',
  revision: 'bg-violet-500/20 text-violet-300'
};

function confColor(score) {
  if (score >= 90) return 'bg-emerald-400';
  if (score >= 75) return 'bg-cyber-cyan';
  if (score >= 60) return 'bg-amber-400';
  return 'bg-red-400';
}

function renderQueue() {
  const sF = document.getElementById('filterStatus').value;
  const pF = document.getElementById('filterPriority').value;
  const aF = document.getElementById('filterAgent').value;
  let filtered = [...items];
  if (sF) filtered = filtered.filter(i => i.status === sF);
  if (pF) filtered = filtered.filter(i => i.priority === pF);
  if (aF) filtered = filtered.filter(i => i.agent_source === aF);

  document.getElementById('statTotal').textContent = items.length;
  document.getElementById('statPending').textContent = items.filter(i => i.status === 'pending').length;
  document.getElementById('statApproved').textContent = items.filter(i => i.status === 'approved').length;
  document.getElementById('statRejected').textContent = items.filter(i => i.status === 'rejected').length;
  const scores = items.filter(i => i.confidence_score != null).map(i => i.confidence_score);
  document.getElementById('statAvgConf').textContent = scores.length ? Math.round(scores.reduce((a,b) => a+b, 0) / scores.length) + '%' : '-';

  const container = document.getElementById('queueContainer');
  const empty = document.getElementById('emptyState');
  if (filtered.length === 0) { container.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  container.innerHTML = filtered.map(item => {
    const conf = item.confidence_score || 0;
    const evid = item.evidence_coverage || 0;
    const ps = PRIORITY_STYLE[item.priority] || PRIORITY_STYLE.medium;
    const sb = STATUS_BADGE[item.status] || STATUS_BADGE.pending;
    const age = timeAgo(item.created_at);
    return `<div class="queue-card bg-slate-900/60 border border-slate-800/50 rounded-xl p-4 cursor-pointer transition-all" onclick="showDetail('${item.id}')">
      <div class="flex items-start justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-xs px-2 py-0.5 rounded-full ${ps} font-medium">${(item.priority||'medium').toUpperCase()}</span>
          <span class="text-xs px-2 py-0.5 rounded-full ${sb}">${(item.status||'pending')}</span>
          <span class="text-xs px-2 py-0.5 rounded-full bg-violet-500/20 text-violet-300">${item.agent_source || 'AI'} Agent</span>
        </div>
        <span class="text-xs text-slate-500">${age}</span>
      </div>
      <h4 class="text-white font-medium">${item.section} ${item.section_ref ? '<span class="text-slate-500 text-xs ml-1">(' + item.section_ref + ')</span>' : ''}</h4>
      <p class="text-xs text-slate-400 mt-1 line-clamp-2">${item.ai_output}</p>
      <div class="flex items-center gap-6 mt-3">
        <div class="flex items-center gap-2 flex-1">
          <span class="text-xs text-slate-500">Confidence</span>
          <div class="flex-1 bg-slate-800 rounded-full h-1.5"><div class="h-1.5 rounded-full ${confColor(conf)}" style="width:${conf}%"></div></div>
          <span class="text-xs font-medium text-white">${conf}%</span>
        </div>
        <div class="flex items-center gap-2 flex-1">
          <span class="text-xs text-slate-500">Evidence</span>
          <div class="flex-1 bg-slate-800 rounded-full h-1.5"><div class="h-1.5 rounded-full bg-emerald-400" style="width:${evid}%"></div></div>
          <span class="text-xs font-medium text-white">${evid}%</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs / 24) + 'd ago';
}

function showDetail(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  currentDetailId = id;
  document.getElementById('detailTitle').textContent = item.section + (item.section_ref ? ' (' + item.section_ref + ')' : '');
  document.getElementById('detailType').textContent = item.content_type || '-';
  document.getElementById('detailAgent').textContent = (item.agent_source || 'AI') + ' Agent';
  const pEl = document.getElementById('detailPriority');
  pEl.textContent = (item.priority || 'medium').toUpperCase();
  pEl.className = 'text-xs px-2 py-1 rounded-full ' + (PRIORITY_STYLE[item.priority] || PRIORITY_STYLE.medium);
  document.getElementById('detailContent').textContent = item.ai_output;
  const conf = item.confidence_score || 0;
  const evid = item.evidence_coverage || 0;
  document.getElementById('detailConfBar').style.width = conf + '%';
  document.getElementById('detailConfBar').className = 'h-2 rounded-full ' + confColor(conf);
  document.getElementById('detailConf').textContent = conf + '%';
  document.getElementById('detailEvidBar').style.width = evid + '%';
  document.getElementById('detailEvid').textContent = evid + '%';
  document.getElementById('detailModal').classList.remove('hidden');
}

function closeDetail() { document.getElementById('detailModal').classList.add('hidden'); }

async function updateStatus(id, newStatus) {
  const idx = items.findIndex(i => i.id === id);
  if (idx === -1) return;
  items[idx].status = newStatus;
  try {
    if (sbClient && !id.startsWith('demo-') && !id.startsWith('local-')) {
      await sbClient.from('hitl_queue').update({ status: newStatus }).eq('id', id);
    }
  } catch(e) { console.warn('Supabase update failed'); }
  closeDetail();
  renderQueue();
}

init();
</script>
</body>
</html>


