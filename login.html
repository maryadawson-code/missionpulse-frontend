<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'mp-cyan': '#00E5FA',
            'mp-navy': '#00050F',
            'mp-dark': '#0a0f1a',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    .gradient-bg {
      background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 229, 250, 0.1);
    }
    
    .input-field {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .input-field:focus {
      background: rgba(255, 255, 255, 0.08);
      border-color: #00E5FA;
      box-shadow: 0 0 0 3px rgba(0, 229, 250, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00E5FA 0%, #00b8d4 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0, 229, 250, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-oauth {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .btn-oauth:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .pulse-ring {
      animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }
    
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1); opacity: 0.3; }
      100% { transform: scale(0.8); opacity: 0.5; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .spinner {
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
  
  <!-- Background Effects -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-mp-cyan/5 rounded-full blur-3xl pulse-ring"></div>
    <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-teal-500/5 rounded-full blur-3xl pulse-ring" style="animation-delay: 1s;"></div>
  </div>
  
  <!-- Main Container -->
  <div class="relative z-10 w-full max-w-md fade-in">
    
    <!-- Logo & Branding -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-mp-cyan to-teal-500 mb-4 shadow-lg shadow-mp-cyan/20">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-white mb-2">MissionPulse</h1>
      <p class="text-slate-400 text-sm">Mission. Technology. Transformation.</p>
    </div>
    
    <!-- Login Card -->
    <div class="glass-card rounded-2xl p-8">
      
      <!-- Tab Switcher -->
      <div class="flex mb-6 bg-slate-800/50 rounded-lg p-1">
        <button id="loginTab" onclick="switchTab('login')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all bg-mp-cyan/20 text-mp-cyan">
          Sign In
        </button>
        <button id="signupTab" onclick="switchTab('signup')" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white">
          Sign Up
        </button>
      </div>
      
      <!-- Error/Success Messages -->
      <div id="messageBox" class="hidden mb-4 p-3 rounded-lg text-sm"></div>
      
      <!-- Login Form -->
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="loginEmail" 
              required
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="you@company.com"
            >
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Password</label>
            <input 
              type="password" 
              id="loginPassword" 
              required
              minlength="6"
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="••••••••"
            >
          </div>
          
          <div class="flex items-center justify-between text-sm">
            <label class="flex items-center text-slate-400">
              <input type="checkbox" id="rememberMe" class="mr-2 rounded bg-slate-700 border-slate-600">
              Remember me
            </label>
            <a href="#" onclick="showForgotPassword()" class="text-mp-cyan hover:underline">Forgot password?</a>
          </div>
          
          <button 
            type="submit" 
            id="loginBtn"
            class="btn-primary w-full py-3 rounded-lg text-mp-navy font-semibold flex items-center justify-center gap-2"
          >
            <span id="loginBtnText">Sign In</span>
            <div id="loginSpinner" class="hidden w-5 h-5 spinner"></div>
          </button>
        </div>
      </form>
      
      <!-- Signup Form (Hidden by default) -->
      <form id="signupForm" class="hidden" onsubmit="handleSignup(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Full Name</label>
            <input 
              type="text" 
              id="signupName" 
              required
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="Jane Smith"
            >
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Work Email</label>
            <input 
              type="email" 
              id="signupEmail" 
              required
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="you@company.com"
            >
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Password</label>
            <input 
              type="password" 
              id="signupPassword" 
              required
              minlength="6"
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="Min 6 characters"
            >
          </div>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Company Name</label>
            <input 
              type="text" 
              id="signupCompany" 
              required
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="Your Company Inc."
            >
          </div>
          
          <button 
            type="submit" 
            id="signupBtn"
            class="btn-primary w-full py-3 rounded-lg text-mp-navy font-semibold flex items-center justify-center gap-2"
          >
            <span id="signupBtnText">Create Account</span>
            <div id="signupSpinner" class="hidden w-5 h-5 spinner"></div>
          </button>
        </div>
      </form>
      
      <!-- Forgot Password Form (Hidden) -->
      <form id="forgotForm" class="hidden" onsubmit="handleForgotPassword(event)">
        <div class="space-y-4">
          <p class="text-slate-400 text-sm mb-4">Enter your email and we'll send you a reset link.</p>
          
          <div>
            <label class="block text-slate-300 text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="forgotEmail" 
              required
              class="input-field w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 outline-none"
              placeholder="you@company.com"
            >
          </div>
          
          <button 
            type="submit" 
            id="forgotBtn"
            class="btn-primary w-full py-3 rounded-lg text-mp-navy font-semibold flex items-center justify-center gap-2"
          >
            <span id="forgotBtnText">Send Reset Link</span>
            <div id="forgotSpinner" class="hidden w-5 h-5 spinner"></div>
          </button>
          
          <button 
            type="button" 
            onclick="switchTab('login')"
            class="w-full py-2 text-slate-400 hover:text-white text-sm"
          >
            ← Back to login
          </button>
        </div>
      </form>
      
      <!-- Divider -->
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-slate-700"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-4 bg-mp-dark text-slate-500">or continue with</span>
        </div>
      </div>
      
      <!-- OAuth Buttons -->
      <div class="grid grid-cols-2 gap-3">
        <button onclick="signInWithGoogle()" class="btn-oauth py-3 px-4 rounded-lg flex items-center justify-center gap-2 text-white">
          <svg class="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span class="text-sm font-medium">Google</span>
        </button>
        
        <button onclick="signInWithMicrosoft()" class="btn-oauth py-3 px-4 rounded-lg flex items-center justify-center gap-2 text-white">
          <svg class="w-5 h-5" viewBox="0 0 23 23">
            <path fill="#f25022" d="M1 1h10v10H1z"/>
            <path fill="#00a4ef" d="M1 12h10v10H1z"/>
            <path fill="#7fba00" d="M12 1h10v10H12z"/>
            <path fill="#ffb900" d="M12 12h10v10H12z"/>
          </svg>
          <span class="text-sm font-medium">Microsoft</span>
        </button>
      </div>
      
    </div>
    
    <!-- Footer -->
    <p class="text-center text-slate-500 text-xs mt-6">
      By signing in, you agree to our 
      <a href="#" class="text-mp-cyan hover:underline">Terms of Service</a> 
      and 
      <a href="#" class="text-mp-cyan hover:underline">Privacy Policy</a>
    </p>
    
  </div>
  
  <script>
    // ===========================================
    // SUPABASE CONFIGURATION
    // ===========================================
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ===========================================
    // CHECK IF ALREADY LOGGED IN
    // ===========================================
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        // Already logged in, redirect to dashboard
        window.location.href = 'index.html';
      }
    }
    checkAuth();
    
    // Listen for auth changes (for OAuth redirects)
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        window.location.href = 'index.html';
      }
    });
    
    // ===========================================
    // UI FUNCTIONS
    // ===========================================
    function switchTab(tab) {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const forgotForm = document.getElementById('forgotForm');
      const loginTab = document.getElementById('loginTab');
      const signupTab = document.getElementById('signupTab');
      const messageBox = document.getElementById('messageBox');
      
      // Hide message
      messageBox.classList.add('hidden');
      
      // Reset all
      loginForm.classList.add('hidden');
      signupForm.classList.add('hidden');
      forgotForm.classList.add('hidden');
      loginTab.classList.remove('bg-mp-cyan/20', 'text-mp-cyan');
      loginTab.classList.add('text-slate-400');
      signupTab.classList.remove('bg-mp-cyan/20', 'text-mp-cyan');
      signupTab.classList.add('text-slate-400');
      
      if (tab === 'login') {
        loginForm.classList.remove('hidden');
        loginTab.classList.add('bg-mp-cyan/20', 'text-mp-cyan');
        loginTab.classList.remove('text-slate-400');
      } else if (tab === 'signup') {
        signupForm.classList.remove('hidden');
        signupTab.classList.add('bg-mp-cyan/20', 'text-mp-cyan');
        signupTab.classList.remove('text-slate-400');
      } else if (tab === 'forgot') {
        forgotForm.classList.remove('hidden');
      }
    }
    
    function showForgotPassword() {
      switchTab('forgot');
    }
    
    function showMessage(message, isError = false) {
      const messageBox = document.getElementById('messageBox');
      messageBox.textContent = message;
      messageBox.classList.remove('hidden', 'bg-red-500/20', 'text-red-400', 'bg-green-500/20', 'text-green-400');
      
      if (isError) {
        messageBox.classList.add('bg-red-500/20', 'text-red-400');
      } else {
        messageBox.classList.add('bg-green-500/20', 'text-green-400');
      }
    }
    
    function setLoading(formType, isLoading) {
      const btn = document.getElementById(formType + 'Btn');
      const btnText = document.getElementById(formType + 'BtnText');
      const spinner = document.getElementById(formType + 'Spinner');
      
      if (isLoading) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        spinner.classList.remove('hidden');
      } else {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    }
    
    // ===========================================
    // AUTH FUNCTIONS
    // ===========================================
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      setLoading('login', true);
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      setLoading('login', false);
      
      if (error) {
        showMessage(error.message, true);
      } else {
        showMessage('Login successful! Redirecting...');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      }
    }
    
    async function handleSignup(e) {
      e.preventDefault();
      
      const fullName = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const companyName = document.getElementById('signupCompany').value;
      
      setLoading('signup', true);
      
      // 1. Create the user account
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
            company_name: companyName
          }
        }
      });
      
      if (authError) {
        setLoading('signup', false);
        showMessage(authError.message, true);
        return;
      }
      
      // 2. Create the company
      const { data: companyData, error: companyError } = await supabase
        .from('companies')
        .insert({
          name: companyName,
          domain: email.split('@')[1]
        })
        .select()
        .single();
      
      if (companyError) {
        console.error('Company creation error:', companyError);
        // Continue anyway - user is created
      }
      
      // 3. Update the user record with company_id
      if (companyData && authData.user) {
        const { error: updateError } = await supabase
          .from('users')
          .update({ 
            company_id: companyData.id,
            full_name: fullName,
            role: 'CEO',
            is_company_admin: true
          })
          .eq('id', authData.user.id);
          
        if (updateError) {
          console.error('User update error:', updateError);
        }
      }
      
      setLoading('signup', false);
      showMessage('Account created! Check your email to confirm, then sign in.');
      
      // Switch to login tab
      setTimeout(() => {
        switchTab('login');
        document.getElementById('loginEmail').value = email;
      }, 2000);
    }
    
    async function handleForgotPassword(e) {
      e.preventDefault();
      
      const email = document.getElementById('forgotEmail').value;
      
      setLoading('forgot', true);
      
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin + '/reset-password.html'
      });
      
      setLoading('forgot', false);
      
      if (error) {
        showMessage(error.message, true);
      } else {
        showMessage('Password reset link sent! Check your email.');
      }
    }
    
    async function signInWithGoogle() {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + '/index.html'
        }
      });
      
      if (error) {
        showMessage(error.message, true);
      }
    }
    
    async function signInWithMicrosoft() {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'azure',
        options: {
          scopes: 'email profile openid',
          redirectTo: window.location.origin + '/index.html'
        }
      });
      
      if (error) {
        showMessage(error.message, true);
      }
    }
  </script>
  
</body>
</html>
