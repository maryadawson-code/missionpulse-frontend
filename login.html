<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="icon" type="image/png" href="MMT_icon_32px.png">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-navy': '#00050F',
            'cyber-cyan': '#00E5FA',
            'slate-dark': '#0a1628'
          }
        }
      }
    }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 30px rgba(0, 229, 250, 0.15); }
    .input-field:focus { box-shadow: 0 0 0 2px rgba(0, 229, 250, 0.3); }
    .pulse-ring { animation: pulse-ring 2s ease-in-out infinite; }
    @keyframes pulse-ring {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0, 229, 250, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(0, 229, 250, 0); }
    }
  </style>
</head>
<body class="min-h-screen text-white flex items-center justify-center p-4">

  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-cyber-cyan/20 to-blue-600/20 border border-cyber-cyan/30 pulse-ring mb-4">
        <img src="MMT_icon_64px.png" alt="MissionPulse" class="w-10 h-10" onerror="this.outerHTML='<span class=\'text-2xl font-bold text-cyber-cyan\'>MP</span>'">
      </div>
      <h1 class="text-2xl font-bold text-white">MissionPulse</h1>
      <p class="text-sm text-slate-400 mt-1">Mission Meets Tech &bull; Secure Sign In</p>
    </div>

    <!-- Login Card -->
    <div class="bg-slate-900/60 backdrop-blur-sm border border-slate-800/50 rounded-2xl p-8 glow-border">

      <!-- Status Banner -->
      <div id="statusBanner" class="hidden mb-6 px-4 py-3 rounded-lg text-sm">
        <p id="statusText"></p>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
          <input type="email" id="email" required autocomplete="email"
            class="input-field w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-cyber-cyan focus:outline-none transition-all"
            placeholder="you@company.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">Password</label>
          <input type="password" id="password" required autocomplete="current-password"
            class="input-field w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-cyber-cyan focus:outline-none transition-all"
            placeholder="••••••••">
        </div>

        <button type="submit" id="submitBtn"
          class="w-full py-3 bg-gradient-to-r from-cyber-cyan to-blue-500 text-deep-navy font-bold rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 flex items-center justify-center gap-2">
          <span id="btnText">Sign In</span>
          <svg id="btnSpinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
        </button>
      </form>

      <!-- Links -->
      <div class="mt-6 flex items-center justify-between text-sm">
        <a href="reset-password.html" class="text-slate-400 hover:text-cyber-cyan transition-colors">Forgot password?</a>
        <a href="signup.html" class="text-cyber-cyan hover:text-white transition-colors">Create account</a>
      </div>

      <!-- Divider -->
      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
        <div class="relative flex justify-center"><span class="bg-slate-900/60 px-3 text-xs text-slate-500 uppercase tracking-wider">Demo Access</span></div>
      </div>

      <!-- Demo Quick Login -->
      <div class="grid grid-cols-2 gap-3">
        <button onclick="demoLogin('CEO')" class="px-3 py-2 bg-violet-500/10 border border-violet-500/30 rounded-lg text-sm text-violet-400 hover:bg-violet-500/20 transition-colors">
          <span class="block font-medium">CEO</span>
          <span class="text-xs text-slate-500">Full Access</span>
        </button>
        <button onclick="demoLogin('COO')" class="px-3 py-2 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm text-blue-400 hover:bg-blue-500/20 transition-colors">
          <span class="block font-medium">COO</span>
          <span class="text-xs text-slate-500">Operations</span>
        </button>
        <button onclick="demoLogin('Capture Manager')" class="px-3 py-2 bg-emerald-500/10 border border-emerald-500/30 rounded-lg text-sm text-emerald-400 hover:bg-emerald-500/20 transition-colors">
          <span class="block font-medium">Capture Mgr</span>
          <span class="text-xs text-slate-500">Strategy</span>
        </button>
        <button onclick="demoLogin('Viewer')" class="px-3 py-2 bg-slate-500/10 border border-slate-600/30 rounded-lg text-sm text-slate-400 hover:bg-slate-500/20 transition-colors">
          <span class="block font-medium">Viewer</span>
          <span class="text-xs text-slate-500">Read Only</span>
        </button>
      </div>
    </div>

    <!-- Footer -->
    <p class="text-center text-xs text-slate-600 mt-6">&copy; 2025 Mission Meets Tech &bull; AI GENERATED &mdash; REQUIRES HUMAN REVIEW</p>
  </div>

<script>
// =============================================================================
// SUPABASE AUTH — Canonical Instance (djuviwarqdvlbgcfuupa)
// =============================================================================
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';

var sbClient;
try {
  sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
} catch(e) {
  console.error('Supabase init failed:', e);
}

// =============================================================================
// UI HELPERS
// =============================================================================
function showStatus(message, type) {
  const banner = document.getElementById('statusBanner');
  const text = document.getElementById('statusText');
  banner.classList.remove('hidden', 'bg-red-500/10', 'bg-green-500/10', 'bg-amber-500/10');
  text.classList.remove('text-red-400', 'text-green-400', 'text-amber-400');
  const colors = {
    success: ['bg-green-500/10', 'text-green-400'],
    error:   ['bg-red-500/10',   'text-red-400'],
    warning: ['bg-amber-500/10', 'text-amber-400']
  };
  const [bg, fg] = colors[type] || colors.error;
  banner.classList.add(bg);
  text.classList.add(fg);
  text.textContent = message;
}

function setLoading(isLoading) {
  document.getElementById('submitBtn').disabled = isLoading;
  document.getElementById('btnText').textContent = isLoading ? 'Signing in...' : 'Sign In';
  document.getElementById('btnSpinner').classList.toggle('hidden', !isLoading);
}

// =============================================================================
// REAL SUPABASE AUTH — signInWithPassword
// =============================================================================
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  setLoading(true);

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if (!sbClient) {
    showStatus('Connection error. Please refresh and try again.', 'error');
    setLoading(false);
    return;
  }

  try {
    const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

    if (error) {
      console.error('Auth error:', error.message);
      if (error.message.includes('Invalid login')) {
        showStatus('Invalid email or password. Check your credentials.', 'error');
      } else if (error.message.includes('Email not confirmed')) {
        showStatus('Please confirm your email before signing in.', 'warning');
      } else {
        showStatus(error.message, 'error');
      }
      setLoading(false);
      return;
    }

    if (data.session) {
      showStatus('Login successful! Redirecting...', 'success');
      setTimeout(() => { window.location.href = 'dashboard-v2.html'; }, 500);
    } else {
      showStatus('Unexpected response. Please try again.', 'error');
      setLoading(false);
    }
  } catch (err) {
    console.error('Login exception:', err);
    showStatus('Network error. Check your connection.', 'error');
    setLoading(false);
  }
});

// =============================================================================
// DEMO LOGIN — Uses real Supabase auth with known demo credentials
// Falls back to localStorage bridge if demo accounts not provisioned
// =============================================================================
const DEMO_ACCOUNTS = {
  'CEO':             { email: 'maryadawson@gmail.com', password: null },
  'COO':             { email: 'demo-coo@missionpulse.io', password: null },
  'Capture Manager': { email: 'demo-capture@missionpulse.io', password: null },
  'Viewer':          { email: 'demo-viewer@missionpulse.io', password: null }
};

async function demoLogin(role) {
  const account = DEMO_ACCOUNTS[role];
  if (!account) return;

  // If no demo password configured, use localStorage bridge for demo mode
  // This allows the dashboard to detect demo sessions
  showStatus(`Entering demo mode as ${role}...`, 'success');

  const demoUser = {
    email: account.email,
    role: role,
    name: role === 'CEO' ? 'Mary Womack' : `Demo ${role}`,
    company: 'Mission Meets Tech',
    companyId: '11111111-1111-1111-1111-111111111111',
    loginTime: new Date().toISOString(),
    isDemo: true
  };

  localStorage.setItem('MP_USER', JSON.stringify(demoUser));
  localStorage.setItem('MP_SESSION', JSON.stringify({ user: demoUser, token: 'demo-' + Date.now() }));

  setTimeout(() => { window.location.href = 'dashboard-v2.html'; }, 500);
}

// =============================================================================
// SESSION CHECK — Redirect if already authenticated
// =============================================================================
async function checkExistingSession() {
  if (!sbClient) return;

  try {
    const { data: { session } } = await sbClient.auth.getSession();
    if (session) {
      window.location.href = 'dashboard-v2.html';
      return;
    }
  } catch(e) {
    console.warn('Session check failed:', e);
  }

  // Also check demo session
  const demoUser = localStorage.getItem('MP_USER');
  const demoSession = localStorage.getItem('MP_SESSION');
  if (demoUser && demoSession) {
    try {
      const user = JSON.parse(demoUser);
      if (user && user.email && user.isDemo) {
        window.location.href = 'dashboard-v2.html';
      }
    } catch(e) {}
  }
}

checkExistingSession();
</script>
</body>
</html>
