<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse - Sign In</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family:Inter,sans-serif;background:#00050F;min-height:100vh;display:flex;align-items:center;justify-content:center;margin:0;padding:16px">
  <div style="width:100%;max-width:400px">
    <div style="text-align:center;margin-bottom:32px">
      <h1 style="color:white;font-size:24px;font-weight:bold;margin:0">MissionPulse</h1>
      <p style="color:#94a3b8;font-size:14px;margin-top:4px">Mission. Technology. Transformation.</p>
    </div>
    <div style="background:rgba(30,41,59,0.5);border:1px solid rgba(51,65,85,0.5);border-radius:16px;padding:32px">
      <div id="errorAlert" style="display:none;margin-bottom:16px;padding:16px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px">
        <p style="color:#f87171;font-weight:500;font-size:14px;margin:0">Authentication Error</p>
        <p id="errorMessage" style="color:#fca5a5;font-size:14px;margin:4px 0 0 0"></p>
      </div>
      <div id="successAlert" style="display:none;margin-bottom:16px;padding:16px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:12px">
        <p id="successMessage" style="color:#34d399;font-weight:500;font-size:14px;margin:0">Success!</p>
      </div>
      <form id="loginForm">
        <div style="margin-bottom:20px">
          <label style="display:block;font-size:14px;font-weight:500;color:#cbd5e1;margin-bottom:8px">Email</label>
          <input type="email" id="email" required style="width:100%;padding:12px 16px;background:rgba(15,23,42,0.5);border:1px solid #475569;border-radius:12px;color:white;font-size:14px;box-sizing:border-box" placeholder="you@company.com">
        </div>
        <div style="margin-bottom:20px">
          <label style="display:block;font-size:14px;font-weight:500;color:#cbd5e1;margin-bottom:8px">Password</label>
          <input type="password" id="password" required style="width:100%;padding:12px 16px;background:rgba(15,23,42,0.5);border:1px solid #475569;border-radius:12px;color:white;font-size:14px;box-sizing:border-box" placeholder="********">
        </div>
        <button type="submit" id="submitBtn" style="width:100%;padding:12px;background:linear-gradient(to right,#06b6d4,#14b8a6);color:white;font-weight:600;border:none;border-radius:12px;cursor:pointer;font-size:14px">Sign In</button>
      </form>
      <div style="text-align:center;margin-top:16px">
        <a href="reset-password.html" style="color:#06b6d4;font-size:13px;text-decoration:none">Forgot password?</a>
      </div>
    </div>
    <!-- Debug Panel - ALWAYS VISIBLE -->
    <div id="debugPanel" style="margin-top:16px;padding:12px;background:rgba(15,23,42,0.8);border:1px solid #334155;border-radius:8px">
      <p style="font-size:12px;color:#fbbf24;margin:0 0 8px 0;font-weight:600">ðŸ”§ Debug Console</p>
      <pre id="debugOutput" style="font-size:11px;color:#4ade80;margin:0;overflow:auto;max-height:150px;white-space:pre-wrap;word-break:break-all"></pre>
    </div>
    <p style="text-align:center;color:#475569;font-size:11px;margin-top:16px">v1.0.1 | AI GENERATED - REQUIRES HUMAN REVIEW</p>
  </div>
  <script>
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';
    
    let supabase;
    
    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      const output = document.getElementById('debugOutput');
      output.textContent += '[' + ts + '] ' + msg + '\n';
      output.scrollTop = output.scrollHeight;
      console.log('[MissionPulse] ' + msg);
    }
    
    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorAlert').style.display = 'block';
      document.getElementById('successAlert').style.display = 'none';
    }
    
    function showSuccess(msg) {
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successAlert').style.display = 'block';
      document.getElementById('errorAlert').style.display = 'none';
    }
    
    // Initialize
    log('Initializing Supabase...');
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      log('Supabase client created OK');
    } catch (err) {
      log('ERROR creating client: ' + err.message);
    }
    
    // Check existing session
    (async () => {
      try {
        log('Checking existing session...');
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          log('Session check error: ' + error.message);
          return;
        }
        if (session) {
          log('Active session found: ' + session.user.email);
          log('Redirecting to dashboard...');
          window.location.href = 'missionpulse-v12-sprint16.html';
        } else {
          log('No active session - ready for login');
        }
      } catch (err) {
        log('Session check exception: ' + err.message);
      }
    })();
    
    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('errorAlert').style.display = 'none';
      document.getElementById('successAlert').style.display = 'none';
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';
      
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      
      log('Login attempt: ' + email);
      
      try {
        log('Calling signInWithPassword...');
        const { data, error } = await supabase.auth.signInWithPassword({ 
          email: email, 
          password: password 
        });
        
        if (error) {
          log('AUTH ERROR: ' + error.message);
          log('Error status: ' + (error.status || 'N/A'));
          showError(error.message);
          btn.disabled = false;
          btn.textContent = 'Sign In';
          return;
        }
        
        log('AUTH SUCCESS!');
        log('User ID: ' + data.user.id);
        log('Email: ' + data.user.email);
        log('Confirmed: ' + (data.user.email_confirmed_at ? 'Yes' : 'No'));
        
        showSuccess('Login successful! Redirecting...');
        
        // Store basic user info
        localStorage.setItem('mp_user', JSON.stringify({ 
          id: data.user.id, 
          email: data.user.email 
        }));
        
        // Fetch profile from public.users
        log('Fetching user profile...');
        const { data: profile, error: profileError } = await supabase
          .from('users')
          .select('*')
          .eq('id', data.user.id)
          .single();
        
        if (profileError) {
          log('Profile fetch warning: ' + profileError.message);
        } else {
          log('Profile loaded - Role: ' + profile.role);
          sessionStorage.setItem('mp_user_profile', JSON.stringify(profile));
        }
        
        log('Redirecting to dashboard...');
        setTimeout(function() {
          window.location.href = 'missionpulse-v12-sprint16.html';
        }, 1000);
        
      } catch (err) {
        log('EXCEPTION: ' + err.message);
        showError('Unexpected error: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });
  </script>
</body>
</html>
