<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse M3 - Shipley Phase Swimlane Board</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- API Client for AI Agents -->
  <script src="render-api-client.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'pulse-cyan': '#00E5FA',
            'shield-navy': '#00050F',
            'shield-dark': '#0a0f1a',
            'shield-panel': '#0d1526',
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-shimmer { 
      background: linear-gradient(90deg, transparent, rgba(0,229,250,0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #00E5FA; }
    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Icons
    const Icons = {
      grip: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" /></svg>,
      chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2" /></svg>,
      users: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      target: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      dollar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      alert: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      arrowRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
    };

    const Icon = ({ name, className = "w-4 h-4" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // Shipley Phases with colors and descriptions
    const SHIPLEY_PHASES = [
      { id: 'gate1', name: 'Gate 1', shortName: 'G1', color: '#6366F1', description: 'Go/No-Go Decision' },
      { id: 'blue', name: 'Blue Team', shortName: 'BT', color: '#3B82F6', description: 'Strategy Review' },
      { id: 'kickoff', name: 'Kickoff', shortName: 'KO', color: '#8B5CF6', description: '48hr from RFP' },
      { id: 'pink', name: 'Pink Team', shortName: 'PT', color: '#EC4899', description: '30% Draft Review' },
      { id: 'red', name: 'Red Team', shortName: 'RT', color: '#EF4444', description: '70% Compliance' },
      { id: 'gold', name: 'Gold Team', shortName: 'GT', color: '#F59E0B', description: '90% Final Review' },
      { id: 'white', name: 'White Glove', shortName: 'WG', color: '#F8FAFC', description: 'QC & Production' },
      { id: 'submit', name: 'Submission', shortName: 'SUB', color: '#10B981', description: 'Final Delivery' },
    ];

    // Demo opportunities data
    const DEMO_OPPORTUNITIES = [
      {
        id: 'opp1',
        name: 'DHA Healthcare Data Platform',
        value: '$100M',
        priority: 'P-0',
        phase: 'red',
        dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000), // 2 days
        winProb: 72,
        owner: 'Sarah Chen',
        team: ['PM', 'SA', 'CON'],
      },
      {
        id: 'opp2',
        name: 'VA EHR Modernization',
        value: '$45M',
        priority: 'P-1',
        phase: 'pink',
        dueDate: new Date(Date.now() + 8 * 24 * 60 * 60 * 1000), // 8 days
        winProb: 58,
        owner: 'Mike Johnson',
        team: ['CAP', 'PM'],
      },
      {
        id: 'opp3',
        name: 'Army MedLog Support',
        value: '$28M',
        priority: 'P-1',
        phase: 'gold',
        dueDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000), // 1 day
        winProb: 85,
        owner: 'Lisa Park',
        team: ['PM', 'SA', 'FIN', 'CON'],
      },
      {
        id: 'opp4',
        name: 'DISA Cloud Migration',
        value: '$65M',
        priority: 'P-0',
        phase: 'blue',
        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days
        winProb: 45,
        owner: 'David Kim',
        team: ['CEO', 'CAP'],
      },
      {
        id: 'opp5',
        name: 'NIH Research Portal',
        value: '$18M',
        priority: 'P-2',
        phase: 'kickoff',
        dueDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000), // 5 days
        winProb: 62,
        owner: 'Amy Wright',
        team: ['PM', 'SA'],
      },
      {
        id: 'opp6',
        name: 'CDC Analytics Platform',
        value: '$35M',
        priority: 'P-1',
        phase: 'gate1',
        dueDate: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000), // 21 days
        winProb: 38,
        owner: 'Tom Rivera',
        team: ['CEO', 'COO'],
      },
      {
        id: 'opp7',
        name: 'FEMA Response System',
        value: '$22M',
        priority: 'P-2',
        phase: 'white',
        dueDate: new Date(Date.now() + 0.5 * 24 * 60 * 60 * 1000), // 12 hours
        winProb: 91,
        owner: 'Rachel Green',
        team: ['PM', 'DEL'],
      },
      {
        id: 'opp8',
        name: 'SSA Fraud Detection',
        value: '$55M',
        priority: 'P-1',
        phase: 'submit',
        dueDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), // Submitted yesterday
        winProb: 78,
        owner: 'James Wilson',
        team: ['PM', 'SA', 'CON', 'FIN'],
      },
    ];

    // Get days until due
    const getDaysUntil = (date) => {
      const now = new Date();
      const diff = date - now;
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    };

    // Get due date color based on urgency
    const getDueDateColor = (dueDate) => {
      const days = getDaysUntil(dueDate);
      if (days < 0) return { bg: 'bg-slate-600', text: 'text-slate-300', label: 'Submitted' };
      if (days < 3) return { bg: 'bg-red-500/20', text: 'text-red-400', border: 'border-red-500/50' };
      if (days <= 7) return { bg: 'bg-amber-500/20', text: 'text-amber-400', border: 'border-amber-500/50' };
      return { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/50' };
    };

    // Priority badge colors
    const getPriorityColor = (priority) => {
      switch (priority) {
        case 'P-0': return 'bg-red-500/20 text-red-400 border-red-500/50';
        case 'P-1': return 'bg-amber-500/20 text-amber-400 border-amber-500/50';
        case 'P-2': return 'bg-slate-600/50 text-slate-300 border-slate-500/50';
        default: return 'bg-slate-700 text-slate-400';
      }
    };

    // Opportunity Card Component
    const OpportunityCard = ({ opportunity, onMoveNext, phaseIndex }) => {
      const dueColors = getDueDateColor(opportunity.dueDate);
      const days = getDaysUntil(opportunity.dueDate);
      const isLastPhase = phaseIndex === SHIPLEY_PHASES.length - 1;

      return (
        <div className="bg-slate-800/70 border border-slate-700/50 rounded-xl p-3 mb-3 hover:border-cyan-500/30 transition-all group">
          {/* Header with drag handle */}
          <div className="flex items-start justify-between mb-2">
            <div className="flex items-center gap-2">
              <div className="drag-handle p-1 rounded hover:bg-slate-700/50 text-slate-500 hover:text-slate-300">
                <Icon name="grip" className="w-3.5 h-3.5" />
              </div>
              <span className={`px-2 py-0.5 rounded text-xs font-semibold border ${getPriorityColor(opportunity.priority)}`}>
                {opportunity.priority}
              </span>
            </div>
            <span className="text-emerald-400 font-bold text-sm">{opportunity.value}</span>
          </div>

          {/* Opportunity Name */}
          <h4 className="text-white font-semibold text-sm mb-2 line-clamp-2">{opportunity.name}</h4>

          {/* Win Probability */}
          <div className="mb-2">
            <div className="flex items-center justify-between text-xs mb-1">
              <span className="text-slate-400">Win Probability</span>
              <span className={`font-semibold ${opportunity.winProb >= 70 ? 'text-emerald-400' : opportunity.winProb >= 50 ? 'text-amber-400' : 'text-red-400'}`}>
                {opportunity.winProb}%
              </span>
            </div>
            <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
              <div 
                className={`h-full rounded-full transition-all ${opportunity.winProb >= 70 ? 'bg-emerald-500' : opportunity.winProb >= 50 ? 'bg-amber-500' : 'bg-red-500'}`}
                style={{ width: `${opportunity.winProb}%` }}
              />
            </div>
          </div>

          {/* Due Date */}
          <div className={`flex items-center gap-2 px-2 py-1.5 rounded-lg ${dueColors.bg} ${dueColors.border ? `border ${dueColors.border}` : ''} mb-2`}>
            <Icon name="clock" className={`w-3.5 h-3.5 ${dueColors.text}`} />
            <span className={`text-xs font-medium ${dueColors.text}`}>
              {days < 0 ? 'Submitted' : days === 0 ? 'Due Today!' : days === 1 ? 'Due Tomorrow' : `${days} days left`}
            </span>
          </div>

          {/* Team & Owner */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-1">
              {opportunity.team.slice(0, 3).map((role, i) => (
                <span key={i} className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs text-slate-300 font-medium border border-slate-600">
                  {role.charAt(0)}
                </span>
              ))}
              {opportunity.team.length > 3 && (
                <span className="text-xs text-slate-500">+{opportunity.team.length - 3}</span>
              )}
            </div>
            <span className="text-xs text-slate-500">{opportunity.owner.split(' ')[0]}</span>
          </div>

          {/* Move to Next Phase Button */}
          {!isLastPhase && (
            <button
              onClick={() => onMoveNext(opportunity.id)}
              className="w-full mt-3 py-1.5 px-3 bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 rounded-lg text-cyan-400 text-xs font-semibold flex items-center justify-center gap-1.5 opacity-0 group-hover:opacity-100 transition-all"
            >
              <span>Move to Next Phase</span>
              <Icon name="arrowRight" className="w-3.5 h-3.5" />
            </button>
          )}
        </div>
      );
    };

    // Phase Column Component
    const PhaseColumn = ({ phase, opportunities, onMoveNext, phaseIndex }) => {
      const phaseOpps = opportunities.filter(o => o.phase === phase.id);
      const totalValue = phaseOpps.reduce((sum, o) => {
        const numValue = parseFloat(o.value.replace(/[$M]/g, ''));
        return sum + numValue;
      }, 0);

      // Calculate phase progress based on average win probability
      const avgWinProb = phaseOpps.length > 0 
        ? Math.round(phaseOpps.reduce((sum, o) => sum + o.winProb, 0) / phaseOpps.length)
        : 0;

      return (
        <div className="flex-shrink-0 w-64 flex flex-col">
          {/* Column Header */}
          <div 
            className="rounded-t-xl p-3 border-b-2"
            style={{ 
              backgroundColor: `${phase.color}15`,
              borderColor: phase.color 
            }}
          >
            <div className="flex items-center justify-between mb-1">
              <div className="flex items-center gap-2">
                <span 
                  className="w-7 h-7 rounded-lg flex items-center justify-center text-xs font-bold"
                  style={{ backgroundColor: phase.color, color: phase.color === '#F8FAFC' ? '#0f172a' : '#fff' }}
                >
                  {phase.shortName}
                </span>
                <div>
                  <h3 className="font-semibold text-white text-sm">{phase.name}</h3>
                  <p className="text-xs text-slate-500">{phase.description}</p>
                </div>
              </div>
              <span className="text-lg font-bold text-white">{phaseOpps.length}</span>
            </div>

            {/* Progress indicator */}
            <div className="mt-2">
              <div className="flex items-center justify-between text-xs mb-1">
                <span className="text-slate-400">Phase Progress</span>
                <span style={{ color: phase.color }}>{avgWinProb}%</span>
              </div>
              <div className="h-1 bg-slate-700/50 rounded-full overflow-hidden">
                <div 
                  className="h-full rounded-full transition-all"
                  style={{ width: `${avgWinProb}%`, backgroundColor: phase.color }}
                />
              </div>
            </div>

            {/* Total pipeline value */}
            {phaseOpps.length > 0 && (
              <div className="mt-2 flex items-center gap-1 text-xs">
                <Icon name="dollar" className="w-3 h-3 text-emerald-400" />
                <span className="text-emerald-400 font-semibold">${totalValue}M</span>
                <span className="text-slate-500">pipeline</span>
              </div>
            )}
          </div>

          {/* Cards Container */}
          <div className="flex-1 bg-slate-900/30 border-x border-slate-700/30 p-2 overflow-y-auto scrollbar-thin min-h-[400px]">
            {phaseOpps.length === 0 ? (
              <div className="h-full flex items-center justify-center">
                <div className="text-center p-4">
                  <div 
                    className="w-10 h-10 rounded-full mx-auto mb-2 flex items-center justify-center opacity-30"
                    style={{ backgroundColor: `${phase.color}30` }}
                  >
                    <Icon name="target" className="w-5 h-5" style={{ color: phase.color }} />
                  </div>
                  <p className="text-xs text-slate-600">No opportunities</p>
                </div>
              </div>
            ) : (
              phaseOpps.map(opp => (
                <OpportunityCard 
                  key={opp.id} 
                  opportunity={opp} 
                  onMoveNext={onMoveNext}
                  phaseIndex={phaseIndex}
                />
              ))
            )}
          </div>

          {/* Column Footer */}
          <div className="bg-slate-800/50 border border-slate-700/30 border-t-0 rounded-b-xl p-2">
            <button className="w-full py-1.5 text-xs text-slate-500 hover:text-cyan-400 hover:bg-slate-700/30 rounded-lg transition-all">
              + Add Opportunity
            </button>
          </div>
        </div>
      );
    };

    // Main Swimlane Board Component
    const ShipleySwimLaneBoard = () => {
      const [opportunities, setOpportunities] = useState(DEMO_OPPORTUNITIES);
      const [filter, setFilter] = useState('all');
      const scrollRef = useRef(null);

      // Move opportunity to next phase
      const handleMoveNext = (oppId) => {
        setOpportunities(prev => prev.map(opp => {
          if (opp.id === oppId) {
            const currentIndex = SHIPLEY_PHASES.findIndex(p => p.id === opp.phase);
            if (currentIndex < SHIPLEY_PHASES.length - 1) {
              return { ...opp, phase: SHIPLEY_PHASES[currentIndex + 1].id };
            }
          }
          return opp;
        }));
      };

      // Filter opportunities
      const filteredOpportunities = filter === 'all' 
        ? opportunities 
        : opportunities.filter(o => o.priority === filter);

      // Stats
      const totalPipeline = opportunities.reduce((sum, o) => {
        const numValue = parseFloat(o.value.replace(/[$M]/g, ''));
        return sum + numValue;
      }, 0);

      const urgentCount = opportunities.filter(o => getDaysUntil(o.dueDate) <= 3 && getDaysUntil(o.dueDate) >= 0).length;

      return (
        <div className="min-h-screen bg-[#00050F]">
          {/* Header */}
          <header className="bg-slate-900/80 border-b border-slate-700/50 px-6 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
                  <Icon name="shield" className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h1 className="text-xl font-bold text-white">Shipley Pipeline Board</h1>
                  <p className="text-sm text-slate-400">8 phases â€¢ {opportunities.length} opportunities â€¢ ${totalPipeline}M total pipeline</p>
                </div>
              </div>

              {/* Quick Stats */}
              <div className="flex items-center gap-4">
                {urgentCount > 0 && (
                  <div className="flex items-center gap-2 px-3 py-1.5 bg-red-500/20 border border-red-500/30 rounded-lg">
                    <Icon name="alert" className="w-4 h-4 text-red-400" />
                    <span className="text-red-400 text-sm font-semibold">{urgentCount} urgent</span>
                  </div>
                )}
                <div className="flex items-center gap-2 bg-slate-800 rounded-lg p-1">
                  {['all', 'P-0', 'P-1', 'P-2'].map(f => (
                    <button
                      key={f}
                      onClick={() => setFilter(f)}
                      className={`px-3 py-1.5 rounded-md text-xs font-semibold transition-all ${
                        filter === f 
                          ? 'bg-cyan-500 text-white' 
                          : 'text-slate-400 hover:text-white hover:bg-slate-700'
                      }`}
                    >
                      {f === 'all' ? 'All' : f}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </header>

          {/* Phase Legend */}
          <div className="bg-slate-800/30 border-b border-slate-700/30 px-6 py-3">
            <div className="flex items-center gap-2 overflow-x-auto scrollbar-thin">
              <span className="text-xs text-slate-500 mr-2">Phases:</span>
              {SHIPLEY_PHASES.map((phase, i) => (
                <React.Fragment key={phase.id}>
                  <div className="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-slate-800/50">
                    <div 
                      className="w-2 h-2 rounded-full"
                      style={{ backgroundColor: phase.color }}
                    />
                    <span className="text-xs text-slate-300 whitespace-nowrap">{phase.name}</span>
                  </div>
                  {i < SHIPLEY_PHASES.length - 1 && (
                    <Icon name="chevronRight" className="w-3 h-3 text-slate-600 flex-shrink-0" />
                  )}
                </React.Fragment>
              ))}
            </div>
          </div>

          {/* Swimlane Board */}
          <div 
            ref={scrollRef}
            className="flex gap-4 p-6 overflow-x-auto scrollbar-thin"
            style={{ minHeight: 'calc(100vh - 160px)' }}
          >
            {SHIPLEY_PHASES.map((phase, index) => (
              <PhaseColumn
                key={phase.id}
                phase={phase}
                opportunities={filteredOpportunities}
                onMoveNext={handleMoveNext}
                phaseIndex={index}
              />
            ))}
          </div>

          {/* Footer */}
          <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 border-t border-slate-700/50 px-6 py-2">
            <div className="flex items-center justify-between">
              <span className="text-xs text-slate-500">MissionPulse â€¢ Shipley Phase Board v12</span>
              <span className="text-xs text-slate-600">AI GENERATED - REQUIRES HUMAN REVIEW</span>
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<ShipleySwimLaneBoard />);
  </script>
  <!-- AI Chat Widget - Capture Agent -->
  <script src="ai-chat-widget.js" data-agent="capture"></script>
</body>
</html>
