<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Past Performance | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-client-v2.1.js"></script>
  <style>
    :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; --card-bg: #0d1f3c; --border-cyan: rgba(0, 229, 250, 0.3); }
    body { background: var(--deep-navy); color: white; font-family: system-ui, -apple-system, sans-serif; }
    .card { background: var(--card-bg); border: 1px solid var(--border-cyan); border-radius: 12px; }
    .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #0099FF 100%); color: #00050F; font-weight: 600; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0, 229, 250, 0.3); }
    .glow-text { text-shadow: 0 0 20px rgba(0, 229, 250, 0.5); }
    .cpars-exceptional { color: #10b981; } .cpars-very-good { color: #22c55e; } .cpars-satisfactory { color: #fbbf24; } .cpars-marginal { color: #f97316; } .cpars-unsatisfactory { color: #ef4444; }
    .relevance-high { background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5); }
    .relevance-medium { background: rgba(251, 191, 36, 0.2); border-color: rgba(251, 191, 36, 0.5); }
    .relevance-low { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="min-h-screen">
  <header class="border-b border-cyan-500/20 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="index.html" class="text-cyan-400 hover:text-cyan-300">← Dashboard</a>
        <div class="h-6 w-px bg-cyan-500/30"></div>
        <h1 class="text-xl font-bold"><span class="text-cyan-400">Past</span> Performance</h1>
      </div>
      <div class="flex items-center gap-4">
        <div id="connectionStatus" class="flex items-center gap-2 text-sm">
          <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
          <span class="text-gray-400">Connecting...</span>
        </div>
        <button onclick="openAddModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">+ Add Reference</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Stats -->
    <div class="grid grid-cols-5 gap-4 mb-8">
      <div class="card p-4">
        <div class="text-gray-400 text-sm">Total References</div>
        <div id="statTotal" class="text-2xl font-bold text-cyan-400 glow-text">0</div>
      </div>
      <div class="card p-4">
        <div class="text-gray-400 text-sm">Exceptional</div>
        <div id="statExceptional" class="text-2xl font-bold cpars-exceptional">0</div>
      </div>
      <div class="card p-4">
        <div class="text-gray-400 text-sm">Very Good</div>
        <div id="statVeryGood" class="text-2xl font-bold cpars-very-good">0</div>
      </div>
      <div class="card p-4">
        <div class="text-gray-400 text-sm">Total Value</div>
        <div id="statValue" class="text-2xl font-bold text-purple-400">$0</div>
      </div>
      <div class="card p-4">
        <div class="text-gray-400 text-sm">Avg Relevance</div>
        <div id="statRelevance" class="text-2xl font-bold text-amber-400">0%</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card p-4 mb-6">
      <div class="flex items-center gap-4">
        <input type="text" id="searchInput" placeholder="Search contracts, agencies..." class="bg-gray-800 border border-cyan-500/30 rounded px-3 py-2 text-sm flex-1">
        <select id="agencyFilter" class="bg-gray-800 border border-cyan-500/30 rounded px-3 py-2 text-sm">
          <option value="">All Agencies</option>
          <option value="VA">VA</option>
          <option value="DHA">DHA</option>
          <option value="CMS">CMS</option>
          <option value="IHS">IHS</option>
          <option value="HHS">HHS</option>
          <option value="DoD">DoD</option>
        </select>
        <select id="cparsFilter" class="bg-gray-800 border border-cyan-500/30 rounded px-3 py-2 text-sm">
          <option value="">All CPARS Ratings</option>
          <option value="exceptional">Exceptional</option>
          <option value="very_good">Very Good</option>
          <option value="satisfactory">Satisfactory</option>
        </select>
        <select id="relevanceFilter" class="bg-gray-800 border border-cyan-500/30 rounded px-3 py-2 text-sm">
          <option value="">All Relevance</option>
          <option value="high">High (80%+)</option>
          <option value="medium">Medium (50-79%)</option>
          <option value="low">Low (&lt;50%)</option>
        </select>
      </div>
    </div>

    <!-- Past Performance List -->
    <div id="ppList" class="space-y-4">
      <div class="text-gray-500 text-center py-12">Loading past performance references...</div>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="ppModal" class="modal">
    <div class="card p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 id="modalTitle" class="text-lg font-semibold">Add Past Performance Reference</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white">✕</button>
      </div>
      <form id="ppForm" class="space-y-4">
        <input type="hidden" id="ppId">
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contract Name *</label>
            <input type="text" id="contractName" required class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contract Number *</label>
            <input type="text" id="contractNumber" required class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="e.g., VA118-16-C-0001">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contracting Agency *</label>
            <input type="text" id="contractingAgency" required class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="e.g., VA, DHA, CMS">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contract Value *</label>
            <input type="number" id="contractValue" required class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="In dollars">
          </div>
        </div>

        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Start Date</label>
            <input type="date" id="startDate" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">End Date</label>
            <input type="date" id="endDate" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Period of Performance</label>
            <input type="text" id="periodOfPerformance" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="e.g., 5 years">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">CPARS Rating</label>
            <select id="cparsRating" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
              <option value="">Not Rated</option>
              <option value="exceptional">Exceptional</option>
              <option value="very_good">Very Good</option>
              <option value="satisfactory">Satisfactory</option>
              <option value="marginal">Marginal</option>
              <option value="unsatisfactory">Unsatisfactory</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Relevance Score (%)</label>
            <input type="number" id="relevanceScore" min="0" max="100" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="0-100">
          </div>
        </div>

        <div>
          <label class="block text-sm text-gray-400 mb-1">Scope Description</label>
          <textarea id="scopeDescription" rows="3" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="Brief description of work performed..."></textarea>
        </div>

        <div>
          <label class="block text-sm text-gray-400 mb-1">Key Accomplishments</label>
          <textarea id="keyAccomplishments" rows="3" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2" placeholder="One accomplishment per line&#10;• Deployed to 12 facilities&#10;• 99.9% uptime achieved&#10;• Zero security incidents"></textarea>
        </div>

        <div class="border-t border-cyan-500/20 pt-4 mt-4">
          <h3 class="text-sm font-semibold text-cyan-400 mb-3">Point of Contact</h3>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-400 mb-1">POC Name</label>
              <input type="text" id="pocName" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">POC Email</label>
              <input type="email" id="pocEmail" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">POC Phone</label>
              <input type="tel" id="pocPhone" class="w-full bg-gray-800 border border-cyan-500/30 rounded px-3 py-2">
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">Cancel</button>
          <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Reference</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="border-t border-cyan-500/20 px-6 py-4 mt-8">
    <div class="max-w-7xl mx-auto flex items-center justify-between text-sm text-gray-500">
      <span>© 2026 Mission Meets Tech | MissionPulse v2.1</span>
      <span class="text-cyan-400/50">AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</span>
    </div>
  </footer>

  <script>
    let references = [];
    let filters = { search: '', agency: '', cpars: '', relevance: '' };

    async function init() {
      MissionPulse.onConnectionChange(status => {
        const dot = document.querySelector('#connectionStatus span:first-child');
        const text = document.querySelector('#connectionStatus span:last-child');
        if (status === 'connected') {
          dot.className = 'w-2 h-2 rounded-full bg-green-500';
          text.textContent = 'Connected';
          text.className = 'text-green-400';
        }
      });

      await loadReferences();
      setupEventListeners();
      MissionPulse.pastPerformance.subscribe(() => loadReferences());
    }

    async function loadReferences() {
      const { data, error } = await MissionPulse.pastPerformance.getAll({ orderBy: 'contract_value', ascending: false });
      if (error) {
        document.getElementById('ppList').innerHTML = '<div class="text-red-400 text-center py-8">Error loading references</div>';
        return;
      }
      references = data || [];
      renderReferences();
      updateStats();
    }

    function renderReferences() {
      let filtered = references;
      
      if (filters.search) {
        const s = filters.search.toLowerCase();
        filtered = filtered.filter(r => 
          r.contractName?.toLowerCase().includes(s) ||
          r.contractNumber?.toLowerCase().includes(s) ||
          r.contractingAgency?.toLowerCase().includes(s) ||
          r.scopeDescription?.toLowerCase().includes(s)
        );
      }
      if (filters.agency) filtered = filtered.filter(r => r.contractingAgency?.includes(filters.agency));
      if (filters.cpars) filtered = filtered.filter(r => r.cparsRating === filters.cpars);
      if (filters.relevance) {
        filtered = filtered.filter(r => {
          const score = r.relevanceScore || 0;
          if (filters.relevance === 'high') return score >= 80;
          if (filters.relevance === 'medium') return score >= 50 && score < 80;
          if (filters.relevance === 'low') return score < 50;
          return true;
        });
      }

      if (filtered.length === 0) {
        document.getElementById('ppList').innerHTML = '<div class="text-gray-500 text-center py-12">No past performance references found. Add your first reference!</div>';
        return;
      }

      document.getElementById('ppList').innerHTML = filtered.map(r => `
        <div class="card p-6 ${getRelevanceClass(r.relevanceScore)}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="font-semibold text-lg">${r.contractName || 'Unnamed Contract'}</h3>
                ${r.cparsRating ? `<span class="text-sm px-2 py-0.5 rounded bg-gray-800 ${getCparsClass(r.cparsRating)}">${formatCpars(r.cparsRating)}</span>` : ''}
                ${r.relevanceScore ? `<span class="text-sm px-2 py-0.5 rounded bg-gray-800">${r.relevanceScore}% Relevance</span>` : ''}
              </div>
              
              <div class="grid grid-cols-4 gap-4 mb-4 text-sm">
                <div>
                  <span class="text-gray-500">Contract #:</span>
                  <span class="ml-1">${r.contractNumber || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-gray-500">Agency:</span>
                  <span class="ml-1">${r.contractingAgency || 'N/A'}</span>
                </div>
                <div>
                  <span class="text-gray-500">Value:</span>
                  <span class="ml-1 text-cyan-400">${MissionPulse.formatCurrency(r.contractValue)}</span>
                </div>
                <div>
                  <span class="text-gray-500">Period:</span>
                  <span class="ml-1">${r.periodOfPerformance || formatDateRange(r.startDate, r.endDate)}</span>
                </div>
              </div>
              
              ${r.scopeDescription ? `<p class="text-sm text-gray-400 mb-3">${r.scopeDescription}</p>` : ''}
              
              ${r.keyAccomplishments ? `
                <div class="mb-3">
                  <span class="text-xs text-cyan-400 uppercase tracking-wide">Key Accomplishments</span>
                  <div class="text-sm text-gray-300 mt-1">${r.keyAccomplishments}</div>
                </div>
              ` : ''}
              
              ${r.pocName ? `
                <div class="text-xs text-gray-500 pt-3 border-t border-gray-700">
                  <span class="text-gray-400">POC:</span> ${r.pocName}
                  ${r.pocEmail ? ` • ${r.pocEmail}` : ''}
                  ${r.pocPhone ? ` • ${r.pocPhone}` : ''}
                </div>
              ` : ''}
            </div>
            
            <div class="flex items-center gap-2 ml-4">
              <button onclick="editReference('${r.id}')" class="text-cyan-400 hover:text-cyan-300 text-sm">Edit</button>
              <button onclick="deleteReference('${r.id}')" class="text-gray-500 hover:text-red-400 text-sm">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = references.length;
      document.getElementById('statExceptional').textContent = references.filter(r => r.cparsRating === 'exceptional').length;
      document.getElementById('statVeryGood').textContent = references.filter(r => r.cparsRating === 'very_good').length;
      document.getElementById('statValue').textContent = MissionPulse.formatCurrency(references.reduce((sum, r) => sum + (r.contractValue || 0), 0));
      const avgRelevance = references.length ? Math.round(references.reduce((sum, r) => sum + (r.relevanceScore || 0), 0) / references.length) : 0;
      document.getElementById('statRelevance').textContent = `${avgRelevance}%`;
    }

    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Past Performance Reference';
      document.getElementById('ppForm').reset();
      document.getElementById('ppId').value = '';
      document.getElementById('ppModal').classList.add('active');
    }

    function editReference(id) {
      const ref = references.find(r => r.id === id);
      if (!ref) return;
      
      document.getElementById('modalTitle').textContent = 'Edit Past Performance Reference';
      document.getElementById('ppId').value = ref.id;
      document.getElementById('contractName').value = ref.contractName || '';
      document.getElementById('contractNumber').value = ref.contractNumber || '';
      document.getElementById('contractingAgency').value = ref.contractingAgency || '';
      document.getElementById('contractValue').value = ref.contractValue || '';
      document.getElementById('startDate').value = ref.startDate?.split('T')[0] || '';
      document.getElementById('endDate').value = ref.endDate?.split('T')[0] || '';
      document.getElementById('periodOfPerformance').value = ref.periodOfPerformance || '';
      document.getElementById('cparsRating').value = ref.cparsRating || '';
      document.getElementById('relevanceScore').value = ref.relevanceScore || '';
      document.getElementById('scopeDescription').value = ref.scopeDescription || '';
      document.getElementById('keyAccomplishments').value = ref.keyAccomplishments || '';
      document.getElementById('pocName').value = ref.pocName || '';
      document.getElementById('pocEmail').value = ref.pocEmail || '';
      document.getElementById('pocPhone').value = ref.pocPhone || '';
      
      document.getElementById('ppModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('ppModal').classList.remove('active');
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const data = {
        contractName: document.getElementById('contractName').value,
        contractNumber: document.getElementById('contractNumber').value,
        contractingAgency: document.getElementById('contractingAgency').value,
        contractValue: parseInt(document.getElementById('contractValue').value) || 0,
        startDate: document.getElementById('startDate').value || null,
        endDate: document.getElementById('endDate').value || null,
        periodOfPerformance: document.getElementById('periodOfPerformance').value || null,
        cparsRating: document.getElementById('cparsRating').value || null,
        relevanceScore: parseInt(document.getElementById('relevanceScore').value) || null,
        scopeDescription: document.getElementById('scopeDescription').value || null,
        keyAccomplishments: document.getElementById('keyAccomplishments').value || null,
        pocName: document.getElementById('pocName').value || null,
        pocEmail: document.getElementById('pocEmail').value || null,
        pocPhone: document.getElementById('pocPhone').value || null,
      };

      const ppId = document.getElementById('ppId').value;
      const result = ppId 
        ? await MissionPulse.pastPerformance.update(ppId, data)
        : await MissionPulse.pastPerformance.create(data);

      if (result.error) alert('Error saving reference');
      else {
        closeModal();
        await loadReferences();
      }
    }

    async function deleteReference(id) {
      if (!confirm('Delete this past performance reference?')) return;
      await MissionPulse.pastPerformance.delete(id);
      await loadReferences();
    }

    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', e => { filters.search = e.target.value; renderReferences(); });
      document.getElementById('agencyFilter').addEventListener('change', e => { filters.agency = e.target.value; renderReferences(); });
      document.getElementById('cparsFilter').addEventListener('change', e => { filters.cpars = e.target.value; renderReferences(); });
      document.getElementById('relevanceFilter').addEventListener('change', e => { filters.relevance = e.target.value; renderReferences(); });
      document.getElementById('ppForm').addEventListener('submit', handleFormSubmit);
    }

    function formatCpars(rating) {
      return { exceptional: 'Exceptional', very_good: 'Very Good', satisfactory: 'Satisfactory', marginal: 'Marginal', unsatisfactory: 'Unsatisfactory' }[rating] || rating;
    }

    function getCparsClass(rating) {
      return { exceptional: 'cpars-exceptional', very_good: 'cpars-very-good', satisfactory: 'cpars-satisfactory', marginal: 'cpars-marginal', unsatisfactory: 'cpars-unsatisfactory' }[rating] || '';
    }

    function getRelevanceClass(score) {
      if (!score) return '';
      if (score >= 80) return 'relevance-high';
      if (score >= 50) return 'relevance-medium';
      return 'relevance-low';
    }

    function formatDateRange(start, end) {
      if (!start && !end) return 'N/A';
      const s = start ? new Date(start).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : '';
      const e = end ? new Date(end).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'Present';
      return `${s} - ${e}`;
    }

    init();
  </script>
</body>
</html>
