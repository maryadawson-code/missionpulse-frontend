<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Knowledge Base | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-navy': '#00050F',
            'cyber-cyan': '#00E5FA',
            'slate-dark': '#0a1628'
          }
        }
      }
    }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .drag-active { border-color: #00E5FA; background: rgba(0, 229, 250, 0.1); }
    .doc-card:hover { border-color: rgba(0, 229, 250, 0.3); }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="min-h-screen text-white">
  <header class="border-b border-slate-800/50 bg-deep-navy/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyber-cyan to-blue-500 flex items-center justify-center">
          <svg class="w-6 h-6 text-deep-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div>
          <span class="text-lg font-bold text-white">Company Knowledge Base</span>
          <span class="text-xs text-slate-500 block">Train AI with your company data</span>
        </div>
      </div>
      <a href="index.html" class="text-sm text-slate-400 hover:text-cyber-cyan transition-colors">‚Üê Dashboard</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <!-- Auth Check -->
    <div id="authCheck" class="text-center py-12">
      <div class="w-8 h-8 border-2 border-cyber-cyan border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p class="text-slate-400 mt-4">Loading...</p>
    </div>

    <!-- Access Denied -->
    <div id="accessDenied" class="hidden text-center py-12">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-red-400 mb-2">Access Denied</h2>
      <p class="text-slate-400">CEO, COO, or Admin role required.</p>
      <a href="index.html" class="inline-block mt-4 text-cyber-cyan hover:underline">Return to Dashboard</a>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4">
          <p class="text-2xl font-bold text-white" id="statDocuments">0</p>
          <p class="text-xs text-slate-500">Documents</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4">
          <p class="text-2xl font-bold text-cyber-cyan" id="statChunks">0</p>
          <p class="text-xs text-slate-500">Knowledge Chunks</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4">
          <p class="text-2xl font-bold text-emerald-400" id="statCategories">0</p>
          <p class="text-xs text-slate-500">Categories</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-4">
          <p class="text-2xl font-bold text-amber-400" id="statProcessing">0</p>
          <p class="text-xs text-slate-500">Processing</p>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Left Column: Upload & Categories -->
        <div class="space-y-6">
          <!-- Upload Zone -->
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5">
            <h2 class="font-semibold mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-cyber-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload Documents
            </h2>
            <div id="uploadZone" class="border-2 border-dashed border-slate-700 rounded-xl p-8 text-center cursor-pointer hover:border-slate-600 transition-colors">
              <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-slate-800 flex items-center justify-center">
                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
              </div>
              <p class="text-sm font-medium mb-1">Drop files here</p>
              <p class="text-xs text-slate-500">PDF, DOCX, TXT, MD</p>
              <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.md,.doc" multiple class="hidden">
            </div>

            <!-- Category Select -->
            <div class="mt-4">
              <label class="text-xs text-slate-500 block mb-1">Category</label>
              <select id="uploadCategory" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white focus:outline-none focus:border-cyber-cyan">
                <option value="general">General</option>
                <option value="past_performance">Past Performance</option>
                <option value="technical">Technical Approaches</option>
                <option value="management">Management Plans</option>
                <option value="pricing">Pricing Templates</option>
                <option value="contracts">Contract Vehicles</option>
                <option value="capabilities">Capabilities</option>
                <option value="resumes">Key Personnel</option>
              </select>
            </div>
          </div>

          <!-- Categories Filter -->
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5">
            <h2 class="font-semibold mb-4">Categories</h2>
            <div id="categoryList" class="space-y-2"></div>
          </div>

          <!-- Search Knowledge -->
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5">
            <h2 class="font-semibold mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-cyber-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              Search Knowledge
            </h2>
            <div class="relative">
              <input type="text" id="searchInput" placeholder="Search documents..." class="w-full px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyber-cyan">
              <button onclick="searchKnowledge()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyber-cyan">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </button>
            </div>
            <div id="searchResults" class="mt-4 space-y-2 hidden"></div>
          </div>
        </div>

        <!-- Right Column: Document List -->
        <div class="lg:col-span-2">
          <div class="bg-slate-900/60 border border-slate-700/50 rounded-xl p-5">
            <div class="flex items-center justify-between mb-4">
              <h2 class="font-semibold">Documents</h2>
              <div class="flex items-center gap-2">
                <select id="sortBy" onchange="loadDocuments()" class="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-lg text-xs text-white">
                  <option value="created_at">Newest</option>
                  <option value="title">Name</option>
                  <option value="category">Category</option>
                </select>
              </div>
            </div>

            <!-- Upload Progress -->
            <div id="uploadProgress" class="hidden mb-4 p-4 bg-slate-800/50 rounded-lg">
              <div class="flex items-center gap-3 mb-2">
                <div class="w-6 h-6 border-2 border-cyber-cyan border-t-transparent rounded-full animate-spin"></div>
                <span id="uploadFileName" class="text-sm">Uploading...</span>
              </div>
              <div class="w-full bg-slate-700 rounded-full h-1.5">
                <div id="uploadBar" class="bg-cyber-cyan h-1.5 rounded-full transition-all" style="width: 0%"></div>
              </div>
            </div>

            <!-- Document Grid -->
            <div id="documentGrid" class="space-y-3">
              <p class="text-slate-500 text-sm text-center py-8">No documents yet. Upload your first document to get started.</p>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden flex items-center justify-between mt-4 pt-4 border-t border-slate-700">
              <button onclick="prevPage()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors">‚Üê Previous</button>
              <span id="pageInfo" class="text-sm text-slate-400">Page 1 of 1</span>
              <button onclick="nextPage()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors">Next ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="mt-8 bg-slate-900/60 border border-slate-700/50 rounded-xl p-6">
        <h2 class="font-semibold mb-4">How Knowledge Base Works</h2>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-cyber-cyan/20 flex items-center justify-center">
              <span class="text-lg font-bold text-cyber-cyan">1</span>
            </div>
            <p class="text-sm font-medium">Upload Documents</p>
            <p class="text-xs text-slate-500 mt-1">Past proposals, capability statements, technical docs</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-cyber-cyan/20 flex items-center justify-center">
              <span class="text-lg font-bold text-cyber-cyan">2</span>
            </div>
            <p class="text-sm font-medium">AI Processes</p>
            <p class="text-xs text-slate-500 mt-1">Text extracted, chunked, and indexed for search</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-cyber-cyan/20 flex items-center justify-center">
              <span class="text-lg font-bold text-cyber-cyan">3</span>
            </div>
            <p class="text-sm font-medium">Agents Learn</p>
            <p class="text-xs text-slate-500 mt-1">AI agents access your company knowledge</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-cyber-cyan/20 flex items-center justify-center">
              <span class="text-lg font-bold text-cyber-cyan">4</span>
            </div>
            <p class="text-sm font-medium">Better Proposals</p>
            <p class="text-xs text-slate-500 mt-1">Responses tailored to your company's voice</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Document Detail Modal -->
    <div id="docModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
        <div class="flex items-start justify-between mb-4">
          <div>
            <span id="docModalCategory" class="text-xs text-cyber-cyan uppercase tracking-wide"></span>
            <h3 id="docModalTitle" class="text-lg font-bold mt-1"></h3>
          </div>
          <button onclick="closeDocModal()" class="text-slate-400 hover:text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-slate-800/50 rounded-lg p-3">
            <p class="text-xs text-slate-500">File Type</p>
            <p id="docModalType" class="text-sm font-medium"></p>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-3">
            <p class="text-xs text-slate-500">File Size</p>
            <p id="docModalSize" class="text-sm font-medium"></p>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Chunks</p>
            <p id="docModalChunks" class="text-sm font-medium"></p>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-3">
            <p class="text-xs text-slate-500">Uploaded</p>
            <p id="docModalDate" class="text-sm font-medium"></p>
          </div>
        </div>

        <div id="docModalDescription" class="mb-4 text-sm text-slate-400"></div>

        <!-- Chunks Preview -->
        <div class="mb-4">
          <h4 class="text-sm font-medium mb-2">Knowledge Chunks Preview</h4>
          <div id="docModalChunkList" class="space-y-2 max-h-48 overflow-y-auto"></div>
        </div>

        <div class="flex gap-3">
          <button onclick="reprocessDocument()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Reprocess
          </button>
          <button onclick="deleteDocument()" class="flex-1 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-slate-800/50 mt-12">
    <div class="max-w-6xl mx-auto px-6 py-4 text-center text-slate-500 text-xs">AI GENERATED - REQUIRES HUMAN REVIEW</div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1NjcyNTAsImV4cCI6MjA1MzE0MzI1MH0.GRTFxRV7WV67P9sYaIVRwKxVEDALfkWjmUxs4ADB1zs';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let documents = [];
    let currentPage = 1;
    let totalPages = 1;
    let selectedCategory = 'all';
    let currentDocId = null;

    const CATEGORIES = {
      general: { name: 'General', icon: 'üìÅ', color: 'slate' },
      past_performance: { name: 'Past Performance', icon: 'üèÜ', color: 'amber' },
      technical: { name: 'Technical Approaches', icon: '‚öôÔ∏è', color: 'blue' },
      management: { name: 'Management Plans', icon: 'üìã', color: 'purple' },
      pricing: { name: 'Pricing Templates', icon: 'üí∞', color: 'emerald' },
      contracts: { name: 'Contract Vehicles', icon: 'üìú', color: 'orange' },
      capabilities: { name: 'Capabilities', icon: 'üí™', color: 'cyan' },
      resumes: { name: 'Key Personnel', icon: 'üë§', color: 'pink' }
    };

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { window.location.href = 'login.html'; return; }
      
      const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
      
      if (!profile || !['CEO', 'COO', 'Admin'].includes(profile.role)) {
        document.getElementById('authCheck').classList.add('hidden');
        document.getElementById('accessDenied').classList.remove('hidden');
        return;
      }
      
      currentUser = { ...session.user, ...profile };
      document.getElementById('authCheck').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      
      loadDocuments();
      loadStats();
      renderCategories();
    }

    async function loadStats() {
      const { data: docs } = await supabase
        .from('knowledge_documents')
        .select('id, category, status, chunk_count')
        .eq('company_id', currentUser.company_id);

      if (docs) {
        document.getElementById('statDocuments').textContent = docs.length;
        document.getElementById('statChunks').textContent = docs.reduce((sum, d) => sum + (d.chunk_count || 0), 0);
        document.getElementById('statCategories').textContent = [...new Set(docs.map(d => d.category))].length;
        document.getElementById('statProcessing').textContent = docs.filter(d => d.status === 'processing').length;
      }
    }

    function renderCategories() {
      const container = document.getElementById('categoryList');
      container.innerHTML = `
        <button onclick="filterCategory('all')" class="category-btn w-full px-3 py-2 rounded-lg text-sm text-left flex items-center gap-2 transition-colors ${selectedCategory === 'all' ? 'bg-cyber-cyan/20 text-cyber-cyan' : 'hover:bg-slate-800 text-slate-400'}">
          <span>üìö</span> All Documents
        </button>
      ` + Object.entries(CATEGORIES).map(([key, cat]) => `
        <button onclick="filterCategory('${key}')" class="category-btn w-full px-3 py-2 rounded-lg text-sm text-left flex items-center gap-2 transition-colors ${selectedCategory === key ? 'bg-cyber-cyan/20 text-cyber-cyan' : 'hover:bg-slate-800 text-slate-400'}">
          <span>${cat.icon}</span> ${cat.name}
        </button>
      `).join('');
    }

    function filterCategory(category) {
      selectedCategory = category;
      currentPage = 1;
      renderCategories();
      loadDocuments();
    }

    async function loadDocuments() {
      const sortBy = document.getElementById('sortBy').value;
      let query = supabase
        .from('knowledge_documents')
        .select('*')
        .eq('company_id', currentUser.company_id)
        .order(sortBy, { ascending: sortBy === 'title' });

      if (selectedCategory !== 'all') {
        query = query.eq('category', selectedCategory);
      }

      const { data, error } = await query;
      
      if (error) { console.error(error); return; }
      documents = data || [];

      renderDocuments();
    }

    function renderDocuments() {
      const container = document.getElementById('documentGrid');
      
      if (documents.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-sm text-center py-8">No documents found.</p>';
        return;
      }

      container.innerHTML = documents.map(doc => {
        const cat = CATEGORIES[doc.category] || CATEGORIES.general;
        const statusColor = doc.status === 'ready' ? 'emerald' : doc.status === 'processing' ? 'amber' : 'red';
        
        return `
          <div class="doc-card bg-slate-800/50 border border-slate-700/50 rounded-xl p-4 cursor-pointer transition-all hover:border-cyber-cyan/30" onclick="openDocument('${doc.id}')">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-lg bg-${cat.color}-500/20 flex items-center justify-center text-lg">
                ${cat.icon}
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${doc.title}</p>
                <p class="text-xs text-slate-500 mt-0.5">${doc.file_name || 'Unknown file'} ‚Ä¢ ${formatFileSize(doc.file_size)}</p>
              </div>
              <div class="flex flex-col items-end gap-1">
                <span class="text-xs px-2 py-0.5 rounded bg-${statusColor}-500/20 text-${statusColor}-400">${doc.status}</span>
                <span class="text-xs text-slate-500">${doc.chunk_count || 0} chunks</span>
              </div>
            </div>
            ${doc.description ? `<p class="text-xs text-slate-400 mt-2 line-clamp-2">${doc.description}</p>` : ''}
          </div>
        `;
      }).join('');
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 KB';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // File Upload
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-active'); });
    uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('drag-active'); });
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-active');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
      for (const file of files) {
        await uploadFile(file);
      }
      loadDocuments();
      loadStats();
    }

    async function uploadFile(file) {
      const category = document.getElementById('uploadCategory').value;
      
      document.getElementById('uploadProgress').classList.remove('hidden');
      document.getElementById('uploadFileName').textContent = `Uploading ${file.name}...`;
      document.getElementById('uploadBar').style.width = '20%';

      try {
        // Upload to storage
        const filePath = `${currentUser.company_id}/${Date.now()}_${file.name}`;
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('knowledge-documents')
          .upload(filePath, file);

        if (uploadError) throw uploadError;
        document.getElementById('uploadBar').style.width = '50%';

        // Create document record
        const { data: doc, error: docError } = await supabase.from('knowledge_documents').insert({
          company_id: currentUser.company_id,
          title: file.name.replace(/\.[^/.]+$/, ''),
          file_name: file.name,
          file_type: file.type || file.name.split('.').pop(),
          file_size: file.size,
          file_path: filePath,
          category: category,
          status: 'processing',
          uploaded_by: currentUser.id
        }).select().single();

        if (docError) throw docError;
        document.getElementById('uploadBar').style.width = '70%';

        // Extract text and create chunks (simplified - real implementation would use backend)
        await processDocument(doc, file);

        document.getElementById('uploadBar').style.width = '100%';
        document.getElementById('uploadFileName').textContent = `‚úì ${file.name} uploaded`;
        
        setTimeout(() => {
          document.getElementById('uploadProgress').classList.add('hidden');
          document.getElementById('uploadBar').style.width = '0%';
        }, 1500);

      } catch (err) {
        console.error('Upload error:', err);
        document.getElementById('uploadFileName').textContent = `‚úó Failed to upload ${file.name}`;
        setTimeout(() => document.getElementById('uploadProgress').classList.add('hidden'), 2000);
      }

      fileInput.value = '';
    }

    async function processDocument(doc, file) {
      // Read file content
      let text = '';
      
      if (file.type === 'text/plain' || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
        text = await file.text();
      } else {
        // For PDF/DOCX, we'd need backend processing
        // Simulating with placeholder
        text = `[Document: ${file.name}]\n\nThis document contains company knowledge that will be processed by the backend service. The full text extraction requires server-side processing for PDF and DOCX files.\n\nFile size: ${formatFileSize(file.size)}\nCategory: ${doc.category}`;
      }

      // Create chunks (simple splitting by paragraphs)
      const chunks = text.split(/\n\n+/).filter(c => c.trim().length > 50);
      
      for (let i = 0; i < chunks.length; i++) {
        await supabase.from('knowledge_chunks').insert({
          document_id: doc.id,
          company_id: currentUser.company_id,
          content: chunks[i].trim(),
          chunk_index: i,
          token_count: Math.ceil(chunks[i].length / 4), // rough estimate
          metadata: { source: doc.file_name, category: doc.category }
        });
      }

      // Update document status
      await supabase.from('knowledge_documents')
        .update({ 
          status: 'ready', 
          chunk_count: chunks.length,
          processed_at: new Date().toISOString()
        })
        .eq('id', doc.id);
    }

    async function openDocument(docId) {
      currentDocId = docId;
      const doc = documents.find(d => d.id === docId);
      if (!doc) return;

      const cat = CATEGORIES[doc.category] || CATEGORIES.general;
      document.getElementById('docModalCategory').textContent = cat.name;
      document.getElementById('docModalTitle').textContent = doc.title;
      document.getElementById('docModalType').textContent = doc.file_type?.toUpperCase() || 'Unknown';
      document.getElementById('docModalSize').textContent = formatFileSize(doc.file_size);
      document.getElementById('docModalChunks').textContent = doc.chunk_count || 0;
      document.getElementById('docModalDate').textContent = new Date(doc.created_at).toLocaleDateString();
      document.getElementById('docModalDescription').textContent = doc.description || 'No description';

      // Load chunks
      const { data: chunks } = await supabase
        .from('knowledge_chunks')
        .select('*')
        .eq('document_id', docId)
        .order('chunk_index')
        .limit(5);

      const chunkList = document.getElementById('docModalChunkList');
      if (chunks && chunks.length > 0) {
        chunkList.innerHTML = chunks.map((chunk, i) => `
          <div class="p-3 bg-slate-800/50 rounded-lg">
            <p class="text-xs text-slate-500 mb-1">Chunk ${chunk.chunk_index + 1}</p>
            <p class="text-sm text-slate-300 line-clamp-3">${chunk.content}</p>
          </div>
        `).join('');
      } else {
        chunkList.innerHTML = '<p class="text-slate-500 text-sm">No chunks found</p>';
      }

      document.getElementById('docModal').classList.remove('hidden');
    }

    function closeDocModal() {
      document.getElementById('docModal').classList.add('hidden');
      currentDocId = null;
    }

    async function deleteDocument() {
      if (!currentDocId) return;
      if (!confirm('Delete this document and all its knowledge chunks?')) return;

      await supabase.from('knowledge_chunks').delete().eq('document_id', currentDocId);
      await supabase.from('knowledge_documents').delete().eq('id', currentDocId);
      
      closeDocModal();
      loadDocuments();
      loadStats();
    }

    async function reprocessDocument() {
      if (!currentDocId) return;
      alert('Reprocessing would be handled by backend service. Document queued for reprocessing.');
      
      await supabase.from('knowledge_documents')
        .update({ status: 'processing' })
        .eq('id', currentDocId);
      
      closeDocModal();
      loadDocuments();
    }

    async function searchKnowledge() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const { data: results } = await supabase
        .from('knowledge_chunks')
        .select('*, knowledge_documents(title, category)')
        .eq('company_id', currentUser.company_id)
        .textSearch('fts', query)
        .limit(10);

      const container = document.getElementById('searchResults');
      container.classList.remove('hidden');

      if (!results || results.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-sm">No results found</p>';
        return;
      }

      container.innerHTML = results.map(r => `
        <div class="p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800" onclick="openDocument('${r.document_id}')">
          <p class="text-xs text-cyber-cyan">${r.knowledge_documents?.title || 'Unknown'}</p>
          <p class="text-sm text-slate-300 line-clamp-2 mt-1">${r.content}</p>
        </div>
      `).join('');
    }

    document.getElementById('searchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchKnowledge();
    });

    checkAuth();
  </script>
</body>
</html>
