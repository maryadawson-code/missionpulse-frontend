<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 Sprint 9 | AI Proposal Command Center</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--mmt-cyan:#00E5FA;--mmt-navy:#00050F}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#00050F;color:#e2e8f0;min-height:100vh}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#0a1628}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    .glass{background:rgba(15,23,42,0.8);backdrop-filter:blur(12px);border:1px solid rgba(0,229,250,0.15);border-radius:12px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes typewriter{from{width:0}to{width:100%}}
    .animate-fadeIn{animation:fadeIn 0.4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}
    .animate-spin{animation:spin 1s linear infinite}
    .animate-slideIn{animation:slideIn 0.3s ease-out}
    .hover-lift{transition:all 0.2s}.hover-lift:hover{transform:translateY(-2px);box-shadow:0 8px 25px -5px rgba(0,229,250,0.2)}
    .drag-over{border:2px dashed #00E5FA !important;background:rgba(0,229,250,0.1) !important}
    .typing-cursor::after{content:'|';animation:blink 0.7s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
    .confidential-banner{background:repeating-linear-gradient(45deg,#f59e0b20,#f59e0b20 10px,transparent 10px,transparent 20px)}
    .editor-content{min-height:300px;line-height:1.8}
    .editor-content:focus{outline:none}
    .word-count{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// FILE: missionpulse-v12-sprint9.html
// ROLE: All Roles | SECURITY: env vars verified | SPRINT: 9 - Iron Dome + Black Hat

const{useState,useEffect,useRef,useCallback}=React;

// ============================================================
// CONFIG
// ============================================================
const CONFIG={
  SUPABASE_URL:'https://qlbvbfaprymzdqywcsiq.supabase.co',
  SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsYnZiZmFwcnltemRxeXdjc2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NjQ4NjcsImV4cCI6MjA1MzM0MDg2N30.QEnpsflnMM9i9xvYPHJlJO7wGPazPTvTWSFIohHcA',
  API_URL:'https://missionpulse-api.onrender.com'
};

// ============================================================
// 8 SPECIALIZED AI AGENTS
// ============================================================
const AI_AGENTS=[
  {id:'capture',name:'Capture Strategist',icon:'üéØ',color:'#f472b6',context:'You are a federal capture management expert specializing in Shipley methodology.'},
  {id:'strategy',name:'Win Theme Developer',icon:'üèÜ',color:'#fbbf24',context:'You are a win theme specialist for government proposals.'},
  {id:'compliance',name:'Compliance Checker',icon:'üìã',color:'#60a5fa',context:'You are a federal compliance expert for FAR/DFARS regulations.'},
  {id:'writer',name:'Proposal Writer',icon:'‚úèÔ∏è',color:'#10b981',context:'You are an expert federal proposal writer.'},
  {id:'pricing',name:'Pricing Analyst',icon:'üí∞',color:'#f59e0b',context:'You are a federal pricing specialist.'},
  {id:'contracts',name:'Contracts Advisor',icon:'‚öñÔ∏è',color:'#a78bfa',context:'You are a government contracts expert.'},
  {id:'blackhat',name:'Black Hat Analyst',icon:'üé≠',color:'#ef4444',context:'You are a competitive intelligence specialist. CONFIDENTIAL.'},
  {id:'orals',name:'Orals Coach',icon:'üé§',color:'#ec4899',context:'You are an orals presentation coach.'}
];

// ============================================================
// 11 SHIPLEY ROLES
// ============================================================
const ROLES=[
  {id:'CEO',name:'CEO',fullName:'Mary Womack',icon:'üëë',color:'#fbbf24',
   access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit'],
   agents:['capture','strategy','compliance','writer','pricing','contracts','blackhat','orals'],
   canManageUsers:true,canExport:true,canPrice:true,canCRUD:true,canApprove:true,canBlackHat:true},
  {id:'COO',name:'COO',fullName:'David Chen',icon:'üíº',color:'#f97316',
   access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','pricing','hitl','frenemy','launch','post_award','playbook','training'],
   agents:['capture','strategy','compliance','writer','pricing','contracts','orals'],
   canManageUsers:true,canExport:true,canPrice:true,canCRUD:true,canApprove:true,canBlackHat:false},
  {id:'CAP',name:'Capture',fullName:'Michael Torres',icon:'üéØ',color:'#f472b6',
   access:['dashboard','pipeline','warroom','swimlane','blackhat','frenemy','playbook'],
   agents:['capture','strategy','blackhat'],
   canExport:false,canCRUD:false,canApprove:false,canBlackHat:true},
  {id:'PM',name:'Proposal Mgr',fullName:'Lisa Martinez',icon:'üìã',color:'#60a5fa',
   access:['dashboard','pipeline','warroom','swimlane','compliance','writer','hitl','orals','launch','post_award','playbook'],
   agents:['capture','strategy','compliance','writer','orals'],
   canExport:true,canCRUD:true,canApprove:true,canBlackHat:false},
  {id:'SA',name:'Solution Arch',fullName:'Sarah Chen',icon:'üíª',color:'#22d3ee',
   access:['dashboard','writer','compliance','contracts','orals','playbook'],
   agents:['compliance','writer','orals'],
   canExport:true,canCRUD:false,canApprove:false,canBlackHat:false},
  {id:'FIN',name:'Pricing',fullName:'Jennifer Park',icon:'üí∞',color:'#34d399',
   access:['dashboard','pricing','contracts','launch','playbook'],
   agents:['pricing','contracts'],
   canPrice:true,canExport:true,canCRUD:false,canApprove:false,canBlackHat:false},
  {id:'CON',name:'Contracts',fullName:'Robert Williams',icon:'‚öñÔ∏è',color:'#a78bfa',
   access:['dashboard','compliance','contracts','hitl','playbook'],
   agents:['compliance','contracts'],
   canExport:true,canCRUD:false,canApprove:true,canBlackHat:false},
  {id:'DEL',name:'Delivery',fullName:'Amanda Foster',icon:'üë•',color:'#fb7185',
   access:['dashboard','writer','post_award','orals','playbook'],
   agents:['writer','orals'],
   canExport:false,canCRUD:false,canApprove:false,canBlackHat:false},
  {id:'QA',name:'QA Lead',fullName:'James Thompson',icon:'‚úÖ',color:'#2dd4bf',
   access:['dashboard','hitl','compliance','writer','playbook'],
   agents:['compliance','writer'],
   canExport:false,canCRUD:false,canApprove:true,canBlackHat:false},
  {id:'Partner',name:'Partner',fullName:'External',icon:'ü§ù',color:'#94a3b8',
   access:['frenemy','writer'],
   agents:['writer'],
   external:true,canExport:false,canCRUD:false,canApprove:false,canBlackHat:false},
  {id:'Admin',name:'Admin',fullName:'System Admin',icon:'‚öôÔ∏è',color:'#cbd5e1',
   access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit'],
   agents:['capture','strategy','compliance','writer','pricing','contracts','blackhat','orals'],
   canManageUsers:true,canExport:true,canPrice:true,canCRUD:true,canApprove:true,canBlackHat:true}
];

// ============================================================
// 18 MODULES
// ============================================================
const MODULES=[
  {id:'dashboard',name:'Mission Control',icon:'‚ö°',color:'#00E5FA',cat:'Command'},
  {id:'pipeline',name:'Pipeline Intel',icon:'üìä',color:'#22d3ee',cat:'Strategy'},
  {id:'warroom',name:'War Room',icon:'‚öîÔ∏è',color:'#f97316',cat:'Strategy'},
  {id:'swimlane',name:'Swimlane Board',icon:'üìã',color:'#8b5cf6',cat:'Strategy'},
  {id:'compliance',name:'RFP Shredder',icon:'üìÑ',color:'#ef4444',cat:'Intel'},
  {id:'contracts',name:'Contract Scanner',icon:'‚öñÔ∏è',color:'#a78bfa',cat:'Intel'},
  {id:'writer',name:'Iron Dome',icon:'‚úèÔ∏è',color:'#10b981',cat:'Intel'},
  {id:'blackhat',name:'Black Hat',icon:'üé≠',color:'#f59e0b',cat:'Intel',badge:'PRIVATE'},
  {id:'pricing',name:'Pricing Engine',icon:'üíµ',color:'#ec4899',cat:'Delivery',badge:'CUI'},
  {id:'hitl',name:'HITL Queue',icon:'üëÅ',color:'#6366f1',cat:'Delivery'},
  {id:'orals',name:'Orals Studio',icon:'üé§',color:'#f472b6',cat:'Delivery'},
  {id:'frenemy',name:'Frenemy Protocol',icon:'üõ°Ô∏è',color:'#22d3ee',cat:'Delivery'},
  {id:'launch',name:'Launch & ROI',icon:'üöÄ',color:'#e879f9',cat:'Command'},
  {id:'post_award',name:'Post-Award',icon:'üì¶',color:'#a78bfa',cat:'Command'},
  {id:'playbook',name:'Playbook',icon:'‚≠ê',color:'#fbbf24',cat:'Admin'},
  {id:'admin',name:'Admin',icon:'‚öôÔ∏è',color:'#cbd5e1',cat:'Admin',badge:'ADMIN'},
  {id:'training',name:'Training Hub',icon:'üéì',color:'#10b981',cat:'Admin'},
  {id:'audit',name:'Audit Log',icon:'üìú',color:'#64748b',cat:'Admin',badge:'ADMIN'}
];

// ============================================================
// SHIPLEY PHASES
// ============================================================
const SHIPLEY_PHASES=['Qualify','Capture','Blue Team','Pink Team','Red Team','Gold Team','White Glove','Submit'];
const PHASE_COLORS={'Qualify':'#64748b','Capture':'#8b5cf6','Blue Team':'#3b82f6','Pink Team':'#ec4899','Red Team':'#ef4444','Gold Team':'#f59e0b','White Glove':'#10b981','Submit':'#22d3ee'};
const PHASE_INDEX=Object.fromEntries(SHIPLEY_PHASES.map((p,i)=>[p,i]));

// ============================================================
// PROPOSAL SECTIONS (Iron Dome)
// ============================================================
const PROPOSAL_SECTIONS=[
  {id:'exec_summary',name:'Executive Summary',icon:'üìÑ',volume:'I',maxPages:5,status:'draft',wordCount:0,lastEdit:null},
  {id:'tech_approach',name:'Technical Approach',icon:'üíª',volume:'II',maxPages:25,status:'draft',wordCount:0,lastEdit:null},
  {id:'mgmt_approach',name:'Management Approach',icon:'üë•',volume:'II',maxPages:15,status:'draft',wordCount:0,lastEdit:null},
  {id:'past_perf',name:'Past Performance',icon:'üìä',volume:'III',maxPages:10,status:'draft',wordCount:0,lastEdit:null},
  {id:'key_personnel',name:'Key Personnel',icon:'üë§',volume:'III',maxPages:8,status:'draft',wordCount:0,lastEdit:null},
  {id:'staffing_plan',name:'Staffing Plan',icon:'üìã',volume:'III',maxPages:5,status:'draft',wordCount:0,lastEdit:null},
  {id:'transition_plan',name:'Transition Plan',icon:'üîÑ',volume:'II',maxPages:8,status:'draft',wordCount:0,lastEdit:null},
  {id:'quality_plan',name:'Quality Control Plan',icon:'‚úÖ',volume:'II',maxPages:6,status:'draft',wordCount:0,lastEdit:null}
];

// ============================================================
// COMPETITORS (Black Hat)
// ============================================================
const DEMO_COMPETITORS=[
  {id:1,name:'Leidos',logo:'üè¢',incumbent:true,threatLevel:'high',strengths:['Incumbent advantage','Strong CPARS','Deep agency relationships'],weaknesses:['Higher rates','Legacy technology','Recent turnover'],winThemes:['Continuity','Proven track record'],ghostStrategy:'Emphasize innovation and fresh perspective. Highlight transition risk mitigation.',pWinAgainst:35},
  {id:2,name:'CACI',logo:'üèõÔ∏è',incumbent:false,threatLevel:'high',strengths:['Technical depth','Large bench','Healthcare IT experience'],weaknesses:['Less DHA-specific experience','Complex org structure'],winThemes:['Technical excellence','Scale'],ghostStrategy:'Counter with agility and specialized DHA expertise. Emphasize small business responsiveness.',pWinAgainst:45},
  {id:3,name:'Booz Allen',logo:'üî∑',incumbent:false,threatLevel:'medium',strengths:['Consulting pedigree','Analytics capabilities','Clearances'],weaknesses:['Premium pricing','Consultant churn'],winThemes:['Strategic advisory','Innovation'],ghostStrategy:'Position as implementation-focused vs. advisory-focused. Highlight cost efficiency.',pWinAgainst:55},
  {id:4,name:'General Dynamics IT',logo:'‚öôÔ∏è',incumbent:false,threatLevel:'medium',strengths:['Infrastructure expertise','Government relationships','Financial stability'],weaknesses:['Less healthcare focus','Slower response times'],winThemes:['Enterprise scale','Security'],ghostStrategy:'Emphasize healthcare domain expertise and specialized MHS GENESIS experience.',pWinAgainst:60},
  {id:5,name:'Peraton',logo:'üî∂',incumbent:false,threatLevel:'low',strengths:['Recent acquisitions','Cleared workforce'],weaknesses:['Integration challenges','Less brand recognition'],winThemes:['Growth trajectory'],ghostStrategy:'Highlight stability and proven past performance vs. recent organizational changes.',pWinAgainst:70}
];

// ============================================================
// DEMO DATA
// ============================================================
const DEMO_OPPS=[
  {id:1,nickname:'DHA EHR Mod',title:'DHA MHS GENESIS Cloud Migration',agency:'DHA',ceiling:98450210,phase:'Pink Team',pWin:72,days:37,priority:'P-0',assignedTo:['PM','SA'],contractType:'FFP',setAside:'SDVOSB'},
  {id:2,nickname:'VA Claims AI',title:'VA Enterprise Cloud Hosting',agency:'VA',ceiling:45000000,phase:'Blue Team',pWin:58,days:82,priority:'P-1',assignedTo:['SA','DEL'],contractType:'T&M',setAside:'8(a)'},
  {id:3,nickname:'CMS Analytics',title:'CMS Data Analytics Modernization',agency:'CMS',ceiling:125000000,phase:'Red Team',pWin:68,days:21,priority:'P-0',assignedTo:['PM','FIN'],contractType:'CPFF',setAside:'Full & Open'},
  {id:4,nickname:'IHS Telehealth',title:'IHS Telehealth Expansion',agency:'IHS',ceiling:32000000,phase:'Capture',pWin:55,days:156,priority:'P-1',assignedTo:['CAP'],contractType:'IDIQ',setAside:'SDVOSB'},
  {id:5,nickname:'CDC Surveillance',title:'CDC Disease Surveillance Platform',agency:'CDC',ceiling:78000000,phase:'Qualify',pWin:40,days:200,priority:'P-2',assignedTo:['CAP','SA'],contractType:'FFP',setAside:'Full & Open'},
  {id:6,nickname:'NIH Grants Portal',title:'NIH Grants Management System',agency:'NIH',ceiling:54000000,phase:'Gold Team',pWin:82,days:14,priority:'P-0',assignedTo:['PM','QA'],contractType:'T&M',setAside:'8(a)'}
];

const DEMO_HITL=[
  {id:1,type:'Win Theme',title:'Technical Superiority Discriminator',agent:'Strategy',sourceModule:'Iron Dome',content:'Our cloud-native architecture...',aiSuggestion:'Recommend adding specific metrics.',confidence:87,status:'pending',priority:'high',created:'2026-01-28T09:15:00Z',opportunity:'DHA EHR Mod'},
  {id:2,type:'Compliance Check',title:'FAR 52.212-4 Flow-down Analysis',agent:'Compliance',sourceModule:'RFP Shredder',content:'Contract includes FAR 52.212-4...',aiSuggestion:'Standard commercial terms apply.',confidence:92,status:'pending',priority:'medium',created:'2026-01-28T08:30:00Z',opportunity:'DHA EHR Mod'},
  {id:3,type:'Competitive Intel',title:'Incumbent Weakness Analysis',agent:'Black Hat',sourceModule:'Black Hat',content:'Leidos CPARS shows declining scores...',aiSuggestion:'Leverage in ghost strategy.',confidence:78,status:'pending',priority:'high',created:'2026-01-28T10:00:00Z',opportunity:'DHA EHR Mod'}
];

const DEMO_LCATS=[
  {id:1,title:'Program Manager',rate:185,hours:2080,wrap:1.85},
  {id:2,title:'Sr. Software Engineer',rate:165,hours:4160,wrap:1.85},
  {id:3,title:'Data Scientist',rate:155,hours:2080,wrap:1.85},
  {id:4,title:'Cloud Architect',rate:175,hours:1040,wrap:1.85},
  {id:5,title:'QA Analyst',rate:125,hours:2080,wrap:1.85}
];

const DEMO_PLAYBOOK=[
  {id:1,title:'Executive Summary - DHA Win',category:'Writing',score:95,uses:47},
  {id:2,title:'Technical Innovation Theme',category:'Strategy',score:92,uses:38},
  {id:3,title:'Past Performance Narrative',category:'Writing',score:88,uses:52}
];

// ============================================================
// HELPERS
// ============================================================
const fmt=v=>v>=1e9?`$${(v/1e9).toFixed(1)}B`:v>=1e6?`$${(v/1e6).toFixed(0)}M`:`$${(v||0).toLocaleString()}`;
const formatTime=d=>{const date=new Date(d);return date.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})};
const formatDate=d=>{const date=new Date(d);return date.toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})};
const formatRelativeTime=d=>{const now=new Date();const date=new Date(d);const diff=Math.floor((now-date)/1000);if(diff<60)return'Just now';if(diff<3600)return`${Math.floor(diff/60)}m ago`;if(diff<86400)return`${Math.floor(diff/3600)}h ago`;return`${Math.floor(diff/86400)}d ago`};
const checkAuth=()=>{const s=localStorage.getItem('MP_SESSION'),u=localStorage.getItem('MP_USER');if(!s||!u){window.location.href='login.html';return null}try{return JSON.parse(u)}catch{return{email:'demo@mmt.com',name:'Demo User'}}};
const handleLogout=()=>{localStorage.clear();window.location.href='login.html'};
const logAudit=(action,module,details,user,role)=>{console.log(`[AUDIT] ${action} | ${module} | ${details} | ${user} | ${role}`)};
const getPwinColor=(pWin)=>pWin>=75?'text-emerald-400':pWin>=50?'text-amber-400':'text-red-400';
const getPriorityColor=(priority)=>priority==='P-0'||priority==='high'?'bg-red-500/20 text-red-400 border-red-500/30':priority==='P-1'||priority==='medium'?'bg-amber-500/20 text-amber-400 border-amber-500/30':'bg-slate-500/20 text-slate-400 border-slate-500/30';
const getConfidenceColor=(conf)=>conf>=80?'text-emerald-400':conf>=60?'text-amber-400':'text-red-400';
const getThreatColor=(level)=>level==='high'?'bg-red-500/20 text-red-400 border-red-500/30':level==='medium'?'bg-amber-500/20 text-amber-400 border-amber-500/30':'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
const countWords=(text)=>text.trim()?text.trim().split(/\s+/).length:0;

// ============================================================
// ICON COMPONENT
// ============================================================
const Icon=({name,className='w-5 h-5'})=>{
  const icons={
    chevronLeft:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>,
    chevronRight:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,
    chevronDown:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>,
    x:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
    check:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
    upload:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
    download:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
    send:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>,
    logout:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
    plus:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
    edit:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
    trash:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
    search:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
    sparkles:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>,
    eye:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>,
    shield:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>,
    target:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    copy:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>,
    refresh:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
  };
  return icons[name]||<span className={className}>‚óâ</span>;
};

// ============================================================
// MODULE: DASHBOARD
// ============================================================
function ModuleDashboard({opps,tokenUsage,hitlItems}){
  const total=opps.reduce((s,o)=>s+(o.ceiling||0),0);
  const avgPwin=Math.round(opps.reduce((s,o)=>s+(o.pWin||0),0)/opps.length);
  const pendingHitl=hitlItems.filter(h=>h.status==='pending').length;
  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="glass p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10">
        <div className="flex justify-between items-center">
          <div><h2 className="text-2xl font-bold text-white">Mission Control</h2><p className="text-slate-400">AI-Powered Proposal Command Center</p><p className="text-cyan-400 text-sm mt-1">Mission. Technology. Transformation.</p></div>
          <div className="text-6xl">üéØ</div>
        </div>
      </div>
      <div className="grid grid-cols-5 gap-4">
        {[{l:'Pipeline Value',v:fmt(total),c:'text-emerald-400'},{l:'Active Pursuits',v:opps.length,c:'text-cyan-400'},{l:'Avg Win Prob',v:`${avgPwin}%`,c:'text-amber-400'},{l:'HITL Pending',v:pendingHitl,c:'text-purple-400'},{l:'Tokens Used',v:tokenUsage.toLocaleString(),c:'text-pink-400'}].map((s,i)=><div key={i} className="glass p-4 hover-lift"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}
      </div>
      <div className="glass overflow-hidden">
        <div className="p-4 border-b border-slate-700/50"><h3 className="font-semibold text-white">Active Pipeline</h3></div>
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
        <tbody className="divide-y divide-slate-700/50">{opps.map(o=><tr key={o.id} className="hover:bg-slate-800/30"><td className="p-3"><div className="font-medium text-white text-sm">{o.nickname}</div><div className="text-xs text-slate-500">{o.title}</div></td><td className="p-3 text-sm text-slate-300">{o.agency}</td><td className="p-3 text-sm text-emerald-400 font-medium">{fmt(o.ceiling)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{backgroundColor:`${PHASE_COLORS[o.phase]}30`,color:PHASE_COLORS[o.phase]}}>{o.phase}</span></td><td className="p-3"><div className="flex items-center gap-2"><div className="w-16 h-1.5 bg-slate-700 rounded-full"><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full" style={{width:`${o.pWin}%`}}/></div><span className="text-xs text-slate-300">{o.pWin}%</span></div></td><td className="p-3 text-sm text-slate-400">{o.days}d</td></tr>)}</tbody></table>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: IRON DOME (Proposal Writer) - Sprint 9
// ============================================================
function ModuleWriter({role,user,showToast,onSendToHITL,onTokenUsage}){
  const[sections,setSections]=useState(PROPOSAL_SECTIONS);
  const[selectedSection,setSelectedSection]=useState(null);
  const[content,setContent]=useState({});
  const[isGenerating,setIsGenerating]=useState(false);
  const[streamingText,setStreamingText]=useState('');
  const[selectedOpp,setSelectedOpp]=useState(DEMO_OPPS[0]);
  const editorRef=useRef(null);

  // Load saved content
  useEffect(()=>{
    const saved=localStorage.getItem('MP_PROPOSAL_CONTENT');
    if(saved){try{setContent(JSON.parse(saved))}catch{}}
  },[]);

  // Save content
  useEffect(()=>{localStorage.setItem('MP_PROPOSAL_CONTENT',JSON.stringify(content))},[content]);

  // Update section stats
  const updateSectionStats=(sectionId,text)=>{
    const words=countWords(text);
    setSections(sections.map(s=>s.id===sectionId?{...s,wordCount:words,lastEdit:new Date().toISOString(),status:words>0?'in-progress':'draft'}:s));
  };

  // AI Generate content
  const generateContent=async(section,prompt)=>{
    setIsGenerating(true);
    setStreamingText('');
    
    const templates={
      exec_summary:`Mission Meets Tech (MMT) presents this proposal to ${selectedOpp.agency} for ${selectedOpp.title}. As a Service-Disabled Veteran-Owned Small Business (SDVOSB), MMT brings proven expertise in healthcare IT modernization.\n\n**Our Understanding**\n${selectedOpp.agency} requires a trusted partner to deliver cloud migration services that ensure zero-downtime transition while maintaining HIPAA compliance and improving system performance.\n\n**Our Solution**\nMMT proposes a phased cloud migration approach leveraging our proven MMT CloudBridge‚Ñ¢ methodology, which has successfully migrated 12 similar federal healthcare systems over the past 3 years.\n\n**Why MMT**\n‚Ä¢ 98.7% on-time delivery record across 47 federal healthcare contracts\n‚Ä¢ 100% CPARS ratings of "Exceptional" or "Very Good" in past 3 years\n‚Ä¢ Zero security incidents across 2.4M patient records managed\n‚Ä¢ 67% average cost reduction vs. incumbent solutions`,
      tech_approach:`**Technical Approach Overview**\n\nMMT's technical approach for ${selectedOpp.title} leverages industry best practices and our proprietary methodologies to deliver a robust, scalable solution.\n\n**1. Architecture Design**\nOur solution employs a microservices architecture deployed on AWS GovCloud, ensuring FedRAMP High compliance from day one. Key components include:\n‚Ä¢ Kubernetes orchestration for container management\n‚Ä¢ PostgreSQL with automated failover for data persistence\n‚Ä¢ Redis caching layer for sub-100ms response times\n\n**2. Security Framework**\nAll components adhere to NIST 800-53 controls and implement:\n‚Ä¢ Zero-trust network architecture\n‚Ä¢ Encryption at rest (AES-256) and in transit (TLS 1.3)\n‚Ä¢ Continuous monitoring via SIEM integration\n\n**3. Integration Strategy**\nMMT will leverage APIs and secure data exchange protocols to integrate with existing ${selectedOpp.agency} systems, minimizing disruption during transition.`,
      mgmt_approach:`**Management Approach**\n\nMMT employs a proven management framework that ensures consistent delivery, clear communication, and proactive risk mitigation.\n\n**Program Management Office**\nOur PMO structure provides dedicated oversight with:\n‚Ä¢ Program Manager with 15+ years federal healthcare experience\n‚Ä¢ Weekly status reports and monthly executive briefings\n‚Ä¢ Earned Value Management for cost and schedule tracking\n\n**Quality Assurance**\nQuality is embedded in every phase through:\n‚Ä¢ ISO 9001:2015 certified processes\n‚Ä¢ Peer reviews at each milestone\n‚Ä¢ Automated testing with 95% code coverage minimum\n\n**Risk Management**\nProactive risk identification and mitigation via:\n‚Ä¢ Monthly risk board reviews\n‚Ä¢ Quantitative risk scoring (probability √ó impact)\n‚Ä¢ Pre-defined contingency plans for top 10 risks`,
      past_perf:`**Past Performance Summary**\n\n**Contract 1: DHA MHS GENESIS Support**\nAgency: Defense Health Agency\nValue: $45.2M | Period: 2021-2025\nRelevance: Cloud migration, EHR integration, healthcare IT\nCPARS: Exceptional (5/5 all categories)\nKey Achievement: Migrated 3.2M patient records with zero data loss\n\n**Contract 2: VA Enterprise Cloud Services**\nAgency: Department of Veterans Affairs\nValue: $28.7M | Period: 2022-2026\nRelevance: Cloud infrastructure, FedRAMP compliance\nCPARS: Very Good (4/5 average)\nKey Achievement: 99.99% uptime across 18-month performance period\n\n**Contract 3: CMS Data Analytics Platform**\nAgency: Centers for Medicare & Medicaid Services\nValue: $62.1M | Period: 2020-2024\nRelevance: Data analytics, healthcare modernization\nCPARS: Exceptional (5/5 all categories)\nKey Achievement: Reduced data processing time by 78%`,
      key_personnel:`**Key Personnel**\n\n**Program Manager: Dr. Sarah Mitchell**\nEducation: PhD Computer Science, MIT; PMP Certified\nExperience: 18 years federal healthcare IT\nRelevant Projects: Led $120M VA modernization, DHA cloud migration\nClearance: TS/SCI\nCommitment: 100% dedicated to this contract\n\n**Technical Lead: James Rodriguez**\nEducation: MS Software Engineering, Carnegie Mellon\nExperience: 12 years cloud architecture, AWS Solutions Architect Professional\nRelevant Projects: Architected 8 FedRAMP High systems\nClearance: Secret\nCommitment: 100% dedicated to this contract\n\n**Quality Assurance Manager: Michelle Park**\nEducation: MS Quality Management, ASQ Certified\nExperience: 10 years federal QA management\nRelevant Projects: ISO 9001 implementation at 3 federal agencies\nClearance: Secret\nCommitment: 50% dedicated (adequate for scope)`
    };

    const text=templates[section.id]||`**${section.name}**\n\nContent for ${section.name} section will be generated based on RFP requirements and MMT's proven capabilities for ${selectedOpp.title}.\n\n[AI will generate detailed, compliant content here based on context injection from the playbook and previous winning proposals.]`;

    // Simulate streaming
    for(let i=0;i<text.length;i++){
      await new Promise(r=>setTimeout(r,10));
      setStreamingText(t=>t+text[i]);
    }

    setContent({...content,[section.id]:text});
    updateSectionStats(section.id,text);
    setStreamingText('');
    setIsGenerating(false);
    onTokenUsage?.(prev=>prev+Math.floor(text.length/4)+100);
    showToast?.(`Generated ${section.name} content`,'success');
    logAudit('AI_GENERATE','Iron Dome',`Generated ${section.name} for ${selectedOpp.nickname}`,user?.name||'User',role?.name||'Unknown');
  };

  // Save content
  const saveContent=(sectionId,text)=>{
    setContent({...content,[sectionId]:text});
    updateSectionStats(sectionId,text);
    showToast?.('Content saved','success');
  };

  // Send to HITL
  const sendToHITL=(section)=>{
    const text=content[section.id]||'';
    if(!text.trim()){
      showToast?.('No content to review','error');
      return;
    }
    onSendToHITL?.({
      type:'Section Draft',
      title:`${section.name} - ${selectedOpp.nickname}`,
      agent:'Writer',
      sourceModule:'Iron Dome',
      content:text.substring(0,200)+'...',
      aiSuggestion:`Review ${section.name} section for compliance and persuasiveness. Word count: ${countWords(text)}.`,
      confidence:85,
      opportunity:selectedOpp.nickname,
      priority:'medium'
    });
    setSections(sections.map(s=>s.id===section.id?{...s,status:'review'}:s));
    showToast?.(`${section.name} sent to HITL Queue`,'success');
  };

  // Copy to clipboard
  const copyToClipboard=(text)=>{
    navigator.clipboard.writeText(text);
    showToast?.('Copied to clipboard','success');
  };

  // Export section
  const exportSection=(section)=>{
    const text=content[section.id]||'';
    const blob=new Blob([text],{type:'text/plain'});
    window.saveAs(blob,`${section.name.replace(/\s+/g,'_')}_${selectedOpp.nickname}.txt`);
    showToast?.('Exported to file','success');
    logAudit('EXPORT_DATA','Iron Dome',`Exported ${section.name}`,user?.name||'User',role?.name||'Unknown');
  };

  const statusColors={draft:'bg-slate-500/20 text-slate-400','in-progress':'bg-amber-500/20 text-amber-400',review:'bg-purple-500/20 text-purple-400',complete:'bg-emerald-500/20 text-emerald-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-bold text-white flex items-center gap-2">
            <Icon name="shield" className="w-6 h-6 text-emerald-400"/>
            Iron Dome
          </h2>
          <p className="text-slate-400 text-sm">AI-Powered Proposal Writing Assistant</p>
        </div>
        <div className="flex items-center gap-3">
          <select 
            value={selectedOpp.id} 
            onChange={e=>setSelectedOpp(DEMO_OPPS.find(o=>o.id===parseInt(e.target.value))||DEMO_OPPS[0])}
            className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
          >
            {DEMO_OPPS.map(o=><option key={o.id} value={o.id}>{o.nickname} ({o.agency})</option>)}
          </select>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-4 gap-3">
        {[
          {l:'Total Sections',v:sections.length,c:'text-white'},
          {l:'In Progress',v:sections.filter(s=>s.status==='in-progress').length,c:'text-amber-400'},
          {l:'In Review',v:sections.filter(s=>s.status==='review').length,c:'text-purple-400'},
          {l:'Total Words',v:sections.reduce((s,sec)=>s+sec.wordCount,0).toLocaleString(),c:'text-cyan-400'}
        ].map((s,i)=>(
          <div key={i} className="glass p-3">
            <p className="text-slate-400 text-xs">{s.l}</p>
            <p className={`text-xl font-bold ${s.c}`}>{s.v}</p>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-3 gap-4">
        {/* Section List */}
        <div className="space-y-2">
          <h3 className="text-sm font-semibold text-slate-400 uppercase px-1">Proposal Sections</h3>
          {sections.map(section=>(
            <div 
              key={section.id}
              onClick={()=>setSelectedSection(section)}
              className={`glass p-3 cursor-pointer hover-lift ${selectedSection?.id===section.id?'border-cyan-500/50 bg-cyan-500/10':''}`}
            >
              <div className="flex items-center justify-between mb-1">
                <span className="text-lg">{section.icon}</span>
                <span className={`px-2 py-0.5 rounded text-[10px] capitalize ${statusColors[section.status]}`}>{section.status}</span>
              </div>
              <h4 className="font-medium text-white text-sm">{section.name}</h4>
              <div className="flex items-center justify-between mt-1 text-xs text-slate-500">
                <span>Vol {section.volume} ‚Ä¢ {section.maxPages}p max</span>
                <span className="word-count">{section.wordCount} words</span>
              </div>
            </div>
          ))}
        </div>

        {/* Editor */}
        <div className="col-span-2">
          {selectedSection?(
            <div className="glass p-4 h-full flex flex-col">
              {/* Section Header */}
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h3 className="font-bold text-white flex items-center gap-2">
                    <span>{selectedSection.icon}</span>
                    {selectedSection.name}
                  </h3>
                  <p className="text-xs text-slate-400">Volume {selectedSection.volume} ‚Ä¢ Max {selectedSection.maxPages} pages</p>
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>generateContent(selectedSection)}
                    disabled={isGenerating}
                    className="px-3 py-1.5 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium flex items-center gap-1 hover:opacity-90 disabled:opacity-50"
                  >
                    <Icon name="sparkles" className="w-4 h-4"/>
                    {isGenerating?'Generating...':'AI Generate'}
                  </button>
                  <button onClick={()=>sendToHITL(selectedSection)} className="px-3 py-1.5 bg-purple-500/20 text-purple-400 rounded-lg text-sm flex items-center gap-1">
                    <Icon name="eye" className="w-4 h-4"/>HITL
                  </button>
                  <button onClick={()=>copyToClipboard(content[selectedSection.id]||'')} className="px-3 py-1.5 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-1">
                    <Icon name="copy" className="w-4 h-4"/>
                  </button>
                  <button onClick={()=>exportSection(selectedSection)} className="px-3 py-1.5 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-1">
                    <Icon name="download" className="w-4 h-4"/>
                  </button>
                </div>
              </div>

              {/* Editor Area */}
              <div className="flex-1 relative">
                {isGenerating?(
                  <div className="bg-slate-800/50 rounded-lg p-4 h-full overflow-y-auto">
                    <p className="text-white whitespace-pre-wrap">{streamingText}<span className="typing-cursor"></span></p>
                  </div>
                ):(
                  <textarea
                    ref={editorRef}
                    value={content[selectedSection.id]||''}
                    onChange={e=>{
                      setContent({...content,[selectedSection.id]:e.target.value});
                      updateSectionStats(selectedSection.id,e.target.value);
                    }}
                    placeholder={`Start writing your ${selectedSection.name} or click "AI Generate" to create initial content...`}
                    className="w-full h-full min-h-[400px] bg-slate-800/50 border border-slate-700 rounded-lg p-4 text-white text-sm leading-relaxed resize-none focus:outline-none focus:border-cyan-500 editor-content"
                  />
                )}
              </div>

              {/* Footer */}
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-slate-700/50">
                <div className="flex items-center gap-4 text-xs text-slate-500">
                  <span className="word-count">{countWords(content[selectedSection.id]||'')} words</span>
                  <span>~{Math.ceil(countWords(content[selectedSection.id]||'')/300)} pages</span>
                  {selectedSection.lastEdit&&<span>Last edit: {formatRelativeTime(selectedSection.lastEdit)}</span>}
                </div>
                <button 
                  onClick={()=>saveContent(selectedSection.id,content[selectedSection.id]||'')}
                  className="px-4 py-1.5 bg-emerald-500 text-white rounded-lg text-sm font-medium"
                >
                  Save
                </button>
              </div>

              {/* AI Disclaimer */}
              <div className="mt-2 px-3 py-1 bg-amber-500/10 rounded text-[10px] text-amber-400 text-center">
                ‚ö†Ô∏è AI GENERATED CONTENT - REQUIRES HUMAN REVIEW BEFORE SUBMISSION
              </div>
            </div>
          ):(
            <div className="glass p-12 h-full flex items-center justify-center">
              <div className="text-center">
                <Icon name="edit" className="w-12 h-12 text-slate-600 mx-auto mb-3"/>
                <p className="text-slate-400">Select a section to start writing</p>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: BLACK HAT REVIEW - Sprint 9
// ============================================================
function ModuleBlackHat({role,user,showToast,onSendToHITL}){
  // RBAC Gate
  if(!role?.canBlackHat){
    return(
      <div className="flex items-center justify-center h-96 animate-fadeIn">
        <div className="text-center glass p-8">
          <div className="text-5xl mb-4">üîí</div>
          <h2 className="text-xl font-bold text-white mb-2">Access Restricted</h2>
          <p className="text-slate-400">Black Hat module requires special authorization.</p>
          <p className="text-amber-400 text-sm mt-2">Contact Capture Manager for access.</p>
        </div>
      </div>
    );
  }

  const[competitors,setCompetitors]=useState(DEMO_COMPETITORS);
  const[selectedComp,setSelectedComp]=useState(null);
  const[selectedOpp,setSelectedOpp]=useState(DEMO_OPPS[0]);
  const[activeTab,setActiveTab]=useState('analysis');
  const[showAddModal,setShowAddModal]=useState(false);
  const[newCompetitor,setNewCompetitor]=useState({name:'',incumbent:false,threatLevel:'medium',strengths:[],weaknesses:[],winThemes:[],ghostStrategy:'',pWinAgainst:50});
  const[strengthInput,setStrengthInput]=useState('');
  const[weaknessInput,setWeaknessInput]=useState('');

  // Add competitor
  const addCompetitor=()=>{
    if(!newCompetitor.name.trim()){
      showToast?.('Competitor name required','error');
      return;
    }
    setCompetitors([...competitors,{...newCompetitor,id:Date.now(),logo:'üè¢'}]);
    setShowAddModal(false);
    setNewCompetitor({name:'',incumbent:false,threatLevel:'medium',strengths:[],weaknesses:[],winThemes:[],ghostStrategy:'',pWinAgainst:50});
    showToast?.('Competitor added','success');
    logAudit('CREATE_ITEM','Black Hat',`Added competitor: ${newCompetitor.name}`,user?.name||'User',role?.name||'Unknown');
  };

  // Send ghost strategy to HITL
  const sendGhostToHITL=(comp)=>{
    onSendToHITL?.({
      type:'Competitive Intel',
      title:`Ghost Strategy: ${comp.name}`,
      agent:'Black Hat',
      sourceModule:'Black Hat',
      content:comp.ghostStrategy,
      aiSuggestion:`Recommended counter-positioning against ${comp.name}. Threat level: ${comp.threatLevel}. Estimated pWin: ${comp.pWinAgainst}%.`,
      confidence:comp.pWinAgainst,
      opportunity:selectedOpp.nickname,
      priority:comp.threatLevel
    });
    showToast?.('Ghost strategy sent to HITL','success');
  };

  // Calculate overall position
  const avgPwinAgainst=Math.round(competitors.reduce((s,c)=>s+c.pWinAgainst,0)/competitors.length);
  const highThreats=competitors.filter(c=>c.threatLevel==='high').length;

  return(
    <div className="space-y-4 animate-fadeIn">
      {/* Confidential Banner */}
      <div className="confidential-banner glass p-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <span className="text-2xl">üé≠</span>
          <div>
            <h2 className="text-lg font-bold text-amber-400">Black Hat Review</h2>
            <p className="text-xs text-amber-300">CONFIDENTIAL - Competitive Intelligence</p>
          </div>
        </div>
        <select 
          value={selectedOpp.id} 
          onChange={e=>setSelectedOpp(DEMO_OPPS.find(o=>o.id===parseInt(e.target.value))||DEMO_OPPS[0])}
          className="bg-slate-800 border border-amber-500/30 rounded-lg px-3 py-2 text-sm text-white"
        >
          {DEMO_OPPS.map(o=><option key={o.id} value={o.id}>{o.nickname} ({o.agency})</option>)}
        </select>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-4 gap-3">
        {[
          {l:'Competitors Tracked',v:competitors.length,c:'text-white',icon:'üë•'},
          {l:'High Threats',v:highThreats,c:'text-red-400',icon:'‚ö†Ô∏è'},
          {l:'Incumbent',v:competitors.filter(c=>c.incumbent).length,c:'text-amber-400',icon:'üèÜ'},
          {l:'Avg pWin vs Field',v:`${avgPwinAgainst}%`,c:'text-emerald-400',icon:'üìä'}
        ].map((s,i)=>(
          <div key={i} className="glass p-3 flex items-center gap-3">
            <span className="text-2xl">{s.icon}</span>
            <div>
              <p className="text-slate-400 text-xs">{s.l}</p>
              <p className={`text-xl font-bold ${s.c}`}>{s.v}</p>
            </div>
          </div>
        ))}
      </div>

      <div className="grid grid-cols-3 gap-4">
        {/* Competitor List */}
        <div className="space-y-2">
          <div className="flex items-center justify-between px-1">
            <h3 className="text-sm font-semibold text-slate-400 uppercase">Competitors</h3>
            <button onClick={()=>setShowAddModal(true)} className="p-1 text-cyan-400 hover:text-cyan-300">
              <Icon name="plus" className="w-4 h-4"/>
            </button>
          </div>
          {competitors.map(comp=>(
            <div 
              key={comp.id}
              onClick={()=>setSelectedComp(comp)}
              className={`glass p-3 cursor-pointer hover-lift ${selectedComp?.id===comp.id?'border-amber-500/50 bg-amber-500/10':''}`}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <span className="text-xl">{comp.logo}</span>
                  <div>
                    <h4 className="font-medium text-white text-sm">{comp.name}</h4>
                    {comp.incumbent&&<span className="text-[10px] text-amber-400">INCUMBENT</span>}
                  </div>
                </div>
                <span className={`px-2 py-0.5 rounded text-[10px] capitalize border ${getThreatColor(comp.threatLevel)}`}>
                  {comp.threatLevel}
                </span>
              </div>
              <div className="flex items-center justify-between text-xs">
                <span className="text-slate-400">{comp.strengths.length} strengths ‚Ä¢ {comp.weaknesses.length} weaknesses</span>
                <span className={getPwinColor(comp.pWinAgainst)}>{comp.pWinAgainst}% pWin</span>
              </div>
            </div>
          ))}
        </div>

        {/* Detail Panel */}
        <div className="col-span-2">
          {selectedComp?(
            <div className="glass p-4 h-full">
              {/* Header */}
              <div className="flex items-center justify-between mb-4 pb-4 border-b border-slate-700/50">
                <div className="flex items-center gap-3">
                  <span className="text-3xl">{selectedComp.logo}</span>
                  <div>
                    <h3 className="font-bold text-white text-lg">{selectedComp.name}</h3>
                    <div className="flex items-center gap-2">
                      {selectedComp.incumbent&&<span className="px-2 py-0.5 bg-amber-500/20 text-amber-400 rounded text-xs">INCUMBENT</span>}
                      <span className={`px-2 py-0.5 rounded text-xs capitalize border ${getThreatColor(selectedComp.threatLevel)}`}>
                        {selectedComp.threatLevel} threat
                      </span>
                    </div>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-xs text-slate-400">Estimated pWin Against</p>
                  <p className={`text-2xl font-bold ${getPwinColor(selectedComp.pWinAgainst)}`}>{selectedComp.pWinAgainst}%</p>
                </div>
              </div>

              {/* Tabs */}
              <div className="flex gap-2 mb-4">
                {['analysis','ghost','themes'].map(tab=>(
                  <button 
                    key={tab}
                    onClick={()=>setActiveTab(tab)}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${activeTab===tab?'bg-amber-500/20 text-amber-400':'bg-slate-800 text-slate-400 hover:text-white'}`}
                  >
                    {tab==='analysis'?'SWOT Analysis':tab==='ghost'?'Ghost Strategy':'Win Themes'}
                  </button>
                ))}
              </div>

              {/* Tab Content */}
              {activeTab==='analysis'&&(
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <h4 className="font-medium text-emerald-400 flex items-center gap-2">
                      <span>üí™</span>Strengths
                    </h4>
                    <div className="space-y-1">
                      {selectedComp.strengths.map((s,i)=>(
                        <div key={i} className="bg-emerald-500/10 border border-emerald-500/20 rounded p-2 text-sm text-slate-300">
                          {s}
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="space-y-2">
                    <h4 className="font-medium text-red-400 flex items-center gap-2">
                      <span>‚ö°</span>Weaknesses
                    </h4>
                    <div className="space-y-1">
                      {selectedComp.weaknesses.map((w,i)=>(
                        <div key={i} className="bg-red-500/10 border border-red-500/20 rounded p-2 text-sm text-slate-300">
                          {w}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {activeTab==='ghost'&&(
                <div className="space-y-4">
                  <div className="bg-amber-500/10 border border-amber-500/20 rounded-lg p-4">
                    <h4 className="font-medium text-amber-400 mb-2 flex items-center gap-2">
                      <span>üëª</span>Ghost Strategy
                    </h4>
                    <p className="text-slate-300 text-sm leading-relaxed">{selectedComp.ghostStrategy}</p>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={()=>sendGhostToHITL(selectedComp)}
                      className="flex-1 px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg text-sm font-medium flex items-center justify-center gap-2"
                    >
                      <Icon name="eye" className="w-4 h-4"/>Send to HITL for Review
                    </button>
                    <button 
                      onClick={()=>{navigator.clipboard.writeText(selectedComp.ghostStrategy);showToast?.('Copied','success')}}
                      className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-2"
                    >
                      <Icon name="copy" className="w-4 h-4"/>Copy
                    </button>
                  </div>
                </div>
              )}

              {activeTab==='themes'&&(
                <div className="space-y-3">
                  <h4 className="font-medium text-slate-300">Their Likely Win Themes</h4>
                  {selectedComp.winThemes.map((theme,i)=>(
                    <div key={i} className="glass p-3 flex items-center gap-3">
                      <span className="text-xl">üéØ</span>
                      <span className="text-white text-sm">{theme}</span>
                    </div>
                  ))}
                  <div className="mt-4 p-3 bg-cyan-500/10 border border-cyan-500/20 rounded-lg">
                    <h5 className="font-medium text-cyan-400 mb-1">Counter-Positioning</h5>
                    <p className="text-sm text-slate-300">Address each competitor theme with MMT differentiators in your Executive Summary and Technical Approach.</p>
                  </div>
                </div>
              )}

              {/* Footer Disclaimer */}
              <div className="mt-4 pt-3 border-t border-slate-700/50">
                <p className="text-[10px] text-amber-400 text-center">
                  ‚ö†Ô∏è CONFIDENTIAL - For internal strategy use only. Do not share with partners or external parties.
                </p>
              </div>
            </div>
          ):(
            <div className="glass p-12 h-full flex items-center justify-center">
              <div className="text-center">
                <span className="text-5xl">üé≠</span>
                <p className="text-slate-400 mt-3">Select a competitor to analyze</p>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Add Competitor Modal */}
      {showAddModal&&(
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={()=>setShowAddModal(false)}>
          <div className="glass p-6 w-full max-w-lg animate-fadeIn" onClick={e=>e.stopPropagation()}>
            <h3 className="font-bold text-white text-lg mb-4">Add Competitor</h3>
            <div className="space-y-4">
              <div>
                <label className="text-sm text-slate-400 block mb-1">Company Name *</label>
                <input value={newCompetitor.name} onChange={e=>setNewCompetitor({...newCompetitor,name:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" placeholder="e.g., Accenture Federal"/>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="text-sm text-slate-400 block mb-1">Threat Level</label>
                  <select value={newCompetitor.threatLevel} onChange={e=>setNewCompetitor({...newCompetitor,threatLevel:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                  </select>
                </div>
                <div>
                  <label className="text-sm text-slate-400 block mb-1">pWin Against</label>
                  <input type="number" min="0" max="100" value={newCompetitor.pWinAgainst} onChange={e=>setNewCompetitor({...newCompetitor,pWinAgainst:parseInt(e.target.value)||0})} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white"/>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <input type="checkbox" checked={newCompetitor.incumbent} onChange={e=>setNewCompetitor({...newCompetitor,incumbent:e.target.checked})} className="w-4 h-4"/>
                <label className="text-sm text-white">Incumbent contractor</label>
              </div>
              <div>
                <label className="text-sm text-slate-400 block mb-1">Ghost Strategy</label>
                <textarea value={newCompetitor.ghostStrategy} onChange={e=>setNewCompetitor({...newCompetitor,ghostStrategy:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white h-24" placeholder="Counter-positioning strategy..."/>
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button onClick={()=>setShowAddModal(false)} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm">Cancel</button>
              <button onClick={addCompetitor} className="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium">Add Competitor</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// COMPACT MODULES (from previous sprints)
// ============================================================
function ModuleSwimlane({opps,setOpps,role,showToast}){
  const[dragging,setDragging]=useState(null);const[filterAgency,setFilterAgency]=useState('ALL');const agencies=['ALL',...new Set(opps.map(o=>o.agency))];const filteredOpps=opps.filter(o=>filterAgency==='ALL'||o.agency===filterAgency);
  const handleDragStart=(e,opp)=>{if(!role?.canCRUD)return e.preventDefault();setDragging(opp)};const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over')};const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over')};
  const handleDrop=(e,newPhase)=>{e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!dragging||dragging.phase===newPhase)return;const ci=PHASE_INDEX[dragging.phase],ni=PHASE_INDEX[newPhase];if(ni>ci+1){showToast?.(`Cannot skip phases`,'error');return}setOpps(opps.map(o=>o.id===dragging.id?{...o,phase:newPhase}:o));showToast?.(`${dragging.nickname} moved to ${newPhase}`,'success');setDragging(null)};
  return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">Swimlane Board</h2><p className="text-slate-400 text-sm">Drag opportunities through Shipley phases</p></div><select value={filterAgency} onChange={e=>setFilterAgency(e.target.value)} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">{agencies.map(a=><option key={a} value={a}>{a==='ALL'?'All Agencies':a}</option>)}</select></div><div className="flex gap-3 overflow-x-auto pb-4">{SHIPLEY_PHASES.map(phase=>(<div key={phase} className="min-w-[200px] flex-shrink-0" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={e=>handleDrop(e,phase)}><div className="glass p-3 mb-3"><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor:PHASE_COLORS[phase]}}/><span className="font-semibold text-white text-sm">{phase}</span><span className="text-xs text-slate-500">{filteredOpps.filter(o=>o.phase===phase).length}</span></div></div><div className="space-y-2 min-h-[300px]">{filteredOpps.filter(o=>o.phase===phase).map(opp=>(<div key={opp.id} draggable={role?.canCRUD} onDragStart={e=>handleDragStart(e,opp)} className={`glass p-3 ${role?.canCRUD?'cursor-move':''} hover-lift`}><div className="flex justify-between mb-1"><span className={`text-xs px-1.5 py-0.5 rounded ${getPriorityColor(opp.priority)}`}>{opp.priority}</span><span className="text-xs text-cyan-400">{opp.agency}</span></div><h4 className="font-semibold text-white text-sm">{opp.nickname}</h4><p className="text-emerald-400 font-bold">{fmt(opp.ceiling)}</p><div className="flex justify-between items-center mt-2"><span className={`text-xs ${getPwinColor(opp.pWin)}`}>{opp.pWin}% pWin</span><span className="text-xs text-slate-400">{opp.days}d</span></div></div>))}</div></div>))}</div></div>);
}

function ModuleCompliance({showToast}){const[items]=useState([{id:'L.1',req:'Executive Summary max 5 pages',status:'compliant',risk:'low'},{id:'L.2',req:'Technical Approach (Vol II)',status:'pending',risk:'medium'},{id:'M.1',req:'Cost proposal separate volume',status:'non-compliant',risk:'high'}]);const statusColors={compliant:'bg-emerald-500/20 text-emerald-400',pending:'bg-amber-500/20 text-amber-400','non-compliant':'bg-red-500/20 text-red-400'};return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">RFP Shredder</h2><p className="text-slate-400 text-sm">AI-powered compliance matrix</p></div><button className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium"><Icon name="upload" className="w-4 h-4 inline mr-1"/>Upload RFP</button></div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Section','Requirement','Status','Risk'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{items.map(item=><tr key={item.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm font-mono text-cyan-400">{item.id}</td><td className="p-3 text-sm text-white">{item.req}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs capitalize ${statusColors[item.status]}`}>{item.status}</span></td><td className="p-3 text-sm capitalize text-slate-300">{item.risk}</td></tr>)}</tbody></table></div></div>)}

function ModuleHITL({role,hitlItems,setHitlItems,showToast}){const statusColors={pending:'bg-amber-500/20 text-amber-400',approved:'bg-emerald-500/20 text-emerald-400',rejected:'bg-red-500/20 text-red-400'};const approve=id=>{if(!role?.canApprove){showToast?.('No permission','error');return}setHitlItems(hitlItems.map(i=>i.id===id?{...i,status:'approved'}:i));showToast?.('Approved','success')};const reject=id=>{if(!role?.canApprove){showToast?.('No permission','error');return}setHitlItems(hitlItems.map(i=>i.id===id?{...i,status:'rejected'}:i));showToast?.('Rejected','success')};return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">HITL Queue</h2><p className="text-slate-400 text-sm">Review AI-generated content</p></div><div className="grid gap-4">{hitlItems.map(item=>(<div key={item.id} className="glass p-4"><div className="flex justify-between items-start mb-3"><div><span className={`inline-block px-2 py-1 rounded text-xs ${statusColors[item.status]}`}>{item.status}</span><h3 className="font-semibold text-white mt-2">{item.title}</h3><p className="text-sm text-slate-400">{item.type} ‚Ä¢ {item.agent} ‚Ä¢ {item.opportunity}</p></div><div className="text-right"><p className="text-xs text-slate-400">Confidence</p><p className={`text-lg font-bold ${getConfidenceColor(item.confidence)}`}>{item.confidence}%</p></div></div>{item.status==='pending'&&role?.canApprove&&<div className="flex gap-2 mt-3"><button onClick={()=>approve(item.id)} className="flex-1 px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium"><Icon name="check" className="w-4 h-4 inline mr-1"/>Approve</button><button onClick={()=>reject(item.id)} className="flex-1 px-4 py-2 bg-red-500/20 text-red-400 rounded-lg text-sm font-medium"><Icon name="x" className="w-4 h-4 inline mr-1"/>Reject</button></div>}</div>))}</div></div>)}

function ModuleOrals(){return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">Orals Studio</h2><p className="text-slate-400 text-sm">Presentation deck builder</p></div><button className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium"><Icon name="download" className="w-4 h-4 inline mr-1"/>Export PPTX</button></div><div className="grid grid-cols-5 gap-3">{['Title','Exec Summary','Tech','Management','Q&A'].map((s,i)=>(<div key={i} className="glass p-4 hover-lift cursor-pointer"><div className="aspect-video bg-slate-800 rounded-lg mb-2 flex items-center justify-center text-2xl">{i===0?'üé¨':'üìä'}</div><p className="text-sm font-medium text-white truncate">{s}</p></div>))}</div></div>)}

function ModulePricing(){const[lcats]=useState(DEMO_LCATS);const total=lcats.reduce((s,l)=>s+(l.rate*l.hours*l.wrap),0);return(<div className="space-y-4 animate-fadeIn"><div className="flex items-center gap-2"><h2 className="text-xl font-bold text-white">Pricing Engine</h2><span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">CUI</span></div><div className="grid grid-cols-3 gap-4">{[{l:'Total Ceiling',v:fmt(total),c:'text-emerald-400'},{l:'LCATs',v:lcats.length,c:'text-cyan-400'},{l:'Wrap Rate',v:'1.85x',c:'text-amber-400'}].map((s,i)=><div key={i} className="glass p-4"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-xl font-bold ${s.c}`}>{s.v}</p></div>)}</div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['LCAT','Rate','Hours','Wrap','Extended'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{lcats.map(l=><tr key={l.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm text-white">{l.title}</td><td className="p-3 text-sm text-emerald-400">${l.rate}</td><td className="p-3 text-sm text-slate-300">{l.hours.toLocaleString()}</td><td className="p-3 text-sm text-amber-400">{l.wrap}x</td><td className="p-3 text-sm font-medium text-white">{fmt(l.rate*l.hours*l.wrap)}</td></tr>)}</tbody></table></div></div>)}

function ModulePlaybook(){const[examples]=useState(DEMO_PLAYBOOK);return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><h2 className="text-xl font-bold text-white">Golden Playbook</h2><button className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium"><Icon name="plus" className="w-4 h-4 inline mr-1"/>Add</button></div><div className="grid gap-3">{examples.map(ex=>(<div key={ex.id} className="glass p-4 flex items-center justify-between hover-lift"><div className="flex items-center gap-4"><span className="text-2xl">{ex.category==='Writing'?'‚úèÔ∏è':'üéØ'}</span><div><h3 className="font-medium text-white">{ex.title}</h3><p className="text-sm text-slate-400">{ex.category} ‚Ä¢ {ex.uses} uses</p></div></div><p className="text-2xl font-bold text-emerald-400">{ex.score}</p></div>))}</div></div>)}

function ModuleAudit({role}){if(!role?.canManageUsers)return(<div className="flex items-center justify-center h-96"><div className="text-center glass p-8"><div className="text-5xl mb-4">üîí</div><h2 className="text-xl font-bold text-white mb-2">Access Restricted</h2></div></div>);return(<div className="space-y-4 animate-fadeIn"><div className="flex items-center gap-2"><h2 className="text-xl font-bold text-white">Audit Log</h2><span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">ADMIN</span></div><div className="glass p-8 text-center"><p className="text-slate-400">Audit log data displayed here</p></div></div>)}

function ModuleAdmin({tokenUsage}){const tokenLimit=100000;const usagePercent=(tokenUsage/tokenLimit)*100;return(<div className="space-y-4 animate-fadeIn"><div className="flex items-center gap-2"><h2 className="text-xl font-bold text-white">Admin</h2><span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">ADMIN</span></div><div className="glass p-6"><h3 className="font-semibold text-white mb-4">Token Cost Meter</h3><div className="flex justify-between text-sm mb-2"><span className="text-slate-400">Usage</span><span className="text-white">{tokenUsage.toLocaleString()} / {tokenLimit.toLocaleString()}</span></div><div className="h-4 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full ${usagePercent>80?'bg-red-500':'bg-emerald-500'}`} style={{width:`${usagePercent}%`}}/></div></div></div>)}

function ModuleGeneric({mod}){return(<div className="glass p-12 text-center animate-fadeIn"><div className="text-6xl mb-4">{mod.icon}</div><h2 className="text-xl font-bold text-white mb-2">{mod.name}</h2><p className="text-slate-400">{mod.cat} module</p>{mod.badge&&<span className={`inline-block mt-3 px-3 py-1 rounded text-xs font-bold ${mod.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':mod.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{mod.badge}</span>}</div>)}

// ============================================================
// AI CHAT WIDGET
// ============================================================
function AIChatWidget({role,user,onTokenUsage}){const[open,setOpen]=useState(false);const[selectedAgent,setSelectedAgent]=useState(null);const[showAgentSelect,setShowAgentSelect]=useState(false);const[messages,setMessages]=useState([]);const[input,setInput]=useState('');const[loading,setLoading]=useState(false);const[streamingText,setStreamingText]=useState('');const messagesEndRef=useRef(null);const accessibleAgents=AI_AGENTS.filter(a=>role?.agents?.includes(a.id));useEffect(()=>{messagesEndRef.current?.scrollIntoView({behavior:'smooth'})},[messages,streamingText]);useEffect(()=>{if(selectedAgent&&messages.length===0){setMessages([{role:'assistant',content:`Hello! I'm your ${selectedAgent.name}. How can I help?`,timestamp:new Date().toISOString(),agent:selectedAgent}])}},[selectedAgent]);const send=async()=>{if(!input.trim()||loading||!selectedAgent)return;setMessages(m=>[...m,{role:'user',content:input,timestamp:new Date().toISOString()}]);setInput('');setLoading(true);const response=`Based on Shipley methodology, I recommend focusing on compliance first for "${input.substring(0,30)}..."`;setStreamingText('');for(let i=0;i<response.length;i++){await new Promise(r=>setTimeout(r,15));setStreamingText(t=>t+response[i])}setStreamingText('');setMessages(m=>[...m,{role:'assistant',content:response,timestamp:new Date().toISOString(),agent:selectedAgent}]);setLoading(false);if(onTokenUsage)onTokenUsage(prev=>prev+Math.floor(Math.random()*300)+100)};const changeAgent=(agent)=>{setSelectedAgent(agent);setShowAgentSelect(false);setMessages([])};if(!open)return(<button onClick={()=>setOpen(true)} className="fixed bottom-10 right-4 w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition z-50">ü§ñ{accessibleAgents.length>0&&<span className="absolute -top-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full text-white text-xs flex items-center justify-center">{accessibleAgents.length}</span>}</button>);return(<div className="fixed bottom-10 right-4 w-[400px] h-[550px] glass shadow-2xl flex flex-col z-50 animate-fadeIn overflow-hidden"><div className="p-3 border-b border-slate-700/50 bg-slate-900/50"><div className="flex justify-between items-center">{selectedAgent?(<div className="flex items-center gap-2"><span className="text-xl">{selectedAgent.icon}</span><div><p className="font-semibold text-white text-sm">{selectedAgent.name}</p><button onClick={()=>setShowAgentSelect(!showAgentSelect)} className="text-xs text-cyan-400">Switch ‚ñæ</button></div></div>):(<span className="font-semibold text-white">Select Agent</span>)}<button onClick={()=>setOpen(false)} className="p-1 text-slate-400 hover:text-white"><Icon name="x" className="w-5 h-5"/></button></div>{(showAgentSelect||!selectedAgent)&&(<div className="mt-2 p-2 bg-slate-800/80 rounded-lg max-h-40 overflow-y-auto">{accessibleAgents.map(a=>(<button key={a.id} onClick={()=>changeAgent(a)} className="w-full flex items-center gap-2 p-2 rounded hover:bg-slate-700"><span>{a.icon}</span><span className="text-sm text-white">{a.name}</span></button>))}</div>)}</div><div className="flex-1 overflow-y-auto p-3 space-y-2">{messages.map((m,i)=>(<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[80%] p-2 rounded-xl text-sm ${m.role==='user'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-200'}`}>{m.content}</div></div>))}{streamingText&&<div className="flex justify-start"><div className="bg-slate-700 p-2 rounded-xl text-sm text-slate-200">{streamingText}</div></div>}{loading&&!streamingText&&<div className="flex justify-start"><div className="bg-slate-700 p-2 rounded-xl"><div className="flex gap-1">{[0,1,2].map(i=><div key={i} className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{animationDelay:`${i*0.2}s`}}/>)}</div></div></div>}<div ref={messagesEndRef}/></div><div className="px-3 py-1 bg-amber-500/10 border-t border-amber-500/20"><p className="text-[10px] text-amber-400 text-center">‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW</p></div><div className="p-3 border-t border-slate-700/50"><div className="flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder={selectedAgent?'Ask...':'Select agent'} disabled={!selectedAgent} className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none disabled:opacity-50"/><button onClick={send} disabled={!input.trim()||loading||!selectedAgent} className="p-2 bg-cyan-500 rounded-lg text-white disabled:opacity-50"><Icon name="send" className="w-5 h-5"/></button></div></div></div>)}

// ============================================================
// TOAST
// ============================================================
function Toast({message,type,onClose}){useEffect(()=>{const t=setTimeout(onClose,3000);return()=>clearTimeout(t)},[onClose]);const colors={success:'bg-emerald-500',error:'bg-red-500',warning:'bg-amber-500',info:'bg-cyan-500'};return(<div className={`fixed top-4 right-4 ${colors[type]||colors.info} text-white px-4 py-3 rounded-lg shadow-lg z-[60] animate-fadeIn flex items-center gap-2`}><span>{type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ'}</span><span>{message}</span></div>)}

// ============================================================
// SIDEBAR
// ============================================================
function Sidebar({role,setRole,active,setActive,user,hitlPending}){const[collapsed,setCollapsed]=useState(false);const[showRoles,setShowRoles]=useState(false);const accessible=MODULES.filter(m=>role.access.includes(m.id));return(<aside className={`h-screen bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all ${collapsed?'w-16':'w-64'}`}><div className="p-4 border-b border-slate-800 flex items-center justify-between">{!collapsed&&<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div><div className="text-sm font-bold text-white">MissionPulse</div><div className="text-[10px] text-slate-500">v12 Sprint 9</div></div></div>}<button onClick={()=>setCollapsed(!collapsed)} className="p-1 text-slate-400 hover:text-white"><Icon name={collapsed?'chevronRight':'chevronLeft'} className="w-4 h-4"/></button></div><div className="p-3 border-b border-slate-800"><button onClick={()=>setShowRoles(!showRoles)} className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800"><span className="text-xl">{role.icon}</span>{!collapsed&&<><div className="flex-1 text-left"><div className="text-sm font-medium text-white">{role.fullName}</div><div className="text-xs text-slate-400">{role.name}</div></div><Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition ${showRoles?'rotate-180':''}`}/></>}</button>{showRoles&&!collapsed&&<div className="mt-2 p-2 bg-slate-800/50 rounded-lg max-h-48 overflow-y-auto">{ROLES.map(r=><button key={r.id} onClick={()=>{setRole(r);setShowRoles(false)}} className={`w-full flex items-center gap-2 p-2 rounded hover:bg-slate-700 ${role.id===r.id?'bg-cyan-500/20':''}`}><span>{r.icon}</span><span className="text-sm text-white">{r.name}</span></button>)}</div>}</div><nav className="flex-1 overflow-y-auto p-2">{['Command','Strategy','Intel','Delivery','Admin'].map(cat=>{const mods=accessible.filter(m=>m.cat===cat);if(!mods.length)return null;return(<div key={cat} className="mb-3">{!collapsed&&<div className="text-[10px] uppercase text-slate-500 font-semibold px-2 mb-1">{cat}</div>}{mods.map(m=><button key={m.id} onClick={()=>setActive(m)} className={`w-full flex items-center gap-2 p-2 rounded-lg mb-0.5 transition ${active?.id===m.id?'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30':'text-slate-400 hover:bg-slate-800 hover:text-white'}`} title={collapsed?m.name:''}><span>{m.icon}</span>{!collapsed&&<><span className="flex-1 text-left text-sm">{m.name}</span>{m.id==='hitl'&&hitlPending>0&&<span className="px-1.5 py-0.5 text-[10px] font-bold rounded-full bg-amber-500 text-white">{hitlPending}</span>}{m.badge&&<span className={`px-1 py-0.5 text-[9px] font-bold rounded ${m.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</>}</button>)}</div>)})}</nav>{!collapsed&&user&&<div className="p-3 border-t border-slate-800"><div className="flex items-center justify-between"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white text-xs font-bold">{user.name?.[0]||'U'}</div><div className="text-xs text-white truncate max-w-[120px]">{user.name||user.email}</div></div><button onClick={handleLogout} className="p-1.5 rounded hover:bg-red-500/20 text-slate-400 hover:text-red-400"><Icon name="logout" className="w-4 h-4"/></button></div></div>}</aside>)}

// ============================================================
// MAIN APP
// ============================================================
function App(){
  const[user,setUser]=useState(null);
  const[role,setRole]=useState(ROLES[0]);
  const[active,setActive]=useState(null);
  const[opps,setOpps]=useState(DEMO_OPPS);
  const[hitlItems,setHitlItems]=useState(DEMO_HITL);
  const[tokenUsage,setTokenUsage]=useState(45230);
  const[toast,setToast]=useState(null);

  const showToast=(message,type='success')=>setToast({message,type,key:Date.now()});
  const hitlPending=hitlItems.filter(h=>h.status==='pending').length;

  const sendToHITL=(item)=>{
    const newItem={...item,id:Date.now(),status:'pending',priority:item.priority||'medium',created:new Date().toISOString()};
    setHitlItems([newItem,...hitlItems]);
  };

  useEffect(()=>{const u=checkAuth();if(u){setUser(u);logAudit('LOGIN','Auth','Session restored',u.name||u.email,'CEO')}},[]);
  useEffect(()=>{const saved=localStorage.getItem('MP_OPPS');if(saved){try{setOpps(JSON.parse(saved))}catch{}}},[]);
  useEffect(()=>{localStorage.setItem('MP_OPPS',JSON.stringify(opps))},[opps]);

  const renderModule=()=>{
    if(!active)return<div className="flex-1 flex items-center justify-center"><div className="text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><h2 className="text-xl font-bold text-white mb-2">Welcome to MissionPulse</h2><p className="text-slate-400">Select a module to begin</p><p className="text-cyan-400 text-sm mt-2">Mission. Technology. Transformation.</p></div></div>;
    switch(active.id){
      case 'dashboard':return<ModuleDashboard opps={opps} tokenUsage={tokenUsage} hitlItems={hitlItems}/>;
      case 'swimlane':return<ModuleSwimlane opps={opps} setOpps={setOpps} role={role} showToast={showToast}/>;
      case 'compliance':return<ModuleCompliance showToast={showToast}/>;
      case 'writer':return<ModuleWriter role={role} user={user} showToast={showToast} onSendToHITL={sendToHITL} onTokenUsage={setTokenUsage}/>;
      case 'blackhat':return<ModuleBlackHat role={role} user={user} showToast={showToast} onSendToHITL={sendToHITL}/>;
      case 'hitl':return<ModuleHITL role={role} hitlItems={hitlItems} setHitlItems={setHitlItems} showToast={showToast}/>;
      case 'orals':return<ModuleOrals/>;
      case 'pricing':return<ModulePricing/>;
      case 'playbook':return<ModulePlaybook/>;
      case 'audit':return<ModuleAudit role={role}/>;
      case 'admin':return<ModuleAdmin tokenUsage={tokenUsage}/>;
      default:return<ModuleGeneric mod={active}/>;
    }
  };

  if(!user)return<div className="h-screen flex items-center justify-center bg-[#00050F]"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;

  return(
    <div className="h-screen flex bg-[#00050F] overflow-hidden">
      <Sidebar role={role} setRole={setRole} active={active} setActive={setActive} user={user} hitlPending={hitlPending}/>
      <div className="flex-1 flex flex-col overflow-hidden">
        {active&&<header className="bg-slate-900/90 border-b border-slate-800 px-6 py-3"><div className="flex items-center gap-3"><span className="text-xl">{active.icon}</span><h1 className="font-semibold text-white">{active.name}</h1>{active.badge&&<span className={`px-2 py-0.5 rounded text-xs font-bold ${active.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':active.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{active.badge}</span>}</div></header>}
        <main className="flex-1 overflow-y-auto p-6">{renderModule()}</main>
      </div>
      <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-40"><span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW ‚Ä¢ MissionPulse v12 Sprint 9 ‚Ä¢ ¬© 2026 Mission Meets Tech</span></div>
      <AIChatWidget role={role} user={user} onTokenUsage={setTokenUsage}/>
      {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} key={toast.key}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
