<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="MissionPulse - AI-Powered Proposal Command Center">
  <title>MissionPulse | Dashboard</title>
  
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- React 18 + Tailwind -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-cyan: #00E5FA;
      --deep-navy: #00050F;
      --success-teal: #00BDAE;
      --warning-amber: #F59E0B;
      --risk-coral: #EF4444;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: var(--deep-navy); 
      min-height: 100vh;
      color: #e2e8f0;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a1628; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    
    /* Glass Panel */
    .glass-panel { 
      background: rgba(15, 23, 42, 0.7); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(0, 229, 250, 0.12); 
      border-radius: 12px; 
    }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0, 229, 250, 0.15); }
    
    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, createContext, useContext } = React;

    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================
    // AUTH CONTEXT
    // ============================================================
    const AuthContext = createContext(null);

    // ============================================================
    // SHIPLEY PHASES
    // ============================================================
    const SHIPLEY_PHASES = [
      { id: 'capture', name: 'Capture', color: '#60a5fa', order: 1 },
      { id: 'qualify', name: 'Qualify', color: '#8b5cf6', order: 2 },
      { id: 'proposal', name: 'Proposal', color: '#f59e0b', order: 3 },
      { id: 'review', name: 'Review', color: '#ef4444', order: 4 },
      { id: 'submit', name: 'Submit', color: '#10b981', order: 5 },
      { id: 'award', name: 'Award', color: '#00E5FA', order: 6 }
    ];

    // ============================================================
    // ICONS
    // ============================================================
    const Icon = ({ name, className = 'w-5 h-5', style }) => {
      const icons = {
        shield: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        logout: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
        user: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        briefcase: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
        dollarSign: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        trendingUp: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
        clock: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        calendar: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        chevronRight: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
        filter: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
        search: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        plus: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        building: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
        alert: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        checkCircle: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        bell: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
        refresh: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        loader: <svg className={`${className} animate-spin`} style={style} fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
      };
      return icons[name] || null;
    };

    // ============================================================
    // UI COMPONENTS
    // ============================================================
    const Card = ({ children, className = '', hover = false }) => (
      <div className={`glass-panel p-5 ${hover ? 'hover-lift cursor-pointer' : ''} ${className}`}>
        {children}
      </div>
    );

    const Badge = ({ children, variant = 'default', className = '' }) => {
      const variants = {
        default: 'bg-slate-700 text-slate-300',
        cyan: 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30',
        success: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30',
        warning: 'bg-amber-500/20 text-amber-400 border border-amber-500/30',
        danger: 'bg-red-500/20 text-red-400 border border-red-500/30'
      };
      return (
        <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${variants[variant]} ${className}`}>
          {children}
        </span>
      );
    };

    const Button = ({ children, onClick, variant = 'primary', size = 'md', icon, disabled, loading, className = '' }) => {
      const variants = {
        primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white hover:from-cyan-400 hover:to-teal-400 shadow-lg shadow-cyan-500/25',
        secondary: 'bg-slate-700 text-slate-200 hover:bg-slate-600 border border-slate-600',
        ghost: 'text-slate-400 hover:text-white hover:bg-slate-700/50',
        danger: 'bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30'
      };
      const sizes = {
        sm: 'px-3 py-1.5 text-xs',
        md: 'px-4 py-2 text-sm',
        lg: 'px-6 py-3 text-base'
      };
      return (
        <button 
          onClick={onClick} 
          disabled={disabled || loading}
          className={`inline-flex items-center justify-center gap-2 rounded-lg font-semibold transition-all ${variants[variant]} ${sizes[size]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
        >
          {loading ? <Icon name="loader" className="w-4 h-4" /> : icon && <Icon name={icon} className="w-4 h-4" />}
          {children}
        </button>
      );
    };

    const Skeleton = ({ className = '' }) => (
      <div className={`skeleton rounded ${className}`}></div>
    );

    // ============================================================
    // KPI CARD COMPONENT
    // ============================================================
    const KPICard = ({ icon, label, value, subtext, trend, loading }) => (
      <Card className="animate-fadeIn">
        <div className="flex items-start justify-between">
          <div className="w-10 h-10 rounded-lg bg-cyan-500/20 flex items-center justify-center">
            <Icon name={icon} className="w-5 h-5 text-cyan-400" />
          </div>
          {trend && (
            <Badge variant={trend > 0 ? 'success' : 'danger'}>
              {trend > 0 ? '+' : ''}{trend}%
            </Badge>
          )}
        </div>
        <div className="mt-4">
          {loading ? (
            <Skeleton className="h-8 w-24 mb-2" />
          ) : (
            <div className="text-2xl font-bold text-white">{value}</div>
          )}
          <div className="text-sm text-slate-400">{label}</div>
          {subtext && <div className="text-xs text-slate-500 mt-1">{subtext}</div>}
        </div>
      </Card>
    );

    // ============================================================
    // OPPORTUNITY CARD COMPONENT
    // ============================================================
    const OpportunityCard = ({ opportunity, onClick }) => {
      const phase = SHIPLEY_PHASES.find(p => p.id === opportunity.shipley_phase) || SHIPLEY_PHASES[0];
      const daysUntilDeadline = Math.ceil((new Date(opportunity.submission_deadline) - new Date()) / (1000 * 60 * 60 * 24));
      const isUrgent = daysUntilDeadline <= 14;
      
      const priorityColors = {
        high: 'text-red-400',
        medium: 'text-amber-400',
        low: 'text-emerald-400'
      };

      return (
        <Card hover onClick={onClick} className="animate-fadeIn">
          <div className="flex items-start justify-between mb-3">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <Badge 
                  variant="cyan"
                  className="text-[10px]"
                >
                  {opportunity.solicitation_number || 'TBD'}
                </Badge>
                {isUrgent && (
                  <Badge variant="danger" className="text-[10px]">URGENT</Badge>
                )}
              </div>
              <h3 className="font-semibold text-white line-clamp-1">{opportunity.title}</h3>
              <div className="flex items-center gap-2 mt-1 text-xs text-slate-400">
                <Icon name="building" className="w-3 h-3" />
                <span>{opportunity.agency}</span>
              </div>
            </div>
            <div className="text-right">
              <div className="text-lg font-bold text-cyan-400">
                ${(opportunity.contract_value / 1000000).toFixed(1)}M
              </div>
              <div className="text-xs text-slate-500">Contract Value</div>
            </div>
          </div>
          
          {/* Phase Badge */}
          <div className="flex items-center justify-between mb-3">
            <div 
              className="px-3 py-1 rounded-full text-xs font-medium"
              style={{ 
                backgroundColor: `${phase.color}20`, 
                color: phase.color,
                border: `1px solid ${phase.color}40`
              }}
            >
              {phase.name} Phase
            </div>
            <div className={`flex items-center gap-1 text-sm font-semibold ${priorityColors[opportunity.priority] || priorityColors.medium}`}>
              <span>{opportunity.pwin}%</span>
              <span className="text-xs text-slate-500">pWin</span>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="mb-3">
            <div className="flex justify-between text-xs text-slate-400 mb-1">
              <span>Completion</span>
              <span>{opportunity.completion_percent || 0}%</span>
            </div>
            <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
              <div 
                className="h-full rounded-full transition-all duration-500"
                style={{ 
                  width: `${opportunity.completion_percent || 0}%`,
                  backgroundColor: phase.color
                }}
              />
            </div>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-between pt-3 border-t border-slate-700/50">
            <div className="flex items-center gap-1 text-xs text-slate-400">
              <Icon name="calendar" className="w-3 h-3" />
              <span>
                {new Date(opportunity.submission_deadline).toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                })}
              </span>
              <span className={isUrgent ? 'text-red-400 font-medium' : ''}>
                ({daysUntilDeadline}d)
              </span>
            </div>
            <button className="text-cyan-400 text-xs font-medium flex items-center gap-1 hover:text-cyan-300 transition-colors">
              View Details
              <Icon name="chevronRight" className="w-3 h-3" />
            </button>
          </div>
        </Card>
      );
    };

    // ============================================================
    // HEADER COMPONENT
    // ============================================================
    const Header = ({ user, company, onLogout }) => (
      <header className="bg-slate-900/80 border-b border-slate-700/50 px-6 py-3 backdrop-blur-sm sticky top-0 z-40">
        <div className="flex items-center justify-between">
          {/* Logo */}
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center shadow-lg shadow-cyan-500/25">
              <Icon name="shield" className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">MissionPulse</h1>
              <p className="text-xs text-cyan-400">
                {company?.name || 'Loading...'}
              </p>
            </div>
          </div>

          {/* Right Side */}
          <div className="flex items-center gap-4">
            {/* Notifications */}
            <button className="relative p-2 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors">
              <Icon name="bell" className="w-5 h-5" />
              <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>

            {/* User Menu */}
            <div className="flex items-center gap-3 pl-4 border-l border-slate-700">
              <div className="w-9 h-9 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-semibold text-sm">
                {user?.full_name?.split(' ').map(n => n[0]).join('').toUpperCase() || 'U'}
              </div>
              <div className="hidden sm:block">
                <div className="text-sm font-medium text-white">{user?.full_name || 'User'}</div>
                <div className="text-xs text-slate-400">{user?.role || 'Member'}</div>
              </div>
              <Button 
                variant="ghost" 
                size="sm" 
                icon="logout"
                onClick={onLogout}
                className="ml-2"
              >
                <span className="hidden sm:inline">Logout</span>
              </Button>
            </div>
          </div>
        </div>
      </header>
    );

    // ============================================================
    // FILTER BAR COMPONENT
    // ============================================================
    const FilterBar = ({ filters, onFilterChange, onSearch }) => {
      const [searchQuery, setSearchQuery] = useState('');

      return (
        <div className="glass-panel p-4 mb-6">
          <div className="flex flex-wrap items-center gap-4">
            {/* Search */}
            <div className="relative flex-1 min-w-[200px]">
              <Icon name="search" className="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" />
              <input
                type="text"
                placeholder="Search opportunities..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && onSearch(searchQuery)}
                className="w-full pl-10 pr-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-cyan-500/50"
              />
            </div>

            {/* Phase Filter */}
            <select 
              value={filters.phase || 'all'}
              onChange={(e) => onFilterChange({ ...filters, phase: e.target.value })}
              className="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white focus:outline-none focus:border-cyan-500/50"
            >
              <option value="all">All Phases</option>
              {SHIPLEY_PHASES.map(phase => (
                <option key={phase.id} value={phase.id}>{phase.name}</option>
              ))}
            </select>

            {/* Priority Filter */}
            <select 
              value={filters.priority || 'all'}
              onChange={(e) => onFilterChange({ ...filters, priority: e.target.value })}
              className="px-4 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-white focus:outline-none focus:border-cyan-500/50"
            >
              <option value="all">All Priorities</option>
              <option value="high">High Priority</option>
              <option value="medium">Medium Priority</option>
              <option value="low">Low Priority</option>
            </select>

            {/* Add Opportunity Button */}
            <Button variant="primary" size="md" icon="plus">
              New Opportunity
            </Button>
          </div>
        </div>
      );
    };

    // ============================================================
    // MAIN DASHBOARD COMPONENT
    // ============================================================
    const Dashboard = ({ user, company, onLogout }) => {
      const [opportunities, setOpportunities] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [filters, setFilters] = useState({ phase: 'all', priority: 'all' });
      const [searchQuery, setSearchQuery] = useState('');

      // Fetch opportunities from Supabase
      const fetchOpportunities = async () => {
        setLoading(true);
        setError(null);
        
        try {
          let query = supabase
            .from('opportunities')
            .select('*')
            .eq('company_id', user.company_id)
            .order('submission_deadline', { ascending: true });

          if (filters.phase !== 'all') {
            query = query.eq('shipley_phase', filters.phase);
          }

          if (filters.priority !== 'all') {
            query = query.eq('priority', filters.priority);
          }

          const { data, error: fetchError } = await query;

          if (fetchError) throw fetchError;
          setOpportunities(data || []);
        } catch (err) {
          console.error('Error fetching opportunities:', err);
          setError('Failed to load opportunities. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        if (user?.company_id) {
          fetchOpportunities();
        }
      }, [user?.company_id, filters]);

      // Calculate KPIs
      const kpis = useMemo(() => {
        const activeOpps = opportunities.filter(o => o.status === 'active' || !o.status);
        const totalValue = activeOpps.reduce((sum, o) => sum + (o.contract_value || 0), 0);
        const avgPwin = activeOpps.length > 0 
          ? Math.round(activeOpps.reduce((sum, o) => sum + (o.pwin || 0), 0) / activeOpps.length)
          : 0;
        const urgentCount = activeOpps.filter(o => {
          const days = Math.ceil((new Date(o.submission_deadline) - new Date()) / (1000 * 60 * 60 * 24));
          return days <= 14;
        }).length;

        return {
          activeCount: activeOpps.length,
          pipelineValue: totalValue,
          avgPwin,
          urgentCount
        };
      }, [opportunities]);

      // Filter opportunities by search
      const filteredOpportunities = useMemo(() => {
        if (!searchQuery) return opportunities;
        const query = searchQuery.toLowerCase();
        return opportunities.filter(o => 
          o.title?.toLowerCase().includes(query) ||
          o.agency?.toLowerCase().includes(query) ||
          o.solicitation_number?.toLowerCase().includes(query)
        );
      }, [opportunities, searchQuery]);

      return (
        <div className="min-h-screen bg-[#00050F]">
          <Header user={user} company={company} onLogout={onLogout} />
          
          <main className="max-w-7xl mx-auto px-6 py-8">
            {/* Welcome Section */}
            <div className="mb-8">
              <h2 className="text-2xl font-bold text-white mb-2">
                Welcome back, {user?.full_name?.split(' ')[0] || 'there'}!
              </h2>
              <p className="text-slate-400">
                Here's your pipeline overview for {company?.name || 'your company'}.
              </p>
            </div>

            {/* KPI Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              <KPICard
                icon="briefcase"
                label="Active Opportunities"
                value={loading ? '-' : kpis.activeCount}
                subtext="In progress"
                loading={loading}
              />
              <KPICard
                icon="dollarSign"
                label="Pipeline Value"
                value={loading ? '-' : `$${(kpis.pipelineValue / 1000000).toFixed(1)}M`}
                subtext="Total contract value"
                loading={loading}
              />
              <KPICard
                icon="trendingUp"
                label="Avg Win Probability"
                value={loading ? '-' : `${kpis.avgPwin}%`}
                subtext="Weighted average"
                trend={5}
                loading={loading}
              />
              <KPICard
                icon="clock"
                label="Urgent Deadlines"
                value={loading ? '-' : kpis.urgentCount}
                subtext="Due within 14 days"
                loading={loading}
              />
            </div>

            {/* Filter Bar */}
            <FilterBar 
              filters={filters}
              onFilterChange={setFilters}
              onSearch={setSearchQuery}
            />

            {/* Error State */}
            {error && (
              <div className="glass-panel p-6 mb-6 border-red-500/30 bg-red-500/10">
                <div className="flex items-center gap-3">
                  <Icon name="alert" className="w-6 h-6 text-red-400" />
                  <div>
                    <h3 className="font-semibold text-red-400">Error Loading Data</h3>
                    <p className="text-sm text-slate-400">{error}</p>
                  </div>
                  <Button variant="danger" size="sm" onClick={fetchOpportunities} className="ml-auto">
                    Retry
                  </Button>
                </div>
              </div>
            )}

            {/* Opportunities Grid */}
            <div className="mb-4 flex items-center justify-between">
              <h3 className="text-lg font-semibold text-white">
                Opportunities 
                <span className="text-slate-400 font-normal ml-2">
                  ({filteredOpportunities.length})
                </span>
              </h3>
              <Button 
                variant="ghost" 
                size="sm" 
                icon="refresh"
                onClick={fetchOpportunities}
                loading={loading}
              >
                Refresh
              </Button>
            </div>

            {loading ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {[1, 2, 3, 4, 5, 6].map(i => (
                  <Card key={i}>
                    <Skeleton className="h-4 w-24 mb-3" />
                    <Skeleton className="h-6 w-full mb-4" />
                    <Skeleton className="h-4 w-32 mb-3" />
                    <Skeleton className="h-2 w-full mb-4" />
                    <Skeleton className="h-4 w-full" />
                  </Card>
                ))}
              </div>
            ) : filteredOpportunities.length > 0 ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredOpportunities.map(opp => (
                  <OpportunityCard 
                    key={opp.id} 
                    opportunity={opp}
                    onClick={() => console.log('View opportunity:', opp.id)}
                  />
                ))}
              </div>
            ) : (
              <Card className="text-center py-12">
                <Icon name="briefcase" className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                <h3 className="text-lg font-semibold text-slate-300 mb-2">No Opportunities Found</h3>
                <p className="text-slate-500 mb-6">
                  {searchQuery ? 'Try adjusting your search or filters.' : 'Get started by adding your first opportunity.'}
                </p>
                <Button variant="primary" icon="plus">
                  Add Opportunity
                </Button>
              </Card>
            )}
          </main>

          {/* Footer */}
          <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 border-t border-slate-700/50 backdrop-blur-sm z-30">
            <div className="max-w-7xl mx-auto px-6 py-2 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="alert" className="w-4 h-4 text-amber-400" />
                <span className="text-xs text-slate-400">AI GENERATED - REQUIRES HUMAN REVIEW</span>
              </div>
              <span className="text-xs text-slate-500">MissionPulse v12.0 • © 2026 Mission Meets Tech</span>
            </div>
          </footer>
        </div>
      );
    };

    // ============================================================
    // LOADING SCREEN
    // ============================================================
    const LoadingScreen = () => (
      <div className="min-h-screen bg-[#00050F] flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-cyan-500/30">
            <Icon name="shield" className="w-10 h-10 text-white" />
          </div>
          <h1 className="text-2xl font-bold text-white mb-2">MissionPulse</h1>
          <p className="text-slate-400 mb-6">Loading your dashboard...</p>
          <Icon name="loader" className="w-8 h-8 text-cyan-400 mx-auto" />
        </div>
      </div>
    );

    // ============================================================
    // MAIN APP COMPONENT
    // ============================================================
    function App() {
      const [loading, setLoading] = useState(true);
      const [user, setUser] = useState(null);
      const [company, setCompany] = useState(null);

      // Check authentication on mount
      useEffect(() => {
        checkAuth();

        // Listen for auth changes
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
          if (event === 'SIGNED_OUT' || !session) {
            window.location.href = '/login.html';
          } else if (event === 'SIGNED_IN' && session) {
            await loadUserData(session.user);
          }
        });

        return () => subscription.unsubscribe();
      }, []);

      const checkAuth = async () => {
        try {
          const { data: { session }, error } = await supabase.auth.getSession();
          
          if (error || !session) {
            // Redirect to login
            window.location.href = '/login.html';
            return;
          }

          await loadUserData(session.user);
        } catch (err) {
          console.error('Auth check error:', err);
          window.location.href = '/login.html';
        }
      };

      const loadUserData = async (authUser) => {
        try {
          // Fetch user profile with company
          const { data: userData, error: userError } = await supabase
            .from('users')
            .select(`
              *,
              companies (
                id,
                name,
                domain,
                cage_code
              )
            `)
            .eq('id', authUser.id)
            .single();

          if (userError) {
            // User doesn't exist in users table yet - might be new signup
            // Create a basic user object from auth data
            setUser({
              id: authUser.id,
              email: authUser.email,
              full_name: authUser.user_metadata?.full_name || authUser.email?.split('@')[0],
              role: 'Member',
              company_id: null
            });
            setCompany(null);
          } else {
            setUser(userData);
            setCompany(userData.companies);
          }
        } catch (err) {
          console.error('Error loading user data:', err);
        } finally {
          setLoading(false);
        }
      };

      const handleLogout = async () => {
        try {
          await supabase.auth.signOut();
          window.location.href = '/login.html';
        } catch (err) {
          console.error('Logout error:', err);
        }
      };

      if (loading) {
        return <LoadingScreen />;
      }

      return (
        <AuthContext.Provider value={{ user, company }}>
          <Dashboard 
            user={user} 
            company={company} 
            onLogout={handleLogout}
          />
        </AuthContext.Provider>
      );
    }

    // ============================================================
    // RENDER
    // ============================================================
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
