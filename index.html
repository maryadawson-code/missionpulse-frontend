<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12.0 - Sprint 16</title>
  <!-- Supabase Client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF for PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-cyan: #00E5FA;
      --deep-navy: #00050F;
      --slate-800: #1e293b;
      --slate-700: #334155;
      --slate-600: #475569;
      --slate-500: #64748b;
      --slate-400: #94a3b8;
      --slate-300: #cbd5e1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--deep-navy); min-height: 100vh; color: white; }
    
    /* Animations */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
    
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
    .animate-slide-out-right { animation: slideOutRight 0.3s ease-out forwards; }
    .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--slate-600); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--slate-500); }
    
    /* Custom checkbox */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--slate-500);
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      position: relative;
      transition: all 0.15s ease;
    }
    .custom-checkbox:checked {
      background: #00E5FA;
      border-color: #00E5FA;
    }
    .custom-checkbox:checked::after {
      content: '';
      position: absolute;
      left: 5px;
      top: 2px;
      width: 5px;
      height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    .custom-checkbox:hover { border-color: #00E5FA; }
    
    /* Light theme support */
    .light-theme { background: #f8fafc; color: #0f172a; }
    .light-theme .bg-slate-900 { background: #f1f5f9; }
    .light-theme .bg-slate-800 { background: #e2e8f0; }
    .light-theme .text-white { color: #0f172a; }
    .light-theme .text-slate-400 { color: #64748b; }
    .light-theme .border-slate-700 { border-color: #cbd5e1; }
    
    /* Tabular numbers for dates/counts */
    .tabular-nums { font-variant-numeric: tabular-nums; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cyan: { 400: '#00E5FA', 500: '#00c4d6', 600: '#00a3b3' },
            navy: { 950: '#00050F' }
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    
    // ============================================================
    // SUPABASE CONFIGURATION
    // ============================================================
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================
    // CONSTANTS
    // ============================================================
    const SHIPLEY_PHASES = [
      { key: 'gate_1', name: 'Gate 1', color: '#94a3b8' },
      { key: 'blue_team', name: 'Blue Team', color: '#60a5fa' },
      { key: 'pink_team', name: 'Pink Team', color: '#f472b6' },
      { key: 'red_team', name: 'Red Team', color: '#ef4444' },
      { key: 'gold_team', name: 'Gold Team', color: '#fbbf24' },
      { key: 'submitted', name: 'Submitted', color: '#22c55e' },
      { key: 'awarded', name: 'Awarded', color: '#8b5cf6' },
      { key: 'lost', name: 'Lost', color: '#64748b' }
    ];
    
    const PRIORITIES = [
      { value: 'P-0', label: 'P-0 Critical', color: '#ef4444' },
      { value: 'P-1', label: 'P-1 High', color: '#f97316' },
      { value: 'P-2', label: 'P-2 Medium', color: '#eab308' },
      { value: 'P-3', label: 'P-3 Low', color: '#22c55e' }
    ];
    
    const AGENCIES = ['VA', 'DHA', 'CMS', 'IHS', 'DoD', 'HHS', 'GSA', 'NASA', 'DHS'];
    
    const DEFAULT_SETTINGS = {
      display: {
        defaultView: 'board',
        cardsPerRow: 'auto',
        showPwinBars: true,
        compactMode: false
      },
      notifications: {
        dueDateAlerts: true,
        dueDateThreshold: 3,
        p0Alerts: true,
        phaseStuckAlerts: true,
        phaseStuckThreshold: 14
      }
    };
    
    const DEFAULT_FILTER_PRESETS = [
      { id: 'all', name: 'All Opportunities', filters: { search: '', agencies: [], priorities: [], phases: [], pWinMin: 0, pWinMax: 100, dueDateStart: null, dueDateEnd: null }, isBuiltIn: true },
      { id: 'critical', name: 'Critical Priority', filters: { search: '', agencies: [], priorities: ['P-0'], phases: [], pWinMin: 0, pWinMax: 100, dueDateStart: null, dueDateEnd: null }, isBuiltIn: true },
      { id: 'highpwin', name: 'High Win Probability', filters: { search: '', agencies: [], priorities: [], phases: [], pWinMin: 70, pWinMax: 100, dueDateStart: null, dueDateEnd: null }, isBuiltIn: true }
    ];

    // ============================================================
    // ICONS
    // ============================================================
    const Icons = {
      activity: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>,
      bell: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      calendar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
      chart: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      chevronDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
      chevronLeft: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>,
      chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      clipboard: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>,
      clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      command: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 3a3 3 0 00-3 3v12a3 3 0 003 3 3 3 0 003-3 3 3 0 00-3-3H6a3 3 0 00-3 3 3 3 0 003 3 3 3 0 003-3V6a3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3h12a3 3 0 003-3 3 3 0 00-3-3z" /></svg>,
      download: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      edit: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      filter: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
      grid: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
      list: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>,
      loader: () => <svg className="w-full h-full animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      moon: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
      plus: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      search: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      settings: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      sun: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      trash: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      user: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      file: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      checkSquare: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
      comment: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
      users: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      arrowUp: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>,
      arrowDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>,
      save: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
      refresh: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
    };

    const Icon = ({ name, className = "w-4 h-4" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // ============================================================
    // UTILITIES
    // ============================================================
    const formatCurrency = (value) => {
      if (!value) return '$0';
      if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
      if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
      if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
      return `$${value.toLocaleString()}`;
    };
    
    const formatDate = (date) => {
      if (!date) return '';
      return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };
    
    const formatRelativeTime = (date) => {
      if (!date) return '';
      const now = new Date();
      const then = new Date(date);
      const diffMs = now - then;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return formatDate(date);
    };
    
    const getDaysRemaining = (dueDate) => {
      if (!dueDate) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dueDate);
      due.setHours(0, 0, 0, 0);
      return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
    };
    
    const getPriorityColor = (priority) => {
      const p = PRIORITIES.find(p => p.value === priority);
      return p?.color || '#64748b';
    };
    
    const getPhaseInfo = (phaseKey) => {
      return SHIPLEY_PHASES.find(p => p.key === phaseKey) || SHIPLEY_PHASES[0];
    };

    // ============================================================
    // DATABASE FUNCTIONS
    // ============================================================
    const mapToFrontend = (record) => {
      if (!record) return null;
      return {
        id: record.id,
        name: record.name,
        agency: record.agency,
        contractValue: record.contract_value,
        priority: record.priority,
        shipleyPhase: record.shipley_phase,
        winProbability: record.win_probability,
        dueDate: record.due_date,
        solicitationNumber: record.solicitation_number,
        description: record.description,
        contractType: record.contract_type,
        setAside: record.set_aside,
        naicsCode: record.naics_code,
        primaryContact: record.primary_contact,
        createdAt: record.created_at,
        updatedAt: record.updated_at
      };
    };
    
    const mapToDatabase = (data) => {
      const mapped = {};
      if (data.name !== undefined) mapped.name = data.name;
      if (data.agency !== undefined) mapped.agency = data.agency;
      if (data.contractValue !== undefined) mapped.contract_value = data.contractValue;
      if (data.priority !== undefined) mapped.priority = data.priority;
      if (data.shipleyPhase !== undefined) mapped.shipley_phase = data.shipleyPhase;
      if (data.winProbability !== undefined) mapped.win_probability = data.winProbability;
      if (data.dueDate !== undefined) mapped.due_date = data.dueDate;
      if (data.solicitationNumber !== undefined) mapped.solicitation_number = data.solicitationNumber;
      if (data.description !== undefined) mapped.description = data.description;
      if (data.contractType !== undefined) mapped.contract_type = data.contractType;
      if (data.setAside !== undefined) mapped.set_aside = data.setAside;
      if (data.naicsCode !== undefined) mapped.naics_code = data.naicsCode;
      if (data.primaryContact !== undefined) mapped.primary_contact = data.primaryContact;
      return mapped;
    };

    // ============================================================
    // TOAST NOTIFICATION COMPONENT
    // ============================================================
    const Toast = ({ message, type = 'success', onClose, action }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, action ? 8000 : 4000);
        return () => clearTimeout(timer);
      }, [onClose, action]);
      
      const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-cyan-500';
      
      return (
        <div className={`fixed bottom-4 right-4 z-50 ${bgColor} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 animate-slide-up`}>
          <Icon name={type === 'success' ? 'check' : type === 'error' ? 'x' : 'bell'} className="w-5 h-5" />
          <span className="font-medium">{message}</span>
          {action && (
            <button onClick={action.onClick} className="ml-2 px-2 py-1 bg-white/20 hover:bg-white/30 rounded text-sm font-semibold transition-colors">
              {action.label}
            </button>
          )}
          <button onClick={onClose} className="ml-2 hover:bg-white/20 rounded p-1 transition-colors">
            <Icon name="x" className="w-4 h-4" />
          </button>
        </div>
      );
    };

    // ============================================================
    // ACTIVITY LOG PANEL - Task 16.1
    // ============================================================
    const ActivityLogPanel = ({ isOpen, onClose, activities, loading, onLoadMore, hasMore, onClickActivity, onExport }) => {
      const [filterTab, setFilterTab] = useState('all');
      
      const filteredActivities = useMemo(() => {
        if (filterTab === 'all') return activities;
        return activities.filter(a => {
          if (filterTab === 'phase_changes') return a.action_type === 'phase_changed';
          if (filterTab === 'created') return a.action_type === 'created';
          if (filterTab === 'updated') return a.action_type === 'updated';
          if (filterTab === 'deleted') return a.action_type === 'deleted';
          return true;
        });
      }, [activities, filterTab]);
      
      const getActivityIcon = (actionType) => {
        switch (actionType) {
          case 'created': return 'plus';
          case 'updated': return 'edit';
          case 'deleted': return 'trash';
          case 'phase_changed': return 'arrowUp';
          case 'comment_added': return 'comment';
          case 'assignment_changed': return 'users';
          default: return 'activity';
        }
      };
      
      const getActivityColor = (actionType) => {
        switch (actionType) {
          case 'created': return 'text-emerald-400';
          case 'deleted': return 'text-red-400';
          case 'phase_changed': return 'text-cyan-400';
          case 'updated': return 'text-amber-400';
          case 'comment_added': return 'text-blue-400';
          case 'assignment_changed': return 'text-purple-400';
          default: return 'text-slate-400';
        }
      };
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-40">
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <div className="absolute right-0 top-0 h-full w-[400px] bg-slate-900 border-l border-slate-700 animate-slide-in-right flex flex-col">
            {/* Header */}
            <div className="p-4 border-b border-slate-700 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="activity" className="w-5 h-5 text-cyan-400" />
                <h2 className="text-lg font-semibold text-white">Activity Log</h2>
              </div>
              <div className="flex items-center gap-2">
                {/* Export Dropdown */}
                <div className="relative group">
                  <button className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                    <Icon name="download" className="w-4 h-4 text-slate-400" />
                  </button>
                  <div className="absolute right-0 top-full mt-1 hidden group-hover:block bg-slate-800 rounded-lg border border-slate-700 shadow-xl py-1 min-w-[120px]">
                    <button onClick={() => onExport('csv')} className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Export CSV</button>
                    <button onClick={() => onExport('json')} className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Export JSON</button>
                  </div>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                  <Icon name="x" className="w-5 h-5 text-slate-400" />
                </button>
              </div>
            </div>
            
            {/* Filter Tabs */}
            <div className="px-4 py-2 border-b border-slate-700 flex gap-1 overflow-x-auto">
              {[
                { key: 'all', label: 'All' },
                { key: 'phase_changes', label: 'Phase Changes' },
                { key: 'created', label: 'Created' },
                { key: 'updated', label: 'Updated' },
                { key: 'deleted', label: 'Deleted' }
              ].map(tab => (
                <button
                  key={tab.key}
                  onClick={() => setFilterTab(tab.key)}
                  className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-colors ${
                    filterTab === tab.key ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-slate-400 hover:text-white hover:bg-slate-800'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
            
            {/* Activities List */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {filteredActivities.length === 0 && !loading ? (
                <div className="text-center text-slate-500 py-8">
                  <Icon name="activity" className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>No activities found</p>
                </div>
              ) : (
                filteredActivities.map(activity => (
                  <div
                    key={activity.id}
                    onClick={() => onClickActivity(activity)}
                    className="p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 hover:border-cyan-500/30 cursor-pointer transition-colors"
                  >
                    <div className="flex items-start gap-3">
                      <div className={`p-2 rounded-lg bg-slate-800 ${getActivityColor(activity.action_type)}`}>
                        <Icon name={getActivityIcon(activity.action_type)} className="w-4 h-4" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-white truncate">{activity.opportunity_name || 'Unknown'}</p>
                        <p className="text-sm text-slate-400 mt-0.5">{activity.description || activity.action_type}</p>
                        {activity.old_value && activity.new_value && (
                          <p className="text-xs text-slate-500 mt-1">
                            <span className="text-red-400/70">{activity.old_value}</span>
                            <span className="mx-1">â†’</span>
                            <span className="text-emerald-400/70">{activity.new_value}</span>
                          </p>
                        )}
                        <p className="text-xs text-slate-500 mt-1 tabular-nums">{formatRelativeTime(activity.created_at)}</p>
                      </div>
                    </div>
                  </div>
                ))
              )}
              
              {loading && (
                <div className="flex items-center justify-center py-4">
                  <Icon name="loader" className="w-6 h-6 text-cyan-400" />
                </div>
              )}
              
              {hasMore && !loading && (
                <button
                  onClick={onLoadMore}
                  className="w-full py-2 text-sm text-cyan-400 hover:text-cyan-300 font-medium transition-colors"
                >
                  Load More
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // BULK ACTION BAR - Task 16.2
    // ============================================================
    const BulkActionBar = ({ selectedCount, onChangePhase, onChangePriority, onDelete, onClearSelection }) => {
      const [showPhaseDropdown, setShowPhaseDropdown] = useState(false);
      const [showPriorityDropdown, setShowPriorityDropdown] = useState(false);
      
      if (selectedCount === 0) return null;
      
      return (
        <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-30 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl px-4 py-3 flex items-center gap-4 animate-slide-up">
          <span className="text-sm font-medium text-white tabular-nums">
            <span className="text-cyan-400">{selectedCount}</span> selected
          </span>
          
          <div className="h-6 w-px bg-slate-700" />
          
          {/* Change Phase */}
          <div className="relative">
            <button
              onClick={() => { setShowPhaseDropdown(!showPhaseDropdown); setShowPriorityDropdown(false); }}
              className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white font-medium flex items-center gap-2 transition-colors"
            >
              <Icon name="arrowUp" className="w-4 h-4" />
              Change Phase
              <Icon name="chevronDown" className="w-3 h-3" />
            </button>
            {showPhaseDropdown && (
              <div className="absolute bottom-full mb-2 left-0 bg-slate-800 rounded-lg border border-slate-700 shadow-xl py-1 min-w-[160px]">
                {SHIPLEY_PHASES.map(phase => (
                  <button
                    key={phase.key}
                    onClick={() => { onChangePhase(phase.key); setShowPhaseDropdown(false); }}
                    className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2 transition-colors"
                  >
                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: phase.color }} />
                    {phase.name}
                  </button>
                ))}
              </div>
            )}
          </div>
          
          {/* Change Priority */}
          <div className="relative">
            <button
              onClick={() => { setShowPriorityDropdown(!showPriorityDropdown); setShowPhaseDropdown(false); }}
              className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm text-white font-medium flex items-center gap-2 transition-colors"
            >
              <Icon name="filter" className="w-4 h-4" />
              Change Priority
              <Icon name="chevronDown" className="w-3 h-3" />
            </button>
            {showPriorityDropdown && (
              <div className="absolute bottom-full mb-2 left-0 bg-slate-800 rounded-lg border border-slate-700 shadow-xl py-1 min-w-[140px]">
                {PRIORITIES.map(p => (
                  <button
                    key={p.value}
                    onClick={() => { onChangePriority(p.value); setShowPriorityDropdown(false); }}
                    className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2 transition-colors"
                  >
                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: p.color }} />
                    {p.label}
                  </button>
                ))}
              </div>
            )}
          </div>
          
          {/* Delete */}
          <button
            onClick={onDelete}
            className="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-lg text-sm text-red-400 font-medium flex items-center gap-2 transition-colors"
          >
            <Icon name="trash" className="w-4 h-4" />
            Delete
          </button>
          
          <div className="h-6 w-px bg-slate-700" />
          
          {/* Clear Selection */}
          <button
            onClick={onClearSelection}
            className="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"
          >
            <Icon name="x" className="w-5 h-5" />
          </button>
        </div>
      );
    };

    // ============================================================
    // PDF EXPORT MODAL - Task 16.3
    // ============================================================
    const PDFExportModal = ({ isOpen, onClose, opportunities, stats }) => {
      const [sections, setSections] = useState({
        executiveSummary: true,
        pipelineByPhase: true,
        priorityBreakdown: true,
        upcomingDueDates: true,
        detailsTable: true
      });
      const [generating, setGenerating] = useState(false);
      
      const toggleSection = (key) => {
        setSections(prev => ({ ...prev, [key]: !prev[key] }));
      };
      
      const generatePDF = async () => {
        setGenerating(true);
        
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 20;
          let y = margin;
          
          // Header
          doc.setFillColor(0, 5, 15);
          doc.rect(0, 0, pageWidth, 35, 'F');
          doc.setTextColor(0, 229, 250);
          doc.setFontSize(22);
          doc.text('MissionPulse Pipeline Report', margin, 22);
          doc.setTextColor(150, 150, 150);
          doc.setFontSize(10);
          doc.text(`Generated: ${new Date().toLocaleString()}`, margin, 30);
          
          y = 45;
          
          // Executive Summary
          if (sections.executiveSummary) {
            doc.setTextColor(0, 229, 250);
            doc.setFontSize(14);
            doc.text('Executive Summary', margin, y);
            y += 8;
            
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.text(`Total Pipeline Value: ${formatCurrency(stats?.totalValue || 0)}`, margin, y); y += 6;
            doc.text(`Opportunity Count: ${opportunities.length}`, margin, y); y += 6;
            doc.text(`Average Win Probability: ${stats?.avgPwin || 0}%`, margin, y); y += 6;
            doc.text(`Due This Month: ${stats?.dueThisMonth || 0}`, margin, y); y += 12;
          }
          
          // Pipeline by Phase
          if (sections.pipelineByPhase) {
            doc.setTextColor(0, 229, 250);
            doc.setFontSize(14);
            doc.text('Pipeline by Phase', margin, y);
            y += 8;
            
            const phaseData = SHIPLEY_PHASES.map(phase => {
              const phaseOpps = opportunities.filter(o => o.shipleyPhase === phase.key);
              const value = phaseOpps.reduce((sum, o) => sum + (o.contractValue || 0), 0);
              return [phase.name, phaseOpps.length.toString(), formatCurrency(value)];
            });
            
            doc.autoTable({
              startY: y,
              head: [['Phase', 'Count', 'Value']],
              body: phaseData,
              theme: 'grid',
              headStyles: { fillColor: [0, 50, 70], textColor: [0, 229, 250] },
              styles: { fontSize: 9, cellPadding: 3 },
              margin: { left: margin, right: margin }
            });
            
            y = doc.lastAutoTable.finalY + 12;
          }
          
          // Priority Breakdown
          if (sections.priorityBreakdown) {
            if (y > pageHeight - 60) { doc.addPage(); y = margin; }
            
            doc.setTextColor(0, 229, 250);
            doc.setFontSize(14);
            doc.text('Priority Breakdown', margin, y);
            y += 8;
            
            const priorityData = PRIORITIES.map(p => {
              const count = opportunities.filter(o => o.priority === p.value).length;
              return [p.label, count.toString()];
            });
            
            doc.autoTable({
              startY: y,
              head: [['Priority', 'Count']],
              body: priorityData,
              theme: 'grid',
              headStyles: { fillColor: [0, 50, 70], textColor: [0, 229, 250] },
              styles: { fontSize: 9, cellPadding: 3 },
              margin: { left: margin, right: margin },
              tableWidth: 80
            });
            
            y = doc.lastAutoTable.finalY + 12;
          }
          
          // Upcoming Due Dates
          if (sections.upcomingDueDates) {
            if (y > pageHeight - 60) { doc.addPage(); y = margin; }
            
            doc.setTextColor(0, 229, 250);
            doc.setFontSize(14);
            doc.text('Upcoming Due Dates (Next 30 Days)', margin, y);
            y += 8;
            
            const today = new Date();
            const thirtyDays = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            const upcomingOpps = opportunities
              .filter(o => {
                if (!o.dueDate) return false;
                const due = new Date(o.dueDate);
                return due >= today && due <= thirtyDays;
              })
              .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
              .slice(0, 10);
            
            if (upcomingOpps.length > 0) {
              const upcomingData = upcomingOpps.map(o => [
                o.name?.substring(0, 30) || '',
                o.agency || '',
                formatDate(o.dueDate),
                `${getDaysRemaining(o.dueDate)} days`
              ]);
              
              doc.autoTable({
                startY: y,
                head: [['Opportunity', 'Agency', 'Due Date', 'Days Left']],
                body: upcomingData,
                theme: 'grid',
                headStyles: { fillColor: [0, 50, 70], textColor: [0, 229, 250] },
                styles: { fontSize: 9, cellPadding: 3 },
                margin: { left: margin, right: margin }
              });
              
              y = doc.lastAutoTable.finalY + 12;
            } else {
              doc.setTextColor(100, 100, 100);
              doc.setFontSize(10);
              doc.text('No opportunities due in the next 30 days', margin, y);
              y += 12;
            }
          }
          
          // Details Table
          if (sections.detailsTable) {
            if (y > pageHeight - 60) { doc.addPage(); y = margin; }
            
            doc.setTextColor(0, 229, 250);
            doc.setFontSize(14);
            doc.text('Opportunity Details', margin, y);
            y += 8;
            
            const detailsData = opportunities.slice(0, 20).map(o => [
              o.name?.substring(0, 25) || '',
              o.agency || '',
              formatCurrency(o.contractValue),
              o.priority || '',
              getPhaseInfo(o.shipleyPhase).name,
              `${o.winProbability || 0}%`,
              formatDate(o.dueDate)
            ]);
            
            doc.autoTable({
              startY: y,
              head: [['Name', 'Agency', 'Value', 'Priority', 'Phase', 'pWin', 'Due']],
              body: detailsData,
              theme: 'grid',
              headStyles: { fillColor: [0, 50, 70], textColor: [0, 229, 250] },
              styles: { fontSize: 8, cellPadding: 2 },
              margin: { left: margin, right: margin },
              columnStyles: {
                0: { cellWidth: 40 },
                1: { cellWidth: 20 },
                2: { cellWidth: 25 },
                3: { cellWidth: 18 },
                4: { cellWidth: 25 },
                5: { cellWidth: 15 },
                6: { cellWidth: 25 }
              }
            });
          }
          
          // Footer on all pages
          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFillColor(245, 245, 245);
            doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text('AI GENERATED - REQUIRES HUMAN REVIEW', margin, pageHeight - 6);
            doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin - 20, pageHeight - 6);
          }
          
          // Download
          const filename = `MissionPulse-Report-${new Date().toISOString().split('T')[0]}.pdf`;
          doc.save(filename);
          
          onClose();
        } catch (error) {
          console.error('PDF generation error:', error);
          alert('Failed to generate PDF. Please try again.');
        } finally {
          setGenerating(false);
        }
      };
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/60" onClick={onClose} />
          <div className="relative bg-slate-900 rounded-xl border border-slate-700 shadow-2xl w-full max-w-md p-6 animate-fade-in">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-semibold text-white flex items-center gap-2">
                <Icon name="file" className="w-5 h-5 text-cyan-400" />
                Generate Pipeline Report
              </h2>
              <button onClick={onClose} className="p-1 hover:bg-slate-800 rounded-lg transition-colors">
                <Icon name="x" className="w-5 h-5 text-slate-400" />
              </button>
            </div>
            
            <div className="space-y-3 mb-6">
              <p className="text-sm text-slate-400 mb-4">Select sections to include:</p>
              
              {[
                { key: 'executiveSummary', label: 'Executive Summary' },
                { key: 'pipelineByPhase', label: 'Pipeline by Phase' },
                { key: 'priorityBreakdown', label: 'Priority Breakdown' },
                { key: 'upcomingDueDates', label: 'Upcoming Due Dates' },
                { key: 'detailsTable', label: 'Opportunity Details Table' }
              ].map(section => (
                <label key={section.key} className="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800 transition-colors">
                  <input
                    type="checkbox"
                    checked={sections[section.key]}
                    onChange={() => toggleSection(section.key)}
                    className="custom-checkbox"
                  />
                  <span className="text-white">{section.label}</span>
                </label>
              ))}
            </div>
            
            <button
              onClick={generatePDF}
              disabled={generating}
              className="w-full py-3 bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 text-white font-semibold rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {generating ? (
                <>
                  <Icon name="loader" className="w-5 h-5" />
                  Generating...
                </>
              ) : (
                <>
                  <Icon name="download" className="w-5 h-5" />
                  Generate PDF
                </>
              )}
            </button>
          </div>
        </div>
      );
    };

    // ============================================================
    // SETTINGS PANEL - Task 16.4
    // ============================================================
    const SettingsPanel = ({ isOpen, onClose, settings, onUpdateSettings, onExportData, onClearStorage, onResetDefaults }) => {
      const [showConfirmClear, setShowConfirmClear] = useState(false);
      const [showConfirmReset, setShowConfirmReset] = useState(false);
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-40">
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <div className="absolute right-0 top-0 h-full w-[400px] bg-slate-900 border-l border-slate-700 animate-slide-in-right flex flex-col">
            {/* Header */}
            <div className="p-4 border-b border-slate-700 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="settings" className="w-5 h-5 text-cyan-400" />
                <h2 className="text-lg font-semibold text-white">Settings</h2>
              </div>
              <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <Icon name="x" className="w-5 h-5 text-slate-400" />
              </button>
            </div>
            
            {/* Settings Content */}
            <div className="flex-1 overflow-y-auto p-4 space-y-6">
              {/* Display Preferences */}
              <section>
                <h3 className="text-sm font-semibold text-cyan-400 uppercase tracking-wider mb-3">Display Preferences</h3>
                <div className="space-y-4">
                  {/* Default View */}
                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">Default View</label>
                    <select
                      value={settings.display.defaultView}
                      onChange={(e) => onUpdateSettings({ ...settings, display: { ...settings.display, defaultView: e.target.value } })}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-cyan-500"
                    >
                      <option value="board">Board</option>
                      <option value="table">Table</option>
                      <option value="calendar">Calendar</option>
                      <option value="dashboard">Dashboard</option>
                    </select>
                  </div>
                  
                  {/* Cards Per Row */}
                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">Cards Per Row (Board View)</label>
                    <select
                      value={settings.display.cardsPerRow}
                      onChange={(e) => onUpdateSettings({ ...settings, display: { ...settings.display, cardsPerRow: e.target.value } })}
                      className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-cyan-500"
                    >
                      <option value="auto">Auto</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                    </select>
                  </div>
                  
                  {/* Toggle: Show pWin Bars */}
                  <label className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg cursor-pointer">
                    <span className="text-sm text-white">Show Win Probability bars on cards</span>
                    <input
                      type="checkbox"
                      checked={settings.display.showPwinBars}
                      onChange={(e) => onUpdateSettings({ ...settings, display: { ...settings.display, showPwinBars: e.target.checked } })}
                      className="custom-checkbox"
                    />
                  </label>
                  
                  {/* Toggle: Compact Mode */}
                  <label className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg cursor-pointer">
                    <span className="text-sm text-white">Compact mode (reduced padding)</span>
                    <input
                      type="checkbox"
                      checked={settings.display.compactMode}
                      onChange={(e) => onUpdateSettings({ ...settings, display: { ...settings.display, compactMode: e.target.checked } })}
                      className="custom-checkbox"
                    />
                  </label>
                </div>
              </section>
              
              {/* Notification Preferences */}
              <section>
                <h3 className="text-sm font-semibold text-cyan-400 uppercase tracking-wider mb-3">Notification Preferences</h3>
                <div className="space-y-4">
                  {/* Due Date Alerts */}
                  <label className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg cursor-pointer">
                    <span className="text-sm text-white">Enable due date alerts</span>
                    <input
                      type="checkbox"
                      checked={settings.notifications.dueDateAlerts}
                      onChange={(e) => onUpdateSettings({ ...settings, notifications: { ...settings.notifications, dueDateAlerts: e.target.checked } })}
                      className="custom-checkbox"
                    />
                  </label>
                  
                  {settings.notifications.dueDateAlerts && (
                    <div>
                      <label className="text-sm text-slate-400 mb-2 block">Due date warning threshold</label>
                      <select
                        value={settings.notifications.dueDateThreshold}
                        onChange={(e) => onUpdateSettings({ ...settings, notifications: { ...settings.notifications, dueDateThreshold: parseInt(e.target.value) } })}
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-cyan-500"
                      >
                        {[1, 2, 3, 5, 7].map(d => (
                          <option key={d} value={d}>{d} day{d > 1 ? 's' : ''} before due</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  {/* P-0 Alerts */}
                  <label className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg cursor-pointer">
                    <span className="text-sm text-white">Enable P-0 alerts</span>
                    <input
                      type="checkbox"
                      checked={settings.notifications.p0Alerts}
                      onChange={(e) => onUpdateSettings({ ...settings, notifications: { ...settings.notifications, p0Alerts: e.target.checked } })}
                      className="custom-checkbox"
                    />
                  </label>
                  
                  {/* Phase Stuck Alerts */}
                  <label className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg cursor-pointer">
                    <span className="text-sm text-white">Enable phase stuck alerts</span>
                    <input
                      type="checkbox"
                      checked={settings.notifications.phaseStuckAlerts}
                      onChange={(e) => onUpdateSettings({ ...settings, notifications: { ...settings.notifications, phaseStuckAlerts: e.target.checked } })}
                      className="custom-checkbox"
                    />
                  </label>
                  
                  {settings.notifications.phaseStuckAlerts && (
                    <div>
                      <label className="text-sm text-slate-400 mb-2 block">Phase stuck threshold</label>
                      <select
                        value={settings.notifications.phaseStuckThreshold}
                        onChange={(e) => onUpdateSettings({ ...settings, notifications: { ...settings.notifications, phaseStuckThreshold: parseInt(e.target.value) } })}
                        className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-cyan-500"
                      >
                        {[7, 14, 21, 30].map(d => (
                          <option key={d} value={d}>{d} days in same phase</option>
                        ))}
                      </select>
                    </div>
                  )}
                </div>
              </section>
              
              {/* Data & Privacy */}
              <section>
                <h3 className="text-sm font-semibold text-cyan-400 uppercase tracking-wider mb-3">Data & Privacy</h3>
                <div className="space-y-3">
                  <button
                    onClick={onExportData}
                    className="w-full p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white text-sm font-medium flex items-center gap-2 transition-colors"
                  >
                    <Icon name="download" className="w-4 h-4 text-cyan-400" />
                    Export all data (JSON)
                  </button>
                  
                  <button
                    onClick={() => setShowConfirmClear(true)}
                    className="w-full p-3 bg-slate-800 hover:bg-red-500/20 border border-transparent hover:border-red-500/30 rounded-lg text-slate-300 hover:text-red-400 text-sm font-medium flex items-center gap-2 transition-colors"
                  >
                    <Icon name="trash" className="w-4 h-4" />
                    Clear local storage
                  </button>
                  
                  <button
                    onClick={() => setShowConfirmReset(true)}
                    className="w-full p-3 bg-slate-800 hover:bg-amber-500/20 border border-transparent hover:border-amber-500/30 rounded-lg text-slate-300 hover:text-amber-400 text-sm font-medium flex items-center gap-2 transition-colors"
                  >
                    <Icon name="refresh" className="w-4 h-4" />
                    Reset to defaults
                  </button>
                </div>
              </section>
            </div>
            
            {/* Confirmation Dialogs */}
            {showConfirmClear && (
              <div className="absolute inset-0 bg-black/60 flex items-center justify-center p-4">
                <div className="bg-slate-800 rounded-xl p-6 max-w-sm">
                  <h3 className="text-lg font-semibold text-white mb-2">Clear Local Storage?</h3>
                  <p className="text-sm text-slate-400 mb-4">This will clear all saved preferences, filter presets, and cached data. This action cannot be undone.</p>
                  <div className="flex gap-3">
                    <button onClick={() => setShowConfirmClear(false)} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors">Cancel</button>
                    <button onClick={() => { onClearStorage(); setShowConfirmClear(false); }} className="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-white transition-colors">Clear</button>
                  </div>
                </div>
              </div>
            )}
            
            {showConfirmReset && (
              <div className="absolute inset-0 bg-black/60 flex items-center justify-center p-4">
                <div className="bg-slate-800 rounded-xl p-6 max-w-sm">
                  <h3 className="text-lg font-semibold text-white mb-2">Reset to Defaults?</h3>
                  <p className="text-sm text-slate-400 mb-4">This will reset all settings to their default values. Your data will not be affected.</p>
                  <div className="flex gap-3">
                    <button onClick={() => setShowConfirmReset(false)} className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors">Cancel</button>
                    <button onClick={() => { onResetDefaults(); setShowConfirmReset(false); }} className="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 rounded-lg text-white transition-colors">Reset</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================
    // DELETE CONFIRMATION MODAL
    // ============================================================
    const DeleteConfirmModal = ({ isOpen, onClose, onConfirm, count }) => {
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/60" onClick={onClose} />
          <div className="relative bg-slate-900 rounded-xl border border-slate-700 shadow-2xl w-full max-w-sm p-6 animate-fade-in">
            <div className="text-center">
              <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <Icon name="trash" className="w-8 h-8 text-red-400" />
              </div>
              <h2 className="text-xl font-semibold text-white mb-2">Delete {count} Opportunit{count === 1 ? 'y' : 'ies'}?</h2>
              <p className="text-slate-400 mb-6">This action cannot be undone. All selected opportunities will be permanently deleted.</p>
              <div className="flex gap-3">
                <button onClick={onClose} className="flex-1 px-4 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-white font-medium transition-colors">Cancel</button>
                <button onClick={onConfirm} className="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 rounded-lg text-white font-medium transition-colors">Delete</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // NOTIFICATION CENTER (from Sprint 15)
    // ============================================================
    const NotificationCenter = ({ isOpen, onClose, notifications, onDismiss, onClickNotification }) => {
      const [filterTab, setFilterTab] = useState('all');
      
      const filteredNotifications = useMemo(() => {
        if (filterTab === 'all') return notifications;
        return notifications.filter(n => n.type === filterTab);
      }, [notifications, filterTab]);
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-40">
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <div className="absolute right-0 top-0 h-full w-[360px] bg-slate-900 border-l border-slate-700 animate-slide-in-right flex flex-col">
            <div className="p-4 border-b border-slate-700 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Icon name="bell" className="w-5 h-5 text-cyan-400" />
                <h2 className="text-lg font-semibold text-white">Notifications</h2>
              </div>
              <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                <Icon name="x" className="w-5 h-5 text-slate-400" />
              </button>
            </div>
            
            <div className="px-4 py-2 border-b border-slate-700 flex gap-1">
              {[
                { key: 'all', label: 'All' },
                { key: 'due_soon', label: 'Due Soon' },
                { key: 'p0_alert', label: 'Critical' }
              ].map(tab => (
                <button
                  key={tab.key}
                  onClick={() => setFilterTab(tab.key)}
                  className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                    filterTab === tab.key ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-slate-400 hover:text-white hover:bg-slate-800'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {filteredNotifications.length === 0 ? (
                <div className="text-center text-slate-500 py-8">
                  <Icon name="bell" className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>No notifications</p>
                </div>
              ) : (
                filteredNotifications.map(notif => (
                  <div
                    key={notif.id}
                    className={`p-3 rounded-lg border cursor-pointer transition-colors ${
                      notif.read ? 'bg-slate-800/30 border-slate-700/50' : 'bg-slate-800/70 border-cyan-500/30'
                    }`}
                    onClick={() => onClickNotification(notif)}
                  >
                    <div className="flex items-start justify-between gap-2">
                      <div className="flex-1">
                        <p className={`font-medium ${notif.read ? 'text-slate-400' : 'text-white'}`}>{notif.title}</p>
                        <p className="text-sm text-slate-500 mt-0.5">{notif.message}</p>
                        <p className="text-xs text-slate-600 mt-1">{formatRelativeTime(notif.created_at)}</p>
                      </div>
                      <button
                        onClick={(e) => { e.stopPropagation(); onDismiss(notif.id); }}
                        className="p-1 hover:bg-slate-700 rounded transition-colors"
                      >
                        <Icon name="x" className="w-4 h-4 text-slate-500" />
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // COMMAND PALETTE (from Sprint 15)
    // ============================================================
    const CommandPalette = ({ isOpen, onClose, opportunities, onNavigate, onAction }) => {
      const [query, setQuery] = useState('');
      const [selectedIndex, setSelectedIndex] = useState(0);
      const inputRef = useRef(null);
      
      useEffect(() => {
        if (isOpen) {
          setQuery('');
          setSelectedIndex(0);
          setTimeout(() => inputRef.current?.focus(), 100);
        }
      }, [isOpen]);
      
      const results = useMemo(() => {
        const items = [];
        const q = query.toLowerCase();
        
        // Quick Actions
        const actions = [
          { type: 'action', id: 'new', label: 'Create New Opportunity', icon: 'plus', action: () => onAction('create') },
          { type: 'action', id: 'board', label: 'Switch to Board View', icon: 'grid', action: () => onAction('view', 'board') },
          { type: 'action', id: 'table', label: 'Switch to Table View', icon: 'list', action: () => onAction('view', 'table') },
          { type: 'action', id: 'calendar', label: 'Switch to Calendar View', icon: 'calendar', action: () => onAction('view', 'calendar') },
          { type: 'action', id: 'dashboard', label: 'Switch to Dashboard', icon: 'chart', action: () => onAction('view', 'dashboard') },
          { type: 'action', id: 'export', label: 'Export PDF Report', icon: 'download', action: () => onAction('export') },
        ];
        
        actions.forEach(a => {
          if (!q || a.label.toLowerCase().includes(q)) items.push(a);
        });
        
        // Opportunities
        if (q.length >= 2) {
          opportunities
            .filter(o => o.name?.toLowerCase().includes(q) || o.agency?.toLowerCase().includes(q))
            .slice(0, 5)
            .forEach(o => {
              items.push({
                type: 'opportunity',
                id: o.id,
                label: o.name,
                sublabel: `${o.agency} â€¢ ${getPhaseInfo(o.shipleyPhase).name}`,
                icon: 'file',
                action: () => onNavigate(o)
              });
            });
        }
        
        return items;
      }, [query, opportunities, onAction, onNavigate]);
      
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (!isOpen) return;
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            setSelectedIndex(i => Math.min(i + 1, results.length - 1));
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            setSelectedIndex(i => Math.max(i - 1, 0));
          } else if (e.key === 'Enter' && results[selectedIndex]) {
            e.preventDefault();
            results[selectedIndex].action();
            onClose();
          } else if (e.key === 'Escape') {
            onClose();
          }
        };
        
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [isOpen, results, selectedIndex, onClose]);
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 z-50 flex items-start justify-center pt-[15vh]">
          <div className="absolute inset-0 bg-black/60" onClick={onClose} />
          <div className="relative bg-slate-900 rounded-xl border border-slate-700 shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in">
            <div className="flex items-center gap-3 p-4 border-b border-slate-700">
              <Icon name="search" className="w-5 h-5 text-slate-400" />
              <input
                ref={inputRef}
                type="text"
                value={query}
                onChange={(e) => { setQuery(e.target.value); setSelectedIndex(0); }}
                placeholder="Search opportunities or type a command..."
                className="flex-1 bg-transparent text-white placeholder-slate-500 outline-none text-sm"
              />
              <kbd className="px-2 py-1 bg-slate-800 rounded text-xs text-slate-500">ESC</kbd>
            </div>
            
            <div className="max-h-80 overflow-y-auto p-2">
              {results.length === 0 ? (
                <div className="text-center text-slate-500 py-8">No results found</div>
              ) : (
                results.map((item, index) => (
                  <button
                    key={item.id}
                    onClick={() => { item.action(); onClose(); }}
                    className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors ${
                      index === selectedIndex ? 'bg-cyan-500/20 text-white' : 'text-slate-300 hover:bg-slate-800'
                    }`}
                  >
                    <Icon name={item.icon} className={`w-5 h-5 ${index === selectedIndex ? 'text-cyan-400' : 'text-slate-500'}`} />
                    <div className="flex-1 text-left">
                      <p className="font-medium">{item.label}</p>
                      {item.sublabel && <p className="text-xs text-slate-500">{item.sublabel}</p>}
                    </div>
                    {item.type === 'action' && (
                      <span className="text-xs text-slate-600">Action</span>
                    )}
                  </button>
                ))
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // OPPORTUNITY CARD
    // ============================================================
    const OpportunityCard = ({ opportunity, isSelected, onSelect, onShiftSelect, onClick, showPwinBars, compact }) => {
      const phase = getPhaseInfo(opportunity.shipleyPhase);
      const daysRemaining = getDaysRemaining(opportunity.dueDate);
      const isOverdue = daysRemaining !== null && daysRemaining < 0;
      const isDueSoon = daysRemaining !== null && daysRemaining <= 3 && daysRemaining >= 0;
      
      const handleClick = (e) => {
        if (e.shiftKey) {
          onShiftSelect(opportunity.id);
        } else if (e.target.type === 'checkbox' || e.target.closest('.checkbox-wrapper')) {
          // Handled by checkbox
        } else {
          onClick(opportunity);
        }
      };
      
      return (
        <div
          onClick={handleClick}
          className={`relative bg-slate-800/50 rounded-xl border transition-all cursor-pointer hover:shadow-lg ${
            isSelected ? 'border-cyan-500 ring-2 ring-cyan-500/30' : 'border-slate-700/50 hover:border-slate-600'
          } ${compact ? 'p-3' : 'p-4'}`}
        >
          {/* Checkbox */}
          <div className="checkbox-wrapper absolute top-3 left-3" onClick={(e) => e.stopPropagation()}>
            <input
              type="checkbox"
              checked={isSelected}
              onChange={(e) => onSelect(opportunity.id, e.target.checked)}
              className="custom-checkbox"
            />
          </div>
          
          {/* Phase Indicator */}
          <div className="absolute top-0 right-4 h-1 w-16 rounded-b-full" style={{ backgroundColor: phase.color }} />
          
          <div className={compact ? 'pl-6' : 'pl-8'}>
            {/* Priority Badge */}
            <div className="flex items-center gap-2 mb-2">
              <span
                className="px-2 py-0.5 rounded text-xs font-semibold"
                style={{ backgroundColor: `${getPriorityColor(opportunity.priority)}20`, color: getPriorityColor(opportunity.priority) }}
              >
                {opportunity.priority}
              </span>
              <span className="text-xs text-slate-500">{phase.name}</span>
            </div>
            
            {/* Title */}
            <h3 className={`font-semibold text-white mb-1 line-clamp-2 ${compact ? 'text-sm' : ''}`}>{opportunity.name}</h3>
            
            {/* Agency & Value */}
            <div className="flex items-center gap-2 text-sm text-slate-400 mb-2">
              <span>{opportunity.agency}</span>
              <span className="w-1 h-1 rounded-full bg-slate-600" />
              <span className="text-cyan-400 font-medium">{formatCurrency(opportunity.contractValue)}</span>
            </div>
            
            {/* Due Date */}
            {opportunity.dueDate && (
              <div className={`flex items-center gap-1 text-xs ${isOverdue ? 'text-red-400' : isDueSoon ? 'text-amber-400' : 'text-slate-500'}`}>
                <Icon name="clock" className="w-3 h-3" />
                <span>{formatDate(opportunity.dueDate)}</span>
                {daysRemaining !== null && (
                  <span className="ml-1">
                    ({isOverdue ? `${Math.abs(daysRemaining)}d overdue` : `${daysRemaining}d left`})
                  </span>
                )}
              </div>
            )}
            
            {/* pWin Bar */}
            {showPwinBars && (
              <div className="mt-3">
                <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
                  <span>Win Probability</span>
                  <span className="text-cyan-400 font-medium">{opportunity.winProbability || 0}%</span>
                </div>
                <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-gradient-to-r from-cyan-500 to-cyan-400 rounded-full transition-all"
                    style={{ width: `${opportunity.winProbability || 0}%` }}
                  />
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================================
    // MAIN APP
    // ============================================================
    const App = () => {
      // State
      const [opportunities, setOpportunities] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [view, setView] = useState('board');
      const [theme, setTheme] = useState('dark');
      const [toast, setToast] = useState(null);
      
      // Settings
      const [settings, setSettings] = useState(() => {
        const saved = localStorage.getItem('MP_SETTINGS');
        return saved ? JSON.parse(saved) : DEFAULT_SETTINGS;
      });
      
      // Filters
      const [filters, setFilters] = useState({
        search: '',
        agencies: [],
        priorities: [],
        phases: [],
        pWinMin: 0,
        pWinMax: 100,
        dueDateStart: null,
        dueDateEnd: null
      });
      
      // Selection state
      const [selectedIds, setSelectedIds] = useState(new Set());
      const [lastSelectedId, setLastSelectedId] = useState(null);
      
      // Panels
      const [showActivityLog, setShowActivityLog] = useState(false);
      const [showNotifications, setShowNotifications] = useState(false);
      const [showCommandPalette, setShowCommandPalette] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showPDFExport, setShowPDFExport] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      
      // Activity Log state
      const [activities, setActivities] = useState([]);
      const [activitiesLoading, setActivitiesLoading] = useState(false);
      const [activitiesPage, setActivitiesPage] = useState(0);
      const [hasMoreActivities, setHasMoreActivities] = useState(true);
      const [activityCount24h, setActivityCount24h] = useState(0);
      
      // Notifications state
      const [notifications, setNotifications] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      
      // Stats
      const [stats, setStats] = useState(null);
      
      // -------------------- DATA LOADING --------------------
      
      // Load opportunities
      const loadOpportunities = useCallback(async () => {
        try {
          setLoading(true);
          const { data, error } = await supabase
            .from('opportunities')
            .select('*')
            .order('due_date', { ascending: true });
          
          if (error) throw error;
          
          const mapped = (data || []).map(mapToFrontend);
          setOpportunities(mapped);
          
          // Calculate stats
          const totalValue = mapped.reduce((sum, o) => sum + (o.contractValue || 0), 0);
          const avgPwin = mapped.length > 0
            ? Math.round(mapped.reduce((sum, o) => sum + (o.winProbability || 0), 0) / mapped.length)
            : 0;
          const now = new Date();
          const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          const dueThisMonth = mapped.filter(o => {
            if (!o.dueDate) return false;
            const due = new Date(o.dueDate);
            return due >= now && due <= monthEnd;
          }).length;
          
          setStats({ totalValue, avgPwin, dueThisMonth });
          
        } catch (err) {
          console.error('Error loading opportunities:', err);
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }, []);
      
      // Load activities
      const loadActivities = useCallback(async (reset = false) => {
        try {
          setActivitiesLoading(true);
          const page = reset ? 0 : activitiesPage;
          const limit = 20;
          
          const { data, error } = await supabase
            .from('activity_log')
            .select('*')
            .order('created_at', { ascending: false })
            .range(page * limit, (page + 1) * limit - 1);
          
          if (error) throw error;
          
          if (reset) {
            setActivities(data || []);
            setActivitiesPage(0);
          } else {
            setActivities(prev => [...prev, ...(data || [])]);
          }
          
          setHasMoreActivities((data || []).length === limit);
          
        } catch (err) {
          console.error('Error loading activities:', err);
        } finally {
          setActivitiesLoading(false);
        }
      }, [activitiesPage]);
      
      // Load activity count for badge
      const loadActivityCount = useCallback(async () => {
        try {
          const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
          const { count, error } = await supabase
            .from('activity_log')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', yesterday);
          
          if (!error) setActivityCount24h(count || 0);
        } catch (err) {
          console.error('Error loading activity count:', err);
        }
      }, []);
      
      // Generate notifications from opportunities
      const generateNotifications = useCallback(() => {
        const notifs = [];
        const now = new Date();
        
        opportunities.forEach(opp => {
          const days = getDaysRemaining(opp.dueDate);
          
          // Due soon notifications
          if (settings.notifications.dueDateAlerts && days !== null && days <= settings.notifications.dueDateThreshold && days >= 0) {
            notifs.push({
              id: `due-${opp.id}`,
              type: 'due_soon',
              title: 'Due Soon',
              message: `${opp.name} is due in ${days} day${days === 1 ? '' : 's'}`,
              opportunity_id: opp.id,
              created_at: now.toISOString(),
              read: false
            });
          }
          
          // P-0 alerts
          if (settings.notifications.p0Alerts && opp.priority === 'P-0') {
            notifs.push({
              id: `p0-${opp.id}`,
              type: 'p0_alert',
              title: 'Critical Priority',
              message: `${opp.name} is marked as P-0 Critical`,
              opportunity_id: opp.id,
              created_at: now.toISOString(),
              read: false
            });
          }
        });
        
        // Load read state from localStorage
        const readState = JSON.parse(localStorage.getItem('MP_NOTIFICATIONS') || '{}');
        notifs.forEach(n => {
          if (readState[n.id]) n.read = true;
        });
        
        setNotifications(notifs);
        setUnreadCount(notifs.filter(n => !n.read).length);
      }, [opportunities, settings.notifications]);
      
      // Initial load
      useEffect(() => {
        loadOpportunities();
        loadActivityCount();
      }, [loadOpportunities, loadActivityCount]);
      
      // Generate notifications when opportunities or settings change
      useEffect(() => {
        generateNotifications();
      }, [generateNotifications]);
      
      // Real-time subscription
      useEffect(() => {
        const channel = supabase
          .channel('opportunities-changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'opportunities' }, () => {
            loadOpportunities();
          })
          .subscribe();
        
        return () => {
          supabase.removeChannel(channel);
        };
      }, [loadOpportunities]);
      
      // Keyboard shortcuts
      useEffect(() => {
        const handleKeyDown = (e) => {
          // Don't trigger in inputs
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
          
          // Cmd/Ctrl + K for Command Palette
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            setShowCommandPalette(true);
          }
          
          // Escape to clear selection
          if (e.key === 'Escape' && selectedIds.size > 0) {
            setSelectedIds(new Set());
          }
        };
        
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [selectedIds]);
      
      // Save settings to localStorage
      useEffect(() => {
        localStorage.setItem('MP_SETTINGS', JSON.stringify(settings));
      }, [settings]);
      
      // Apply default view from settings
      useEffect(() => {
        if (settings.display.defaultView) {
          setView(settings.display.defaultView);
        }
      }, []);
      
      // -------------------- HANDLERS --------------------
      
      // Selection handlers
      const handleSelect = (id, isSelected) => {
        setSelectedIds(prev => {
          const next = new Set(prev);
          if (isSelected) {
            next.add(id);
          } else {
            next.delete(id);
          }
          return next;
        });
        setLastSelectedId(id);
      };
      
      const handleShiftSelect = (id) => {
        if (!lastSelectedId) {
          handleSelect(id, true);
          return;
        }
        
        const sortedOpps = filteredOpportunities;
        const lastIndex = sortedOpps.findIndex(o => o.id === lastSelectedId);
        const currentIndex = sortedOpps.findIndex(o => o.id === id);
        
        if (lastIndex === -1 || currentIndex === -1) {
          handleSelect(id, true);
          return;
        }
        
        const start = Math.min(lastIndex, currentIndex);
        const end = Math.max(lastIndex, currentIndex);
        
        setSelectedIds(prev => {
          const next = new Set(prev);
          for (let i = start; i <= end; i++) {
            next.add(sortedOpps[i].id);
          }
          return next;
        });
      };
      
      const handleSelectAll = (isSelected) => {
        if (isSelected) {
          setSelectedIds(new Set(filteredOpportunities.map(o => o.id)));
        } else {
          setSelectedIds(new Set());
        }
      };
      
      const clearSelection = () => {
        setSelectedIds(new Set());
        setLastSelectedId(null);
      };
      
      // Bulk operations
      const handleBulkPhaseChange = async (newPhase) => {
        const ids = Array.from(selectedIds);
        const oldOpps = opportunities.filter(o => ids.includes(o.id));
        
        // Optimistic update
        setOpportunities(prev => prev.map(o =>
          ids.includes(o.id) ? { ...o, shipleyPhase: newPhase } : o
        ));
        
        try {
          const { error } = await supabase
            .from('opportunities')
            .update({ shipley_phase: newPhase })
            .in('id', ids);
          
          if (error) throw error;
          
          // Log activity
          for (const opp of oldOpps) {
            await supabase.from('activity_log').insert({
              opportunity_id: opp.id,
              opportunity_name: opp.name,
              action_type: 'phase_changed',
              description: `Bulk phase change`,
              old_value: getPhaseInfo(opp.shipleyPhase).name,
              new_value: getPhaseInfo(newPhase).name
            });
          }
          
          setToast({ message: `Updated ${ids.length} opportunities`, type: 'success' });
          clearSelection();
          loadActivityCount();
          
        } catch (err) {
          console.error('Bulk phase change error:', err);
          // Rollback
          setOpportunities(prev => prev.map(o => {
            const old = oldOpps.find(oo => oo.id === o.id);
            return old ? old : o;
          }));
          setToast({ message: 'Failed to update opportunities', type: 'error' });
        }
      };
      
      const handleBulkPriorityChange = async (newPriority) => {
        const ids = Array.from(selectedIds);
        const oldOpps = opportunities.filter(o => ids.includes(o.id));
        
        // Optimistic update
        setOpportunities(prev => prev.map(o =>
          ids.includes(o.id) ? { ...o, priority: newPriority } : o
        ));
        
        try {
          const { error } = await supabase
            .from('opportunities')
            .update({ priority: newPriority })
            .in('id', ids);
          
          if (error) throw error;
          
          // Log activity
          for (const opp of oldOpps) {
            await supabase.from('activity_log').insert({
              opportunity_id: opp.id,
              opportunity_name: opp.name,
              action_type: 'updated',
              description: `Bulk priority change`,
              old_value: opp.priority,
              new_value: newPriority
            });
          }
          
          setToast({ message: `Updated ${ids.length} opportunities`, type: 'success' });
          clearSelection();
          loadActivityCount();
          
        } catch (err) {
          console.error('Bulk priority change error:', err);
          setOpportunities(prev => prev.map(o => {
            const old = oldOpps.find(oo => oo.id === o.id);
            return old ? old : o;
          }));
          setToast({ message: 'Failed to update opportunities', type: 'error' });
        }
      };
      
      const handleBulkDelete = async () => {
        const ids = Array.from(selectedIds);
        const deletedOpps = opportunities.filter(o => ids.includes(o.id));
        
        // Optimistic update
        setOpportunities(prev => prev.filter(o => !ids.includes(o.id)));
        setShowDeleteConfirm(false);
        
        setToast({
          message: `Deleted ${ids.length} opportunities`,
          type: 'success',
          action: {
            label: 'Undo',
            onClick: async () => {
              // Restore
              for (const opp of deletedOpps) {
                await supabase.from('opportunities').insert(mapToDatabase(opp));
              }
              loadOpportunities();
              setToast({ message: 'Restored opportunities', type: 'success' });
            }
          }
        });
        
        try {
          const { error } = await supabase
            .from('opportunities')
            .delete()
            .in('id', ids);
          
          if (error) throw error;
          
          // Log activity
          for (const opp of deletedOpps) {
            await supabase.from('activity_log').insert({
              opportunity_id: opp.id,
              opportunity_name: opp.name,
              action_type: 'deleted',
              description: `Opportunity deleted (bulk operation)`
            });
          }
          
          clearSelection();
          loadActivityCount();
          
        } catch (err) {
          console.error('Bulk delete error:', err);
          // Rollback
          for (const opp of deletedOpps) {
            await supabase.from('opportunities').insert(mapToDatabase(opp));
          }
          loadOpportunities();
          setToast({ message: 'Failed to delete opportunities', type: 'error' });
        }
      };
      
      // Activity log handlers
      const handleActivityLoadMore = () => {
        setActivitiesPage(prev => prev + 1);
        loadActivities(false);
      };
      
      const handleActivityExport = (format) => {
        const data = activities.map(a => ({
          id: a.id,
          opportunity: a.opportunity_name,
          action: a.action_type,
          description: a.description,
          old_value: a.old_value,
          new_value: a.new_value,
          timestamp: a.created_at
        }));
        
        if (format === 'json') {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `activity-log-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
        } else if (format === 'csv') {
          const headers = ['ID', 'Opportunity', 'Action', 'Description', 'Old Value', 'New Value', 'Timestamp'];
          const rows = data.map(d => [d.id, d.opportunity, d.action, d.description, d.old_value, d.new_value, d.timestamp]);
          const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `activity-log-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
        }
        
        setToast({ message: `Exported as ${format.toUpperCase()}`, type: 'success' });
      };
      
      // Notification handlers
      const handleNotificationDismiss = (id) => {
        const readState = JSON.parse(localStorage.getItem('MP_NOTIFICATIONS') || '{}');
        readState[id] = true;
        localStorage.setItem('MP_NOTIFICATIONS', JSON.stringify(readState));
        
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
        setUnreadCount(prev => Math.max(0, prev - 1));
      };
      
      // Settings handlers
      const handleUpdateSettings = (newSettings) => {
        setSettings(newSettings);
      };
      
      const handleExportData = () => {
        const data = {
          opportunities,
          settings,
          exportedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `missionpulse-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        setToast({ message: 'Data exported successfully', type: 'success' });
      };
      
      const handleClearStorage = () => {
        const keys = Object.keys(localStorage).filter(k => k.startsWith('MP_'));
        keys.forEach(k => localStorage.removeItem(k));
        setSettings(DEFAULT_SETTINGS);
        setToast({ message: 'Local storage cleared', type: 'success' });
      };
      
      const handleResetDefaults = () => {
        setSettings(DEFAULT_SETTINGS);
        setToast({ message: 'Settings reset to defaults', type: 'success' });
      };
      
      // Command palette actions
      const handleCommandAction = (action, value) => {
        if (action === 'view') {
          setView(value);
        } else if (action === 'export') {
          setShowPDFExport(true);
        } else if (action === 'create') {
          // TODO: Open create modal
          setToast({ message: 'Create opportunity coming soon', type: 'info' });
        }
      };
      
      // Filter opportunities
      const filteredOpportunities = useMemo(() => {
        return opportunities.filter(opp => {
          // Search
          if (filters.search) {
            const q = filters.search.toLowerCase();
            if (!opp.name?.toLowerCase().includes(q) && !opp.agency?.toLowerCase().includes(q)) {
              return false;
            }
          }
          
          // Agencies
          if (filters.agencies.length > 0 && !filters.agencies.includes(opp.agency)) {
            return false;
          }
          
          // Priorities
          if (filters.priorities.length > 0 && !filters.priorities.includes(opp.priority)) {
            return false;
          }
          
          // Phases
          if (filters.phases.length > 0 && !filters.phases.includes(opp.shipleyPhase)) {
            return false;
          }
          
          // pWin range
          const pwin = opp.winProbability || 0;
          if (pwin < filters.pWinMin || pwin > filters.pWinMax) {
            return false;
          }
          
          return true;
        });
      }, [opportunities, filters]);
      
      // Group by phase for board view
      const opportunitiesByPhase = useMemo(() => {
        const grouped = {};
        SHIPLEY_PHASES.forEach(p => {
          grouped[p.key] = filteredOpportunities.filter(o => o.shipleyPhase === p.key);
        });
        return grouped;
      }, [filteredOpportunities]);
      
      // -------------------- RENDER --------------------
      
      return (
        <div className={`min-h-screen ${theme === 'light' ? 'light-theme' : ''}`}>
          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur border-b border-slate-700/50">
            <div className="px-6 py-3 flex items-center justify-between">
              {/* Logo */}
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 bg-gradient-to-br from-cyan-400 to-cyan-600 rounded-lg flex items-center justify-center">
                  <Icon name="shield" className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h1 className="text-lg font-bold text-white">MissionPulse</h1>
                  <p className="text-[10px] text-slate-500 -mt-0.5">Sprint 16</p>
                </div>
              </div>
              
              {/* Search */}
              <div className="flex-1 max-w-md mx-8">
                <div className="relative">
                  <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                  <input
                    type="text"
                    value={filters.search}
                    onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                    placeholder="Search opportunities... (âŒ˜K)"
                    onClick={() => setShowCommandPalette(true)}
                    className="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500 transition-colors"
                  />
                </div>
              </div>
              
              {/* Actions */}
              <div className="flex items-center gap-2">
                {/* View Switcher */}
                <div className="flex bg-slate-800 rounded-lg p-1">
                  {[
                    { key: 'board', icon: 'grid' },
                    { key: 'table', icon: 'list' },
                    { key: 'calendar', icon: 'calendar' },
                    { key: 'dashboard', icon: 'chart' }
                  ].map(v => (
                    <button
                      key={v.key}
                      onClick={() => setView(v.key)}
                      className={`p-2 rounded-md transition-colors ${
                        view === v.key ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white'
                      }`}
                    >
                      <Icon name={v.icon} className="w-4 h-4" />
                    </button>
                  ))}
                </div>
                
                <div className="w-px h-6 bg-slate-700" />
                
                {/* Export Dropdown */}
                <div className="relative group">
                  <button className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                    <Icon name="download" className="w-5 h-5 text-slate-400" />
                  </button>
                  <div className="absolute right-0 top-full mt-1 hidden group-hover:block bg-slate-800 rounded-lg border border-slate-700 shadow-xl py-1 min-w-[160px]">
                    <button onClick={() => handleActivityExport('csv')} className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Export CSV</button>
                    <button onClick={() => setShowPDFExport(true)} className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Export PDF Report</button>
                  </div>
                </div>
                
                {/* Activity Log */}
                <button
                  onClick={() => { setShowActivityLog(true); loadActivities(true); }}
                  className="relative p-2 hover:bg-slate-800 rounded-lg transition-colors"
                >
                  <Icon name="activity" className="w-5 h-5 text-slate-400" />
                  {activityCount24h > 0 && (
                    <span className="absolute -top-0.5 -right-0.5 w-4 h-4 bg-cyan-500 rounded-full text-[10px] font-bold text-white flex items-center justify-center">
                      {activityCount24h > 9 ? '9+' : activityCount24h}
                    </span>
                  )}
                </button>
                
                {/* Notifications */}
                <button
                  onClick={() => setShowNotifications(true)}
                  className="relative p-2 hover:bg-slate-800 rounded-lg transition-colors"
                >
                  <Icon name="bell" className="w-5 h-5 text-slate-400" />
                  {unreadCount > 0 && (
                    <span className="absolute -top-0.5 -right-0.5 w-4 h-4 bg-red-500 rounded-full text-[10px] font-bold text-white flex items-center justify-center">
                      {unreadCount > 9 ? '9+' : unreadCount}
                    </span>
                  )}
                </button>
                
                {/* Theme Toggle */}
                <button
                  onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')}
                  className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
                >
                  <Icon name={theme === 'dark' ? 'sun' : 'moon'} className="w-5 h-5 text-slate-400" />
                </button>
                
                {/* Settings */}
                <button
                  onClick={() => setShowSettings(true)}
                  className="p-2 hover:bg-slate-800 rounded-lg transition-colors"
                >
                  <Icon name="settings" className="w-5 h-5 text-slate-400" />
                </button>
              </div>
            </div>
          </header>
          
          {/* Main Content */}
          <main className="p-6">
            {loading ? (
              <div className="flex items-center justify-center h-64">
                <Icon name="loader" className="w-8 h-8 text-cyan-400" />
              </div>
            ) : error ? (
              <div className="text-center text-red-400 py-8">
                <p>Error loading opportunities: {error}</p>
                <button onClick={loadOpportunities} className="mt-4 px-4 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-lg text-white transition-colors">
                  Retry
                </button>
              </div>
            ) : view === 'board' ? (
              /* Board View */
              <div className="grid grid-cols-4 gap-4">
                {SHIPLEY_PHASES.slice(0, 6).map(phase => (
                  <div key={phase.key} className="bg-slate-900/50 rounded-xl border border-slate-700/50 overflow-hidden">
                    {/* Column Header */}
                    <div className="p-3 border-b border-slate-700/50 flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full" style={{ backgroundColor: phase.color }} />
                        <span className="font-semibold text-white text-sm">{phase.name}</span>
                        <span className="text-xs text-slate-500">({opportunitiesByPhase[phase.key]?.length || 0})</span>
                      </div>
                    </div>
                    
                    {/* Cards */}
                    <div className={`p-3 space-y-3 overflow-y-auto ${settings.display.compactMode ? 'max-h-[400px]' : 'max-h-[500px]'}`}>
                      {opportunitiesByPhase[phase.key]?.map(opp => (
                        <OpportunityCard
                          key={opp.id}
                          opportunity={opp}
                          isSelected={selectedIds.has(opp.id)}
                          onSelect={handleSelect}
                          onShiftSelect={handleShiftSelect}
                          onClick={() => {}}
                          showPwinBars={settings.display.showPwinBars}
                          compact={settings.display.compactMode}
                        />
                      ))}
                      {opportunitiesByPhase[phase.key]?.length === 0 && (
                        <div className="text-center text-slate-600 text-sm py-8">No opportunities</div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            ) : view === 'table' ? (
              /* Table View */
              <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b border-slate-700">
                        <th className="p-3 text-left">
                          <input
                            type="checkbox"
                            checked={selectedIds.size === filteredOpportunities.length && filteredOpportunities.length > 0}
                            onChange={(e) => handleSelectAll(e.target.checked)}
                            className="custom-checkbox"
                          />
                        </th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Agency</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Value</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Priority</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Phase</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">pWin</th>
                        <th className="p-3 text-left text-xs font-semibold text-slate-400 uppercase">Due Date</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredOpportunities.map(opp => {
                        const phase = getPhaseInfo(opp.shipleyPhase);
                        const days = getDaysRemaining(opp.dueDate);
                        return (
                          <tr
                            key={opp.id}
                            onClick={(e) => e.shiftKey ? handleShiftSelect(opp.id) : null}
                            className={`border-b border-slate-800 hover:bg-slate-800/50 transition-colors cursor-pointer ${
                              selectedIds.has(opp.id) ? 'bg-cyan-500/10' : ''
                            }`}
                          >
                            <td className="p-3" onClick={(e) => e.stopPropagation()}>
                              <input
                                type="checkbox"
                                checked={selectedIds.has(opp.id)}
                                onChange={(e) => handleSelect(opp.id, e.target.checked)}
                                className="custom-checkbox"
                              />
                            </td>
                            <td className="p-3">
                              <p className="font-medium text-white">{opp.name}</p>
                            </td>
                            <td className="p-3 text-slate-400">{opp.agency}</td>
                            <td className="p-3 text-cyan-400 font-medium">{formatCurrency(opp.contractValue)}</td>
                            <td className="p-3">
                              <span
                                className="px-2 py-0.5 rounded text-xs font-semibold"
                                style={{ backgroundColor: `${getPriorityColor(opp.priority)}20`, color: getPriorityColor(opp.priority) }}
                              >
                                {opp.priority}
                              </span>
                            </td>
                            <td className="p-3">
                              <span className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full" style={{ backgroundColor: phase.color }} />
                                <span className="text-slate-300">{phase.name}</span>
                              </span>
                            </td>
                            <td className="p-3">
                              <div className="flex items-center gap-2">
                                <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                  <div className="h-full bg-cyan-400 rounded-full" style={{ width: `${opp.winProbability || 0}%` }} />
                                </div>
                                <span className="text-sm text-slate-400">{opp.winProbability || 0}%</span>
                              </div>
                            </td>
                            <td className={`p-3 ${days !== null && days < 0 ? 'text-red-400' : days !== null && days <= 3 ? 'text-amber-400' : 'text-slate-400'}`}>
                              {formatDate(opp.dueDate)}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            ) : view === 'dashboard' ? (
              /* Dashboard View */
              <div className="space-y-6">
                {/* Stats Cards */}
                <div className="grid grid-cols-4 gap-4">
                  <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4">
                    <p className="text-sm text-slate-400 mb-1">Total Pipeline</p>
                    <p className="text-2xl font-bold text-white">{formatCurrency(stats?.totalValue || 0)}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4">
                    <p className="text-sm text-slate-400 mb-1">Opportunities</p>
                    <p className="text-2xl font-bold text-white">{opportunities.length}</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4">
                    <p className="text-sm text-slate-400 mb-1">Avg Win Probability</p>
                    <p className="text-2xl font-bold text-cyan-400">{stats?.avgPwin || 0}%</p>
                  </div>
                  <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-4">
                    <p className="text-sm text-slate-400 mb-1">Due This Month</p>
                    <p className="text-2xl font-bold text-amber-400">{stats?.dueThisMonth || 0}</p>
                  </div>
                </div>
                
                {/* Phase Distribution */}
                <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-6">
                  <h3 className="text-lg font-semibold text-white mb-4">Pipeline by Phase</h3>
                  <div className="space-y-3">
                    {SHIPLEY_PHASES.map(phase => {
                      const count = opportunitiesByPhase[phase.key]?.length || 0;
                      const value = opportunitiesByPhase[phase.key]?.reduce((sum, o) => sum + (o.contractValue || 0), 0) || 0;
                      const pct = opportunities.length > 0 ? (count / opportunities.length) * 100 : 0;
                      return (
                        <div key={phase.key} className="flex items-center gap-4">
                          <div className="w-24 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: phase.color }} />
                            <span className="text-sm text-slate-300">{phase.name}</span>
                          </div>
                          <div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className="h-full rounded-full" style={{ width: `${pct}%`, backgroundColor: phase.color }} />
                          </div>
                          <div className="w-32 text-right">
                            <span className="text-sm text-slate-400">{count} â€¢ </span>
                            <span className="text-sm text-cyan-400">{formatCurrency(value)}</span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            ) : (
              /* Calendar View Placeholder */
              <div className="bg-slate-900/50 rounded-xl border border-slate-700/50 p-8 text-center">
                <Icon name="calendar" className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                <h3 className="text-xl font-semibold text-white mb-2">Calendar View</h3>
                <p className="text-slate-400">Calendar view from Sprint 15 - coming soon in this file</p>
              </div>
            )}
          </main>
          
          {/* Bulk Action Bar */}
          <BulkActionBar
            selectedCount={selectedIds.size}
            onChangePhase={handleBulkPhaseChange}
            onChangePriority={handleBulkPriorityChange}
            onDelete={() => setShowDeleteConfirm(true)}
            onClearSelection={clearSelection}
          />
          
          {/* Activity Log Panel */}
          <ActivityLogPanel
            isOpen={showActivityLog}
            onClose={() => setShowActivityLog(false)}
            activities={activities}
            loading={activitiesLoading}
            onLoadMore={handleActivityLoadMore}
            hasMore={hasMoreActivities}
            onClickActivity={(a) => {
              // TODO: Navigate to opportunity
              setShowActivityLog(false);
            }}
            onExport={handleActivityExport}
          />
          
          {/* Notification Center */}
          <NotificationCenter
            isOpen={showNotifications}
            onClose={() => setShowNotifications(false)}
            notifications={notifications}
            onDismiss={handleNotificationDismiss}
            onClickNotification={(n) => {
              handleNotificationDismiss(n.id);
              setShowNotifications(false);
            }}
          />
          
          {/* Command Palette */}
          <CommandPalette
            isOpen={showCommandPalette}
            onClose={() => setShowCommandPalette(false)}
            opportunities={opportunities}
            onNavigate={(opp) => {
              // TODO: Open opportunity drawer
              setShowCommandPalette(false);
            }}
            onAction={handleCommandAction}
          />
          
          {/* Settings Panel */}
          <SettingsPanel
            isOpen={showSettings}
            onClose={() => setShowSettings(false)}
            settings={settings}
            onUpdateSettings={handleUpdateSettings}
            onExportData={handleExportData}
            onClearStorage={handleClearStorage}
            onResetDefaults={handleResetDefaults}
          />
          
          {/* PDF Export Modal */}
          <PDFExportModal
            isOpen={showPDFExport}
            onClose={() => setShowPDFExport(false)}
            opportunities={filteredOpportunities}
            stats={stats}
          />
          
          {/* Delete Confirmation */}
          <DeleteConfirmModal
            isOpen={showDeleteConfirm}
            onClose={() => setShowDeleteConfirm(false)}
            onConfirm={handleBulkDelete}
            count={selectedIds.size}
          />
          
          {/* Toast */}
          {toast && (
            <Toast
              message={toast.message}
              type={toast.type}
              action={toast.action}
              onClose={() => setToast(null)}
            />
          )}
          
          {/* Footer */}
          <footer className="text-center py-4 text-xs text-slate-600">
            AI GENERATED - REQUIRES HUMAN REVIEW â€¢ Â© 2026 Mission Meets Tech
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
