<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 | AI Proposal Command Center</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--mmt-cyan:#00E5FA;--mmt-navy:#00050F}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#00050F;color:#e2e8f0;min-height:100vh}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0a1628}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    .glass{background:rgba(15,23,42,0.8);backdrop-filter:blur(12px);border:1px solid rgba(0,229,250,0.15);border-radius:12px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn 0.4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}
    .animate-spin{animation:spin 1s linear infinite}
    .hover-lift{transition:all 0.2s}.hover-lift:hover{transform:translateY(-2px);box-shadow:0 8px 25px -5px rgba(0,229,250,0.2)}
    .drag-over{border:2px dashed #00E5FA !important;background:rgba(0,229,250,0.1) !important}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
/**
 * FILE: index.html
 * ROLE: System
 * SECURITY: Supabase credentials verified
 * SPRINT: 53 - Data Wiring COMPLETE
 * MODULES: ALL 15 MODULES LIVE - Full Supabase Integration
 */
const{useState,useEffect,useRef,useCallback}=React;

// CONFIG
const CONFIG={
  SUPABASE_URL:'https://qdrtpnpnhkxvfmvfziop.supabase.co',
  SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NjQ4NjcsImV4cCI6MjA1MzM0MDg2N30.QEnpsflnMM9i9xvYPHJlJO7wGPazPTvTWSFIohHcA',
  API_URL:'https://missionpulse-api.onrender.com'
};
const supabase=window.supabase?.createClient(CONFIG.SUPABASE_URL,CONFIG.SUPABASE_KEY);

// ==================================================================
// MISSIONPULSE DATA API (Sprint 49 - Live Supabase Wiring)
// ==================================================================
const MissionPulse = {
  // OPPORTUNITIES
  async getOpportunities(filters = {}) {
    try {
      let query = supabase.from('opportunities').select('*').order('response_date', { ascending: true });
      if (filters.phase) query = query.eq('phase', filters.phase);
      if (filters.status) query = query.eq('status', filters.status);
      if (filters.search) query = query.or(`name.ilike.%${filters.search}%,nickname.ilike.%${filters.search}%`);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) {
      console.error('[MissionPulse] getOpportunities error:', err);
      return [];
    }
  },

  async createOpportunity(opp) {
    try {
      const { data, error } = await supabase.from('opportunities')
        .insert([{ ...opp, created_at: new Date().toISOString(), status: opp.status || 'active' }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createOpportunity error:', err); throw err; }
  },

  async updateOpportunity(id, updates) {
    try {
      const { data, error } = await supabase.from('opportunities')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updateOpportunity error:', err); throw err; }
  },

  async deleteOpportunity(id) {
    try {
      const { error } = await supabase.from('opportunities').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deleteOpportunity error:', err); throw err; }
  },

  async updateOpportunityPhase(id, newPhase) {
    return this.updateOpportunity(id, { phase: newPhase });
  },

  // TEAM ASSIGNMENTS
  async getTeamAssignments(opportunityId) {
    try {
      let query = supabase.from('team_assignments')
        .select('*, user:profiles(id, email, full_name, role)')
        .eq('status', 'active');
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query.order('assigned_at', { ascending: false });
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getTeamAssignments error:', err); return []; }
  },

  async assignTeamMember(opportunityId, userId, role) {
    try {
      const { data, error } = await supabase.from('team_assignments')
        .upsert([{ opportunity_id: opportunityId, user_id: userId, role, status: 'active', assigned_at: new Date().toISOString() }],
          { onConflict: 'opportunity_id,user_id,role' })
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] assignTeamMember error:', err); throw err; }
  },

  async getTeamMembers() {
    try {
      const { data, error } = await supabase.from('profiles').select('id, email, full_name, role').order('full_name');
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getTeamMembers error:', err); return []; }
  },

  // PIPELINE STATS
  async getPipelineStats() {
    const opps = await this.getOpportunities();
    return {
      totalOpportunities: opps.length,
      totalValue: opps.reduce((s, o) => s + (parseInt(o.value) || 0), 0),
      avgPwin: opps.length > 0 ? Math.round(opps.reduce((s, o) => s + (parseInt(o.pwin) || 0), 0) / opps.length) : 0,
      upcoming: opps.filter(o => { const d = new Date(o.response_date); return d > new Date() && d < new Date(Date.now() + 30*24*60*60*1000); }).length
    };
  },

  // COMPLIANCE ITEMS (Sprint 50)
  async getComplianceItems(opportunityId) {
    try {
      let query = supabase.from('compliance_items').select('*').order('requirement_id', { ascending: true });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getComplianceItems error:', err); return []; }
  },

  async createComplianceItem(item) {
    try {
      const { data, error } = await supabase.from('compliance_items')
        .insert([{ ...item, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createComplianceItem error:', err); throw err; }
  },

  async updateComplianceItem(id, updates) {
    try {
      const { data, error } = await supabase.from('compliance_items')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updateComplianceItem error:', err); throw err; }
  },

  async deleteComplianceItem(id) {
    try {
      const { error } = await supabase.from('compliance_items').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deleteComplianceItem error:', err); throw err; }
  },

  async getComplianceStats(opportunityId) {
    const items = await this.getComplianceItems(opportunityId);
    const total = items.length;
    const compliant = items.filter(i => i.status === 'compliant').length;
    const partial = items.filter(i => i.status === 'partial').length;
    const risk = items.filter(i => i.status === 'risk').length;
    return { total, compliant, partial, risk, score: total > 0 ? Math.round((compliant / total) * 100) : 0 };
  },

  // CONTRACT CLAUSES (Sprint 50)
  async getContractClauses(opportunityId) {
    try {
      let query = supabase.from('contract_clauses').select('*').order('clause_number', { ascending: true });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getContractClauses error:', err); return []; }
  },

  async createContractClause(clause) {
    try {
      const { data, error } = await supabase.from('contract_clauses')
        .insert([{ ...clause, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createContractClause error:', err); throw err; }
  },

  async updateContractClause(id, updates) {
    try {
      const { data, error } = await supabase.from('contract_clauses')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updateContractClause error:', err); throw err; }
  },

  async deleteContractClause(id) {
    try {
      const { error } = await supabase.from('contract_clauses').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deleteContractClause error:', err); throw err; }
  },

  async getContractRiskSummary(opportunityId) {
    const clauses = await this.getContractClauses(opportunityId);
    return {
      total: clauses.length,
      high: clauses.filter(c => c.risk_level === 'high').length,
      medium: clauses.filter(c => c.risk_level === 'medium').length,
      low: clauses.filter(c => c.risk_level === 'low').length
    };
  },

  // COMPETITORS (Sprint 51 - Black Hat)
  async getCompetitors(opportunityId) {
    try {
      let query = supabase.from('competitors').select('*').order('threat_level', { ascending: false });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getCompetitors error:', err); return []; }
  },

  async createCompetitor(competitor) {
    try {
      const { data, error } = await supabase.from('competitors')
        .insert([{ ...competitor, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createCompetitor error:', err); throw err; }
  },

  async updateCompetitor(id, updates) {
    try {
      const { data, error } = await supabase.from('competitors')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updateCompetitor error:', err); throw err; }
  },

  async deleteCompetitor(id) {
    try {
      const { error } = await supabase.from('competitors').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deleteCompetitor error:', err); throw err; }
  },

  // PRICING ITEMS (Sprint 51 - BOE)
  async getPricingItems(opportunityId) {
    try {
      let query = supabase.from('pricing_items').select('*').order('year', { ascending: true });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getPricingItems error:', err); return []; }
  },

  async createPricingItem(item) {
    try {
      const { data, error } = await supabase.from('pricing_items')
        .insert([{ ...item, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createPricingItem error:', err); throw err; }
  },

  async updatePricingItem(id, updates) {
    try {
      const { data, error } = await supabase.from('pricing_items')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updatePricingItem error:', err); throw err; }
  },

  async deletePricingItem(id) {
    try {
      const { error } = await supabase.from('pricing_items').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deletePricingItem error:', err); throw err; }
  },

  async calculateBOE(opportunityId, wrapRate = 1.85) {
    const items = await this.getPricingItems(opportunityId);
    const directLabor = items.reduce((sum, i) => sum + ((i.hours || 0) * (parseFloat(i.rate) || 0)), 0);
    const wrapped = directLabor * wrapRate;
    return { directLabor, wrapped, items: items.length, wrapRate };
  },

  // AI APPROVALS (Sprint 51 - HITL Queue)
  async getAIApprovals(status = null) {
    try {
      let query = supabase.from('ai_approvals')
        .select('*, opportunity:opportunities(name, nickname)')
        .order('created_at', { ascending: false });
      if (status) query = query.eq('status', status);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getAIApprovals error:', err); return []; }
  },

  async createAIApproval(approval) {
    try {
      const { data, error } = await supabase.from('ai_approvals')
        .insert([{ ...approval, created_at: new Date().toISOString(), status: 'pending' }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createAIApproval error:', err); throw err; }
  },

  async approveContent(id, notes = null) {
    try {
      const { data, error } = await supabase.from('ai_approvals')
        .update({ status: 'approved', reviewed_at: new Date().toISOString(), reviewer_notes: notes })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] approveContent error:', err); throw err; }
  },

  async rejectContent(id, notes) {
    try {
      const { data, error } = await supabase.from('ai_approvals')
        .update({ status: 'rejected', reviewed_at: new Date().toISOString(), reviewer_notes: notes })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] rejectContent error:', err); throw err; }
  },

  // ORALS DECKS (Sprint 52)
  async getOralsDeck(opportunityId) {
    try {
      const { data, error } = await supabase.from('orals_decks')
        .select('*')
        .eq('opportunity_id', opportunityId)
        .order('created_at', { ascending: false })
        .limit(1)
        .single();
      if (error && error.code !== 'PGRST116') throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] getOralsDeck error:', err); return null; }
  },

  async saveOralsDeck(opportunityId, slides, title = 'Orals Deck') {
    try {
      const existing = await this.getOralsDeck(opportunityId);
      if (existing) {
        const { data, error } = await supabase.from('orals_decks')
          .update({ slides: JSON.stringify(slides), updated_at: new Date().toISOString() })
          .eq('id', existing.id).select().single();
        if (error) throw error;
        return data;
      } else {
        const { data, error } = await supabase.from('orals_decks')
          .insert([{ opportunity_id: opportunityId, title, slides: JSON.stringify(slides), status: 'draft' }])
          .select().single();
        if (error) throw error;
        return data;
      }
    } catch (err) { console.error('[MissionPulse] saveOralsDeck error:', err); throw err; }
  },

  // PLAYBOOK ITEMS (Sprint 52)
  async getPlaybookItems(category = null) {
    try {
      let query = supabase.from('playbook_items').select('*').order('score', { ascending: false });
      if (category) query = query.eq('category', category);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getPlaybookItems error:', err); return []; }
  },

  async createPlaybookItem(item) {
    try {
      const { data, error } = await supabase.from('playbook_items')
        .insert([{ ...item, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createPlaybookItem error:', err); throw err; }
  },

  async incrementPlaybookUse(id) {
    try {
      const { data: current } = await supabase.from('playbook_items').select('uses').eq('id', id).single();
      const { data, error } = await supabase.from('playbook_items')
        .update({ uses: (current?.uses || 0) + 1 })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] incrementPlaybookUse error:', err); throw err; }
  },

  async deletePlaybookItem(id) {
    try {
      const { error } = await supabase.from('playbook_items').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deletePlaybookItem error:', err); throw err; }
  },

  // PARTNER ACCESS (Sprint 52 - Frenemy Protocol)
  async getPartnerAccess(opportunityId) {
    try {
      let query = supabase.from('partner_access').select('*').order('created_at', { ascending: false });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getPartnerAccess error:', err); return []; }
  },

  async invitePartner(partner) {
    try {
      const { data, error } = await supabase.from('partner_access')
        .insert([{ ...partner, status: 'pending', created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] invitePartner error:', err); throw err; }
  },

  async updatePartnerStatus(id, status) {
    try {
      const updates = { status };
      if (status === 'revoked') updates.revoked_at = new Date().toISOString();
      const { data, error } = await supabase.from('partner_access')
        .update(updates).eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updatePartnerStatus error:', err); throw err; }
  },

  async revokeAllPartners(opportunityId) {
    try {
      const { data, error } = await supabase.from('partner_access')
        .update({ status: 'revoked', revoked_at: new Date().toISOString() })
        .eq('opportunity_id', opportunityId)
        .eq('auto_revoke_on_submit', true)
        .neq('status', 'revoked');
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] revokeAllPartners error:', err); throw err; }
  },

  // LAUNCH CHECKLISTS (Sprint 53)
  async getLaunchChecklist(opportunityId) {
    try {
      let query = supabase.from('launch_checklists').select('*').order('category', { ascending: true });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getLaunchChecklist error:', err); return []; }
  },

  async createChecklistItem(item) {
    try {
      const { data, error } = await supabase.from('launch_checklists')
        .insert([{ ...item, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createChecklistItem error:', err); throw err; }
  },

  async updateChecklistItem(id, updates) {
    try {
      if (updates.status === 'complete') updates.completed_at = new Date().toISOString();
      const { data, error } = await supabase.from('launch_checklists')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updateChecklistItem error:', err); throw err; }
  },

  async deleteChecklistItem(id) {
    try {
      const { error } = await supabase.from('launch_checklists').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deleteChecklistItem error:', err); throw err; }
  },

  async getLaunchReadiness(opportunityId) {
    const items = await this.getLaunchChecklist(opportunityId);
    const total = items.length;
    const complete = items.filter(i => i.status === 'complete').length;
    const blocked = items.filter(i => i.blockers).length;
    return { total, complete, blocked, percent: total > 0 ? Math.round((complete / total) * 100) : 0 };
  },

  // POST-AWARD ACTIONS (Sprint 53)
  async getPostAwardActions(opportunityId, actionType = null) {
    try {
      let query = supabase.from('post_award_actions').select('*').order('due_date', { ascending: true });
      if (opportunityId) query = query.eq('opportunity_id', opportunityId);
      if (actionType) query = query.eq('action_type', actionType);
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getPostAwardActions error:', err); return []; }
  },

  async createPostAwardAction(action) {
    try {
      const { data, error } = await supabase.from('post_award_actions')
        .insert([{ ...action, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] createPostAwardAction error:', err); throw err; }
  },

  async updatePostAwardAction(id, updates) {
    try {
      if (updates.status === 'complete') updates.completed_at = new Date().toISOString();
      const { data, error } = await supabase.from('post_award_actions')
        .update({ ...updates, updated_at: new Date().toISOString() })
        .eq('id', id).select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] updatePostAwardAction error:', err); throw err; }
  },

  async deletePostAwardAction(id) {
    try {
      const { error } = await supabase.from('post_award_actions').delete().eq('id', id);
      if (error) throw error;
      return true;
    } catch (err) { console.error('[MissionPulse] deletePostAwardAction error:', err); throw err; }
  },

  // AUDIT LOGS (Sprint 53)
  async getAuditLogs(limit = 100) {
    try {
      const { data, error } = await supabase.from('audit_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(limit);
      if (error) throw error;
      return data || [];
    } catch (err) { console.error('[MissionPulse] getAuditLogs error:', err); return []; }
  },

  async logAuditAction(action, module, resourceType = null, resourceId = null, details = null) {
    try {
      const { data, error } = await supabase.from('audit_logs')
        .insert([{ action, module, resource_type: resourceType, resource_id: resourceId, details, created_at: new Date().toISOString() }])
        .select().single();
      if (error) throw error;
      return data;
    } catch (err) { console.error('[MissionPulse] logAuditAction error:', err); return null; }
  },

  // HELPERS
  fmt: v => v >= 1e9 ? `$${(v/1e9).toFixed(1)}B` : v >= 1e6 ? `$${(v/1e6).toFixed(0)}M` : `$${(v||0).toLocaleString()}`,
  getDaysUntil: d => d ? Math.ceil((new Date(d) - new Date()) / (1000*60*60*24)) : null,
  getPhaseColor: p => ({
    'Phase 0 - Market Intel': '#6366f1', 'Phase 1 - Opportunity ID': '#8b5cf6', 'Phase 2 - Capture Planning': '#a855f7',
    'Phase 3 - Proposal Development': '#00E5FA', 'Phase 4 - Proposal Submission': '#22c55e',
    'Phase 5 - Post-Submission': '#eab308', 'Phase 6 - Award/Debrief': '#ef4444',
    'Qualify': '#64748b', 'Capture': '#8b5cf6', 'Blue Team': '#3b82f6', 'Pink Team': '#ec4899',
    'Red Team': '#ef4444', 'Gold Team': '#f59e0b', 'White Glove': '#10b981', 'Submit': '#22d3ee'
  })[p] || '#6b7280'
};

// 11 SHIPLEY ROLES
const ROLES=[
  {id:'CEO',name:'CEO',fullName:'Mary Womack',icon:'üëë',color:'#fbbf24',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']},
  {id:'COO',name:'COO',fullName:'David Chen',icon:'üíº',color:'#f97316',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','pricing','hitl','frenemy','launch','post_award','playbook','training']},
  {id:'CAP',name:'Capture',fullName:'Michael Torres',icon:'üéØ',color:'#f472b6',access:['dashboard','pipeline','warroom','swimlane','blackhat','frenemy','playbook']},
  {id:'PM',name:'Proposal Mgr',fullName:'Lisa Martinez',icon:'üìã',color:'#60a5fa',access:['dashboard','pipeline','warroom','swimlane','compliance','writer','hitl','orals','launch','post_award','playbook']},
  {id:'SA',name:'Solution Arch',fullName:'Sarah Chen',icon:'üíª',color:'#22d3ee',access:['dashboard','writer','compliance','contracts','orals','playbook']},
  {id:'FIN',name:'Pricing',fullName:'Jennifer Park',icon:'üí∞',color:'#34d399',access:['dashboard','pricing','contracts','launch','playbook']},
  {id:'CON',name:'Contracts',fullName:'Robert Williams',icon:'‚öñÔ∏è',color:'#a78bfa',access:['dashboard','compliance','contracts','hitl','playbook']},
  {id:'DEL',name:'Delivery',fullName:'Amanda Foster',icon:'üë•',color:'#fb7185',access:['dashboard','writer','post_award','orals','playbook']},
  {id:'QA',name:'QA Lead',fullName:'James Thompson',icon:'‚úÖ',color:'#2dd4bf',access:['dashboard','hitl','compliance','writer','playbook']},
  {id:'Partner',name:'Partner',fullName:'External',icon:'ü§ù',color:'#94a3b8',access:['frenemy','writer'],external:true},
  {id:'Admin',name:'Admin',fullName:'System Admin',icon:'‚öôÔ∏è',color:'#cbd5e1',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']}
];

// 18 MODULES
const MODULES=[
  {id:'dashboard',name:'Mission Control',icon:'‚ö°',color:'#00E5FA',cat:'Command'},
  {id:'pipeline',name:'Pipeline Intel',icon:'üìä',color:'#22d3ee',cat:'Strategy'},
  {id:'warroom',name:'War Room',icon:'‚öîÔ∏è',color:'#f97316',cat:'Strategy'},
  {id:'swimlane',name:'Swimlane Board',icon:'üìã',color:'#8b5cf6',cat:'Strategy'},
  {id:'compliance',name:'RFP Shredder',icon:'üìÑ',color:'#ef4444',cat:'Intel'},
  {id:'contracts',name:'Contract Scanner',icon:'‚öñÔ∏è',color:'#a78bfa',cat:'Intel'},
  {id:'writer',name:'Iron Dome',icon:'‚úèÔ∏è',color:'#10b981',cat:'Intel'},
  {id:'blackhat',name:'Black Hat',icon:'üé≠',color:'#f59e0b',cat:'Intel',badge:'PRIVATE'},
  {id:'pricing',name:'Pricing Engine',icon:'üíµ',color:'#ec4899',cat:'Delivery',badge:'CUI'},
  {id:'hitl',name:'HITL Queue',icon:'üëÅÔ∏è',color:'#6366f1',cat:'Delivery'},
  {id:'orals',name:'Orals Studio',icon:'üé§',color:'#f472b6',cat:'Delivery'},
  {id:'frenemy',name:'Frenemy Protocol',icon:'üõ°Ô∏è',color:'#22d3ee',cat:'Delivery'},
  {id:'launch',name:'Launch & ROI',icon:'üöÄ',color:'#e879f9',cat:'Command'},
  {id:'post_award',name:'Post-Award',icon:'üì¶',color:'#a78bfa',cat:'Command'},
  {id:'playbook',name:'Playbook',icon:'‚≠ê',color:'#fbbf24',cat:'Admin'},
  {id:'admin',name:'Admin',icon:'‚öôÔ∏è',color:'#cbd5e1',cat:'Admin',badge:'ADMIN'},
  {id:'training',name:'Training Hub',icon:'üéì',color:'#10b981',cat:'Admin'},
  {id:'audit',name:'Audit Log',icon:'üìú',color:'#64748b',cat:'Admin',badge:'ADMIN'}
];

// SHIPLEY PHASES
const SHIPLEY_PHASES=['Qualify','Capture','Blue Team','Pink Team','Red Team','Gold Team','White Glove','Submit'];

// DEMO FALLBACK DATA
const DEMO_OPPS=[
  {id:'demo-1',nickname:'DHA EHR Mod',name:'DHA MHS GENESIS Cloud Migration',agency:'DHA',value:98450210,phase:'Pink Team',pwin:72,response_date:'2026-03-07'},
  {id:'demo-2',nickname:'VA Claims AI',name:'VA Enterprise Cloud Hosting',agency:'VA',value:45000000,phase:'Blue Team',pwin:58,response_date:'2026-04-21'},
  {id:'demo-3',nickname:'CMS Analytics',name:'CMS Data Analytics Modernization',agency:'CMS',value:125000000,phase:'Red Team',pwin:68,response_date:'2026-02-19'},
  {id:'demo-4',nickname:'IHS Telehealth',name:'IHS Telehealth Expansion',agency:'IHS',value:32000000,phase:'Capture',pwin:55,response_date:'2026-07-04'}
];

const DEMO_COMPLIANCE=[
  {id:1,ref:'L.1.1',title:'Technical Approach',section:'L',status:'compliant',owner:'Sarah C.',confidence:95},
  {id:2,ref:'L.2.1',title:'Management Plan',section:'L',status:'partial',owner:'Lisa M.',confidence:78},
  {id:3,ref:'M.1',title:'Cost Volume Format',section:'M',status:'compliant',owner:'Jennifer P.',confidence:92},
  {id:4,ref:'L.3',title:'Past Performance',section:'L',status:'risk',owner:'David C.',confidence:62}
];

const DEMO_HITL=[
  {id:1,type:'Win Theme',title:'Cloud-First Innovation',agent:'Strategy',confidence:87,status:'pending',created:'2h ago'},
  {id:2,type:'Compliance Check',title:'FAR 52.212-4 Analysis',agent:'Compliance',confidence:92,status:'pending',created:'4h ago'},
  {id:3,type:'Price Analysis',title:'LCAT Rate Validation',agent:'Pricing',confidence:65,status:'pending',created:'1d ago'},
  {id:4,type:'Win Theme',title:'Innovation Discriminator',agent:'Strategy',confidence:88,status:'approved',created:'2d ago'}
];

const DEMO_LCATS=[
  {id:1,title:'Program Manager',rate:185,hours:2080,wrap:1.85},
  {id:2,title:'Sr. Software Engineer',rate:165,hours:4160,wrap:1.85},
  {id:3,title:'Data Scientist',rate:155,hours:2080,wrap:1.85},
  {id:4,title:'Cloud Architect',rate:175,hours:1040,wrap:1.85},
  {id:5,title:'QA Analyst',rate:125,hours:2080,wrap:1.85}
];

const DEMO_AUDIT=[
  {id:1,action:'LOGIN',user:'Mary Womack',role:'CEO',ip:'192.168.1.100',ts:'2026-01-29 09:15:22'},
  {id:2,action:'VIEW_BLACKHAT',user:'Michael Torres',role:'Capture',ip:'192.168.1.105',ts:'2026-01-29 09:18:45'},
  {id:3,action:'EXPORT_PRICING',user:'Jennifer Park',role:'Pricing',ip:'192.168.1.110',ts:'2026-01-29 10:02:33'},
  {id:4,action:'APPROVE_SECTION',user:'Lisa Martinez',role:'PM',ip:'192.168.1.108',ts:'2026-01-29 10:45:12'}
];

const DEMO_PLAYBOOK=[
  {id:1,title:'Executive Summary - DHA Win',category:'Writing',score:95,uses:47},
  {id:2,title:'Technical Innovation Theme',category:'Strategy',score:92,uses:38},
  {id:3,title:'Past Performance Narrative',category:'Writing',score:88,uses:52}
];

// HELPERS
const fmt=v=>v>=1e9?`$${(v/1e9).toFixed(1)}B`:v>=1e6?`$${(v/1e6).toFixed(0)}M`:`$${(v||0).toLocaleString()}`;
const checkAuth=()=>{const s=localStorage.getItem('MP_SESSION'),u=localStorage.getItem('MP_USER');if(!s||!u){window.location.href='login.html';return null}try{return JSON.parse(u)}catch{return{email:'demo@mmt.com',name:'Demo User'}}};
const handleLogout=()=>{localStorage.clear();window.location.href='login.html'};

// ICON
const Icon=({name,className='w-5 h-5'})=>{
  const icons={
    chevronLeft:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>,
    chevronRight:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,
    chevronDown:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>,
    x:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
    check:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
    upload:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
    download:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>,
    send:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>,
    logout:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
    plus:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
    edit:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>,
    trash:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
    refresh:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    database:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>,
  };
  return icons[name]||<span className={className}>‚óâ</span>;
};

// LOADING SPINNER
const Spinner=({size='md'})=>{
  const s={sm:'w-4 h-4',md:'w-8 h-8',lg:'w-12 h-12'}[size];
  return <div className={`${s} border-2 border-cyan-500 border-t-transparent rounded-full animate-spin`}/>;
};

// DATA SOURCE BADGE
const DataBadge=({live})=>(
  <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-medium ${live?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>
    <Icon name="database" className="w-3 h-3"/>
    {live?'LIVE':'DEMO'}
  </span>
);

// ============================================================
// MODULE: DASHBOARD (M1) - LIVE DATA
// ============================================================
function ModuleDashboard({opps,loading,isLive,onRefresh,tokenUsage}){
  const total=opps.reduce((s,o)=>s+(parseInt(o.value)||o.ceiling||0),0);
  const avgPwin=opps.length?Math.round(opps.reduce((s,o)=>s+(parseInt(o.pwin)||o.pWin||0),0)/opps.length):0;
  
  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="glass p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10">
        <div className="flex justify-between items-center">
          <div>
            <div className="flex items-center gap-2 mb-1">
              <h2 className="text-2xl font-bold text-white">Mission Control</h2>
              <DataBadge live={isLive}/>
            </div>
            <p className="text-slate-400">AI-Powered Proposal Command Center</p>
            <p className="text-cyan-400 text-sm mt-1">Mission. Technology. Transformation.</p>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={onRefresh} className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-cyan-400 transition" title="Refresh Data">
              <Icon name="refresh" className={`w-5 h-5 ${loading?'animate-spin':''}`}/>
            </button>
            <div className="text-6xl">üéØ</div>
          </div>
        </div>
      </div>
      
      <div className="grid grid-cols-4 gap-4">
        {[
          {l:'Pipeline Value',v:fmt(total),c:'text-emerald-400'},
          {l:'Active Pursuits',v:opps.length,c:'text-cyan-400'},
          {l:'Avg Win Prob',v:`${avgPwin}%`,c:'text-amber-400'},
          {l:'Tokens Used',v:tokenUsage.toLocaleString(),c:'text-purple-400'}
        ].map((s,i)=><div key={i} className="glass p-4 hover-lift"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{loading?<Spinner size="sm"/>:s.v}</p></div>)}
      </div>
      
      <div className="glass overflow-hidden">
        <div className="p-4 border-b border-slate-700/50 flex justify-between items-center">
          <h3 className="font-semibold text-white">Active Pipeline</h3>
          <span className="text-xs text-slate-500">{opps.length} opportunities</span>
        </div>
        {loading?(
          <div className="p-8 flex justify-center"><Spinner/></div>
        ):(
          <table className="w-full">
            <thead className="bg-slate-800/50">
              <tr>{['Opportunity','Agency','Value','Phase','pWin','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr>
            </thead>
            <tbody className="divide-y divide-slate-700/50">
              {opps.map(o=>{
                const days=MissionPulse.getDaysUntil(o.response_date)||o.days||'--';
                return(
                  <tr key={o.id} className="hover:bg-slate-800/30">
                    <td className="p-3"><div className="font-medium text-white text-sm">{o.nickname||o.name}</div><div className="text-xs text-slate-500">{o.name||o.title}</div></td>
                    <td className="p-3 text-sm text-slate-300">{o.agency}</td>
                    <td className="p-3 text-sm text-emerald-400 font-medium">{fmt(o.value||o.ceiling)}</td>
                    <td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{backgroundColor:`${MissionPulse.getPhaseColor(o.phase)}20`,color:MissionPulse.getPhaseColor(o.phase)}}>{o.phase}</span></td>
                    <td className="p-3"><div className="flex items-center gap-2"><div className="w-16 h-1.5 bg-slate-700 rounded-full"><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full" style={{width:`${o.pwin||o.pWin||0}%`}}/></div><span className="text-xs text-slate-300">{o.pwin||o.pWin||0}%</span></div></td>
                    <td className="p-3 text-sm text-slate-400">{days}d</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: PIPELINE (M1) - FULL CRUD
// ============================================================
function ModulePipeline({opps,setOpps,loading,isLive,onRefresh}){
  const[showNew,setShowNew]=useState(false);
  const[editing,setEditing]=useState(null);
  const[form,setForm]=useState({nickname:'',name:'',agency:'',value:'',pwin:'',phase:'Qualify',response_date:''});
  const[saving,setSaving]=useState(false);

  const resetForm=()=>setForm({nickname:'',name:'',agency:'',value:'',pwin:'',phase:'Qualify',response_date:''});

  const handleSave=async()=>{
    setSaving(true);
    try{
      const data={...form,value:parseInt(form.value)||0,pwin:parseInt(form.pwin)||0};
      if(editing){
        const updated=await MissionPulse.updateOpportunity(editing.id,data);
        setOpps(opps.map(o=>o.id===editing.id?{...o,...updated}:o));
      }else{
        const created=await MissionPulse.createOpportunity(data);
        setOpps([...opps,created]);
      }
      setShowNew(false);setEditing(null);resetForm();
    }catch(err){alert('Error saving: '+err.message)}
    finally{setSaving(false)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete this opportunity?'))return;
    try{
      await MissionPulse.deleteOpportunity(id);
      setOpps(opps.filter(o=>o.id!==id));
    }catch(err){alert('Error deleting: '+err.message)}
  };

  const openEdit=(opp)=>{
    setForm({nickname:opp.nickname||'',name:opp.name||'',agency:opp.agency||'',value:opp.value||opp.ceiling||'',pwin:opp.pwin||opp.pWin||'',phase:opp.phase||'Qualify',response_date:opp.response_date||''});
    setEditing(opp);setShowNew(true);
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Pipeline Intel</h2>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">Opportunity tracking and management</p>
        </div>
        <div className="flex gap-2">
          <button onClick={onRefresh} className="px-3 py-2 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-2"><Icon name="refresh" className={`w-4 h-4 ${loading?'animate-spin':''}`}/>Refresh</button>
          <button onClick={()=>{resetForm();setEditing(null);setShowNew(true)}} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>New Opportunity</button>
        </div>
      </div>

      {/* Form Modal */}
      {showNew&&(
        <div className="glass p-6 animate-fadeIn">
          <h3 className="font-semibold text-white mb-4">{editing?'Edit Opportunity':'New Opportunity'}</h3>
          <div className="grid grid-cols-2 gap-4">
            <input placeholder="Nickname" value={form.nickname} onChange={e=>setForm({...form,nickname:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
            <input placeholder="Full Name" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
            <input placeholder="Agency" value={form.agency} onChange={e=>setForm({...form,agency:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
            <input placeholder="Value ($)" type="number" value={form.value} onChange={e=>setForm({...form,value:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
            <input placeholder="Win Probability (%)" type="number" value={form.pwin} onChange={e=>setForm({...form,pwin:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
            <select value={form.phase} onChange={e=>setForm({...form,phase:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
              {SHIPLEY_PHASES.map(p=><option key={p} value={p}>{p}</option>)}
            </select>
            <input type="date" value={form.response_date} onChange={e=>setForm({...form,response_date:e.target.value})} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"/>
          </div>
          <div className="flex justify-end gap-2 mt-4">
            <button onClick={()=>{setShowNew(false);setEditing(null);resetForm()}} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm">Cancel</button>
            <button onClick={handleSave} disabled={saving} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm flex items-center gap-2">{saving?<Spinner size="sm"/>:null}{editing?'Update':'Create'}</button>
          </div>
        </div>
      )}

      {/* Table */}
      <div className="glass overflow-hidden">
        {loading?(
          <div className="p-8 flex justify-center"><Spinner/></div>
        ):(
          <table className="w-full">
            <thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Due','Actions'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
            <tbody className="divide-y divide-slate-700/50">
              {opps.map(o=>{
                const days=MissionPulse.getDaysUntil(o.response_date)||o.days||'--';
                return(
                  <tr key={o.id} className="hover:bg-slate-800/30">
                    <td className="p-3"><div className="font-medium text-white text-sm">{o.nickname||o.name}</div></td>
                    <td className="p-3 text-sm text-slate-300">{o.agency}</td>
                    <td className="p-3 text-sm text-emerald-400">{fmt(o.value||o.ceiling)}</td>
                    <td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{backgroundColor:`${MissionPulse.getPhaseColor(o.phase)}20`,color:MissionPulse.getPhaseColor(o.phase)}}>{o.phase}</span></td>
                    <td className="p-3 text-sm text-slate-300">{o.pwin||o.pWin||0}%</td>
                    <td className="p-3 text-sm text-slate-400">{days}d</td>
                    <td className="p-3 flex gap-1">
                      <button onClick={()=>openEdit(o)} className="p-1.5 rounded bg-slate-700 hover:bg-cyan-500/20 text-slate-400 hover:text-cyan-400"><Icon name="edit" className="w-4 h-4"/></button>
                      <button onClick={()=>handleDelete(o.id)} className="p-1.5 rounded bg-slate-700 hover:bg-red-500/20 text-slate-400 hover:text-red-400"><Icon name="trash" className="w-4 h-4"/></button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: WAR ROOM (M2) - TEAM ASSIGNMENTS
// ============================================================
function ModuleWarRoom({opps,loading,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[assignments,setAssignments]=useState([]);
  const[teamMembers,setTeamMembers]=useState([]);
  const[loadingTeam,setLoadingTeam]=useState(false);

  useEffect(()=>{
    const loadTeam=async()=>{
      const members=await MissionPulse.getTeamMembers();
      setTeamMembers(members.length?members:ROLES.map(r=>({id:r.id,full_name:r.fullName,role:r.name,email:`${r.id.toLowerCase()}@mmt.com`})));
    };
    loadTeam();
  },[]);

  useEffect(()=>{
    if(!selectedOpp)return;
    const loadAssignments=async()=>{
      setLoadingTeam(true);
      const data=await MissionPulse.getTeamAssignments(selectedOpp.id);
      setAssignments(data);
      setLoadingTeam(false);
    };
    loadAssignments();
  },[selectedOpp]);

  const handleAssign=async(memberId,role)=>{
    if(!selectedOpp)return;
    try{
      await MissionPulse.assignTeamMember(selectedOpp.id,memberId,role);
      const data=await MissionPulse.getTeamAssignments(selectedOpp.id);
      setAssignments(data);
    }catch(err){console.error(err)}
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">War Room</h2>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">Team assignments and proposal coordination</p>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        {/* Opportunity Selector */}
        <div className="glass p-4">
          <h3 className="font-semibold text-white mb-3">Select Opportunity</h3>
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {loading?<Spinner/>:opps.map(o=>(
              <button key={o.id} onClick={()=>setSelectedOpp(o)} className={`w-full text-left p-3 rounded-lg transition ${selectedOpp?.id===o.id?'bg-cyan-500/20 border border-cyan-500/30':'bg-slate-800/50 hover:bg-slate-700'}`}>
                <div className="font-medium text-white text-sm">{o.nickname||o.name}</div>
                <div className="text-xs text-slate-400">{o.agency} ‚Ä¢ {o.phase}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Team Grid */}
        <div className="col-span-2 glass p-4">
          <h3 className="font-semibold text-white mb-3">
            {selectedOpp?`Team: ${selectedOpp.nickname||selectedOpp.name}`:'Select an opportunity'}
          </h3>
          {!selectedOpp?(
            <div className="text-center py-12 text-slate-500">Select an opportunity to view team assignments</div>
          ):loadingTeam?(
            <div className="flex justify-center py-8"><Spinner/></div>
          ):(
            <div className="grid grid-cols-3 gap-3">
              {ROLES.slice(0,9).map(role=>{
                const assigned=assignments.find(a=>a.role===role.id);
                return(
                  <div key={role.id} className="p-3 bg-slate-800/50 rounded-lg">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-lg">{role.icon}</span>
                      <span className="text-sm font-medium text-white">{role.name}</span>
                    </div>
                    {assigned?(
                      <div className="text-xs text-cyan-400">{assigned.user?.full_name||role.fullName}</div>
                    ):(
                      <select onChange={e=>e.target.value&&handleAssign(e.target.value,role.id)} className="w-full bg-slate-700 border-0 rounded text-xs text-slate-300 p-1">
                        <option value="">Unassigned</option>
                        {teamMembers.map(m=><option key={m.id} value={m.id}>{m.full_name||m.email}</option>)}
                      </select>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: SWIMLANE KANBAN (M3) - PHASE PERSISTENCE
// ============================================================
function ModuleSwimlane({opps,setOpps,loading,isLive}){
  const[dragging,setDragging]=useState(null);
  const[updating,setUpdating]=useState(null);
  const phaseColors={'Qualify':'#64748b','Capture':'#8b5cf6','Blue Team':'#3b82f6','Pink Team':'#ec4899','Red Team':'#ef4444','Gold Team':'#f59e0b','White Glove':'#10b981','Submit':'#22d3ee'};

  const handleDragStart=(e,opp)=>{setDragging(opp);e.dataTransfer.effectAllowed='move'};
  const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over')};
  const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over')};
  
  const handleDrop=async(e,phase)=>{
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    if(!dragging||dragging.phase===phase)return;
    
    setUpdating(dragging.id);
    try{
      await MissionPulse.updateOpportunityPhase(dragging.id,phase);
      setOpps(opps.map(o=>o.id===dragging.id?{...o,phase}:o));
    }catch(err){
      console.error('Failed to update phase:',err);
      alert('Failed to update phase');
    }finally{
      setDragging(null);
      setUpdating(null);
    }
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Swimlane Board</h2>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">Drag opportunities through Shipley gate phases</p>
        </div>
      </div>
      
      {loading?(
        <div className="flex justify-center py-12"><Spinner size="lg"/></div>
      ):(
        <div className="flex gap-3 overflow-x-auto pb-4">
          {SHIPLEY_PHASES.map(phase=>(
            <div key={phase} className="flex-shrink-0 w-56" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={(e)=>handleDrop(e,phase)}>
              <div className="flex items-center gap-2 mb-3 px-2">
                <div className="w-3 h-3 rounded-full" style={{backgroundColor:phaseColors[phase]}}/>
                <span className="text-sm font-semibold text-white">{phase}</span>
                <span className="text-xs text-slate-500 ml-auto">{opps.filter(o=>o.phase===phase).length}</span>
              </div>
              <div className="space-y-2 min-h-[300px] p-2 rounded-lg bg-slate-800/30 border border-slate-700/50">
                {opps.filter(o=>o.phase===phase).map(opp=>(
                  <div key={opp.id} draggable onDragStart={(e)=>handleDragStart(e,opp)} className={`glass p-3 cursor-grab active:cursor-grabbing hover-lift ${updating===opp.id?'opacity-50':''}`}>
                    <div className="font-medium text-white text-sm mb-1">{opp.nickname||opp.name}</div>
                    <div className="flex justify-between items-center">
                      <span className="text-xs text-slate-400">{opp.agency}</span>
                      <span className="text-[10px] text-emerald-400 font-mono">{fmt(opp.value||opp.ceiling)}</span>
                    </div>
                    {updating===opp.id&&<div className="mt-2 flex justify-center"><Spinner size="sm"/></div>}
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================================
// MODULE: RFP SHREDDER (M4) - LIVE DATA
// ============================================================
const ORALS_SLIDES=['Title Slide','Executive Summary','Technical Approach','Management Plan','Past Performance','Key Personnel','Risk Mitigation','Timeline','Value Proposition','Q&A'];

function ModuleCompliance({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[requirements,setRequirements]=useState([]);
  const[loading,setLoading]=useState(false);
  const[uploading,setUploading]=useState(false);
  const[extracting,setExtracting]=useState(false);
  const[progress,setProgress]=useState(0);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({requirement_id:'',title:'',section:'L',status:'identified',confidence:50});
  const fileRef=useRef();

  const statusColors={compliant:'bg-emerald-500/20 text-emerald-400',partial:'bg-amber-500/20 text-amber-400',risk:'bg-red-500/20 text-red-400',identified:'bg-slate-500/20 text-slate-400',draft:'bg-slate-500/20 text-slate-400'};

  // Load compliance items when opportunity selected
  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getComplianceItems(selectedOpp.id);
      setRequirements(data.length>0?data:DEMO_COMPLIANCE);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleUpload=(e)=>{
    const f=e.target?.files?.[0];if(!f||!selectedOpp)return;
    setUploading(true);setProgress(0);
    const interval=setInterval(()=>{
      setProgress(p=>{
        if(p>=100){
          clearInterval(interval);setUploading(false);setExtracting(true);
          setTimeout(async()=>{
            // Simulate AI extraction - add items to database
            const newItems=[
              {opportunity_id:selectedOpp.id,requirement_id:'L.3.1',title:'Transition Plan (AI Extracted)',section:'L',status:'identified',confidence:75},
              {opportunity_id:selectedOpp.id,requirement_id:'M.2',title:'Cost Breakdown (AI Extracted)',section:'M',status:'identified',confidence:82}
            ];
            for(const item of newItems){
              try{await MissionPulse.createComplianceItem(item)}catch(e){console.error(e)}
            }
            const data=await MissionPulse.getComplianceItems(selectedOpp.id);
            setRequirements(data);
            setExtracting(false);
          },2000);
          return 100;
        }
        return p+10;
      });
    },200);
  };

  const handleStatusChange=async(id,newStatus)=>{
    try{
      await MissionPulse.updateComplianceItem(id,{status:newStatus});
      setRequirements(requirements.map(r=>r.id===id?{...r,status:newStatus}:r));
    }catch(err){console.error(err)}
  };

  const handleAddItem=async()=>{
    if(!selectedOpp||!form.title)return;
    try{
      const item=await MissionPulse.createComplianceItem({...form,opportunity_id:selectedOpp.id});
      setRequirements([...requirements,item]);
      setShowForm(false);
      setForm({requirement_id:'',title:'',section:'L',status:'identified',confidence:50});
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete this requirement?'))return;
    try{
      await MissionPulse.deleteComplianceItem(id);
      setRequirements(requirements.filter(r=>r.id!==id));
    }catch(err){console.error(err)}
  };

  const exportMatrix=()=>{
    const csv='Ref,Title,Section,Status,Confidence\n'+requirements.map(r=>`${r.requirement_id||r.ref},${r.title},${r.section},${r.status},${r.confidence}`).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='compliance_matrix.csv';a.click();
  };

  const stats={
    total:requirements.length,
    compliant:requirements.filter(r=>r.status==='compliant').length,
    partial:requirements.filter(r=>r.status==='partial').length,
    risk:requirements.filter(r=>r.status==='risk').length
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">RFP Shredder</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Upload RFP to auto-extract requirements</p>
        </div>
        <div className="flex gap-2">
          {selectedOpp&&<button onClick={()=>setShowForm(true)} className="px-3 py-2 bg-emerald-500 text-white rounded-lg text-sm flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add Item</button>}
          {selectedOpp&&<button onClick={()=>fileRef.current?.click()} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="upload" className="w-4 h-4"/>Upload RFP</button>}
          <button onClick={exportMatrix} disabled={!requirements.length} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 disabled:opacity-50"><Icon name="download" className="w-4 h-4"/>Export CSV</button>
        </div>
        <input ref={fileRef} type="file" accept=".pdf,.docx" className="hidden" onChange={handleUpload}/>
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {/* Add Form */}
      {showForm&&selectedOpp&&(
        <div className="glass p-4 animate-fadeIn">
          <h3 className="font-semibold text-white mb-3">Add Compliance Item</h3>
          <div className="grid grid-cols-4 gap-3">
            <input placeholder="Ref (e.g. L.1.1)" value={form.requirement_id} onChange={e=>setForm({...form,requirement_id:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <input placeholder="Title" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <select value={form.section} onChange={e=>setForm({...form,section:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              <option value="L">Section L</option><option value="M">Section M</option><option value="K">Section K</option>
            </select>
          </div>
          <div className="flex justify-end gap-2 mt-3">
            <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
            <button onClick={handleAddItem} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
          </div>
        </div>
      )}

      {/* Upload Progress */}
      {(uploading||extracting)&&(
        <div className="glass p-6 text-center">
          {uploading?<><Spinner/><p className="text-white mt-4">Uploading RFP... {progress}%</p><div className="w-full max-w-xs mx-auto h-2 bg-slate-700 rounded-full mt-4 overflow-hidden"><div className="h-full bg-gradient-to-r from-cyan-500 to-teal-500 transition-all" style={{width:`${progress}%`}}/></div></>:
          <><div className="text-4xl mb-4">üîç</div><p className="text-white">AI Extracting Requirements...</p><p className="text-cyan-400 text-sm mt-2">Analyzing Sections L & M</p></>}
        </div>
      )}

      {/* Compliance Matrix */}
      {selectedOpp&&(
        <div className="glass overflow-hidden">
          <div className="p-4 border-b border-slate-700/50 flex justify-between items-center">
            <h3 className="font-semibold text-white">Compliance Matrix: {selectedOpp.nickname||selectedOpp.name}</h3>
            <div className="flex gap-2">
              {[{k:'compliant',l:'Compliant',c:stats.compliant},{k:'partial',l:'Partial',c:stats.partial},{k:'risk',l:'Risk',c:stats.risk}].map(s=>
                <span key={s.k} className={`px-2 py-1 rounded text-xs ${statusColors[s.k]}`}>{s.c} {s.l}</span>
              )}
            </div>
          </div>
          {loading?<div className="p-8 flex justify-center"><Spinner/></div>:(
            <table className="w-full">
              <thead className="bg-slate-800/50"><tr>{['Ref','Requirement','Section','Status','AI Conf',''].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
              <tbody className="divide-y divide-slate-700/50">
                {requirements.map(r=>(
                  <tr key={r.id} className="hover:bg-slate-800/30">
                    <td className="p-3 text-sm font-mono text-cyan-400">{r.requirement_id||r.ref}</td>
                    <td className="p-3 text-sm text-white">{r.title}</td>
                    <td className="p-3 text-sm text-slate-300">{r.section}</td>
                    <td className="p-3">
                      <select value={r.status} onChange={e=>handleStatusChange(r.id,e.target.value)} className={`px-2 py-1 rounded text-xs border-0 ${statusColors[r.status]} bg-transparent cursor-pointer`}>
                        <option value="identified">Identified</option>
                        <option value="compliant">Compliant</option>
                        <option value="partial">Partial</option>
                        <option value="risk">Risk</option>
                      </select>
                    </td>
                    <td className="p-3"><div className="flex items-center gap-2"><div className="w-12 h-1.5 bg-slate-700 rounded-full"><div className={`h-full rounded-full ${r.confidence>=85?'bg-emerald-500':r.confidence>=70?'bg-amber-500':'bg-red-500'}`} style={{width:`${r.confidence}%`}}/></div><span className="text-xs text-slate-400">{r.confidence}%</span></div></td>
                    <td className="p-3"><button onClick={()=>handleDelete(r.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üìÑ</div><p className="text-white text-lg mb-2">Select an opportunity to view compliance matrix</p><p className="text-slate-400">Upload RFP documents to auto-extract requirements</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: CONTRACT SCANNER (M5) - LIVE DATA
// ============================================================
function ModuleContracts({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[clauses,setClauses]=useState([]);
  const[loading,setLoading]=useState(false);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({clause_number:'',clause_title:'',clause_type:'FAR',risk_level:'low',notes:''});

  const riskColors={high:'bg-red-500/20 text-red-400',medium:'bg-amber-500/20 text-amber-400',low:'bg-emerald-500/20 text-emerald-400'};

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getContractClauses(selectedOpp.id);
      setClauses(data.length>0?data:[
        {id:'demo-1',clause_number:'52.212-4',clause_title:'Contract Terms and Conditions',clause_type:'FAR',risk_level:'low',compliance_status:'compliant'},
        {id:'demo-2',clause_number:'52.219-14',clause_title:'Limitations on Subcontracting',clause_type:'FAR',risk_level:'high',compliance_status:'pending'},
        {id:'demo-3',clause_number:'252.204-7012',clause_title:'DFARS Cybersecurity Requirements',clause_type:'DFARS',risk_level:'high',compliance_status:'partial'}
      ]);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleAddClause=async()=>{
    if(!selectedOpp||!form.clause_number)return;
    try{
      const clause=await MissionPulse.createContractClause({...form,opportunity_id:selectedOpp.id,compliance_status:'pending'});
      setClauses([...clauses,clause]);
      setShowForm(false);
      setForm({clause_number:'',clause_title:'',clause_type:'FAR',risk_level:'low',notes:''});
    }catch(err){console.error(err)}
  };

  const handleRiskChange=async(id,newRisk)=>{
    try{
      await MissionPulse.updateContractClause(id,{risk_level:newRisk});
      setClauses(clauses.map(c=>c.id===id?{...c,risk_level:newRisk}:c));
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete this clause?'))return;
    try{
      await MissionPulse.deleteContractClause(id);
      setClauses(clauses.filter(c=>c.id!==id));
    }catch(err){console.error(err)}
  };

  const stats={
    total:clauses.length,
    high:clauses.filter(c=>c.risk_level==='high').length,
    medium:clauses.filter(c=>c.risk_level==='medium').length,
    low:clauses.filter(c=>c.risk_level==='low').length
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Contract Scanner</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">FAR/DFARS clause analysis and risk scoring</p>
        </div>
        {selectedOpp&&<button onClick={()=>setShowForm(true)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add Clause</button>}
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {/* Risk Summary */}
      {selectedOpp&&(
        <div className="grid grid-cols-4 gap-4">
          <div className="glass p-4"><p className="text-slate-400 text-xs">Total Clauses</p><p className="text-2xl font-bold text-white">{stats.total}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">High Risk</p><p className="text-2xl font-bold text-red-400">{stats.high}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">Medium Risk</p><p className="text-2xl font-bold text-amber-400">{stats.medium}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">Low Risk</p><p className="text-2xl font-bold text-emerald-400">{stats.low}</p></div>
        </div>
      )}

      {/* Add Form */}
      {showForm&&(
        <div className="glass p-4 animate-fadeIn">
          <h3 className="font-semibold text-white mb-3">Add Contract Clause</h3>
          <div className="grid grid-cols-4 gap-3">
            <input placeholder="Clause # (e.g. 52.212-4)" value={form.clause_number} onChange={e=>setForm({...form,clause_number:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <input placeholder="Clause Title" value={form.clause_title} onChange={e=>setForm({...form,clause_title:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <select value={form.clause_type} onChange={e=>setForm({...form,clause_type:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              <option value="FAR">FAR</option><option value="DFARS">DFARS</option><option value="HHSAR">HHSAR</option><option value="VAAR">VAAR</option>
            </select>
            <select value={form.risk_level} onChange={e=>setForm({...form,risk_level:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              <option value="low">Low Risk</option><option value="medium">Medium Risk</option><option value="high">High Risk</option>
            </select>
            <input placeholder="Notes" value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
          </div>
          <div className="flex justify-end gap-2 mt-3">
            <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
            <button onClick={handleAddClause} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
          </div>
        </div>
      )}

      {/* Clauses Table */}
      {selectedOpp&&(
        <div className="glass overflow-hidden">
          <div className="p-4 border-b border-slate-700/50"><h3 className="font-semibold text-white">Contract Clauses: {selectedOpp.nickname||selectedOpp.name}</h3></div>
          {loading?<div className="p-8 flex justify-center"><Spinner/></div>:(
            <table className="w-full">
              <thead className="bg-slate-800/50"><tr>{['Clause','Title','Type','Risk','Status',''].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
              <tbody className="divide-y divide-slate-700/50">
                {clauses.map(c=>(
                  <tr key={c.id} className="hover:bg-slate-800/30">
                    <td className="p-3 text-sm font-mono text-cyan-400">{c.clause_number}</td>
                    <td className="p-3 text-sm text-white">{c.clause_title}</td>
                    <td className="p-3"><span className="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">{c.clause_type}</span></td>
                    <td className="p-3">
                      <select value={c.risk_level} onChange={e=>handleRiskChange(c.id,e.target.value)} className={`px-2 py-1 rounded text-xs border-0 ${riskColors[c.risk_level]} bg-transparent cursor-pointer`}>
                        <option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option>
                      </select>
                    </td>
                    <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${c.compliance_status==='compliant'?'bg-emerald-500/20 text-emerald-400':c.compliance_status==='partial'?'bg-amber-500/20 text-amber-400':'bg-slate-500/20 text-slate-400'}`}>{c.compliance_status}</span></td>
                    <td className="p-3"><button onClick={()=>handleDelete(c.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">‚öñÔ∏è</div><p className="text-white text-lg mb-2">Select an opportunity to scan contracts</p><p className="text-slate-400">Analyze FAR/DFARS clauses and assess risk</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: IRON DOME (M6) - RISK AGGREGATION VIEW
// ============================================================
function ModuleIronDome({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[complianceStats,setComplianceStats]=useState(null);
  const[contractStats,setContractStats]=useState(null);
  const[loading,setLoading]=useState(false);

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const[cStats,ctStats]=await Promise.all([
        MissionPulse.getComplianceStats(selectedOpp.id),
        MissionPulse.getContractRiskSummary(selectedOpp.id)
      ]);
      setComplianceStats(cStats.total>0?cStats:{total:4,compliant:2,partial:1,risk:1,score:50});
      setContractStats(ctStats.total>0?ctStats:{total:3,high:1,medium:1,low:1});
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const overallRisk=()=>{
    if(!complianceStats||!contractStats)return 'unknown';
    const riskScore=(complianceStats.risk*3+complianceStats.partial+contractStats.high*3+contractStats.medium);
    if(riskScore>=6)return 'high';
    if(riskScore>=3)return 'medium';
    return 'low';
  };

  const riskColor={high:'text-red-400',medium:'text-amber-400',low:'text-emerald-400',unknown:'text-slate-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Iron Dome</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Aggregated risk assessment and defense posture</p>
        </div>
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {selectedOpp&&!loading&&(
        <>
          {/* Overall Risk Score */}
          <div className="glass p-6 bg-gradient-to-r from-slate-800/50 to-slate-900/50">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold text-white">Overall Risk Assessment</h3>
                <p className="text-slate-400 text-sm">{selectedOpp.nickname||selectedOpp.name}</p>
              </div>
              <div className="text-right">
                <div className={`text-4xl font-bold uppercase ${riskColor[overallRisk()]}`}>{overallRisk()}</div>
                <p className="text-xs text-slate-500">Risk Level</p>
              </div>
            </div>
          </div>

          {/* Risk Breakdown */}
          <div className="grid grid-cols-2 gap-4">
            {/* Compliance Risks */}
            <div className="glass p-4">
              <h3 className="font-semibold text-white mb-4 flex items-center gap-2">üìÑ Compliance Risks</h3>
              {complianceStats&&(
                <div className="space-y-3">
                  <div className="flex justify-between items-center"><span className="text-sm text-slate-400">Total Requirements</span><span className="text-white font-medium">{complianceStats.total}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-emerald-400">Compliant</span><span className="text-white">{complianceStats.compliant}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-amber-400">Partial</span><span className="text-white">{complianceStats.partial}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-red-400">At Risk</span><span className="text-white">{complianceStats.risk}</span></div>
                  <div className="h-2 bg-slate-700 rounded-full overflow-hidden mt-2">
                    <div className="h-full bg-gradient-to-r from-emerald-500 to-cyan-500" style={{width:`${complianceStats.score}%`}}/>
                  </div>
                  <p className="text-xs text-slate-500 text-center">Compliance Score: {complianceStats.score}%</p>
                </div>
              )}
            </div>

            {/* Contract Risks */}
            <div className="glass p-4">
              <h3 className="font-semibold text-white mb-4 flex items-center gap-2">‚öñÔ∏è Contract Risks</h3>
              {contractStats&&(
                <div className="space-y-3">
                  <div className="flex justify-between items-center"><span className="text-sm text-slate-400">Total Clauses</span><span className="text-white font-medium">{contractStats.total}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-red-400">High Risk</span><span className="text-white">{contractStats.high}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-amber-400">Medium Risk</span><span className="text-white">{contractStats.medium}</span></div>
                  <div className="flex justify-between items-center"><span className="text-sm text-emerald-400">Low Risk</span><span className="text-white">{contractStats.low}</span></div>
                  <div className="flex gap-1 mt-2">
                    {Array(contractStats.high).fill().map((_,i)=><div key={`h${i}`} className="flex-1 h-4 bg-red-500/50 rounded"/>)}
                    {Array(contractStats.medium).fill().map((_,i)=><div key={`m${i}`} className="flex-1 h-4 bg-amber-500/50 rounded"/>)}
                    {Array(contractStats.low).fill().map((_,i)=><div key={`l${i}`} className="flex-1 h-4 bg-emerald-500/50 rounded"/>)}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Recommendations */}
          <div className="glass p-4">
            <h3 className="font-semibold text-white mb-3">üõ°Ô∏è Defense Recommendations</h3>
            <div className="space-y-2">
              {complianceStats?.risk>0&&<div className="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-300">‚ö†Ô∏è {complianceStats.risk} compliance item(s) at risk - prioritize resolution before submission</div>}
              {contractStats?.high>0&&<div className="p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg text-sm text-amber-300">üìã {contractStats.high} high-risk contract clause(s) require mitigation strategies</div>}
              {complianceStats?.score>=80&&<div className="p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-lg text-sm text-emerald-300">‚úÖ Strong compliance posture ({complianceStats.score}%) - maintain current trajectory</div>}
            </div>
          </div>
        </>
      )}

      {loading&&<div className="glass p-8 flex justify-center"><Spinner/></div>}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><p className="text-white text-lg mb-2">Select an opportunity to view risk assessment</p><p className="text-slate-400">Aggregated view of compliance and contract risks</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: BLACK HAT (M7) - COMPETITOR INTEL - LIVE DATA
// ============================================================
function ModuleBlackHat({opps,isLive,role}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[competitors,setCompetitors]=useState([]);
  const[loading,setLoading]=useState(false);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({company_name:'',threat_level:'medium',incumbent:false,strengths:'',weaknesses:'',ghost_strategy:''});

  // RBAC: Only CEO, COO, CAP can access
  const allowed=['CEO','COO','CAP'];
  if(!allowed.includes(role?.id)){
    return(<div className="glass p-12 text-center animate-fadeIn"><div className="text-6xl mb-4">üîí</div><h2 className="text-xl font-bold text-red-400 mb-2">Access Restricted</h2><p className="text-slate-400">Black Hat module is restricted to CEO, COO, and Capture leads</p><p className="text-xs text-slate-500 mt-2">Current role: {role?.name||'Unknown'}</p></div>);
  }

  const threatColors={high:'bg-red-500/20 text-red-400 border-red-500/30',medium:'bg-amber-500/20 text-amber-400 border-amber-500/30',low:'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'};

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getCompetitors(selectedOpp.id);
      setCompetitors(data.length>0?data:[
        {id:'demo-1',company_name:'Leidos',threat_level:'high',incumbent:true,strengths:['Incumbent advantage','Deep agency relationships'],weaknesses:['Higher rates','Slow to innovate'],ghost_strategy:'Highlight innovation velocity'},
        {id:'demo-2',company_name:'Booz Allen',threat_level:'medium',incumbent:false,strengths:['Strong past performance','Technical depth'],weaknesses:['Premium pricing'],ghost_strategy:'Compete on value and agility'}
      ]);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleAdd=async()=>{
    if(!selectedOpp||!form.company_name)return;
    try{
      const competitor=await MissionPulse.createCompetitor({
        ...form,
        opportunity_id:selectedOpp.id,
        strengths:form.strengths.split(',').map(s=>s.trim()).filter(Boolean),
        weaknesses:form.weaknesses.split(',').map(s=>s.trim()).filter(Boolean)
      });
      setCompetitors([...competitors,competitor]);
      setShowForm(false);
      setForm({company_name:'',threat_level:'medium',incumbent:false,strengths:'',weaknesses:'',ghost_strategy:''});
    }catch(err){console.error(err)}
  };

  const handleThreatChange=async(id,newLevel)=>{
    try{
      await MissionPulse.updateCompetitor(id,{threat_level:newLevel});
      setCompetitors(competitors.map(c=>c.id===id?{...c,threat_level:newLevel}:c));
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete competitor?'))return;
    try{
      await MissionPulse.deleteCompetitor(id);
      setCompetitors(competitors.filter(c=>c.id!==id));
    }catch(err){console.error(err)}
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Black Hat Analysis</h2>
            <span className="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">PRIVATE</span>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Competitor intelligence and ghost strategies</p>
        </div>
        {selectedOpp&&<button onClick={()=>setShowForm(true)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add Competitor</button>}
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {/* Add Form */}
      {showForm&&(
        <div className="glass p-4 animate-fadeIn">
          <h3 className="font-semibold text-white mb-3">Add Competitor</h3>
          <div className="grid grid-cols-3 gap-3">
            <input placeholder="Company Name" value={form.company_name} onChange={e=>setForm({...form,company_name:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <select value={form.threat_level} onChange={e=>setForm({...form,threat_level:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              <option value="low">Low Threat</option><option value="medium">Medium Threat</option><option value="high">High Threat</option>
            </select>
            <label className="flex items-center gap-2 text-sm text-white"><input type="checkbox" checked={form.incumbent} onChange={e=>setForm({...form,incumbent:e.target.checked})} className="rounded"/>Incumbent</label>
            <input placeholder="Strengths (comma-separated)" value={form.strengths} onChange={e=>setForm({...form,strengths:e.target.value})} className="col-span-3 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <input placeholder="Weaknesses (comma-separated)" value={form.weaknesses} onChange={e=>setForm({...form,weaknesses:e.target.value})} className="col-span-3 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <textarea placeholder="Ghost Strategy" value={form.ghost_strategy} onChange={e=>setForm({...form,ghost_strategy:e.target.value})} className="col-span-3 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white h-16"/>
          </div>
          <div className="flex justify-end gap-2 mt-3">
            <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
            <button onClick={handleAdd} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
          </div>
        </div>
      )}

      {/* Competitors Grid */}
      {selectedOpp&&(
        <div className="space-y-4">
          {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
            <div className="grid grid-cols-2 gap-4">
              {competitors.map(c=>(
                <div key={c.id} className={`glass p-4 border ${threatColors[c.threat_level]}`}>
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h4 className="font-semibold text-white flex items-center gap-2">{c.company_name}{c.incumbent&&<span className="px-1.5 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">INCUMBENT</span>}</h4>
                    </div>
                    <div className="flex items-center gap-2">
                      <select value={c.threat_level} onChange={e=>handleThreatChange(c.id,e.target.value)} className={`px-2 py-1 rounded text-xs border-0 ${threatColors[c.threat_level]} bg-transparent cursor-pointer`}>
                        <option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option>
                      </select>
                      <button onClick={()=>handleDelete(c.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><p className="text-xs text-emerald-400 mb-1">Strengths</p><ul className="text-slate-300 text-xs space-y-0.5">{(c.strengths||[]).map((s,i)=><li key={i}>‚Ä¢ {s}</li>)}</ul></div>
                    <div><p className="text-xs text-red-400 mb-1">Weaknesses</p><ul className="text-slate-300 text-xs space-y-0.5">{(c.weaknesses||[]).map((w,i)=><li key={i}>‚Ä¢ {w}</li>)}</ul></div>
                  </div>
                  {c.ghost_strategy&&<div className="mt-3 p-2 bg-slate-800/50 rounded"><p className="text-xs text-cyan-400 mb-1">üëª Ghost Strategy</p><p className="text-sm text-white">{c.ghost_strategy}</p></div>}
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üé≠</div><p className="text-white text-lg mb-2">Select an opportunity for competitor analysis</p><p className="text-slate-400">Analyze competitors and develop ghost strategies</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: HITL REVIEW QUEUE (M9) - LIVE DATA
// ============================================================
function ModuleHITL({opps,isLive}){
  const[items,setItems]=useState([]);
  const[loading,setLoading]=useState(true);
  const[editing,setEditing]=useState(null);
  const[editContent,setEditContent]=useState('');
  const[reviewNotes,setReviewNotes]=useState('');

  useEffect(()=>{
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getAIApprovals();
      setItems(data.length>0?data:DEMO_HITL);
      setLoading(false);
    };
    load();
  },[]);

  const handleApprove=async(id)=>{
    try{
      await MissionPulse.approveContent(id,reviewNotes||null);
      setItems(items.map(i=>i.id===id?{...i,status:'approved'}:i));
      setEditing(null);
      setReviewNotes('');
    }catch(err){console.error(err);setItems(items.map(i=>i.id===id?{...i,status:'approved'}:i))}
  };

  const handleReject=async(id)=>{
    if(!reviewNotes){alert('Please provide rejection notes');return}
    try{
      await MissionPulse.rejectContent(id,reviewNotes);
      setItems(items.map(i=>i.id===id?{...i,status:'rejected'}:i));
      setEditing(null);
      setReviewNotes('');
    }catch(err){console.error(err);setItems(items.map(i=>i.id===id?{...i,status:'rejected'}:i))}
  };

  const handleEdit=(item)=>{
    setEditing(item);
    setEditContent(item.content||`AI-generated content for: ${item.title}\n\nThis is the draft content requiring human review.`);
  };

  const pending=items.filter(i=>i.status==='pending');
  const reviewed=items.filter(i=>i.status!=='pending');

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">HITL Review Queue</h2>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">Human-in-the-Loop approval workflow</p>
        </div>
        <div className="flex gap-2">
          <span className="px-3 py-1.5 bg-amber-500/20 text-amber-400 rounded-lg text-sm font-medium">{pending.length} Pending</span>
          <span className="px-3 py-1.5 bg-emerald-500/20 text-emerald-400 rounded-lg text-sm font-medium">{reviewed.filter(i=>i.status==='approved').length} Approved</span>
        </div>
      </div>

      {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
        <div className="grid grid-cols-2 gap-4">
          <div>
            <h3 className="font-semibold text-white mb-3">Pending Review</h3>
            <div className="space-y-3">
              {pending.map(item=>(
                <div key={item.id} className="glass p-4 hover-lift">
                  <div className="flex justify-between items-start mb-2">
                    <span className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">{item.content_type||item.type}</span>
                    <span className="text-xs text-slate-500">{new Date(item.created_at||item.created).toLocaleDateString()}</span>
                  </div>
                  <h4 className="font-medium text-white mb-1">{item.title}</h4>
                  <p className="text-xs text-slate-400 mb-3">Agent: {item.agent_type||item.agent}</p>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <div className="w-20 h-1.5 bg-slate-700 rounded-full">
                        <div className={`h-full rounded-full ${item.confidence>=85?'bg-emerald-500':item.confidence>=70?'bg-amber-500':'bg-red-500'}`} style={{width:`${item.confidence}%`}}/>
                      </div>
                      <span className={`text-xs ${item.confidence>=85?'text-emerald-400':item.confidence>=70?'text-amber-400':'text-red-400'}`}>{item.confidence}%</span>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={()=>handleEdit(item)} className="px-2 py-1 bg-slate-700 text-white rounded text-xs">Review</button>
                      <button onClick={()=>handleApprove(item.id)} className="px-2 py-1 bg-emerald-500 text-white rounded text-xs">‚úì</button>
                      <button onClick={()=>{setEditing(item);setReviewNotes('Rejected: ')}} className="px-2 py-1 bg-red-500 text-white rounded text-xs">‚úó</button>
                    </div>
                  </div>
                </div>
              ))}
              {pending.length===0&&<div className="glass p-6 text-center text-slate-400">No pending items</div>}
            </div>
          </div>
          <div>
            <h3 className="font-semibold text-white mb-3">Recently Reviewed</h3>
            <div className="space-y-2">
              {reviewed.slice(0,10).map(item=>(
                <div key={item.id} className="glass p-3 opacity-60">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-white">{item.title}</span>
                    <span className={`px-2 py-0.5 rounded text-xs ${item.status==='approved'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}`}>{item.status}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {editing&&(
        <div className="glass p-6 animate-fadeIn">
          <h3 className="font-semibold text-white mb-4">Review: {editing.title}</h3>
          <textarea value={editContent} onChange={e=>setEditContent(e.target.value)} className="w-full h-48 bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white resize-none mb-3"/>
          <textarea placeholder="Reviewer notes (required for rejection)" value={reviewNotes} onChange={e=>setReviewNotes(e.target.value)} className="w-full h-16 bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm text-white resize-none"/>
          <div className="flex justify-end gap-2 mt-4">
            <button onClick={()=>{setEditing(null);setReviewNotes('')}} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm">Cancel</button>
            <button onClick={()=>handleReject(editing.id)} className="px-4 py-2 bg-red-500 text-white rounded-lg text-sm">Reject</button>
            <button onClick={()=>handleApprove(editing.id)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm">Approve</button>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// MODULE: ORALS STUDIO (M10) - LIVE DATA
// ============================================================
function ModuleOrals({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[generating,setGenerating]=useState(false);
  const[slides,setSlides]=useState([]);
  const[current,setCurrent]=useState(0);
  const[timer,setTimer]=useState(0);
  const[practicing,setPracticing]=useState(false);
  const[saving,setSaving]=useState(false);

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      const deck=await MissionPulse.getOralsDeck(selectedOpp.id);
      if(deck&&deck.slides){
        try{
          const parsed=typeof deck.slides==='string'?JSON.parse(deck.slides):deck.slides;
          if(Array.isArray(parsed)&&parsed.length>0)setSlides(parsed);
        }catch(e){console.error(e)}
      }
    };
    load();
  },[selectedOpp]);

  const generateDeck=()=>{
    setGenerating(true);setSlides([]);let i=0;
    const interval=setInterval(()=>{
      if(i<ORALS_SLIDES.length){
        setSlides(prev=>[...prev,{id:i+1,title:ORALS_SLIDES[i],bullets:['Key point 1','Key point 2','Key point 3'],talkingPoints:['Emphasize value','Reference past performance','Address concerns']}]);
        i++;
      }else{
        clearInterval(interval);setGenerating(false);
      }
    },400);
  };

  const saveDeck=async()=>{
    if(!selectedOpp||slides.length===0)return;
    setSaving(true);
    try{await MissionPulse.saveOralsDeck(selectedOpp.id,slides)}catch(e){console.error(e)}
    setSaving(false);
  };

  useEffect(()=>{let interval;if(practicing){interval=setInterval(()=>setTimer(t=>t+1),1000)}return()=>clearInterval(interval)},[practicing]);
  const formatTime=(s)=>`${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Orals Studio</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">AI-powered presentation deck generator</p>
        </div>
        <div className="flex gap-2">
          {slides.length>0&&selectedOpp&&<button onClick={saveDeck} disabled={saving} className="px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium flex items-center gap-2">{saving?<Spinner size="sm"/>:<Icon name="save" className="w-4 h-4"/>}Save Deck</button>}
          {slides.length>0&&<button onClick={()=>{setPracticing(!practicing);if(practicing)setTimer(0)}} className={`px-4 py-2 rounded-lg font-medium ${practicing?'bg-red-500 text-white':'bg-emerald-500 text-white'}`}>{practicing?'‚èπ Stop':'‚ñ∂Ô∏è Practice'}</button>}
        </div>
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>{setSelectedOpp(opps.find(o=>o.id===e.target.value)||null);setSlides([])}} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {selectedOpp&&slides.length===0&&!generating&&(
        <div className="glass p-6 text-center">
          <button onClick={generateDeck} className="px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg font-medium text-lg">üé§ Generate 10-Slide Deck</button>
          <p className="text-slate-400 text-sm mt-3">AI will create branded slides with talking points for {selectedOpp.nickname||selectedOpp.name}</p>
        </div>
      )}

      {generating&&<div className="glass p-8 text-center"><Spinner/><p className="text-white mt-4">Generating slides... {slides.length}/{ORALS_SLIDES.length}</p></div>}

      {slides.length>0&&!generating&&(
        <div className="grid grid-cols-4 gap-4">
          <div className="col-span-1 space-y-2">
            <div className="text-sm font-semibold text-white mb-2">Slides ({slides.length})</div>
            <div className="space-y-1 max-h-96 overflow-y-auto">
              {slides.map((s,i)=><button key={s.id} onClick={()=>setCurrent(i)} className={`w-full text-left p-2 rounded-lg text-sm ${current===i?'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30':'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}>{i+1}. {s.title}</button>)}
            </div>
          </div>
          <div className="col-span-3">
            {practicing&&<div className="glass p-4 mb-4 flex items-center justify-between"><span className="text-white font-medium">Practice Timer</span><span className="text-2xl font-mono text-cyan-400">{formatTime(timer)}</span><span className="text-sm text-slate-400">Target: 02:00/slide</span></div>}
            <div className="glass p-6">
              <div className="aspect-video bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-8 mb-4 border border-slate-700">
                <div className="h-1 w-24 bg-gradient-to-r from-cyan-500 to-teal-500 rounded mb-4"/>
                <h3 className="text-2xl font-bold text-white mb-4">{slides[current]?.title}</h3>
                <ul className="space-y-2">{slides[current]?.bullets.map((b,i)=><li key={i} className="text-slate-300 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-cyan-400"/>‚Ä¢ {b}</li>)}</ul>
              </div>
              <div><div className="text-sm font-semibold text-white mb-2">üí° Talking Points:</div><ul className="space-y-1">{slides[current]?.talkingPoints.map((t,i)=><li key={i} className="text-sm text-slate-400">‚Ä¢ {t}</li>)}</ul></div>
            </div>
            <div className="flex justify-between mt-4">
              <button disabled={current===0} onClick={()=>setCurrent(c=>c-1)} className="px-4 py-2 bg-slate-700 text-white rounded-lg disabled:opacity-50">‚Üê Previous</button>
              <span className="text-slate-400 self-center">{current+1} / {slides.length}</span>
              <button disabled={current===slides.length-1} onClick={()=>setCurrent(c=>c+1)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg disabled:opacity-50">Next ‚Üí</button>
            </div>
          </div>
        </div>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üé§</div><p className="text-white text-lg mb-2">Select an opportunity to create presentation</p><p className="text-slate-400">AI will generate branded slides with talking points</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: PRICING ENGINE (M8) - LIVE DATA
// ============================================================
function ModulePricing({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[lcats,setLcats]=useState([]);
  const[loading,setLoading]=useState(false);
  const[wrapRate,setWrapRate]=useState(1.85);

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getPricingItems(selectedOpp.id);
      setLcats(data.length>0?data.map(d=>({...d,title:d.labor_category,rate:parseFloat(d.rate)||0,hours:d.hours||0})):DEMO_LCATS);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const totalDirect=lcats.reduce((s,l)=>s+((parseFloat(l.rate)||0)*(l.hours||0)),0);
  const totalWrapped=totalDirect*wrapRate;

  const updateLcat=async(id,field,value)=>{
    const numVal=field==='title'?value:(parseFloat(value)||0);
    setLcats(lcats.map(l=>l.id===id?{...l,[field]:numVal}:l));
    try{
      await MissionPulse.updatePricingItem(id,{[field==='title'?'labor_category':field]:numVal});
    }catch(err){console.error(err)}
  };

  const addLcat=async()=>{
    if(!selectedOpp)return;
    try{
      const item=await MissionPulse.createPricingItem({opportunity_id:selectedOpp.id,labor_category:'New LCAT',rate:100,hours:2080});
      setLcats([...lcats,{...item,title:item.labor_category,rate:parseFloat(item.rate),hours:item.hours}]);
    }catch(err){console.error(err);setLcats([...lcats,{id:Date.now(),title:'New LCAT',rate:100,hours:2080}])}
  };

  const removeLcat=async(id)=>{
    try{
      await MissionPulse.deletePricingItem(id);
      setLcats(lcats.filter(l=>l.id!==id));
    }catch(err){console.error(err);setLcats(lcats.filter(l=>l.id!==id))}
  };

  const exportBOE=()=>{
    const csv='LCAT,Rate,Hours,Extended,Wrapped\n'+lcats.map(l=>`${l.title||l.labor_category},${l.rate},${l.hours},${(l.rate||0)*(l.hours||0)},${(l.rate||0)*(l.hours||0)*wrapRate}`).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='boe_pricing.csv';a.click();
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Pricing Engine</h2>
            <span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">CUI</span>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">LCAT mapping and BOE builder</p>
        </div>
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {selectedOpp&&(
        <>
          <div className="grid grid-cols-4 gap-4">
            <div className="glass p-4"><p className="text-slate-400 text-xs">Direct Labor</p><p className="text-2xl font-bold text-white">{MissionPulse.fmt(totalDirect)}</p></div>
            <div className="glass p-4">
              <p className="text-slate-400 text-xs">Wrap Rate</p>
              <input type="number" step="0.01" value={wrapRate} onChange={e=>setWrapRate(parseFloat(e.target.value)||1.85)} className="text-2xl font-bold text-cyan-400 bg-transparent w-20 focus:outline-none"/>
            </div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Total Wrapped</p><p className="text-2xl font-bold text-emerald-400">{MissionPulse.fmt(totalWrapped)}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">LCATs</p><p className="text-2xl font-bold text-purple-400">{lcats.length}</p></div>
          </div>

          <div className="glass overflow-hidden">
            <div className="p-4 border-b border-slate-700/50 flex justify-between items-center">
              <h3 className="font-semibold text-white">Labor Categories: {selectedOpp.nickname||selectedOpp.name}</h3>
              <div className="flex gap-2">
                <button onClick={addLcat} className="px-3 py-1.5 bg-cyan-500 text-white rounded-lg text-sm flex items-center gap-1"><Icon name="plus" className="w-4 h-4"/>Add LCAT</button>
                <button onClick={exportBOE} className="px-3 py-1.5 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-1"><Icon name="download" className="w-4 h-4"/>Export</button>
              </div>
            </div>
            {loading?<div className="p-8 flex justify-center"><Spinner/></div>:(
              <table className="w-full">
                <thead className="bg-slate-800/50"><tr>{['LCAT','Rate','Hours','Extended','Wrapped',''].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
                <tbody className="divide-y divide-slate-700/50">
                  {lcats.map(l=>(
                    <tr key={l.id} className="hover:bg-slate-800/30">
                      <td className="p-3"><input value={l.title||l.labor_category||''} onChange={e=>updateLcat(l.id,'title',e.target.value)} className="bg-transparent text-sm text-white w-full focus:outline-none"/></td>
                      <td className="p-3"><input type="number" value={l.rate||0} onChange={e=>updateLcat(l.id,'rate',e.target.value)} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-emerald-400 w-20"/></td>
                      <td className="p-3"><input type="number" value={l.hours||0} onChange={e=>updateLcat(l.id,'hours',e.target.value)} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white w-20"/></td>
                      <td className="p-3 text-sm text-white">{MissionPulse.fmt((l.rate||0)*(l.hours||0))}</td>
                      <td className="p-3 text-sm text-cyan-400 font-medium">{MissionPulse.fmt((l.rate||0)*(l.hours||0)*wrapRate)}</td>
                      <td className="p-3"><button onClick={()=>removeLcat(l.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üí∞</div><p className="text-white text-lg mb-2">Select an opportunity to build pricing</p><p className="text-slate-400">Create BOE with labor categories and wrap rates</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: PLAYBOOK (M11) - LIVE DATA
// ============================================================
function ModulePlaybook({isLive}){
  const[items,setItems]=useState([]);
  const[loading,setLoading]=useState(true);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({category:'Capture',title:'',content:'',score:80});
  const[filter,setFilter]=useState('all');

  const categories=['Capture','Pricing','Compliance','Technical','Management','Past Performance'];

  useEffect(()=>{
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getPlaybookItems();
      setItems(data.length>0?data:DEMO_PLAYBOOK);
      setLoading(false);
    };
    load();
  },[]);

  const handleAdd=async()=>{
    if(!form.title)return;
    try{
      const item=await MissionPulse.createPlaybookItem(form);
      setItems([item,...items]);
      setShowForm(false);
      setForm({category:'Capture',title:'',content:'',score:80});
    }catch(err){console.error(err)}
  };

  const handleUse=async(id)=>{
    try{
      const updated=await MissionPulse.incrementPlaybookUse(id);
      setItems(items.map(i=>i.id===id?{...i,uses:(i.uses||0)+1}:i));
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete this playbook item?'))return;
    try{
      await MissionPulse.deletePlaybookItem(id);
      setItems(items.filter(i=>i.id!==id));
    }catch(err){console.error(err)}
  };

  const filtered=filter==='all'?items:items.filter(i=>i.category===filter);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Winning Playbook</h2>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">Golden examples and lessons learned</p>
        </div>
        <button onClick={()=>setShowForm(true)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add to Playbook</button>
      </div>

      {/* Category Filter */}
      <div className="flex gap-2 flex-wrap">
        <button onClick={()=>setFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm ${filter==='all'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>All ({items.length})</button>
        {categories.map(c=>{
          const count=items.filter(i=>i.category===c).length;
          return<button key={c} onClick={()=>setFilter(c)} className={`px-3 py-1.5 rounded-lg text-sm ${filter===c?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>{c} ({count})</button>
        })}
      </div>

      {/* Add Form */}
      {showForm&&(
        <div className="glass p-4 animate-fadeIn">
          <h3 className="font-semibold text-white mb-3">Add Playbook Item</h3>
          <div className="grid grid-cols-3 gap-3">
            <select value={form.category} onChange={e=>setForm({...form,category:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              {categories.map(c=><option key={c} value={c}>{c}</option>)}
            </select>
            <input placeholder="Title" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <textarea placeholder="Content / Example" value={form.content} onChange={e=>setForm({...form,content:e.target.value})} className="col-span-3 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white h-20"/>
            <div className="flex items-center gap-2">
              <span className="text-xs text-slate-400">Score:</span>
              <input type="number" min="0" max="100" value={form.score} onChange={e=>setForm({...form,score:parseInt(e.target.value)||0})} className="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            </div>
          </div>
          <div className="flex justify-end gap-2 mt-3">
            <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
            <button onClick={handleAdd} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
          </div>
        </div>
      )}

      {/* Playbook Grid */}
      {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
        <div className="grid grid-cols-3 gap-4">
          {filtered.map(i=>(
            <div key={i.id} className="glass p-4 hover-lift">
              <div className="flex items-start justify-between mb-2">
                <span className="text-2xl">‚≠ê</span>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs">{i.category}</span>
                  <button onClick={()=>handleDelete(i.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-3 h-3"/></button>
                </div>
              </div>
              <h4 className="font-medium text-white mb-2">{i.title}</h4>
              {i.content&&<p className="text-xs text-slate-400 mb-2 line-clamp-2">{i.content}</p>}
              <div className="flex justify-between items-center text-xs text-slate-400">
                <span>Score: {i.score}%</span>
                <button onClick={()=>handleUse(i.id)} className="px-2 py-0.5 bg-slate-700 rounded hover:bg-slate-600">{i.uses||0} uses ‚Üó</button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================================
// MODULE: FRENEMY PROTOCOL (M12) - PARTNER ACCESS
// ============================================================
function ModuleFrenemy({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[partners,setPartners]=useState([]);
  const[loading,setLoading]=useState(false);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({partner_company:'',partner_email:'',access_level:'read',sections:[],nda_signed:false,auto_revoke_on_submit:true});

  const sections=['Technical Volume','Management Volume','Past Performance','Pricing','Compliance Matrix'];
  const statusColors={pending:'bg-amber-500/20 text-amber-400',active:'bg-emerald-500/20 text-emerald-400',revoked:'bg-red-500/20 text-red-400',expired:'bg-slate-500/20 text-slate-400'};

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getPartnerAccess(selectedOpp.id);
      setPartners(data.length>0?data:[
        {id:'demo-1',partner_company:'Acme Solutions',partner_email:'partner@acme.com',access_level:'read',sections:['Technical Volume'],nda_signed:true,status:'active',auto_revoke_on_submit:true},
        {id:'demo-2',partner_company:'Beta Corp',partner_email:'team@beta.io',access_level:'write',sections:['Past Performance','Management Volume'],nda_signed:true,status:'pending',auto_revoke_on_submit:true}
      ]);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleInvite=async()=>{
    if(!selectedOpp||!form.partner_company||!form.partner_email)return;
    try{
      const partner=await MissionPulse.invitePartner({...form,opportunity_id:selectedOpp.id});
      setPartners([partner,...partners]);
      setShowForm(false);
      setForm({partner_company:'',partner_email:'',access_level:'read',sections:[],nda_signed:false,auto_revoke_on_submit:true});
    }catch(err){console.error(err)}
  };

  const handleStatusChange=async(id,newStatus)=>{
    try{
      await MissionPulse.updatePartnerStatus(id,newStatus);
      setPartners(partners.map(p=>p.id===id?{...p,status:newStatus}:p));
    }catch(err){console.error(err)}
  };

  const handleRevokeAll=async()=>{
    if(!selectedOpp||!confirm('Revoke ALL partner access for this opportunity?'))return;
    try{
      await MissionPulse.revokeAllPartners(selectedOpp.id);
      setPartners(partners.map(p=>p.auto_revoke_on_submit?{...p,status:'revoked'}:p));
    }catch(err){console.error(err)}
  };

  const toggleSection=(section)=>{
    setForm(f=>({...f,sections:f.sections.includes(section)?f.sections.filter(s=>s!==section):[...f.sections,section]}));
  };

  const activeCount=partners.filter(p=>p.status==='active').length;

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Frenemy Protocol</h2>
            <span className="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">PRIVATE</span>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Teaming partner access control with auto-revoke</p>
        </div>
        <div className="flex gap-2">
          {selectedOpp&&activeCount>0&&<button onClick={handleRevokeAll} className="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 rounded-lg text-sm font-medium">‚ö†Ô∏è Revoke All</button>}
          {selectedOpp&&<button onClick={()=>setShowForm(true)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Invite Partner</button>}
        </div>
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {/* Stats */}
      {selectedOpp&&(
        <div className="grid grid-cols-4 gap-4">
          <div className="glass p-4"><p className="text-slate-400 text-xs">Total Partners</p><p className="text-2xl font-bold text-white">{partners.length}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">Active</p><p className="text-2xl font-bold text-emerald-400">{activeCount}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">Pending NDA</p><p className="text-2xl font-bold text-amber-400">{partners.filter(p=>!p.nda_signed).length}</p></div>
          <div className="glass p-4"><p className="text-slate-400 text-xs">Auto-Revoke</p><p className="text-2xl font-bold text-cyan-400">{partners.filter(p=>p.auto_revoke_on_submit&&p.status!=='revoked').length}</p></div>
        </div>
      )}

      {/* Invite Form */}
      {showForm&&(
        <div className="glass p-4 animate-fadeIn">
          <h3 className="font-semibold text-white mb-3">Invite Teaming Partner</h3>
          <div className="grid grid-cols-3 gap-3">
            <input placeholder="Company Name" value={form.partner_company} onChange={e=>setForm({...form,partner_company:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <input placeholder="Email Address" type="email" value={form.partner_email} onChange={e=>setForm({...form,partner_email:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
            <select value={form.access_level} onChange={e=>setForm({...form,access_level:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
              <option value="read">Read Only</option><option value="write">Read/Write</option><option value="admin">Admin</option>
            </select>
          </div>
          <div className="mt-3">
            <p className="text-xs text-slate-400 mb-2">Section Access:</p>
            <div className="flex flex-wrap gap-2">
              {sections.map(s=><button key={s} onClick={()=>toggleSection(s)} className={`px-2 py-1 rounded text-xs ${form.sections.includes(s)?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>{s}</button>)}
            </div>
          </div>
          <div className="flex items-center gap-4 mt-3">
            <label className="flex items-center gap-2 text-sm text-white"><input type="checkbox" checked={form.nda_signed} onChange={e=>setForm({...form,nda_signed:e.target.checked})} className="rounded"/>NDA Signed</label>
            <label className="flex items-center gap-2 text-sm text-white"><input type="checkbox" checked={form.auto_revoke_on_submit} onChange={e=>setForm({...form,auto_revoke_on_submit:e.target.checked})} className="rounded"/>Auto-revoke on submit</label>
          </div>
          <div className="flex justify-end gap-2 mt-3">
            <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
            <button onClick={handleInvite} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Send Invite</button>
          </div>
        </div>
      )}

      {/* Partners Table */}
      {selectedOpp&&(
        <div className="glass overflow-hidden">
          <div className="p-4 border-b border-slate-700/50"><h3 className="font-semibold text-white">Partner Access: {selectedOpp.nickname||selectedOpp.name}</h3></div>
          {loading?<div className="p-8 flex justify-center"><Spinner/></div>:(
            <table className="w-full">
              <thead className="bg-slate-800/50"><tr>{['Company','Email','Access','Sections','NDA','Status',''].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
              <tbody className="divide-y divide-slate-700/50">
                {partners.map(p=>(
                  <tr key={p.id} className={`hover:bg-slate-800/30 ${p.status==='revoked'?'opacity-50':''}`}>
                    <td className="p-3 text-sm text-white font-medium">{p.partner_company}</td>
                    <td className="p-3 text-sm text-slate-400">{p.partner_email}</td>
                    <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${p.access_level==='admin'?'bg-purple-500/20 text-purple-400':p.access_level==='write'?'bg-cyan-500/20 text-cyan-400':'bg-slate-500/20 text-slate-400'}`}>{p.access_level}</span></td>
                    <td className="p-3 text-xs text-slate-400">{(p.sections||[]).join(', ')||'‚Äî'}</td>
                    <td className="p-3">{p.nda_signed?<span className="text-emerald-400">‚úì</span>:<span className="text-red-400">‚úó</span>}</td>
                    <td className="p-3">
                      <select value={p.status} onChange={e=>handleStatusChange(p.id,e.target.value)} disabled={p.status==='revoked'} className={`px-2 py-1 rounded text-xs border-0 ${statusColors[p.status]} bg-transparent cursor-pointer disabled:cursor-not-allowed`}>
                        <option value="pending">Pending</option><option value="active">Active</option><option value="revoked">Revoked</option>
                      </select>
                    </td>
                    <td className="p-3">{p.auto_revoke_on_submit&&p.status!=='revoked'&&<span className="text-xs text-amber-400" title="Auto-revokes on proposal submission">‚è±Ô∏è</span>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">ü§ù</div><p className="text-white text-lg mb-2">Select an opportunity to manage partners</p><p className="text-slate-400">Control teaming partner access with auto-revoke on submission</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: LAUNCH READINESS (M13) - LIVE DATA
// ============================================================
function ModuleLaunch({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[items,setItems]=useState([]);
  const[loading,setLoading]=useState(false);
  const[showForm,setShowForm]=useState(false);
  const[form,setForm]=useState({category:'Compliance',item:'',owner_name:'',due_date:''});

  const categories=['Compliance','Technical','Pricing','Management','Past Performance','Orals'];
  const statusColors={pending:'bg-slate-500/20 text-slate-400',in_progress:'bg-amber-500/20 text-amber-400',complete:'bg-emerald-500/20 text-emerald-400',blocked:'bg-red-500/20 text-red-400'};

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getLaunchChecklist(selectedOpp.id);
      setItems(data.length>0?data:[
        {id:'demo-1',category:'Compliance',item:'Complete L Section requirements',status:'complete',owner_name:'Lisa Martinez'},
        {id:'demo-2',category:'Technical',item:'Finalize technical approach',status:'in_progress',owner_name:'Sarah Chen'},
        {id:'demo-3',category:'Pricing',item:'Lock pricing model',status:'pending',owner_name:'Jennifer Park',blockers:'Awaiting subcontractor rates'},
        {id:'demo-4',category:'Management',item:'Executive summary review',status:'pending',owner_name:'Mary Womack'}
      ]);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleAdd=async()=>{
    if(!selectedOpp||!form.item)return;
    try{
      const item=await MissionPulse.createChecklistItem({...form,opportunity_id:selectedOpp.id,status:'pending'});
      setItems([...items,item]);
      setShowForm(false);
      setForm({category:'Compliance',item:'',owner_name:'',due_date:''});
    }catch(err){console.error(err)}
  };

  const handleStatusChange=async(id,newStatus)=>{
    try{
      await MissionPulse.updateChecklistItem(id,{status:newStatus});
      setItems(items.map(i=>i.id===id?{...i,status:newStatus}:i));
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete checklist item?'))return;
    try{
      await MissionPulse.deleteChecklistItem(id);
      setItems(items.filter(i=>i.id!==id));
    }catch(err){console.error(err)}
  };

  const stats={
    total:items.length,
    complete:items.filter(i=>i.status==='complete').length,
    blocked:items.filter(i=>i.status==='blocked'||i.blockers).length,
    percent:items.length>0?Math.round((items.filter(i=>i.status==='complete').length/items.length)*100):0
  };

  const goNoGo=stats.percent>=80&&stats.blocked===0?'GO':stats.percent>=50?'CONDITIONAL':'NO-GO';

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Launch Readiness</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Pre-submission checklist and Go/No-Go assessment</p>
        </div>
        {selectedOpp&&<button onClick={()=>setShowForm(true)} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add Item</button>}
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {selectedOpp&&(
        <>
          {/* Stats & Go/No-Go */}
          <div className="grid grid-cols-5 gap-4">
            <div className="glass p-4"><p className="text-slate-400 text-xs">Total Items</p><p className="text-2xl font-bold text-white">{stats.total}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Complete</p><p className="text-2xl font-bold text-emerald-400">{stats.complete}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Blocked</p><p className="text-2xl font-bold text-red-400">{stats.blocked}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Progress</p><p className="text-2xl font-bold text-cyan-400">{stats.percent}%</p></div>
            <div className={`glass p-4 border-2 ${goNoGo==='GO'?'border-emerald-500 bg-emerald-500/10':goNoGo==='CONDITIONAL'?'border-amber-500 bg-amber-500/10':'border-red-500 bg-red-500/10'}`}>
              <p className="text-slate-400 text-xs">Decision</p>
              <p className={`text-2xl font-bold ${goNoGo==='GO'?'text-emerald-400':goNoGo==='CONDITIONAL'?'text-amber-400':'text-red-400'}`}>{goNoGo}</p>
            </div>
          </div>

          {/* Add Form */}
          {showForm&&(
            <div className="glass p-4 animate-fadeIn">
              <h3 className="font-semibold text-white mb-3">Add Checklist Item</h3>
              <div className="grid grid-cols-4 gap-3">
                <select value={form.category} onChange={e=>setForm({...form,category:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
                  {categories.map(c=><option key={c} value={c}>{c}</option>)}
                </select>
                <input placeholder="Item description" value={form.item} onChange={e=>setForm({...form,item:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
                <input placeholder="Owner" value={form.owner_name} onChange={e=>setForm({...form,owner_name:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
              </div>
              <div className="flex justify-end gap-2 mt-3">
                <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
                <button onClick={handleAdd} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
              </div>
            </div>
          )}

          {/* Checklist by Category */}
          {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
            <div className="space-y-4">
              {categories.map(cat=>{
                const catItems=items.filter(i=>i.category===cat);
                if(catItems.length===0)return null;
                return(
                  <div key={cat} className="glass overflow-hidden">
                    <div className="p-3 border-b border-slate-700/50 bg-slate-800/50">
                      <h3 className="font-semibold text-white">{cat} ({catItems.filter(i=>i.status==='complete').length}/{catItems.length})</h3>
                    </div>
                    <div className="divide-y divide-slate-700/50">
                      {catItems.map(item=>(
                        <div key={item.id} className="p-3 flex items-center justify-between hover:bg-slate-800/30">
                          <div className="flex items-center gap-3">
                            <select value={item.status} onChange={e=>handleStatusChange(item.id,e.target.value)} className={`px-2 py-1 rounded text-xs border-0 ${statusColors[item.status]} bg-transparent cursor-pointer`}>
                              <option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="complete">Complete</option><option value="blocked">Blocked</option>
                            </select>
                            <span className={`text-sm ${item.status==='complete'?'text-slate-500 line-through':'text-white'}`}>{item.item}</span>
                            {item.blockers&&<span className="px-2 py-0.5 bg-red-500/20 text-red-400 rounded text-xs">‚ö†Ô∏è {item.blockers}</span>}
                          </div>
                          <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-400">{item.owner_name||'Unassigned'}</span>
                            <button onClick={()=>handleDelete(item.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üöÄ</div><p className="text-white text-lg mb-2">Select an opportunity for launch readiness</p><p className="text-slate-400">Track pre-submission checklist and Go/No-Go decision</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: POST-AWARD (M14) - LIVE DATA
// ============================================================
function ModulePostAward({opps,isLive}){
  const[selectedOpp,setSelectedOpp]=useState(null);
  const[actions,setActions]=useState([]);
  const[loading,setLoading]=useState(false);
  const[showForm,setShowForm]=useState(false);
  const[activeTab,setActiveTab]=useState('transition');
  const[form,setForm]=useState({action_type:'transition',title:'',description:'',owner_name:'',priority:'medium',due_date:''});

  const actionTypes=[
    {id:'transition',name:'Transition',icon:'üîÑ'},
    {id:'deliverable',name:'Deliverable',icon:'üì¶'},
    {id:'lesson',name:'Lesson Learned',icon:'üí°'}
  ];
  const priorities={high:'bg-red-500/20 text-red-400',medium:'bg-amber-500/20 text-amber-400',low:'bg-emerald-500/20 text-emerald-400'};
  const statusColors={pending:'bg-slate-500/20 text-slate-400',in_progress:'bg-cyan-500/20 text-cyan-400',complete:'bg-emerald-500/20 text-emerald-400'};

  useEffect(()=>{
    if(!selectedOpp)return;
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getPostAwardActions(selectedOpp.id);
      setActions(data.length>0?data:[
        {id:'demo-1',action_type:'transition',title:'Kickoff meeting with COR',status:'complete',priority:'high',owner_name:'Mary Womack'},
        {id:'demo-2',action_type:'transition',title:'Staff onboarding',status:'in_progress',priority:'high',owner_name:'Amanda Foster'},
        {id:'demo-3',action_type:'deliverable',title:'CDRL 001 - Monthly Status Report',status:'pending',priority:'medium',due_date:'2026-02-15'},
        {id:'demo-4',action_type:'lesson',title:'Pricing assumptions were accurate',status:'complete',lesson_category:'Pricing',lesson_impact:'positive'}
      ]);
      setLoading(false);
    };
    load();
  },[selectedOpp]);

  const handleAdd=async()=>{
    if(!selectedOpp||!form.title)return;
    try{
      const action=await MissionPulse.createPostAwardAction({...form,opportunity_id:selectedOpp.id,status:'pending'});
      setActions([...actions,action]);
      setShowForm(false);
      setForm({action_type:'transition',title:'',description:'',owner_name:'',priority:'medium',due_date:''});
    }catch(err){console.error(err)}
  };

  const handleStatusChange=async(id,newStatus)=>{
    try{
      await MissionPulse.updatePostAwardAction(id,{status:newStatus});
      setActions(actions.map(a=>a.id===id?{...a,status:newStatus}:a));
    }catch(err){console.error(err)}
  };

  const handleDelete=async(id)=>{
    if(!confirm('Delete this item?'))return;
    try{
      await MissionPulse.deletePostAwardAction(id);
      setActions(actions.filter(a=>a.id!==id));
    }catch(err){console.error(err)}
  };

  const filteredActions=actions.filter(a=>a.action_type===activeTab);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Post-Award Management</h2>
            <DataBadge live={isLive&&selectedOpp}/>
          </div>
          <p className="text-slate-400 text-sm">Transition tracking, deliverables, and lessons learned</p>
        </div>
        {selectedOpp&&<button onClick={()=>{setForm({...form,action_type:activeTab});setShowForm(true)}} className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add {actionTypes.find(t=>t.id===activeTab)?.name}</button>}
      </div>

      {/* Opportunity Selector */}
      <div className="glass p-4">
        <label className="text-sm text-slate-400 mb-2 block">Select Won Opportunity</label>
        <select value={selectedOpp?.id||''} onChange={e=>setSelectedOpp(opps.find(o=>o.id===e.target.value)||null)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white">
          <option value="">-- Select Opportunity --</option>
          {opps.filter(o=>o.status==='Won'||o.phase?.includes('Award')||true).map(o=><option key={o.id} value={o.id}>{o.nickname||o.name} ({o.agency})</option>)}
        </select>
      </div>

      {selectedOpp&&(
        <>
          {/* Stats */}
          <div className="grid grid-cols-4 gap-4">
            <div className="glass p-4"><p className="text-slate-400 text-xs">Transition Tasks</p><p className="text-2xl font-bold text-cyan-400">{actions.filter(a=>a.action_type==='transition').length}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Deliverables</p><p className="text-2xl font-bold text-purple-400">{actions.filter(a=>a.action_type==='deliverable').length}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Lessons Learned</p><p className="text-2xl font-bold text-amber-400">{actions.filter(a=>a.action_type==='lesson').length}</p></div>
            <div className="glass p-4"><p className="text-slate-400 text-xs">Completion</p><p className="text-2xl font-bold text-emerald-400">{actions.length>0?Math.round((actions.filter(a=>a.status==='complete').length/actions.length)*100):0}%</p></div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2">
            {actionTypes.map(t=>(
              <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab===t.id?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>
                {t.icon} {t.name} ({actions.filter(a=>a.action_type===t.id).length})
              </button>
            ))}
          </div>

          {/* Add Form */}
          {showForm&&(
            <div className="glass p-4 animate-fadeIn">
              <h3 className="font-semibold text-white mb-3">Add {actionTypes.find(t=>t.id===form.action_type)?.name}</h3>
              <div className="grid grid-cols-3 gap-3">
                <input placeholder="Title" value={form.title} onChange={e=>setForm({...form,title:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
                <select value={form.priority} onChange={e=>setForm({...form,priority:e.target.value})} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white">
                  <option value="low">Low Priority</option><option value="medium">Medium</option><option value="high">High Priority</option>
                </select>
                <textarea placeholder="Description" value={form.description} onChange={e=>setForm({...form,description:e.target.value})} className="col-span-2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white h-16"/>
                <div className="space-y-2">
                  <input placeholder="Owner" value={form.owner_name} onChange={e=>setForm({...form,owner_name:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
                  <input type="date" value={form.due_date} onChange={e=>setForm({...form,due_date:e.target.value})} className="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm text-white"/>
                </div>
              </div>
              <div className="flex justify-end gap-2 mt-3">
                <button onClick={()=>setShowForm(false)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
                <button onClick={handleAdd} className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Add</button>
              </div>
            </div>
          )}

          {/* Actions List */}
          {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
            <div className="glass overflow-hidden">
              <table className="w-full">
                <thead className="bg-slate-800/50"><tr>{['Status','Title','Priority','Owner','Due Date',''].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
                <tbody className="divide-y divide-slate-700/50">
                  {filteredActions.map(a=>(
                    <tr key={a.id} className="hover:bg-slate-800/30">
                      <td className="p-3">
                        <select value={a.status} onChange={e=>handleStatusChange(a.id,e.target.value)} className={`px-2 py-1 rounded text-xs border-0 ${statusColors[a.status]} bg-transparent cursor-pointer`}>
                          <option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="complete">Complete</option>
                        </select>
                      </td>
                      <td className="p-3">
                        <span className={`text-sm ${a.status==='complete'?'text-slate-500 line-through':'text-white'}`}>{a.title}</span>
                        {a.description&&<p className="text-xs text-slate-500 mt-0.5">{a.description}</p>}
                      </td>
                      <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${priorities[a.priority]}`}>{a.priority}</span></td>
                      <td className="p-3 text-sm text-slate-400">{a.owner_name||'‚Äî'}</td>
                      <td className="p-3 text-sm text-slate-400">{a.due_date?new Date(a.due_date).toLocaleDateString():'‚Äî'}</td>
                      <td className="p-3"><button onClick={()=>handleDelete(a.id)} className="p-1 text-red-400 hover:text-red-300"><Icon name="trash" className="w-4 h-4"/></button></td>
                    </tr>
                  ))}
                  {filteredActions.length===0&&<tr><td colSpan="6" className="p-8 text-center text-slate-400">No {actionTypes.find(t=>t.id===activeTab)?.name.toLowerCase()}s yet</td></tr>}
                </tbody>
              </table>
            </div>
          )}
        </>
      )}

      {!selectedOpp&&<div className="glass p-12 text-center"><div className="text-6xl mb-4">üèÜ</div><p className="text-white text-lg mb-2">Select a won opportunity for post-award tracking</p><p className="text-slate-400">Manage transition, deliverables, and lessons learned</p></div>}
    </div>
  );
}

// ============================================================
// MODULE: AUDIT LOG (M15) - LIVE DATA
// ============================================================
function ModuleAudit({isLive}){
  const[logs,setLogs]=useState([]);
  const[loading,setLoading]=useState(true);
  const[filter,setFilter]=useState('all');

  const actionColors={
    'CREATE':'bg-emerald-500/20 text-emerald-400',
    'UPDATE':'bg-cyan-500/20 text-cyan-400',
    'DELETE':'bg-red-500/20 text-red-400',
    'LOGIN':'bg-purple-500/20 text-purple-400',
    'LOGOUT':'bg-slate-500/20 text-slate-400',
    'VIEW':'bg-slate-500/20 text-slate-400',
    'APPROVE':'bg-emerald-500/20 text-emerald-400',
    'REJECT':'bg-red-500/20 text-red-400'
  };

  useEffect(()=>{
    const load=async()=>{
      setLoading(true);
      const data=await MissionPulse.getAuditLogs(100);
      setLogs(data.length>0?data:DEMO_AUDIT.map(a=>({
        id:a.id,
        action:a.action,
        user_email:a.user,
        user_role:a.role,
        ip_address:a.ip,
        created_at:a.ts,
        module:'System'
      })));
      setLoading(false);
    };
    load();
  },[]);

  const actions=[...new Set(logs.map(l=>l.action))];
  const filtered=filter==='all'?logs:logs.filter(l=>l.action===filter);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <div className="flex items-center gap-2">
            <h2 className="text-xl font-bold text-white">Audit Log</h2>
            <span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">ADMIN</span>
            <DataBadge live={isLive}/>
          </div>
          <p className="text-slate-400 text-sm">System activity and access tracking</p>
        </div>
        <button onClick={()=>window.location.reload()} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm flex items-center gap-2"><Icon name="refresh-cw" className="w-4 h-4"/>Refresh</button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-5 gap-4">
        <div className="glass p-4"><p className="text-slate-400 text-xs">Total Events</p><p className="text-2xl font-bold text-white">{logs.length}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Creates</p><p className="text-2xl font-bold text-emerald-400">{logs.filter(l=>l.action==='CREATE').length}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Updates</p><p className="text-2xl font-bold text-cyan-400">{logs.filter(l=>l.action==='UPDATE').length}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Deletes</p><p className="text-2xl font-bold text-red-400">{logs.filter(l=>l.action==='DELETE').length}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Logins</p><p className="text-2xl font-bold text-purple-400">{logs.filter(l=>l.action==='LOGIN').length}</p></div>
      </div>

      {/* Filter */}
      <div className="flex gap-2 flex-wrap">
        <button onClick={()=>setFilter('all')} className={`px-3 py-1.5 rounded-lg text-sm ${filter==='all'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>All ({logs.length})</button>
        {actions.map(a=>(
          <button key={a} onClick={()=>setFilter(a)} className={`px-3 py-1.5 rounded-lg text-sm ${filter===a?'bg-cyan-500 text-white':'bg-slate-700 text-slate-300'}`}>{a} ({logs.filter(l=>l.action===a).length})</button>
        ))}
      </div>

      {/* Log Table */}
      {loading?<div className="glass p-8 flex justify-center"><Spinner/></div>:(
        <div className="glass overflow-hidden">
          <table className="w-full">
            <thead className="bg-slate-800/50"><tr>{['Timestamp','Action','Module','User','Role','IP Address'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
            <tbody className="divide-y divide-slate-700/50">
              {filtered.slice(0,50).map(log=>(
                <tr key={log.id} className="hover:bg-slate-800/30">
                  <td className="p-3 text-sm text-slate-400 font-mono">{new Date(log.created_at).toLocaleString()}</td>
                  <td className="p-3"><span className={`px-2 py-0.5 rounded text-xs ${actionColors[log.action]||'bg-slate-700 text-white'}`}>{log.action}</span></td>
                  <td className="p-3 text-sm text-slate-300">{log.module||'‚Äî'}</td>
                  <td className="p-3 text-sm text-white">{log.user_email||'System'}</td>
                  <td className="p-3 text-sm text-slate-300">{log.user_role||'‚Äî'}</td>
                  <td className="p-3 text-sm text-slate-500 font-mono">{log.ip_address||'‚Äî'}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {filtered.length>50&&<div className="p-3 text-center text-slate-400 text-sm">Showing 50 of {filtered.length} events</div>}
        </div>
      )}
    </div>
  );
}

function ModuleAdmin({tokenUsage,setTokenUsage}){
  const tokenLimit=100000;const usagePercent=Math.round((tokenUsage/tokenLimit)*100);
  return(<div className="space-y-4 animate-fadeIn"><div className="flex items-center gap-2"><h2 className="text-xl font-bold text-white">Admin Panel</h2><span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">ADMIN</span></div><p className="text-slate-400 text-sm">System configuration and user management</p><div className="grid grid-cols-2 gap-4"><div className="glass p-6"><h3 className="font-semibold text-white mb-4">üí∞ Token Cost Meter</h3><div className="space-y-4"><div><div className="flex justify-between text-sm mb-2"><span className="text-slate-400">Usage</span><span className="text-white">{tokenUsage.toLocaleString()} / {tokenLimit.toLocaleString()}</span></div><div className="h-4 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full transition-all ${usagePercent>80?'bg-red-500':usagePercent>50?'bg-amber-500':'bg-emerald-500'}`} style={{width:`${usagePercent}%`}}/></div></div><div className="grid grid-cols-2 gap-4"><div className="p-3 bg-slate-800/50 rounded-lg"><p className="text-xs text-slate-400">This Month</p><p className="text-lg font-bold text-white">{tokenUsage.toLocaleString()}</p></div><div className="p-3 bg-slate-800/50 rounded-lg"><p className="text-xs text-slate-400">Est. Cost</p><p className="text-lg font-bold text-emerald-400">${((tokenUsage/1000)*0.003).toFixed(2)}</p></div></div></div></div><div className="glass p-6"><h3 className="font-semibold text-white mb-4">‚öôÔ∏è System Settings</h3><div className="space-y-3">{[{l:'RBAC Enforcement',v:true},{l:'CUI Watermarking',v:true},{l:'Partner Auto-Revoke',v:true},{l:'Audit Logging',v:true}].map((s,i)=><div key={i} className="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg"><span className="text-sm text-white">{s.l}</span><div className={`w-10 h-6 rounded-full p-1 cursor-pointer ${s.v?'bg-emerald-500':'bg-slate-600'}`}><div className={`w-4 h-4 bg-white rounded-full transition-transform ${s.v?'translate-x-4':''}`}/></div></div>)}</div></div></div><div className="glass p-6"><h3 className="font-semibold text-white mb-4">üë• User Management</h3><div className="grid grid-cols-3 gap-3">{ROLES.slice(0,6).map(r=><div key={r.id} className="p-3 bg-slate-800/50 rounded-lg flex items-center gap-3"><span className="text-xl">{r.icon}</span><div><p className="text-sm text-white">{r.fullName}</p><p className="text-xs text-slate-400">{r.name}</p></div></div>)}</div></div></div>);
}

function ModuleGeneric({mod}){
  return(<div className="glass p-12 text-center animate-fadeIn"><div className="text-6xl mb-4">{mod.icon}</div><h2 className="text-xl font-bold text-white mb-2">{mod.name}</h2><p className="text-slate-400">{mod.cat} module</p>{mod.badge&&<span className={`inline-block mt-3 px-3 py-1 rounded text-xs font-bold ${mod.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':mod.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{mod.badge}</span>}</div>);
}

// AI CHAT WIDGET
function AIChatWidget(){
  const[open,setOpen]=useState(false);const[messages,setMessages]=useState([{role:'assistant',content:'Hello! I\'m your MissionPulse AI assistant. How can I help?'}]);const[input,setInput]=useState('');const[loading,setLoading]=useState(false);
  const send=()=>{if(!input.trim()||loading)return;setMessages(m=>[...m,{role:'user',content:input}]);setInput('');setLoading(true);setTimeout(()=>{setMessages(m=>[...m,{role:'assistant',content:`Great question about "${input}". Based on Shipley methodology, I recommend focusing on compliance first, then win themes. Would you like me to elaborate?`}]);setLoading(false)},1000)};
  if(!open)return<button onClick={()=>setOpen(true)} className="fixed bottom-10 right-4 w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition z-50">ü§ñ</button>;
  return(<div className="fixed bottom-10 right-4 w-96 h-[500px] glass shadow-2xl flex flex-col z-50 animate-fadeIn"><div className="p-3 border-b border-slate-700/50 flex justify-between items-center"><span className="font-semibold text-white flex items-center gap-2">ü§ñ AI Assistant</span><button onClick={()=>setOpen(false)} className="p-1 text-slate-400 hover:text-white"><Icon name="x" className="w-5 h-5"/></button></div><div className="flex-1 overflow-y-auto p-3 space-y-3">{messages.map((m,i)=><div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.role==='user'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-200'}`}>{m.content}</div></div>)}{loading&&<div className="flex justify-start"><div className="bg-slate-700 p-3 rounded-xl"><div className="flex gap-1">{[0,1,2].map(i=><div key={i} className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{animationDelay:`${i*0.2}s`}}/>)}</div></div></div>}</div><div className="p-3 border-t border-slate-700/50 flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder="Ask anything..." className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-cyan-500"/><button onClick={send} disabled={!input.trim()||loading} className="p-2 bg-cyan-500 rounded-lg text-white disabled:opacity-50"><Icon name="send" className="w-5 h-5"/></button></div></div>);
}

// SIDEBAR
function Sidebar({role,setRole,active,setActive,user}){
  const[collapsed,setCollapsed]=useState(false);const[showRoles,setShowRoles]=useState(false);
  const accessible=MODULES.filter(m=>role.access.includes(m.id));
  return(<aside className={`h-screen bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all ${collapsed?'w-16':'w-64'}`}><div className="p-4 border-b border-slate-800 flex items-center justify-between">{!collapsed&&<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div><div className="text-sm font-bold text-white">MissionPulse</div><div className="text-[10px] text-slate-500">v12 Sprint 53</div></div></div>}<button onClick={()=>setCollapsed(!collapsed)} className="p-1 text-slate-400 hover:text-white"><Icon name={collapsed?'chevronRight':'chevronLeft'} className="w-4 h-4"/></button></div><div className="p-3 border-b border-slate-800"><button onClick={()=>setShowRoles(!showRoles)} className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800"><span className="text-xl">{role.icon}</span>{!collapsed&&<><div className="flex-1 text-left"><div className="text-sm font-medium text-white">{role.fullName}</div><div className="text-xs text-slate-400">{role.name}</div></div><Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition ${showRoles?'rotate-180':''}`}/></>}</button>{showRoles&&!collapsed&&<div className="mt-2 p-2 bg-slate-800/50 rounded-lg max-h-48 overflow-y-auto">{ROLES.map(r=><button key={r.id} onClick={()=>{setRole(r);setShowRoles(false)}} className={`w-full flex items-center gap-2 p-2 rounded hover:bg-slate-700 ${role.id===r.id?'bg-cyan-500/20':''}`}><span>{r.icon}</span><span className="text-sm text-white">{r.name}</span></button>)}</div>}</div><nav className="flex-1 overflow-y-auto p-2">{['Command','Strategy','Intel','Delivery','Admin'].map(cat=>{const mods=accessible.filter(m=>m.cat===cat);if(!mods.length)return null;return(<div key={cat} className="mb-3">{!collapsed&&<div className="text-[10px] uppercase text-slate-500 font-semibold px-2 mb-1">{cat}</div>}{mods.map(m=><button key={m.id} onClick={()=>setActive(m)} className={`w-full flex items-center gap-2 p-2 rounded-lg mb-0.5 transition ${active?.id===m.id?'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30':'text-slate-400 hover:bg-slate-800 hover:text-white'}`} title={collapsed?m.name:''}><span>{m.icon}</span>{!collapsed&&<><span className="flex-1 text-left text-sm">{m.name}</span>{m.badge&&<span className={`px-1 py-0.5 text-[9px] font-bold rounded ${m.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</>}</button>)}</div>)})}</nav>{!collapsed&&user&&<div className="p-3 border-t border-slate-800"><div className="flex items-center justify-between"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white text-xs font-bold">{user.name?.[0]||'U'}</div><div className="text-xs text-white truncate max-w-[120px]">{user.name||user.email}</div></div><button onClick={handleLogout} className="p-1.5 rounded hover:bg-red-500/20 text-slate-400 hover:text-red-400"><Icon name="logout" className="w-4 h-4"/></button></div></div>}</aside>);
}

// ============================================================
// MAIN APP
// ============================================================
function App(){
  const[user,setUser]=useState(null);
  const[role,setRole]=useState(ROLES[0]);
  const[active,setActive]=useState(null);
  const[opps,setOpps]=useState([]);
  const[loading,setLoading]=useState(true);
  const[isLive,setIsLive]=useState(false);
  const[tokenUsage,setTokenUsage]=useState(45230);

  // Load opportunities on mount
  const loadOpportunities=useCallback(async()=>{
    setLoading(true);
    try{
      const data=await MissionPulse.getOpportunities();
      if(data&&data.length>0){
        setOpps(data);
        setIsLive(true);
        console.log('[MissionPulse] Loaded',data.length,'opportunities from Supabase');
      }else{
        setOpps(DEMO_OPPS);
        setIsLive(false);
        console.log('[MissionPulse] Using demo data - no Supabase opportunities found');
      }
    }catch(err){
      console.error('[MissionPulse] Failed to load from Supabase, using demo data:',err);
      setOpps(DEMO_OPPS);
      setIsLive(false);
    }finally{
      setLoading(false);
    }
  },[]);

  useEffect(()=>{
    const u=checkAuth();
    if(u){
      setUser(u);
      loadOpportunities();
    }
  },[loadOpportunities]);

  const renderModule=()=>{
    if(!active)return<div className="flex-1 flex items-center justify-center"><div className="text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><h2 className="text-xl font-bold text-white mb-2">Welcome to MissionPulse</h2><p className="text-slate-400">Select a module to begin</p><p className="text-xs text-cyan-400 mt-2">{isLive?'Connected to Supabase':'Demo Mode'}</p></div></div>;
    switch(active.id){
      case 'dashboard':return<ModuleDashboard opps={opps} loading={loading} isLive={isLive} onRefresh={loadOpportunities} tokenUsage={tokenUsage}/>;
      case 'pipeline':return<ModulePipeline opps={opps} setOpps={setOpps} loading={loading} isLive={isLive} onRefresh={loadOpportunities}/>;
      case 'warroom':return<ModuleWarRoom opps={opps} loading={loading} isLive={isLive}/>;
      case 'swimlane':return<ModuleSwimlane opps={opps} setOpps={setOpps} loading={loading} isLive={isLive}/>;
      case 'compliance':return<ModuleCompliance opps={opps} isLive={isLive}/>;
      case 'contracts':return<ModuleContracts opps={opps} isLive={isLive}/>;
      case 'writer':return<ModuleIronDome opps={opps} isLive={isLive}/>;
      case 'blackhat':return<ModuleBlackHat opps={opps} isLive={isLive} role={role}/>;
      case 'hitl':return<ModuleHITL opps={opps} isLive={isLive}/>;
      case 'orals':return<ModuleOrals opps={opps} isLive={isLive}/>;
      case 'pricing':return<ModulePricing opps={opps} isLive={isLive}/>;
      case 'frenemy':return<ModuleFrenemy opps={opps} isLive={isLive}/>;
      case 'launch':return<ModuleLaunch opps={opps} isLive={isLive}/>;
      case 'post_award':return<ModulePostAward opps={opps} isLive={isLive}/>;
      case 'playbook':return<ModulePlaybook isLive={isLive}/>;
      case 'audit':return<ModuleAudit isLive={isLive}/>;
      case 'admin':return<ModuleAdmin tokenUsage={tokenUsage} setTokenUsage={setTokenUsage}/>;
      default:return<ModuleGeneric mod={active}/>;
    }
  };

  if(!user)return<div className="h-screen flex items-center justify-center bg-[#00050F]"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;

  return(
    <div className="h-screen flex bg-[#00050F] overflow-hidden">
      <Sidebar role={role} setRole={setRole} active={active} setActive={setActive} user={user}/>
      <div className="flex-1 flex flex-col overflow-hidden">
        {active&&<header className="bg-slate-900/90 border-b border-slate-800 px-6 py-3"><div className="flex items-center gap-3"><span className="text-xl">{active.icon}</span><div><h1 className="font-semibold text-white">{active.name}</h1></div>{active.badge&&<span className={`px-2 py-0.5 rounded text-xs font-bold ${active.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':active.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{active.badge}</span>}</div></header>}
        <main className="flex-1 overflow-y-auto p-6">{renderModule()}</main>
      </div>
      <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-40"><span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW ‚Ä¢ MissionPulse v12 Sprint 53 FINAL ‚Ä¢ ¬© 2026 Mission Meets Tech</span></div>
      <AIChatWidget/>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
