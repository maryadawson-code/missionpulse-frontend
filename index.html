<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse | Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #00050F 0%, #001a2c 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        /* Header */
        .header {
            background: rgba(0,5,15,0.9);
            border-bottom: 1px solid rgba(0,229,250,0.2);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo h1 {
            font-size: 24px;
            color: #00E5FA;
        }
        .logo span {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-email {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }
        .btn-logout {
            background: rgba(239,68,68,0.2);
            border: 1px solid rgba(239,68,68,0.5);
            color: #fca5a5;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-logout:hover {
            background: rgba(239,68,68,0.3);
        }
        
        /* Main Content */
        .main {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        .kpi-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
        }
        .kpi-card:hover {
            border-color: rgba(0,229,250,0.3);
            transform: translateY(-2px);
        }
        .kpi-label {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #00E5FA;
        }
        .kpi-card.success .kpi-value { color: #22c55e; }
        .kpi-card.warning .kpi-value { color: #f59e0b; }
        .kpi-card.danger .kpi-value { color: #ef4444; }
        
        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
        }
        .btn-add {
            background: linear-gradient(135deg, #00E5FA 0%, #00b8d4 100%);
            border: none;
            color: #00050F;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,229,250,0.4);
        }
        
        /* Opportunities Grid */
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .opp-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .opp-card:hover {
            border-color: rgba(0,229,250,0.5);
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0,229,250,0.15);
        }
        .opp-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .opp-name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }
        .opp-agency {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        .opp-value {
            font-size: 20px;
            font-weight: 700;
            color: #00E5FA;
        }
        .opp-meta {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .opp-meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .opp-meta-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .opp-meta-value {
            font-size: 14px;
            font-weight: 500;
        }
        .phase-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(0,229,250,0.2);
            color: #00E5FA;
        }
        .pwin-high { color: #22c55e; }
        .pwin-medium { color: #f59e0b; }
        .pwin-low { color: #ef4444; }
        
        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px;
            color: rgba(255,255,255,0.6);
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(0,229,250,0.3);
            border-top-color: #00E5FA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px;
            color: rgba(255,255,255,0.6);
        }
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #fff;
        }
        
        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .status-dot.disconnected {
            background: #ef4444;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .opportunities-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 16px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <h1>ðŸŽ¯ MissionPulse</h1>
            <span>Federal Proposal Intelligence</span>
        </div>
        <div class="user-info">
            <div class="connection-status">
                <div id="statusDot" class="status-dot disconnected"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <span id="userEmail" class="user-email"></span>
            <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
    </header>

    <main class="main">
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Total Pipeline Value</div>
                <div id="kpiTotalValue" class="kpi-value">$0</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Active Opportunities</div>
                <div id="kpiCount" class="kpi-value">0</div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-label">Avg Win Probability</div>
                <div id="kpiAvgPwin" class="kpi-value">0%</div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-label">Due This Month</div>
                <div id="kpiDueThisMonth" class="kpi-value">0</div>
            </div>
        </div>

        <!-- Opportunities Section -->
        <div class="section-header">
            <h2 class="section-title">Pipeline Opportunities</h2>
            <button id="addOppBtn" class="btn-add">+ Add Opportunity</button>
        </div>

        <div id="opportunitiesContainer">
            <div class="loading">
                <div class="spinner"></div>
                <span>Loading opportunities...</span>
            </div>
        </div>
    </main>

    <script>
        // ============================================================
        // SUPABASE CONFIG
        // ============================================================
        const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
        
        let supabaseClient = null;

        // ============================================================
        // INITIALIZATION
        // ============================================================
        async function init() {
            console.log('[MissionPulse] Initializing dashboard...');
            
            // Check for existing session
            const userId = localStorage.getItem('mp_user_id');
            const userEmail = localStorage.getItem('mp_user_email');
            
            if (!userId) {
                console.log('[MissionPulse] No session found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Display user info
            document.getElementById('userEmail').textContent = userEmail || 'User';
            
            // Initialize Supabase
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('[MissionPulse] Supabase client initialized');
                updateConnectionStatus(true);
            } else {
                console.error('[MissionPulse] Supabase library not loaded');
                updateConnectionStatus(false);
            }
            
            // Load opportunities
            await loadOpportunities();
            
            // Setup event listeners
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('addOppBtn').addEventListener('click', handleAddOpportunity);
        }

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function loadOpportunities() {
            const container = document.getElementById('opportunitiesContainer');
            
            try {
                console.log('[MissionPulse] Fetching opportunities...');
                
                const { data, error } = await supabaseClient
                    .from('opportunities')
                    .select('*')
                    .order('contract_value', { ascending: false });
                
                if (error) {
                    console.error('[MissionPulse] Error fetching:', error);
                    container.innerHTML = `<div class="empty-state"><h3>Error Loading Data</h3><p>${error.message}</p></div>`;
                    return;
                }
                
                console.log(`[MissionPulse] Loaded ${data.length} opportunities`);
                
                // Update KPIs
                updateKPIs(data);
                
                // Render opportunities
                if (data.length === 0) {
                    container.innerHTML = `<div class="empty-state"><h3>No Opportunities Yet</h3><p>Click "Add Opportunity" to create your first one.</p></div>`;
                } else {
                    container.innerHTML = `<div class="opportunities-grid">${data.map(renderOpportunityCard).join('')}</div>`;
                }
                
            } catch (err) {
                console.error('[MissionPulse] Exception:', err);
                container.innerHTML = `<div class="empty-state"><h3>Connection Error</h3><p>Unable to connect to database.</p></div>`;
            }
        }

        function renderOpportunityCard(opp) {
            const value = formatCurrency(opp.contract_value);
            const pwinClass = opp.win_probability >= 60 ? 'pwin-high' : opp.win_probability >= 40 ? 'pwin-medium' : 'pwin-low';
            const phase = formatPhase(opp.shipley_phase);
            const dueDate = opp.due_date ? new Date(opp.due_date).toLocaleDateString() : 'TBD';
            
            return `
                <div class="opp-card" onclick="viewOpportunity('${opp.id}')">
                    <div class="opp-header">
                        <div>
                            <div class="opp-name">${escapeHtml(opp.name)}</div>
                            <div class="opp-agency">${escapeHtml(opp.agency || 'Unknown Agency')}</div>
                        </div>
                        <div class="opp-value">${value}</div>
                    </div>
                    <div class="opp-meta">
                        <div class="opp-meta-item">
                            <span class="opp-meta-label">Phase</span>
                            <span class="phase-badge">${phase}</span>
                        </div>
                        <div class="opp-meta-item">
                            <span class="opp-meta-label">Win Prob</span>
                            <span class="opp-meta-value ${pwinClass}">${opp.win_probability || 0}%</span>
                        </div>
                        <div class="opp-meta-item">
                            <span class="opp-meta-label">Due Date</span>
                            <span class="opp-meta-value">${dueDate}</span>
                        </div>
                        <div class="opp-meta-item">
                            <span class="opp-meta-label">Priority</span>
                            <span class="opp-meta-value">${opp.priority || 'Medium'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // KPI CALCULATIONS
        // ============================================================
        function updateKPIs(opportunities) {
            const totalValue = opportunities.reduce((sum, o) => sum + (o.contract_value || 0), 0);
            const avgPwin = opportunities.length > 0 
                ? Math.round(opportunities.reduce((sum, o) => sum + (o.win_probability || 0), 0) / opportunities.length)
                : 0;
            
            // Count due this month
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            const dueThisMonth = opportunities.filter(o => {
                if (!o.due_date) return false;
                const due = new Date(o.due_date);
                return due.getMonth() === thisMonth && due.getFullYear() === thisYear;
            }).length;
            
            document.getElementById('kpiTotalValue').textContent = formatCurrency(totalValue);
            document.getElementById('kpiCount').textContent = opportunities.length;
            document.getElementById('kpiAvgPwin').textContent = avgPwin + '%';
            document.getElementById('kpiDueThisMonth').textContent = dueThisMonth;
        }

        // ============================================================
        // EVENT HANDLERS
        // ============================================================
        async function handleLogout() {
            console.log('[MissionPulse] Logging out...');
            
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            
            localStorage.removeItem('mp_user_id');
            localStorage.removeItem('mp_user_email');
            
            window.location.href = 'login.html';
        }

        function handleAddOpportunity() {
            alert('Add Opportunity feature coming soon!\n\nFor now, add opportunities directly in Supabase:\nhttps://supabase.com/dashboard/project/djuviwarqdvlbgcfuupa/editor');
        }

        function viewOpportunity(id) {
            console.log('[MissionPulse] View opportunity:', id);
            alert('Opportunity detail view coming soon!');
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function formatCurrency(value) {
            if (!value) return '$0';
            if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
            if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
            if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
            return `$${value.toLocaleString()}`;
        }

        function formatPhase(phase) {
            if (!phase) return 'Unknown';
            return phase.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.remove('disconnected');
                text.textContent = 'Connected';
            } else {
                dot.classList.add('disconnected');
                text.textContent = 'Disconnected';
            }
        }

        // ============================================================
        // START
        // ============================================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
