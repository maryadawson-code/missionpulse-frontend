<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse v1.0 | AI Proposal Command Center</title>
    <meta name="description" content="AI-powered proposal management for federal contractors. 8 specialized agents, Shipley methodology, RBAC security.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mmt-cyan': '#00E5FA',
                        'mmt-navy': '#00050F',
                        'mmt-slate': '#0f172a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --mmt-cyan: #00E5FA;
            --mmt-navy: #00050F;
        }
        
        body {
            background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%);
            min-height: 100vh;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a1628; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--mmt-cyan); }
        
        /* Glass Effect */
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 229, 250, 0.1);
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        
        /* Typing cursor */
        .typing::after {
            content: '▊';
            animation: pulse 1s infinite;
            color: var(--mmt-cyan);
        }
        
        /* Agent card hover */
        .agent-card {
            transition: all 0.2s ease;
        }
        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px -5px rgba(0, 229, 250, 0.2);
            border-color: rgba(0, 229, 250, 0.3);
        }
        
        /* Chat message */
        .chat-message {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Markdown styling */
        .markdown h2 { font-size: 1.25rem; font-weight: 700; margin: 1rem 0 0.5rem; color: #00E5FA; }
        .markdown h3 { font-size: 1.1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; color: #e2e8f0; }
        .markdown p { margin: 0.5rem 0; line-height: 1.6; }
        .markdown ul, .markdown ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .markdown li { margin: 0.25rem 0; }
        .markdown strong { color: #00E5FA; }
        .markdown code { background: rgba(0, 229, 250, 0.1); padding: 0.125rem 0.375rem; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; }
        .markdown table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; font-size: 0.875rem; }
        .markdown th, .markdown td { border: 1px solid rgba(0, 229, 250, 0.2); padding: 0.5rem; text-align: left; }
        .markdown th { background: rgba(0, 229, 250, 0.1); color: #00E5FA; }
        .markdown hr { border: none; border-top: 1px solid rgba(0, 229, 250, 0.2); margin: 1rem 0; }
    </style>
</head>
<body class="text-slate-200 overflow-hidden">
    <div id="app" class="flex h-screen">
        
        <!-- Sidebar -->
        <aside class="w-72 glass border-r border-cyan-500/10 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-cyan-500/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center">
                        <i data-lucide="shield" class="w-6 h-6 text-mmt-navy"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white">MissionPulse</h1>
                        <p class="text-xs text-cyan-400">v1.0 • AI Command Center</p>
                    </div>
                </div>
            </div>
            
            <!-- Role Selector -->
            <div class="p-4 border-b border-cyan-500/10">
                <label class="text-xs text-slate-400 uppercase tracking-wider mb-2 block">Current Role</label>
                <select id="roleSelect" class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-cyan-500/50">
                    <option value="executive">CEO (Executive)</option>
                    <option value="operations">COO (Operations)</option>
                    <option value="capture_manager">Capture Manager</option>
                    <option value="volume_lead">Volume Lead</option>
                    <option value="author">Author</option>
                    <option value="consultant">Consultant</option>
                    <option value="teaming_partner">Teaming Partner</option>
                    <option value="subcontractor">Subcontractor</option>
                </select>
            </div>
            
            <!-- Agent List -->
            <div class="flex-1 overflow-y-auto p-4">
                <h3 class="text-xs text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <i data-lucide="bot" class="w-3 h-3"></i>
                    AI Agents
                </h3>
                <div id="agentList" class="space-y-2">
                    <!-- Agents loaded dynamically -->
                    <div class="text-center py-8 text-slate-500">
                        <i data-lucide="loader-2" class="w-6 h-6 mx-auto animate-spin mb-2"></i>
                        <p class="text-sm">Loading agents...</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 border-t border-cyan-500/10">
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <span>Mission Meets Tech</span>
                    <a href="https://missionpulse-api.onrender.com/docs" target="_blank" class="text-cyan-400 hover:text-cyan-300 flex items-center gap-1">
                        API Docs <i data-lucide="external-link" class="w-3 h-3"></i>
                    </a>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            
            <!-- Header -->
            <header class="glass border-b border-cyan-500/10 px-6 py-4 flex items-center justify-between">
                <div id="chatHeader" class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5 text-slate-400"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white">Select an Agent</h2>
                        <p class="text-sm text-slate-400">Choose an AI agent from the sidebar to begin</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- API Status -->
                    <div id="apiStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/50 border border-cyan-500/20">
                        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse-slow"></span>
                        <span class="text-xs text-slate-400">Checking API...</span>
                    </div>
                    
                    <!-- New Chat -->
                    <button onclick="clearChat()" class="p-2 rounded-lg bg-slate-800/50 border border-cyan-500/20 hover:border-cyan-500/40 transition-colors" title="New Chat">
                        <i data-lucide="plus" class="w-5 h-5 text-slate-400"></i>
                    </button>
                </div>
            </header>
            
            <!-- Chat Area -->
            <div id="chatArea" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Welcome State -->
                <div id="welcomeState" class="h-full flex items-center justify-center">
                    <div class="text-center max-w-lg">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-cyan-400/20 to-cyan-600/20 border border-cyan-500/20 flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="rocket" class="w-10 h-10 text-cyan-400"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-3">Welcome to MissionPulse</h2>
                        <p class="text-slate-400 mb-6">Your AI-powered proposal command center. Select an agent from the sidebar to start winning more government contracts.</p>
                        <div class="grid grid-cols-2 gap-3 text-left">
                            <div class="glass rounded-lg p-3">
                                <div class="flex items-center gap-2 text-cyan-400 mb-1">
                                    <i data-lucide="target" class="w-4 h-4"></i>
                                    <span class="text-sm font-medium">8 AI Agents</span>
                                </div>
                                <p class="text-xs text-slate-500">Specialized for federal proposals</p>
                            </div>
                            <div class="glass rounded-lg p-3">
                                <div class="flex items-center gap-2 text-cyan-400 mb-1">
                                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                                    <span class="text-sm font-medium">11-Role RBAC</span>
                                </div>
                                <p class="text-xs text-slate-500">Invisible security enforcement</p>
                            </div>
                            <div class="glass rounded-lg p-3">
                                <div class="flex items-center gap-2 text-cyan-400 mb-1">
                                    <i data-lucide="zap" class="w-4 h-4"></i>
                                    <span class="text-sm font-medium">Real-time Streaming</span>
                                </div>
                                <p class="text-xs text-slate-500">See responses as they generate</p>
                            </div>
                            <div class="glass rounded-lg p-3">
                                <div class="flex items-center gap-2 text-cyan-400 mb-1">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    <span class="text-sm font-medium">Shipley Compliant</span>
                                </div>
                                <p class="text-xs text-slate-500">Industry-standard methodology</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages Container -->
                <div id="chatMessages" class="space-y-4 hidden">
                    <!-- Messages rendered here -->
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="glass border-t border-cyan-500/10 p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <textarea 
                                id="messageInput" 
                                placeholder="Ask a question about your proposal..." 
                                rows="1"
                                class="w-full bg-slate-800/50 border border-cyan-500/20 rounded-xl px-4 py-3 pr-12 resize-none focus:outline-none focus:border-cyan-500/50 text-sm"
                                onkeydown="handleKeyDown(event)"
                                oninput="autoResize(this)"
                            ></textarea>
                        </div>
                        <button 
                            id="sendButton"
                            onclick="sendMessage()" 
                            class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 rounded-xl font-medium text-mmt-navy transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                            disabled
                        >
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Send
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">
                        <i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i>
                        AI GENERATED - REQUIRES HUMAN REVIEW
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =================================================================
        // CONFIGURATION
        // =================================================================
        const API_BASE = 'https://missionpulse-api.onrender.com';
        
        // State
        let currentAgent = null;
        let currentRole = 'executive';
        let chatHistory = [];
        let isStreaming = false;
        
        // Icons mapping
        const ICONS = {
            'Target': 'target',
            'Lightbulb': 'lightbulb',
            'Shield': 'shield',
            'PenTool': 'pen-tool',
            'Calculator': 'calculator',
            'Eye': 'eye',
            'FileText': 'file-text',
            'Mic': 'mic'
        };
        
        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkApiHealth();
            loadAgents();
            
            // Role selector change
            document.getElementById('roleSelect').addEventListener('change', (e) => {
                currentRole = e.target.value;
                loadAgents();
            });
        });
        
        // =================================================================
        // API FUNCTIONS
        // =================================================================
        async function checkApiHealth() {
            const statusEl = document.getElementById('apiStatus');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusEl.innerHTML = `
                        <span class="w-2 h-2 rounded-full bg-green-400"></span>
                        <span class="text-xs text-green-400">API Online</span>
                    `;
                } else {
                    throw new Error('Unhealthy');
                }
            } catch (error) {
                statusEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-red-400"></span>
                    <span class="text-xs text-red-400">API Offline</span>
                `;
            }
        }
        
        async function loadAgents() {
            const listEl = document.getElementById('agentList');
            
            try {
                const response = await fetch(`${API_BASE}/api/agents`, {
                    headers: {
                        'X-User-Role': currentRole,
                        'X-User-Org': 'internal'
                    }
                });
                const agents = await response.json();
                
                if (agents.length === 0) {
                    listEl.innerHTML = `
                        <div class="text-center py-8 text-slate-500">
                            <i data-lucide="lock" class="w-6 h-6 mx-auto mb-2"></i>
                            <p class="text-sm">No agents available for this role</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                listEl.innerHTML = agents.map(agent => `
                    <button 
                        onclick="selectAgent('${agent.id}')"
                        class="agent-card w-full text-left p-3 rounded-xl glass border border-transparent hover:border-cyan-500/30 ${currentAgent?.id === agent.id ? 'border-cyan-500/50 bg-cyan-500/10' : ''}"
                        data-agent-id="${agent.id}"
                    >
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-lg flex items-center justify-center" style="background: ${agent.color}20">
                                <i data-lucide="${ICONS[agent.icon] || 'bot'}" class="w-5 h-5" style="color: ${agent.color}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm text-white truncate">${agent.display_name}</div>
                                <div class="text-xs text-slate-500 truncate">${agent.description}</div>
                            </div>
                            ${agent.is_restricted ? '<span class="px-1.5 py-0.5 text-[10px] bg-amber-500/20 text-amber-400 rounded">RESTRICTED</span>' : ''}
                        </div>
                    </button>
                `).join('');
                
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load agents:', error);
                listEl.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-2"></i>
                        <p class="text-sm">Failed to load agents</p>
                        <button onclick="loadAgents()" class="mt-2 text-xs text-cyan-400 hover:underline">Retry</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        async function selectAgent(agentId) {
            try {
                const response = await fetch(`${API_BASE}/api/agents/${agentId}`, {
                    headers: {
                        'X-User-Role': currentRole,
                        'X-User-Org': 'internal'
                    }
                });
                currentAgent = await response.json();
                
                // Update header
                document.getElementById('chatHeader').innerHTML = `
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: ${currentAgent.color}20">
                        <i data-lucide="${ICONS[currentAgent.icon] || 'bot'}" class="w-5 h-5" style="color: ${currentAgent.color}"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold text-white">${currentAgent.display_name}</h2>
                        <p class="text-sm text-slate-400">${currentAgent.description}</p>
                    </div>
                `;
                
                // Update sidebar selection
                document.querySelectorAll('.agent-card').forEach(card => {
                    card.classList.remove('border-cyan-500/50', 'bg-cyan-500/10');
                    if (card.dataset.agentId === agentId) {
                        card.classList.add('border-cyan-500/50', 'bg-cyan-500/10');
                    }
                });
                
                // Show chat, hide welcome
                document.getElementById('welcomeState').classList.add('hidden');
                document.getElementById('chatMessages').classList.remove('hidden');
                
                // Enable send button
                document.getElementById('sendButton').disabled = false;
                
                // Clear chat history for new agent
                chatHistory = [];
                document.getElementById('chatMessages').innerHTML = '';
                
                // Show example prompts
                showExamplePrompts();
                
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to select agent:', error);
            }
        }
        
        function showExamplePrompts() {
            if (!currentAgent) return;
            
            const messagesEl = document.getElementById('chatMessages');
            messagesEl.innerHTML = `
                <div class="glass rounded-xl p-4 animate-fadeIn">
                    <h4 class="text-sm font-medium text-cyan-400 mb-3 flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        Try asking ${currentAgent.display_name}:
                    </h4>
                    <div class="grid gap-2">
                        ${currentAgent.example_prompts.map(prompt => `
                            <button 
                                onclick="usePrompt('${prompt.replace(/'/g, "\\'")}')"
                                class="text-left px-4 py-2 rounded-lg bg-slate-800/50 border border-cyan-500/10 hover:border-cyan-500/30 text-sm text-slate-300 transition-colors"
                            >
                                ${prompt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        
        function usePrompt(prompt) {
            document.getElementById('messageInput').value = prompt;
            autoResize(document.getElementById('messageInput'));
        }
        
        // =================================================================
        // CHAT FUNCTIONS
        // =================================================================
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        async function sendMessage() {
            if (!currentAgent || isStreaming) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input
            input.value = '';
            autoResize(input);
            
            // Add user message
            addMessage('user', message);
            
            // Add assistant message placeholder
            const assistantMsgId = addMessage('assistant', '', true);
            
            // Disable input during streaming
            isStreaming = true;
            document.getElementById('sendButton').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/agents/${currentAgent.id}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Role': currentRole,
                        'X-User-Org': 'internal'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: chatHistory,
                        stream: true
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.token) {
                                    fullResponse += data.token;
                                    updateMessage(assistantMsgId, fullResponse);
                                }
                                
                                if (data.confidence !== undefined) {
                                    addConfidenceBadge(assistantMsgId, data.confidence);
                                }
                            } catch (e) {
                                // Skip non-JSON lines
                            }
                        }
                    }
                }
                
                // Add to chat history
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: fullResponse });
                
            } catch (error) {
                console.error('Chat error:', error);
                updateMessage(assistantMsgId, 'Sorry, an error occurred. Please try again.');
            }
            
            // Re-enable input
            isStreaming = false;
            document.getElementById('sendButton').disabled = false;
        }
        
        function addMessage(role, content, isStreaming = false) {
            const messagesEl = document.getElementById('chatMessages');
            const msgId = 'msg-' + Date.now();
            
            const isUser = role === 'user';
            const html = `
                <div id="${msgId}" class="chat-message flex gap-3 ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center ${isUser ? 'bg-cyan-500/20' : 'bg-slate-700'}">
                        <i data-lucide="${isUser ? 'user' : ICONS[currentAgent?.icon] || 'bot'}" class="w-4 h-4 ${isUser ? 'text-cyan-400' : 'text-slate-400'}"></i>
                    </div>
                    <div class="flex-1 ${isUser ? 'text-right' : ''}">
                        <div class="${isUser ? 'inline-block text-left bg-cyan-500/10 border border-cyan-500/20' : 'glass'} rounded-xl px-4 py-3 max-w-[80%] ${isUser ? '' : 'w-full'}">
                            <div class="message-content text-sm ${isStreaming && !content ? 'typing' : ''} ${isUser ? '' : 'markdown'}">
                                ${content ? (isUser ? escapeHtml(content) : formatMarkdown(content)) : ''}
                            </div>
                        </div>
                        <div class="confidence-badge mt-1"></div>
                    </div>
                </div>
            `;
            
            // Remove example prompts if present
            const examplePromptsEl = messagesEl.querySelector('.glass:first-child');
            if (examplePromptsEl && examplePromptsEl.querySelector('[data-lucide="sparkles"]')) {
                examplePromptsEl.remove();
            }
            
            messagesEl.insertAdjacentHTML('beforeend', html);
            lucide.createIcons();
            
            // Scroll to bottom
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
            
            return msgId;
        }
        
        function updateMessage(msgId, content) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            
            const contentEl = msgEl.querySelector('.message-content');
            contentEl.classList.remove('typing');
            contentEl.innerHTML = formatMarkdown(content);
            
            // Scroll to bottom
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
        }
        
        function addConfidenceBadge(msgId, confidence) {
            const msgEl = document.getElementById(msgId);
            if (!msgEl) return;
            
            const badgeEl = msgEl.querySelector('.confidence-badge');
            const level = confidence >= 0.85 ? 'HIGH' : confidence >= 0.70 ? 'MODERATE' : 'LOW';
            const color = confidence >= 0.85 ? 'green' : confidence >= 0.70 ? 'amber' : 'red';
            
            badgeEl.innerHTML = `
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs bg-${color}-500/20 text-${color}-400">
                    <span class="w-1.5 h-1.5 rounded-full bg-${color}-400"></span>
                    ${Math.round(confidence * 100)}% Confidence (${level})
                </span>
            `;
        }
        
        function clearChat() {
            chatHistory = [];
            document.getElementById('chatMessages').innerHTML = '';
            if (currentAgent) {
                showExamplePrompts();
            } else {
                document.getElementById('welcomeState').classList.remove('hidden');
                document.getElementById('chatMessages').classList.add('hidden');
            }
        }
        
        // =================================================================
        // UTILITY FUNCTIONS
        // =================================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatMarkdown(text) {
            // Simple markdown-like formatting
            return text
                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/---/g, '<hr>')
                .replace(/\|(.*?)\|/g, (match) => {
                    const cells = match.split('|').filter(c => c.trim());
                    if (cells.some(c => c.includes('---'))) return '';
                    return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                });
        }
    </script>
</body>
</html>
