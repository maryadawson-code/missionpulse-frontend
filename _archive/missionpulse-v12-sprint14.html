<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12.14 - Pipeline Command Center</title>
  
  <!-- External Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--bg-primary);
      min-height: 100vh;
      transition: background-color 0.3s ease;
    }
    
    /* CSS Variables for Theming */
    :root {
      --bg-primary: #00050F;
      --bg-secondary: #0a0f1a;
      --bg-card: #111827;
      --bg-card-hover: #1f2937;
      --border-color: #1f2937;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-cyan: #00E5FA;
      --accent-cyan-dim: rgba(0, 229, 250, 0.1);
    }
    
    .light-mode {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-card: #ffffff;
      --bg-card-hover: #f8fafc;
      --border-color: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
    }
    
    /* Animations */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-slideIn { animation: slideIn 0.3s ease-out; }
    .animate-slideUp { animation: slideUp 0.2s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    
    .tabular-nums { font-variant-numeric: tabular-nums; }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    
    /* Gantt Timeline Styles */
    .gantt-container { overflow-x: auto; overflow-y: auto; }
    .gantt-bar { transition: all 0.2s ease; cursor: pointer; }
    .gantt-bar:hover { filter: brightness(1.2); transform: scaleY(1.1); }
    .gantt-today-line { position: absolute; width: 2px; background: #ef4444; z-index: 10; }
    
    /* Widget Grid Styles */
    .widget-grid { display: grid; gap: 1rem; }
    .widget-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .widget-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .widget { transition: all 0.2s ease; }
    .widget.size-small { grid-column: span 1; }
    .widget.size-medium { grid-column: span 1; }
    .widget.size-large { grid-column: span 2; }
    
    /* Drag and Drop Styles */
    .dragging { opacity: 0.5; }
    .drag-over { border: 2px dashed #00E5FA !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // ============================================================
    // CONFIGURATION & CONSTANTS
    // ============================================================
    
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const SHIPLEY_PHASES = {
      'gate_1': { name: 'Gate 1', color: '#94a3b8', order: 1 },
      'blue_team': { name: 'Blue Team', color: '#60a5fa', order: 2 },
      'pink_team': { name: 'Pink Team', color: '#f472b6', order: 3 },
      'red_team': { name: 'Red Team', color: '#ef4444', order: 4 },
      'gold_team': { name: 'Gold Team', color: '#fbbf24', order: 5 },
      'submitted': { name: 'Submitted', color: '#22c55e', order: 6 },
      'awarded': { name: 'Awarded', color: '#8b5cf6', order: 7 },
      'lost': { name: 'Lost', color: '#64748b', order: 8 }
    };

    const PRIORITIES = {
      'P-0': { name: 'P-0 Critical', color: '#ef4444', bgColor: 'bg-red-500/20', textColor: 'text-red-400' },
      'P-1': { name: 'P-1 High', color: '#f59e0b', bgColor: 'bg-amber-500/20', textColor: 'text-amber-400' },
      'P-2': { name: 'P-2 Medium', color: '#3b82f6', bgColor: 'bg-blue-500/20', textColor: 'text-blue-400' },
      'P-3': { name: 'P-3 Low', color: '#64748b', bgColor: 'bg-slate-500/20', textColor: 'text-slate-400' }
    };

    const SHIPLEY_ROLES = [
      { id: 'CEO', name: 'CEO', description: 'Final Go/No-Go' },
      { id: 'COO', name: 'COO', description: 'Capture Oversight' },
      { id: 'CAP', name: 'CAP', description: 'Capture Manager' },
      { id: 'PM', name: 'PM', description: 'Proposal Manager' },
      { id: 'SA', name: 'SA', description: 'Solution Architect' },
      { id: 'FIN', name: 'FIN', description: 'Finance/Pricing' },
      { id: 'CON', name: 'CON', description: 'Contracts' },
      { id: 'DEL', name: 'DEL', description: 'Delivery Lead' },
      { id: 'QA', name: 'QA', description: 'Quality Assurance' }
    ];

    const DEFAULT_WIDGETS = [
      { id: 'pipeline-summary', name: 'Pipeline Summary', size: 'medium', enabled: true, position: 0 },
      { id: 'phase-funnel', name: 'Phase Funnel', size: 'medium', enabled: true, position: 1 },
      { id: 'due-this-week', name: 'Due This Week', size: 'medium', enabled: true, position: 2 },
      { id: 'pwin-distribution', name: 'Win Probability', size: 'medium', enabled: true, position: 3 },
      { id: 'agency-breakdown', name: 'Agency Breakdown', size: 'medium', enabled: true, position: 4 },
      { id: 'recent-activity', name: 'Recent Activity', size: 'medium', enabled: true, position: 5 },
      { id: 'my-assignments', name: 'My Assignments', size: 'medium', enabled: false, position: 6 },
      { id: 'stale-opps', name: 'Stale Opportunities', size: 'medium', enabled: false, position: 7 }
    ];

    // ============================================================
    // SVG ICONS
    // ============================================================
    
    const Icons = {
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      search: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      plus: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      chevronDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
      chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      calendar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
      kanban: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>,
      table: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      chart: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      gantt: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /><rect x="6" y="5" width="8" height="2" rx="1" fill="currentColor" /><rect x="10" y="9" width="6" height="2" rx="1" fill="currentColor" /><rect x="4" y="13" width="10" height="2" rx="1" fill="currentColor" /><rect x="8" y="17" width="4" height="2" rx="1" fill="currentColor" /></svg>,
      dashboard: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>,
      filter: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
      download: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      upload: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
      trash: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      edit: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      dots: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>,
      bell: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      settings: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      user: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      users: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      message: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
      pin: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>,
      pinFilled: () => <svg className="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>,
      send: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
      clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2" /></svg>,
      activity: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>,
      loader: () => <svg className="w-full h-full animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      sun: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      moon: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
      refresh: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      expand: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>,
      grip: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" /></svg>,
      zoomIn: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>,
      zoomOut: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" /></svg>,
      copy: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      trendingUp: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
      warning: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
    };

    const Icon = ({ name, className = "w-4 h-4" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    
    const formatCurrency = (value) => {
      if (!value) return '$0';
      if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
      if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
      if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
      return `$${value.toLocaleString()}`;
    };

    const formatDate = (dateString) => {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatRelativeTime = (dateString) => {
      if (!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return formatDate(dateString);
    };

    const getDaysRemaining = (dueDate) => {
      if (!dueDate) return null;
      const due = new Date(dueDate);
      const now = new Date();
      return Math.ceil((due - now) / (1000 * 60 * 60 * 24));
    };

    const mapToFrontend = (record) => {
      if (!record) return null;
      return {
        id: record.id,
        name: record.name,
        agency: record.agency,
        contractValue: record.contract_value,
        priority: record.priority,
        shipleyPhase: record.shipley_phase,
        winProbability: record.win_probability,
        dueDate: record.due_date,
        solicitationNumber: record.solicitation_number,
        description: record.description,
        createdAt: record.created_at,
        updatedAt: record.updated_at,
        daysRemaining: getDaysRemaining(record.due_date)
      };
    };

    const mapToDatabase = (data) => {
      if (!data) return null;
      const mapped = {};
      if (data.name !== undefined) mapped.name = data.name;
      if (data.agency !== undefined) mapped.agency = data.agency;
      if (data.contractValue !== undefined) mapped.contract_value = data.contractValue;
      if (data.priority !== undefined) mapped.priority = data.priority;
      if (data.shipleyPhase !== undefined) mapped.shipley_phase = data.shipleyPhase;
      if (data.winProbability !== undefined) mapped.win_probability = data.winProbability;
      if (data.dueDate !== undefined) mapped.due_date = data.dueDate;
      if (data.solicitationNumber !== undefined) mapped.solicitation_number = data.solicitationNumber;
      if (data.description !== undefined) mapped.description = data.description;
      mapped.updated_at = new Date().toISOString();
      return mapped;
    };

    const getInitials = (name) => {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    };

    // ============================================================
    // TOAST NOTIFICATION SYSTEM
    // ============================================================
    
    const ToastContext = React.createContext();

    const ToastProvider = ({ children }) => {
      const [toasts, setToasts] = useState([]);

      const addToast = useCallback((message, type = 'info', duration = 4000) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, duration);
      }, []);

      return (
        <ToastContext.Provider value={{ addToast }}>
          {children}
          <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2">
            {toasts.map(toast => (
              <div 
                key={toast.id}
                className={`px-4 py-3 rounded-lg shadow-lg animate-slideUp flex items-center gap-2 ${
                  toast.type === 'success' ? 'bg-green-500/90 text-white' :
                  toast.type === 'error' ? 'bg-red-500/90 text-white' :
                  toast.type === 'warning' ? 'bg-amber-500/90 text-white' :
                  'bg-cyan-500/90 text-white'
                }`}
              >
                <Icon name={toast.type === 'success' ? 'check' : toast.type === 'error' ? 'x' : 'bell'} className="w-4 h-4" />
                <span className="text-sm font-medium">{toast.message}</span>
              </div>
            ))}
          </div>
        </ToastContext.Provider>
      );
    };

    const useToast = () => React.useContext(ToastContext);

    // ============================================================
    // COMMENTS SYSTEM
    // ============================================================
    
    const CommentsTab = ({ opportunityId, onCountChange }) => {
      const [comments, setComments] = useState([]);
      const [newComment, setNewComment] = useState('');
      const [loading, setLoading] = useState(true);
      const [submitting, setSubmitting] = useState(false);
      const { addToast } = useToast();
      const textareaRef = useRef(null);

      // Fetch comments
      const fetchComments = useCallback(async () => {
        try {
          const { data, error } = await supabase
            .from('opportunity_comments')
            .select('*')
            .eq('opportunity_id', opportunityId)
            .order('is_pinned', { ascending: false })
            .order('created_at', { ascending: false });

          if (error) throw error;
          setComments(data || []);
          onCountChange?.(data?.length || 0);
        } catch (err) {
          console.error('Error fetching comments:', err);
          // Use localStorage fallback for demo
          const stored = JSON.parse(localStorage.getItem(`MP_COMMENTS_${opportunityId}`) || '[]');
          setComments(stored);
          onCountChange?.(stored.length);
        } finally {
          setLoading(false);
        }
      }, [opportunityId, onCountChange]);

      useEffect(() => {
        fetchComments();
        
        // Real-time subscription
        const channel = supabase
          .channel(`comments-${opportunityId}`)
          .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'opportunity_comments', filter: `opportunity_id=eq.${opportunityId}` },
            () => fetchComments()
          )
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [opportunityId, fetchComments]);

      const handleSubmit = async () => {
        if (!newComment.trim() || submitting) return;
        
        setSubmitting(true);
        const commentData = {
          id: crypto.randomUUID(),
          opportunity_id: opportunityId,
          content: newComment.trim(),
          author: 'Current User',
          is_pinned: false,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        try {
          const { error } = await supabase
            .from('opportunity_comments')
            .insert([commentData]);

          if (error) throw error;
          
          addToast('Comment added', 'success');
        } catch (err) {
          console.error('Error adding comment:', err);
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_COMMENTS_${opportunityId}`) || '[]');
          stored.unshift(commentData);
          localStorage.setItem(`MP_COMMENTS_${opportunityId}`, JSON.stringify(stored));
          setComments(stored);
          onCountChange?.(stored.length);
          addToast('Comment added (local)', 'success');
        } finally {
          setNewComment('');
          setSubmitting(false);
        }
      };

      const handlePin = async (commentId) => {
        const comment = comments.find(c => c.id === commentId);
        if (!comment) return;

        try {
          const { error } = await supabase
            .from('opportunity_comments')
            .update({ is_pinned: !comment.is_pinned })
            .eq('id', commentId);

          if (error) throw error;
          fetchComments();
          addToast(comment.is_pinned ? 'Comment unpinned' : 'Comment pinned', 'success');
        } catch (err) {
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_COMMENTS_${opportunityId}`) || '[]');
          const idx = stored.findIndex(c => c.id === commentId);
          if (idx !== -1) {
            stored[idx].is_pinned = !stored[idx].is_pinned;
            stored.sort((a, b) => (b.is_pinned ? 1 : 0) - (a.is_pinned ? 1 : 0));
            localStorage.setItem(`MP_COMMENTS_${opportunityId}`, JSON.stringify(stored));
            setComments(stored);
          }
        }
      };

      const handleDelete = async (commentId) => {
        if (!confirm('Delete this comment?')) return;

        try {
          const { error } = await supabase
            .from('opportunity_comments')
            .delete()
            .eq('id', commentId);

          if (error) throw error;
          fetchComments();
          addToast('Comment deleted', 'success');
        } catch (err) {
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_COMMENTS_${opportunityId}`) || '[]');
          const filtered = stored.filter(c => c.id !== commentId);
          localStorage.setItem(`MP_COMMENTS_${opportunityId}`, JSON.stringify(filtered));
          setComments(filtered);
          onCountChange?.(filtered.length);
        }
      };

      const handleKeyDown = (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
          handleSubmit();
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-48">
            <Icon name="loader" className="w-6 h-6 text-cyan-400" />
          </div>
        );
      }

      return (
        <div className="flex flex-col h-full">
          {/* Comments List */}
          <div className="flex-1 overflow-y-auto space-y-3 mb-4">
            {comments.length === 0 ? (
              <div className="text-center py-8 text-slate-500">
                <Icon name="message" className="w-8 h-8 mx-auto mb-2 opacity-50" />
                <p>No comments yet</p>
              </div>
            ) : (
              comments.map(comment => (
                <div 
                  key={comment.id} 
                  className={`p-3 rounded-lg border ${comment.is_pinned ? 'bg-cyan-500/10 border-cyan-500/30' : 'bg-slate-800/50 border-slate-700'}`}
                >
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <div className="flex items-center gap-2">
                      <div className="w-7 h-7 rounded-full bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-white text-xs font-medium">
                        {getInitials(comment.author)}
                      </div>
                      <div>
                        <span className="text-sm font-medium text-white">{comment.author}</span>
                        <span className="text-xs text-slate-500 ml-2">{formatRelativeTime(comment.created_at)}</span>
                      </div>
                      {comment.is_pinned && (
                        <span className="text-xs text-cyan-400 flex items-center gap-1">
                          <Icon name="pinFilled" className="w-3 h-3" /> Pinned
                        </span>
                      )}
                    </div>
                    <div className="flex items-center gap-1">
                      <button 
                        onClick={() => handlePin(comment.id)}
                        className={`p-1 rounded hover:bg-slate-700 ${comment.is_pinned ? 'text-cyan-400' : 'text-slate-500'}`}
                        title={comment.is_pinned ? 'Unpin' : 'Pin'}
                      >
                        <Icon name={comment.is_pinned ? 'pinFilled' : 'pin'} className="w-4 h-4" />
                      </button>
                      <button 
                        onClick={() => handleDelete(comment.id)}
                        className="p-1 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400"
                        title="Delete"
                      >
                        <Icon name="trash" className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                  <p className="text-sm text-slate-300 whitespace-pre-wrap">{comment.content}</p>
                </div>
              ))
            )}
          </div>

          {/* Comment Input */}
          <div className="border-t border-slate-700 pt-4">
            <textarea
              ref={textareaRef}
              value={newComment}
              onChange={(e) => setNewComment(e.target.value.slice(0, 1000))}
              onKeyDown={handleKeyDown}
              placeholder="Add a comment... (Ctrl+Enter to submit)"
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm resize-none focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
              rows={3}
            />
            <div className="flex items-center justify-between mt-2">
              <span className="text-xs text-slate-500">{newComment.length}/1000</span>
              <button
                onClick={handleSubmit}
                disabled={!newComment.trim() || submitting}
                className="px-4 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium hover:bg-cyan-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              >
                {submitting ? <Icon name="loader" className="w-4 h-4" /> : <Icon name="send" className="w-4 h-4" />}
                Send
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // TEAM ASSIGNMENTS
    // ============================================================
    
    const AssignmentsSection = ({ opportunityId, expanded, onToggle }) => {
      const [assignments, setAssignments] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showAddForm, setShowAddForm] = useState(false);
      const [newAssignment, setNewAssignment] = useState({ role: '', assignee_name: '', assignee_email: '' });
      const { addToast } = useToast();

      const fetchAssignments = useCallback(async () => {
        try {
          const { data, error } = await supabase
            .from('opportunity_assignments')
            .select('*')
            .eq('opportunity_id', opportunityId)
            .order('created_at', { ascending: true });

          if (error) throw error;
          setAssignments(data || []);
        } catch (err) {
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_ASSIGNMENTS_${opportunityId}`) || '[]');
          setAssignments(stored);
        } finally {
          setLoading(false);
        }
      }, [opportunityId]);

      useEffect(() => {
        fetchAssignments();
      }, [fetchAssignments]);

      const handleAdd = async () => {
        if (!newAssignment.role || !newAssignment.assignee_name) {
          addToast('Role and name are required', 'error');
          return;
        }

        if (assignments.length >= 10) {
          addToast('Maximum 10 assignments per opportunity', 'warning');
          return;
        }

        const assignmentData = {
          id: crypto.randomUUID(),
          opportunity_id: opportunityId,
          role: newAssignment.role,
          assignee_name: newAssignment.assignee_name,
          assignee_email: newAssignment.assignee_email || null,
          created_at: new Date().toISOString()
        };

        try {
          const { error } = await supabase
            .from('opportunity_assignments')
            .insert([assignmentData]);

          if (error) throw error;
          fetchAssignments();
          setNewAssignment({ role: '', assignee_name: '', assignee_email: '' });
          setShowAddForm(false);
          addToast('Assignment added', 'success');
        } catch (err) {
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_ASSIGNMENTS_${opportunityId}`) || '[]');
          stored.push(assignmentData);
          localStorage.setItem(`MP_ASSIGNMENTS_${opportunityId}`, JSON.stringify(stored));
          setAssignments(stored);
          setNewAssignment({ role: '', assignee_name: '', assignee_email: '' });
          setShowAddForm(false);
          addToast('Assignment added (local)', 'success');
        }
      };

      const handleRemove = async (assignmentId) => {
        try {
          const { error } = await supabase
            .from('opportunity_assignments')
            .delete()
            .eq('id', assignmentId);

          if (error) throw error;
          fetchAssignments();
          addToast('Assignment removed', 'success');
        } catch (err) {
          // localStorage fallback
          const stored = JSON.parse(localStorage.getItem(`MP_ASSIGNMENTS_${opportunityId}`) || '[]');
          const filtered = stored.filter(a => a.id !== assignmentId);
          localStorage.setItem(`MP_ASSIGNMENTS_${opportunityId}`, JSON.stringify(filtered));
          setAssignments(filtered);
        }
      };

      const roleColors = {
        CEO: 'bg-purple-500',
        COO: 'bg-blue-500',
        CAP: 'bg-cyan-500',
        PM: 'bg-green-500',
        SA: 'bg-amber-500',
        FIN: 'bg-pink-500',
        CON: 'bg-red-500',
        DEL: 'bg-indigo-500',
        QA: 'bg-teal-500'
      };

      return (
        <div className="border border-slate-700 rounded-lg overflow-hidden">
          <button 
            onClick={onToggle}
            className="w-full px-4 py-3 flex items-center justify-between bg-slate-800/50 hover:bg-slate-800"
          >
            <div className="flex items-center gap-2">
              <Icon name="users" className="w-4 h-4 text-cyan-400" />
              <span className="font-medium text-white">Team Assignments</span>
              {assignments.length > 0 && (
                <span className="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">
                  {assignments.length}
                </span>
              )}
            </div>
            <Icon name={expanded ? 'chevronDown' : 'chevronRight'} className="w-4 h-4 text-slate-400" />
          </button>

          {expanded && (
            <div className="p-4 space-y-3">
              {loading ? (
                <div className="flex justify-center py-4">
                  <Icon name="loader" className="w-5 h-5 text-cyan-400" />
                </div>
              ) : (
                <>
                  {/* Assignments List */}
                  {assignments.length > 0 && (
                    <div className="space-y-2">
                      {assignments.map(assignment => (
                        <div 
                          key={assignment.id}
                          className="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg"
                        >
                          <div className="flex items-center gap-3">
                            <div className={`w-8 h-8 rounded-full ${roleColors[assignment.role] || 'bg-slate-500'} flex items-center justify-center text-white text-xs font-medium`}>
                              {getInitials(assignment.assignee_name)}
                            </div>
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-medium text-white">{assignment.assignee_name}</span>
                                <span className={`text-xs px-2 py-0.5 rounded ${roleColors[assignment.role] || 'bg-slate-500'} text-white`}>
                                  {assignment.role}
                                </span>
                              </div>
                              {assignment.assignee_email && (
                                <span className="text-xs text-slate-500">{assignment.assignee_email}</span>
                              )}
                            </div>
                          </div>
                          <button 
                            onClick={() => handleRemove(assignment.id)}
                            className="p-1.5 rounded hover:bg-red-500/20 text-slate-500 hover:text-red-400"
                          >
                            <Icon name="x" className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Add Form */}
                  {showAddForm ? (
                    <div className="space-y-3 pt-2 border-t border-slate-700">
                      <select
                        value={newAssignment.role}
                        onChange={(e) => setNewAssignment(prev => ({ ...prev, role: e.target.value }))}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      >
                        <option value="">Select Role...</option>
                        {SHIPLEY_ROLES.map(role => (
                          <option key={role.id} value={role.id}>{role.id} - {role.description}</option>
                        ))}
                      </select>
                      <input
                        type="text"
                        value={newAssignment.assignee_name}
                        onChange={(e) => setNewAssignment(prev => ({ ...prev, assignee_name: e.target.value }))}
                        placeholder="Assignee Name"
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      />
                      <input
                        type="email"
                        value={newAssignment.assignee_email}
                        onChange={(e) => setNewAssignment(prev => ({ ...prev, assignee_email: e.target.value }))}
                        placeholder="Email (optional)"
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={handleAdd}
                          className="flex-1 px-3 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium hover:bg-cyan-600"
                        >
                          Add Assignment
                        </button>
                        <button
                          onClick={() => {
                            setShowAddForm(false);
                            setNewAssignment({ role: '', assignee_name: '', assignee_email: '' });
                          }}
                          className="px-3 py-2 bg-slate-700 text-white rounded-lg text-sm hover:bg-slate-600"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button
                      onClick={() => setShowAddForm(true)}
                      disabled={assignments.length >= 10}
                      className="w-full px-3 py-2 border border-dashed border-slate-600 rounded-lg text-slate-400 hover:text-cyan-400 hover:border-cyan-500/50 text-sm flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Icon name="plus" className="w-4 h-4" />
                      Add Team Member
                    </button>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      );
    };

    // ============================================================
    // GANTT TIMELINE VIEW
    // ============================================================
    
    const GanttTimelineView = ({ opportunities, onSelectOpportunity }) => {
      const [zoom, setZoom] = useState('week'); // day, week, month
      const [groupBy, setGroupBy] = useState('none'); // none, agency, priority, phase
      const containerRef = useRef(null);

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate timeline range
      const timelineData = useMemo(() => {
        if (!opportunities.length) return { start: today, end: today, days: 0, opps: [] };

        const validOpps = opportunities.filter(o => o.dueDate);
        if (!validOpps.length) return { start: today, end: today, days: 0, opps: [] };

        // Find min/max dates
        const dates = validOpps.map(o => new Date(o.dueDate));
        const minDate = new Date(Math.min(today, ...dates));
        const maxDate = new Date(Math.max(...dates));
        
        // Add padding
        minDate.setDate(minDate.getDate() - 7);
        maxDate.setDate(maxDate.getDate() + 14);

        const days = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));

        return { start: minDate, end: maxDate, days, opps: validOpps };
      }, [opportunities]);

      // Group opportunities
      const groupedOpps = useMemo(() => {
        const opps = timelineData.opps;
        if (groupBy === 'none') return [{ name: 'All Opportunities', items: opps }];

        const groups = {};
        opps.forEach(opp => {
          let key;
          switch (groupBy) {
            case 'agency': key = opp.agency || 'Unknown'; break;
            case 'priority': key = opp.priority || 'P-3'; break;
            case 'phase': key = opp.shipleyPhase || 'gate_1'; break;
            default: key = 'All';
          }
          if (!groups[key]) groups[key] = [];
          groups[key].push(opp);
        });

        return Object.entries(groups).map(([name, items]) => ({ name, items }));
      }, [timelineData.opps, groupBy]);

      // Generate column headers based on zoom
      const columns = useMemo(() => {
        const cols = [];
        const { start, end } = timelineData;
        let current = new Date(start);

        while (current <= end) {
          const label = zoom === 'day' 
            ? current.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })
            : zoom === 'week'
            ? `W${Math.ceil((current.getDate()) / 7)} ${current.toLocaleDateString('en-US', { month: 'short' })}`
            : current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
          
          cols.push({ date: new Date(current), label });
          
          if (zoom === 'day') current.setDate(current.getDate() + 1);
          else if (zoom === 'week') current.setDate(current.getDate() + 7);
          else current.setMonth(current.getMonth() + 1);
        }
        return cols;
      }, [timelineData, zoom]);

      const getBarPosition = (opp) => {
        const { start, days } = timelineData;
        const dueDate = new Date(opp.dueDate);
        const createdDate = opp.createdAt ? new Date(opp.createdAt) : new Date(today);
        createdDate.setDate(createdDate.getDate() - 14); // Show as starting 2 weeks before created

        const barStart = Math.max(0, (createdDate - start) / (1000 * 60 * 60 * 24));
        const barEnd = (dueDate - start) / (1000 * 60 * 60 * 24);
        const left = (barStart / days) * 100;
        const width = ((barEnd - barStart) / days) * 100;

        return { left: `${Math.max(0, left)}%`, width: `${Math.min(100 - left, Math.max(width, 2))}%` };
      };

      const getTodayPosition = () => {
        const { start, days } = timelineData;
        const pos = (today - start) / (1000 * 60 * 60 * 24);
        return `${(pos / days) * 100}%`;
      };

      const getBarColor = (opp) => {
        return SHIPLEY_PHASES[opp.shipleyPhase]?.color || '#94a3b8';
      };

      const getBarHeight = (priority) => {
        switch (priority) {
          case 'P-0': return 'h-8';
          case 'P-1': return 'h-7';
          case 'P-2': return 'h-6';
          default: return 'h-5';
        }
      };

      if (!timelineData.opps.length) {
        return (
          <div className="flex items-center justify-center h-96 text-slate-500">
            <div className="text-center">
              <Icon name="gantt" className="w-12 h-12 mx-auto mb-4 opacity-50" />
              <p>No opportunities with due dates to display</p>
            </div>
          </div>
        );
      }

      return (
        <div className="h-full flex flex-col">
          {/* Controls */}
          <div className="flex items-center justify-between mb-4 pb-4 border-b border-slate-700">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <span className="text-sm text-slate-400">Zoom:</span>
                <div className="flex bg-slate-800 rounded-lg p-1">
                  {['day', 'week', 'month'].map(z => (
                    <button
                      key={z}
                      onClick={() => setZoom(z)}
                      className={`px-3 py-1 rounded text-sm capitalize ${zoom === z ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                      {z}
                    </button>
                  ))}
                </div>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-sm text-slate-400">Group by:</span>
                <select
                  value={groupBy}
                  onChange={(e) => setGroupBy(e.target.value)}
                  className="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                >
                  <option value="none">None</option>
                  <option value="agency">Agency</option>
                  <option value="priority">Priority</option>
                  <option value="phase">Phase</option>
                </select>
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm text-slate-400">
              <div className="w-3 h-3 bg-red-500 rounded-full"></div>
              <span>Today</span>
            </div>
          </div>

          {/* Timeline */}
          <div className="flex-1 overflow-auto gantt-container" ref={containerRef}>
            <div className="min-w-[1000px]">
              {/* Header */}
              <div className="flex border-b border-slate-700 sticky top-0 bg-slate-900 z-20">
                <div className="w-64 flex-shrink-0 p-3 text-sm font-medium text-slate-400 border-r border-slate-700">
                  Opportunity
                </div>
                <div className="flex-1 relative">
                  <div className="flex">
                    {columns.map((col, i) => (
                      <div 
                        key={i}
                        className="flex-1 min-w-[60px] p-2 text-center text-xs text-slate-500 border-r border-slate-800"
                      >
                        {col.label}
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Groups */}
              {groupedOpps.map((group, gi) => (
                <div key={gi} className="border-b border-slate-800">
                  {groupBy !== 'none' && (
                    <div className="flex bg-slate-800/50">
                      <div className="w-64 flex-shrink-0 p-2 text-sm font-medium text-slate-300 border-r border-slate-700">
                        {groupBy === 'phase' ? SHIPLEY_PHASES[group.name]?.name || group.name : group.name}
                        <span className="ml-2 text-xs text-slate-500">({group.items.length})</span>
                      </div>
                      <div className="flex-1"></div>
                    </div>
                  )}
                  
                  {/* Rows */}
                  {group.items.map((opp, i) => {
                    const pos = getBarPosition(opp);
                    return (
                      <div 
                        key={opp.id}
                        className="flex hover:bg-slate-800/30 group"
                      >
                        <div className="w-64 flex-shrink-0 p-2 text-sm text-white border-r border-slate-700 truncate flex items-center gap-2">
                          <span 
                            className="w-2 h-2 rounded-full flex-shrink-0"
                            style={{ backgroundColor: PRIORITIES[opp.priority]?.color || '#64748b' }}
                          />
                          <span 
                            className="truncate cursor-pointer hover:text-cyan-400"
                            onClick={() => onSelectOpportunity(opp)}
                          >
                            {opp.name}
                          </span>
                        </div>
                        <div className="flex-1 relative h-10 flex items-center">
                          {/* Grid lines */}
                          <div className="absolute inset-0 flex">
                            {columns.map((_, i) => (
                              <div key={i} className="flex-1 border-r border-slate-800/50"></div>
                            ))}
                          </div>
                          
                          {/* Today line */}
                          <div 
                            className="gantt-today-line h-full"
                            style={{ left: getTodayPosition() }}
                          />
                          
                          {/* Bar */}
                          <div
                            className={`gantt-bar absolute ${getBarHeight(opp.priority)} rounded-sm flex items-center px-2`}
                            style={{ 
                              left: pos.left, 
                              width: pos.width, 
                              backgroundColor: getBarColor(opp),
                              minWidth: '20px'
                            }}
                            onClick={() => onSelectOpportunity(opp)}
                            title={`${opp.name}\nDue: ${formatDate(opp.dueDate)}\n${opp.daysRemaining} days remaining`}
                          >
                            <span className="text-xs text-white truncate font-medium">
                              {opp.daysRemaining}d
                            </span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // DASHBOARD WIDGETS
    // ============================================================
    
    const DashboardWidget = ({ widget, opportunities, activities, onExpand, onRefresh }) => {
      const renderContent = () => {
        switch (widget.id) {
          case 'pipeline-summary': {
            const totalValue = opportunities.reduce((sum, o) => sum + (o.contractValue || 0), 0);
            const avgPwin = opportunities.length 
              ? Math.round(opportunities.reduce((sum, o) => sum + (o.winProbability || 0), 0) / opportunities.length)
              : 0;
            const weightedValue = opportunities.reduce((sum, o) => sum + ((o.contractValue || 0) * (o.winProbability || 0) / 100), 0);
            
            return (
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-slate-500 uppercase tracking-wider">Total Pipeline</p>
                  <p className="text-2xl font-bold text-white">{formatCurrency(totalValue)}</p>
                </div>
                <div>
                  <p className="text-xs text-slate-500 uppercase tracking-wider">Weighted Value</p>
                  <p className="text-2xl font-bold text-cyan-400">{formatCurrency(weightedValue)}</p>
                </div>
                <div>
                  <p className="text-xs text-slate-500 uppercase tracking-wider">Opportunities</p>
                  <p className="text-2xl font-bold text-white">{opportunities.length}</p>
                </div>
                <div>
                  <p className="text-xs text-slate-500 uppercase tracking-wider">Avg Win Prob</p>
                  <p className="text-2xl font-bold text-green-400">{avgPwin}%</p>
                </div>
              </div>
            );
          }
          
          case 'phase-funnel': {
            const phases = Object.entries(SHIPLEY_PHASES).slice(0, 6);
            const maxCount = Math.max(...phases.map(([key]) => 
              opportunities.filter(o => o.shipleyPhase === key).length
            ), 1);
            
            return (
              <div className="space-y-2">
                {phases.map(([key, phase]) => {
                  const count = opportunities.filter(o => o.shipleyPhase === key).length;
                  const width = (count / maxCount) * 100;
                  return (
                    <div key={key} className="flex items-center gap-2">
                      <span className="text-xs text-slate-400 w-20 truncate">{phase.name}</span>
                      <div className="flex-1 h-5 bg-slate-800 rounded overflow-hidden">
                        <div 
                          className="h-full rounded flex items-center justify-end px-2"
                          style={{ width: `${width}%`, backgroundColor: phase.color }}
                        >
                          {count > 0 && <span className="text-xs text-white font-medium">{count}</span>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            );
          }
          
          case 'due-this-week': {
            const now = new Date();
            const weekEnd = new Date(now);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            const dueThisWeek = opportunities
              .filter(o => {
                if (!o.dueDate) return false;
                const due = new Date(o.dueDate);
                return due >= now && due <= weekEnd;
              })
              .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
              .slice(0, 5);
            
            if (!dueThisWeek.length) {
              return <p className="text-slate-500 text-sm">No deadlines this week</p>;
            }
            
            return (
              <div className="space-y-2">
                {dueThisWeek.map(opp => (
                  <div key={opp.id} className="flex items-center justify-between p-2 bg-slate-800/50 rounded">
                    <span className="text-sm text-white truncate flex-1">{opp.name}</span>
                    <span className={`text-xs px-2 py-1 rounded ${opp.daysRemaining <= 2 ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`}>
                      {opp.daysRemaining}d
                    </span>
                  </div>
                ))}
              </div>
            );
          }
          
          case 'pwin-distribution': {
            const ranges = [
              { label: '0-25%', min: 0, max: 25, color: '#ef4444' },
              { label: '26-50%', min: 26, max: 50, color: '#f59e0b' },
              { label: '51-75%', min: 51, max: 75, color: '#3b82f6' },
              { label: '76-100%', min: 76, max: 100, color: '#22c55e' }
            ];
            
            const maxCount = Math.max(...ranges.map(r => 
              opportunities.filter(o => (o.winProbability || 0) >= r.min && (o.winProbability || 0) <= r.max).length
            ), 1);
            
            return (
              <div className="flex items-end justify-around h-32 gap-2">
                {ranges.map(range => {
                  const count = opportunities.filter(o => 
                    (o.winProbability || 0) >= range.min && (o.winProbability || 0) <= range.max
                  ).length;
                  const height = (count / maxCount) * 100;
                  return (
                    <div key={range.label} className="flex flex-col items-center flex-1">
                      <div 
                        className="w-full rounded-t transition-all"
                        style={{ height: `${height}%`, backgroundColor: range.color, minHeight: count > 0 ? '8px' : '0' }}
                      />
                      <span className="text-xs text-slate-500 mt-1">{range.label}</span>
                      <span className="text-xs font-medium text-white">{count}</span>
                    </div>
                  );
                })}
              </div>
            );
          }
          
          case 'agency-breakdown': {
            const agencyCounts = {};
            opportunities.forEach(o => {
              const agency = o.agency || 'Unknown';
              agencyCounts[agency] = (agencyCounts[agency] || 0) + 1;
            });
            
            const sorted = Object.entries(agencyCounts)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5);
            
            const colors = ['#00E5FA', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444'];
            const total = sorted.reduce((sum, [, count]) => sum + count, 0);
            
            return (
              <div className="flex items-center gap-4">
                <div className="w-24 h-24 relative">
                  <svg viewBox="0 0 32 32" className="transform -rotate-90">
                    {sorted.reduce((acc, [agency, count], i) => {
                      const percent = (count / total) * 100;
                      const offset = acc.offset;
                      acc.elements.push(
                        <circle
                          key={agency}
                          cx="16" cy="16" r="12"
                          fill="none"
                          stroke={colors[i]}
                          strokeWidth="8"
                          strokeDasharray={`${percent} ${100 - percent}`}
                          strokeDashoffset={-offset}
                          className="transition-all"
                        />
                      );
                      acc.offset += percent;
                      return acc;
                    }, { elements: [], offset: 0 }).elements}
                  </svg>
                </div>
                <div className="flex-1 space-y-1">
                  {sorted.map(([agency, count], i) => (
                    <div key={agency} className="flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full" style={{ backgroundColor: colors[i] }} />
                      <span className="text-xs text-slate-400 flex-1 truncate">{agency}</span>
                      <span className="text-xs font-medium text-white">{count}</span>
                    </div>
                  ))}
                </div>
              </div>
            );
          }
          
          case 'recent-activity': {
            const recentActivities = activities.slice(0, 6);
            
            if (!recentActivities.length) {
              return <p className="text-slate-500 text-sm">No recent activity</p>;
            }
            
            return (
              <div className="space-y-2">
                {recentActivities.map(act => (
                  <div key={act.id} className="flex items-center gap-2 text-xs">
                    <div className={`w-2 h-2 rounded-full ${
                      act.action === 'created' ? 'bg-green-500' :
                      act.action === 'deleted' ? 'bg-red-500' :
                      'bg-cyan-500'
                    }`} />
                    <span className="text-slate-400 flex-1 truncate">
                      {act.action === 'created' ? 'Created' : 
                       act.action === 'deleted' ? 'Deleted' :
                       `Updated ${act.field_changed || 'item'}`}
                    </span>
                    <span className="text-slate-500">{formatRelativeTime(act.created_at)}</span>
                  </div>
                ))}
              </div>
            );
          }
          
          case 'stale-opps': {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const stale = opportunities.filter(o => {
              const updated = new Date(o.updatedAt);
              return updated < sevenDaysAgo && !['submitted', 'awarded', 'lost'].includes(o.shipleyPhase);
            }).slice(0, 5);
            
            if (!stale.length) {
              return (
                <div className="text-center py-4">
                  <Icon name="check" className="w-8 h-8 mx-auto text-green-500 mb-2" />
                  <p className="text-sm text-slate-400">All opportunities are active!</p>
                </div>
              );
            }
            
            return (
              <div className="space-y-2">
                {stale.map(opp => (
                  <div key={opp.id} className="flex items-center justify-between p-2 bg-amber-500/10 border border-amber-500/20 rounded">
                    <span className="text-sm text-white truncate flex-1">{opp.name}</span>
                    <Icon name="warning" className="w-4 h-4 text-amber-500" />
                  </div>
                ))}
              </div>
            );
          }
          
          default:
            return <p className="text-slate-500">Widget not configured</p>;
        }
      };

      return (
        <div className={`widget ${widget.size === 'large' ? 'size-large' : 'size-medium'} bg-slate-800/50 border border-slate-700 rounded-xl p-4`}>
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-medium text-white">{widget.name}</h3>
            <div className="flex items-center gap-1">
              <button 
                onClick={onRefresh}
                className="p-1.5 rounded hover:bg-slate-700 text-slate-500 hover:text-white"
                title="Refresh"
              >
                <Icon name="refresh" className="w-4 h-4" />
              </button>
              <button 
                onClick={onExpand}
                className="p-1.5 rounded hover:bg-slate-700 text-slate-500 hover:text-white"
                title="Expand"
              >
                <Icon name="expand" className="w-4 h-4" />
              </button>
            </div>
          </div>
          {renderContent()}
        </div>
      );
    };

    const DashboardView = ({ opportunities, activities }) => {
      const [widgets, setWidgets] = useState(() => {
        const saved = localStorage.getItem('MP_DASHBOARD_LAYOUT');
        return saved ? JSON.parse(saved) : DEFAULT_WIDGETS;
      });
      const [columns, setColumns] = useState(() => {
        const saved = localStorage.getItem('MP_DASHBOARD_COLUMNS');
        return saved ? parseInt(saved) : 2;
      });
      const [configuring, setConfiguring] = useState(false);

      useEffect(() => {
        localStorage.setItem('MP_DASHBOARD_LAYOUT', JSON.stringify(widgets));
      }, [widgets]);

      useEffect(() => {
        localStorage.setItem('MP_DASHBOARD_COLUMNS', columns.toString());
      }, [columns]);

      const toggleWidget = (widgetId) => {
        setWidgets(prev => prev.map(w => 
          w.id === widgetId ? { ...w, enabled: !w.enabled } : w
        ));
      };

      const enabledWidgets = widgets.filter(w => w.enabled).sort((a, b) => a.position - b.position);

      return (
        <div className="h-full flex flex-col">
          {/* Dashboard Header */}
          <div className="flex items-center justify-between mb-4 pb-4 border-b border-slate-700">
            <h2 className="text-lg font-semibold text-white">Dashboard</h2>
            <div className="flex items-center gap-3">
              <div className="flex items-center gap-2">
                <span className="text-sm text-slate-400">Columns:</span>
                <div className="flex bg-slate-800 rounded-lg p-1">
                  {[2, 3].map(c => (
                    <button
                      key={c}
                      onClick={() => setColumns(c)}
                      className={`px-3 py-1 rounded text-sm ${columns === c ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                      {c}
                    </button>
                  ))}
                </div>
              </div>
              <button
                onClick={() => setConfiguring(!configuring)}
                className={`px-3 py-1.5 rounded-lg text-sm flex items-center gap-2 ${configuring ? 'bg-cyan-500 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}
              >
                <Icon name="settings" className="w-4 h-4" />
                Configure
              </button>
            </div>
          </div>

          {/* Configuration Panel */}
          {configuring && (
            <div className="mb-4 p-4 bg-slate-800/50 border border-slate-700 rounded-xl">
              <h3 className="text-sm font-medium text-white mb-3">Toggle Widgets</h3>
              <div className="grid grid-cols-4 gap-2">
                {widgets.map(widget => (
                  <button
                    key={widget.id}
                    onClick={() => toggleWidget(widget.id)}
                    className={`px-3 py-2 rounded-lg text-sm text-left ${widget.enabled ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'bg-slate-700 text-slate-400 border border-transparent'}`}
                  >
                    {widget.name}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Widget Grid */}
          <div className={`widget-grid cols-${columns} flex-1 overflow-y-auto`}>
            {enabledWidgets.map(widget => (
              <DashboardWidget
                key={widget.id}
                widget={widget}
                opportunities={opportunities}
                activities={activities}
                onExpand={() => {}}
                onRefresh={() => {}}
              />
            ))}
          </div>
        </div>
      );
    };

    // ============================================================
    // OPPORTUNITY CARD
    // ============================================================
    
    const OpportunityCard = ({ opportunity, onSelect, onPhaseChange, commentCount = 0, assignmentCount = 0 }) => {
      const [isDragging, setIsDragging] = useState(false);
      const priority = PRIORITIES[opportunity.priority] || PRIORITIES['P-3'];
      const phase = SHIPLEY_PHASES[opportunity.shipleyPhase] || SHIPLEY_PHASES.gate_1;

      const handleDragStart = (e) => {
        setIsDragging(true);
        e.dataTransfer.setData('opportunityId', opportunity.id);
        e.dataTransfer.setData('sourcePhase', opportunity.shipleyPhase);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragEnd = () => {
        setIsDragging(false);
      };

      return (
        <div
          draggable
          onDragStart={handleDragStart}
          onDragEnd={handleDragEnd}
          onClick={() => onSelect(opportunity)}
          className={`group p-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg cursor-pointer transition-all ${isDragging ? 'opacity-50' : ''}`}
        >
          {/* Header */}
          <div className="flex items-start justify-between gap-2 mb-2">
            <h4 className="text-sm font-medium text-white line-clamp-2 flex-1">{opportunity.name}</h4>
            <span className={`text-xs px-2 py-0.5 rounded font-medium ${priority.bgColor} ${priority.textColor}`}>
              {opportunity.priority}
            </span>
          </div>

          {/* Agency */}
          <p className="text-xs text-slate-400 mb-2 truncate">{opportunity.agency}</p>

          {/* Value and pWin */}
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-semibold text-white">
              {formatCurrency(opportunity.contractValue)}
            </span>
            <div className="flex items-center gap-1">
              <div className="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                <div 
                  className="h-full rounded-full bg-gradient-to-r from-cyan-500 to-green-500"
                  style={{ width: `${opportunity.winProbability || 0}%` }}
                />
              </div>
              <span className="text-xs text-cyan-400">{opportunity.winProbability || 0}%</span>
            </div>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-between pt-2 border-t border-slate-700">
            <div className="flex items-center gap-3 text-xs text-slate-500">
              {/* Due Date */}
              <span className={`flex items-center gap-1 ${
                opportunity.daysRemaining !== null && opportunity.daysRemaining <= 7 
                  ? opportunity.daysRemaining <= 3 ? 'text-red-400' : 'text-amber-400' 
                  : ''
              }`}>
                <Icon name="calendar" className="w-3 h-3" />
                {opportunity.daysRemaining !== null ? `${opportunity.daysRemaining}d` : 'No date'}
              </span>
              
              {/* Comments */}
              {commentCount > 0 && (
                <span className="flex items-center gap-1">
                  <Icon name="message" className="w-3 h-3" />
                  {commentCount}
                </span>
              )}
              
              {/* Assignments */}
              {assignmentCount > 0 && (
                <span className="flex items-center gap-1">
                  <Icon name="users" className="w-3 h-3" />
                  {assignmentCount}
                </span>
              )}
            </div>

            {/* Quick Phase Forward */}
            <button
              onClick={(e) => {
                e.stopPropagation();
                const phases = Object.keys(SHIPLEY_PHASES);
                const currentIdx = phases.indexOf(opportunity.shipleyPhase);
                if (currentIdx < phases.length - 1) {
                  onPhaseChange(opportunity.id, phases[currentIdx + 1]);
                }
              }}
              className="opacity-0 group-hover:opacity-100 p-1 rounded bg-cyan-500/20 text-cyan-400 hover:bg-cyan-500/30 transition-opacity"
              title="Move to next phase"
            >
              <Icon name="chevronRight" className="w-3 h-3" />
            </button>
          </div>
        </div>
      );
    };

    // ============================================================
    // BOARD VIEW (KANBAN)
    // ============================================================
    
    const BoardView = ({ opportunities, onSelectOpportunity, onUpdateOpportunity }) => {
      const [dragOverPhase, setDragOverPhase] = useState(null);
      const { addToast } = useToast();

      const handleDragOver = (e, phase) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        setDragOverPhase(phase);
      };

      const handleDragLeave = () => {
        setDragOverPhase(null);
      };

      const handleDrop = async (e, targetPhase) => {
        e.preventDefault();
        setDragOverPhase(null);

        const opportunityId = e.dataTransfer.getData('opportunityId');
        const sourcePhase = e.dataTransfer.getData('sourcePhase');

        if (sourcePhase === targetPhase) return;

        // Optimistic update
        onUpdateOpportunity(opportunityId, { shipleyPhase: targetPhase });
        addToast(`Moved to ${SHIPLEY_PHASES[targetPhase].name}`, 'success');
      };

      const groupedOpportunities = useMemo(() => {
        const grouped = {};
        Object.keys(SHIPLEY_PHASES).forEach(phase => {
          grouped[phase] = opportunities.filter(o => o.shipleyPhase === phase);
        });
        return grouped;
      }, [opportunities]);

      return (
        <div className="flex gap-4 h-full overflow-x-auto pb-4">
          {Object.entries(SHIPLEY_PHASES).map(([phaseKey, phase]) => {
            const phaseOpps = groupedOpportunities[phaseKey] || [];
            const totalValue = phaseOpps.reduce((sum, o) => sum + (o.contractValue || 0), 0);

            return (
              <div
                key={phaseKey}
                className={`flex-shrink-0 w-72 flex flex-col rounded-xl border transition-colors ${
                  dragOverPhase === phaseKey 
                    ? 'border-cyan-500 bg-cyan-500/5' 
                    : 'border-slate-700 bg-slate-900/50'
                }`}
                onDragOver={(e) => handleDragOver(e, phaseKey)}
                onDragLeave={handleDragLeave}
                onDrop={(e) => handleDrop(e, phaseKey)}
              >
                {/* Column Header */}
                <div className="p-3 border-b border-slate-700">
                  <div className="flex items-center justify-between mb-1">
                    <div className="flex items-center gap-2">
                      <div 
                        className="w-3 h-3 rounded-full"
                        style={{ backgroundColor: phase.color }}
                      />
                      <h3 className="font-medium text-white text-sm">{phase.name}</h3>
                    </div>
                    <span className="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full">
                      {phaseOpps.length}
                    </span>
                  </div>
                  <p className="text-xs text-slate-500">{formatCurrency(totalValue)}</p>
                </div>

                {/* Cards */}
                <div className="flex-1 overflow-y-auto p-2 space-y-2">
                  {phaseOpps.map(opp => (
                    <OpportunityCard
                      key={opp.id}
                      opportunity={opp}
                      onSelect={onSelectOpportunity}
                      onPhaseChange={(id, newPhase) => onUpdateOpportunity(id, { shipleyPhase: newPhase })}
                    />
                  ))}
                  
                  {phaseOpps.length === 0 && (
                    <div className="text-center py-8 text-slate-600 text-sm">
                      Drop here
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      );
    };

    // ============================================================
    // TABLE VIEW
    // ============================================================
    
    const TableView = ({ opportunities, onSelectOpportunity, sortConfig, onSort }) => {
      const columns = [
        { key: 'name', label: 'Opportunity', sortable: true },
        { key: 'agency', label: 'Agency', sortable: true },
        { key: 'contractValue', label: 'Value', sortable: true },
        { key: 'priority', label: 'Priority', sortable: true },
        { key: 'shipleyPhase', label: 'Phase', sortable: true },
        { key: 'winProbability', label: 'pWin', sortable: true },
        { key: 'dueDate', label: 'Due Date', sortable: true }
      ];

      const getSortIcon = (key) => {
        if (sortConfig.key !== key) return null;
        return sortConfig.direction === 'asc' ? '' : '';
      };

      return (
        <div className="bg-slate-800/50 border border-slate-700 rounded-xl overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-slate-700">
                  {columns.map(col => (
                    <th 
                      key={col.key}
                      onClick={() => col.sortable && onSort(col.key)}
                      className={`px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider ${col.sortable ? 'cursor-pointer hover:text-white' : ''}`}
                    >
                      <span className="flex items-center gap-1">
                        {col.label}
                        {getSortIcon(col.key)}
                      </span>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700">
                {opportunities.map(opp => (
                  <tr 
                    key={opp.id}
                    onClick={() => onSelectOpportunity(opp)}
                    className="hover:bg-slate-700/50 cursor-pointer"
                  >
                    <td className="px-4 py-3">
                      <span className="text-sm font-medium text-white">{opp.name}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className="text-sm text-slate-300">{opp.agency}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className="text-sm font-semibold text-white">{formatCurrency(opp.contractValue)}</span>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`text-xs px-2 py-1 rounded ${PRIORITIES[opp.priority]?.bgColor} ${PRIORITIES[opp.priority]?.textColor}`}>
                        {opp.priority}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      <span 
                        className="text-xs px-2 py-1 rounded text-white"
                        style={{ backgroundColor: SHIPLEY_PHASES[opp.shipleyPhase]?.color }}
                      >
                        {SHIPLEY_PHASES[opp.shipleyPhase]?.name || opp.shipleyPhase}
                      </span>
                    </td>
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <div className="w-16 h-2 bg-slate-700 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-cyan-500 rounded-full"
                            style={{ width: `${opp.winProbability || 0}%` }}
                          />
                        </div>
                        <span className="text-xs text-cyan-400">{opp.winProbability || 0}%</span>
                      </div>
                    </td>
                    <td className="px-4 py-3">
                      <span className={`text-sm ${opp.daysRemaining <= 7 ? 'text-red-400' : 'text-slate-300'}`}>
                        {formatDate(opp.dueDate)}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // ============================================================
    // OPPORTUNITY DRAWER
    // ============================================================
    
    const OpportunityDrawer = ({ opportunity, isOpen, onClose, onSave, onDelete }) => {
      const [activeTab, setActiveTab] = useState('details');
      const [formData, setFormData] = useState(opportunity || {});
      const [saving, setSaving] = useState(false);
      const [commentCount, setCommentCount] = useState(0);
      const [assignmentsExpanded, setAssignmentsExpanded] = useState(true);
      const { addToast } = useToast();

      useEffect(() => {
        if (opportunity) {
          setFormData(opportunity);
          setActiveTab('details');
        }
      }, [opportunity]);

      const handleSave = async () => {
        setSaving(true);
        try {
          await onSave(formData);
          addToast('Opportunity updated', 'success');
        } catch (err) {
          addToast('Failed to save', 'error');
        } finally {
          setSaving(false);
        }
      };

      const handleDelete = async () => {
        if (!confirm('Delete this opportunity? This cannot be undone.')) return;
        try {
          await onDelete(opportunity.id);
          onClose();
          addToast('Opportunity deleted', 'success');
        } catch (err) {
          addToast('Failed to delete', 'error');
        }
      };

      if (!isOpen || !opportunity) return null;

      const tabs = [
        { id: 'details', label: 'Details', icon: 'edit' },
        { id: 'comments', label: 'Comments', icon: 'message', count: commentCount },
        { id: 'activity', label: 'Activity', icon: 'activity' },
        { id: 'timeline', label: 'Timeline', icon: 'clock' }
      ];

      return (
        <div className="fixed inset-0 z-50 flex justify-end">
          {/* Backdrop */}
          <div 
            className="absolute inset-0 bg-black/50"
            onClick={onClose}
          />

          {/* Drawer */}
          <div className="relative w-full max-w-xl bg-slate-900 border-l border-slate-700 overflow-hidden animate-slideIn">
            {/* Header */}
            <div className="p-4 border-b border-slate-700">
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1 min-w-0">
                  <h2 className="text-lg font-semibold text-white truncate">{opportunity.name}</h2>
                  <p className="text-sm text-slate-400">{opportunity.agency}</p>
                </div>
                <button 
                  onClick={onClose}
                  className="p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white"
                >
                  <Icon name="x" className="w-5 h-5" />
                </button>
              </div>

              {/* Quick Stats */}
              <div className="flex gap-4 mt-4">
                <div className="flex-1 p-2 bg-slate-800 rounded-lg">
                  <p className="text-xs text-slate-500">Value</p>
                  <p className="text-sm font-semibold text-white">{formatCurrency(opportunity.contractValue)}</p>
                </div>
                <div className="flex-1 p-2 bg-slate-800 rounded-lg">
                  <p className="text-xs text-slate-500">Win Prob</p>
                  <p className="text-sm font-semibold text-cyan-400">{opportunity.winProbability || 0}%</p>
                </div>
                <div className="flex-1 p-2 bg-slate-800 rounded-lg">
                  <p className="text-xs text-slate-500">Days Left</p>
                  <p className={`text-sm font-semibold ${opportunity.daysRemaining <= 7 ? 'text-red-400' : 'text-white'}`}>
                    {opportunity.daysRemaining ?? 'N/A'}
                  </p>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex border-b border-slate-700">
              {tabs.map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`flex-1 px-4 py-3 text-sm font-medium flex items-center justify-center gap-2 border-b-2 transition-colors ${
                    activeTab === tab.id 
                      ? 'border-cyan-500 text-cyan-400' 
                      : 'border-transparent text-slate-400 hover:text-white'
                  }`}
                >
                  <Icon name={tab.icon} className="w-4 h-4" />
                  {tab.label}
                  {tab.count > 0 && (
                    <span className="text-xs bg-cyan-500/20 text-cyan-400 px-1.5 py-0.5 rounded-full">
                      {tab.count}
                    </span>
                  )}
                </button>
              ))}
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-4" style={{ height: 'calc(100vh - 280px)' }}>
              {activeTab === 'details' && (
                <div className="space-y-4">
                  {/* Assignments Section */}
                  <AssignmentsSection 
                    opportunityId={opportunity.id}
                    expanded={assignmentsExpanded}
                    onToggle={() => setAssignmentsExpanded(!assignmentsExpanded)}
                  />

                  {/* Form Fields */}
                  <div className="space-y-4 pt-4">
                    <div>
                      <label className="block text-xs font-medium text-slate-400 mb-1">Name</label>
                      <input
                        type="text"
                        value={formData.name || ''}
                        onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs font-medium text-slate-400 mb-1">Priority</label>
                        <select
                          value={formData.priority || 'P-2'}
                          onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value }))}
                          className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                        >
                          {Object.entries(PRIORITIES).map(([key, val]) => (
                            <option key={key} value={key}>{val.name}</option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-slate-400 mb-1">Phase</label>
                        <select
                          value={formData.shipleyPhase || 'gate_1'}
                          onChange={(e) => setFormData(prev => ({ ...prev, shipleyPhase: e.target.value }))}
                          className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                        >
                          {Object.entries(SHIPLEY_PHASES).map(([key, val]) => (
                            <option key={key} value={key}>{val.name}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs font-medium text-slate-400 mb-1">Contract Value ($)</label>
                        <input
                          type="number"
                          value={formData.contractValue || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, contractValue: parseInt(e.target.value) || 0 }))}
                          className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-medium text-slate-400 mb-1">Win Probability (%)</label>
                        <input
                          type="number"
                          min="0"
                          max="100"
                          value={formData.winProbability || ''}
                          onChange={(e) => setFormData(prev => ({ ...prev, winProbability: parseInt(e.target.value) || 0 }))}
                          className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-400 mb-1">Due Date</label>
                      <input
                        type="date"
                        value={formData.dueDate || ''}
                        onChange={(e) => setFormData(prev => ({ ...prev, dueDate: e.target.value }))}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-slate-400 mb-1">Description</label>
                      <textarea
                        value={formData.description || ''}
                        onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                        rows={4}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white resize-none focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                      />
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'comments' && (
                <CommentsTab 
                  opportunityId={opportunity.id}
                  onCountChange={setCommentCount}
                />
              )}

              {activeTab === 'activity' && (
                <div className="space-y-3">
                  <p className="text-sm text-slate-500">Activity log coming from database...</p>
                  {/* Activity items would be fetched from activity_log table */}
                </div>
              )}

              {activeTab === 'timeline' && (
                <div className="space-y-4">
                  {/* Phase Stepper */}
                  <div className="relative">
                    {Object.entries(SHIPLEY_PHASES).map(([key, phase], index) => {
                      const isCurrent = key === opportunity.shipleyPhase;
                      const isPast = phase.order < (SHIPLEY_PHASES[opportunity.shipleyPhase]?.order || 1);
                      const isFuture = phase.order > (SHIPLEY_PHASES[opportunity.shipleyPhase]?.order || 1);

                      return (
                        <div key={key} className="flex items-center gap-3 mb-4 last:mb-0">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                            isCurrent ? 'bg-cyan-500' : isPast ? 'bg-green-500' : 'bg-slate-700'
                          }`}>
                            {isPast ? (
                              <Icon name="check" className="w-4 h-4 text-white" />
                            ) : (
                              <span className="text-xs text-white font-medium">{index + 1}</span>
                            )}
                          </div>
                          <div className={`flex-1 ${isFuture ? 'opacity-50' : ''}`}>
                            <p className="text-sm font-medium text-white">{phase.name}</p>
                            {isCurrent && (
                              <p className="text-xs text-cyan-400">Current Phase</p>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="absolute bottom-0 left-0 right-0 p-4 bg-slate-900 border-t border-slate-700 flex gap-3">
              <button
                onClick={handleDelete}
                className="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 flex items-center gap-2"
              >
                <Icon name="trash" className="w-4 h-4" />
                Delete
              </button>
              <div className="flex-1" />
              <button
                onClick={onClose}
                className="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600"
              >
                Cancel
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 disabled:opacity-50 flex items-center gap-2"
              >
                {saving && <Icon name="loader" className="w-4 h-4" />}
                Save Changes
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // MAIN APPLICATION
    // ============================================================
    
    const App = () => {
      const [opportunities, setOpportunities] = useState([]);
      const [activities, setActivities] = useState([]);
      const [loading, setLoading] = useState(true);
      const [view, setView] = useState('board'); // board, table, calendar, analytics, timeline, dashboard
      const [theme, setTheme] = useState(() => localStorage.getItem('MP_THEME') || 'dark');
      const [selectedOpportunity, setSelectedOpportunity] = useState(null);
      const [drawerOpen, setDrawerOpen] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [sortConfig, setSortConfig] = useState({ key: null, direction: null });

      // Apply theme
      useEffect(() => {
        document.body.className = theme === 'light' ? 'light-mode' : '';
        localStorage.setItem('MP_THEME', theme);
      }, [theme]);

      // Fetch opportunities
      const fetchOpportunities = useCallback(async () => {
        try {
          const { data, error } = await supabase
            .from('opportunities')
            .select('*')
            .order('due_date', { ascending: true });

          if (error) throw error;
          setOpportunities((data || []).map(mapToFrontend));
        } catch (err) {
          console.error('Error fetching opportunities:', err);
        } finally {
          setLoading(false);
        }
      }, []);

      // Fetch activities
      const fetchActivities = useCallback(async () => {
        try {
          const { data, error } = await supabase
            .from('activity_log')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

          if (error) throw error;
          setActivities(data || []);
        } catch (err) {
          console.error('Error fetching activities:', err);
        }
      }, []);

      useEffect(() => {
        fetchOpportunities();
        fetchActivities();

        // Real-time subscription
        const channel = supabase
          .channel('opportunities-changes')
          .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'opportunities' },
            () => fetchOpportunities()
          )
          .subscribe();

        return () => {
          supabase.removeChannel(channel);
        };
      }, [fetchOpportunities, fetchActivities]);

      // Update opportunity
      const handleUpdateOpportunity = async (id, updates) => {
        // Optimistic update
        setOpportunities(prev => prev.map(o => 
          o.id === id ? { ...o, ...updates } : o
        ));

        try {
          const { error } = await supabase
            .from('opportunities')
            .update(mapToDatabase(updates))
            .eq('id', id);

          if (error) throw error;
        } catch (err) {
          console.error('Error updating opportunity:', err);
          fetchOpportunities(); // Rollback
        }
      };

      // Delete opportunity
      const handleDeleteOpportunity = async (id) => {
        setOpportunities(prev => prev.filter(o => o.id !== id));

        try {
          const { error } = await supabase
            .from('opportunities')
            .delete()
            .eq('id', id);

          if (error) throw error;
        } catch (err) {
          console.error('Error deleting opportunity:', err);
          fetchOpportunities();
        }
      };

      // Save opportunity from drawer
      const handleSaveOpportunity = async (data) => {
        await handleUpdateOpportunity(data.id, data);
      };

      // Open drawer
      const handleSelectOpportunity = (opp) => {
        setSelectedOpportunity(opp);
        setDrawerOpen(true);
      };

      // Sort handler
      const handleSort = (key) => {
        setSortConfig(prev => ({
          key,
          direction: prev.key === key 
            ? prev.direction === 'asc' ? 'desc' : prev.direction === 'desc' ? null : 'asc'
            : 'asc'
        }));
      };

      // Filter and sort opportunities
      const filteredOpportunities = useMemo(() => {
        let result = opportunities;

        // Search filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          result = result.filter(o => 
            o.name?.toLowerCase().includes(query) ||
            o.agency?.toLowerCase().includes(query) ||
            o.solicitationNumber?.toLowerCase().includes(query)
          );
        }

        // Sort
        if (sortConfig.key && sortConfig.direction) {
          result = [...result].sort((a, b) => {
            let aVal = a[sortConfig.key];
            let bVal = b[sortConfig.key];

            if (typeof aVal === 'string') {
              aVal = aVal.toLowerCase();
              bVal = bVal?.toLowerCase() || '';
            }

            if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
          });
        }

        return result;
      }, [opportunities, searchQuery, sortConfig]);

      const views = [
        { id: 'board', label: 'Board', icon: 'kanban' },
        { id: 'table', label: 'Table', icon: 'table' },
        { id: 'timeline', label: 'Timeline', icon: 'gantt' },
        { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' }
      ];

      // Pipeline stats
      const stats = useMemo(() => ({
        total: opportunities.length,
        totalValue: opportunities.reduce((sum, o) => sum + (o.contractValue || 0), 0),
        avgPwin: opportunities.length 
          ? Math.round(opportunities.reduce((sum, o) => sum + (o.winProbability || 0), 0) / opportunities.length)
          : 0
      }), [opportunities]);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center" style={{ background: 'var(--bg-primary)' }}>
            <div className="text-center">
              <Icon name="loader" className="w-8 h-8 text-cyan-500 mx-auto mb-4" />
              <p className="text-slate-400">Loading MissionPulse...</p>
            </div>
          </div>
        );
      }

      return (
        <ToastProvider>
          <div className="min-h-screen" style={{ background: 'var(--bg-primary)' }}>
            {/* Header */}
            <header className="border-b" style={{ borderColor: 'var(--border-color)' }}>
              <div className="max-w-[1800px] mx-auto px-6 py-4">
                <div className="flex items-center justify-between">
                  {/* Logo & Title */}
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center">
                        <Icon name="shield" className="w-6 h-6 text-white" />
                      </div>
                      <div>
                        <h1 className="text-lg font-bold" style={{ color: 'var(--text-primary)' }}>MissionPulse</h1>
                        <p className="text-xs" style={{ color: 'var(--text-muted)' }}>Pipeline Command Center</p>
                      </div>
                    </div>

                    {/* Stats Pills */}
                    <div className="flex items-center gap-3 ml-6 pl-6 border-l" style={{ borderColor: 'var(--border-color)' }}>
                      <div className="px-3 py-1 rounded-full" style={{ background: 'var(--accent-cyan-dim)' }}>
                        <span className="text-xs text-cyan-400 font-medium">{stats.total} Opportunities</span>
                      </div>
                      <div className="px-3 py-1 rounded-full" style={{ background: 'var(--accent-cyan-dim)' }}>
                        <span className="text-xs text-cyan-400 font-medium">{formatCurrency(stats.totalValue)} Pipeline</span>
                      </div>
                      <div className="px-3 py-1 rounded-full" style={{ background: 'var(--accent-cyan-dim)' }}>
                        <span className="text-xs text-cyan-400 font-medium">{stats.avgPwin}% Avg pWin</span>
                      </div>
                    </div>
                  </div>

                  {/* Search & Actions */}
                  <div className="flex items-center gap-4">
                    {/* Search */}
                    <div className="relative">
                      <Icon name="search" className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Search opportunities..."
                        className="w-64 pl-9 pr-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
                        style={{ 
                          background: 'var(--bg-card)', 
                          border: '1px solid var(--border-color)',
                          color: 'var(--text-primary)'
                        }}
                      />
                    </div>

                    {/* Theme Toggle */}
                    <button
                      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
                      className="p-2 rounded-lg hover:bg-slate-800"
                      style={{ color: 'var(--text-secondary)' }}
                    >
                      <Icon name={theme === 'dark' ? 'sun' : 'moon'} className="w-5 h-5" />
                    </button>

                    {/* Add New */}
                    <button className="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 flex items-center gap-2 text-sm font-medium">
                      <Icon name="plus" className="w-4 h-4" />
                      New Opportunity
                    </button>
                  </div>
                </div>
              </div>
            </header>

            {/* Main Content */}
            <main className="max-w-[1800px] mx-auto px-6 py-6">
              {/* View Toggle */}
              <div className="flex items-center justify-between mb-6">
                <div className="flex items-center gap-1 p-1 rounded-lg" style={{ background: 'var(--bg-card)' }}>
                  {views.map(v => (
                    <button
                      key={v.id}
                      onClick={() => setView(v.id)}
                      className={`px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-colors ${
                        view === v.id 
                          ? 'bg-cyan-500 text-white' 
                          : 'text-slate-400 hover:text-white'
                      }`}
                    >
                      <Icon name={v.icon} className="w-4 h-4" />
                      {v.label}
                    </button>
                  ))}
                </div>

                <div className="flex items-center gap-2">
                  <button 
                    onClick={fetchOpportunities}
                    className="p-2 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white"
                    title="Refresh"
                  >
                    <Icon name="refresh" className="w-5 h-5" />
                  </button>
                </div>
              </div>

              {/* Views */}
              <div className="h-[calc(100vh-200px)]">
                {view === 'board' && (
                  <BoardView
                    opportunities={filteredOpportunities}
                    onSelectOpportunity={handleSelectOpportunity}
                    onUpdateOpportunity={handleUpdateOpportunity}
                  />
                )}

                {view === 'table' && (
                  <TableView
                    opportunities={filteredOpportunities}
                    onSelectOpportunity={handleSelectOpportunity}
                    sortConfig={sortConfig}
                    onSort={handleSort}
                  />
                )}

                {view === 'timeline' && (
                  <GanttTimelineView
                    opportunities={filteredOpportunities}
                    onSelectOpportunity={handleSelectOpportunity}
                  />
                )}

                {view === 'dashboard' && (
                  <DashboardView
                    opportunities={filteredOpportunities}
                    activities={activities}
                  />
                )}
              </div>
            </main>

            {/* Opportunity Drawer */}
            <OpportunityDrawer
              opportunity={selectedOpportunity}
              isOpen={drawerOpen}
              onClose={() => setDrawerOpen(false)}
              onSave={handleSaveOpportunity}
              onDelete={handleDeleteOpportunity}
            />

            {/* Footer */}
            <footer className="fixed bottom-0 left-0 right-0 py-2 text-center text-xs border-t" style={{ background: 'var(--bg-primary)', borderColor: 'var(--border-color)', color: 'var(--text-muted)' }}>
              AI GENERATED - REQUIRES HUMAN REVIEW | MissionPulse v12.14 Sprint 14 |  2026 Mission Meets Tech
            </footer>
          </div>
        </ToastProvider>
      );
    };

    // Render the application
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
