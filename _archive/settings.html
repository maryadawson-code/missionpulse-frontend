<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse | Settings</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--deep-navy); min-height: 100vh; color: #e2e8f0; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a1628; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(0, 229, 250, 0.12); border-radius: 12px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="supabase-client.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    const supabase = window.supabase;

    // Icons
    const Icon = ({ name, className = 'w-5 h-5' }) => {
      const icons = {
        user: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        lock: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>,
        bell: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
        building: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
        arrowLeft: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
        save: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
        check: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        x: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        loader: <svg className={`${className} animate-spin`} fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      };
      return icons[name] || null;
    };

    // Components
    const Card = ({ children, className = '', title, icon }) => (
      <div className={`glass-panel p-6 ${className}`}>
        {title && (
          <div className="flex items-center gap-2 mb-5 pb-4 border-b border-slate-700/50">
            {icon && <Icon name={icon} className="w-5 h-5 text-cyan-400" />}
            <h3 className="font-semibold text-white text-lg">{title}</h3>
          </div>
        )}
        {children}
      </div>
    );

    const Input = ({ label, type = 'text', value, onChange, placeholder, disabled, ...props }) => (
      <div>
        {label && <label className="block text-sm font-medium text-slate-300 mb-2">{label}</label>}
        <input
          type={type}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placeholder}
          disabled={disabled}
          className={`w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder:text-slate-500 focus:outline-none focus:border-cyan-500 transition-colors ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
          {...props}
        />
      </div>
    );

    const Toggle = ({ label, description, checked, onChange }) => (
      <label className="flex items-start gap-4 cursor-pointer">
        <div className="relative mt-0.5">
          <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)} className="sr-only" />
          <div className={`w-11 h-6 rounded-full transition-colors ${checked ? 'bg-cyan-500' : 'bg-slate-700'}`}></div>
          <div className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform ${checked ? 'translate-x-5' : ''}`}></div>
        </div>
        <div className="flex-1">
          <div className="text-sm font-medium text-white">{label}</div>
          {description && <div className="text-xs text-slate-400 mt-0.5">{description}</div>}
        </div>
      </label>
    );

    const Button = ({ children, onClick, type = 'button', variant = 'primary', icon, disabled, loading, className = '' }) => {
      const variants = {
        primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white hover:from-cyan-400 hover:to-teal-400',
        secondary: 'bg-slate-700 text-slate-200 hover:bg-slate-600 border border-slate-600',
        danger: 'bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30'
      };
      return (
        <button 
          type={type}
          onClick={onClick} 
          disabled={disabled || loading}
          className={`inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-semibold text-sm transition-all ${variants[variant]} ${disabled || loading ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
        >
          {loading ? <Icon name="loader" className="w-4 h-4" /> : icon && <Icon name={icon} className="w-4 h-4" />}
          {children}
        </button>
      );
    };

    const Avatar = ({ name, size = 'lg' }) => {
      const initials = name?.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '?';
      const sizes = { md: 'w-12 h-12 text-lg', lg: 'w-20 h-20 text-2xl', xl: 'w-28 h-28 text-3xl' };
      return (
        <div className={`${sizes[size]} rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold`}>
          {initials}
        </div>
      );
    };

    // Tab Navigation
    const TabNav = ({ tabs, activeTab, onChange }) => (
      <div className="flex gap-1 p-1 bg-slate-800/50 rounded-lg mb-6">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => onChange(tab.id)}
            className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${
              activeTab === tab.id 
                ? 'bg-cyan-500/20 text-cyan-400' 
                : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
            }`}
          >
            <Icon name={tab.icon} className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>
    );

    // Main Settings Page
    function SettingsPage() {
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [activeTab, setActiveTab] = useState('profile');
      const [toast, setToast] = useState(null);
      
      const [user, setUser] = useState(null);
      const [company, setCompany] = useState(null);
      
      // Form states
      const [profile, setProfile] = useState({ full_name: '', email: '', phone: '', title: '' });
      const [password, setPassword] = useState({ current: '', new: '', confirm: '' });
      const [notifications, setNotifications] = useState({
        email_deadlines: true,
        email_assignments: true,
        email_mentions: false,
        push_enabled: true
      });

      const tabs = [
        { id: 'profile', label: 'Profile', icon: 'user' },
        { id: 'security', label: 'Security', icon: 'lock' },
        { id: 'notifications', label: 'Notifications', icon: 'bell' },
        { id: 'company', label: 'Company', icon: 'building' }
      ];

      useEffect(() => {
        loadUserData();
      }, []);

      const loadUserData = async () => {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) {
            window.location.href = '/login.html';
            return;
          }

          const { data: userData } = await supabase
            .from('users')
            .select('*, companies(*)')
            .eq('id', session.user.id)
            .single();

          if (userData) {
            setUser(userData);
            setCompany(userData.companies);
            setProfile({
              full_name: userData.full_name || '',
              email: userData.email || '',
              phone: userData.phone || '',
              title: userData.title || ''
            });
            if (userData.preferences) {
              setNotifications(prev => ({ ...prev, ...userData.preferences.notifications }));
            }
          }
        } catch (err) {
          console.error('Error loading user:', err);
          showToast('Failed to load profile', 'error');
        } finally {
          setLoading(false);
        }
      };

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 4000);
      };

      const handleSaveProfile = async () => {
        setSaving(true);
        try {
          const { error } = await supabase
            .from('users')
            .update({
              full_name: profile.full_name,
              phone: profile.phone,
              title: profile.title
            })
            .eq('id', user.id);

          if (error) throw error;
          showToast('Profile saved successfully!');
        } catch (err) {
          showToast(err.message || 'Failed to save profile', 'error');
        } finally {
          setSaving(false);
        }
      };

      const handleChangePassword = async () => {
        if (password.new !== password.confirm) {
          showToast('Passwords do not match', 'error');
          return;
        }
        if (password.new.length < 8) {
          showToast('Password must be at least 8 characters', 'error');
          return;
        }

        setSaving(true);
        try {
          const { error } = await supabase.auth.updateUser({
            password: password.new
          });
          if (error) throw error;
          
          setPassword({ current: '', new: '', confirm: '' });
          showToast('Password changed successfully!');
        } catch (err) {
          showToast(err.message || 'Failed to change password', 'error');
        } finally {
          setSaving(false);
        }
      };

      const handleSaveNotifications = async () => {
        setSaving(true);
        try {
          const { error } = await supabase
            .from('users')
            .update({
              preferences: { ...user.preferences, notifications }
            })
            .eq('id', user.id);

          if (error) throw error;
          showToast('Notification preferences saved!');
        } catch (err) {
          showToast(err.message || 'Failed to save preferences', 'error');
        } finally {
          setSaving(false);
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        window.location.href = '/login.html';
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-[#00050F] flex items-center justify-center">
            <Icon name="loader" className="w-10 h-10 text-cyan-400" />
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-[#00050F] pb-20">
          {/* Header */}
          <header className="bg-slate-900/80 border-b border-slate-700/50 px-6 py-4 sticky top-0 z-40 backdrop-blur-sm">
            <div className="max-w-4xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-4">
                <a href="/index.html" className="text-slate-400 hover:text-white transition-colors">
                  <Icon name="arrowLeft" className="w-5 h-5" />
                </a>
                <h1 className="text-xl font-bold text-white">Settings</h1>
              </div>
              <Button variant="danger" icon="logout" onClick={handleLogout}>
                Sign Out
              </Button>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-6 py-8">
            {/* Tab Navigation */}
            <TabNav tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />

            {/* Profile Tab */}
            {activeTab === 'profile' && (
              <div className="animate-fadeIn space-y-6">
                <Card>
                  <div className="flex flex-col sm:flex-row items-center gap-6 mb-6">
                    <Avatar name={profile.full_name} size="xl" />
                    <div className="text-center sm:text-left">
                      <h2 className="text-xl font-bold text-white">{profile.full_name}</h2>
                      <p className="text-slate-400">{user?.role} • {company?.name}</p>
                      <p className="text-sm text-slate-500 mt-1">{profile.email}</p>
                    </div>
                  </div>
                </Card>

                <Card title="Profile Information" icon="user">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input
                      label="Full Name"
                      value={profile.full_name}
                      onChange={(v) => setProfile(p => ({ ...p, full_name: v }))}
                      placeholder="Your full name"
                    />
                    <Input
                      label="Email"
                      type="email"
                      value={profile.email}
                      onChange={() => {}}
                      disabled
                    />
                    <Input
                      label="Phone"
                      type="tel"
                      value={profile.phone}
                      onChange={(v) => setProfile(p => ({ ...p, phone: v }))}
                      placeholder="(555) 123-4567"
                    />
                    <Input
                      label="Title"
                      value={profile.title}
                      onChange={(v) => setProfile(p => ({ ...p, title: v }))}
                      placeholder="e.g., Capture Manager"
                    />
                  </div>
                  <div className="mt-6 flex justify-end">
                    <Button icon="save" onClick={handleSaveProfile} loading={saving}>
                      Save Changes
                    </Button>
                  </div>
                </Card>
              </div>
            )}

            {/* Security Tab */}
            {activeTab === 'security' && (
              <div className="animate-fadeIn">
                <Card title="Change Password" icon="lock">
                  <div className="space-y-4 max-w-md">
                    <Input
                      label="Current Password"
                      type="password"
                      value={password.current}
                      onChange={(v) => setPassword(p => ({ ...p, current: v }))}
                      placeholder="••••••••"
                    />
                    <Input
                      label="New Password"
                      type="password"
                      value={password.new}
                      onChange={(v) => setPassword(p => ({ ...p, new: v }))}
                      placeholder="Min 8 characters"
                    />
                    <Input
                      label="Confirm New Password"
                      type="password"
                      value={password.confirm}
                      onChange={(v) => setPassword(p => ({ ...p, confirm: v }))}
                      placeholder="Re-enter new password"
                    />
                  </div>
                  <div className="mt-6">
                    <Button icon="lock" onClick={handleChangePassword} loading={saving}>
                      Update Password
                    </Button>
                  </div>
                </Card>
              </div>
            )}

            {/* Notifications Tab */}
            {activeTab === 'notifications' && (
              <div className="animate-fadeIn">
                <Card title="Email Notifications" icon="bell">
                  <div className="space-y-5">
                    <Toggle
                      label="Deadline Reminders"
                      description="Get notified 7, 3, and 1 days before submission deadlines"
                      checked={notifications.email_deadlines}
                      onChange={(v) => setNotifications(n => ({ ...n, email_deadlines: v }))}
                    />
                    <Toggle
                      label="New Assignments"
                      description="Get notified when you're assigned to an opportunity or section"
                      checked={notifications.email_assignments}
                      onChange={(v) => setNotifications(n => ({ ...n, email_assignments: v }))}
                    />
                    <Toggle
                      label="Mentions"
                      description="Get notified when someone @mentions you in comments"
                      checked={notifications.email_mentions}
                      onChange={(v) => setNotifications(n => ({ ...n, email_mentions: v }))}
                    />
                  </div>
                  <div className="mt-6 pt-6 border-t border-slate-700/50">
                    <Toggle
                      label="Push Notifications"
                      description="Receive push notifications in browser (requires permission)"
                      checked={notifications.push_enabled}
                      onChange={(v) => setNotifications(n => ({ ...n, push_enabled: v }))}
                    />
                  </div>
                  <div className="mt-6 flex justify-end">
                    <Button icon="save" onClick={handleSaveNotifications} loading={saving}>
                      Save Preferences
                    </Button>
                  </div>
                </Card>
              </div>
            )}

            {/* Company Tab */}
            {activeTab === 'company' && (
              <div className="animate-fadeIn">
                <Card title="Company Information" icon="building">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <Input label="Company Name" value={company?.name || ''} onChange={() => {}} disabled />
                    <Input label="Domain" value={company?.domain || ''} onChange={() => {}} disabled />
                    <Input label="CAGE Code" value={company?.cage_code || 'Not set'} onChange={() => {}} disabled />
                    <Input label="DUNS Number" value={company?.duns_number || 'Not set'} onChange={() => {}} disabled />
                  </div>
                  
                  {company?.set_aside_status?.length > 0 && (
                    <div className="mt-6">
                      <label className="block text-sm font-medium text-slate-300 mb-2">Set-Aside Status</label>
                      <div className="flex flex-wrap gap-2">
                        {company.set_aside_status.map(status => (
                          <span key={status} className="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded-full text-sm">
                            {status}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  <div className="mt-6 p-4 bg-slate-800/50 rounded-lg">
                    <p className="text-sm text-slate-400">
                      Company settings can only be modified by administrators. 
                      {user?.role === 'Admin' || user?.role === 'CEO' ? (
                        <a href="/admin-users.html" className="text-cyan-400 hover:text-cyan-300 ml-1">
                          Go to Admin Panel →
                        </a>
                      ) : (
                        ' Contact your admin to make changes.'
                      )}
                    </p>
                  </div>
                </Card>
              </div>
            )}
          </main>

          {/* Footer */}
          <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 border-t border-slate-700/50 backdrop-blur-sm z-30">
            <div className="max-w-4xl mx-auto px-6 py-2 flex items-center justify-between">
              <span className="text-xs text-slate-500">MissionPulse v12.0</span>
              <span className="text-xs text-slate-500">© 2026 Mission Meets Tech</span>
            </div>
          </footer>

          {/* Toast */}
          {toast && (
            <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg border shadow-lg backdrop-blur-sm animate-fadeIn ${
              toast.type === 'error' 
                ? 'bg-red-500/20 border-red-500/30 text-red-400' 
                : 'bg-emerald-500/20 border-emerald-500/30 text-emerald-400'
            }`}>
              <div className="flex items-center gap-2">
                <Icon name={toast.type === 'error' ? 'x' : 'check'} className="w-5 h-5" />
                {toast.message}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<SettingsPage />);
  </script>
</body>
</html>
