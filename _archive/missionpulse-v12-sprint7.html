<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 - Sprint 7.2 | Shipley Pipeline Board</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'pulse-cyan': '#00E5FA',
            'shield-navy': '#00050F',
            'shield-dark': '#0a0f1a',
            'shield-panel': '#0d1526',
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-shimmer { 
      background: linear-gradient(90deg, transparent, rgba(0,229,250,0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    .animate-slideIn { animation: slideIn 0.3s ease-out; }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #00E5FA; }
    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }
    .row-selected { background: rgba(0, 229, 250, 0.1) !important; }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #00E5FA;
      cursor: pointer;
      border: 2px solid #0a0f1a;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback, createContext, useContext } = React;

    // ============================================================
    // ICONS
    // ============================================================
    const Icons = {
      grip: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" /></svg>,
      chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
      chevronDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2" /></svg>,
      users: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      target: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      dollar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      alert: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      arrowRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
      plus: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      edit: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      trash: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      search: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      filter: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
      refresh: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      table: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      board: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>,
      calendar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
      checkCircle: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      xCircle: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      info: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      wifi: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>,
      wifiOff: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" /></svg>,
      sortAsc: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>,
      sortDesc: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4" /></svg>,
      activity: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      checkSquare: () => <svg className="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>,
      square: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" strokeWidth={2}/></svg>,
      minusSquare: () => <svg className="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2z"/></svg>,
    };

    const Icon = ({ name, className = "w-4 h-4" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // ============================================================
    // TOAST SYSTEM
    // ============================================================
    const ToastContext = createContext(null);

    const ToastProvider = ({ children }) => {
      const [toasts, setToasts] = useState([]);

      const addToast = useCallback((message, type = 'info', duration = 4000) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, duration);
      }, []);

      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);

      return (
        <ToastContext.Provider value={{ addToast }}>
          {children}
          <div className="fixed bottom-20 right-4 z-50 flex flex-col gap-2">
            {toasts.map(toast => (
              <div
                key={toast.id}
                className={`animate-slideUp flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg border ${
                  toast.type === 'success' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100' :
                  toast.type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-100' :
                  toast.type === 'warning' ? 'bg-amber-900/90 border-amber-500/30 text-amber-100' :
                  'bg-slate-800/90 border-slate-600/30 text-slate-100'
                }`}
              >
                <Icon 
                  name={toast.type === 'success' ? 'checkCircle' : toast.type === 'error' ? 'xCircle' : 'info'} 
                  className="w-5 h-5" 
                />
                <span className="text-sm font-medium">{toast.message}</span>
                <button onClick={() => removeToast(toast.id)} className="ml-2 opacity-60 hover:opacity-100">
                  <Icon name="x" className="w-4 h-4" />
                </button>
              </div>
            ))}
          </div>
        </ToastContext.Provider>
      );
    };

    const useToast = () => {
      const context = useContext(ToastContext);
      if (!context) throw new Error('useToast must be used within ToastProvider');
      return context;
    };

    // ============================================================
    // CONNECTION STATUS
    // ============================================================
    const ConnectionStatus = ({ status }) => (
      <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${
        status === 'connected' 
          ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' 
          : 'bg-red-500/20 text-red-400 border border-red-500/30'
      }`}>
        <Icon name={status === 'connected' ? 'wifi' : 'wifiOff'} className="w-3 h-3" />
        <span>{status === 'connected' ? 'Live' : 'Disconnected'}</span>
      </div>
    );

    // ============================================================
    // LOADING STATES
    // ============================================================
    const SkeletonCard = () => (
      <div className="bg-slate-800/50 rounded-lg p-3 animate-pulse">
        <div className="h-4 bg-slate-700 rounded w-3/4 mb-2"></div>
        <div className="h-3 bg-slate-700 rounded w-1/2 mb-3"></div>
        <div className="flex gap-2">
          <div className="h-5 bg-slate-700 rounded w-16"></div>
          <div className="h-5 bg-slate-700 rounded w-12"></div>
        </div>
      </div>
    );

    const LoadingState = () => (
      <div className="flex flex-col items-center justify-center h-64 gap-4">
        <div className="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"></div>
        <p className="text-slate-400">Loading opportunities...</p>
      </div>
    );

    const ErrorState = ({ message, onRetry }) => (
      <div className="flex flex-col items-center justify-center h-64 gap-4">
        <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
          <Icon name="xCircle" className="w-8 h-8 text-red-400" />
        </div>
        <p className="text-red-400 text-center">{message}</p>
        {onRetry && (
          <button 
            onClick={onRetry}
            className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm flex items-center gap-2"
          >
            <Icon name="refresh" className="w-4 h-4" />
            Retry
          </button>
        )}
      </div>
    );

    // ============================================================
    // BUTTON COMPONENT
    // ============================================================
    const Button = ({ 
      children, 
      variant = 'primary', 
      size = 'md', 
      disabled = false, 
      loading = false,
      onClick,
      className = '',
      ...props 
    }) => {
      const variants = {
        primary: 'bg-cyan-500 hover:bg-cyan-400 text-white shadow-lg shadow-cyan-500/30',
        secondary: 'bg-slate-700 hover:bg-slate-600 text-white',
        danger: 'bg-red-600 hover:bg-red-500 text-white',
        ghost: 'bg-transparent hover:bg-slate-700/50 text-slate-300',
      };

      const sizes = {
        sm: 'px-3 py-1.5 text-xs',
        md: 'px-4 py-2 text-sm',
        lg: 'px-6 py-3 text-base',
      };

      return (
        <button
          onClick={onClick}
          disabled={disabled || loading}
          className={`
            font-semibold rounded-lg transition-all flex items-center gap-2 justify-center
            ${variants[variant]}
            ${sizes[size]}
            ${disabled || loading ? 'opacity-50 cursor-not-allowed' : ''}
            ${className}
          `}
          {...props}
        >
          {loading && <Icon name="refresh" className="w-4 h-4 animate-spin" />}
          {children}
        </button>
      );
    };

    // ============================================================
    // MODAL COMPONENT
    // ============================================================
    const Modal = ({ isOpen, onClose, title, size = 'md', children }) => {
      if (!isOpen) return null;

      const sizes = {
        sm: 'max-w-sm',
        md: 'max-w-md',
        lg: 'max-w-lg',
        xl: 'max-w-xl',
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center animate-fadeIn">
          <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
          <div className={`relative bg-slate-800 rounded-xl border border-slate-700 shadow-2xl w-full mx-4 ${sizes[size]}`}>
            <div className="flex items-center justify-between p-4 border-b border-slate-700">
              <h2 className="text-lg font-semibold text-white">{title}</h2>
              <button 
                onClick={onClose}
                className="p-1 hover:bg-slate-700 rounded-lg transition-colors"
              >
                <Icon name="x" className="w-5 h-5 text-slate-400" />
              </button>
            </div>
            <div className="p-4">
              {children}
            </div>
          </div>
        </div>
      );
    };

    // ============================================================
    // MULTI-SELECT DROPDOWN
    // ============================================================
    const MultiSelectDropdown = ({ label, options, selected, onChange, placeholder }) => {
      const [isOpen, setIsOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (ref.current && !ref.current.contains(e.target)) {
            setIsOpen(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      const toggleOption = (value) => {
        if (selected.includes(value)) {
          onChange(selected.filter(v => v !== value));
        } else {
          onChange([...selected, value]);
        }
      };

      return (
        <div ref={ref} className="relative">
          {label && <label className="block text-xs text-slate-400 mb-1">{label}</label>}
          <button
            type="button"
            onClick={() => setIsOpen(!isOpen)}
            className="w-full flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-left hover:border-slate-500"
          >
            <span className={selected.length ? 'text-white' : 'text-slate-400'}>
              {selected.length ? `${selected.length} selected` : placeholder || 'Select...'}
            </span>
            <Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
          </button>
          
          {isOpen && (
            <div className="absolute z-50 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl max-h-48 overflow-y-auto">
              {options.map(option => (
                <label
                  key={option.value}
                  className="flex items-center gap-2 px-3 py-2 hover:bg-slate-700 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    checked={selected.includes(option.value)}
                    onChange={() => toggleOption(option.value)}
                    className="rounded border-slate-600 text-cyan-500 focus:ring-cyan-500 bg-slate-700"
                  />
                  <span className="text-sm text-white">{option.label}</span>
                </label>
              ))}
            </div>
          )}
        </div>
      );
    };

    // ============================================================
    // SEARCH & FILTER BAR
    // ============================================================
    const SearchFilterBar = ({ filters, setFilters, agencies, phases }) => {
      const [showAdvanced, setShowAdvanced] = useState(false);

      const activeFilterCount = [
        filters.agencies.length > 0,
        filters.priorities.length > 0,
        filters.phases.length > 0,
        filters.pWinMin > 0 || filters.pWinMax < 100,
        filters.dueDateFrom || filters.dueDateTo,
      ].filter(Boolean).length;

      const clearAllFilters = () => {
        setFilters({
          search: '',
          agencies: [],
          priorities: [],
          phases: [],
          pWinMin: 0,
          pWinMax: 100,
          dueDateFrom: '',
          dueDateTo: '',
        });
      };

      return (
        <div className="bg-slate-800/50 rounded-xl border border-slate-700/50 p-4 mb-4">
          <div className="flex items-center gap-4">
            {/* Search Input */}
            <div className="flex-1 relative">
              <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <input
                type="text"
                placeholder="Search by name, agency, or solicitation..."
                value={filters.search}
                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                className="w-full pl-10 pr-4 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500"
              />
            </div>

            {/* Toggle Advanced Filters */}
            <button
              onClick={() => setShowAdvanced(!showAdvanced)}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg border transition-colors ${
                showAdvanced || activeFilterCount > 0
                  ? 'bg-cyan-500/20 border-cyan-500/50 text-cyan-400'
                  : 'bg-slate-700 border-slate-600 text-slate-300 hover:bg-slate-600'
              }`}
            >
              <Icon name="filter" className="w-4 h-4" />
              <span className="text-sm font-medium">Filters</span>
              {activeFilterCount > 0 && (
                <span className="bg-cyan-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full">
                  {activeFilterCount}
                </span>
              )}
            </button>

            {/* Clear All */}
            {(filters.search || activeFilterCount > 0) && (
              <button
                onClick={clearAllFilters}
                className="text-sm text-slate-400 hover:text-white"
              >
                Clear All
              </button>
            )}
          </div>

          {/* Advanced Filters Panel */}
          {showAdvanced && (
            <div className="mt-4 pt-4 border-t border-slate-700 grid grid-cols-2 md:grid-cols-4 gap-4">
              {/* Agency Filter */}
              <MultiSelectDropdown
                label="Agency"
                options={agencies.map(a => ({ value: a, label: a }))}
                selected={filters.agencies}
                onChange={(val) => setFilters(prev => ({ ...prev, agencies: val }))}
                placeholder="All Agencies"
              />

              {/* Priority Filter */}
              <MultiSelectDropdown
                label="Priority"
                options={[
                  { value: 'P-0', label: 'P-0 (Must Win)' },
                  { value: 'P-1', label: 'P-1 (High)' },
                  { value: 'P-2', label: 'P-2 (Medium)' },
                  { value: 'P-3', label: 'P-3 (Low)' },
                ]}
                selected={filters.priorities}
                onChange={(val) => setFilters(prev => ({ ...prev, priorities: val }))}
                placeholder="All Priorities"
              />

              {/* Phase Filter */}
              <MultiSelectDropdown
                label="Phase"
                options={phases.map(p => ({ value: p.key, label: p.name }))}
                selected={filters.phases}
                onChange={(val) => setFilters(prev => ({ ...prev, phases: val }))}
                placeholder="All Phases"
              />

              {/* pWin Range */}
              <div>
                <label className="block text-xs text-slate-400 mb-1">Win Probability</label>
                <div className="flex items-center gap-2">
                  <span className="text-xs text-slate-500">{filters.pWinMin}%</span>
                  <input
                    type="range"
                    min="0"
                    max="100"
                    value={filters.pWinMin}
                    onChange={(e) => setFilters(prev => ({ 
                      ...prev, 
                      pWinMin: Math.min(Number(e.target.value), prev.pWinMax - 5)
                    }))}
                    className="flex-1 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                  />
                  <input
                    type="range"
                    min="0"
                    max="100"
                    value={filters.pWinMax}
                    onChange={(e) => setFilters(prev => ({ 
                      ...prev, 
                      pWinMax: Math.max(Number(e.target.value), prev.pWinMin + 5)
                    }))}
                    className="flex-1 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                  />
                  <span className="text-xs text-slate-500">{filters.pWinMax}%</span>
                </div>
              </div>

              {/* Due Date Range */}
              <div>
                <label className="block text-xs text-slate-400 mb-1">Due From</label>
                <input
                  type="date"
                  value={filters.dueDateFrom}
                  onChange={(e) => setFilters(prev => ({ ...prev, dueDateFrom: e.target.value }))}
                  className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                />
              </div>

              <div>
                <label className="block text-xs text-slate-400 mb-1">Due To</label>
                <input
                  type="date"
                  value={filters.dueDateTo}
                  onChange={(e) => setFilters(prev => ({ ...prev, dueDateTo: e.target.value }))}
                  className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                />
              </div>
            </div>
          )}
        </div>
      );
    };

    // ============================================================
    // BULK ACTION BAR
    // ============================================================
    const BulkActionBar = ({ selectedCount, onPhaseChange, onDelete, phases, isProcessing }) => {
      const [showPhaseDropdown, setShowPhaseDropdown] = useState(false);
      const dropdownRef = useRef(null);

      useEffect(() => {
        const handleClickOutside = (e) => {
          if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
            setShowPhaseDropdown(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      if (selectedCount === 0) return null;

      return (
        <div className="fixed bottom-16 left-1/2 -translate-x-1/2 z-40 animate-slideUp">
          <div className="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl px-6 py-3 flex items-center gap-4">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center">
                <span className="text-cyan-400 font-bold text-sm">{selectedCount}</span>
              </div>
              <span className="text-white font-medium">selected</span>
            </div>

            <div className="w-px h-8 bg-slate-600"></div>

            {/* Phase Change Dropdown */}
            <div ref={dropdownRef} className="relative">
              <Button
                variant="secondary"
                size="sm"
                onClick={() => setShowPhaseDropdown(!showPhaseDropdown)}
                disabled={isProcessing}
              >
                <Icon name="arrowRight" className="w-4 h-4" />
                Change Phase
                <Icon name="chevronDown" className="w-3 h-3" />
              </Button>

              {showPhaseDropdown && (
                <div className="absolute bottom-full left-0 mb-2 w-48 bg-slate-800 border border-slate-600 rounded-lg shadow-xl overflow-hidden">
                  {phases.map(phase => (
                    <button
                      key={phase.key}
                      onClick={() => {
                        onPhaseChange(phase.key);
                        setShowPhaseDropdown(false);
                      }}
                      className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-700 text-left"
                    >
                      <div 
                        className="w-3 h-3 rounded-full" 
                        style={{ backgroundColor: phase.color }}
                      />
                      <span className="text-sm text-white">{phase.name}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Delete Button */}
            <Button
              variant="danger"
              size="sm"
              onClick={onDelete}
              disabled={isProcessing}
            >
              <Icon name="trash" className="w-4 h-4" />
              Delete
            </Button>
          </div>
        </div>
      );
    };

    // ============================================================
    // DELETE CONFIRM MODAL
    // ============================================================
    const DeleteConfirmModal = ({ isOpen, onClose, onConfirm, count, isLoading }) => (
      <Modal isOpen={isOpen} onClose={onClose} title="Confirm Delete" size="sm">
        <div className="text-center">
          <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
            <Icon name="trash" className="w-8 h-8 text-red-400" />
          </div>
          <p className="text-white mb-2">
            Delete {count} opportunit{count === 1 ? 'y' : 'ies'}?
          </p>
          <p className="text-slate-400 text-sm mb-6">This action cannot be undone.</p>
          <div className="flex gap-3 justify-center">
            <Button variant="secondary" onClick={onClose} disabled={isLoading}>
              Cancel
            </Button>
            <Button variant="danger" onClick={onConfirm} loading={isLoading}>
              Delete
            </Button>
          </div>
        </div>
      </Modal>
    );

    // ============================================================
    // OPPORTUNITY FORM
    // ============================================================
    const OpportunityForm = ({ opportunity, onSave, onCancel, isLoading }) => {
      const [formData, setFormData] = useState({
        name: opportunity?.name || '',
        agency: opportunity?.agency || '',
        contractValue: opportunity?.contractValue || '',
        priority: opportunity?.priority || 'P-2',
        shipleyPhase: opportunity?.shipleyPhase || 'gate_1',
        winProbability: opportunity?.winProbability || 50,
        dueDate: opportunity?.dueDate || '',
        solicitationNumber: opportunity?.solicitationNumber || '',
        description: opportunity?.description || '',
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({
          ...formData,
          contractValue: parseInt(formData.contractValue) || 0,
          winProbability: parseInt(formData.winProbability) || 0,
        });
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm text-slate-400 mb-1">Name *</label>
            <input
              type="text"
              required
              value={formData.name}
              onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
              className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              placeholder="Opportunity name"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-1">Agency</label>
              <input
                type="text"
                value={formData.agency}
                onChange={(e) => setFormData(prev => ({ ...prev, agency: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
                placeholder="e.g., DHA, VA"
              />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">Contract Value ($)</label>
              <input
                type="number"
                value={formData.contractValue}
                onChange={(e) => setFormData(prev => ({ ...prev, contractValue: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
                placeholder="100000000"
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-1">Priority</label>
              <select
                value={formData.priority}
                onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              >
                <option value="P-0">P-0 (Must Win)</option>
                <option value="P-1">P-1 (High)</option>
                <option value="P-2">P-2 (Medium)</option>
                <option value="P-3">P-3 (Low)</option>
              </select>
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">Phase</label>
              <select
                value={formData.shipleyPhase}
                onChange={(e) => setFormData(prev => ({ ...prev, shipleyPhase: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              >
                {MissionPulse.getShipleyPhases().map(phase => (
                  <option key={phase.key} value={phase.key}>{phase.name}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-1">Win Probability (%)</label>
              <input
                type="number"
                min="0"
                max="100"
                value={formData.winProbability}
                onChange={(e) => setFormData(prev => ({ ...prev, winProbability: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-1">Due Date</label>
              <input
                type="date"
                value={formData.dueDate}
                onChange={(e) => setFormData(prev => ({ ...prev, dueDate: e.target.value }))}
                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm text-slate-400 mb-1">Solicitation Number</label>
            <input
              type="text"
              value={formData.solicitationNumber}
              onChange={(e) => setFormData(prev => ({ ...prev, solicitationNumber: e.target.value }))}
              className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              placeholder="e.g., W52P1J-24-R-0001"
            />
          </div>

          <div>
            <label className="block text-sm text-slate-400 mb-1">Description</label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
              rows={3}
              className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500 resize-none"
              placeholder="Brief description..."
            />
          </div>

          <div className="flex gap-3 pt-2">
            <Button variant="secondary" type="button" onClick={onCancel} className="flex-1">
              Cancel
            </Button>
            <Button variant="primary" type="submit" loading={isLoading} className="flex-1">
              {opportunity ? 'Update' : 'Create'} Opportunity
            </Button>
          </div>
        </form>
      );
    };

    // ============================================================
    // OPPORTUNITY DRAWER
    // ============================================================
    const OpportunityDrawer = ({ opportunity, onClose, onEdit, onDelete }) => {
      if (!opportunity) return null;

      const phaseInfo = MissionPulse.getPhaseInfo(opportunity.shipleyPhase);
      const daysRemaining = opportunity.daysRemaining;

      return (
        <div className="fixed inset-y-0 right-0 w-96 bg-slate-800 border-l border-slate-700 shadow-2xl z-40 animate-slideIn">
          <div className="flex items-center justify-between p-4 border-b border-slate-700">
            <h2 className="text-lg font-semibold text-white">Details</h2>
            <button 
              onClick={onClose}
              className="p-1 hover:bg-slate-700 rounded-lg transition-colors"
            >
              <Icon name="x" className="w-5 h-5 text-slate-400" />
            </button>
          </div>

          <div className="p-4 overflow-y-auto h-[calc(100%-140px)]">
            <h3 className="text-xl font-bold text-white mb-2">{opportunity.name}</h3>
            
            <div className="flex items-center gap-2 mb-4">
              <span 
                className="px-2 py-1 rounded-full text-xs font-semibold"
                style={{ backgroundColor: `${phaseInfo.color}30`, color: phaseInfo.color }}
              >
                {phaseInfo.name}
              </span>
              <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                opportunity.priority === 'P-0' ? 'bg-red-500/20 text-red-400' :
                opportunity.priority === 'P-1' ? 'bg-orange-500/20 text-orange-400' :
                opportunity.priority === 'P-2' ? 'bg-yellow-500/20 text-yellow-400' :
                'bg-slate-500/20 text-slate-400'
              }`}>
                {opportunity.priority}
              </span>
            </div>

            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Agency</p>
                  <p className="text-white font-medium">{opportunity.agency || '-'}</p>
                </div>
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Contract Value</p>
                  <p className="text-emerald-400 font-medium">
                    {MissionPulse.formatCurrency(opportunity.contractValue)}
                  </p>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Win Probability</p>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-cyan-500 rounded-full"
                        style={{ width: `${opportunity.winProbability}%` }}
                      />
                    </div>
                    <span className="text-cyan-400 font-medium">{opportunity.winProbability}%</span>
                  </div>
                </div>
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Days Remaining</p>
                  <p className={`font-medium ${
                    daysRemaining <= 3 ? 'text-red-400' :
                    daysRemaining <= 7 ? 'text-amber-400' :
                    'text-slate-300'
                  }`}>
                    {daysRemaining !== undefined ? (
                      daysRemaining < 0 ? 'Overdue' : `${daysRemaining} days`
                    ) : '-'}
                  </p>
                </div>
              </div>

              {opportunity.solicitationNumber && (
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Solicitation Number</p>
                  <p className="text-white font-mono text-sm">{opportunity.solicitationNumber}</p>
                </div>
              )}

              {opportunity.description && (
                <div className="bg-slate-900/50 rounded-lg p-3">
                  <p className="text-xs text-slate-400 mb-1">Description</p>
                  <p className="text-slate-300 text-sm">{opportunity.description}</p>
                </div>
              )}
            </div>
          </div>

          <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-slate-700 bg-slate-800 flex gap-3">
            <Button variant="secondary" onClick={() => onEdit(opportunity)} className="flex-1">
              <Icon name="edit" className="w-4 h-4" />
              Edit
            </Button>
            <Button variant="danger" onClick={() => onDelete(opportunity)} className="flex-1">
              <Icon name="trash" className="w-4 h-4" />
              Delete
            </Button>
          </div>
        </div>
      );
    };

    // ============================================================
    // OPPORTUNITY CARD (Board View)
    // ============================================================
    const OpportunityCard = ({ opportunity, onClick, onMoveNext }) => {
      const priorityColors = {
        'P-0': 'border-l-red-500',
        'P-1': 'border-l-orange-500',
        'P-2': 'border-l-yellow-500',
        'P-3': 'border-l-slate-500',
      };

      return (
        <div 
          onClick={onClick}
          className={`bg-slate-800/80 rounded-lg p-3 mb-2 border-l-4 cursor-pointer
            hover:bg-slate-700/80 transition-all ${priorityColors[opportunity.priority] || 'border-l-slate-500'}`}
        >
          <div className="flex items-start justify-between mb-2">
            <h4 className="text-sm font-semibold text-white line-clamp-2">{opportunity.name}</h4>
            {opportunity.daysRemaining !== undefined && opportunity.daysRemaining <= 7 && opportunity.daysRemaining >= 0 && (
              <span className="ml-2 px-1.5 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">
                {opportunity.daysRemaining}d
              </span>
            )}
          </div>
          
          <p className="text-xs text-slate-400 mb-2">{opportunity.agency}</p>
          
          <div className="flex items-center justify-between text-xs">
            <span className="text-emerald-400 font-semibold">
              {MissionPulse.formatCurrency(opportunity.contractValue)}
            </span>
            <span className={`px-1.5 py-0.5 rounded ${
              opportunity.priority === 'P-0' ? 'bg-red-500/20 text-red-400' :
              opportunity.priority === 'P-1' ? 'bg-orange-500/20 text-orange-400' :
              opportunity.priority === 'P-2' ? 'bg-yellow-500/20 text-yellow-400' :
              'bg-slate-500/20 text-slate-400'
            }`}>
              {opportunity.priority}
            </span>
          </div>

          <div className="mt-2 flex items-center gap-2">
            <div className="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
              <div 
                className="h-full bg-cyan-500 rounded-full"
                style={{ width: `${opportunity.winProbability}%` }}
              />
            </div>
            <span className="text-xs text-cyan-400">{opportunity.winProbability}%</span>
          </div>
        </div>
      );
    };

    // ============================================================
    // PHASE COLUMN (Board View)
    // ============================================================
    const PhaseColumn = ({ phase, opportunities, onCardClick, onDrop }) => {
      const [isDragOver, setIsDragOver] = useState(false);
      const phaseOpps = opportunities.filter(o => o.shipleyPhase === phase.key);
      const totalValue = phaseOpps.reduce((sum, o) => sum + (o.contractValue || 0), 0);

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragOver(true);
      };

      const handleDragLeave = () => {
        setIsDragOver(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragOver(false);
        const oppId = e.dataTransfer.getData('text/plain');
        if (oppId) {
          onDrop(oppId, phase.key);
        }
      };

      return (
        <div 
          className={`flex-shrink-0 w-72 flex flex-col rounded-xl overflow-hidden transition-all ${
            isDragOver ? 'ring-2 ring-cyan-500' : ''
          }`}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
        >
          {/* Column Header */}
          <div 
            className="p-3 border-b border-slate-700/50"
            style={{ backgroundColor: `${phase.color}15` }}
          >
            <div className="flex items-center justify-between mb-1">
              <div className="flex items-center gap-2">
                <div 
                  className="w-3 h-3 rounded-full"
                  style={{ backgroundColor: phase.color }}
                />
                <h3 className="font-semibold text-white">{phase.name}</h3>
              </div>
              <span className="text-xs text-slate-400">{phaseOpps.length}</span>
            </div>
            {phaseOpps.length > 0 && (
              <p className="text-xs text-emerald-400">
                {MissionPulse.formatCurrency(totalValue)} pipeline
              </p>
            )}
          </div>

          {/* Cards Container */}
          <div className="flex-1 bg-slate-900/30 p-2 overflow-y-auto scrollbar-thin min-h-[300px]">
            {phaseOpps.length === 0 ? (
              <div className="h-full flex items-center justify-center text-slate-600 text-xs">
                No opportunities
              </div>
            ) : (
              phaseOpps.map(opp => (
                <div
                  key={opp.id}
                  draggable
                  onDragStart={(e) => e.dataTransfer.setData('text/plain', opp.id)}
                >
                  <OpportunityCard 
                    opportunity={opp}
                    onClick={() => onCardClick(opp)}
                  />
                </div>
              ))
            )}
          </div>
        </div>
      );
    };

    // ============================================================
    // TABLE VIEW (with Checkboxes for Bulk Actions)
    // ============================================================
    const TableView = ({ 
      opportunities, 
      onRowClick, 
      selectedIds, 
      onToggleSelect, 
      onToggleSelectAll,
      lastSelectedIndex,
      setLastSelectedIndex 
    }) => {
      const [sortField, setSortField] = useState('dueDate');
      const [sortDir, setSortDir] = useState('asc');

      const sortedOpportunities = useMemo(() => {
        return [...opportunities].sort((a, b) => {
          let aVal = a[sortField];
          let bVal = b[sortField];
          
          if (sortField === 'dueDate') {
            aVal = new Date(aVal || '9999-12-31');
            bVal = new Date(bVal || '9999-12-31');
          } else if (sortField === 'contractValue' || sortField === 'winProbability') {
            aVal = aVal || 0;
            bVal = bVal || 0;
          } else {
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
          }
          
          if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }, [opportunities, sortField, sortDir]);

      const handleSort = (field) => {
        if (sortField === field) {
          setSortDir(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
          setSortField(field);
          setSortDir('asc');
        }
      };

      const handleRowSelect = (opp, index, e) => {
        if (e.shiftKey && lastSelectedIndex !== null) {
          // Range selection
          const start = Math.min(lastSelectedIndex, index);
          const end = Math.max(lastSelectedIndex, index);
          const rangeIds = sortedOpportunities.slice(start, end + 1).map(o => o.id);
          onToggleSelect(opp.id, true, rangeIds);
        } else {
          onToggleSelect(opp.id, false);
          setLastSelectedIndex(index);
        }
      };

      const allSelected = opportunities.length > 0 && selectedIds.length === opportunities.length;
      const someSelected = selectedIds.length > 0 && selectedIds.length < opportunities.length;

      const SortHeader = ({ field, label }) => (
        <th 
          className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider cursor-pointer hover:text-white"
          onClick={() => handleSort(field)}
        >
          <div className="flex items-center gap-1">
            {label}
            {sortField === field && (
              <Icon name={sortDir === 'asc' ? 'sortAsc' : 'sortDesc'} className="w-3 h-3" />
            )}
          </div>
        </th>
      );

      return (
        <div className="bg-slate-800/30 border border-slate-700/50 rounded-xl overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-900/50 border-b border-slate-700/50">
                <tr>
                  {/* Checkbox Column */}
                  <th className="w-12 px-4 py-3">
                    <button
                      onClick={onToggleSelectAll}
                      className="text-slate-400 hover:text-white"
                    >
                      <Icon 
                        name={allSelected ? 'checkSquare' : someSelected ? 'minusSquare' : 'square'} 
                        className="w-5 h-5" 
                      />
                    </button>
                  </th>
                  <SortHeader field="name" label="Name" />
                  <SortHeader field="agency" label="Agency" />
                  <SortHeader field="priority" label="Priority" />
                  <SortHeader field="shipleyPhase" label="Phase" />
                  <SortHeader field="contractValue" label="Value" />
                  <SortHeader field="winProbability" label="pWin" />
                  <SortHeader field="dueDate" label="Due Date" />
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700/30">
                {sortedOpportunities.map((opp, index) => {
                  const isSelected = selectedIds.includes(opp.id);
                  const phaseInfo = MissionPulse.getPhaseInfo(opp.shipleyPhase);
                  
                  return (
                    <tr 
                      key={opp.id}
                      className={`hover:bg-slate-700/30 transition-colors cursor-pointer ${
                        isSelected ? 'row-selected bg-cyan-500/10' : ''
                      }`}
                    >
                      {/* Checkbox */}
                      <td className="px-4 py-3" onClick={(e) => e.stopPropagation()}>
                        <button
                          onClick={(e) => handleRowSelect(opp, index, e)}
                          className="text-slate-400 hover:text-white"
                        >
                          <Icon 
                            name={isSelected ? 'checkSquare' : 'square'} 
                            className="w-5 h-5" 
                          />
                        </button>
                      </td>
                      <td 
                        className="px-4 py-3"
                        onClick={() => onRowClick(opp)}
                      >
                        <div className="flex flex-col">
                          <span className="text-white font-medium">{opp.name}</span>
                          {opp.solicitationNumber && (
                            <span className="text-xs text-slate-500 font-mono">{opp.solicitationNumber}</span>
                          )}
                        </div>
                      </td>
                      <td className="px-4 py-3 text-slate-300" onClick={() => onRowClick(opp)}>
                        {opp.agency || '-'}
                      </td>
                      <td className="px-4 py-3" onClick={() => onRowClick(opp)}>
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                          opp.priority === 'P-0' ? 'bg-red-500/20 text-red-400' :
                          opp.priority === 'P-1' ? 'bg-orange-500/20 text-orange-400' :
                          opp.priority === 'P-2' ? 'bg-yellow-500/20 text-yellow-400' :
                          'bg-slate-500/20 text-slate-400'
                        }`}>
                          {opp.priority}
                        </span>
                      </td>
                      <td className="px-4 py-3" onClick={() => onRowClick(opp)}>
                        <span 
                          className="px-2 py-1 rounded-full text-xs font-semibold"
                          style={{ backgroundColor: `${phaseInfo.color}20`, color: phaseInfo.color }}
                        >
                          {phaseInfo.name}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-emerald-400 font-semibold" onClick={() => onRowClick(opp)}>
                        {MissionPulse.formatCurrency(opp.contractValue)}
                      </td>
                      <td className="px-4 py-3" onClick={() => onRowClick(opp)}>
                        <div className="flex items-center gap-2">
                          <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-cyan-500 rounded-full"
                              style={{ width: `${opp.winProbability}%` }}
                            />
                          </div>
                          <span className="text-cyan-400 text-sm">{opp.winProbability}%</span>
                        </div>
                      </td>
                      <td className="px-4 py-3" onClick={() => onRowClick(opp)}>
                        <span className={`${
                          opp.daysRemaining !== undefined && opp.daysRemaining <= 3 ? 'text-red-400' :
                          opp.daysRemaining !== undefined && opp.daysRemaining <= 7 ? 'text-amber-400' :
                          'text-slate-300'
                        }`}>
                          {opp.dueDate ? new Date(opp.dueDate).toLocaleDateString() : '-'}
                        </span>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    };

    // ============================================================
    // MAIN COMPONENT
    // ============================================================
    const ShipleySwimLaneBoard = () => {
      // State
      const [opportunities, setOpportunities] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [connectionStatus, setConnectionStatus] = useState('disconnected');
      const [viewMode, setViewMode] = useState('board'); // 'board' | 'table'
      
      // Drawer & Modals
      const [selectedOpportunity, setSelectedOpportunity] = useState(null);
      const [isDrawerOpen, setIsDrawerOpen] = useState(false);
      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      const [isEditModalOpen, setIsEditModalOpen] = useState(false);
      const [editingOpportunity, setEditingOpportunity] = useState(null);
      const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
      const [isSaving, setIsSaving] = useState(false);
      
      // Bulk Actions
      const [selectedIds, setSelectedIds] = useState([]);
      const [lastSelectedIndex, setLastSelectedIndex] = useState(null);
      const [isBulkDeleteModalOpen, setIsBulkDeleteModalOpen] = useState(false);
      const [isBulkProcessing, setIsBulkProcessing] = useState(false);
      
      // Filters
      const [filters, setFilters] = useState({
        search: '',
        agencies: [],
        priorities: [],
        phases: [],
        pWinMin: 0,
        pWinMax: 100,
        dueDateFrom: '',
        dueDateTo: '',
      });
      
      const { addToast } = useToast();
      const phases = MissionPulse.getShipleyPhases();

      // Get unique agencies
      const uniqueAgencies = useMemo(() => {
        return [...new Set(opportunities.map(o => o.agency).filter(Boolean))].sort();
      }, [opportunities]);

      // Load opportunities
      const loadOpportunities = async () => {
        setLoading(true);
        setError(null);
        
        const { data, error: fetchError } = await MissionPulse.getOpportunities();
        
        if (fetchError) {
          setError(fetchError.message);
          addToast('Failed to load opportunities', 'error');
        } else {
          setOpportunities(data || []);
        }
        
        setLoading(false);
      };

      // Initialize
      useEffect(() => {
        loadOpportunities();
        
        // Subscribe to real-time updates
        const unsubscribe = MissionPulse.subscribeToOpportunities((event) => {
          if (event.eventType === 'INSERT') {
            setOpportunities(prev => [...prev, event.new]);
          } else if (event.eventType === 'UPDATE') {
            setOpportunities(prev => prev.map(o => o.id === event.new.id ? event.new : o));
          } else if (event.eventType === 'DELETE') {
            setOpportunities(prev => prev.filter(o => o.id !== event.old.id));
          }
        });

        // Connection status
        const unsubscribeConn = MissionPulse.onConnectionChange(setConnectionStatus);

        return () => {
          unsubscribe();
          unsubscribeConn();
        };
      }, []);

      // Clear selection when view or filters change
      useEffect(() => {
        setSelectedIds([]);
        setLastSelectedIndex(null);
      }, [viewMode, filters]);

      // Filter opportunities
      const filteredOpportunities = useMemo(() => {
        return opportunities.filter(opp => {
          // Search filter
          if (filters.search) {
            const search = filters.search.toLowerCase();
            const matchesSearch = 
              opp.name?.toLowerCase().includes(search) ||
              opp.agency?.toLowerCase().includes(search) ||
              opp.solicitationNumber?.toLowerCase().includes(search);
            if (!matchesSearch) return false;
          }

          // Agency filter
          if (filters.agencies.length > 0 && !filters.agencies.includes(opp.agency)) {
            return false;
          }

          // Priority filter
          if (filters.priorities.length > 0 && !filters.priorities.includes(opp.priority)) {
            return false;
          }

          // Phase filter
          if (filters.phases.length > 0 && !filters.phases.includes(opp.shipleyPhase)) {
            return false;
          }

          // pWin filter
          const pWin = opp.winProbability || 0;
          if (pWin < filters.pWinMin || pWin > filters.pWinMax) {
            return false;
          }

          // Due date filter
          if (filters.dueDateFrom && opp.dueDate) {
            if (new Date(opp.dueDate) < new Date(filters.dueDateFrom)) {
              return false;
            }
          }
          if (filters.dueDateTo && opp.dueDate) {
            if (new Date(opp.dueDate) > new Date(filters.dueDateTo)) {
              return false;
            }
          }

          return true;
        });
      }, [opportunities, filters]);

      // CRUD Handlers
      const handleCreate = async (data) => {
        setIsSaving(true);
        const { data: newOpp, error } = await MissionPulse.createOpportunity(data);
        
        if (error) {
          addToast('Failed to create opportunity', 'error');
        } else {
          addToast('Opportunity created successfully', 'success');
          setIsAddModalOpen(false);
        }
        setIsSaving(false);
      };

      const handleUpdate = async (data) => {
        setIsSaving(true);
        const { error } = await MissionPulse.updateOpportunity(editingOpportunity.id, data);
        
        if (error) {
          addToast('Failed to update opportunity', 'error');
        } else {
          addToast('Opportunity updated successfully', 'success');
          setIsEditModalOpen(false);
          setIsDrawerOpen(false);
          setEditingOpportunity(null);
        }
        setIsSaving(false);
      };

      const handleDelete = async () => {
        setIsSaving(true);
        const { error } = await MissionPulse.deleteOpportunity(selectedOpportunity.id);
        
        if (error) {
          addToast('Failed to delete opportunity', 'error');
        } else {
          addToast('Opportunity deleted', 'success');
          setIsDeleteModalOpen(false);
          setIsDrawerOpen(false);
          setSelectedOpportunity(null);
        }
        setIsSaving(false);
      };

      // Drag & Drop handler
      const handleDrop = async (oppId, newPhase) => {
        const { error } = await MissionPulse.updateOpportunity(oppId, { shipleyPhase: newPhase });
        
        if (error) {
          addToast('Failed to move opportunity', 'error');
        } else {
          addToast('Phase updated', 'success');
        }
      };

      // Bulk Action Handlers
      const handleToggleSelect = (id, isRange = false, rangeIds = []) => {
        if (isRange && rangeIds.length > 0) {
          // For range selection, add all IDs in range
          setSelectedIds(prev => {
            const newIds = new Set(prev);
            rangeIds.forEach(rid => newIds.add(rid));
            return Array.from(newIds);
          });
        } else {
          setSelectedIds(prev => {
            if (prev.includes(id)) {
              return prev.filter(x => x !== id);
            } else {
              return [...prev, id];
            }
          });
        }
      };

      const handleToggleSelectAll = () => {
        if (selectedIds.length === filteredOpportunities.length) {
          setSelectedIds([]);
        } else {
          setSelectedIds(filteredOpportunities.map(o => o.id));
        }
      };

      const handleBulkPhaseChange = async (newPhase) => {
        setIsBulkProcessing(true);
        const { data, error } = await MissionPulse.bulkUpdateOpportunities(selectedIds, { shipleyPhase: newPhase });
        
        if (error) {
          addToast(`Failed to update ${selectedIds.length} opportunities`, 'error');
        } else {
          addToast(`Updated ${data.count} opportunities to ${MissionPulse.getPhaseInfo(newPhase).name}`, 'success');
          setSelectedIds([]);
          loadOpportunities();
        }
        setIsBulkProcessing(false);
      };

      const handleBulkDelete = async () => {
        setIsBulkProcessing(true);
        const { data, error } = await MissionPulse.bulkDeleteOpportunities(selectedIds);
        
        if (error) {
          addToast(`Failed to delete ${selectedIds.length} opportunities`, 'error');
        } else {
          addToast(`Deleted ${data.count} opportunities`, 'success');
          setSelectedIds([]);
          setIsBulkDeleteModalOpen(false);
          loadOpportunities();
        }
        setIsBulkProcessing(false);
      };

      // Stats
      const totalPipeline = opportunities.reduce((sum, o) => sum + (o.contractValue || 0), 0);
      const urgentCount = opportunities.filter(o => o.daysRemaining !== undefined && o.daysRemaining <= 3 && o.daysRemaining >= 0).length;

      return (
        <div className="min-h-screen bg-[#00050F]">
          {/* Header */}
          <header className="bg-slate-900/80 border-b border-slate-700/50 px-6 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
                  <Icon name="shield" className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h1 className="text-xl font-bold text-white">Shipley Pipeline Board</h1>
                  <p className="text-sm text-slate-400">
                    {opportunities.length} opportunities  {MissionPulse.formatCurrency(totalPipeline)} pipeline
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-4">
                <ConnectionStatus status={connectionStatus} />
                
                {urgentCount > 0 && (
                  <div className="flex items-center gap-2 px-3 py-1.5 bg-red-500/20 border border-red-500/30 rounded-lg">
                    <Icon name="alert" className="w-4 h-4 text-red-400" />
                    <span className="text-red-400 text-sm font-semibold">{urgentCount} urgent</span>
                  </div>
                )}

                {/* View Toggle */}
                <div className="flex items-center bg-slate-800 rounded-lg p-1">
                  <button
                    onClick={() => setViewMode('board')}
                    className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 ${
                      viewMode === 'board' ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white'
                    }`}
                  >
                    <Icon name="board" className="w-4 h-4" />
                    Board
                  </button>
                  <button
                    onClick={() => setViewMode('table')}
                    className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 ${
                      viewMode === 'table' ? 'bg-cyan-500 text-white' : 'text-slate-400 hover:text-white'
                    }`}
                  >
                    <Icon name="table" className="w-4 h-4" />
                    Table
                  </button>
                </div>

                <Button onClick={() => setIsAddModalOpen(true)}>
                  <Icon name="plus" className="w-4 h-4" />
                  Add Opportunity
                </Button>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className="p-6">
            {/* Search & Filters */}
            <SearchFilterBar 
              filters={filters}
              setFilters={setFilters}
              agencies={uniqueAgencies}
              phases={phases}
            />

            {/* Content */}
            {loading ? (
              <LoadingState />
            ) : error ? (
              <ErrorState message={error} onRetry={loadOpportunities} />
            ) : viewMode === 'board' ? (
              <div className="flex gap-4 overflow-x-auto pb-4 scrollbar-thin">
                {phases.map(phase => (
                  <PhaseColumn
                    key={phase.key}
                    phase={phase}
                    opportunities={filteredOpportunities}
                    onCardClick={(opp) => {
                      setSelectedOpportunity(opp);
                      setIsDrawerOpen(true);
                    }}
                    onDrop={handleDrop}
                  />
                ))}
              </div>
            ) : (
              <TableView
                opportunities={filteredOpportunities}
                onRowClick={(opp) => {
                  setSelectedOpportunity(opp);
                  setIsDrawerOpen(true);
                }}
                selectedIds={selectedIds}
                onToggleSelect={handleToggleSelect}
                onToggleSelectAll={handleToggleSelectAll}
                lastSelectedIndex={lastSelectedIndex}
                setLastSelectedIndex={setLastSelectedIndex}
              />
            )}
          </main>

          {/* Bulk Action Bar */}
          {viewMode === 'table' && (
            <BulkActionBar
              selectedCount={selectedIds.length}
              onPhaseChange={handleBulkPhaseChange}
              onDelete={() => setIsBulkDeleteModalOpen(true)}
              phases={phases}
              isProcessing={isBulkProcessing}
            />
          )}

          {/* Drawer */}
          {isDrawerOpen && (
            <OpportunityDrawer
              opportunity={selectedOpportunity}
              onClose={() => {
                setIsDrawerOpen(false);
                setSelectedOpportunity(null);
              }}
              onEdit={(opp) => {
                setEditingOpportunity(opp);
                setIsEditModalOpen(true);
              }}
              onDelete={(opp) => {
                setSelectedOpportunity(opp);
                setIsDeleteModalOpen(true);
              }}
            />
          )}

          {/* Add Modal */}
          <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="Add Opportunity" size="lg">
            <OpportunityForm
              onSave={handleCreate}
              onCancel={() => setIsAddModalOpen(false)}
              isLoading={isSaving}
            />
          </Modal>

          {/* Edit Modal */}
          <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title="Edit Opportunity" size="lg">
            <OpportunityForm
              opportunity={editingOpportunity}
              onSave={handleUpdate}
              onCancel={() => setIsEditModalOpen(false)}
              isLoading={isSaving}
            />
          </Modal>

          {/* Single Delete Confirm Modal */}
          <DeleteConfirmModal
            isOpen={isDeleteModalOpen}
            onClose={() => setIsDeleteModalOpen(false)}
            onConfirm={handleDelete}
            count={1}
            isLoading={isSaving}
          />

          {/* Bulk Delete Confirm Modal */}
          <DeleteConfirmModal
            isOpen={isBulkDeleteModalOpen}
            onClose={() => setIsBulkDeleteModalOpen(false)}
            onConfirm={handleBulkDelete}
            count={selectedIds.length}
            isLoading={isBulkProcessing}
          />

          {/* Footer */}
          <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 border-t border-slate-700/50 px-6 py-2">
            <div className="flex items-center justify-between">
              <span className="text-xs text-slate-500">MissionPulse v12  Sprint 7.2</span>
              <span className="text-xs text-slate-600">AI GENERATED - REQUIRES HUMAN REVIEW</span>
            </div>
          </footer>
        </div>
      );
    };

    // Render App with Toast Provider
    ReactDOM.createRoot(document.getElementById('root')).render(
      <ToastProvider>
        <ShipleySwimLaneBoard />
      </ToastProvider>
    );
  </script>
</body>
</html>
