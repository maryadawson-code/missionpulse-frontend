<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse Analytics Command Center</title>
    
    <!-- Typography: SF Pro with Inter fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           DESIGN SYSTEM: Shield & Pulse UX v8.0
           From MISSIONPULSE_V12_DESIGN_SYSTEM.css
           ============================================ */
        
        :root {
            /* === FOUNDATION COLORS === */
            --deep-navy: #00050F;
            --navy-900: #0A1628;
            --navy-800: #111C2E;
            --navy-700: #1A2942;
            --navy-600: #243656;
            
            /* === PRIMARY ACCENT (MMT Cyan) === */
            --primary-cyan: #00E5FA;
            --primary-cyan-rgb: 0, 229, 250;
            --primary-cyan-hover: #33EBFB;
            --primary-cyan-active: #00B8C8;
            --primary-cyan-glow: rgba(0, 229, 250, 0.25);
            --primary-cyan-subtle: rgba(0, 229, 250, 0.1);
            
            /* === SEMANTIC STATES === */
            --success-teal: #00BDAE;
            --success-teal-bg: rgba(0, 189, 174, 0.12);
            --success-teal-border: rgba(0, 189, 174, 0.3);
            --warning-amber: #F59E0B;
            --warning-amber-bg: rgba(245, 158, 11, 0.12);
            --warning-amber-border: rgba(245, 158, 11, 0.3);
            --risk-coral: #EF4444;
            --risk-coral-bg: rgba(239, 68, 68, 0.12);
            --risk-coral-border: rgba(239, 68, 68, 0.3);
            --info-blue: #3B82F6;
            --info-blue-bg: rgba(59, 130, 246, 0.12);
            
            /* === PRIORITY COLORS === */
            --p0-must-win: #EF4444;
            --p1-active: #00E5FA;
            --p2-gap-filler: #00BDAE;
            
            /* === TEXT HIERARCHY === */
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --text-tertiary: #64748B;
            --text-disabled: #475569;
            
            /* === GLASS EFFECTS === */
            --glass-white: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-hover: rgba(255, 255, 255, 0.1);
            --shadow-glow: 0 0 30px rgba(0, 229, 250, 0.15);
            
            /* === TYPOGRAPHY === */
            --font-display: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            --font-body: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            --font-mono: 'SF Mono', 'JetBrains Mono', 'Fira Code', monospace;
            
            /* === SPACING === */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            
            /* === BORDER RADIUS === */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* === EASING & TIMING === */
            --ease-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --duration-fast: 200ms;
            --duration-normal: 300ms;
            --duration-slow: 500ms;
        }
        
        /* === KEYFRAME ANIMATIONS === */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 var(--primary-cyan-glow); }
            50% { box-shadow: 0 0 20px 10px var(--primary-cyan-glow); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes statusPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, var(--deep-navy) 0%, var(--navy-900) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: var(--space-6);
        }
        
        /* === GLASS CARD === */
        .glass-card {
            background: var(--glass-white);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: var(--shadow-glow);
            animation: fadeInUp var(--duration-normal) var(--ease-out-expo);
        }
        
        .glass-card:hover {
            background: var(--glass-hover);
            border-color: rgba(0, 229, 250, 0.2);
        }
        
        /* === LOADING STATE === */
        .skeleton {
            background: linear-gradient(90deg, var(--navy-800) 0%, var(--navy-700) 50%, var(--navy-800) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }
        
        .skeleton-text { height: 20px; margin-bottom: 8px; }
        .skeleton-large { height: 40px; width: 120px; }
        
        /* === ACCESS DENIED === */
        .access-denied {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        
        .access-denied.show { display: flex; }
        
        .access-denied-icon {
            font-size: 64px;
            margin-bottom: var(--space-6);
            opacity: 0.5;
        }
        
        .access-denied h2 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
        }
        
        .access-denied p {
            color: var(--text-secondary);
            max-width: 400px;
        }
        
        /* === HEADER === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-8);
            animation: fadeInUp var(--duration-normal) var(--ease-out-expo);
        }
        
        .header-left { display: flex; align-items: center; gap: var(--space-4); }
        
        .header-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-cyan-active) 100%);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 24px rgba(0, 229, 250, 0.3);
        }
        
        .header h1 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        .header-subtitle { color: var(--text-tertiary); font-size: 14px; margin-top: 4px; }
        
        .rbac-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--primary-cyan-subtle);
            border: 1px solid rgba(0, 229, 250, 0.3);
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-cyan);
            margin-top: var(--space-2);
        }
        
        .rbac-badge::before { content: 'üîê'; font-size: 14px; }
        
        .header-controls { display: flex; gap: var(--space-3); align-items: center; }
        
        .time-select {
            background: var(--primary-cyan-subtle);
            border: 1px solid rgba(0, 229, 250, 0.3);
            color: var(--primary-cyan);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .time-select:hover { background: rgba(0, 229, 250, 0.15); }
        
        .refresh-btn {
            width: 44px;
            height: 44px;
            background: var(--primary-cyan-subtle);
            border: 1px solid rgba(0, 229, 250, 0.3);
            border-radius: var(--radius-md);
            color: var(--primary-cyan);
            font-size: 18px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-btn:hover { background: rgba(0, 229, 250, 0.15); transform: scale(1.05); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }
        
        /* === KPI CARDS === */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .kpi-grid { grid-template-columns: 1fr; } }
        
        .kpi-card { padding: var(--space-6); position: relative; overflow: hidden; }
        .kpi-card .bg-icon { position: absolute; top: -10px; right: -10px; font-size: 80px; opacity: 0.05; }
        .kpi-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4); }
        
        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        
        .kpi-icon.cyan { background: var(--primary-cyan-subtle); }
        .kpi-icon.teal { background: var(--success-teal-bg); }
        .kpi-icon.purple { background: rgba(139, 92, 246, 0.12); }
        .kpi-icon.amber { background: var(--warning-amber-bg); }
        
        .kpi-label { color: var(--text-secondary); font-size: 14px; font-weight: 500; }
        
        .kpi-value {
            font-family: var(--font-display);
            font-size: 36px;
            font-weight: 700;
            margin-bottom: var(--space-2);
            animation: countUp var(--duration-slow) var(--ease-out-expo);
        }
        
        .kpi-value.cyan { color: var(--primary-cyan); }
        .kpi-value.teal { color: var(--success-teal); }
        .kpi-value.purple { color: #8B5CF6; }
        .kpi-value.amber { color: var(--warning-amber); }
        
        .kpi-footer { display: flex; align-items: center; gap: var(--space-3); }
        .kpi-subvalue { color: var(--text-tertiary); font-size: 14px; }
        
        .kpi-trend {
            font-size: 12px;
            padding: var(--space-1) var(--space-2);
            border-radius: 20px;
            font-weight: 600;
        }
        
        .trend-up { background: var(--success-teal-bg); color: var(--success-teal); }
        .trend-down { background: var(--risk-coral-bg); color: var(--risk-coral); }
        
        /* === CHARTS === */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        @media (max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } }
        
        .chart-card { padding: var(--space-6); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); }
        .chart-title { display: flex; align-items: center; gap: var(--space-2); font-family: var(--font-display); font-size: 18px; font-weight: 600; }
        
        .chart-badge { padding: var(--space-2) var(--space-3); border-radius: 20px; font-size: 12px; font-weight: 600; }
        .chart-badge.cyan { background: var(--primary-cyan-subtle); color: var(--primary-cyan); }
        .chart-badge.teal { background: var(--success-teal-bg); color: var(--success-teal); }
        
        /* === PIPELINE BARS === */
        .pipeline-bars { display: flex; flex-direction: column; gap: var(--space-3); }
        .pipeline-item { display: flex; align-items: center; gap: var(--space-3); }
        .pipeline-label { width: 100px; font-size: 13px; color: var(--text-secondary); text-align: right; }
        
        .pipeline-bar-container {
            flex: 1;
            height: 36px;
            background: var(--navy-700);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .pipeline-bar {
            height: 100%;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: var(--space-3);
            font-size: 13px;
            font-weight: 600;
            color: var(--deep-navy);
            transition: width 1s var(--ease-out-expo);
        }
        
        .pipeline-value { width: 80px; text-align: right; font-size: 13px; font-weight: 600; color: var(--primary-cyan); }
        
        /* === WIN RATE BARS === */
        .win-rate-visual {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            padding: var(--space-5) 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .win-bar-group { display: flex; flex-direction: column; align-items: center; gap: var(--space-2); }
        
        .win-bar {
            width: 60px;
            background: linear-gradient(180deg, var(--success-teal) 0%, var(--primary-cyan) 100%);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: var(--space-2);
            font-size: 14px;
            font-weight: 700;
            color: var(--deep-navy);
            transition: height 1s var(--ease-out-expo);
        }
        
        .win-label { font-size: 12px; color: var(--text-tertiary); margin-top: var(--space-2); }
        
        /* === BOTTOM ROW === */
        .bottom-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        @media (max-width: 1000px) { .bottom-row { grid-template-columns: 1fr; } }
        
        /* === AGENT GRID === */
        .agent-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4); }
        @media (max-width: 800px) { .agent-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .agent-card {
            background: var(--primary-cyan-subtle);
            border: 1px solid rgba(0, 229, 250, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            transition: all var(--duration-fast) var(--ease-standard);
        }
        
        .agent-card:hover {
            background: rgba(0, 229, 250, 0.1);
            border-color: rgba(0, 229, 250, 0.3);
            transform: translateY(-2px);
        }
        
        .agent-emoji { font-size: 28px; margin-bottom: var(--space-2); }
        .agent-name { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-1); }
        .agent-sessions { font-family: var(--font-display); font-size: 24px; font-weight: 700; color: var(--primary-cyan); }
        .agent-label { font-size: 12px; color: var(--text-tertiary); }
        .agent-tokens { font-size: 12px; color: var(--text-secondary); margin-top: var(--space-2); }
        
        /* === DONUT CHART === */
        .donut-container { display: flex; justify-content: center; padding: var(--space-5) 0; }
        
        .donut {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
        }
        
        .donut-hole {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: var(--deep-navy);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .donut-total { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--primary-cyan); }
        .donut-label { font-size: 12px; color: var(--text-tertiary); }
        
        .priority-list { margin-top: var(--space-5); }
        
        .priority-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .priority-item:last-child { border-bottom: none; }
        .priority-left { display: flex; align-items: center; gap: var(--space-2); }
        .priority-dot { width: 12px; height: 12px; border-radius: 50%; animation: statusPulse 2s ease-in-out infinite; }
        .priority-name { color: var(--text-secondary); font-size: 14px; }
        .priority-count { font-weight: 600; color: var(--text-primary); }
        
        /* === TOKEN SECTION === */
        .token-section { padding: var(--space-6); margin-bottom: var(--space-8); }
        .legend { display: flex; gap: var(--space-6); }
        .legend-item { display: flex; align-items: center; gap: var(--space-2); font-size: 14px; color: var(--text-secondary); }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        
        .token-visual {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            padding: var(--space-5) var(--space-8);
        }
        
        .token-bar-group { display: flex; flex-direction: column; align-items: center; gap: var(--space-1); width: 80px; }
        .token-bars { display: flex; gap: var(--space-1); align-items: flex-end; }
        .token-bar { width: 30px; border-radius: var(--radius-sm) var(--radius-sm) 0 0; transition: height 1s var(--ease-out-expo); }
        .token-bar.usage { background: linear-gradient(180deg, var(--primary-cyan) 0%, var(--primary-cyan-active) 100%); }
        .token-bar.cost { background: linear-gradient(180deg, var(--warning-amber) 0%, #D97706 100%); }
        .token-date { font-size: 11px; color: var(--text-tertiary); margin-top: var(--space-2); }
        
        /* === FOOTER === */
        .footer {
            text-align: center;
            padding: var(--space-5);
            border-top: 1px solid var(--glass-border);
            margin-top: var(--space-4);
        }
        
        .footer-disclaimer {
            color: var(--warning-amber);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--warning-amber-bg);
            border-radius: var(--radius-md);
            display: inline-block;
        }
        
        .footer-brand { color: var(--text-tertiary); font-size: 12px; }
        .footer-brand span { color: var(--primary-cyan); }
        
        /* === DASHBOARD CONTAINER === */
        #dashboard { display: none; }
        #dashboard.show { display: block; }
        
        /* === REDUCED MOTION === */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- ACCESS DENIED STATE -->
    <div id="accessDenied" class="access-denied">
        <div class="access-denied-icon">üîí</div>
        <h2>Analytics Access Required</h2>
        <p>The Analytics Command Center requires executive, operations, or capture manager role access. Contact your administrator to request access.</p>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="dashboard">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <div class="header-icon">üìä</div>
                <div>
                    <h1>Analytics Command Center</h1>
                    <p class="header-subtitle">MissionPulse Performance Intelligence</p>
                    <div class="rbac-badge">
                        Executive ‚Ä¢ Operations ‚Ä¢ Capture Manager
                    </div>
                </div>
            </div>
            <div class="header-controls">
                <select class="time-select" id="timeRange" onchange="loadDashboard()">
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                    <option value="ytd">Year to Date</option>
                </select>
                <button class="refresh-btn" id="refreshBtn" onclick="handleRefresh()">‚Üª</button>
            </div>
        </div>

        <!-- KPI CARDS -->
        <div class="kpi-grid">
            <div class="glass-card kpi-card">
                <span class="bg-icon">üéØ</span>
                <div class="kpi-header">
                    <div class="kpi-icon cyan">üéØ</div>
                    <span class="kpi-label">Pipeline Value</span>
                </div>
                <div class="kpi-value cyan" id="kpiPipelineValue">$--</div>
                <div class="kpi-footer">
                    <span class="kpi-subvalue" id="kpiPipelineDetail">-- Active Pursuits</span>
                    <span class="kpi-trend trend-up" id="kpiPipelineTrend">‚Üë --%</span>
                </div>
            </div>
            
            <div class="glass-card kpi-card">
                <span class="bg-icon">üìà</span>
                <div class="kpi-header">
                    <div class="kpi-icon teal">üìà</div>
                    <span class="kpi-label">Win Probability</span>
                </div>
                <div class="kpi-value teal" id="kpiWinRate">--%</div>
                <div class="kpi-footer">
                    <span class="kpi-subvalue" id="kpiWinRateDetail">-- of -- Q1 2025</span>
                    <span class="kpi-trend trend-up" id="kpiWinRateTrend">‚Üë --%</span>
                </div>
            </div>
            
            <div class="glass-card kpi-card">
                <span class="bg-icon">üß†</span>
                <div class="kpi-header">
                    <div class="kpi-icon purple">üß†</div>
                    <span class="kpi-label">AI Sessions</span>
                </div>
                <div class="kpi-value purple" id="kpiSessions">--</div>
                <div class="kpi-footer">
                    <span class="kpi-subvalue">This Period</span>
                    <span class="kpi-trend trend-up" id="kpiSessionsTrend">‚Üë --%</span>
                </div>
            </div>
            
            <div class="glass-card kpi-card">
                <span class="bg-icon">‚ö°</span>
                <div class="kpi-header">
                    <div class="kpi-icon amber">‚ö°</div>
                    <span class="kpi-label">Token Usage</span>
                </div>
                <div class="kpi-value amber" id="kpiTokens">--</div>
                <div class="kpi-footer">
                    <span class="kpi-subvalue" id="kpiTokenCost">$-- Total Cost</span>
                    <span class="kpi-trend trend-down" id="kpiTokenTrend">‚Üì --%</span>
                </div>
            </div>
        </div>

        <!-- CHARTS ROW -->
        <div class="charts-row">
            <div class="glass-card chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>üõ°Ô∏è</span>
                        <span>Pipeline by Shipley Stage</span>
                    </div>
                    <span class="chart-badge cyan">Shipley Methodology</span>
                </div>
                <div class="pipeline-bars" id="pipelineBars">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="glass-card chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>üìà</span>
                        <span>Win Rate Trajectory</span>
                    </div>
                    <span class="chart-badge teal" id="winRateBadge">+--% YoY</span>
                </div>
                <div class="win-rate-visual" id="winRateBars">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- BOTTOM ROW -->
        <div class="bottom-row">
            <div class="glass-card chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>üß†</span>
                        <span>AI Agent Performance</span>
                    </div>
                </div>
                <div class="agent-grid" id="agentGrid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="glass-card chart-card">
                <div class="chart-header">
                    <div class="chart-title">
                        <span>üéØ</span>
                        <span>Priority Mix</span>
                    </div>
                </div>
                <div class="donut-container">
                    <div class="donut" id="priorityDonut">
                        <div class="donut-hole">
                            <span class="donut-total" id="priorityTotal">--</span>
                            <span class="donut-label">Pursuits</span>
                        </div>
                    </div>
                </div>
                <div class="priority-list" id="priorityList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- TOKEN COST TREND -->
        <div class="glass-card token-section">
            <div class="chart-header">
                <div class="chart-title">
                    <span>üí∞</span>
                    <span>Token Consumption & Cost Trend</span>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--primary-cyan);"></div>
                        <span>Tokens (K)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--warning-amber);"></div>
                        <span>Cost ($)</span>
                    </div>
                </div>
            </div>
            <div class="token-visual" id="tokenBars">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="footer-disclaimer">‚ö†Ô∏è AI GENERATED ANALYTICS - REQUIRES HUMAN REVIEW</div>
            <p class="footer-brand">
                MissionPulse v1.1 ‚Ä¢ <span>Mission Meets Tech</span> ‚Ä¢ Shield & Pulse UX v8.0
            </p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000/api'
            : 'https://missionpulse-api.onrender.com/api';
        
        // Allowed roles for analytics access
        const ALLOWED_ROLES = ['executive', 'operations', 'capture_manager'];
        
        // Get current user role (from session, URL param, or default for demo)
        function getCurrentRole() {
            // Check URL param first (for testing)
            const urlParams = new URLSearchParams(window.location.search);
            const roleParam = urlParams.get('role');
            if (roleParam) return roleParam;
            
            // Check sessionStorage
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole) return storedRole;
            
            // Default to executive for demo
            return 'executive';
        }
        
        // ============================================
        // RBAC CHECK
        // ============================================
        
        function checkAccess() {
            const role = getCurrentRole();
            const hasAccess = ALLOWED_ROLES.includes(role);
            
            document.getElementById('accessDenied').classList.toggle('show', !hasAccess);
            document.getElementById('dashboard').classList.toggle('show', hasAccess);
            
            return hasAccess;
        }
        
        // ============================================
        // FORMAT HELPERS
        // ============================================
        
        function formatCurrency(value) {
            if (value >= 1000) return '$' + (value / 1000).toFixed(1) + 'B';
            return '$' + value.toFixed(1) + 'M';
        }
        
        function formatTokens(tokens) {
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(2) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K';
            return tokens.toString();
        }
        
        function formatTrend(value) {
            const prefix = value >= 0 ? '‚Üë' : '‚Üì';
            return prefix + ' ' + Math.abs(value).toFixed(1) + '%';
        }
        
        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        
        function renderPipelineBars(pipeline) {
            const maxCount = Math.max(...pipeline.map(p => p.count));
            const container = document.getElementById('pipelineBars');
            
            container.innerHTML = pipeline.map(stage => {
                const width = (stage.count / maxCount) * 100;
                return `
                    <div class="pipeline-item">
                        <span class="pipeline-label">${stage.stage}</span>
                        <div class="pipeline-bar-container">
                            <div class="pipeline-bar" style="width: ${width}%; background: linear-gradient(90deg, ${stage.color}, ${adjustColor(stage.color, -20)});">
                                ${stage.count}
                            </div>
                        </div>
                        <span class="pipeline-value">$${stage.value}M</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderWinRateBars(winRate) {
            const maxRate = Math.max(...winRate.map(w => w.rate));
            const container = document.getElementById('winRateBars');
            
            container.innerHTML = winRate.map(quarter => {
                const height = (quarter.rate / maxRate) * 150;
                return `
                    <div class="win-bar-group">
                        <div class="win-bar" style="height: ${height}px;">${quarter.rate}%</div>
                        <span class="win-label">${quarter.quarter.replace('20', "'")}</span>
                    </div>
                `;
            }).join('');
            
            // Update YoY badge
            if (winRate.length >= 5) {
                const yoyChange = winRate[4].rate - winRate[0].rate;
                document.getElementById('winRateBadge').textContent = 
                    (yoyChange >= 0 ? '+' : '') + yoyChange.toFixed(1) + '% YoY';
            }
        }
        
        function renderAgentGrid(agents) {
            const container = document.getElementById('agentGrid');
            
            container.innerHTML = agents.map(agent => `
                <div class="agent-card">
                    <div class="agent-emoji">${agent.icon}</div>
                    <div class="agent-name">${agent.agent_name}</div>
                    <div class="agent-sessions">${agent.sessions}</div>
                    <div class="agent-label">sessions</div>
                    <div class="agent-tokens">${formatTokens(agent.tokens)} tokens</div>
                </div>
            `).join('');
        }
        
        function renderPriorityChart(priorities) {
            const total = priorities.reduce((sum, p) => sum + p.value, 0);
            
            // Update total
            document.getElementById('priorityTotal').textContent = total;
            
            // Generate conic gradient for donut
            let gradientStops = [];
            let currentAngle = 0;
            
            priorities.forEach(p => {
                const angle = (p.value / total) * 360;
                gradientStops.push(`${p.color} ${currentAngle}deg ${currentAngle + angle}deg`);
                currentAngle += angle;
            });
            
            document.getElementById('priorityDonut').style.background = 
                `conic-gradient(${gradientStops.join(', ')})`;
            
            // Render legend
            const listContainer = document.getElementById('priorityList');
            listContainer.innerHTML = priorities.map(p => `
                <div class="priority-item">
                    <div class="priority-left">
                        <div class="priority-dot" style="background: ${p.color};"></div>
                        <span class="priority-name">${p.name}</span>
                    </div>
                    <span class="priority-count">${p.value}</span>
                </div>
            `).join('');
        }
        
        function renderTokenTrend(tokenTrend) {
            const maxTokens = Math.max(...tokenTrend.map(t => t.tokens));
            const maxCost = Math.max(...tokenTrend.map(t => t.cost));
            const container = document.getElementById('tokenBars');
            
            container.innerHTML = tokenTrend.map(point => {
                const tokenHeight = (point.tokens / maxTokens) * 150;
                const costHeight = (point.cost / maxCost) * 80;
                return `
                    <div class="token-bar-group">
                        <div class="token-bars">
                            <div class="token-bar usage" style="height: ${tokenHeight}px;"></div>
                            <div class="token-bar cost" style="height: ${costHeight}px;"></div>
                        </div>
                        <span class="token-date">${point.date}</span>
                    </div>
                `;
            }).join('');
        }
        
        function adjustColor(hex, amount) {
            // Simple color adjustment helper
            let num = parseInt(hex.replace('#', ''), 16);
            let r = Math.min(255, Math.max(0, (num >> 16) + amount));
            let g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            let b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (b | (g << 8) | (r << 16)).toString(16).padStart(6, '0');
        }
        
        // ============================================
        // API CALLS
        // ============================================
        
        async function loadDashboard() {
            if (!checkAccess()) return;
            
            const role = getCurrentRole();
            const timeRange = document.getElementById('timeRange').value;
            
            try {
                const response = await fetch(
                    `${API_BASE}/analytics/dashboard?time_range=${timeRange}&user_role=${role}`
                );
                
                if (!response.ok) {
                    if (response.status === 403) {
                        document.getElementById('accessDenied').classList.add('show');
                        document.getElementById('dashboard').classList.remove('show');
                        return;
                    }
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update KPIs
                const summary = data.summary;
                document.getElementById('kpiPipelineValue').textContent = formatCurrency(summary.pipeline_value);
                document.getElementById('kpiPipelineDetail').textContent = `${summary.active_pursuits} Active Pursuits`;
                document.getElementById('kpiPipelineTrend').textContent = formatTrend(summary.pipeline_trend);
                document.getElementById('kpiPipelineTrend').className = 
                    `kpi-trend ${summary.pipeline_trend >= 0 ? 'trend-up' : 'trend-down'}`;
                
                document.getElementById('kpiWinRate').textContent = summary.win_rate + '%';
                document.getElementById('kpiWinRateDetail').textContent = summary.win_rate_detail;
                document.getElementById('kpiWinRateTrend').textContent = formatTrend(summary.win_rate_trend);
                
                document.getElementById('kpiSessions').textContent = summary.ai_sessions.toLocaleString();
                document.getElementById('kpiSessionsTrend').textContent = formatTrend(summary.ai_sessions_trend);
                
                document.getElementById('kpiTokens').textContent = formatTokens(summary.token_usage);
                document.getElementById('kpiTokenCost').textContent = `$${summary.token_cost.toFixed(2)} Total Cost`;
                document.getElementById('kpiTokenTrend').textContent = formatTrend(summary.token_trend);
                document.getElementById('kpiTokenTrend').className = 
                    `kpi-trend ${summary.token_trend <= 0 ? 'trend-up' : 'trend-down'}`;
                
                // Render charts
                renderPipelineBars(data.pipeline);
                renderWinRateBars(data.win_rate);
                renderAgentGrid(data.agents);
                renderPriorityChart(data.priority_distribution);
                renderTokenTrend(data.token_trend);
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                // Could show error toast here
            }
        }
        
        function handleRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            
            loadDashboard().finally(() => {
                setTimeout(() => btn.classList.remove('spinning'), 500);
            });
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAccess()) {
                loadDashboard();
            }
        });
    </script>
</body>
</html>
