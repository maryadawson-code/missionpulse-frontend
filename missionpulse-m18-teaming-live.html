<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teaming Partners | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; }
        body { background: linear-gradient(135deg, #00050F 0%, #001a2c 50%, #00050F 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); backdrop-filter: blur(10px); }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #00E5FA, #00b8d4); color: #00050F; font-weight: 600; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
        .size-large { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .size-small { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .size-sdvosb { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .size-8a { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .size-hubzone { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
        .size-wosb { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .status-identified { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .status-contacted { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .status-nda-signed { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .status-ta-signed { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .status-active-partner { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status-inactive { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .status-do-not-use { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .value-critical { color: #f87171; }
        .value-high { color: #fb923c; }
        .value-medium { color: #facc15; }
        .value-low { color: #9ca3af; }
        .strength-star { color: #facc15; }
        .strength-empty { color: #374151; }
        .tag { background: rgba(0, 229, 250, 0.15); color: #00E5FA; font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; }
        .differentiator { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); }
    </style>
</head>
<body class="text-white font-sans">
    <!-- Header -->
    <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-cyan-400 hover:text-cyan-300"><i class="fas fa-arrow-left"></i></a>
                <div>
                    <h1 class="text-xl font-bold text-cyan-400"><i class="fas fa-handshake mr-2"></i>Teaming Partners</h1>
                    <p class="text-xs text-gray-400">Partner Relationship & Capability Management</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="connectionStatus" class="text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400">
                    <i class="fas fa-circle text-[8px] mr-1"></i> Connecting...
                </span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-cyan-400" id="totalPartners">0</div>
                <div class="text-xs text-gray-400">Total Partners</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-400" id="activePartners">0</div>
                <div class="text-xs text-gray-400">Active</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-400" id="ndaSigned">0</div>
                <div class="text-xs text-gray-400">NDA/TA Signed</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-400" id="smallBizCount">0</div>
                <div class="text-xs text-gray-400">Small Business</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-400" id="criticalPartners">0</div>
                <div class="text-xs text-gray-400">Critical Value</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" onkeyup="filterPartners()" placeholder="Search partners, capabilities, NAICS..." class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
            </div>
            <select id="filterSize" onchange="filterPartners()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Sizes</option>
                <option value="Large">Large</option>
                <option value="Small">Small</option>
                <option value="SDVOSB">SDVOSB</option>
                <option value="8(a)">8(a)</option>
                <option value="HUBZone">HUBZone</option>
                <option value="WOSB">WOSB</option>
            </select>
            <select id="filterStatus" onchange="filterPartners()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Statuses</option>
                <option value="Identified">Identified</option>
                <option value="Contacted">Contacted</option>
                <option value="NDA Signed">NDA Signed</option>
                <option value="TA Signed">TA Signed</option>
                <option value="Active Partner">Active Partner</option>
            </select>
            <select id="filterValue" onchange="filterPartners()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
                <option value="">All Values</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
            </select>
            <button onclick="openPartnerModal()" class="btn-primary px-4 py-2 rounded text-sm">
                <i class="fas fa-plus mr-2"></i>Add Partner
            </button>
        </div>

        <!-- Partners Grid -->
        <div id="partnersGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="glass-card rounded-lg p-8 text-center text-gray-500 col-span-full">
                <i class="fas fa-handshake text-4xl mb-4 opacity-50"></i>
                <p>Loading teaming partners...</p>
            </div>
        </div>
    </main>

    <!-- Partner Modal -->
    <div id="partnerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-card rounded-xl max-w-4xl w-full p-6 my-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-building mr-2"></i><span id="modalTitle">Add Partner</span></h3>
                <button onclick="closePartnerModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="partnerForm" onsubmit="savePartner(event)" class="space-y-6">
                <input type="hidden" id="partnerId">
                
                <!-- Company Info -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Company Name <span class="text-red-400">*</span></label>
                        <input type="text" id="companyName" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Website</label>
                        <input type="url" id="website" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="https://">
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">DUNS</label>
                        <input type="text" id="dunsNumber" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="9 digits">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">CAGE Code</label>
                        <input type="text" id="cageCode" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="5 chars">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">UEI</label>
                        <input type="text" id="uei" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="12 chars">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">HQ Location</label>
                        <input type="text" id="hqLocation" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="City, State">
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Company Size</label>
                        <select id="companySize" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Small">Small Business</option>
                            <option value="SDVOSB">SDVOSB</option>
                            <option value="8(a)">8(a)</option>
                            <option value="HUBZone">HUBZone</option>
                            <option value="WOSB">WOSB</option>
                            <option value="EDWOSB">EDWOSB</option>
                            <option value="Large">Large Business</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Annual Revenue</label>
                        <input type="number" id="annualRevenue" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 50000000">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Employees</label>
                        <input type="number" id="employeeCount" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 250">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Clearance Level</label>
                        <select id="clearanceLevel" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="None">None</option>
                            <option value="Public Trust">Public Trust</option>
                            <option value="Secret">Secret</option>
                            <option value="Top Secret">Top Secret</option>
                            <option value="TS/SCI">TS/SCI</option>
                        </select>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Primary NAICS (comma separated)</label>
                        <input type="text" id="primaryNaics" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="541512, 541519, 518210">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Contract Vehicles (comma separated)</label>
                        <input type="text" id="contractVehicles" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="T4NG, VETS2, CIO-SP3">
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Relationship Status</label>
                        <select id="relationshipStatus" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Identified">Identified</option>
                            <option value="Contacted">Contacted</option>
                            <option value="NDA Signed">NDA Signed</option>
                            <option value="TA Signed">TA Signed</option>
                            <option value="Active Partner">Active Partner</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Do Not Use">Do Not Use</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Strategic Value</label>
                        <select id="strategicValue" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Medium">Medium</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Relationship Strength (1-5)</label>
                        <select id="relationshipStrength" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="1">1 - Cold</option>
                            <option value="2">2 - Acquainted</option>
                            <option value="3" selected>3 - Developing</option>
                            <option value="4">4 - Strong</option>
                            <option value="5">5 - Strategic Alliance</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Past Performance Summary</label>
                    <textarea id="ppSummary" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Key contracts, agencies served, notable achievements..."></textarea>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Notes</label>
                    <textarea id="notes" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Internal notes about this partner..."></textarea>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closePartnerModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save Partner</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Capability Modal -->
    <div id="capabilityModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-xl max-w-lg w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-cogs mr-2"></i>Add Capability</h3>
                <button onclick="closeCapabilityModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="capabilityForm" onsubmit="saveCapability(event)" class="space-y-4">
                <input type="hidden" id="capId">
                <input type="hidden" id="capPartnerId">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Capability Area <span class="text-red-400">*</span></label>
                    <input type="text" id="capArea" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., Cloud Migration, Cybersecurity, EHR Integration">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Description</label>
                    <textarea id="capDescription" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Detailed capability description..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Years Experience</label>
                        <input type="number" id="capYears" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" min="0" max="50">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Certifications</label>
                        <input type="text" id="capCerts" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="AWS, CISSP, PMP">
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="capDifferentiator" class="rounded">
                    <label for="capDifferentiator" class="text-sm text-gray-400">This is a key differentiator</label>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeCapabilityModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-xl max-w-lg w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-user mr-2"></i>Add Contact</h3>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="contactForm" onsubmit="saveContact(event)" class="space-y-4">
                <input type="hidden" id="contactId">
                <input type="hidden" id="contactPartnerId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name <span class="text-red-400">*</span></label>
                        <input type="text" id="contactName" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Title</label>
                        <input type="text" id="contactTitle" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <input type="email" id="contactEmail" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Phone</label>
                        <input type="tel" id="contactPhone" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">LinkedIn</label>
                    <input type="url" id="contactLinkedin" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="https://linkedin.com/in/...">
                </div>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="contactPrimary" class="rounded"> Primary Contact
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="contactBD" class="rounded"> BD Contact
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-400">
                        <input type="checkbox" id="contactTech" class="rounded"> Technical Contact
                    </label>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeContactModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-card rounded-xl max-w-5xl w-full p-6 my-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400" id="detailTitle">Partner Details</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-cyan-500/10 mt-12 py-6 text-center text-xs text-gray-500">
        <p>AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
        <p class="mt-1">MissionPulse v2.0 | Mission Meets Tech | Shield & Pulse UX v8.0</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTc0NjMsImV4cCI6MjA1Mjk5MzQ2M30.GXfKRTONeK0kCHk9WJzJzeG3sEaH15uPlFwczw4MXCg';
        
        let supabase;
        let partners = [], capabilities = [], contacts = [];

        // Demo Data
        const demoPartners = [
            { id: 'p1', company_name: 'TechForward Solutions', cage_code: '8XY12', uei: 'ABC123456789', website: 'https://techforward.com', headquarters_location: 'Reston, VA', company_size: 'SDVOSB', annual_revenue: 45000000, employee_count: 180, clearance_level: 'Top Secret', primary_naics: ['541512', '541519'], contract_vehicles: ['T4NG', 'VETS2', 'CIO-SP3'], relationship_status: 'Active Partner', relationship_strength: 5, strategic_value: 'Critical', past_performance_summary: 'VA, DHA, Army contracts. Strong EHR and cybersecurity capabilities.' },
            { id: 'p2', company_name: 'DataBridge Federal', cage_code: '7WZ89', uei: 'DEF987654321', website: 'https://databridgefed.com', headquarters_location: 'Columbia, MD', company_size: '8(a)', annual_revenue: 28000000, employee_count: 95, clearance_level: 'Secret', primary_naics: ['541511', '518210'], contract_vehicles: ['Alliant 2', 'SEWP V'], relationship_status: 'TA Signed', relationship_strength: 4, strategic_value: 'High', past_performance_summary: 'CMS and HHS data analytics work. AWS certified partner.' },
            { id: 'p3', company_name: 'CyberShield Inc', cage_code: '5AB34', uei: 'GHI456789012', website: 'https://cybershield.com', headquarters_location: 'Arlington, VA', company_size: 'Small', annual_revenue: 62000000, employee_count: 220, clearance_level: 'TS/SCI', primary_naics: ['541519', '561621'], contract_vehicles: ['GSA MAS', 'ITES-3S'], relationship_status: 'NDA Signed', relationship_strength: 3, strategic_value: 'High', past_performance_summary: 'DoD cyber operations. FedRAMP authorized solutions.' },
            { id: 'p4', company_name: 'Apex Health IT', cage_code: '9CD56', uei: 'JKL789012345', website: 'https://apexhealthit.com', headquarters_location: 'Bethesda, MD', company_size: 'HUBZone', annual_revenue: 18000000, employee_count: 65, clearance_level: 'Public Trust', primary_naics: ['541512', '621999'], contract_vehicles: ['CIO-SP3 SB'], relationship_status: 'Contacted', relationship_strength: 2, strategic_value: 'Medium', past_performance_summary: 'IHS and state health department contracts.' },
            { id: 'p5', company_name: 'Quantum Defense Systems', cage_code: '2EF78', uei: 'MNO012345678', website: 'https://quantumdefense.com', headquarters_location: 'McLean, VA', company_size: 'Large', annual_revenue: 850000000, employee_count: 3200, clearance_level: 'TS/SCI', primary_naics: ['541330', '541512'], contract_vehicles: ['OASIS', 'Alliant 2'], relationship_status: 'Active Partner', relationship_strength: 4, strategic_value: 'Critical', past_performance_summary: 'Major DoD primes. Strong mentor-protege interest.' }
        ];
        const demoCapabilities = [
            { id: 'cap1', partner_id: 'p1', capability_area: 'EHR Implementation', capability_description: 'Full lifecycle EHR deployment and integration', experience_years: 12, certifications: ['Epic', 'Cerner'], is_differentiator: true },
            { id: 'cap2', partner_id: 'p1', capability_area: 'Cybersecurity Operations', capability_description: 'SOC operations, threat hunting, incident response', experience_years: 8, certifications: ['CISSP', 'CEH'], is_differentiator: false },
            { id: 'cap3', partner_id: 'p2', capability_area: 'Data Analytics', capability_description: 'Healthcare data analytics and predictive modeling', experience_years: 10, certifications: ['AWS ML', 'Tableau'], is_differentiator: true },
            { id: 'cap4', partner_id: 'p3', capability_area: 'Zero Trust Architecture', capability_description: 'Zero trust implementation and assessment', experience_years: 6, certifications: ['CISSP', 'CCSP'], is_differentiator: true },
            { id: 'cap5', partner_id: 'p5', capability_area: 'Cloud Migration', capability_description: 'Large-scale cloud migration and modernization', experience_years: 15, certifications: ['AWS SAP', 'Azure Expert'], is_differentiator: false }
        ];
        const demoContacts = [
            { id: 'c1', partner_id: 'p1', name: 'Robert Chen', title: 'VP Business Development', email: 'rchen@techforward.com', phone: '703-555-0111', is_primary: true, is_bd_contact: true },
            { id: 'c2', partner_id: 'p1', name: 'Amanda Foster', title: 'Technical Director', email: 'afoster@techforward.com', phone: '703-555-0112', is_technical_contact: true },
            { id: 'c3', partner_id: 'p2', name: 'David Kim', title: 'CEO', email: 'dkim@databridgefed.com', phone: '410-555-0201', is_primary: true },
            { id: 'c4', partner_id: 'p3', name: 'Jennifer Walsh', title: 'BD Manager', email: 'jwalsh@cybershield.com', phone: '703-555-0301', is_bd_contact: true },
            { id: 'c5', partner_id: 'p5', name: 'Michael Torres', title: 'Capture Director', email: 'mtorres@quantumdefense.com', phone: '703-555-0501', is_primary: true, is_bd_contact: true }
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const [pRes, capRes, conRes] = await Promise.all([
                    supabase.from('teaming_partners').select('*').order('company_name'),
                    supabase.from('teaming_partner_capabilities').select('*'),
                    supabase.from('teaming_partner_contacts').select('*')
                ]);
                partners = pRes.data?.length ? pRes.data : demoPartners;
                capabilities = capRes.data?.length ? capRes.data : demoCapabilities;
                contacts = conRes.data?.length ? conRes.data : demoContacts;
                updateStatus('connected', 'Live');
            } catch (e) {
                console.log('Demo mode:', e.message);
                partners = demoPartners;
                capabilities = demoCapabilities;
                contacts = demoContacts;
                updateStatus('demo', 'Demo Mode');
            }
            updateStats();
            renderPartners();
        }

        function updateStatus(type, text) {
            const el = document.getElementById('connectionStatus');
            el.className = type === 'connected' 
                ? 'text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400'
                : 'text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            el.innerHTML = `<i class="fas fa-circle text-[8px] mr-1"></i> ${text}`;
        }

        function updateStats() {
            const active = partners.filter(p => p.relationship_status === 'Active Partner').length;
            const ndaTa = partners.filter(p => ['NDA Signed', 'TA Signed'].includes(p.relationship_status)).length;
            const smallBiz = partners.filter(p => ['Small', 'SDVOSB', '8(a)', 'HUBZone', 'WOSB', 'EDWOSB'].includes(p.company_size)).length;
            const critical = partners.filter(p => p.strategic_value === 'Critical').length;

            document.getElementById('totalPartners').textContent = partners.length;
            document.getElementById('activePartners').textContent = active;
            document.getElementById('ndaSigned').textContent = ndaTa;
            document.getElementById('smallBizCount').textContent = smallBiz;
            document.getElementById('criticalPartners').textContent = critical;
        }

        function filterPartners() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const size = document.getElementById('filterSize').value;
            const status = document.getElementById('filterStatus').value;
            const value = document.getElementById('filterValue').value;

            const filtered = partners.filter(p => {
                if (search && !JSON.stringify(p).toLowerCase().includes(search)) {
                    const partnerCaps = capabilities.filter(c => c.partner_id === p.id);
                    if (!partnerCaps.some(c => JSON.stringify(c).toLowerCase().includes(search))) return false;
                }
                if (size && p.company_size !== size) return false;
                if (status && p.relationship_status !== status) return false;
                if (value && p.strategic_value !== value) return false;
                return true;
            });
            renderPartners(filtered);
        }

        function renderPartners(list = partners) {
            const grid = document.getElementById('partnersGrid');
            if (!list.length) {
                grid.innerHTML = `<div class="glass-card rounded-lg p-8 text-center text-gray-500 col-span-full">
                    <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                    <p>No partners found matching your criteria</p>
                </div>`;
                return;
            }

            grid.innerHTML = list.map(p => {
                const sizeClass = `size-${p.company_size?.toLowerCase().replace(/[()]/g, '')}`;
                const statusClass = `status-${p.relationship_status?.toLowerCase().replace(/\s+/g, '-')}`;
                const valueClass = `value-${p.strategic_value?.toLowerCase()}`;
                const naics = p.primary_naics || [];
                const vehicles = p.contract_vehicles || [];
                const partnerCaps = capabilities.filter(c => c.partner_id === p.id);
                const differentiators = partnerCaps.filter(c => c.is_differentiator);
                const contactCount = contacts.filter(c => c.partner_id === p.id).length;
                const stars = renderStars(p.relationship_strength || 3);

                return `
                    <div class="glass-card rounded-lg p-4 cursor-pointer hover:border-cyan-400/50 transition-all" onclick="showDetail('${p.id}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-white truncate">${p.company_name}</h4>
                                <p class="text-xs text-gray-400">${p.headquarters_location || 'Location TBD'}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${sizeClass}">${p.company_size}</span>
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs px-2 py-1 rounded ${statusClass}">${p.relationship_status}</span>
                            <span class="text-xs ${valueClass}">${p.strategic_value || 'Medium'} Value</span>
                        </div>
                        <div class="mb-3">${stars}</div>
                        <div class="space-y-1 text-xs text-gray-400 mb-3">
                            <div><i class="fas fa-shield-alt w-4"></i> ${p.clearance_level || 'None'}</div>
                            <div><i class="fas fa-users w-4"></i> ${p.employee_count || '?'} employees</div>
                            ${p.annual_revenue ? `<div><i class="fas fa-dollar-sign w-4"></i> $${(p.annual_revenue / 1000000).toFixed(0)}M revenue</div>` : ''}
                        </div>
                        ${differentiators.length ? `
                            <div class="flex flex-wrap gap-1 mb-3">
                                ${differentiators.slice(0, 2).map(d => `<span class="tag differentiator"><i class="fas fa-star text-[8px] mr-1"></i>${d.capability_area}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${naics.slice(0, 2).map(n => `<span class="tag">${n}</span>`).join('')}
                            ${vehicles.slice(0, 1).map(v => `<span class="tag">${v}</span>`).join('')}
                        </div>
                        <div class="flex items-center justify-between pt-3 border-t border-gray-700/50 text-xs text-gray-500">
                            <span><i class="fas fa-user mr-1"></i>${contactCount} contacts</span>
                            <span><i class="fas fa-cogs mr-1"></i>${partnerCaps.length} capabilities</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStars(strength) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<i class="fas fa-star text-xs ${i <= strength ? 'strength-star' : 'strength-empty'}"></i>`;
            }
            return html;
        }

        function showDetail(id) {
            const p = partners.find(x => x.id === id);
            if (!p) return;
            const partnerCaps = capabilities.filter(c => c.partner_id === id);
            const partnerContacts = contacts.filter(c => c.partner_id === id);
            
            document.getElementById('detailTitle').innerHTML = `<i class="fas fa-building mr-2"></i>${p.company_name}`;
            document.getElementById('detailContent').innerHTML = `
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-info-circle mr-2"></i>Company Info</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Size:</span><span class="px-2 py-0.5 rounded size-${p.company_size?.toLowerCase().replace(/[()]/g, '')}">${p.company_size}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">CAGE:</span><span>${p.cage_code || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">UEI:</span><span>${p.uei || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Location:</span><span>${p.headquarters_location || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Employees:</span><span>${p.employee_count || '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Revenue:</span><span>${p.annual_revenue ? '$' + (p.annual_revenue / 1000000).toFixed(0) + 'M' : '-'}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Clearance:</span><span>${p.clearance_level || 'None'}</span></div>
                                ${p.website ? `<div><a href="${p.website}" target="_blank" class="text-cyan-400 hover:underline text-xs"><i class="fas fa-external-link-alt mr-1"></i>Website</a></div>` : ''}
                            </div>
                        </div>
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-handshake mr-2"></i>Relationship</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span class="text-gray-400">Status:</span><span class="px-2 py-0.5 rounded status-${p.relationship_status?.toLowerCase().replace(/\s+/g, '-')}">${p.relationship_status}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Value:</span><span class="value-${p.strategic_value?.toLowerCase()}">${p.strategic_value || 'Medium'}</span></div>
                                <div class="flex justify-between items-center"><span class="text-gray-400">Strength:</span><span>${renderStars(p.relationship_strength || 3)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="glass-card rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-cyan-400"><i class="fas fa-cogs mr-2"></i>Capabilities</h4>
                                <button onclick="event.stopPropagation(); openCapabilityModal('${id}')" class="text-xs text-cyan-400 hover:text-cyan-300"><i class="fas fa-plus mr-1"></i>Add</button>
                            </div>
                            ${partnerCaps.length ? partnerCaps.map(c => `
                                <div class="p-2 ${c.is_differentiator ? 'bg-green-500/10 border border-green-500/30' : 'bg-gray-800/50'} rounded mb-2">
                                    <div class="flex justify-between items-start">
                                        <span class="font-medium text-sm">${c.capability_area}</span>
                                        ${c.is_differentiator ? '<span class="text-xs text-green-400"><i class="fas fa-star"></i></span>' : ''}
                                    </div>
                                    ${c.capability_description ? `<p class="text-xs text-gray-400 mt-1">${c.capability_description}</p>` : ''}
                                    <div class="flex gap-2 mt-1 text-xs text-gray-500">
                                        ${c.experience_years ? `<span>${c.experience_years}+ years</span>` : ''}
                                        ${c.certifications?.length ? `<span>${c.certifications.join(', ')}</span>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<p class="text-sm text-gray-500">No capabilities added</p>'}
                        </div>
                        <div class="glass-card rounded-lg p-4">
                            <h4 class="text-sm font-medium text-cyan-400 mb-3"><i class="fas fa-certificate mr-2"></i>Contract Vehicles</h4>
                            <div class="flex flex-wrap gap-2">
                                ${(p.contract_vehicles || []).map(v => `<span class="tag">${v}</span>`).join('') || '<span class="text-sm text-gray-500">None listed</span>'}
                            </div>
                            <h4 class="text-sm font-medium text-cyan-400 mt-4 mb-2"><i class="fas fa-hashtag mr-2"></i>NAICS Codes</h4>
                            <div class="flex flex-wrap gap-2">
                                ${(p.primary_naics || []).map(n => `<span class="tag">${n}</span>`).join('') || '<span class="text-sm text-gray-500">None listed</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="glass-card rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-medium text-cyan-400"><i class="fas fa-users mr-2"></i>Contacts</h4>
                                <button onclick="event.stopPropagation(); openContactModal('${id}')" class="text-xs text-cyan-400 hover:text-cyan-300"><i class="fas fa-plus mr-1"></i>Add</button>
                            </div>
                            ${partnerContacts.length ? partnerContacts.map(c => `
                                <div class="p-2 bg-gray-800/50 rounded mb-2">
                                    <div class="flex justify-between">
                                        <span class="font-medium text-sm">${c.name}</span>
                                        <div class="flex gap-1">
                                            ${c.is_primary ? '<span class="text-xs text-cyan-400" title="Primary"><i class="fas fa-star"></i></span>' : ''}
                                            ${c.is_bd_contact ? '<span class="text-xs text-green-400" title="BD"><i class="fas fa-briefcase"></i></span>' : ''}
                                            ${c.is_technical_contact ? '<span class="text-xs text-purple-400" title="Technical"><i class="fas fa-code"></i></span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-400">${c.title || ''}</div>
                                    <div class="text-xs text-cyan-400">${c.email || ''}</div>
                                    <div class="text-xs text-gray-500">${c.phone || ''}</div>
                                </div>
                            `).join('') : '<p class="text-sm text-gray-500">No contacts added</p>'}
                        </div>
                        ${p.past_performance_summary ? `
                            <div class="glass-card rounded-lg p-4">
                                <h4 class="text-sm font-medium text-cyan-400 mb-2"><i class="fas fa-trophy mr-2"></i>Past Performance</h4>
                                <p class="text-sm text-gray-300">${p.past_performance_summary}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="flex gap-3 mt-6 pt-4 border-t border-gray-700">
                    <button onclick="editPartner('${id}')" class="btn-primary px-4 py-2 rounded text-sm"><i class="fas fa-edit mr-2"></i>Edit</button>
                    <button onclick="deletePartner('${id}')" class="px-4 py-2 border border-red-500/50 text-red-400 rounded text-sm hover:bg-red-500/10"><i class="fas fa-trash mr-2"></i>Delete</button>
                    <button onclick="advanceStatus('${id}')" class="px-4 py-2 border border-cyan-500/50 text-cyan-400 rounded text-sm hover:bg-cyan-500/10"><i class="fas fa-arrow-right mr-2"></i>Advance Status</button>
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal() { document.getElementById('detailModal').classList.add('hidden'); }

        // Partner CRUD
        function openPartnerModal() {
            document.getElementById('partnerForm').reset();
            document.getElementById('partnerId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Partner';
            document.getElementById('partnerModal').classList.remove('hidden');
        }

        function closePartnerModal() { document.getElementById('partnerModal').classList.add('hidden'); }

        function editPartner(id) {
            closeDetailModal();
            const p = partners.find(x => x.id === id);
            if (!p) return;
            document.getElementById('partnerId').value = p.id;
            document.getElementById('companyName').value = p.company_name;
            document.getElementById('website').value = p.website || '';
            document.getElementById('dunsNumber').value = p.duns_number || '';
            document.getElementById('cageCode').value = p.cage_code || '';
            document.getElementById('uei').value = p.uei || '';
            document.getElementById('hqLocation').value = p.headquarters_location || '';
            document.getElementById('companySize').value = p.company_size || 'Small';
            document.getElementById('annualRevenue').value = p.annual_revenue || '';
            document.getElementById('employeeCount').value = p.employee_count || '';
            document.getElementById('clearanceLevel').value = p.clearance_level || 'None';
            document.getElementById('primaryNaics').value = (p.primary_naics || []).join(', ');
            document.getElementById('contractVehicles').value = (p.contract_vehicles || []).join(', ');
            document.getElementById('relationshipStatus').value = p.relationship_status || 'Identified';
            document.getElementById('strategicValue').value = p.strategic_value || 'Medium';
            document.getElementById('relationshipStrength').value = p.relationship_strength || 3;
            document.getElementById('ppSummary').value = p.past_performance_summary || '';
            document.getElementById('notes').value = p.notes || '';
            document.getElementById('modalTitle').textContent = 'Edit Partner';
            document.getElementById('partnerModal').classList.remove('hidden');
        }

        async function savePartner(e) {
            e.preventDefault();
            const id = document.getElementById('partnerId').value;
            const data = {
                company_name: document.getElementById('companyName').value,
                website: document.getElementById('website').value || null,
                duns_number: document.getElementById('dunsNumber').value || null,
                cage_code: document.getElementById('cageCode').value || null,
                uei: document.getElementById('uei').value || null,
                headquarters_location: document.getElementById('hqLocation').value || null,
                company_size: document.getElementById('companySize').value,
                annual_revenue: parseFloat(document.getElementById('annualRevenue').value) || null,
                employee_count: parseInt(document.getElementById('employeeCount').value) || null,
                clearance_level: document.getElementById('clearanceLevel').value,
                primary_naics: document.getElementById('primaryNaics').value.split(',').map(s => s.trim()).filter(Boolean),
                contract_vehicles: document.getElementById('contractVehicles').value.split(',').map(s => s.trim()).filter(Boolean),
                relationship_status: document.getElementById('relationshipStatus').value,
                strategic_value: document.getElementById('strategicValue').value,
                relationship_strength: parseInt(document.getElementById('relationshipStrength').value),
                past_performance_summary: document.getElementById('ppSummary').value || null,
                notes: document.getElementById('notes').value || null,
                updated_at: new Date().toISOString()
            };

            try {
                if (id) {
                    await supabase.from('teaming_partners').update(data).eq('id', id);
                    const idx = partners.findIndex(p => p.id === id);
                    if (idx >= 0) partners[idx] = { ...partners[idx], ...data };
                } else {
                    const { data: newP } = await supabase.from('teaming_partners').insert([data]).select().single();
                    if (newP) partners.unshift(newP);
                    else partners.unshift({ id: 'p' + Date.now(), ...data });
                }
            } catch (e) {
                if (id) {
                    const idx = partners.findIndex(p => p.id === id);
                    if (idx >= 0) partners[idx] = { ...partners[idx], ...data };
                } else {
                    partners.unshift({ id: 'p' + Date.now(), ...data });
                }
            }

            closePartnerModal();
            updateStats();
            renderPartners();
        }

        async function deletePartner(id) {
            if (!confirm('Delete this partner and all related data?')) return;
            try { await supabase.from('teaming_partners').delete().eq('id', id); } catch (e) {}
            partners = partners.filter(p => p.id !== id);
            capabilities = capabilities.filter(c => c.partner_id !== id);
            contacts = contacts.filter(c => c.partner_id !== id);
            closeDetailModal();
            updateStats();
            renderPartners();
        }

        async function advanceStatus(id) {
            const p = partners.find(x => x.id === id);
            if (!p) return;
            const statusOrder = ['Identified', 'Contacted', 'NDA Signed', 'TA Signed', 'Active Partner'];
            const currentIdx = statusOrder.indexOf(p.relationship_status);
            if (currentIdx < statusOrder.length - 1) {
                const newStatus = statusOrder[currentIdx + 1];
                p.relationship_status = newStatus;
                try { await supabase.from('teaming_partners').update({ relationship_status: newStatus }).eq('id', id); } catch (e) {}
                showDetail(id);
                updateStats();
                renderPartners();
            }
        }

        // Capability CRUD
        function openCapabilityModal(partnerId) {
            document.getElementById('capabilityForm').reset();
            document.getElementById('capId').value = '';
            document.getElementById('capPartnerId').value = partnerId;
            document.getElementById('capabilityModal').classList.remove('hidden');
        }

        function closeCapabilityModal() { document.getElementById('capabilityModal').classList.add('hidden'); }

        async function saveCapability(e) {
            e.preventDefault();
            const data = {
                partner_id: document.getElementById('capPartnerId').value,
                capability_area: document.getElementById('capArea').value,
                capability_description: document.getElementById('capDescription').value || null,
                experience_years: parseInt(document.getElementById('capYears').value) || null,
                certifications: document.getElementById('capCerts').value.split(',').map(s => s.trim()).filter(Boolean),
                is_differentiator: document.getElementById('capDifferentiator').checked
            };

            try {
                const { data: newC } = await supabase.from('teaming_partner_capabilities').insert([data]).select().single();
                if (newC) capabilities.push(newC);
                else capabilities.push({ id: 'cap' + Date.now(), ...data });
            } catch (e) {
                capabilities.push({ id: 'cap' + Date.now(), ...data });
            }

            closeCapabilityModal();
            showDetail(data.partner_id);
        }

        // Contact CRUD
        function openContactModal(partnerId) {
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            document.getElementById('contactPartnerId').value = partnerId;
            document.getElementById('contactModal').classList.remove('hidden');
        }

        function closeContactModal() { document.getElementById('contactModal').classList.add('hidden'); }

        async function saveContact(e) {
            e.preventDefault();
            const data = {
                partner_id: document.getElementById('contactPartnerId').value,
                name: document.getElementById('contactName').value,
                title: document.getElementById('contactTitle').value || null,
                email: document.getElementById('contactEmail').value || null,
                phone: document.getElementById('contactPhone').value || null,
                linkedin: document.getElementById('contactLinkedin').value || null,
                is_primary: document.getElementById('contactPrimary').checked,
                is_bd_contact: document.getElementById('contactBD').checked,
                is_technical_contact: document.getElementById('contactTech').checked
            };

            try {
                const { data: newC } = await supabase.from('teaming_partner_contacts').insert([data]).select().single();
                if (newC) contacts.push(newC);
                else contacts.push({ id: 'c' + Date.now(), ...data });
            } catch (e) {
                contacts.push({ id: 'c' + Date.now(), ...data });
            }

            closeContactModal();
            showDetail(data.partner_id);
        }

        init();
    </script>
</body>
</html>
