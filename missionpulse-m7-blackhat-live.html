<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Hat Analysis | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: linear-gradient(135deg, #00050F 0%, #000A1A 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); border-radius: 0.75rem; }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .cyan-glow { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
        .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #00B8D4 100%); color: #00050F; font-weight: 600; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .threat-high { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); }
        .threat-medium { background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.5); }
        .threat-low { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.5); }
        .swot-strength { border-left: 4px solid #22C55E; }
        .swot-weakness { border-left: 4px solid #EF4444; }
        .swot-opportunity { border-left: 4px solid #3B82F6; }
        .swot-threat { border-left: 4px solid #F59E0B; }
    </style>
</head>
<body class="text-white font-sans">
    <div id="missionpulse-sidebar" data-current-page="blackhat"></div>
    <script src="missionpulse-nav.js"></script>

    <div class="main-content" style="margin-left: 260px;">
        <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-3xl">ðŸŽ­</div>
                        <div>
                            <h1 class="text-2xl font-bold text-cyan-400">Black Hat Analysis</h1>
                            <p class="text-white/50 text-sm">Competitor intelligence and SWOT analysis</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="opportunitySelect" onchange="loadCompetitors()" class="bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white">
                            <option value="">Select Opportunity</option>
                        </select>
                        <div id="connectionStatus" class="flex items-center gap-2 text-sm">
                            <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                            <span class="text-white/50">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Add Competitor -->
            <div class="glass-card cyan-glow p-6 mb-8">
                <h2 class="text-lg font-semibold text-cyan-400 mb-4">Add Competitor</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="compName" placeholder="Competitor Name" class="bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white">
                    <select id="compThreat" class="bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white">
                        <option value="high">High Threat</option>
                        <option value="medium">Medium Threat</option>
                        <option value="low">Low Threat</option>
                    </select>
                    <input type="number" id="compPwin" placeholder="Est. pWin %" min="0" max="100" class="bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white">
                    <button onclick="addCompetitor()" class="btn-primary rounded-lg">+ Add Competitor</button>
                </div>
            </div>

            <!-- Competitors Grid -->
            <div id="competitorsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Populated by JS -->
            </div>

            <!-- Ghosts & Landmines -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-cyan-400">ðŸ‘» Ghosts (Counter Their Strengths)</h2>
                        <button onclick="addGhost()" class="text-cyan-400 hover:text-cyan-300 text-sm">+ Add</button>
                    </div>
                    <div id="ghostsList" class="space-y-2"></div>
                </div>
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-yellow-400">ðŸ’£ Landmines (Exploit Their Weaknesses)</h2>
                        <button onclick="addLandmine()" class="text-yellow-400 hover:text-yellow-300 text-sm">+ Add</button>
                    </div>
                    <div id="landminesList" class="space-y-2"></div>
                </div>
            </div>
        </main>

        <footer class="border-t border-cyan-500/20 mt-12">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <p class="text-center text-white/30 text-xs">AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
            </div>
        </footer>
    </div>

    <script>
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTMwNjIsImV4cCI6MjA1Mjk4OTA2Mn0.gwBTnfAtsxSFDz96fDPL7HAIYdA5s_9hiv_l0ECWvYc';
        
        let supabase, isLive = false, currentOpp = null;
        let competitors = [], ghosts = [], landmines = [];

        const demoCompetitors = [
            { id: 1, name: 'Leidos', threat_level: 'high', estimated_pwin: 70, strengths: ['Incumbent', 'Strong past performance'], weaknesses: ['High rates', 'Staff turnover'] },
            { id: 2, name: 'CACI', threat_level: 'medium', estimated_pwin: 55, strengths: ['Technical depth', 'Cleared staff'], weaknesses: ['No incumbency', 'Limited healthcare experience'] },
            { id: 3, name: 'Booz Allen', threat_level: 'high', estimated_pwin: 65, strengths: ['Consulting reputation', 'Analytics capability'], weaknesses: ['Premium pricing', 'High overhead'] }
        ];

        const demoGhosts = [
            { id: 1, text: 'Emphasize our 15% lower rates vs incumbent', competitor: 'Leidos' },
            { id: 2, text: 'Highlight our healthcare IT certifications', competitor: 'CACI' }
        ];

        const demoLandmines = [
            { id: 1, text: 'RFP requires CMMI Level 3 - competitor only has Level 2', competitor: 'CACI' },
            { id: 2, text: 'Ask about staff retention rates in Q&A', competitor: 'Leidos' }
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data, error } = await supabase.from('opportunities').select('id, title, nickname');
                if (!error && data?.length) {
                    isLive = true;
                    updateStatus(true);
                    populateOpportunities(data);
                } else {
                    loadDemo();
                }
            } catch (e) {
                loadDemo();
            }
        }

        function loadDemo() {
            isLive = false;
            updateStatus(false);
            populateOpportunities([{ id: 'demo', title: 'DHA DHMSM Support', nickname: 'DHMSM' }]);
            competitors = [...demoCompetitors];
            ghosts = [...demoGhosts];
            landmines = [...demoLandmines];
            renderAll();
        }

        function updateStatus(live) {
            const el = document.getElementById('connectionStatus');
            el.innerHTML = live ? '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-green-400">Live</span>' : '<div class="w-2 h-2 rounded-full bg-yellow-500"></div><span class="text-yellow-400">Demo</span>';
        }

        function populateOpportunities(opps) {
            const sel = document.getElementById('opportunitySelect');
            sel.innerHTML = '<option value="">Select Opportunity</option>' + opps.map(o => `<option value="${o.id}">${o.nickname || o.title}</option>`).join('');
            if (opps.length === 1) { sel.value = opps[0].id; loadCompetitors(); }
        }

        async function loadCompetitors() {
            currentOpp = document.getElementById('opportunitySelect').value;
            if (!currentOpp) return;
            if (isLive) {
                const { data } = await supabase.from('competitors').select('*').eq('opportunity_id', currentOpp);
                competitors = data || [];
                const { data: g } = await supabase.from('competitor_insights').select('*').eq('opportunity_id', currentOpp).eq('insight_type', 'ghost');
                ghosts = g || [];
                const { data: l } = await supabase.from('competitor_insights').select('*').eq('opportunity_id', currentOpp).eq('insight_type', 'landmine');
                landmines = l || [];
            }
            renderAll();
        }

        function renderAll() {
            renderCompetitors();
            renderGhosts();
            renderLandmines();
        }

        function renderCompetitors() {
            const grid = document.getElementById('competitorsGrid');
            if (!competitors.length) {
                grid.innerHTML = '<div class="col-span-2 text-center text-white/40 py-12">No competitors added yet</div>';
                return;
            }
            grid.innerHTML = competitors.map(c => `
                <div class="glass-card p-5 threat-${c.threat_level}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-white">${c.name}</h3>
                            <span class="text-xs px-2 py-0.5 rounded ${c.threat_level === 'high' ? 'bg-red-500/20 text-red-400' : c.threat_level === 'medium' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'}">${c.threat_level.toUpperCase()} THREAT</span>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-cyan-400">${c.estimated_pwin || '?'}%</div>
                            <div class="text-xs text-white/50">Est. pWin</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-green-400 font-semibold mb-2">STRENGTHS</div>
                            <ul class="text-sm text-white/70 space-y-1">${(c.strengths || []).map(s => `<li class="swot-strength pl-2">${s}</li>`).join('') || '<li class="text-white/40">None listed</li>'}</ul>
                        </div>
                        <div>
                            <div class="text-xs text-red-400 font-semibold mb-2">WEAKNESSES</div>
                            <ul class="text-sm text-white/70 space-y-1">${(c.weaknesses || []).map(w => `<li class="swot-weakness pl-2">${w}</li>`).join('') || '<li class="text-white/40">None listed</li>'}</ul>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-cyan-500/20 flex gap-2">
                        <button onclick="editCompetitor(${c.id})" class="text-xs text-cyan-400 hover:text-cyan-300">Edit</button>
                        <button onclick="deleteCompetitor(${c.id})" class="text-xs text-red-400 hover:text-red-300">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function renderGhosts() {
            const list = document.getElementById('ghostsList');
            list.innerHTML = ghosts.length ? ghosts.map(g => `
                <div class="p-3 bg-white/5 rounded-lg flex justify-between items-start">
                    <div>
                        <div class="text-sm text-white/80">${g.text || g.content}</div>
                        <div class="text-xs text-cyan-400 mt-1">vs ${g.competitor || g.competitor_name}</div>
                    </div>
                    <button onclick="deleteGhost(${g.id})" class="text-red-400 hover:text-red-300 text-xs">Ã—</button>
                </div>
            `).join('') : '<div class="text-white/40 text-sm">No ghosts defined</div>';
        }

        function renderLandmines() {
            const list = document.getElementById('landminesList');
            list.innerHTML = landmines.length ? landmines.map(l => `
                <div class="p-3 bg-white/5 rounded-lg flex justify-between items-start">
                    <div>
                        <div class="text-sm text-white/80">${l.text || l.content}</div>
                        <div class="text-xs text-yellow-400 mt-1">vs ${l.competitor || l.competitor_name}</div>
                    </div>
                    <button onclick="deleteLandmine(${l.id})" class="text-red-400 hover:text-red-300 text-xs">Ã—</button>
                </div>
            `).join('') : '<div class="text-white/40 text-sm">No landmines defined</div>';
        }

        async function addCompetitor() {
            const name = document.getElementById('compName').value.trim();
            const threat = document.getElementById('compThreat').value;
            const pwin = parseInt(document.getElementById('compPwin').value) || 50;
            if (!name || !currentOpp) return alert('Enter competitor name and select opportunity');
            
            const newComp = { id: Date.now(), name, threat_level: threat, estimated_pwin: pwin, strengths: [], weaknesses: [] };
            if (isLive) {
                const { data, error } = await supabase.from('competitors').insert([{ ...newComp, opportunity_id: currentOpp }]).select().single();
                if (!error) newComp.id = data.id;
            }
            competitors.push(newComp);
            document.getElementById('compName').value = '';
            document.getElementById('compPwin').value = '';
            renderCompetitors();
        }

        function addGhost() {
            const text = prompt('Enter ghost strategy (counter their strength):');
            const competitor = prompt('Which competitor?');
            if (!text || !competitor) return;
            ghosts.push({ id: Date.now(), text, competitor });
            renderGhosts();
        }

        function addLandmine() {
            const text = prompt('Enter landmine (exploit their weakness):');
            const competitor = prompt('Which competitor?');
            if (!text || !competitor) return;
            landmines.push({ id: Date.now(), text, competitor });
            renderLandmines();
        }

        function deleteCompetitor(id) { competitors = competitors.filter(c => c.id !== id); renderCompetitors(); }
        function deleteGhost(id) { ghosts = ghosts.filter(g => g.id !== id); renderGhosts(); }
        function deleteLandmine(id) { landmines = landmines.filter(l => l.id !== id); renderLandmines(); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
