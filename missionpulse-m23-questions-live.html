<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questions to Government | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: linear-gradient(135deg, #00050F 0%, #000A1A 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); border-radius: 0.75rem; }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .cyan-glow { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
        .status-draft { background: rgba(107, 114, 128, 0.2); color: #D1D5DB; }
        .status-ready { background: rgba(139, 92, 246, 0.2); color: #C4B5FD; }
        .status-submitted { background: rgba(245, 158, 11, 0.2); color: #FCD34D; }
        .status-answered { background: rgba(16, 185, 129, 0.2); color: #6EE7B7; }
        .status-withdrawn { background: rgba(239, 68, 68, 0.2); color: #FCA5A5; }
        .priority-high { background: rgba(239, 68, 68, 0.2); color: #FCA5A5; }
        .priority-medium { background: rgba(245, 158, 11, 0.2); color: #FCD34D; }
        .priority-low { background: rgba(107, 114, 128, 0.2); color: #D1D5DB; }
        .category-technical { background: rgba(6, 182, 212, 0.2); color: #67E8F9; }
        .category-management { background: rgba(139, 92, 246, 0.2); color: #C4B5FD; }
        .category-pricing { background: rgba(16, 185, 129, 0.2); color: #6EE7B7; }
        .category-contractual { background: rgba(236, 72, 153, 0.2); color: #F9A8D4; }
        .category-past-performance { background: rgba(245, 158, 11, 0.2); color: #FCD34D; }
        .category-clarification { background: rgba(99, 102, 241, 0.2); color: #A5B4FC; }
        .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #00B8D4 100%); color: #00050F; font-weight: 600; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .modal-overlay { background: rgba(0, 5, 15, 0.9); backdrop-filter: blur(4px); }
        .amendment-badge { background: rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); }
    </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="text-white font-sans">
    <!-- Sidebar -->
    <div id="missionpulse-sidebar" data-current-page="questions"></div>
    <script src="missionpulse-nav.js"></script>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 260px;">
        <!-- Header -->
        <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-3xl">‚ùì</div>
                        <div>
                            <h1 class="text-2xl font-bold text-cyan-400">Questions to Government</h1>
                            <p class="text-white/50 text-sm">Track RFP questions and agency responses</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="connectionStatus" class="flex items-center gap-2 text-sm">
                            <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                            <span class="text-white/50">Checking...</span>
                        </div>
                        <button onclick="exportQuestions()" class="px-4 py-2 border border-cyan-500/30 rounded-lg text-cyan-400 hover:bg-cyan-500/10 flex items-center gap-2">
                            <span>üì• Export</span>
                        </button>
                        <button onclick="openModal()" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2">
                            <span>+ Add Question</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <!-- Opportunity Selector -->
            <div class="mb-6">
                <label class="block text-white/60 text-sm mb-2">Select Opportunity</label>
                <select id="opportunitySelect" onchange="loadQuestions()" class="w-full md:w-96 bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-3 text-white focus:border-cyan-400 focus:outline-none">
                    <option value="">Loading opportunities...</option>
                </select>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
                <div class="glass-card p-4 text-center">
                    <div id="statTotal" class="text-2xl font-bold text-cyan-400">0</div>
                    <div class="text-xs text-white/50">Total Questions</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statDraft" class="text-2xl font-bold text-gray-400">0</div>
                    <div class="text-xs text-white/50">Draft</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statReady" class="text-2xl font-bold text-purple-400">0</div>
                    <div class="text-xs text-white/50">Ready</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statSubmitted" class="text-2xl font-bold text-yellow-400">0</div>
                    <div class="text-xs text-white/50">Submitted</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statAnswered" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-white/50">Answered</div>
                </div>
                <div class="glass-card p-4 text-center">
                    <div id="statHighPriority" class="text-2xl font-bold text-red-400">0</div>
                    <div class="text-xs text-white/50">High Priority</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="glass-card p-4 mb-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Category:</label>
                        <select id="filterCategory" onchange="applyFilters()" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white">
                            <option value="">All Categories</option>
                            <option value="technical">Technical</option>
                            <option value="management">Management</option>
                            <option value="pricing">Pricing</option>
                            <option value="contractual">Contractual</option>
                            <option value="past-performance">Past Performance</option>
                            <option value="clarification">Clarification</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Status:</label>
                        <select id="filterStatus" onchange="applyFilters()" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="ready">Ready to Submit</option>
                            <option value="submitted">Submitted</option>
                            <option value="answered">Answered</option>
                            <option value="withdrawn">Withdrawn</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-white/60 text-sm">Priority:</label>
                        <select id="filterPriority" onchange="applyFilters()" class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white">
                            <option value="">All Priority</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-white/60 text-sm cursor-pointer">
                            <input type="checkbox" id="filterAmendment" onchange="applyFilters()" class="rounded bg-black/40 border-cyan-500/30">
                            Amendment Related
                        </label>
                    </div>
                    <div class="ml-auto">
                        <input type="text" id="searchBox" onkeyup="applyFilters()" placeholder="Search questions..." class="bg-black/40 border border-cyan-500/30 rounded px-3 py-1.5 text-sm text-white w-48">
                    </div>
                </div>
            </div>

            <!-- Questions List -->
            <div id="questionsList" class="space-y-4">
                <div class="glass-card p-8 text-center text-white/40">Select an opportunity to view questions</div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="border-t border-cyan-500/20 mt-12">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <p class="text-center text-white/30 text-xs">AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
                <p class="text-center text-white/20 text-xs mt-1">¬© 2025 Mission Meets Tech. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Add/Edit Modal -->
    <div id="questionModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-cyan-500/20 flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-bold text-cyan-400">Add Question</h3>
                <button onclick="closeModal()" class="text-white/50 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="questionForm" onsubmit="saveQuestion(event)" class="p-6 space-y-4">
                <input type="hidden" id="questionId">
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Question # </label>
                        <input type="text" id="questionNumber" placeholder="e.g., Q-001" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Category *</label>
                        <select id="questionCategory" required class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            <option value="technical">Technical</option>
                            <option value="management">Management</option>
                            <option value="pricing">Pricing</option>
                            <option value="contractual">Contractual</option>
                            <option value="past-performance">Past Performance</option>
                            <option value="clarification">Clarification</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Section Reference</label>
                        <input type="text" id="questionSection" placeholder="e.g., L.1.2.3" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-white/60 text-sm mb-1">Question Text *</label>
                    <textarea id="questionText" required rows="3" placeholder="Enter the question to submit to the government..." class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Priority</label>
                        <select id="questionPriority" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Status</label>
                        <select id="questionStatus" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            <option value="draft">Draft</option>
                            <option value="ready">Ready to Submit</option>
                            <option value="submitted">Submitted</option>
                            <option value="answered">Answered</option>
                            <option value="withdrawn">Withdrawn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Assigned To</label>
                        <input type="text" id="questionAssigned" placeholder="Team member" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Submitted Date</label>
                        <input type="date" id="questionSubmittedDate" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-white/60 text-sm mb-1">Source</label>
                        <input type="text" id="questionSource" placeholder="e.g., Capture Lead, Tech SME" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <!-- Amendment Section -->
                <div class="border border-yellow-500/30 rounded-lg p-4 bg-yellow-500/5">
                    <label class="flex items-center gap-2 text-yellow-400 text-sm mb-3 cursor-pointer">
                        <input type="checkbox" id="questionIsAmendment" onchange="toggleAmendmentField()" class="rounded bg-black/40 border-yellow-500/30">
                        Related to RFP Amendment
                    </label>
                    <div id="amendmentField" class="hidden">
                        <label class="block text-white/60 text-sm mb-1">Amendment Number</label>
                        <input type="text" id="questionAmendmentNumber" placeholder="e.g., A001" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                    </div>
                </div>

                <!-- Response Section -->
                <div class="border border-green-500/30 rounded-lg p-4 bg-green-500/5">
                    <h4 class="text-green-400 text-sm font-semibold mb-3">Government Response</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-white/60 text-sm mb-1">Response Text</label>
                            <textarea id="questionResponse" rows="3" placeholder="Enter government response when received..." class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white/60 text-sm mb-1">Response Date</label>
                                <input type="date" id="questionResponseDate" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-white/60 text-sm mb-1">Impact Assessment</label>
                                <select id="questionImpact" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none">
                                    <option value="">-- Select Impact --</option>
                                    <option value="none">No Impact</option>
                                    <option value="minor">Minor Change</option>
                                    <option value="moderate">Moderate Change</option>
                                    <option value="major">Major Change</option>
                                    <option value="showstopper">Showstopper</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-white/60 text-sm mb-1">Notes</label>
                    <textarea id="questionNotes" rows="2" placeholder="Internal notes" class="w-full bg-black/40 border border-cyan-500/30 rounded-lg px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-cyan-500/20">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border border-cyan-500/30 rounded-lg text-white/70 hover:bg-cyan-500/10">Cancel</button>
                    <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Init
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTMwNjIsImV4cCI6MjA1Mjk4OTA2Mn0.gwBTnfAtsxSFDz96fDPL7HAIYdA5s_9hiv_l0ECWvYc';
        
        let supabase;
        let allQuestions = [];
        let currentOpportunityId = null;
        let isLiveMode = false;

        // Demo Data
        const demoOpportunities = [
            { id: 'demo-1', title: 'DHA DHMSM Support', nickname: 'DHMSM' },
            { id: 'demo-2', title: 'VA EHR Modernization', nickname: 'VA-EHR' },
            { id: 'demo-3', title: 'CMS Data Analytics', nickname: 'CMS-Analytics' }
        ];

        const demoQuestions = [
            { id: 'q1', opportunity_id: 'demo-1', question_number: 'Q-001', question_text: 'Section L.1.2 references "existing infrastructure." Please clarify if this refers to the current MHS GENESIS deployment or legacy AHLTA systems.', section_reference: 'L.1.2', category: 'technical', priority: 'high', status: 'answered', submitted_date: '2025-01-15', response_text: 'The reference to existing infrastructure includes both MHS GENESIS and legacy systems during the transition period. Offerors should address interoperability with both systems.', response_date: '2025-01-20', response_impact: 'moderate', assigned_to: 'Sarah Chen', source: 'Tech Lead', is_amendment_related: false, notes: 'Critical for architecture approach' },
            { id: 'q2', opportunity_id: 'demo-1', question_number: 'Q-002', question_text: 'Is there a page limit for the Technical Volume that differs from what is stated in Section L.3?', section_reference: 'L.3', category: 'clarification', priority: 'medium', status: 'submitted', submitted_date: '2025-01-18', response_text: '', response_date: null, response_impact: '', assigned_to: 'Mike Johnson', source: 'Proposal Manager', is_amendment_related: false, notes: '' },
            { id: 'q3', opportunity_id: 'demo-1', question_number: 'Q-003', question_text: 'Amendment A002 changed the labor category requirements. Please confirm that the new LCAT matrix supersedes Attachment J-4.', section_reference: 'J-4', category: 'contractual', priority: 'high', status: 'ready', submitted_date: null, response_text: '', response_date: null, response_impact: '', assigned_to: 'Lisa Wong', source: 'Contracts', is_amendment_related: true, amendment_number: 'A002', notes: 'Blocking pricing finalization' },
            { id: 'q4', opportunity_id: 'demo-1', question_number: 'Q-004', question_text: 'Can past performance references from subcontractors be used to meet the 3-contract minimum requirement?', section_reference: 'M.2.1', category: 'past-performance', priority: 'high', status: 'answered', submitted_date: '2025-01-10', response_text: 'Yes, subcontractor past performance may be used if the subcontractor is proposed for a significant role and the work is directly relevant. Relevancy will be evaluated per M.2.3.', response_date: '2025-01-14', response_impact: 'none', assigned_to: 'Tom Davis', source: 'Capture Lead', is_amendment_related: false, notes: 'Good news - opens up teaming options' },
            { id: 'q5', opportunity_id: 'demo-1', question_number: 'Q-005', question_text: 'Section B.3 pricing instructions appear to conflict with the CLIN structure in Section B.1. Which takes precedence?', section_reference: 'B.1, B.3', category: 'pricing', priority: 'medium', status: 'draft', submitted_date: null, response_text: '', response_date: null, response_impact: '', assigned_to: 'Alex Kim', source: 'Pricing Lead', is_amendment_related: false, notes: 'Need internal review before submission' },
            { id: 'q6', opportunity_id: 'demo-1', question_number: 'Q-006', question_text: 'Please provide the Government estimate for Option Year 3 travel, as it was omitted from Attachment J-8.', section_reference: 'J-8', category: 'pricing', priority: 'low', status: 'submitted', submitted_date: '2025-01-19', response_text: '', response_date: null, response_impact: '', assigned_to: 'Alex Kim', source: 'Pricing Lead', is_amendment_related: false, notes: '' },
            { id: 'q7', opportunity_id: 'demo-2', question_number: 'Q-001', question_text: 'Does the VA require FedRAMP High authorization for the proposed cloud environment, or is FedRAMP Moderate acceptable?', section_reference: 'L.2.4', category: 'technical', priority: 'high', status: 'draft', submitted_date: null, response_text: '', response_date: null, response_impact: '', assigned_to: '', source: 'Tech Lead', is_amendment_related: false, notes: '' }
        ];

        // Initialize
        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await loadOpportunities();
            } catch (error) {
                console.error('Init error:', error);
                loadDemoMode();
            }
        }

        async function loadOpportunities() {
            try {
                const { data, error } = await supabase.from('opportunities').select('id, title, nickname').order('title');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    isLiveMode = true;
                    updateConnectionStatus(true);
                    populateOpportunitySelect(data);
                } else {
                    loadDemoMode();
                }
            } catch (error) {
                console.error('Load opportunities error:', error);
                loadDemoMode();
            }
        }

        function loadDemoMode() {
            isLiveMode = false;
            updateConnectionStatus(false);
            populateOpportunitySelect(demoOpportunities);
        }

        function updateConnectionStatus(isLive) {
            const status = document.getElementById('connectionStatus');
            if (isLive) {
                status.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-green-400">Live Database</span>';
            } else {
                status.innerHTML = '<div class="w-2 h-2 rounded-full bg-yellow-500"></div><span class="text-yellow-400">Demo Mode</span>';
            }
        }

        function populateOpportunitySelect(opportunities) {
            const select = document.getElementById('opportunitySelect');
            select.innerHTML = '<option value="">-- Select Opportunity --</option>' + 
                opportunities.map(o => `<option value="${o.id}">${o.nickname || o.title}</option>`).join('');
        }

        async function loadQuestions() {
            const oppId = document.getElementById('opportunitySelect').value;
            if (!oppId) {
                document.getElementById('questionsList').innerHTML = '<div class="glass-card p-8 text-center text-white/40">Select an opportunity to view questions</div>';
                updateStats([]);
                return;
            }
            
            currentOpportunityId = oppId;

            if (isLiveMode) {
                try {
                    const { data, error } = await supabase
                        .from('government_questions')
                        .select('*')
                        .eq('opportunity_id', oppId)
                        .order('sort_order')
                        .order('question_number');
                    
                    if (error) throw error;
                    allQuestions = data || [];
                } catch (error) {
                    console.error('Load questions error:', error);
                    allQuestions = demoQuestions.filter(q => q.opportunity_id === oppId);
                }
            } else {
                allQuestions = demoQuestions.filter(q => q.opportunity_id === oppId);
            }

            applyFilters();
        }

        function applyFilters() {
            let filtered = [...allQuestions];
            
            const categoryFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const amendmentFilter = document.getElementById('filterAmendment').checked;
            const search = document.getElementById('searchBox').value.toLowerCase();

            if (categoryFilter) filtered = filtered.filter(q => q.category === categoryFilter);
            if (statusFilter) filtered = filtered.filter(q => q.status === statusFilter);
            if (priorityFilter) filtered = filtered.filter(q => q.priority === priorityFilter);
            if (amendmentFilter) filtered = filtered.filter(q => q.is_amendment_related);
            if (search) filtered = filtered.filter(q => 
                q.question_text.toLowerCase().includes(search) || 
                (q.question_number || '').toLowerCase().includes(search) ||
                (q.response_text || '').toLowerCase().includes(search)
            );

            renderQuestions(filtered);
            updateStats(allQuestions);
        }

        function renderQuestions(questions) {
            const container = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                container.innerHTML = '<div class="glass-card p-8 text-center text-white/40">No questions found. Click "Add Question" to create one.</div>';
                return;
            }

            container.innerHTML = questions.map(q => `
                <div class="glass-card p-5 hover:border-cyan-400/50 transition-all">
                    <div class="flex items-start justify-between gap-4 mb-3">
                        <div class="flex items-center gap-3">
                            <span class="font-mono text-cyan-400 font-bold">${q.question_number || 'Q-???'}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium category-${q.category}">${formatCategory(q.category)}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium priority-${q.priority}">${capitalize(q.priority)}</span>
                            <span class="px-2 py-0.5 rounded text-xs font-medium status-${q.status}">${formatStatus(q.status)}</span>
                            ${q.is_amendment_related ? `<span class="px-2 py-0.5 rounded text-xs font-medium amendment-badge text-yellow-400">üìã ${q.amendment_number || 'Amendment'}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editQuestion('${q.id}')" class="text-cyan-400 hover:text-cyan-300 px-2 py-1 text-sm">‚úèÔ∏è Edit</button>
                            <button onclick="deleteQuestion('${q.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-white/90 leading-relaxed">${q.question_text}</p>
                        ${q.section_reference ? `<p class="text-white/40 text-sm mt-1">üìå Reference: ${q.section_reference}</p>` : ''}
                    </div>

                    ${q.response_text ? `
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mt-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-green-400 text-sm font-semibold">‚úÖ Government Response</span>
                                ${q.response_date ? `<span class="text-white/40 text-xs">(${formatDate(q.response_date)})</span>` : ''}
                                ${q.response_impact ? `<span class="px-2 py-0.5 rounded text-xs font-medium ${getImpactClass(q.response_impact)}">${formatImpact(q.response_impact)}</span>` : ''}
                            </div>
                            <p class="text-white/80 text-sm">${q.response_text}</p>
                        </div>
                    ` : ''}

                    <div class="flex items-center gap-4 mt-3 text-xs text-white/40">
                        ${q.assigned_to ? `<span>üë§ ${q.assigned_to}</span>` : ''}
                        ${q.source ? `<span>üìç Source: ${q.source}</span>` : ''}
                        ${q.submitted_date ? `<span>üì§ Submitted: ${formatDate(q.submitted_date)}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateStats(questions) {
            document.getElementById('statTotal').textContent = questions.length;
            document.getElementById('statDraft').textContent = questions.filter(q => q.status === 'draft').length;
            document.getElementById('statReady').textContent = questions.filter(q => q.status === 'ready').length;
            document.getElementById('statSubmitted').textContent = questions.filter(q => q.status === 'submitted').length;
            document.getElementById('statAnswered').textContent = questions.filter(q => q.status === 'answered').length;
            document.getElementById('statHighPriority').textContent = questions.filter(q => q.priority === 'high' && q.status !== 'answered').length;
        }

        function toggleAmendmentField() {
            const isAmendment = document.getElementById('questionIsAmendment').checked;
            document.getElementById('amendmentField').classList.toggle('hidden', !isAmendment);
        }

        function openModal(question = null) {
            document.getElementById('questionModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = question ? 'Edit Question' : 'Add Question';
            
            if (question) {
                document.getElementById('questionId').value = question.id;
                document.getElementById('questionNumber').value = question.question_number || '';
                document.getElementById('questionCategory').value = question.category;
                document.getElementById('questionSection').value = question.section_reference || '';
                document.getElementById('questionText').value = question.question_text;
                document.getElementById('questionPriority').value = question.priority;
                document.getElementById('questionStatus').value = question.status;
                document.getElementById('questionAssigned').value = question.assigned_to || '';
                document.getElementById('questionSubmittedDate').value = question.submitted_date || '';
                document.getElementById('questionSource').value = question.source || '';
                document.getElementById('questionIsAmendment').checked = question.is_amendment_related;
                document.getElementById('questionAmendmentNumber').value = question.amendment_number || '';
                document.getElementById('questionResponse').value = question.response_text || '';
                document.getElementById('questionResponseDate').value = question.response_date || '';
                document.getElementById('questionImpact').value = question.response_impact || '';
                document.getElementById('questionNotes').value = question.notes || '';
                toggleAmendmentField();
            } else {
                document.getElementById('questionForm').reset();
                document.getElementById('questionId').value = '';
                document.getElementById('amendmentField').classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('questionModal').classList.add('hidden');
        }

        async function saveQuestion(event) {
            event.preventDefault();
            
            const questionData = {
                opportunity_id: currentOpportunityId,
                question_number: document.getElementById('questionNumber').value || null,
                question_text: document.getElementById('questionText').value,
                section_reference: document.getElementById('questionSection').value || null,
                category: document.getElementById('questionCategory').value,
                priority: document.getElementById('questionPriority').value,
                status: document.getElementById('questionStatus').value,
                assigned_to: document.getElementById('questionAssigned').value || null,
                submitted_date: document.getElementById('questionSubmittedDate').value || null,
                source: document.getElementById('questionSource').value || null,
                is_amendment_related: document.getElementById('questionIsAmendment').checked,
                amendment_number: document.getElementById('questionAmendmentNumber').value || null,
                response_text: document.getElementById('questionResponse').value || null,
                response_date: document.getElementById('questionResponseDate').value || null,
                response_impact: document.getElementById('questionImpact').value || null,
                notes: document.getElementById('questionNotes').value || null,
                updated_at: new Date().toISOString()
            };

            const questionId = document.getElementById('questionId').value;

            if (isLiveMode) {
                try {
                    if (questionId) {
                        const { error } = await supabase.from('government_questions').update(questionData).eq('id', questionId);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.from('government_questions').insert([questionData]);
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert('Error saving question: ' + error.message);
                    return;
                }
            } else {
                if (questionId) {
                    const idx = allQuestions.findIndex(q => q.id === questionId);
                    if (idx !== -1) allQuestions[idx] = { ...allQuestions[idx], ...questionData };
                } else {
                    allQuestions.push({ id: 'demo-' + Date.now(), ...questionData });
                }
            }

            closeModal();
            loadQuestions();
        }

        function editQuestion(id) {
            const question = allQuestions.find(q => q.id === id);
            if (question) openModal(question);
        }

        async function deleteQuestion(id) {
            if (!confirm('Delete this question?')) return;

            if (isLiveMode) {
                try {
                    const { error } = await supabase.from('government_questions').delete().eq('id', id);
                    if (error) throw error;
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting question: ' + error.message);
                    return;
                }
            } else {
                allQuestions = allQuestions.filter(q => q.id !== id);
            }

            loadQuestions();
        }

        function exportQuestions() {
            if (allQuestions.length === 0) {
                alert('No questions to export');
                return;
            }

            let csv = 'Question #,Category,Section,Question,Status,Priority,Submitted,Response,Response Date,Impact\n';
            allQuestions.forEach(q => {
                csv += `"${q.question_number || ''}","${q.category}","${q.section_reference || ''}","${q.question_text.replace(/"/g, '""')}","${q.status}","${q.priority}","${q.submitted_date || ''}","${(q.response_text || '').replace(/"/g, '""')}","${q.response_date || ''}","${q.response_impact || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions-${currentOpportunityId}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Utilities
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatCategory(cat) {
            const map = {
                'technical': 'Technical',
                'management': 'Management',
                'pricing': 'Pricing',
                'contractual': 'Contractual',
                'past-performance': 'Past Perf',
                'clarification': 'Clarification'
            };
            return map[cat] || cat;
        }

        function formatStatus(status) {
            const map = {
                'draft': 'Draft',
                'ready': 'Ready',
                'submitted': 'Submitted',
                'answered': 'Answered',
                'withdrawn': 'Withdrawn'
            };
            return map[status] || status;
        }

        function formatImpact(impact) {
            const map = {
                'none': 'No Impact',
                'minor': 'Minor',
                'moderate': 'Moderate',
                'major': 'Major',
                'showstopper': '‚ö†Ô∏è Showstopper'
            };
            return map[impact] || impact;
        }

        function getImpactClass(impact) {
            const map = {
                'none': 'bg-gray-500/20 text-gray-300',
                'minor': 'bg-green-500/20 text-green-300',
                'moderate': 'bg-yellow-500/20 text-yellow-300',
                'major': 'bg-orange-500/20 text-orange-300',
                'showstopper': 'bg-red-500/20 text-red-300'
            };
            return map[impact] || '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
