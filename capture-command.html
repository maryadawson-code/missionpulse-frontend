<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capture Command | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="icon" type="image/png" href="MMT_icon_32px.png">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'deep-navy': '#00050F',
            'cyber-cyan': '#00E5FA',
            'slate-dark': '#0a1628'
          }
        }
      }
    }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .event-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 229, 250, 0.15); }
    .type-badge { font-size: 10px; letter-spacing: 0.05em; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="min-h-screen text-white">
  <header class="border-b border-slate-800/50 bg-deep-navy/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
        </div>
        <div>
          <span class="text-lg font-bold text-white">Capture Command</span>
          <span class="text-xs text-slate-500 block">Capture Events &amp; Timeline</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="dataSource" class="text-xs px-2 py-1 rounded bg-slate-800 text-slate-500">Loading...</span>
        <a href="dashboard-v2.html" class="text-sm text-slate-400 hover:text-cyber-cyan transition-colors">&larr; Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <div id="authCheck" class="text-center py-12">
      <div class="animate-pulse text-slate-500">Authenticating...</div>
    </div>
    <div id="mainContent" class="hidden">
      <!-- Stats Row -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Total Events</p>
          <p class="text-2xl font-bold text-white mt-1" id="statTotal">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Upcoming</p>
          <p class="text-2xl font-bold text-emerald-400 mt-1" id="statUpcoming">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">Milestones</p>
          <p class="text-2xl font-bold text-amber-400 mt-1" id="statMilestones">0</p>
        </div>
        <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-4">
          <p class="text-xs text-slate-500 uppercase tracking-wide">This Week</p>
          <p class="text-2xl font-bold text-cyber-cyan mt-1" id="statThisWeek">0</p>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap gap-3 mb-6">
        <select id="filterType" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
          <option value="">All Types</option>
          <option value="meeting">Meeting</option>
          <option value="call">Call</option>
          <option value="deadline">Deadline</option>
          <option value="review">Review</option>
          <option value="milestone">Milestone</option>
          <option value="submission">Submission</option>
        </select>
        <select id="filterStatus" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
          <option value="">All Statuses</option>
          <option value="scheduled">Scheduled</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button onclick="showAddModal()" class="ml-auto bg-cyber-cyan/20 hover:bg-cyber-cyan/30 border border-cyber-cyan/30 text-cyber-cyan px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          + New Event
        </button>
      </div>

      <!-- Events Timeline -->
      <div id="eventsContainer" class="space-y-3"></div>
      <div id="emptyState" class="hidden text-center py-16">
        <p class="text-slate-500">No capture events found. Create one to get started.</p>
      </div>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="eventModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg p-6">
      <h3 class="text-lg font-bold text-white mb-4" id="modalTitle">New Capture Event</h3>
      <div class="space-y-4">
        <div>
          <label class="text-xs text-slate-400 block mb-1">Title *</label>
          <input id="fTitle" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" placeholder="Event title">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-400 block mb-1">Type *</label>
            <select id="fType" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
              <option value="meeting">Meeting</option>
              <option value="call">Call</option>
              <option value="deadline">Deadline</option>
              <option value="review">Review</option>
              <option value="milestone">Milestone</option>
              <option value="submission">Submission</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-slate-400 block mb-1">Status</label>
            <select id="fStatus" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
              <option value="scheduled">Scheduled</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-slate-400 block mb-1">Start Date *</label>
            <input id="fStart" type="datetime-local" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
          </div>
          <div>
            <label class="text-xs text-slate-400 block mb-1">End Date</label>
            <input id="fEnd" type="datetime-local" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Description</label>
          <textarea id="fDesc" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" placeholder="Notes..."></textarea>
        </div>
        <div>
          <label class="text-xs text-slate-400 block mb-1">Location / Virtual Link</label>
          <input id="fLocation" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" placeholder="Room / URL">
        </div>
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer">
            <input id="fMilestone" type="checkbox" class="rounded bg-slate-800 border-slate-600">
            Milestone
          </label>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-400 hover:text-white">Cancel</button>
        <button onclick="saveEvent()" class="px-4 py-2 text-sm bg-cyber-cyan/20 hover:bg-cyber-cyan/30 border border-cyber-cyan/30 text-cyber-cyan rounded-lg font-medium">Save</button>
      </div>
    </div>
  </div>

  <footer class="border-t border-slate-800/30 mt-12 py-4 text-center">
    <p class="text-xs text-slate-600">AI GENERATED &mdash; REQUIRES HUMAN REVIEW &bull; MissionPulse &copy; Mission Meets Tech</p>
  </footer>

<script>
// ============================================================
// SUPABASE INIT (var sbClient — matches global pattern)
// ============================================================
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzQ0NDYsImV4cCI6MjA1MzQxMDQ0Nn0.KmJnSsVJdxFRMPOxFYBxOQZbV5m_s2G8Yn52QLbmCPg';
var sbClient;
try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) { console.warn('Supabase init failed, using demo data'); }

// ============================================================
// DEMO DATA FALLBACK
// ============================================================
const DEMO_EVENTS = [
  { id: 'demo-1', title: 'DHA CIO Meeting', event_type: 'meeting', status: 'scheduled', start_date: new Date(Date.now() + 86400000*2).toISOString(), description: 'Discuss MHS Genesis integration timeline', location: 'Pentagon Room 3B142', is_milestone: false },
  { id: 'demo-2', title: 'RFP Response Deadline', event_type: 'deadline', status: 'scheduled', start_date: new Date(Date.now() + 86400000*7).toISOString(), description: 'DHMS-25-R-0042 Technical Volume due', is_milestone: true },
  { id: 'demo-3', title: 'Pink Team Review', event_type: 'review', status: 'scheduled', start_date: new Date(Date.now() + 86400000*4).toISOString(), description: 'Review Management Volume draft', is_milestone: false },
  { id: 'demo-4', title: 'Teaming Call — Leidos', event_type: 'call', status: 'completed', start_date: new Date(Date.now() - 86400000*1).toISOString(), description: 'Discuss subcontracting roles for DHMS recompete', is_milestone: false },
  { id: 'demo-5', title: 'Proposal Submission', event_type: 'submission', status: 'scheduled', start_date: new Date(Date.now() + 86400000*14).toISOString(), description: 'Final submission to SAM.gov', is_milestone: true },
];

let events = [...DEMO_EVENTS];
let editingId = null;

// ============================================================
// AUTH & INIT
// ============================================================
async function init() {
  let user = null;
  try {
    if (sbClient) {
      const { data } = await sbClient.auth.getUser();
      user = data?.user;
    }
  } catch(e) {}

  document.getElementById('authCheck').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');

  if (user) { await loadFromSupabase(); }
  else { document.getElementById('dataSource').textContent = 'Demo Data'; document.getElementById('dataSource').classList.add('text-amber-400'); }

  document.getElementById('filterType').addEventListener('change', renderEvents);
  document.getElementById('filterStatus').addEventListener('change', renderEvents);
  renderEvents();
}

async function loadFromSupabase() {
  try {
    const { data, error } = await sbClient.from('capture_events').select('*').order('start_date', { ascending: true });
    if (!error && data && data.length > 0) {
      events = data;
      document.getElementById('dataSource').textContent = 'Live — Supabase';
      document.getElementById('dataSource').classList.add('text-emerald-400');
    } else {
      document.getElementById('dataSource').textContent = 'Demo Data';
      document.getElementById('dataSource').classList.add('text-amber-400');
    }
  } catch(e) {
    console.warn('Supabase fetch failed, using demo data');
    document.getElementById('dataSource').textContent = 'Demo Data';
    document.getElementById('dataSource').classList.add('text-amber-400');
  }
}

// ============================================================
// RENDER
// ============================================================
const TYPE_COLORS = {
  meeting: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
  call: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
  deadline: 'bg-red-500/20 text-red-300 border-red-500/30',
  review: 'bg-amber-500/20 text-amber-300 border-amber-500/30',
  milestone: 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30',
  submission: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30'
};
const STATUS_DOT = { scheduled: 'bg-blue-400', completed: 'bg-emerald-400', cancelled: 'bg-slate-500' };

function renderEvents() {
  const typeF = document.getElementById('filterType').value;
  const statusF = document.getElementById('filterStatus').value;
  let filtered = [...events];
  if (typeF) filtered = filtered.filter(e => e.event_type === typeF);
  if (statusF) filtered = filtered.filter(e => e.status === statusF);

  const now = new Date();
  const weekEnd = new Date(now.getTime() + 7 * 86400000);
  document.getElementById('statTotal').textContent = events.length;
  document.getElementById('statUpcoming').textContent = events.filter(e => new Date(e.start_date) > now && e.status !== 'cancelled').length;
  document.getElementById('statMilestones').textContent = events.filter(e => e.is_milestone).length;
  document.getElementById('statThisWeek').textContent = events.filter(e => { const d = new Date(e.start_date); return d >= now && d <= weekEnd; }).length;

  const container = document.getElementById('eventsContainer');
  const empty = document.getElementById('emptyState');
  if (filtered.length === 0) { container.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  container.innerHTML = filtered.map(ev => {
    const d = new Date(ev.start_date);
    const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const tc = TYPE_COLORS[ev.event_type] || TYPE_COLORS.meeting;
    const sd = STATUS_DOT[ev.status] || STATUS_DOT.scheduled;
    const isPast = d < now;
    return `<div class="event-card bg-slate-900/60 border border-slate-800/50 rounded-xl p-4 flex gap-4 items-start transition-all ${isPast ? 'opacity-60' : ''}">
      <div class="text-center min-w-[56px]">
        <p class="text-xs text-slate-500 uppercase">${d.toLocaleDateString('en-US',{month:'short'})}</p>
        <p class="text-2xl font-bold text-white">${d.getDate()}</p>
        <p class="text-xs text-slate-500">${timeStr}</p>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1">
          <span class="type-badge px-2 py-0.5 rounded-full border ${tc} uppercase font-medium">${ev.event_type}</span>
          ${ev.is_milestone ? '<span class="text-amber-400 text-xs">&#9733; Milestone</span>' : ''}
          <span class="w-2 h-2 rounded-full ${sd} ml-auto flex-shrink-0" title="${ev.status}"></span>
        </div>
        <h4 class="text-white font-medium truncate">${ev.title}</h4>
        ${ev.description ? `<p class="text-xs text-slate-400 mt-1 line-clamp-2">${ev.description}</p>` : ''}
        ${ev.location ? `<p class="text-xs text-slate-500 mt-1">&#128205; ${ev.location}</p>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// CRUD
// ============================================================
function showAddModal() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'New Capture Event';
  document.getElementById('fTitle').value = '';
  document.getElementById('fType').value = 'meeting';
  document.getElementById('fStatus').value = 'scheduled';
  document.getElementById('fStart').value = '';
  document.getElementById('fEnd').value = '';
  document.getElementById('fDesc').value = '';
  document.getElementById('fLocation').value = '';
  document.getElementById('fMilestone').checked = false;
  document.getElementById('eventModal').classList.remove('hidden');
}

function closeModal() { document.getElementById('eventModal').classList.add('hidden'); }

async function saveEvent() {
  const title = document.getElementById('fTitle').value.trim();
  const startVal = document.getElementById('fStart').value;
  if (!title || !startVal) { alert('Title and Start Date are required'); return; }

  const payload = {
    title,
    event_type: document.getElementById('fType').value,
    status: document.getElementById('fStatus').value,
    start_date: new Date(startVal).toISOString(),
    end_date: document.getElementById('fEnd').value ? new Date(document.getElementById('fEnd').value).toISOString() : null,
    description: document.getElementById('fDesc').value.trim() || null,
    location: document.getElementById('fLocation').value.trim() || null,
    is_milestone: document.getElementById('fMilestone').checked
  };

  try {
    if (sbClient) {
      const { data, error } = await sbClient.from('capture_events').insert(payload).select().single();
      if (!error && data) { events.push(data); }
      else { payload.id = 'local-' + Date.now(); events.push(payload); }
    } else { payload.id = 'local-' + Date.now(); events.push(payload); }
  } catch(e) { payload.id = 'local-' + Date.now(); events.push(payload); }

  closeModal();
  renderEvents();
}

init();
</script>
</body>
</html>

