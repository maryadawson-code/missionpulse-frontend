<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capture Command | MissionPulse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="icon" type="image/png" href="MMT_icon_32px.png">
  <script>
    tailwind.config = { theme: { extend: { colors: { 'deep-navy': '#00050F', 'cyber-cyan': '#00E5FA', 'slate-dark': '#0a1628' } } } }
  </script>
  <style>
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .gate-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 229, 250, 0.1); }
    .gate-card { transition: all 0.2s; }
    .score-ring { transition: stroke-dashoffset 0.6s ease; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a1628; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="min-h-screen text-white">
  <header class="border-b border-slate-800/50 bg-deep-navy/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-rose-500 to-orange-500 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <div>
          <span class="text-lg font-bold text-white">Capture Command</span>
          <span class="text-xs text-slate-500 block">Go/No-Go Decision Center</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <select id="oppSelector" onchange="loadOpportunity()" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-white focus:border-cyber-cyan outline-none max-w-xs"></select>
        <a href="dashboard-v2.html" class="text-sm text-slate-400 hover:text-cyber-cyan transition-colors">← Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    <div id="authCheck" class="text-center py-12"><p class="text-slate-400">Verifying access...</p></div>

    <div id="mainContent" class="hidden space-y-8">
      <!-- Capture Score Summary -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-1 bg-slate-900/60 border border-slate-800/50 rounded-xl p-6 flex flex-col items-center justify-center">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" fill="none" stroke="#1e293b" stroke-width="8"/>
            <circle id="scoreArc" cx="60" cy="60" r="50" fill="none" stroke="#00E5FA" stroke-width="8" stroke-linecap="round"
                    stroke-dasharray="314.16" stroke-dashoffset="314.16" transform="rotate(-90 60 60)" class="score-ring"/>
            <text x="60" y="55" text-anchor="middle" fill="white" font-size="28" font-weight="bold" id="scoreText">0</text>
            <text x="60" y="72" text-anchor="middle" fill="#64748b" font-size="11">CAPTURE SCORE</text>
          </svg>
          <div class="mt-3 text-center">
            <span id="goNoGo" class="text-sm font-bold px-3 py-1 rounded-full bg-slate-800 text-slate-400">PENDING</span>
          </div>
        </div>

        <div class="md:col-span-3 grid grid-cols-3 gap-4">
          <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-5">
            <p class="text-xs text-slate-500 mb-1">Opportunity</p>
            <p class="text-lg font-bold text-white truncate" id="oppName">--</p>
            <p class="text-xs text-slate-500 mt-1" id="oppAgency">--</p>
          </div>
          <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-5">
            <p class="text-xs text-slate-500 mb-1">Estimated Value</p>
            <p class="text-lg font-bold text-cyber-cyan" id="oppValue">--</p>
            <p class="text-xs text-slate-500 mt-1" id="oppPhase">--</p>
          </div>
          <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-5">
            <p class="text-xs text-slate-500 mb-1">Win Probability</p>
            <p class="text-lg font-bold" id="oppPwin">--</p>
            <p class="text-xs text-slate-500 mt-1" id="oppSol">--</p>
          </div>
        </div>
      </div>

      <!-- Gate Reviews -->
      <div>
        <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Shipley Gate Reviews</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="gatesContainer"></div>
      </div>

      <!-- Capture Action Items -->
      <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wider">Capture Action Items</h2>
          <button onclick="addAction()" class="text-xs bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/30 rounded-lg px-3 py-1.5 hover:bg-cyber-cyan/30 transition-all">+ Add Action</button>
        </div>
        <div id="actionsContainer" class="space-y-2"></div>
      </div>

      <!-- Decision Log -->
      <div class="bg-slate-900/60 border border-slate-800/50 rounded-xl p-6">
        <h2 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">Decision Log</h2>
        <div id="decisionLog" class="space-y-3"></div>
        <div class="mt-4 flex gap-3">
          <input id="decisionInput" type="text" placeholder="Log a capture decision..." class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:border-cyber-cyan outline-none">
          <button onclick="logDecision()" class="bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/30 rounded-lg px-4 py-2 text-sm hover:bg-cyber-cyan/30 transition-all">Log</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t border-slate-800/30 mt-12 py-4 text-center">
    <p class="text-xs text-slate-600">AI GENERATED — REQUIRES HUMAN REVIEW &bull; MissionPulse &copy; Mission Meets Tech</p>
  </footer>

<script>
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzQ0NDIsImV4cCI6MjA1MzQxMDQ0Mn0.gMzJAb3GkUNJBnfoDSpWPbKDnJBATkTNwdB2D1kMiFo';
var sbClient;
try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) {}

const DEMO_OPPS = [
  { id:'1', name:'MHS Genesis Wave 4', agency:'DHA', estimated_value:85000000, win_probability:72, shipley_phase:'Drafting', solicitation_number:'W91CRB-25-R-0042' },
  { id:'2', name:'VA EHR Modernization', agency:'VA', estimated_value:120000000, win_probability:45, shipley_phase:'Capture', solicitation_number:'VA-25-00198' },
  { id:'3', name:'CMS Data Analytics', agency:'CMS', estimated_value:32000000, win_probability:68, shipley_phase:'Planning', solicitation_number:'CMS-25-0087' },
  { id:'4', name:'IHS Telehealth Platform', agency:'IHS', estimated_value:18500000, win_probability:81, shipley_phase:'Review', solicitation_number:'IHS-25-0034' },
  { id:'5', name:'DHA Cybersecurity Ops', agency:'DHA', estimated_value:45000000, win_probability:55, shipley_phase:'Opportunity', solicitation_number:'' },
];

const GATES = [
  { id:'gate0', name:'Bid Decision', phase:'Opportunity', criteria:['Customer relationship established','Funding confirmed','Contract vehicle identified','Competitive landscape assessed','Technical solution viable'] },
  { id:'gate1', name:'Capture Readiness', phase:'Capture', criteria:['Win strategy defined','Key personnel identified','Teaming partners secured','Price-to-win estimated','Customer meetings completed'] },
  { id:'gate2', name:'Proposal Kickoff', phase:'Planning', criteria:['RFP analyzed & shredded','Compliance matrix complete','Outline approved','Writers assigned','Schedule baselined'] },
  { id:'gate3', name:'Pink Team', phase:'Drafting', criteria:['All sections drafted','Win themes woven throughout','Graphics placed','Compliance cross-checked','Page count within limits'] },
  { id:'gate4', name:'Red Team', phase:'Review', criteria:['Executive summary compelling','Discriminators clearly stated','Pricing competitive','No compliance gaps','Risk mitigations addressed'] },
  { id:'gate5', name:'Gold Team / Submit', phase:'Submitted', criteria:['Final formatting complete','All volumes assembled','Electronic submission tested','Management sign-off obtained','Submission confirmation received'] },
];

let opportunities = [...DEMO_OPPS];
let currentOpp = null;
let gateStates = {};
let actions = [];
let decisions = [];

function formatValue(v) {
  if (v >= 1e9) return '$' + (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return '$' + (v/1e6).toFixed(1) + 'M';
  return '$' + v.toLocaleString();
}

async function init() {
  document.getElementById('authCheck').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
  try {
    if (sbClient) {
      const { data } = await sbClient.from('opportunities').select('*');
      if (data?.length) opportunities = data.map(r => ({ id:String(r.id), name:r.name||r.title||'Untitled', agency:r.agency||'', estimated_value:r.estimated_value||0, win_probability:r.win_probability||0, shipley_phase:r.shipley_phase||'Opportunity', solicitation_number:r.solicitation_number||'' }));
    }
  } catch(e) {}

  const sel = document.getElementById('oppSelector');
  sel.innerHTML = opportunities.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
  loadOpportunity();
}

function loadOpportunity() {
  const id = document.getElementById('oppSelector').value;
  currentOpp = opportunities.find(o => o.id === id) || opportunities[0];
  if (!currentOpp) return;

  document.getElementById('oppName').textContent = currentOpp.name;
  document.getElementById('oppAgency').textContent = currentOpp.agency;
  document.getElementById('oppValue').textContent = formatValue(currentOpp.estimated_value);
  document.getElementById('oppPhase').textContent = currentOpp.shipley_phase + ' Phase';
  document.getElementById('oppPwin').textContent = currentOpp.win_probability + '%';
  document.getElementById('oppPwin').className = `text-lg font-bold ${currentOpp.win_probability >= 70 ? 'text-emerald-400' : currentOpp.win_probability >= 50 ? 'text-amber-400' : 'text-red-400'}`;
  document.getElementById('oppSol').textContent = currentOpp.solicitation_number || 'No solicitation #';

  if (!gateStates[currentOpp.id]) {
    gateStates[currentOpp.id] = {};
    GATES.forEach(g => { gateStates[currentOpp.id][g.id] = g.criteria.map(() => false); });
  }
  renderGates();
  renderActions();
  renderDecisions();
  updateScore();
}

function renderGates() {
  const container = document.getElementById('gatesContainer');
  const states = gateStates[currentOpp.id];
  container.innerHTML = GATES.map(g => {
    const checks = states[g.id];
    const done = checks.filter(Boolean).length;
    const total = checks.length;
    const pct = Math.round((done/total)*100);
    const color = pct === 100 ? 'emerald' : pct >= 60 ? 'amber' : 'slate';
    return `
      <div class="gate-card bg-slate-900/60 border border-slate-800/50 rounded-xl p-5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-sm font-bold text-white">${g.name}</h3>
            <p class="text-xs text-slate-500">${g.phase} Phase</p>
          </div>
          <span class="text-xs font-mono px-2 py-1 rounded-full bg-${color}-500/20 text-${color}-400">${done}/${total}</span>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-1.5 mb-3">
          <div class="h-1.5 rounded-full bg-${color}-500 transition-all" style="width:${pct}%"></div>
        </div>
        <div class="space-y-2">
          ${g.criteria.map((c, i) => `
            <label class="flex items-center gap-2 cursor-pointer group" onclick="toggleGate('${g.id}', ${i})">
              <div class="w-4 h-4 rounded border ${checks[i] ? 'bg-emerald-500 border-emerald-500' : 'border-slate-600 group-hover:border-slate-400'} flex items-center justify-center">
                ${checks[i] ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}
              </div>
              <span class="text-xs ${checks[i] ? 'text-slate-400 line-through' : 'text-slate-300'}">${c}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function toggleGate(gateId, idx) {
  gateStates[currentOpp.id][gateId][idx] = !gateStates[currentOpp.id][gateId][idx];
  renderGates();
  updateScore();
}

function updateScore() {
  const states = gateStates[currentOpp.id];
  let total = 0, done = 0;
  Object.values(states).forEach(checks => { total += checks.length; done += checks.filter(Boolean).length; });
  const pct = total > 0 ? Math.round((done/total)*100) : 0;

  const circumference = 314.16;
  document.getElementById('scoreArc').style.strokeDashoffset = circumference - (circumference * pct / 100);
  document.getElementById('scoreText').textContent = pct;

  const arc = document.getElementById('scoreArc');
  arc.setAttribute('stroke', pct >= 80 ? '#10b981' : pct >= 50 ? '#f59e0b' : '#00E5FA');

  const badge = document.getElementById('goNoGo');
  if (pct >= 80) { badge.textContent = 'GO'; badge.className = 'text-sm font-bold px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400'; }
  else if (pct >= 50) { badge.textContent = 'CONDITIONAL'; badge.className = 'text-sm font-bold px-3 py-1 rounded-full bg-amber-500/20 text-amber-400'; }
  else { badge.textContent = 'NO-GO'; badge.className = 'text-sm font-bold px-3 py-1 rounded-full bg-red-500/20 text-red-400'; }
}

// Actions
function addAction() {
  const name = prompt('Action item:');
  if (!name) return;
  actions.push({ id: Date.now(), text: name, done: false, owner: 'Unassigned', due: 'TBD' });
  renderActions();
}

function toggleAction(id) {
  const a = actions.find(x => x.id === id);
  if (a) a.done = !a.done;
  renderActions();
}

function renderActions() {
  const c = document.getElementById('actionsContainer');
  if (!actions.length) { c.innerHTML = '<p class="text-xs text-slate-600">No actions yet. Click + Add Action to start.</p>'; return; }
  c.innerHTML = actions.map(a => `
    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-800/50 transition-colors">
      <button onclick="toggleAction(${a.id})" class="w-5 h-5 rounded border ${a.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-600'} flex items-center justify-center flex-shrink-0">
        ${a.done ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}
      </button>
      <span class="text-sm ${a.done ? 'text-slate-500 line-through' : 'text-white'} flex-1">${a.text}</span>
      <span class="text-xs text-slate-600">${a.owner}</span>
    </div>
  `).join('');
}

// Decisions
function logDecision() {
  const input = document.getElementById('decisionInput');
  const text = input.value.trim();
  if (!text) return;
  decisions.unshift({ text, time: new Date().toLocaleString(), opp: currentOpp.name });
  input.value = '';
  renderDecisions();
}

function renderDecisions() {
  const c = document.getElementById('decisionLog');
  if (!decisions.length) { c.innerHTML = '<p class="text-xs text-slate-600">No decisions logged yet.</p>'; return; }
  c.innerHTML = decisions.slice(0, 10).map(d => `
    <div class="flex items-start gap-3 p-2 border-l-2 border-slate-700">
      <div class="flex-1">
        <p class="text-sm text-white">${d.text}</p>
        <p class="text-xs text-slate-500 mt-1">${d.time}</p>
      </div>
    </div>
  `).join('');
}

init();
</script>
</body>
</html>
