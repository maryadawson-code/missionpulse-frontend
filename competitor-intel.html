<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Competitor Intel ‚Äî MissionPulse</title>
<link rel="icon" type="image/png" sizes="32x32" href="MMT_icon_32px.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body{background:#00050F;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
.glow-border{border:1px solid rgba(0,229,250,0.2);box-shadow:0 0 15px rgba(0,229,250,0.03)}
.card{background:#0A1628;border:1px solid #1E293B;border-radius:12px;padding:20px;transition:border-color 0.15s}
.card:hover{border-color:rgba(0,229,250,0.3)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:50}
.modal-overlay.show{display:flex}
.threat-high{color:#EF4444;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
.threat-medium{color:#F59E0B;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3)}
.threat-low{color:#10B981;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3)}
</style>
</head>
<body class="text-slate-300 min-h-screen">
<div class="max-w-7xl mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="flex items-center gap-3">
        <a href="dashboard-v2.html" class="text-slate-500 hover:text-cyan-400 text-sm">‚Üê Dashboard</a>
        <h1 class="text-2xl font-bold text-white">Competitor Intel</h1>
      </div>
      <p class="text-slate-500 text-sm mt-1">Know your competition ‚Äî strengths, weaknesses, and threat level</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="dataBadge" class="text-xs px-2 py-1 rounded font-mono"></span>
      <button onclick="openAddModal()" class="bg-cyan-500 hover:bg-cyan-400 text-[#00050F] px-4 py-2 rounded-lg text-sm font-semibold">+ Add Competitor</button>
    </div>
  </div>

  <div id="cardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  <div id="emptyState" class="hidden text-center py-16 text-slate-500">
    <div class="text-4xl mb-3">üéØ</div>
    <p>No competitors tracked yet.</p>
    <button onclick="openAddModal()" class="text-cyan-400 hover:text-cyan-300 text-sm mt-2">Add your first competitor ‚Üí</button>
  </div>
  <div class="text-center mt-8 text-xs text-slate-600">MISSION MEETS TECH ¬∑ AI GENERATED ‚Äî REQUIRES HUMAN REVIEW</div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="bg-[#0A1628] border border-slate-700 rounded-xl p-6 w-full max-w-lg mx-4">
    <h3 class="text-lg font-bold text-white mb-4" id="modalTitle">Add Competitor</h3>
    <input type="hidden" id="editId">
    <div class="space-y-3">
      <div><label class="block text-xs text-slate-400 mb-1">Competitor Name</label><input id="fName" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Booz Allen Hamilton"></div>
      <div><label class="block text-xs text-slate-400 mb-1">Description / Overview</label><textarea id="fDesc" rows="2" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Large firm, DHA incumbent..."></textarea></div>
      <div><label class="block text-xs text-slate-400 mb-1">Strengths</label><textarea id="fStrengths" rows="2" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="Incumbent advantage, deep bench..."></textarea></div>
      <div><label class="block text-xs text-slate-400 mb-1">Weaknesses</label><textarea id="fWeaknesses" rows="2" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white" placeholder="High rates, slow innovation..."></textarea></div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="block text-xs text-slate-400 mb-1">Threat Level</label>
          <select id="fThreat" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
            <option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option>
          </select>
        </div>
        <div><label class="block text-xs text-slate-400 mb-1">Status</label>
          <select id="fStatus" class="w-full bg-[#1E293B] border border-slate-600 rounded-lg px-3 py-2 text-sm text-white">
            <option value="active">Active</option><option value="watching">Watching</option><option value="eliminated">Eliminated</option>
          </select>
        </div>
      </div>
    </div>
    <div class="flex gap-3 mt-5">
      <button onclick="closeModal()" class="flex-1 py-2 rounded-lg text-sm border border-slate-600 text-slate-400 hover:border-slate-400">Cancel</button>
      <button onclick="saveItem()" class="flex-1 py-2 rounded-lg text-sm font-semibold bg-cyan-500 text-[#00050F] hover:bg-cyan-400">Save</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL='https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
var sbClient;try{sbClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON)}catch(e){}

let items=[],companyId=null,isLive=false;

// competitive_matrix stores: matrix_name (competitor name), description, status
// We'll use description as JSON to store strengths/weaknesses/threat
const DEMO_DATA=[
  {id:'d1',matrix_name:'Booz Allen Hamilton',description:'Large firm, DHA incumbent on multiple contracts',status:'active',_strengths:'Incumbent advantage, deep bench, past performance',_weaknesses:'High rates, bureaucratic, slow to innovate',_threat:'high'},
  {id:'d2',matrix_name:'Leidos',description:'Strong health IT portfolio, DHMSM experience',status:'active',_strengths:'MHS Genesis experience, cleared staff',_weaknesses:'Integration challenges, post-merger culture',_threat:'high'},
  {id:'d3',matrix_name:'Accenture Federal',description:'Management consulting + tech delivery',status:'watching',_strengths:'Brand recognition, innovation labs',_weaknesses:'Premium pricing, turnover',_threat:'medium'},
  {id:'d4',matrix_name:'GDIT',description:'Infrastructure and cloud services focus',status:'active',_strengths:'Cloud migration experience, GovCloud certified',_weaknesses:'Less health IT specific, commodity positioning',_threat:'low'},
];

function parseMetadata(item){
  try{
    if(item._strengths)return{strengths:item._strengths,weaknesses:item._weaknesses,threat:item._threat};
    const meta=JSON.parse(item.description||'{}');
    return{strengths:meta.strengths||'',weaknesses:meta.weaknesses||'',threat:meta.threat||'medium',desc:meta.desc||''};
  }catch(e){return{strengths:'',weaknesses:'',threat:'medium',desc:item.description||''}}
}

(async()=>{
  if(!sbClient){useDemoMode();return}
  const{data:{session}}=await sbClient.auth.getSession();
  if(!session){useDemoMode();return}
  const{data:profile}=await sbClient.from('profiles').select('company_id').eq('id',session.user.id).single();
  if(!profile?.company_id){useDemoMode();return}
  companyId=profile.company_id;
  await loadFromSupabase();
})();

async function loadFromSupabase(){
  const{data,error}=await sbClient.from('competitive_matrix').select('*').order('created_at',{ascending:false});
  if(error){useDemoMode();return}
  items=data;isLive=true;
  document.getElementById('dataBadge').textContent='Live ‚Äî Supabase';
  document.getElementById('dataBadge').className='text-xs px-2 py-1 rounded font-mono bg-green-900 text-green-300';
  renderCards();
}

function useDemoMode(){
  items=DEMO_DATA;isLive=false;
  document.getElementById('dataBadge').textContent='Demo Mode';
  document.getElementById('dataBadge').className='text-xs px-2 py-1 rounded font-mono bg-amber-900 text-amber-300';
  renderCards();
}

function renderCards(){
  const grid=document.getElementById('cardGrid');
  if(items.length===0){grid.innerHTML='';document.getElementById('emptyState').classList.remove('hidden');return}
  document.getElementById('emptyState').classList.add('hidden');
  grid.innerHTML=items.map(i=>{
    const m=parseMetadata(i);
    const threatClass=m.threat==='high'?'threat-high':m.threat==='medium'?'threat-medium':'threat-low';
    return `
    <div class="card">
      <div class="flex items-start justify-between mb-3">
        <h3 class="text-white font-bold text-base">${i.matrix_name}</h3>
        <span class="text-xs px-2 py-0.5 rounded font-semibold capitalize ${threatClass}">${m.threat}</span>
      </div>
      <p class="text-slate-400 text-sm mb-3">${m.desc||i.description||''}</p>
      ${m.strengths?`<div class="mb-2"><div class="text-xs text-green-400 font-semibold mb-1">STRENGTHS</div><p class="text-sm text-slate-300">${m.strengths}</p></div>`:''}
      ${m.weaknesses?`<div class="mb-3"><div class="text-xs text-red-400 font-semibold mb-1">WEAKNESSES</div><p class="text-sm text-slate-300">${m.weaknesses}</p></div>`:''}
      <div class="flex items-center justify-between pt-3 border-t border-slate-800">
        <span class="text-xs text-slate-500 capitalize">${i.status||'active'}</span>
        <div>
          <button onclick="editItem('${i.id}')" class="text-slate-500 hover:text-cyan-400 text-xs mr-2">Edit</button>
          <button onclick="deleteItem('${i.id}')" class="text-slate-500 hover:text-red-400 text-xs">Delete</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openAddModal(){
  document.getElementById('modalTitle').textContent='Add Competitor';
  document.getElementById('editId').value='';
  ['fName','fDesc','fStrengths','fWeaknesses'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fThreat').value='medium';
  document.getElementById('fStatus').value='active';
  document.getElementById('modal').classList.add('show');
}

function editItem(id){
  const item=items.find(i=>i.id===id);if(!item)return;
  const m=parseMetadata(item);
  document.getElementById('modalTitle').textContent='Edit Competitor';
  document.getElementById('editId').value=id;
  document.getElementById('fName').value=item.matrix_name||'';
  document.getElementById('fDesc').value=m.desc||item.description||'';
  document.getElementById('fStrengths').value=m.strengths||'';
  document.getElementById('fWeaknesses').value=m.weaknesses||'';
  document.getElementById('fThreat').value=m.threat||'medium';
  document.getElementById('fStatus').value=item.status||'active';
  document.getElementById('modal').classList.add('show');
}

function closeModal(){document.getElementById('modal').classList.remove('show')}

async function saveItem(){
  const id=document.getElementById('editId').value;
  const name=document.getElementById('fName').value.trim();
  if(!name){alert('Competitor name is required');return}
  const meta=JSON.stringify({
    desc:document.getElementById('fDesc').value.trim(),
    strengths:document.getElementById('fStrengths').value.trim(),
    weaknesses:document.getElementById('fWeaknesses').value.trim(),
    threat:document.getElementById('fThreat').value,
  });
  const row={
    matrix_name:name,
    description:meta,
    status:document.getElementById('fStatus').value,
  };
  if(isLive){
    row.company_id=companyId;row.updated_at=new Date().toISOString();
    if(id){await sbClient.from('competitive_matrix').update(row).eq('id',id)}
    else{await sbClient.from('competitive_matrix').insert(row)}
    await loadFromSupabase();
  }else{
    if(id){const idx=items.findIndex(i=>i.id===id);if(idx>=0)items[idx]={...items[idx],...row}}
    else{items.unshift({id:'d'+Date.now(),...row,_strengths:document.getElementById('fStrengths').value.trim(),_weaknesses:document.getElementById('fWeaknesses').value.trim(),_threat:document.getElementById('fThreat').value})}
    renderCards();
  }
  closeModal();
}

async function deleteItem(id){
  if(!confirm('Delete this competitor?'))return;
  if(isLive){await sbClient.from('competitive_matrix').delete().eq('id',id);await loadFromSupabase()}
  else{items=items.filter(i=>i.id!==id);renderCards()}
}
</script>
</body>
</html>
