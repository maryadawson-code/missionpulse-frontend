<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War Room | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a1628; }
        ::-webkit-scrollbar-thumb { background: #00E5FA; border-radius: 3px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-pulse { animation: pulse 2s infinite; }
    </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="bg-[#00050F] text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MTcyNjUsImV4cCI6MjA1MjI5MzI2NX0.DACT1xnVtJeHx5tL7_K8y1hOx9NyJE7B6UBhPqwHHx8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

        const TABS = ['Overview', 'Requirements', 'Competitors', 'Team', 'Compliance', 'Pricing', 'Timeline'];

        const App = () => {
            const [opportunities, setOpportunities] = useState([]);
            const [selectedOpp, setSelectedOpp] = useState(null);
            const [activeTab, setActiveTab] = useState('Overview');
            const [loading, setLoading] = useState(true);
            const [connected, setConnected] = useState(false);
            const [relatedData, setRelatedData] = useState({
                requirements: [],
                competitors: [],
                team: [],
                compliance: [],
                pricing: []
            });

            const loadOpportunities = async () => {
                try {
                    const { data, error } = await supabase
                        .from('opportunities')
                        .select('*')
                        .order('proposal_due_date', { ascending: true });
                    
                    if (error) throw error;
                    setOpportunities(data || []);
                    setConnected(true);
                    if (data?.length && !selectedOpp) {
                        setSelectedOpp(data[0]);
                    }
                } catch (e) {
                    console.error('Load error:', e);
                    setConnected(false);
                } finally {
                    setLoading(false);
                }
            };

            const loadRelatedData = async (oppId) => {
                if (!oppId) return;
                
                try {
                    const [req, comp, team, compl, pricing] = await Promise.all([
                        supabase.from('rfp_requirements').select('*').eq('opportunity_id', oppId),
                        supabase.from('competitors').select('*').eq('opportunity_id', oppId),
                        supabase.from('team_assignments').select('*').eq('opportunity_id', oppId),
                        supabase.from('compliance_items').select('*').eq('opportunity_id', oppId),
                        supabase.from('pricing_items').select('*').eq('opportunity_id', oppId)
                    ]);

                    setRelatedData({
                        requirements: req.data || [],
                        competitors: comp.data || [],
                        team: team.data || [],
                        compliance: compl.data || [],
                        pricing: pricing.data || []
                    });
                } catch (e) {
                    console.error('Load related data error:', e);
                }
            };

            useEffect(() => {
                loadOpportunities();
            }, []);

            useEffect(() => {
                if (selectedOpp?.id) {
                    loadRelatedData(selectedOpp.id);
                }
            }, [selectedOpp?.id]);

            const formatCurrency = (val) => {
                const num = parseFloat(val) || 0;
                if (num >= 1000000) return `$${(num/1000000).toFixed(1)}M`;
                if (num >= 1000) return `$${(num/1000).toFixed(0)}K`;
                return `$${num.toFixed(0)}`;
            };

            const getDaysUntilDue = (date) => {
                if (!date) return null;
                const diff = Math.ceil((new Date(date) - new Date()) / (1000 * 60 * 60 * 24));
                return diff;
            };

            const StatCard = ({ icon, label, value, subtext, color = 'text-[#00E5FA]' }) => (
                <div className="bg-[#0d1f3c] rounded-xl p-4 border border-white/10">
                    <div className="flex items-center gap-2 text-white/60 text-sm mb-1">
                        <span>{icon}</span>
                        <span>{label}</span>
                    </div>
                    <div className={`text-2xl font-bold ${color}`}>{value}</div>
                    {subtext && <div className="text-xs text-white/40 mt-1">{subtext}</div>}
                </div>
            );

            const OverviewTab = () => (
                <div className="space-y-6">
                    <div className="grid grid-cols-4 gap-4">
                        <StatCard icon="üí∞" label="Contract Value" value={formatCurrency(selectedOpp.contract_value)} />
                        <StatCard icon="üìä" label="Win Probability" value={`${selectedOpp.pwin || 0}%`} color={selectedOpp.pwin >= 70 ? 'text-emerald-400' : selectedOpp.pwin >= 40 ? 'text-amber-400' : 'text-red-400'} />
                        <StatCard icon="üìÖ" label="Days Until Due" value={getDaysUntilDue(selectedOpp.proposal_due_date) || 'N/A'} color={getDaysUntilDue(selectedOpp.proposal_due_date) <= 14 ? 'text-red-400' : 'text-[#00E5FA]'} />
                        <StatCard icon="üéØ" label="Stage" value={selectedOpp.stage || 'TBD'} />
                    </div>

                    <div className="grid grid-cols-2 gap-6">
                        <div className="bg-[#0d1f3c] rounded-xl p-6 border border-white/10">
                            <h3 className="font-semibold mb-4 flex items-center gap-2"><span>üìã</span> Opportunity Details</h3>
                            <dl className="space-y-3">
                                <div className="flex justify-between"><dt className="text-white/60">Customer</dt><dd>{selectedOpp.customer}</dd></div>
                                <div className="flex justify-between"><dt className="text-white/60">Solicitation #</dt><dd>{selectedOpp.solicitation_number || '-'}</dd></div>
                                <div className="flex justify-between"><dt className="text-white/60">NAICS Code</dt><dd>{selectedOpp.naics_code || '-'}</dd></div>
                                <div className="flex justify-between"><dt className="text-white/60">Contract Type</dt><dd>{selectedOpp.contract_type || '-'}</dd></div>
                                <div className="flex justify-between"><dt className="text-white/60">Set-Aside</dt><dd>{selectedOpp.set_aside || 'Full & Open'}</dd></div>
                                <div className="flex justify-between"><dt className="text-white/60">Due Date</dt><dd>{selectedOpp.proposal_due_date ? new Date(selectedOpp.proposal_due_date).toLocaleDateString() : '-'}</dd></div>
                            </dl>
                        </div>

                        <div className="bg-[#0d1f3c] rounded-xl p-6 border border-white/10">
                            <h3 className="font-semibold mb-4 flex items-center gap-2"><span>üìà</span> Quick Stats</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="text-center p-3 bg-white/5 rounded-lg">
                                    <div className="text-2xl font-bold text-[#00E5FA]">{relatedData.requirements.length}</div>
                                    <div className="text-xs text-white/60">Requirements</div>
                                </div>
                                <div className="text-center p-3 bg-white/5 rounded-lg">
                                    <div className="text-2xl font-bold text-amber-400">{relatedData.competitors.length}</div>
                                    <div className="text-xs text-white/60">Competitors</div>
                                </div>
                                <div className="text-center p-3 bg-white/5 rounded-lg">
                                    <div className="text-2xl font-bold text-emerald-400">{relatedData.team.length}</div>
                                    <div className="text-xs text-white/60">Team Members</div>
                                </div>
                                <div className="text-center p-3 bg-white/5 rounded-lg">
                                    <div className="text-2xl font-bold text-purple-400">{relatedData.pricing.length}</div>
                                    <div className="text-xs text-white/60">Pricing Items</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {selectedOpp.description && (
                        <div className="bg-[#0d1f3c] rounded-xl p-6 border border-white/10">
                            <h3 className="font-semibold mb-3">Description</h3>
                            <p className="text-white/70">{selectedOpp.description}</p>
                        </div>
                    )}
                </div>
            );

            const RequirementsTab = () => (
                <div className="bg-[#0d1f3c] rounded-xl border border-white/10 overflow-hidden">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center">
                        <h3 className="font-semibold">RFP Requirements ({relatedData.requirements.length})</h3>
                        <a href="missionpulse-rfpshredder-v2.html" className="text-sm text-[#00E5FA] hover:underline">Open RFP Shredder ‚Üí</a>
                    </div>
                    {relatedData.requirements.length === 0 ? (
                        <div className="p-8 text-center text-white/50">No requirements extracted yet. Use RFP Shredder to add.</div>
                    ) : (
                        <table className="w-full text-sm">
                            <thead className="bg-[#00050F]/50">
                                <tr>
                                    <th className="text-left p-3 text-white/60">Section</th>
                                    <th className="text-left p-3 text-white/60">Requirement</th>
                                    <th className="text-center p-3 text-white/60">Status</th>
                                    <th className="text-center p-3 text-white/60">Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                {relatedData.requirements.slice(0, 10).map(r => (
                                    <tr key={r.id} className="border-t border-white/5 hover:bg-white/5">
                                        <td className="p-3 font-mono text-xs">{r.section_reference || '-'}</td>
                                        <td className="p-3">{r.requirement_text?.substring(0, 100)}...</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-0.5 rounded text-xs ${r.status === 'Complete' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                                                {r.status || 'Pending'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-center text-white/60">{r.priority || 'Medium'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            );

            const CompetitorsTab = () => (
                <div className="bg-[#0d1f3c] rounded-xl border border-white/10 overflow-hidden">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center">
                        <h3 className="font-semibold">Competitor Analysis ({relatedData.competitors.length})</h3>
                        <a href="missionpulse-blackhat-v2.html" className="text-sm text-[#00E5FA] hover:underline">Open Black Hat ‚Üí</a>
                    </div>
                    {relatedData.competitors.length === 0 ? (
                        <div className="p-8 text-center text-white/50">No competitors identified yet. Use Black Hat module to add.</div>
                    ) : (
                        <div className="grid grid-cols-2 gap-4 p-4">
                            {relatedData.competitors.map(c => (
                                <div key={c.id} className="bg-[#00050F] p-4 rounded-lg border border-white/10">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="font-medium">{c.company_name || c.name}</span>
                                        <span className={`text-xs px-2 py-0.5 rounded ${c.threat_level === 'High' ? 'bg-red-500/20 text-red-400' : c.threat_level === 'Medium' ? 'bg-amber-500/20 text-amber-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                                            {c.threat_level || 'Unknown'} Threat
                                        </span>
                                    </div>
                                    {c.incumbent && <div className="text-xs text-amber-400 mb-2">‚ö†Ô∏è Incumbent</div>}
                                    {c.ghost_strategy && <p className="text-sm text-white/60">{c.ghost_strategy.substring(0, 100)}...</p>}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            const TeamTab = () => (
                <div className="bg-[#0d1f3c] rounded-xl border border-white/10 overflow-hidden">
                    <div className="p-4 border-b border-white/10">
                        <h3 className="font-semibold">Team Assignments ({relatedData.team.length})</h3>
                    </div>
                    {relatedData.team.length === 0 ? (
                        <div className="p-8 text-center text-white/50">No team members assigned yet.</div>
                    ) : (
                        <table className="w-full text-sm">
                            <thead className="bg-[#00050F]/50">
                                <tr>
                                    <th className="text-left p-3 text-white/60">Name</th>
                                    <th className="text-left p-3 text-white/60">Role</th>
                                    <th className="text-center p-3 text-white/60">Hours</th>
                                </tr>
                            </thead>
                            <tbody>
                                {relatedData.team.map(t => (
                                    <tr key={t.id} className="border-t border-white/5 hover:bg-white/5">
                                        <td className="p-3">{t.user_name || t.name || '-'}</td>
                                        <td className="p-3 text-white/70">{t.role || '-'}</td>
                                        <td className="p-3 text-center">{t.allocated_hours || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            );

            const renderTabContent = () => {
                switch (activeTab) {
                    case 'Overview': return <OverviewTab />;
                    case 'Requirements': return <RequirementsTab />;
                    case 'Competitors': return <CompetitorsTab />;
                    case 'Team': return <TeamTab />;
                    default: return <div className="text-center py-12 text-white/50">Tab content coming soon...</div>;
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-[#00E5FA]/20 border-t-[#00E5FA] rounded-full animate-spin mx-auto mb-4"></div>
                            <div className="text-white/60">Loading War Room...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-[#00050F] p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="flex items-center justify-between mb-6">
                            <div>
                                <h1 className="text-2xl font-bold flex items-center gap-3">
                                    <span className="text-3xl">‚öîÔ∏è</span>
                                    War Room
                                </h1>
                                <p className="text-white/60 mt-1">Opportunity command center</p>
                            </div>
                            <div className="flex items-center gap-4">
                                <select
                                    value={selectedOpp?.id || ''}
                                    onChange={(e) => {
                                        const opp = opportunities.find(o => o.id === e.target.value);
                                        setSelectedOpp(opp);
                                    }}
                                    className="bg-[#0d1f3c] border border-white/10 rounded-lg px-4 py-2 text-white min-w-[300px]"
                                >
                                    {opportunities.map(o => (
                                        <option key={o.id} value={o.id}>{o.title}</option>
                                    ))}
                                </select>
                                <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm ${connected ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                    <div className={`w-2 h-2 rounded-full ${connected ? 'bg-emerald-400' : 'bg-red-400'} status-pulse`}></div>
                                    {connected ? 'Connected' : 'Offline'}
                                </div>
                            </div>
                        </div>

                        {selectedOpp ? (
                            <>
                                {/* Opportunity Title Bar */}
                                <div className="bg-gradient-to-r from-[#00E5FA]/10 to-transparent rounded-xl p-6 mb-6 border border-[#00E5FA]/20">
                                    <h2 className="text-xl font-bold">{selectedOpp.title}</h2>
                                    <div className="flex items-center gap-4 mt-2 text-sm text-white/60">
                                        <span>üè¢ {selectedOpp.customer}</span>
                                        <span>üìù {selectedOpp.solicitation_number || 'No Sol #'}</span>
                                        <span>üí∞ {formatCurrency(selectedOpp.contract_value)}</span>
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex gap-2 mb-6 border-b border-white/10 pb-2">
                                    {TABS.map(tab => (
                                        <button
                                            key={tab}
                                            onClick={() => setActiveTab(tab)}
                                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === tab ? 'bg-[#00E5FA] text-[#00050F]' : 'bg-white/5 text-white/70 hover:bg-white/10'}`}
                                        >
                                            {tab}
                                        </button>
                                    ))}
                                </div>

                                {/* Tab Content */}
                                {renderTabContent()}
                            </>
                        ) : (
                            <div className="text-center py-12 text-white/50">
                                No opportunities found. Add one in Pipeline first.
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-[#00050F]/90 border-t border-white/10 p-2 text-center text-xs text-white/40">
                        AI GENERATED - REQUIRES HUMAN REVIEW | MissionPulse ¬© 2026 Mission Meets Tech
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
