<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 - Production</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PDF.js for PDF extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js for Word documents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- SheetJS for Excel files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#00050F;min-height:100vh}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn 0.3s ease-out}
    .animate-pulse{animation:pulse 2s ease-in-out infinite}
    .animate-spin{animation:spin 1s linear infinite}
    .glass{background:rgba(30,41,59,0.5);backdrop-filter:blur(8px);border:1px solid rgba(71,85,105,0.3);border-radius:12px}
    .hover-lift{transition:transform 0.2s,box-shadow 0.2s}
    .hover-lift:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,229,250,0.1)}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    .drag-over{background:rgba(0,229,250,0.1)!important;border-color:rgba(0,229,250,0.5)!important}
    .dropzone{border:2px dashed rgba(71,85,105,0.5);transition:all 0.3s}
    .dropzone:hover,.dropzone.active{border-color:rgba(0,229,250,0.5);background:rgba(0,229,250,0.05)}
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body>
<div id="root"></div>
<script src="supabase-client.js"></script>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef}=React;

// PDF.js worker
if(typeof pdfjsLib!=='undefined')pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ============================================================
// CONFIGURATION
// ============================================================
const RENDER_API_URL='https://missionpulse-api.onrender.com';

// Supported file types
const SUPPORTED_TYPES={
  pdf:{ext:['.pdf'],mime:['application/pdf'],icon:'üìÑ',color:'text-red-400'},
  word:{ext:['.doc','.docx'],mime:['application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'],icon:'üìù',color:'text-blue-400'},
  excel:{ext:['.xls','.xlsx'],mime:['application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'],icon:'üìä',color:'text-emerald-400'}
};

// ============================================================
// FILE EXTRACTION FUNCTIONS
// ============================================================

// Extract text from PDF
async function extractPDFText(file){
  return new Promise(async(resolve,reject)=>{
    try{
      const arrayBuffer=await file.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
      let fullText='';
      for(let i=1;i<=pdf.numPages;i++){
        const page=await pdf.getPage(i);
        const content=await page.getTextContent();
        const pageText=content.items.map(item=>item.str).join(' ');
        fullText+=pageText+'\n\n';
      }
      resolve({text:fullText,pages:pdf.numPages,type:'pdf'});
    }catch(e){reject(e)}
  });
}

// Extract text from Word document (.docx)
async function extractWordText(file){
  return new Promise(async(resolve,reject)=>{
    try{
      const arrayBuffer=await file.arrayBuffer();
      const result=await mammoth.extractRawText({arrayBuffer});
      const text=result.value||'';
      const pageEstimate=Math.ceil(text.split(/\s+/).length/300);
      resolve({text,pages:pageEstimate,type:'word',warnings:result.messages});
    }catch(e){reject(e)}
  });
}

// Extract text from Excel file (.xlsx)
async function extractExcelText(file){
  return new Promise(async(resolve,reject)=>{
    try{
      const arrayBuffer=await file.arrayBuffer();
      const workbook=XLSX.read(arrayBuffer,{type:'array'});
      let fullText='';
      let totalRows=0;
      
      // Process each sheet
      workbook.SheetNames.forEach(sheetName=>{
        fullText+=`\n=== SHEET: ${sheetName} ===\n`;
        const sheet=workbook.Sheets[sheetName];
        const data=XLSX.utils.sheet_to_json(sheet,{header:1,defval:''});
        
        data.forEach((row,i)=>{
          if(Array.isArray(row)&&row.some(cell=>cell!=='')){
            fullText+=row.join(' | ')+'\n';
            totalRows++;
          }
        });
      });
      
      resolve({text:fullText,pages:workbook.SheetNames.length,sheets:workbook.SheetNames,rows:totalRows,type:'excel'});
    }catch(e){reject(e)}
  });
}

// Universal file extractor
async function extractFileContent(file){
  const fileName=file.name.toLowerCase();
  const fileType=file.type;
  
  // Determine file type and extract
  if(fileName.endsWith('.pdf')||fileType.includes('pdf')){
    return await extractPDFText(file);
  }else if(fileName.endsWith('.docx')||fileType.includes('wordprocessingml')){
    return await extractWordText(file);
  }else if(fileName.endsWith('.doc')){
    // .doc files (old Word format) - limited support
    return{text:`[Legacy .doc format - please convert to .docx for best results]\nFile: ${file.name}`,pages:1,type:'word-legacy'};
  }else if(fileName.endsWith('.xlsx')||fileName.endsWith('.xls')||fileType.includes('spreadsheet')||fileType.includes('excel')){
    return await extractExcelText(file);
  }else{
    throw new Error(`Unsupported file type: ${fileName}`);
  }
}

// Get file type info
function getFileTypeInfo(fileName){
  const lower=fileName.toLowerCase();
  if(lower.endsWith('.pdf'))return{...SUPPORTED_TYPES.pdf,name:'PDF'};
  if(lower.endsWith('.doc')||lower.endsWith('.docx'))return{...SUPPORTED_TYPES.word,name:'Word'};
  if(lower.endsWith('.xls')||lower.endsWith('.xlsx'))return{...SUPPORTED_TYPES.excel,name:'Excel'};
  return{icon:'üìé',color:'text-slate-400',name:'File'};
}

// ============================================================
// AUTH HELPERS
// ============================================================
function checkAuth(){
  const session=localStorage.getItem('MP_SESSION');
  const user=localStorage.getItem('MP_USER');
  if(!session||!user){window.location.href='login.html';return null}
  try{
    const parsed=JSON.parse(user);
    const sess=JSON.parse(session);
    if(sess.expires&&new Date(sess.expires)<new Date()){localStorage.clear();window.location.href='login.html';return null}
    return parsed;
  }catch{return{email:'demo@mmt.com',name:'Demo User',role:'CEO'}}
}
function handleLogout(){localStorage.removeItem('MP_SESSION');localStorage.removeItem('MP_USER');window.location.href='login.html'}

// ============================================================
// ROLES & MODULES
// ============================================================
const ROLES=[
  {id:'CEO',name:'CEO',fullName:'Mary Womack',icon:'üëë',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']},
  {id:'COO',name:'COO',fullName:'David Chen',icon:'üíº',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','pricing','hitl','frenemy','launch','post_award','playbook','training']},
  {id:'CAP',name:'Capture',fullName:'Michael Torres',icon:'üéØ',access:['dashboard','pipeline','warroom','swimlane','blackhat','frenemy','playbook']},
  {id:'PM',name:'Proposal Mgr',fullName:'Lisa Martinez',icon:'üìã',access:['dashboard','pipeline','warroom','swimlane','compliance','writer','hitl','orals','launch','post_award','playbook']},
  {id:'SA',name:'Solution Arch',fullName:'Sarah Chen',icon:'üíª',access:['dashboard','writer','compliance','contracts','orals','playbook']},
  {id:'FIN',name:'Pricing',fullName:'Jennifer Park',icon:'üí∞',access:['dashboard','pricing','contracts','launch','playbook']},
  {id:'CON',name:'Contracts',fullName:'Robert Williams',icon:'‚öñÔ∏è',access:['dashboard','compliance','contracts','hitl','playbook']},
  {id:'DEL',name:'Delivery',fullName:'Amanda Foster',icon:'üë•',access:['dashboard','writer','post_award','orals','playbook']},
  {id:'Admin',name:'Admin',fullName:'System Admin',icon:'‚öôÔ∏è',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']}
];

const MODULES=[
  {id:'dashboard',name:'Mission Control',icon:'‚ö°',cat:'Command'},
  {id:'pipeline',name:'Pipeline Intel',icon:'üìä',cat:'Strategy'},
  {id:'warroom',name:'War Room',icon:'‚öîÔ∏è',cat:'Strategy'},
  {id:'swimlane',name:'Swimlane Board',icon:'üìã',cat:'Strategy'},
  {id:'compliance',name:'RFP Shredder',icon:'üìÑ',cat:'Intel'},
  {id:'contracts',name:'Contract Scanner',icon:'‚öñÔ∏è',cat:'Intel'},
  {id:'writer',name:'Iron Dome',icon:'‚úèÔ∏è',cat:'Intel'},
  {id:'blackhat',name:'Black Hat',icon:'üé≠',cat:'Intel',badge:'PRIVATE'},
  {id:'pricing',name:'Pricing Engine',icon:'üíµ',cat:'Delivery',badge:'CUI'},
  {id:'hitl',name:'HITL Queue',icon:'üëÅÔ∏è',cat:'Delivery'},
  {id:'orals',name:'Orals Studio',icon:'üé§',cat:'Delivery'},
  {id:'frenemy',name:'Frenemy Protocol',icon:'üõ°Ô∏è',cat:'Delivery'},
  {id:'launch',name:'Launch & ROI',icon:'üöÄ',cat:'Command'},
  {id:'post_award',name:'Post-Award',icon:'üì¶',cat:'Command'},
  {id:'playbook',name:'Playbook',icon:'‚≠ê',cat:'Admin'},
  {id:'admin',name:'Admin',icon:'‚öôÔ∏è',cat:'Admin',badge:'ADMIN'},
  {id:'training',name:'Training Hub',icon:'üéì',cat:'Admin'},
  {id:'audit',name:'Audit Log',icon:'üìú',cat:'Admin',badge:'ADMIN'}
];

const SHIPLEY_PHASES=[
  {key:'qualify',name:'Qualify',color:'#64748b'},
  {key:'capture',name:'Capture',color:'#8b5cf6'},
  {key:'blue_team',name:'Blue Team',color:'#3b82f6'},
  {key:'pink_team',name:'Pink Team',color:'#ec4899'},
  {key:'red_team',name:'Red Team',color:'#ef4444'},
  {key:'gold_team',name:'Gold Team',color:'#f59e0b'},
  {key:'white_glove',name:'White Glove',color:'#10b981'},
  {key:'submitted',name:'Submitted',color:'#22d3ee'}
];

const AGENCIES=['DHA','VA','CMS','IHS','SSA','CDC','NIH','HRSA','FDA','SAMHSA','ACF','AHRQ','DOD','HHS','GSA','Other'];

// ============================================================
// AI SERVICE
// ============================================================
const AIService={
  status:'checking',
  async checkConnection(){try{const c=new AbortController();setTimeout(()=>c.abort(),5000);const r=await fetch(`${RENDER_API_URL}/`,{signal:c.signal});this.status=r.ok?'connected':'offline'}catch{this.status='offline'}return this.status},
  async chat(agent,message,context={}){
    if(this.status==='connected'){try{const r=await fetch(`${RENDER_API_URL}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent,message,context})});if(r.ok){const d=await r.json();return{success:true,response:d.response||d.content||d,source:'api'}}}catch{}}
    return{success:true,response:this.getMockResponse(agent,message,context),source:'mock'}
  },
  getMockResponse(agent,message,context){
    const responses={
      blackhat:`## Competitive Analysis: ${context.competitor?.name||'Competitor'}\n\n**Threat Assessment:** ${context.competitor?.threat?.toUpperCase()||'MEDIUM'}\n\n### Ghosting Strategy:\n${context.competitor?.ghostStrategy||'Focus on differentiation.'}\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      writer:`## Generated: ${context.sectionType||'Content'}\n\n${message}\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      rfp_shredder:AIService.generateRFPAnalysis(context),
      orals:`## Orals Slide: ${context.slideTitle||'Overview'}\n\n**Key Points:**\n‚Ä¢ Lead with discriminator\n‚Ä¢ Support with evidence\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      assistant:`Based on Shipley methodology:\n\n1. Compliance first\n2. Win themes\n3. Ghost competition\n4. Quantify claims\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`
    };
    return responses[agent]||responses.assistant;
  },
  generateRFPAnalysis(context){
    const text=context.rfpText||'';
    const fileName=context.fileName||'document';
    const fileType=context.fileType||'pdf';
    const requirements=[];
    let refNum=1;
    
    // Enhanced pattern matching for federal RFP requirements
    const patterns=[
      {regex:/technical\s*(approach|solution|proposal)/gi,title:'Technical Approach',section:'L',conf:88},
      {regex:/management\s*(approach|plan|proposal)/gi,title:'Management Approach',section:'L',conf:85},
      {regex:/staffing\s*(plan|approach|matrix)/gi,title:'Staffing Plan',section:'L',conf:82},
      {regex:/past\s*performance/gi,title:'Past Performance',section:'L',conf:90},
      {regex:/key\s*personnel/gi,title:'Key Personnel',section:'L',conf:87},
      {regex:/transition\s*(plan|approach)/gi,title:'Transition Plan',section:'L',conf:80},
      {regex:/quality\s*(assurance|control|plan)/gi,title:'Quality Assurance Plan',section:'L',conf:78},
      {regex:/risk\s*(management|mitigation)/gi,title:'Risk Management',section:'L',conf:75},
      {regex:/security\s*(plan|approach|requirements)/gi,title:'Security Requirements',section:'L',conf:85},
      {regex:/oral\s*(presentation|proposal)/gi,title:'Oral Presentation',section:'L',conf:92},
      {regex:/price\s*(proposal|volume)/gi,title:'Price Proposal',section:'M',conf:88},
      {regex:/cost\s*(proposal|volume|narrative)/gi,title:'Cost Narrative',section:'M',conf:85},
      {regex:/labor\s*(categories|rates|mix)/gi,title:'Labor Categories',section:'M',conf:82},
      {regex:/basis\s*of\s*estimate/gi,title:'Basis of Estimate',section:'M',conf:80},
      {regex:/subcontracting\s*plan/gi,title:'Subcontracting Plan',section:'M',conf:78},
      {regex:/far\s+\d+/gi,title:'FAR Clause Compliance',section:'C',conf:90},
      {regex:/dfars/gi,title:'DFARS Compliance',section:'C',conf:88},
      {regex:/hipaa/gi,title:'HIPAA Compliance',section:'C',conf:92},
      {regex:/fedramp/gi,title:'FedRAMP Authorization',section:'C',conf:90},
      {regex:/508\s*compliance|accessibility/gi,title:'Section 508 Accessibility',section:'C',conf:85},
      {regex:/cmmc|cybersecurity\s*maturity/gi,title:'CMMC Compliance',section:'C',conf:88},
      {regex:/clearance|secret|top\s*secret/gi,title:'Security Clearance Requirements',section:'C',conf:90},
      {regex:/small\s*business|sdvosb|8\(a\)|hubzone|wosb/gi,title:'Small Business Requirements',section:'C',conf:85},
    ];
    
    // Excel-specific patterns (for pricing/labor matrices)
    if(fileType==='excel'){
      patterns.push(
        {regex:/labor\s*category|lcat/gi,title:'Labor Category Matrix',section:'M',conf:95},
        {regex:/hourly\s*rate|loaded\s*rate/gi,title:'Rate Schedule',section:'M',conf:92},
        {regex:/fte|full\s*time/gi,title:'FTE Requirements',section:'M',conf:85},
        {regex:/clin|contract\s*line/gi,title:'CLIN Structure',section:'M',conf:90},
        {regex:/ceiling|value|amount/gi,title:'Contract Value Analysis',section:'M',conf:80}
      );
    }
    
    const foundPatterns=new Set();
    patterns.forEach(p=>{
      if(p.regex.test(text)&&!foundPatterns.has(p.title)){
        foundPatterns.add(p.title);
        requirements.push({
          ref:`${p.section}.${refNum}.1`,
          title:p.title,
          section:p.section,
          status:'draft',
          confidence:p.conf+Math.floor(Math.random()*10)-5,
          owner:'Unassigned',
          source:fileName,
          sourceType:fileType
        });
        refNum++;
      }
    });
    
    // Extract solicitation number
    const solMatch=text.match(/solicitation\s*(number|#|no\.?)[:\s]*([A-Z0-9-]+)/i);
    const solicitationNumber=solMatch?solMatch[2]:null;
    
    // Extract contract value hints
    const valueMatch=text.match(/\$[\d,]+(?:\.\d{2})?\s*(million|m|billion|b)?/gi);
    const estimatedValue=valueMatch?valueMatch[0]:null;
    
    // Extract NAICS
    const naicsMatch=text.match(/naics[:\s]*(\d{6})/i);
    const naics=naicsMatch?naicsMatch[1]:null;
    
    // Extract set-aside
    const setAsidePatterns=['SDVOSB','8(a)','HUBZone','WOSB','Small Business','Full and Open'];
    let setAside=null;
    setAsidePatterns.forEach(p=>{if(text.toLowerCase().includes(p.toLowerCase()))setAside=p});

    return JSON.stringify({
      summary:{
        wordCount:text.split(/\s+/).length,
        pageEstimate:Math.ceil(text.split(/\s+/).length/300),
        requirementsFound:requirements.length,
        sectionsIdentified:[...new Set(requirements.map(r=>r.section))],
        solicitationNumber,
        estimatedValue,
        naics,
        setAside,
        fileType
      },
      requirements,
      warnings:text.split(/\s+/).length<100?['Document may be truncated']:[],
      aiGenerated:true
    });
  }
};

// ============================================================
// DEMO DATA
// ============================================================
const DEMO_OPPS=[
  {id:'1',name:'DHA MHS GENESIS Cloud Migration',nickname:'DHA EHR Mod',agency:'DHA',contractValue:98450210,shipleyPhase:'pink_team',winProbability:72,days:37,priority:'P-0'},
  {id:'2',name:'VA Enterprise Claims Modernization',nickname:'VA Claims AI',agency:'VA',contractValue:67500000,shipleyPhase:'blue_team',winProbability:58,days:82,priority:'P-1'},
  {id:'3',name:'CMS Quality Analytics Platform',nickname:'CMS Analytics',agency:'CMS',contractValue:125000000,shipleyPhase:'red_team',winProbability:68,days:21,priority:'P-0'},
  {id:'4',name:'IHS Telehealth Expansion',nickname:'IHS Telehealth',agency:'IHS',contractValue:32000000,shipleyPhase:'capture',winProbability:55,days:156,priority:'P-1'},
  {id:'5',name:'SSA Fraud Detection ML Platform',nickname:'SSA Fraud ML',agency:'SSA',contractValue:89000000,shipleyPhase:'gold_team',winProbability:81,days:14,priority:'P-0'},
  {id:'6',name:'CDC Disease Surveillance System',nickname:'CDC Surveillance',agency:'CDC',contractValue:78000000,shipleyPhase:'qualify',winProbability:42,days:120,priority:'P-2'}
];
const DEMO_COMPETITORS=[{id:'1',name:'Booz Allen Hamilton',threat:'high',strengths:['Incumbent','500+ staff'],weaknesses:['Premium pricing'],ghostStrategy:'Emphasize agility.'},{id:'2',name:'Deloitte Federal',threat:'high',strengths:['Brand recognition'],weaknesses:['Cost overruns'],ghostStrategy:'Reference VA delays.'},{id:'3',name:'GDIT',threat:'high',strengths:['Technical depth'],weaknesses:['Merger issues'],ghostStrategy:'Focus on healthcare.'}];
const DEMO_PARTNERS=[{id:'1',name:'CloudFirst Solutions',status:'Active',capabilities:['AWS','Azure','FedRAMP'],trustScore:92,socio:'SDVOSB',assigned:['DHA MHS GENESIS']},{id:'2',name:'DataSecure Inc',status:'Active',capabilities:['Cybersecurity','CMMC'],trustScore:88,socio:'8(a)',assigned:['CMS Analytics']}];
const DEMO_CONTRACTS=[{id:'1',vehicle:'GSA MAS',type:'IDIQ',risk:'low',clauses:12,findings:0,expiry:'2028-09-30'},{id:'2',vehicle:'CIO-SP3 SB',type:'GWAC',risk:'medium',clauses:28,findings:2,expiry:'2027-05-15'},{id:'3',vehicle:'SEWP V',type:'GWAC',risk:'low',clauses:15,findings:0,expiry:'2029-04-30'}];
const DEMO_SUBMISSIONS=[{id:'1',name:'DHA MHS GENESIS Phase 1',status:'Won',value:45000000,submitted:'2025-08-15',roi:847},{id:'2',name:'VA Claims Pilot',status:'Won',value:18500000,submitted:'2025-06-01',roi:523},{id:'3',name:'CMS Quality Dashboard',status:'Pending',value:67000000,submitted:'2026-01-10',roi:null}];
const DEMO_PLAYBOOK=[{id:'1',title:'Executive Summary - DHA Win',category:'Writing',score:96,uses:47,content:'Mission Meets Tech brings proven healthcare IT expertise...'},{id:'2',title:'Technical Innovation Theme',category:'Strategy',score:94,uses:38,content:'Unlike legacy approaches...'}];
const DEMO_LCATS=[{id:'1',title:'Program Manager',rate:195,hours:2080,wrap:1.85},{id:'2',title:'Sr. Software Engineer',rate:165,hours:4160,wrap:1.85},{id:'3',title:'Software Engineer',rate:135,hours:6240,wrap:1.85}];
const DEMO_HITL=[{id:'1',type:'Content',title:'Executive Summary Draft',author:'Sarah Chen',status:'pending',created:'2026-01-27'},{id:'2',type:'Pricing',title:'LCAT Rate Approval',author:'Jennifer Park',status:'pending',created:'2026-01-27'}];
const DEMO_AUDIT=[{id:'1',action:'LOGIN',user:'Mary Womack',role:'CEO',ts:'2026-01-28T10:00:00Z'},{id:'2',action:'RFP_UPLOAD',user:'Lisa Martinez',role:'PM',ts:'2026-01-28T09:45:00Z'}];

// Helpers
const fmt=v=>v>=1e9?`$${(v/1e9).toFixed(1)}B`:v>=1e6?`$${(v/1e6).toFixed(1)}M`:`$${(v||0).toLocaleString()}`;
const phaseName=p=>SHIPLEY_PHASES.find(s=>s.key===p)?.name||p;
const phaseColor=p=>SHIPLEY_PHASES.find(s=>s.key===p)?.color||'#64748b';

// Data hook
function useData(fetchFn,fallback,deps=[]){const[data,setData]=useState(fallback);const[loading,setLoading]=useState(true);const load=useCallback(async()=>{setLoading(true);try{if(typeof MissionPulse!=='undefined'&&fetchFn){const r=await fetchFn();if(r?.data&&r.data.length>0){setData(r.data)}else{setData(fallback)}}else{setData(fallback)}}catch{setData(fallback)}setLoading(false)},[]);useEffect(()=>{load()},[...deps]);return{data,loading,refresh:load,setData}}

// Icons
const Icon=({name,className='w-5 h-5'})=>{const icons={chevronLeft:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>,chevronRight:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,chevronDown:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>,x:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,check:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,send:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>,logout:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,refresh:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,search:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,upload:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,folder:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>,document:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>,plus:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>};return icons[name]||<span>‚óè</span>};
const StatusBar=({dbStatus,aiStatus})=>{const c={connected:'bg-emerald-500',offline:'bg-red-500',checking:'bg-amber-500 animate-pulse'};return(<div className="flex items-center gap-4 text-xs"><div className="flex items-center gap-1.5"><div className={`w-2 h-2 rounded-full ${c[dbStatus]}`}/><span className="text-slate-400">DB</span></div><div className="flex items-center gap-1.5"><div className={`w-2 h-2 rounded-full ${c[aiStatus]}`}/><span className="text-slate-400">AI</span></div></div>)};

// ============================================================
// MODULE: RFP SHREDDER (Multi-Format Upload)
// ============================================================
function ModuleCompliance({aiStatus,opportunities,setOpportunities,complianceReqs,setComplianceReqs}){
  const[mode,setMode]=useState('list');
  const[files,setFiles]=useState([]);
  const[processedFiles,setProcessedFiles]=useState([]);
  const[processing,setProcessing]=useState(false);
  const[currentFileIndex,setCurrentFileIndex]=useState(0);
  const[allRequirements,setAllRequirements]=useState([]);
  const[projectMeta,setProjectMeta]=useState({name:'',nickname:'',agency:'',solicitationNumber:'',dueDate:'',estimatedValue:'',naics:'',setAside:'',priority:'P-1'});
  const[dragActive,setDragActive]=useState(false);
  const fileInputRef=useRef(null);
  
  const reqs=complianceReqs||[];
  const[filter,setFilter]=useState('all');
  const filtered=filter==='all'?reqs:reqs.filter(r=>r.status===filter);
  const stats={compliant:reqs.filter(r=>r.status==='compliant').length,partial:reqs.filter(r=>r.status==='partial').length,risk:reqs.filter(r=>r.status==='risk').length,draft:reqs.filter(r=>r.status==='draft').length};

  // Check if file is supported
  const isFileSupported=(file)=>{
    const name=file.name.toLowerCase();
    return name.endsWith('.pdf')||name.endsWith('.doc')||name.endsWith('.docx')||name.endsWith('.xls')||name.endsWith('.xlsx');
  };

  const handleFiles=async(fileList)=>{
    const supportedFiles=Array.from(fileList).filter(isFileSupported);
    const unsupportedCount=fileList.length-supportedFiles.length;
    
    if(unsupportedCount>0){
      alert(`${unsupportedCount} file(s) skipped - only PDF, Word, and Excel files are supported.`);
    }
    if(supportedFiles.length===0)return;
    
    setFiles(supportedFiles);
    setMode('upload');
    setProcessing(true);
    setProcessedFiles([]);
    setAllRequirements([]);
    setCurrentFileIndex(0);
    
    const extractedReqs=[];
    const processed=[];
    let firstDocMeta=null;
    
    for(let i=0;i<supportedFiles.length;i++){
      setCurrentFileIndex(i);
      const file=supportedFiles[i];
      const typeInfo=getFileTypeInfo(file.name);
      
      try{
        const result=await extractFileContent(file);
        processed.push({
          name:file.name,
          size:file.size,
          type:result.type,
          typeInfo,
          pages:result.pages,
          sheets:result.sheets,
          rows:result.rows,
          wordCount:result.text.split(/\s+/).length,
          status:'success'
        });
        
        // Analyze with AI
        const analysis=await AIService.chat('rfp_shredder','Analyze RFP',{
          rfpText:result.text,
          fileName:file.name,
          fileType:result.type,
          pageCount:result.pages
        });
        
        let parsed;
        try{parsed=JSON.parse(analysis.response)}catch{parsed={requirements:[],summary:{}}}
        
        // Capture metadata from first document
        if(i===0&&parsed.summary){
          firstDocMeta={
            solicitationNumber:parsed.summary.solicitationNumber||'',
            estimatedValue:parsed.summary.estimatedValue||'',
            naics:parsed.summary.naics||'',
            setAside:parsed.summary.setAside||''
          };
        }
        
        // Add requirements
        if(parsed.requirements){
          parsed.requirements.forEach(r=>{
            r.source=file.name;
            r.sourceType=result.type;
            r.id=`req-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;
            extractedReqs.push(r);
          });
        }
      }catch(e){
        console.error('Error processing',file.name,e);
        processed.push({name:file.name,size:file.size,typeInfo,status:'error',error:e.message});
      }
    }
    
    // Deduplicate requirements by title
    const uniqueReqs=[];
    const seenTitles=new Set();
    extractedReqs.forEach(r=>{
      if(!seenTitles.has(r.title)){
        seenTitles.add(r.title);
        uniqueReqs.push(r);
      }
    });
    
    setProcessedFiles(processed);
    setAllRequirements(uniqueReqs);
    if(firstDocMeta)setProjectMeta(m=>({...m,...firstDocMeta}));
    setProcessing(false);
    setMode('review');
  };

  const handleDrop=(e)=>{e.preventDefault();setDragActive(false);handleFiles(e.dataTransfer.files)};
  const handleDragOver=(e)=>{e.preventDefault();setDragActive(true)};
  const handleDragLeave=()=>setDragActive(false);

  const createProject=async()=>{
    if(!projectMeta.name){alert('Please enter a project name');return}
    
    const newOpp={
      id:`opp-${Date.now()}`,
      name:projectMeta.name,
      nickname:projectMeta.nickname||projectMeta.name.slice(0,20),
      agency:projectMeta.agency||'Other',
      solicitationNumber:projectMeta.solicitationNumber,
      contractValue:parseFloat(projectMeta.estimatedValue?.replace(/[^0-9.]/g,''))||0,
      naics:projectMeta.naics,
      setAside:projectMeta.setAside,
      shipleyPhase:'capture',
      winProbability:50,
      priority:projectMeta.priority,
      days:projectMeta.dueDate?Math.ceil((new Date(projectMeta.dueDate)-new Date())/(1000*60*60*24)):90,
      dueDate:projectMeta.dueDate,
      documents:processedFiles.filter(f=>f.status==='success').map(f=>f.name),
      created:new Date().toISOString()
    };
    
    if(typeof MissionPulse!=='undefined'){try{await MissionPulse.createOpportunity(newOpp)}catch(e){console.error('Error saving',e)}}
    if(setOpportunities)setOpportunities(prev=>[newOpp,...(prev||DEMO_OPPS)]);
    
    const taggedReqs=allRequirements.map(r=>({...r,opportunityId:newOpp.id,opportunityName:newOpp.nickname}));
    if(setComplianceReqs)setComplianceReqs(prev=>[...taggedReqs,...(prev||[])]);
    
    alert(`‚úÖ Project "${newOpp.nickname}" created with ${taggedReqs.length} requirements!`);
    setMode('list');
    setFiles([]);
    setProcessedFiles([]);
    setAllRequirements([]);
    setProjectMeta({name:'',nickname:'',agency:'',solicitationNumber:'',dueDate:'',estimatedValue:'',naics:'',setAside:'',priority:'P-1'});
  };

  // LIST MODE
  if(mode==='list'){
    return(
      <div className="space-y-4 animate-fadeIn">
        <div className="flex justify-between items-center">
          <div><h2 className="text-xl font-bold text-white">üìÑ RFP Shredder</h2><p className="text-slate-400 text-sm">AI-powered compliance extraction</p></div>
          <button onClick={()=>setMode('upload')} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium flex items-center gap-2">
            <Icon name="upload" className="w-4 h-4"/>New RFP Project
          </button>
        </div>
        
        {reqs.length===0?(
          <div className="glass p-12 text-center">
            <div className="w-20 h-20 mx-auto mb-4 bg-slate-800 rounded-full flex items-center justify-center"><Icon name="folder" className="w-10 h-10 text-slate-500"/></div>
            <h3 className="text-lg font-semibold text-white mb-2">No RFP Projects Yet</h3>
            <p className="text-slate-400 mb-4">Upload RFP documents to start extracting requirements</p>
            <div className="flex justify-center gap-4 mb-6">
              <div className="flex items-center gap-2 text-sm"><span className="text-red-400">üìÑ</span><span className="text-slate-300">PDF</span></div>
              <div className="flex items-center gap-2 text-sm"><span className="text-blue-400">üìù</span><span className="text-slate-300">Word</span></div>
              <div className="flex items-center gap-2 text-sm"><span className="text-emerald-400">üìä</span><span className="text-slate-300">Excel</span></div>
            </div>
            <button onClick={()=>setMode('upload')} className="px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg font-medium">
              Upload RFP Documents
            </button>
          </div>
        ):(
          <>
            <div className="grid grid-cols-5 gap-4">
              {[{l:'Compliant',v:stats.compliant,c:'text-emerald-400',bg:'bg-emerald-500/20'},{l:'Partial',v:stats.partial,c:'text-amber-400',bg:'bg-amber-500/20'},{l:'At Risk',v:stats.risk,c:'text-red-400',bg:'bg-red-500/20'},{l:'Draft',v:stats.draft,c:'text-purple-400',bg:'bg-purple-500/20'},{l:'Total',v:reqs.length,c:'text-cyan-400',bg:'bg-cyan-500/20'}].map((s,i)=><div key={i} className={`glass p-4 ${s.bg}`}><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}
            </div>
            <div className="flex gap-2">{['all','compliant','partial','risk','draft'].map(f=><button key={f} onClick={()=>setFilter(f)} className={`px-3 py-1 rounded text-sm ${filter===f?'bg-cyan-500 text-white':'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{f.charAt(0).toUpperCase()+f.slice(1)}</button>)}</div>
            <div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Ref','Requirement','Section','Source','Status','Confidence'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{filtered.map(r=>{const typeInfo=getFileTypeInfo(r.source||'');return(<tr key={r.id} className="hover:bg-slate-800/30"><td className="p-3 font-mono text-sm text-cyan-400">{r.ref}</td><td className="p-3 text-sm text-white">{r.title}</td><td className="p-3 text-sm text-slate-400">{r.section}</td><td className="p-3 text-xs"><span className={typeInfo.color}>{typeInfo.icon}</span><span className="text-slate-500 ml-1">{r.source?.slice(0,15)||'‚Äî'}</span></td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${r.status==='compliant'?'bg-emerald-500/20 text-emerald-400':r.status==='partial'?'bg-amber-500/20 text-amber-400':r.status==='risk'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{r.status}</span></td><td className="p-3"><div className="flex items-center gap-2"><div className="w-16 h-1.5 bg-slate-700 rounded-full"><div className={`h-full rounded-full ${r.confidence>=80?'bg-emerald-500':r.confidence>=60?'bg-amber-500':'bg-red-500'}`} style={{width:`${r.confidence}%`}}/></div><span className="text-xs text-slate-400">{r.confidence}%</span></div></td></tr>)})}</tbody></table></div>
          </>
        )}
      </div>
    );
  }

  // UPLOAD MODE
  if(mode==='upload'){
    return(
      <div className="space-y-4 animate-fadeIn">
        <div className="flex justify-between items-center">
          <div><h2 className="text-xl font-bold text-white">üìÑ New RFP Project</h2><p className="text-slate-400 text-sm">Upload all RFP documents for analysis</p></div>
          <button onClick={()=>{setMode('list');setFiles([]);setProcessing(false)}} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Cancel</button>
        </div>
        
        <div 
          className={`dropzone rounded-xl p-12 text-center cursor-pointer transition ${dragActive?'active':''}`}
          onDrop={handleDrop}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onClick={()=>fileInputRef.current?.click()}
        >
          <input ref={fileInputRef} type="file" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple className="hidden" onChange={e=>handleFiles(e.target.files)}/>
          {processing?(
            <div className="flex flex-col items-center gap-4">
              <div className="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/>
              <div>
                <p className="text-white font-medium">Processing document {currentFileIndex+1} of {files.length}</p>
                <p className="text-slate-400 text-sm mt-1">{files[currentFileIndex]?.name}</p>
              </div>
              <div className="w-64 h-2 bg-slate-700 rounded-full mt-2">
                <div className="h-full bg-cyan-500 rounded-full transition-all" style={{width:`${((currentFileIndex+1)/files.length)*100}%`}}/>
              </div>
            </div>
          ):(
            <div className="flex flex-col items-center gap-4">
              <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center">
                <Icon name="folder" className="w-10 h-10 text-cyan-400"/>
              </div>
              <div>
                <p className="text-white font-medium text-lg">Drop RFP documents here</p>
                <p className="text-slate-400 text-sm mt-1">or click to browse</p>
              </div>
              <div className="flex gap-3 mt-4">
                <div className="flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg">
                  <span className="text-red-400 text-lg">üìÑ</span>
                  <div className="text-left"><div className="text-xs text-white font-medium">PDF</div><div className="text-[10px] text-slate-400">Solicitation, SOW</div></div>
                </div>
                <div className="flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg">
                  <span className="text-blue-400 text-lg">üìù</span>
                  <div className="text-left"><div className="text-xs text-white font-medium">Word</div><div className="text-[10px] text-slate-400">PWS, Attachments</div></div>
                </div>
                <div className="flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg">
                  <span className="text-emerald-400 text-lg">üìä</span>
                  <div className="text-left"><div className="text-xs text-white font-medium">Excel</div><div className="text-[10px] text-slate-400">Pricing, LCATs</div></div>
                </div>
              </div>
            </div>
          )}
        </div>
        
        <div className="glass p-4 bg-cyan-500/5">
          <h4 className="font-medium text-white mb-2">üí° Supported File Types</h4>
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div><span className="text-red-400">PDF</span><span className="text-slate-400 ml-2">- Main solicitation, SOW</span></div>
            <div><span className="text-blue-400">Word</span><span className="text-slate-400 ml-2">- PWS, attachments (.docx)</span></div>
            <div><span className="text-emerald-400">Excel</span><span className="text-slate-400 ml-2">- Pricing, labor matrix</span></div>
          </div>
        </div>
      </div>
    );
  }

  // REVIEW MODE
  if(mode==='review'){
    const successFiles=processedFiles.filter(f=>f.status==='success');
    const errorFiles=processedFiles.filter(f=>f.status==='error');
    
    return(
      <div className="space-y-4 animate-fadeIn">
        <div className="flex justify-between items-center">
          <div><h2 className="text-xl font-bold text-white">üìã Review & Create Project</h2><p className="text-slate-400 text-sm">{allRequirements.length} requirements from {successFiles.length} documents</p></div>
          <div className="flex gap-2">
            <button onClick={()=>setMode('upload')} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Back</button>
            <button onClick={createProject} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium">Create Project</button>
          </div>
        </div>
        
        {/* Project Metadata Form */}
        <div className="glass p-6">
          <h3 className="font-semibold text-white mb-4">Project Details</h3>
          <div className="grid grid-cols-3 gap-4">
            <div><label className="text-xs text-slate-400 block mb-1">Project Name *</label><input value={projectMeta.name} onChange={e=>setProjectMeta(m=>({...m,name:e.target.value}))} placeholder="e.g., DHA MHS GENESIS Modernization" className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">Nickname</label><input value={projectMeta.nickname} onChange={e=>setProjectMeta(m=>({...m,nickname:e.target.value}))} placeholder="e.g., DHA EHR Mod" className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">Agency</label><select value={projectMeta.agency} onChange={e=>setProjectMeta(m=>({...m,agency:e.target.value}))} className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="">Select Agency</option>{AGENCIES.map(a=><option key={a} value={a}>{a}</option>)}</select></div>
            <div><label className="text-xs text-slate-400 block mb-1">Solicitation Number</label><input value={projectMeta.solicitationNumber} onChange={e=>setProjectMeta(m=>({...m,solicitationNumber:e.target.value}))} className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">Due Date</label><input type="date" value={projectMeta.dueDate} onChange={e=>setProjectMeta(m=>({...m,dueDate:e.target.value}))} className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">Priority</label><select value={projectMeta.priority} onChange={e=>setProjectMeta(m=>({...m,priority:e.target.value}))} className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="P-0">P-0 (Critical)</option><option value="P-1">P-1 (High)</option><option value="P-2">P-2 (Normal)</option></select></div>
            <div><label className="text-xs text-slate-400 block mb-1">Estimated Value</label><input value={projectMeta.estimatedValue} onChange={e=>setProjectMeta(m=>({...m,estimatedValue:e.target.value}))} placeholder="e.g., $50M" className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">NAICS</label><input value={projectMeta.naics} onChange={e=>setProjectMeta(m=>({...m,naics:e.target.value}))} placeholder="541512" className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
            <div><label className="text-xs text-slate-400 block mb-1">Set-Aside</label><select value={projectMeta.setAside} onChange={e=>setProjectMeta(m=>({...m,setAside:e.target.value}))} className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="">Full & Open</option><option value="SDVOSB">SDVOSB</option><option value="8(a)">8(a)</option><option value="HUBZone">HUBZone</option><option value="WOSB">WOSB</option><option value="Small Business">Small Business</option></select></div>
          </div>
        </div>
        
        {/* Processed Documents */}
        <div className="glass p-4">
          <h3 className="font-semibold text-white mb-3">üìÅ Processed Documents ({processedFiles.length})</h3>
          <div className="grid grid-cols-2 gap-2">
            {processedFiles.map((f,i)=>(
              <div key={i} className={`flex items-center gap-3 p-3 rounded-lg ${f.status==='success'?'bg-slate-800/50':'bg-red-500/10 border border-red-500/20'}`}>
                <span className={`text-lg ${f.typeInfo?.color||'text-slate-400'}`}>{f.typeInfo?.icon||'üìé'}</span>
                <div className="flex-1 min-w-0">
                  <div className="text-sm text-white truncate">{f.name}</div>
                  <div className="text-xs text-slate-400">
                    {f.status==='success'?(
                      <>{f.type==='excel'?`${f.sheets?.length} sheets, ${f.rows} rows`:`${f.pages} pages, ${f.wordCount?.toLocaleString()} words`}</>
                    ):(
                      <span className="text-red-400">Error: {f.error}</span>
                    )}
                  </div>
                </div>
                <span className={`text-xs px-2 py-1 rounded ${f.status==='success'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}`}>
                  {f.status==='success'?'‚úì':'‚úó'}
                </span>
              </div>
            ))}
          </div>
          {errorFiles.length>0&&<p className="text-xs text-amber-400 mt-2">‚ö†Ô∏è {errorFiles.length} file(s) could not be processed</p>}
        </div>
        
        {/* Extracted Requirements */}
        <div className="glass p-4">
          <h3 className="font-semibold text-white mb-3">üìã Extracted Requirements ({allRequirements.length})</h3>
          <div className="grid grid-cols-3 gap-4 mb-4">
            <div className="bg-slate-800/50 p-3 rounded-lg"><p className="text-xs text-slate-400">Section L</p><p className="text-2xl font-bold text-cyan-400">{allRequirements.filter(r=>r.section==='L').length}</p></div>
            <div className="bg-slate-800/50 p-3 rounded-lg"><p className="text-xs text-slate-400">Section M</p><p className="text-2xl font-bold text-amber-400">{allRequirements.filter(r=>r.section==='M').length}</p></div>
            <div className="bg-slate-800/50 p-3 rounded-lg"><p className="text-xs text-slate-400">Section C</p><p className="text-2xl font-bold text-emerald-400">{allRequirements.filter(r=>r.section==='C').length}</p></div>
          </div>
          <div className="max-h-64 overflow-y-auto">
            <table className="w-full"><thead className="bg-slate-800/50 sticky top-0"><tr>{['Ref','Requirement','Sec','Source','Conf'].map(h=><th key={h} className="text-left p-2 text-xs font-semibold text-slate-400">{h}</th>)}</tr></thead>
              <tbody className="divide-y divide-slate-700/50">{allRequirements.slice(0,25).map((r,i)=>{const typeInfo=getFileTypeInfo(r.source||'');return(<tr key={i} className="hover:bg-slate-800/30"><td className="p-2 font-mono text-xs text-cyan-400">{r.ref}</td><td className="p-2 text-sm text-white">{r.title}</td><td className="p-2 text-sm text-slate-400">{r.section}</td><td className="p-2 text-xs"><span className={typeInfo.color}>{typeInfo.icon}</span></td><td className="p-2 text-xs text-slate-400">{r.confidence}%</td></tr>)})}</tbody>
            </table>
            {allRequirements.length>25&&<p className="text-xs text-slate-500 p-2 text-center">+ {allRequirements.length-25} more requirements</p>}
          </div>
        </div>
        
        <p className="text-xs text-slate-500 text-center">‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW</p>
      </div>
    );
  }
}

// ============================================================
// OTHER MODULES (Compact versions - same structure as before)
// ============================================================
function ModuleDashboard({dbStatus,opportunities}){const opps=opportunities||DEMO_OPPS;const total=opps.reduce((s,o)=>s+(o.contractValue||0),0);const avgPwin=opps.length?Math.round(opps.reduce((s,o)=>s+(o.winProbability||0),0)/opps.length):0;const urgent=opps.filter(o=>(o.days||999)<=7).length;return(<div className="space-y-4 animate-fadeIn"><div className="glass p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10"><div className="flex justify-between items-center"><div><h2 className="text-2xl font-bold text-white">Mission Control</h2><p className="text-slate-400">AI-Powered Proposal Command Center</p></div><div className="flex items-center gap-4"><div className={`px-3 py-1 rounded-full text-xs font-medium ${dbStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>{dbStatus==='connected'?'üü¢ Live':'üü° Demo'}</div><div className="text-5xl">üéØ</div></div></div></div><div className="grid grid-cols-4 gap-4">{[{l:'Pipeline Value',v:fmt(total),c:'text-emerald-400'},{l:'Active Pursuits',v:opps.length,c:'text-cyan-400'},{l:'Avg Win Prob',v:`${avgPwin}%`,c:'text-amber-400'},{l:'Due This Week',v:urgent,c:urgent>0?'text-red-400':'text-slate-400'}].map((s,i)=><div key={i} className="glass p-4 hover-lift"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}</div><div className="glass overflow-hidden"><div className="p-4 border-b border-slate-700/50"><h3 className="font-semibold text-white">Active Pipeline</h3></div><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{opps.slice(0,6).map(o=>(<tr key={o.id} className="hover:bg-slate-800/30"><td className="p-3 font-medium text-white text-sm">{o.nickname||o.name}</td><td className="p-3 text-sm text-slate-300">{o.agency}</td><td className="p-3 text-sm text-emerald-400 font-medium">{fmt(o.contractValue)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:`${phaseColor(o.shipleyPhase)}20`,color:phaseColor(o.shipleyPhase)}}>{phaseName(o.shipleyPhase)}</span></td><td className="p-3"><span className="text-xs text-slate-300">{o.winProbability||50}%</span></td><td className="p-3"><span className={`text-sm ${(o.days||999)<=7?'text-red-400 font-bold':'text-slate-400'}`}>{o.days||'‚Äî'}d</span></td></tr>))}</tbody></table></div></div>)}

function ModulePipeline({opportunities,setOpportunities}){const opps=opportunities||DEMO_OPPS;const[search,setSearch]=useState('');const[phaseFilter,setPhaseFilter]=useState('all');const filtered=opps.filter(o=>{const matchSearch=!search||(o.name||'').toLowerCase().includes(search.toLowerCase())||(o.agency||'').toLowerCase().includes(search.toLowerCase());const matchPhase=phaseFilter==='all'||o.shipleyPhase===phaseFilter;return matchSearch&&matchPhase});return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">Pipeline Intel</h2><p className="text-slate-400 text-sm">Track all opportunities</p></div><div className="flex gap-3"><div className="flex-1 relative"><Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"/><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search..." className="w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div><select value={phaseFilter} onChange={e=>setPhaseFilter(e.target.value)} className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="all">All Phases</option>{SHIPLEY_PHASES.map(p=><option key={p.key} value={p.key}>{p.name}</option>)}</select></div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Days','Priority'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{filtered.map(o=>(<tr key={o.id} className="hover:bg-slate-800/30"><td className="p-3 font-medium text-white text-sm">{o.nickname||o.name?.slice(0,25)}</td><td className="p-3 text-sm text-slate-300">{o.agency}</td><td className="p-3 text-sm text-emerald-400">{fmt(o.contractValue)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:`${phaseColor(o.shipleyPhase)}20`,color:phaseColor(o.shipleyPhase)}}>{phaseName(o.shipleyPhase)}</span></td><td className="p-3 text-sm text-cyan-400">{o.winProbability||50}%</td><td className="p-3"><span className={`text-sm ${(o.days||999)<=7?'text-red-400':'text-slate-400'}`}>{o.days||'‚Äî'}</span></td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${o.priority==='P-0'?'bg-red-500/20 text-red-400':o.priority==='P-1'?'bg-amber-500/20 text-amber-400':'bg-slate-500/20 text-slate-400'}`}>{o.priority||'P-2'}</span></td></tr>))}</tbody></table></div></div>)}

function ModuleWarRoom({opportunities}){const opps=opportunities||DEMO_OPPS;const p0=opps.filter(o=>o.priority==='P-0').sort((a,b)=>(a.days||999)-(b.days||999));const focus=p0[0];return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">‚öîÔ∏è War Room</h2><p className="text-slate-400 text-sm">P-0 Priority Focus</p></div><span className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">{p0.length} CRITICAL</span></div>{focus?(<div className="glass p-6 border-red-500/30 bg-gradient-to-r from-red-500/5 to-transparent"><div className="flex justify-between items-start mb-6"><div><span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold mb-2 inline-block">üî• TOP PRIORITY</span><h3 className="text-2xl font-bold text-white">{focus.nickname||focus.name}</h3><p className="text-slate-400">{focus.agency}</p></div><div className="text-right"><div className="text-4xl font-bold text-red-400">{focus.days||'‚Äî'}</div><div className="text-xs text-slate-400">days left</div></div></div><div className="grid grid-cols-4 gap-4">{[{l:'Value',v:fmt(focus.contractValue),c:'text-emerald-400'},{l:'Win Prob',v:`${focus.winProbability||50}%`,c:'text-cyan-400'},{l:'Phase',v:phaseName(focus.shipleyPhase),c:'text-purple-400'},{l:'Due Date',v:focus.dueDate||'TBD',c:'text-amber-400'}].map((s,i)=><div key={i} className="bg-slate-800/50 p-3 rounded-lg"><p className="text-xs text-slate-400">{s.l}</p><p className={`text-lg font-bold ${s.c}`}>{s.v}</p></div>)}</div></div>):<div className="glass p-8 text-center"><div className="text-4xl mb-2">üéâ</div><p className="text-white">No P-0 priorities!</p></div>}</div>)}

function ModuleSwimlane({opportunities,setOpportunities}){const opps=opportunities||DEMO_OPPS;const[draggedId,setDraggedId]=useState(null);const handleDragStart=(e,id)=>{setDraggedId(id);e.dataTransfer.effectAllowed='move'};const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over')};const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over')};const handleDrop=(e,phaseKey)=>{e.preventDefault();e.currentTarget.classList.remove('drag-over');if(!draggedId||!setOpportunities)return;setOpportunities(opps.map(o=>o.id===draggedId?{...o,shipleyPhase:phaseKey}:o));setDraggedId(null)};return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üìã Swimlane Board</h2></div><div className="flex gap-3 overflow-x-auto pb-4">{SHIPLEY_PHASES.map(phase=>{const phaseOpps=opps.filter(o=>o.shipleyPhase===phase.key);return(<div key={phase.key} className="flex-shrink-0 w-52" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={e=>handleDrop(e,phase.key)}><div className="flex items-center gap-2 mb-2 px-2"><div className="w-3 h-3 rounded-full" style={{background:phase.color}}/><span className="font-medium text-white text-sm">{phase.name}</span><span className="text-xs text-slate-400">({phaseOpps.length})</span></div><div className="glass p-2 min-h-[300px] space-y-2">{phaseOpps.map(o=>(<div key={o.id} draggable onDragStart={e=>handleDragStart(e,o.id)} className="p-3 bg-slate-800 rounded-lg cursor-grab hover:bg-slate-700 transition"><div className="font-medium text-white text-sm mb-1">{o.nickname||o.name?.slice(0,15)}</div><div className="flex justify-between text-xs"><span className="text-slate-400">{o.agency}</span><span className="text-emerald-400">{fmt(o.contractValue)}</span></div></div>))}</div></div>)})}</div></div>)}

function ModuleContracts(){const contracts=DEMO_CONTRACTS;return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">‚öñÔ∏è Contract Scanner</h2></div><div className="grid grid-cols-2 gap-4">{contracts.map(c=>(<div key={c.id} className="glass p-4"><div className="flex justify-between items-start mb-3"><div><h3 className="font-semibold text-white">{c.vehicle}</h3><p className="text-xs text-slate-400">{c.type}</p></div><span className={`px-2 py-1 rounded text-xs font-bold ${c.risk==='low'?'bg-emerald-500/20 text-emerald-400':c.risk==='medium'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400'}`}>{c.risk?.toUpperCase()}</span></div><div className="grid grid-cols-3 gap-2 text-center"><div className="bg-slate-800/50 p-2 rounded"><div className="text-lg font-bold text-white">{c.clauses}</div><div className="text-[10px] text-slate-400">Clauses</div></div><div className="bg-slate-800/50 p-2 rounded"><div className={`text-lg font-bold ${c.findings>0?'text-red-400':'text-emerald-400'}`}>{c.findings}</div><div className="text-[10px] text-slate-400">Findings</div></div><div className="bg-slate-800/50 p-2 rounded"><div className="text-lg font-bold text-cyan-400">{c.expiry?.slice(0,7)}</div><div className="text-[10px] text-slate-400">Expiry</div></div></div></div>))}</div></div>)}

function ModuleWriter({aiStatus}){const[prompt,setPrompt]=useState('');const[output,setOutput]=useState('');const[generating,setGenerating]=useState(false);const[sectionType,setSectionType]=useState('executive');const sections=[{id:'executive',name:'Executive Summary',icon:'üìã'},{id:'technical',name:'Technical',icon:'üíª'},{id:'management',name:'Management',icon:'üë•'},{id:'past_perf',name:'Past Performance',icon:'üìà'}];const generate=async()=>{if(!prompt.trim())return;setGenerating(true);setOutput('');const r=await AIService.chat('writer',prompt,{sectionType});setOutput(r.response);setGenerating(false)};return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">‚úèÔ∏è Iron Dome</h2></div><span className={`px-2 py-1 rounded text-xs ${aiStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>AI: {aiStatus==='connected'?'Live':'Mock'}</span></div><div className="grid grid-cols-4 gap-2">{sections.map(s=><button key={s.id} onClick={()=>setSectionType(s.id)} className={`p-3 rounded-lg text-center transition ${sectionType===s.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="text-xl mb-1">{s.icon}</div><div className="text-xs text-white">{s.name}</div></button>)}</div><div className="glass p-4"><textarea value={prompt} onChange={e=>setPrompt(e.target.value)} rows={3} placeholder="Describe what you need..." className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-cyan-500 resize-none"/><div className="flex justify-end mt-3"><button onClick={generate} disabled={generating||!prompt.trim()} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50">{generating?'Generating...':'‚ú® Generate'}</button></div></div>{output&&<div className="glass p-4"><div className="flex justify-between mb-3"><h4 className="font-semibold text-white">Generated</h4><button onClick={()=>navigator.clipboard.writeText(output)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Copy</button></div><div className="bg-slate-800/50 rounded-lg p-4 text-sm text-slate-300 whitespace-pre-wrap">{output}</div></div>}</div>)}

function ModuleBlackHat({aiStatus}){const competitors=DEMO_COMPETITORS;const[selected,setSelected]=useState(competitors[0]);const[analyzing,setAnalyzing]=useState(false);const[analysis,setAnalysis]=useState('');const runAnalysis=async()=>{if(!selected)return;setAnalyzing(true);setAnalysis('');const r=await AIService.chat('blackhat',`Analyze: ${selected.name}`,{competitor:selected});setAnalysis(r.response);setAnalyzing(false)};return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><h2 className="text-xl font-bold text-white">üé≠ Black Hat</h2><span className="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">üîí PRIVATE</span></div></div><div className="grid grid-cols-3 gap-4"><div className="space-y-2">{competitors.map(c=><button key={c.id} onClick={()=>{setSelected(c);setAnalysis('')}} className={`w-full text-left p-4 rounded-lg transition ${selected?.id===c.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="flex justify-between items-center"><span className="font-medium text-white">{c.name}</span><span className={`px-2 py-0.5 rounded text-xs font-bold ${c.threat==='high'?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}`}>{c.threat?.toUpperCase()}</span></div></button>)}</div><div className="col-span-2 glass p-6">{selected&&(<><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-white">{selected.name}</h3><button onClick={runAnalysis} disabled={analyzing} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50">{analyzing?'Analyzing...':'ü§ñ AI Analysis'}</button></div><div className="grid grid-cols-2 gap-4 mb-4"><div><h4 className="text-sm font-semibold text-emerald-400 mb-2">üí™ Strengths</h4><ul className="space-y-1">{selected.strengths?.map((s,i)=><li key={i} className="text-sm text-slate-300">‚Ä¢ {s}</li>)}</ul></div><div><h4 className="text-sm font-semibold text-red-400 mb-2">‚ö° Weaknesses</h4><ul className="space-y-1">{selected.weaknesses?.map((w,i)=><li key={i} className="text-sm text-slate-300">‚Ä¢ {w}</li>)}</ul></div></div>{analysis&&<div className="p-4 bg-slate-800/50 rounded-lg text-sm text-slate-300 whitespace-pre-wrap">{analysis}</div>}</>)}</div></div></div>)}

function ModulePricing(){const lcats=DEMO_LCATS;const totalCost=lcats.reduce((s,l)=>(l.rate||0)*(l.hours||0)*(l.wrap||1.85)+s,0);return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">üíµ Pricing Engine</h2></div><span className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">CUI</span></div><div className="grid grid-cols-3 gap-4"><div className="glass p-4"><p className="text-slate-400 text-xs">LCATs</p><p className="text-2xl font-bold text-cyan-400">{lcats.length}</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Hours</p><p className="text-2xl font-bold text-amber-400">{lcats.reduce((s,l)=>s+(l.hours||0),0).toLocaleString()}</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Loaded Cost</p><p className="text-2xl font-bold text-emerald-400">{fmt(totalCost)}</p></div></div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['LCAT','Rate','Hours','Wrap','Loaded'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{lcats.map(l=>(<tr key={l.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm font-medium text-white">{l.title}</td><td className="p-3 text-sm text-emerald-400">${l.rate}</td><td className="p-3 text-sm text-slate-300">{l.hours?.toLocaleString()}</td><td className="p-3 text-sm text-cyan-400">{l.wrap}x</td><td className="p-3 text-sm font-medium text-amber-400">{fmt((l.rate||0)*(l.hours||0)*(l.wrap||1.85))}</td></tr>))}</tbody></table></div></div>)}

function ModuleHITL(){const[items,setItems]=useState(DEMO_HITL);const pending=items.filter(i=>i.status==='pending');const handleApprove=(id)=>setItems(items.map(i=>i.id===id?{...i,status:'approved'}:i));const handleReject=(id)=>setItems(items.map(i=>i.id===id?{...i,status:'rejected'}:i));return(<div className="space-y-4 animate-fadeIn"><div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">üëÅÔ∏è HITL Queue</h2></div><span className="px-3 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">{pending.length} PENDING</span></div><div className="space-y-3">{items.map(item=>(<div key={item.id} className="glass p-4"><div className="flex justify-between items-center"><div className="flex items-center gap-4"><span className={`px-2 py-1 rounded text-xs ${item.status==='pending'?'bg-amber-500/20 text-amber-400':item.status==='approved'?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}`}>{item.status.toUpperCase()}</span><div><h4 className="font-medium text-white">{item.title}</h4><p className="text-xs text-slate-400">{item.type} ‚Ä¢ {item.author}</p></div></div>{item.status==='pending'&&<div className="flex gap-2"><button onClick={()=>handleApprove(item.id)} className="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded text-sm">‚úì</button><button onClick={()=>handleReject(item.id)} className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-sm">‚úó</button></div>}</div></div>))}</div></div>)}

function ModuleOrals({aiStatus}){const[slides]=useState(['Opening','Technical','Past Performance','Key Personnel','Q&A']);const[selected,setSelected]=useState(0);const[generating,setGenerating]=useState(false);const[content,setContent]=useState('');const generateSlide=async()=>{setGenerating(true);const r=await AIService.chat('orals','Generate slide',{slideTitle:slides[selected]});setContent(r.response);setGenerating(false)};return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üé§ Orals Studio</h2></div><div className="grid grid-cols-4 gap-4"><div className="space-y-2">{slides.map((s,i)=><button key={i} onClick={()=>{setSelected(i);setContent('')}} className={`w-full text-left p-3 rounded-lg transition ${selected===i?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><span className="text-slate-400 text-xs">Slide {i+1}</span><div className="font-medium text-white text-sm">{s}</div></button>)}</div><div className="col-span-3 glass p-6"><div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-white">{slides[selected]}</h3><button onClick={generateSlide} disabled={generating} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50">{generating?'...':'‚ú® Generate'}</button></div><div className="aspect-video bg-slate-800 rounded-lg flex items-center justify-center">{content?<div className="p-6 text-sm text-slate-300 whitespace-pre-wrap overflow-auto max-h-full">{content}</div>:<div className="text-slate-500">Click generate</div>}</div></div></div></div>)}

function ModuleFrenemy(){const partners=DEMO_PARTNERS;const[selected,setSelected]=useState(partners[0]);return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üõ°Ô∏è Frenemy Protocol</h2></div><div className="grid grid-cols-3 gap-4"><div className="space-y-2">{partners.map(p=><button key={p.id} onClick={()=>setSelected(p)} className={`w-full text-left p-4 rounded-lg transition ${selected?.id===p.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="flex justify-between items-center"><span className="font-medium text-white">{p.name}</span><span className={`px-2 py-0.5 rounded text-xs font-bold ${p.status==='Active'?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>{p.status}</span></div><div className="text-xs text-slate-400 mt-1">{p.socio} ‚Ä¢ {p.trustScore}%</div></button>)}</div><div className="col-span-2 glass p-6">{selected&&(<><h3 className="text-xl font-bold text-white mb-4">{selected.name}</h3><div className="mb-4"><h4 className="text-sm font-semibold text-white mb-2">Capabilities</h4><div className="flex flex-wrap gap-2">{selected.capabilities?.map((c,i)=><span key={i} className="px-2 py-1 bg-slate-700 rounded text-xs text-white">{c}</span>)}</div></div></>)}</div></div></div>)}

function ModuleLaunch(){const subs=DEMO_SUBMISSIONS;const wins=subs.filter(s=>s.status==='Won');const winRate=subs.filter(s=>s.status!=='Pending').length?Math.round(wins.length/subs.filter(s=>s.status!=='Pending').length*100):0;return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üöÄ Launch & ROI</h2></div><div className="grid grid-cols-3 gap-4"><div className="glass p-4"><p className="text-slate-400 text-xs">Win Rate</p><p className="text-2xl font-bold text-emerald-400">{winRate}%</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Total Won</p><p className="text-2xl font-bold text-cyan-400">{fmt(wins.reduce((s,w)=>s+(w.value||0),0))}</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Pending</p><p className="text-2xl font-bold text-amber-400">{subs.filter(s=>s.status==='Pending').length}</p></div></div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Submission','Value','Status','ROI'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{subs.map(s=>(<tr key={s.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm font-medium text-white">{s.name}</td><td className="p-3 text-sm text-emerald-400">{fmt(s.value)}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${s.status==='Won'?'bg-emerald-500/20 text-emerald-400':s.status==='Lost'?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}`}>{s.status}</span></td><td className="p-3 text-sm"><span className={s.roi>0?'text-emerald-400':s.roi<0?'text-red-400':'text-slate-400'}>{s.roi!=null?`${s.roi}%`:'‚Äî'}</span></td></tr>))}</tbody></table></div></div>)}

function ModulePostAward(){const[checklist]=useState([{id:'1',task:'Contract signed',done:true},{id:'2',task:'Kickoff scheduled',done:true},{id:'3',task:'Key personnel onboarded',done:false},{id:'4',task:'Systems access',done:false}]);const progress=Math.round(checklist.filter(c=>c.done).length/checklist.length*100);return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üì¶ Post-Award</h2></div><div className="glass p-4"><div className="flex justify-between mb-2"><span className="text-sm text-white">Progress</span><span className="text-sm text-cyan-400">{progress}%</span></div><div className="h-3 bg-slate-700 rounded-full"><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full" style={{width:`${progress}%`}}/></div></div><div className="glass p-4"><h3 className="font-semibold text-white mb-3">Checklist</h3><div className="space-y-2">{checklist.map(c=><div key={c.id} className="flex items-center gap-3 p-2 bg-slate-800/50 rounded"><div className={`w-5 h-5 rounded flex items-center justify-center ${c.done?'bg-emerald-500':'bg-slate-700'}`}>{c.done&&<Icon name="check" className="w-3 h-3 text-white"/>}</div><span className={`text-sm ${c.done?'text-slate-400 line-through':'text-white'}`}>{c.task}</span></div>)}</div></div></div>)}

function ModulePlaybook(){const lessons=DEMO_PLAYBOOK;const[selected,setSelected]=useState(null);return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">‚≠ê Playbook</h2></div><div className="grid grid-cols-3 gap-4"><div className="space-y-2">{lessons.map(l=><button key={l.id} onClick={()=>setSelected(l)} className={`w-full text-left p-3 rounded-lg transition ${selected?.id===l.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="font-medium text-white text-sm">{l.title}</div><div className="flex justify-between text-xs mt-1"><span className="text-slate-400">{l.category}</span><span className="text-cyan-400">‚≠ê {l.score}</span></div></button>)}</div><div className="col-span-2 glass p-6">{selected?(<><h3 className="text-xl font-bold text-white mb-4">{selected.title}</h3><div className="p-4 bg-slate-800/50 rounded-lg text-sm text-slate-300">{selected.content}</div></>):<div className="text-center text-slate-500">Select a lesson</div>}</div></div></div>)}

function ModuleAdmin(){const[tokenUsage]=useState({used:45230,limit:100000,cost:2.26});return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">‚öôÔ∏è Admin</h2></div><div className="grid grid-cols-3 gap-4"><div className="glass p-4"><p className="text-slate-400 text-xs">Tokens Used</p><p className="text-2xl font-bold text-cyan-400">{tokenUsage.used.toLocaleString()}</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Limit</p><p className="text-2xl font-bold text-slate-300">{tokenUsage.limit.toLocaleString()}</p></div><div className="glass p-4"><p className="text-slate-400 text-xs">Cost</p><p className="text-2xl font-bold text-emerald-400">${tokenUsage.cost.toFixed(2)}</p></div></div></div>)}

function ModuleTraining(){const courses=[{id:'1',title:'Shipley Fundamentals',progress:100},{id:'2',title:'Win Themes',progress:75},{id:'3',title:'Pricing',progress:30}];return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üéì Training</h2></div><div className="grid grid-cols-2 gap-4">{courses.map(c=><div key={c.id} className="glass p-4"><h3 className="font-medium text-white mb-3">{c.title}</h3><div className="h-2 bg-slate-700 rounded-full"><div className={`h-full rounded-full ${c.progress===100?'bg-emerald-500':'bg-cyan-500'}`} style={{width:`${c.progress}%`}}/></div><p className="text-xs text-slate-400 mt-2">{c.progress}%</p></div>)}</div></div>)}

function ModuleAudit(){const logs=DEMO_AUDIT;return(<div className="space-y-4 animate-fadeIn"><div><h2 className="text-xl font-bold text-white">üìú Audit Log</h2></div><div className="glass overflow-hidden"><table className="w-full"><thead className="bg-slate-800/50"><tr>{['Time','Action','User','Role'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-700/50">{logs.map(l=>(<tr key={l.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm text-slate-400 font-mono">{new Date(l.ts).toLocaleString()}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs font-bold bg-cyan-500/20 text-cyan-400">{l.action}</span></td><td className="p-3 text-sm text-white">{l.user}</td><td className="p-3 text-sm text-slate-400">{l.role}</td></tr>))}</tbody></table></div></div>)}

// AI Chat Widget
function AIChatWidget({aiStatus}){const[open,setOpen]=useState(false);const[messages,setMessages]=useState([{role:'assistant',content:'Hello! How can I help?'}]);const[input,setInput]=useState('');const[loading,setLoading]=useState(false);const send=async()=>{if(!input.trim()||loading)return;setMessages(m=>[...m,{role:'user',content:input}]);const msg=input;setInput('');setLoading(true);const r=await AIService.chat('assistant',msg,{});setMessages(m=>[...m,{role:'assistant',content:r.response}]);setLoading(false)};if(!open)return<button onClick={()=>setOpen(true)} className="fixed bottom-10 right-4 w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition z-50">ü§ñ</button>;return(<div className="fixed bottom-10 right-4 w-96 h-[500px] glass shadow-2xl flex flex-col z-50 animate-fadeIn"><div className="p-3 border-b border-slate-700/50 flex justify-between items-center"><span className="font-semibold text-white">ü§ñ AI</span><button onClick={()=>setOpen(false)} className="p-1 text-slate-400 hover:text-white"><Icon name="x"/></button></div><div className="flex-1 overflow-y-auto p-3 space-y-3">{messages.map((m,i)=><div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.role==='user'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-200'}`}>{m.content}</div></div>)}{loading&&<div className="flex justify-start"><div className="bg-slate-700 p-3 rounded-xl"><div className="flex gap-1">{[0,1,2].map(i=><div key={i} className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{animationDelay:`${i*0.2}s`}}/>)}</div></div></div>}</div><div className="p-3 border-t border-slate-700/50 flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder="Ask..." className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-cyan-500"/><button onClick={send} disabled={!input.trim()||loading} className="p-2 bg-cyan-500 rounded-lg text-white disabled:opacity-50"><Icon name="send"/></button></div></div>)}

// Sidebar
function Sidebar({role,setRole,active,setActive,user,dbStatus,aiStatus}){const[collapsed,setCollapsed]=useState(false);const[showRoles,setShowRoles]=useState(false);const currentRole=ROLES.find(r=>r.id===role)||ROLES[0];const accessible=MODULES.filter(m=>currentRole.access.includes(m.id));return(<aside className={`h-screen bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all ${collapsed?'w-16':'w-64'}`}><div className="p-4 border-b border-slate-800 flex items-center justify-between">{!collapsed&&<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div><div className="text-sm font-bold text-white">MissionPulse</div><div className="text-[10px] text-slate-500">v12</div></div></div>}<button onClick={()=>setCollapsed(!collapsed)} className="p-1 text-slate-400 hover:text-white"><Icon name={collapsed?'chevronRight':'chevronLeft'} className="w-4 h-4"/></button></div>{!collapsed&&<div className="p-3 border-b border-slate-800"><button onClick={()=>setShowRoles(!showRoles)} className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800"><span className="text-xl">{currentRole.icon}</span><div className="flex-1 text-left"><div className="text-sm font-medium text-white">{currentRole.fullName}</div><div className="text-xs text-slate-400">{currentRole.name}</div></div><Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition ${showRoles?'rotate-180':''}`}/></button>{showRoles&&<div className="mt-2 p-2 bg-slate-800/50 rounded-lg max-h-48 overflow-y-auto">{ROLES.map(r=><button key={r.id} onClick={()=>{setRole(r.id);setShowRoles(false)}} className={`w-full flex items-center gap-2 p-2 rounded hover:bg-slate-700 ${role===r.id?'bg-cyan-500/20':''}`}><span>{r.icon}</span><span className="text-sm text-white">{r.name}</span></button>)}</div>}</div>}<nav className="flex-1 overflow-y-auto p-2">{['Command','Strategy','Intel','Delivery','Admin'].map(cat=>{const mods=accessible.filter(m=>m.cat===cat);if(!mods.length)return null;return(<div key={cat} className="mb-3">{!collapsed&&<div className="text-[10px] uppercase text-slate-500 font-semibold px-2 mb-1">{cat}</div>}{mods.map(m=><button key={m.id} onClick={()=>setActive(m)} className={`w-full flex items-center gap-2 p-2 rounded-lg mb-0.5 transition ${active?.id===m.id?'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30':'text-slate-400 hover:bg-slate-800 hover:text-white'}`} title={collapsed?m.name:''}><span>{m.icon}</span>{!collapsed&&<><span className="flex-1 text-left text-sm">{m.name}</span>{m.badge&&<span className={`px-1 py-0.5 text-[9px] font-bold rounded ${m.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</>}</button>)}</div>)})}</nav>{!collapsed&&<div className="p-3 border-t border-slate-800"><StatusBar dbStatus={dbStatus} aiStatus={aiStatus}/>{user&&<div className="flex items-center justify-between mt-3"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white text-xs font-bold">{user.name?.[0]||'U'}</div><div className="text-xs text-white truncate max-w-[100px]">{user.name||user.email}</div></div><button onClick={handleLogout} className="p-1.5 rounded hover:bg-red-500/20 text-slate-400 hover:text-red-400" title="Logout"><Icon name="logout" className="w-4 h-4"/></button></div>}</div>}</aside>)}

// Main App
function App(){const[user,setUser]=useState(null);const[role,setRole]=useState('CEO');const[active,setActive]=useState(null);const[dbStatus,setDbStatus]=useState('checking');const[aiStatus,setAiStatus]=useState('checking');const[opportunities,setOpportunities]=useState(DEMO_OPPS);const[complianceReqs,setComplianceReqs]=useState([]);useEffect(()=>{const u=checkAuth();if(u){setUser(u);if(u.role)setRole(u.role)}if(typeof MissionPulse!=='undefined'){MissionPulse.getOpportunities().then(r=>{setDbStatus(r.error?'offline':'connected');if(r.data?.length>0)setOpportunities(r.data)}).catch(()=>setDbStatus('offline'))}else{setDbStatus('offline')}AIService.checkConnection().then(s=>setAiStatus(s))},[]);const renderModule=()=>{if(!active)return<div className="flex-1 flex items-center justify-center"><div className="text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><h2 className="text-xl font-bold text-white mb-2">Welcome to MissionPulse</h2><p className="text-slate-400">Select a module</p></div></div>;switch(active.id){case 'dashboard':return<ModuleDashboard dbStatus={dbStatus} opportunities={opportunities}/>;case 'pipeline':return<ModulePipeline opportunities={opportunities} setOpportunities={setOpportunities}/>;case 'warroom':return<ModuleWarRoom opportunities={opportunities}/>;case 'swimlane':return<ModuleSwimlane opportunities={opportunities} setOpportunities={setOpportunities}/>;case 'compliance':return<ModuleCompliance aiStatus={aiStatus} opportunities={opportunities} setOpportunities={setOpportunities} complianceReqs={complianceReqs} setComplianceReqs={setComplianceReqs}/>;case 'contracts':return<ModuleContracts/>;case 'writer':return<ModuleWriter aiStatus={aiStatus}/>;case 'blackhat':return<ModuleBlackHat aiStatus={aiStatus}/>;case 'pricing':return<ModulePricing/>;case 'hitl':return<ModuleHITL/>;case 'orals':return<ModuleOrals aiStatus={aiStatus}/>;case 'frenemy':return<ModuleFrenemy/>;case 'launch':return<ModuleLaunch/>;case 'post_award':return<ModulePostAward/>;case 'playbook':return<ModulePlaybook/>;case 'admin':return<ModuleAdmin/>;case 'training':return<ModuleTraining/>;case 'audit':return<ModuleAudit/>;default:return<div className="glass p-12 text-center"><div className="text-6xl mb-4">{active.icon}</div><h2 className="text-xl font-bold text-white">{active.name}</h2></div>}};if(!user)return<div className="h-screen flex items-center justify-center bg-[#00050F]"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;return(<div className="h-screen flex bg-[#00050F] overflow-hidden"><Sidebar role={role} setRole={setRole} active={active} setActive={setActive} user={user} dbStatus={dbStatus} aiStatus={aiStatus}/><div className="flex-1 flex flex-col overflow-hidden">{active&&<header className="bg-slate-900/90 border-b border-slate-800 px-6 py-3"><div className="flex items-center gap-3"><span className="text-xl">{active.icon}</span><h1 className="font-semibold text-white">{active.name}</h1>{active.badge&&<span className={`px-2 py-0.5 rounded text-xs font-bold ${active.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':active.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{active.badge}</span>}</div></header>}<main className="flex-1 overflow-y-auto p-6">{renderModule()}</main></div><div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-40"><span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW ‚Ä¢ MissionPulse v12 ‚Ä¢ ¬© 2026 Mission Meets Tech</span></div><AIChatWidget aiStatus={aiStatus}/></div>)}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
