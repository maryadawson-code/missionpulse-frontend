<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse - Post-Award</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; color: #F8FAFC; }
    .card { background: #0d1f3c; border: 1px solid rgba(0, 229, 250, 0.3); border-radius: 12px; }
    .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #0891B2 100%); color: #00050F; font-weight: 600; }
    .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
    .glow-text { text-shadow: 0 0 10px rgba(0, 229, 250, 0.5); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .phase-pending { border-left: 4px solid #6B7280; }
    .phase-active { border-left: 4px solid #00E5FA; }
    .phase-complete { border-left: 4px solid #10B981; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <a href="index.html" class="text-gray-400 hover:text-cyan-400">‚Üê Dashboard</a>
      <h1 class="text-2xl font-bold">
        <span class="text-cyan-400 glow-text">Post-Award</span> Transition
      </h1>
    </div>
    <div class="flex items-center gap-4">
      <div id="connectionStatus" class="flex items-center gap-2 text-sm">
        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
        <span class="text-gray-400">Connecting...</span>
      </div>
      <select id="opportunityFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm">
        <option value="">Select Won Opportunity</option>
      </select>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-5 gap-4 mb-6">
    <div class="card p-4 text-center">
      <div id="statContract" class="text-xl font-bold text-cyan-400 truncate">-</div>
      <div class="text-gray-400 text-sm">Contract #</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statValue" class="text-2xl font-bold text-green-400">$0</div>
      <div class="text-gray-400 text-sm">Contract Value</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statPhase" class="text-2xl font-bold text-purple-400">-</div>
      <div class="text-gray-400 text-sm">Current Phase</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statTasks" class="text-2xl font-bold text-amber-400">0/0</div>
      <div class="text-gray-400 text-sm">Tasks Complete</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statDaysToStart" class="text-2xl font-bold text-cyan-400">-</div>
      <div class="text-gray-400 text-sm">Days to Start</div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="grid grid-cols-3 gap-6">
    <!-- Transition Phases -->
    <div class="col-span-2">
      <div class="card p-4 mb-4">
        <h3 class="font-semibold mb-4">Transition Phases</h3>
        
        <!-- Phase Timeline -->
        <div class="flex items-center justify-between mb-6">
          <div id="phase1" class="flex-1 text-center cursor-pointer" onclick="setPhase('award')">
            <div class="w-10 h-10 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-2 transition-all">1</div>
            <div class="text-xs text-gray-400">Award</div>
          </div>
          <div class="flex-1 h-1 bg-gray-700"></div>
          <div id="phase2" class="flex-1 text-center cursor-pointer" onclick="setPhase('kickoff')">
            <div class="w-10 h-10 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-2 transition-all">2</div>
            <div class="text-xs text-gray-400">Kickoff</div>
          </div>
          <div class="flex-1 h-1 bg-gray-700"></div>
          <div id="phase3" class="flex-1 text-center cursor-pointer" onclick="setPhase('mobilization')">
            <div class="w-10 h-10 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-2 transition-all">3</div>
            <div class="text-xs text-gray-400">Mobilization</div>
          </div>
          <div class="flex-1 h-1 bg-gray-700"></div>
          <div id="phase4" class="flex-1 text-center cursor-pointer" onclick="setPhase('operations')">
            <div class="w-10 h-10 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-2 transition-all">4</div>
            <div class="text-xs text-gray-400">Operations</div>
          </div>
        </div>
      </div>

      <!-- Tasks List -->
      <div class="card p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold">Transition Tasks</h3>
          <button onclick="openAddModal()" class="text-cyan-400 hover:text-cyan-300 text-sm">+ Add Task</button>
        </div>
        
        <div id="tasksContainer" class="space-y-3 max-h-[400px] overflow-y-auto">
          <div class="text-gray-500 text-center py-4 animate-pulse">Loading tasks...</div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-span-1 space-y-4">
      <!-- Contract Details -->
      <div class="card p-4">
        <h3 class="font-semibold mb-4">Contract Details</h3>
        <div class="space-y-3 text-sm">
          <div>
            <label class="block text-gray-400 mb-1">Contract Number</label>
            <input type="text" id="contractNumber" placeholder="Enter contract #"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
          <div>
            <label class="block text-gray-400 mb-1">Award Date</label>
            <input type="date" id="awardDate"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
          <div>
            <label class="block text-gray-400 mb-1">Period of Performance Start</label>
            <input type="date" id="popStart"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
          <div>
            <label class="block text-gray-400 mb-1">Period of Performance End</label>
            <input type="date" id="popEnd"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
          <div>
            <label class="block text-gray-400 mb-1">Contracting Officer</label>
            <input type="text" id="contractingOfficer" placeholder="Name"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
          <div>
            <label class="block text-gray-400 mb-1">COR Name</label>
            <input type="text" id="corName" placeholder="COR Name"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"
                   onchange="saveContractDetails()">
          </div>
        </div>
      </div>

      <!-- Key Personnel -->
      <div class="card p-4">
        <h3 class="font-semibold mb-4">Key Personnel Status</h3>
        <div id="keyPersonnel" class="space-y-2 text-sm">
          <p class="text-gray-500">Loading...</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card p-4">
        <h3 class="font-semibold mb-4">Quick Actions</h3>
        <div class="space-y-2">
          <button onclick="generateKickoffAgenda()" class="w-full text-left px-3 py-2 bg-slate-800 rounded hover:bg-slate-700 text-sm">
            üìã Generate Kickoff Agenda
          </button>
          <button onclick="generateStaffingPlan()" class="w-full text-left px-3 py-2 bg-slate-800 rounded hover:bg-slate-700 text-sm">
            üë• Export Staffing Plan
          </button>
          <button onclick="generateTransitionPlan()" class="w-full text-left px-3 py-2 bg-slate-800 rounded hover:bg-slate-700 text-sm">
            üìÑ Generate Transition Plan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="taskModal" class="modal hidden">
    <div class="card p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-cyan-400">Add Transition Task</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <form id="taskForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="taskId">
        
        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Task Description *</label>
          <input type="text" id="taskDescription" required placeholder="Schedule kickoff meeting"
                 class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Phase</label>
            <select id="taskPhase" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="award">Award</option>
              <option value="kickoff">Kickoff</option>
              <option value="mobilization">Mobilization</option>
              <option value="operations">Operations</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Priority</label>
            <select id="taskPriority" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Assigned To</label>
            <input type="text" id="taskAssignee" placeholder="Name"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Due Date</label>
            <input type="date" id="taskDueDate"
                   class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Notes</label>
          <textarea id="taskNotes" rows="2" placeholder="Additional details..."
                    class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-700 rounded-lg hover:bg-slate-600">Cancel</button>
          <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-8 text-center text-xs text-gray-500">
    AI GENERATED - REQUIRES HUMAN REVIEW | Shield & Pulse UX v8.0 | MissionPulse ¬© 2026
  </div>

  <script src="supabase-client-v2.1.js"></script>
  <script>
    // ========== STATE ==========
    let allTasks = [];
    let opportunities = [];
    let currentOpportunity = null;
    let currentPhase = 'award';
    let editingId = null;

    // ========== SUPABASE CONFIG ==========
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MjI4NzQsImV4cCI6MjA1MzQ5ODg3NH0.xV3_Dlcj1PZUkEa4cJzJqv0PdCbHfwVoVEpmr1tRvo0';
    
    let supabase;
    
    function initSupabase() {
      if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        updateConnectionStatus(true);
        return true;
      }
      return false;
    }

    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      status.innerHTML = connected 
        ? `<span class="w-2 h-2 rounded-full bg-green-400"></span><span class="text-green-400">Connected</span>`
        : `<span class="w-2 h-2 rounded-full bg-red-400"></span><span class="text-red-400">Disconnected</span>`;
    }

    // ========== DATA LOADING ==========
    async function loadOpportunities() {
      try {
        // Load only won/awarded opportunities
        const { data, error } = await supabase.from('opportunities')
          .select('*')
          .in('status', ['Won', 'Awarded', 'Submitted'])
          .order('title');
        
        if (error) throw error;
        opportunities = data || [];
        
        const select = document.getElementById('opportunityFilter');
        select.innerHTML = `<option value="">Select Won Opportunity</option>` + 
          opportunities.map(o => `<option value="${o.id}">${o.title} (${o.status})</option>`).join('');
      } catch (err) {
        console.error('Failed to load opportunities:', err);
      }
    }

    async function loadTasks() {
      const oppId = document.getElementById('opportunityFilter').value;
      if (!oppId) {
        showEmptyState('Select an opportunity to view transition tasks');
        return;
      }
      
      currentOpportunity = opportunities.find(o => o.id === oppId);
      
      try {
        const { data, error } = await supabase.from('post_award_tasks')
          .select('*')
          .eq('opportunity_id', oppId)
          .order('due_date');
        
        if (error) throw error;
        
        allTasks = data || [];
        
        if (allTasks.length === 0) {
          await addDefaultTasks(oppId);
          return;
        }
        
        renderTasks();
        updateStats();
        loadContractDetails();
        updatePhaseTimeline();
      } catch (err) {
        console.error('Failed to load tasks:', err);
        showEmptyState('Failed to load tasks');
      }
    }

    async function addDefaultTasks(oppId) {
      const defaults = [
        { phase: 'award', description: 'Receive official award notification', priority: 'high' },
        { phase: 'award', description: 'Review contract terms and conditions', priority: 'high' },
        { phase: 'award', description: 'Notify key personnel of award', priority: 'medium' },
        { phase: 'kickoff', description: 'Schedule kickoff meeting with COR', priority: 'high' },
        { phase: 'kickoff', description: 'Prepare kickoff presentation', priority: 'medium' },
        { phase: 'kickoff', description: 'Submit initial staffing plan', priority: 'high' },
        { phase: 'mobilization', description: 'Onboard key personnel', priority: 'high' },
        { phase: 'mobilization', description: 'Set up project infrastructure', priority: 'medium' },
        { phase: 'mobilization', description: 'Obtain facility access/badges', priority: 'medium' },
        { phase: 'operations', description: 'Begin contract performance', priority: 'high' },
        { phase: 'operations', description: 'Submit first status report', priority: 'medium' }
      ];
      
      try {
        for (const task of defaults) {
          await supabase.from('post_award_tasks').insert([{
            opportunity_id: oppId,
            description: task.description,
            phase: task.phase,
            priority: task.priority,
            is_complete: false,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }]);
        }
        await loadTasks();
      } catch (err) {
        console.error('Failed to add default tasks:', err);
      }
    }

    async function loadContractDetails() {
      const oppId = document.getElementById('opportunityFilter').value;
      if (!oppId) return;
      
      try {
        const { data, error } = await supabase.from('contract_details')
          .select('*')
          .eq('opportunity_id', oppId)
          .single();
        
        if (data) {
          document.getElementById('contractNumber').value = data.contract_number || '';
          document.getElementById('awardDate').value = data.award_date || '';
          document.getElementById('popStart').value = data.pop_start || '';
          document.getElementById('popEnd').value = data.pop_end || '';
          document.getElementById('contractingOfficer').value = data.contracting_officer || '';
          document.getElementById('corName').value = data.cor_name || '';
          
          document.getElementById('statContract').textContent = data.contract_number || '-';
          
          if (data.pop_start) {
            const start = new Date(data.pop_start);
            const today = new Date();
            const days = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
            document.getElementById('statDaysToStart').textContent = days > 0 ? days : 'Started';
          }
        }
      } catch (err) {
        // No details yet, that's ok
      }
      
      // Update value from opportunity
      if (currentOpportunity) {
        document.getElementById('statValue').textContent = '$' + (currentOpportunity.value || 0).toLocaleString();
      }
    }

    async function saveContractDetails() {
      const oppId = document.getElementById('opportunityFilter').value;
      if (!oppId) return;
      
      try {
        await supabase.from('contract_details').upsert([{
          opportunity_id: oppId,
          contract_number: document.getElementById('contractNumber').value || null,
          award_date: document.getElementById('awardDate').value || null,
          pop_start: document.getElementById('popStart').value || null,
          pop_end: document.getElementById('popEnd').value || null,
          contracting_officer: document.getElementById('contractingOfficer').value || null,
          cor_name: document.getElementById('corName').value || null,
          updated_at: new Date().toISOString()
        }], { onConflict: 'opportunity_id' });
        
        loadContractDetails();
      } catch (err) {
        console.error('Failed to save contract details:', err);
      }
    }

    // ========== RENDERING ==========
    function renderTasks() {
      const container = document.getElementById('tasksContainer');
      const phaseTasks = allTasks.filter(t => t.phase === currentPhase);
      
      if (phaseTasks.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            <p>No tasks in this phase</p>
            <button onclick="openAddModal()" class="text-cyan-400 hover:text-cyan-300 text-sm mt-2">+ Add Task</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = phaseTasks.map(task => `
        <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-lg phase-${task.is_complete ? 'complete' : 'active'}">
          <input type="checkbox" ${task.is_complete ? 'checked' : ''} 
                 onchange="toggleTask('${task.id}')"
                 class="w-5 h-5 rounded border-slate-600 text-cyan-400 focus:ring-cyan-400">
          <div class="flex-1">
            <span class="${task.is_complete ? 'line-through text-gray-500' : ''}">${task.description}</span>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-xs px-2 py-0.5 rounded ${getPriorityClass(task.priority)}">${task.priority}</span>
              ${task.assigned_to ? `<span class="text-xs text-gray-500">‚Üí ${task.assigned_to}</span>` : ''}
            </div>
          </div>
          ${task.due_date ? `<span class="text-xs text-gray-500">${formatDate(task.due_date)}</span>` : ''}
          <button onclick="deleteTask('${task.id}')" class="text-red-400 hover:text-red-300 text-xs">‚úï</button>
        </div>
      `).join('');
    }

    function showEmptyState(message) {
      document.getElementById('tasksContainer').innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <p>${message}</p>
        </div>
      `;
    }

    function getPriorityClass(priority) {
      const classes = {
        high: 'bg-red-500/20 text-red-400',
        medium: 'bg-amber-500/20 text-amber-400',
        low: 'bg-green-500/20 text-green-400'
      };
      return classes[priority] || classes.medium;
    }

    function formatDate(date) {
      if (!date) return null;
      return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function updateStats() {
      const complete = allTasks.filter(t => t.is_complete).length;
      const total = allTasks.length;
      
      document.getElementById('statTasks').textContent = `${complete}/${total}`;
      document.getElementById('statPhase').textContent = currentPhase.charAt(0).toUpperCase() + currentPhase.slice(1);
    }

    function updatePhaseTimeline() {
      const phases = ['award', 'kickoff', 'mobilization', 'operations'];
      const phaseElements = ['phase1', 'phase2', 'phase3', 'phase4'];
      
      phases.forEach((phase, index) => {
        const el = document.getElementById(phaseElements[index]);
        const circle = el.querySelector('div');
        const phaseTasks = allTasks.filter(t => t.phase === phase);
        const complete = phaseTasks.filter(t => t.is_complete).length;
        const total = phaseTasks.length;
        
        circle.classList.remove('bg-gray-700', 'bg-cyan-500', 'bg-green-500');
        
        if (phase === currentPhase) {
          circle.classList.add('bg-cyan-500');
        } else if (total > 0 && complete === total) {
          circle.classList.add('bg-green-500');
        } else {
          circle.classList.add('bg-gray-700');
        }
      });
    }

    function setPhase(phase) {
      currentPhase = phase;
      updatePhaseTimeline();
      renderTasks();
      updateStats();
      document.getElementById('taskPhase').value = phase;
    }

    // ========== TASK ACTIONS ==========
    async function toggleTask(id) {
      const task = allTasks.find(t => t.id === id);
      if (!task) return;
      
      try {
        const { error } = await supabase.from('post_award_tasks')
          .update({ 
            is_complete: !task.is_complete,
            completed_at: !task.is_complete ? new Date().toISOString() : null,
            updated_at: new Date().toISOString()
          })
          .eq('id', id);
        
        if (error) throw error;
        
        task.is_complete = !task.is_complete;
        renderTasks();
        updateStats();
        updatePhaseTimeline();
      } catch (err) {
        console.error('Failed to toggle task:', err);
      }
    }

    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        const { error } = await supabase.from('post_award_tasks').delete().eq('id', id);
        if (error) throw error;
        allTasks = allTasks.filter(t => t.id !== id);
        renderTasks();
        updateStats();
        updatePhaseTimeline();
      } catch (err) {
        console.error('Failed to delete:', err);
      }
    }

    // ========== MODAL HANDLERS ==========
    function openAddModal() {
      if (!document.getElementById('opportunityFilter').value) {
        alert('Select an opportunity first');
        return;
      }
      editingId = null;
      document.getElementById('taskForm').reset();
      document.getElementById('taskPhase').value = currentPhase;
      document.getElementById('taskModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('taskModal').classList.add('hidden');
      editingId = null;
    }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const oppId = document.getElementById('opportunityFilter').value;
      const taskData = {
        opportunity_id: oppId,
        description: document.getElementById('taskDescription').value,
        phase: document.getElementById('taskPhase').value,
        priority: document.getElementById('taskPriority').value,
        assigned_to: document.getElementById('taskAssignee').value || null,
        due_date: document.getElementById('taskDueDate').value || null,
        notes: document.getElementById('taskNotes').value || null,
        is_complete: false,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingId) {
          const { error } = await supabase.from('post_award_tasks').update(taskData).eq('id', editingId);
          if (error) throw error;
        } else {
          taskData.created_at = new Date().toISOString();
          const { error } = await supabase.from('post_award_tasks').insert([taskData]);
          if (error) throw error;
        }
        
        closeModal();
        await loadTasks();
      } catch (err) {
        console.error('Failed to save task:', err);
        alert('Failed to save: ' + err.message);
      }
    }

    // ========== QUICK ACTIONS ==========
    function generateKickoffAgenda() {
      const agenda = `
KICKOFF MEETING AGENDA
======================
Contract: ${document.getElementById('contractNumber').value || '[TBD]'}
Date: [TBD]
Location: [TBD]

1. Welcome & Introductions (10 min)
2. Contract Overview (15 min)
   - Scope of Work
   - Period of Performance
   - Key Deliverables
3. Government Team Introduction (10 min)
4. Contractor Team Introduction (10 min)
5. Communication Protocols (10 min)
6. Reporting Requirements (15 min)
7. Security Requirements (10 min)
8. Questions & Next Steps (20 min)

ATTENDEES:
- Contracting Officer: ${document.getElementById('contractingOfficer').value || '[TBD]'}
- COR: ${document.getElementById('corName').value || '[TBD]'}
- Program Manager: [TBD]
- Key Personnel: [TBD]
      `.trim();
      
      downloadText(agenda, 'kickoff-agenda.txt');
    }

    function generateStaffingPlan() {
      alert('Staffing Plan export will be available once team assignments are configured.');
    }

    function generateTransitionPlan() {
      alert('Transition Plan template will be generated based on contract details and tasks.');
    }

    function downloadText(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ========== REAL-TIME ==========
    function subscribeToChanges() {
      supabase
        .channel('post_award_tasks_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'post_award_tasks' }, () => {
          loadTasks();
        })
        .subscribe();
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById('opportunityFilter').addEventListener('change', loadTasks);

    // ========== INIT ==========
    async function init() {
      if (!initSupabase()) {
        updateConnectionStatus(false);
        return;
      }
      await loadOpportunities();
      subscribeToChanges();
      
      // Load key personnel placeholder
      document.getElementById('keyPersonnel').innerHTML = `
        <div class="flex items-center justify-between py-1">
          <span class="text-gray-400">Program Manager</span>
          <span class="text-amber-400">‚è≥ Pending</span>
        </div>
        <div class="flex items-center justify-between py-1">
          <span class="text-gray-400">Technical Lead</span>
          <span class="text-amber-400">‚è≥ Pending</span>
        </div>
        <div class="flex items-center justify-between py-1">
          <span class="text-gray-400">Security Officer</span>
          <span class="text-amber-400">‚è≥ Pending</span>
        </div>
      `;
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
