<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse — Org Chart</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:#00050F;min-height:100vh;color:#e2e8f0}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(0,229,250,0.2);border-radius:3px}</style>
  <script src="rbac-guard.js"></script>
</head>
<body>
  <div id="missionpulse-sidebar"></div>
  <div class="main-content"><div id="root"></div></div>
  <script src="missionpulse-nav.js"></script>
  <script type="text/babel">
    const{useState,useEffect,useRef,useCallback}=React;
    const SB_URL='https://qdrtpnpnhkxvfmvfziop.supabase.co';const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MjMxNDMsImV4cCI6MjA1MzQ5OTE0M30.GFbjgRMgVhMMcnNaJMrLVnJI_u6yBGJOhO-LHKE8sZQ';
    var sbClient;try{sbClient=supabase.createClient(SB_URL,SB_KEY)}catch(e){sbClient=null}
    const ROLES_ALLOWED=['*'];

    const ORG_DATA={
      id:'pm',name:'Mary Womack',title:'Program Manager',lcat:'PM',key:true,clearance:'Secret',partner:'MMT',fte:1.0,
      desc:'Overall program responsibility. Single point of contact for COR. Manages cost, schedule, and performance. Chairs weekly IPT and monthly PMR.',
      children:[
        {id:'dpm',name:'Tom Patterson',title:'Deputy PM',lcat:'DPM',key:true,clearance:'Secret',partner:'MMT',fte:1.0,
          desc:'Supports PM in day-to-day operations. Leads capture and transition activities. Manages risk register and EVM reporting. Acts as PM delegate.',
          children:[
            {id:'hdl',name:'Kevin Brown',title:'Help Desk Lead',lcat:'HD-Lead',key:false,clearance:'Public Trust',partner:'MMT',fte:1.0,
              desc:'Manages Tier 1-3 help desk operations. ServiceNow ticket management. SLA monitoring and escalation. Knowledge base maintenance.',
              children:[
                {id:'hd1',name:'TBD',title:'Help Desk Spec',lcat:'HD-T1',key:false,clearance:'Public Trust',partner:'MMT',fte:1.0,desc:'Tier 1 support. First-contact resolution. Ticket triage and routing.',children:[]},
                {id:'hd2',name:'TBD',title:'Help Desk Spec',lcat:'HD-T1',key:false,clearance:'Public Trust',partner:'MMT',fte:1.0,desc:'Tier 1 support. First-contact resolution. Ticket triage and routing.',children:[]},
              ]},
            {id:'tw',name:'Mark Stevens',title:'Technical Writer',lcat:'TW',key:false,clearance:'Public Trust',partner:'MMT',fte:0.5,
              desc:'Proposal and deliverable documentation. 508 compliance for documents. Maintains document repository and templates.',children:[]},
            {id:'ts',name:'TBD',title:'Training Specialist',lcat:'TS',key:false,clearance:'Public Trust',partner:'MMT',fte:0.5,
              desc:'End-user training development and delivery. Training materials and LMS management. Competency tracking.',children:[]},
          ]},
        {id:'sa',name:'Sarah Kim',title:'Solutions Architect',lcat:'SA',key:true,clearance:'Top Secret',partner:'MMT',fte:1.0,
          desc:'Technical vision and architecture ownership. Cloud infrastructure design (Azure Gov IL5). Integration strategy for MHS GENESIS. Technical review lead.',
          children:[
            {id:'sdev',name:'David Chen',title:'Sr Developer',lcat:'Sr-Dev',key:false,clearance:'Secret',partner:'TPA',fte:1.0,
              desc:'Full-stack development. React frontend and Python/Node backend. API design and database optimization. Code review lead.',children:[]},
            {id:'dso',name:'Lisa Wang',title:'DevSecOps Engineer',lcat:'DSO',key:false,clearance:'Secret',partner:'MMT',fte:1.0,
              desc:'CI/CD pipeline management (GitLab CI). Terraform IaC. Container orchestration (K8s). STIG automation and compliance scanning.',children:[]},
            {id:'de',name:'Michelle Torres',title:'Data Engineer',lcat:'DE',key:false,clearance:'Secret',partner:'DBL',fte:1.0,
              desc:'Data migration and ETL pipelines. Data lake architecture. Analytics dashboard development. Data quality and governance.',children:[]},
            {id:'ai',name:'James Rodriguez',title:'AI/ML Lead',lcat:'AI-Lead',key:true,clearance:'Secret',partner:'MMT',fte:1.0,
              desc:'AI/ML strategy and model development. AskSage integration. Responsible AI governance. NLP and predictive analytics implementation.',children:[]},
          ]},
        {id:'cyber',name:'Angela Foster',title:'Cybersecurity Lead',lcat:'Cyber',key:true,clearance:'Top Secret/SCI',partner:'MMT',fte:1.0,
          desc:'Security architecture and RMF execution. ATO package development. Continuous monitoring. Vulnerability management and incident response.',
          children:[
            {id:'isso',name:'Robert Jackson',title:'ISSO',lcat:'ISSO',key:false,clearance:'Top Secret',partner:'SFI',fte:0.5,
              desc:'eMASS management. STIG compliance validation. SCAP scanning. POA&M tracking. Audit support.',children:[]},
          ]},
        {id:'qa',name:'Patricia Nguyen',title:'QA Lead',lcat:'QA',key:false,clearance:'Secret',partner:'MMT',fte:1.0,
          desc:'Test strategy and execution. Automated regression testing (Selenium/Jest). 508 accessibility testing. Defect management and metrics.',children:[]},
      ]
    };

    const catColor={Management:'#a78bfa',Technical:'#00E5FA',Security:'#ef4444',Support:'#f59e0b',Quality:'#00ff88'};
    const getCat=lcat=>{
      if(['PM','DPM'].includes(lcat))return'Management';
      if(['SA','Sr-Dev','DSO','DE','AI-Lead'].includes(lcat))return'Technical';
      if(['Cyber','ISSO'].includes(lcat))return'Security';
      if(['HD-Lead','HD-T1','TW','TS'].includes(lcat))return'Support';
      return'Quality';
    };
    const clrColor={'Top Secret/SCI':'#ef4444','Top Secret':'#f59e0b',Secret:'#00E5FA','Public Trust':'#94a3b8'};
    const ConnectionDot=({c})=>(<div style={{display:'flex',alignItems:'center',gap:'6px',fontSize:'11px',color:c?'#00ff88':'#f59e0b'}}><div style={{width:'8px',height:'8px',borderRadius:'50%',background:c?'#00ff88':'#f59e0b',boxShadow:`0 0 6px ${c?'#00ff88':'#f59e0b'}`}}/>{c?'LIVE':'DEMO'}</div>);

    const countNodes=n=>1+(n.children||[]).reduce((s,c)=>s+countNodes(c),0);
    const countKey=n=>(n.key?1:0)+(n.children||[]).reduce((s,c)=>s+countKey(c),0);

    const OrgNode=({node,depth=0,selectedId,onSelect})=>{
      const cat=getCat(node.lcat);
      const isSelected=selectedId===node.id;
      return(
        <div style={{display:'flex',flexDirection:'column',alignItems:'center'}}>
          <div onClick={()=>onSelect(isSelected?null:node.id)}
            style={{background:isSelected?'rgba(0,229,250,0.08)':'rgba(10,22,40,0.7)',border:`1.5px solid ${isSelected?'#00E5FA':catColor[cat]+'30'}`,borderRadius:'10px',padding:'10px 14px',cursor:'pointer',transition:'all 0.15s',minWidth:'140px',textAlign:'center',position:'relative'}}
            onMouseOver={e=>{if(!isSelected)e.currentTarget.style.borderColor=catColor[cat]+'60'}} onMouseOut={e=>{if(!isSelected)e.currentTarget.style.borderColor=catColor[cat]+'30'}}>
            {node.key&&<div style={{position:'absolute',top:'-6px',right:'-6px',width:'16px',height:'16px',borderRadius:'50%',background:'rgba(245,158,11,0.2)',border:'1.5px solid #f59e0b',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'8px'}}>⭐</div>}
            <div style={{fontSize:'12px',fontWeight:700,color:'white'}}>{node.name}</div>
            <div style={{fontSize:'10px',color:catColor[cat],fontWeight:600,marginTop:'1px'}}>{node.title}</div>
            <div style={{display:'flex',gap:'4px',justifyContent:'center',marginTop:'4px'}}>
              <span style={{fontSize:'8px',padding:'0 4px',borderRadius:'2px',background:`${catColor[cat]}12`,color:catColor[cat]}}>{node.lcat}</span>
              <span style={{fontSize:'8px',padding:'0 4px',borderRadius:'2px',background:`${clrColor[node.clearance]}12`,color:clrColor[node.clearance]}}>{node.clearance}</span>
            </div>
            <div style={{fontSize:'8px',color:'#3e4f63',marginTop:'2px'}}>{node.partner} • {node.fte} FTE</div>
          </div>
          {node.children&&node.children.length>0&&(
            <div style={{display:'flex',flexDirection:'column',alignItems:'center',marginTop:'0'}}>
              <div style={{width:'2px',height:'16px',background:'rgba(0,229,250,0.12)'}}/>
              <div style={{display:'flex',gap:'8px',position:'relative'}}>
                {node.children.length>1&&<div style={{position:'absolute',top:'0',left:'50%',transform:'translateX(-50%)',width:`calc(100% - 140px)`,height:'2px',background:'rgba(0,229,250,0.1)'}}/>}
                {node.children.map(c=>(
                  <div key={c.id} style={{display:'flex',flexDirection:'column',alignItems:'center'}}>
                    <div style={{width:'2px',height:'12px',background:'rgba(0,229,250,0.12)'}}/>
                    <OrgNode node={c} depth={depth+1} selectedId={selectedId} onSelect={onSelect}/>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const findNode=(node,id)=>{
      if(node.id===id)return node;
      for(const c of(node.children||[])){const found=findNode(c,id);if(found)return found;}
      return null;
    };

    const App=()=>{
      const[connected,setConnected]=useState(false);
      const[selected,setSelected]=useState(null);
      const[view,setView]=useState('chart');
      const chartRef=useRef(null);

      useEffect(()=>{if(!sbClient)return;(async()=>{try{const{data,error}=await sbClient.from('team_assignments').select('id');if(!error&&data&&data.length>0)setConnected(true)}catch{}})()},[]);

      const selectedNode=selected?findNode(ORG_DATA,selected):null;
      const total=countNodes(ORG_DATA);
      const keyCount=countKey(ORG_DATA);

      const flatList=[];
      const flatten=(n,mgr)=>{flatList.push({...n,manager:mgr});(n.children||[]).forEach(c=>flatten(c,n.name))};
      flatten(ORG_DATA,null);

      return(
        <div style={{padding:'24px 32px',maxWidth:'1600px'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'24px'}}>
            <div>
              <div style={{fontSize:'10px',fontWeight:700,color:'rgba(0,229,250,0.5)',letterSpacing:'2px',textTransform:'uppercase',marginBottom:'4px'}}>PROGRAM ORGANIZATION</div>
              <h1 style={{fontSize:'26px',fontWeight:800,color:'white',letterSpacing:'-0.5px',margin:0}}>Organization Chart</h1>
              <div style={{fontSize:'12px',color:'#5a7a9a',marginTop:'4px'}}>DHA EHR Modernization • Interactive hierarchy • Role descriptions</div>
            </div>
            <ConnectionDot c={connected}/>
          </div>

          <div style={{display:'flex',gap:'10px',flexWrap:'wrap',marginBottom:'20px'}}>
            {[
              {label:'Total Staff',value:total,color:'#00E5FA'},
              {label:'Key Personnel',value:keyCount,color:'#f59e0b'},
              {label:'Partners',value:[...new Set(flatList.map(n=>n.partner))].length,color:'#a78bfa'},
              {label:'TS/SCI+TS',value:flatList.filter(n=>n.clearance.includes('Top Secret')).length,color:'#ef4444'},
              {label:'Total FTE',value:flatList.reduce((s,n)=>s+n.fte,0).toFixed(1),color:'#00ff88'},
            ].map(s=>(
              <div key={s.label} style={{background:'rgba(10,22,40,0.7)',border:'1px solid rgba(0,229,250,0.08)',borderRadius:'10px',padding:'10px 16px',minWidth:'120px'}}>
                <div style={{fontSize:'9px',fontWeight:700,color:'#5a7a9a',letterSpacing:'0.5px',textTransform:'uppercase'}}>{s.label}</div>
                <div style={{fontSize:'22px',fontWeight:800,color:s.color,letterSpacing:'-0.5px'}}>{s.value}</div>
              </div>
            ))}
          </div>

          <div style={{display:'flex',gap:'4px',marginBottom:'16px'}}>
            {[{k:'chart',l:'Org Chart'},{k:'list',l:'List View'}].map(t=>(
              <button key={t.k} onClick={()=>setView(t.k)} style={{padding:'7px 16px',fontSize:'12px',fontWeight:600,borderRadius:'8px',border:'none',cursor:'pointer',background:view===t.k?'rgba(0,229,250,0.15)':'rgba(10,22,40,0.5)',color:view===t.k?'#00E5FA':'#5a7a9a'}}>{t.l}</button>
            ))}
            <div style={{display:'flex',gap:'8px',marginLeft:'12px',fontSize:'10px',alignItems:'center'}}>
              {Object.entries(catColor).map(([k,c])=><span key={k} style={{display:'flex',alignItems:'center',gap:'3px',color:c}}><div style={{width:'8px',height:'8px',borderRadius:'2px',background:c}}/>{k}</span>)}
              <span style={{display:'flex',alignItems:'center',gap:'3px',color:'#f59e0b',marginLeft:'8px'}}>⭐ Key Personnel</span>
            </div>
          </div>

          {view==='chart'&&(
            <div style={{display:'flex',gap:'16px'}}>
              <div ref={chartRef} style={{flex:1,overflow:'auto',background:'rgba(10,22,40,0.3)',border:'1px solid rgba(0,229,250,0.06)',borderRadius:'12px',padding:'24px',display:'flex',justifyContent:'center'}}>
                <OrgNode node={ORG_DATA} selectedId={selected} onSelect={setSelected}/>
              </div>
              {selectedNode&&(
                <div style={{width:'300px',flexShrink:0,background:'rgba(10,22,40,0.5)',border:'1px solid rgba(0,229,250,0.12)',borderRadius:'12px',padding:'16px'}}>
                  <div style={{fontSize:'16px',fontWeight:800,color:'white',marginBottom:'2px'}}>{selectedNode.name}</div>
                  <div style={{fontSize:'12px',color:catColor[getCat(selectedNode.lcat)],fontWeight:600,marginBottom:'10px'}}>{selectedNode.title}</div>
                  <div style={{display:'flex',gap:'4px',flexWrap:'wrap',marginBottom:'12px'}}>
                    {selectedNode.key&&<span style={{fontSize:'9px',fontWeight:700,padding:'2px 6px',borderRadius:'3px',background:'rgba(245,158,11,0.12)',color:'#f59e0b'}}>⭐ KEY PERSONNEL</span>}
                    <span style={{fontSize:'9px',padding:'2px 6px',borderRadius:'3px',background:`${catColor[getCat(selectedNode.lcat)]}12`,color:catColor[getCat(selectedNode.lcat)]}}>{getCat(selectedNode.lcat)}</span>
                  </div>
                  {[
                    {l:'LCAT',v:selectedNode.lcat},
                    {l:'FTE',v:selectedNode.fte},
                    {l:'Clearance',v:selectedNode.clearance},
                    {l:'Partner',v:selectedNode.partner},
                    {l:'Reports To',v:flatList.find(n=>n.id===selectedNode.id)?.manager||'—'},
                    {l:'Direct Reports',v:selectedNode.children?.length||0},
                  ].map(r=>(
                    <div key={r.l} style={{display:'flex',justifyContent:'space-between',padding:'5px 0',borderBottom:'1px solid rgba(0,229,250,0.04)',fontSize:'11px'}}>
                      <span style={{color:'#5a7a9a'}}>{r.l}</span>
                      <span style={{color:'#e2e8f0',fontWeight:600}}>{r.v}</span>
                    </div>
                  ))}
                  <div style={{marginTop:'12px'}}>
                    <div style={{fontSize:'9px',fontWeight:700,color:'#5a7a9a',letterSpacing:'0.5px',marginBottom:'4px'}}>ROLE DESCRIPTION</div>
                    <div style={{fontSize:'11px',color:'#94a3b8',lineHeight:'1.6'}}>{selectedNode.desc}</div>
                  </div>
                </div>
              )}
            </div>
          )}

          {view==='list'&&(
            <div style={{background:'rgba(10,22,40,0.5)',border:'1px solid rgba(0,229,250,0.08)',borderRadius:'12px',overflow:'auto'}}>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'12px'}}>
                <thead><tr style={{borderBottom:'1px solid rgba(0,229,250,0.1)'}}>
                  {['Name','Title','LCAT','Category','Clearance','FTE','Partner','Reports To','Key'].map(h=>(
                    <th key={h} style={{padding:'10px 10px',textAlign:'left',color:'#5a7a9a',fontWeight:700,fontSize:'10px',letterSpacing:'0.5px',textTransform:'uppercase'}}>{h}</th>
                  ))}
                </tr></thead>
                <tbody>
                  {flatList.map(n=>{
                    const cat=getCat(n.lcat);
                    return(
                      <tr key={n.id} style={{borderBottom:'1px solid rgba(0,229,250,0.04)'}} onMouseOver={e=>e.currentTarget.style.background='rgba(0,229,250,0.03)'} onMouseOut={e=>e.currentTarget.style.background='transparent'}>
                        <td style={{padding:'8px 10px',color:'white',fontWeight:600}}>{n.name}</td>
                        <td style={{padding:'8px 10px',color:'#94a3b8'}}>{n.title}</td>
                        <td style={{padding:'8px 10px',fontFamily:'monospace',fontSize:'11px',color:'#00E5FA',fontWeight:600}}>{n.lcat}</td>
                        <td style={{padding:'8px 10px'}}><span style={{fontSize:'9px',padding:'1px 5px',borderRadius:'3px',background:`${catColor[cat]}12`,color:catColor[cat]}}>{cat}</span></td>
                        <td style={{padding:'8px 10px'}}><span style={{fontSize:'9px',fontWeight:600,color:clrColor[n.clearance]}}>{n.clearance}</span></td>
                        <td style={{padding:'8px 10px',textAlign:'center',fontWeight:600,color:'#00E5FA'}}>{n.fte}</td>
                        <td style={{padding:'8px 10px',color:'#5a7a9a',fontSize:'11px'}}>{n.partner}</td>
                        <td style={{padding:'8px 10px',color:'#5a7a9a',fontSize:'11px'}}>{n.manager||'—'}</td>
                        <td style={{padding:'8px 10px',textAlign:'center'}}>{n.key?'⭐':''}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}

          <div style={{textAlign:'center',padding:'20px 0',marginTop:'28px',borderTop:'1px solid rgba(0,229,250,0.06)',fontSize:'10px',color:'rgba(148,163,184,0.4)',lineHeight:'1.8'}}>⚠️ AI GENERATED — REQUIRES HUMAN REVIEW<br/>MissionPulse v12.0 — Mission Meets Tech | CMMC 2.0 L2 Compliant</div>
        </div>
      );
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
