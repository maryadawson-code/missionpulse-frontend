<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 | AI Proposal Command Center</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --mmt-cyan: #00E5FA; --mmt-navy: #00050F; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--mmt-navy); color: #e2e8f0; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(0, 229, 250, 0.1); }
    .glow { box-shadow: 0 0 30px rgba(0, 229, 250, 0.2); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes typing { from { width: 0 } to { width: 100% } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .animate-slideIn { animation: slideIn 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .chat-bubble { animation: fadeIn 0.3s ease-out; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// ============================================================
// MISSIONPULSE v12 - PHASE 2: COMPLETE PLATFORM
// Demo Flow + AI Agents + Full Modules
// Mission Meets Tech Â© 2026
// ============================================================

const { useState, useEffect, useRef, createContext, useContext } = React;

// ============================================================
// CONFIGURATION
// ============================================================
const CONFIG = {
  SUPABASE_URL: 'https://qlbvbfaprymzdqywcsiq.supabase.co',
  SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsYnZiZmFwcnltemRxeXdjc2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NjQ4NjcsImV4cCI6MjA1MzM0MDg2N30.QEnpsflnMM9i9xvYPHJlJO7wGPazPTvTWSFIohHcA',
  API_URL: 'https://missionpulse-api.onrender.com',
  LOGIN_PAGE: 'login.html'
};

const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

// ============================================================
// 11 SHIPLEY ROLES
// ============================================================
const ROLES = [
  { id: 'CEO', name: 'CEO', fullName: 'Mary Womack', icon: 'ðŸ‘‘', color: '#fbbf24', function: 'Executive Approver', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'launch', 'orals', 'frenemy', 'post_award'] },
  { id: 'COO', name: 'COO', fullName: 'David Chen', icon: 'ðŸ“Š', color: '#f97316', function: 'Capture Oversight', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'hitl', 'frenemy', 'launch', 'post_award', 'pricing'] },
  { id: 'CAP', name: 'Capture', fullName: 'Michael Torres', icon: 'ðŸŽ¯', color: '#f472b6', function: 'Capture Manager', access: ['dashboard', 'pipeline', 'blackhat', 'warroom', 'frenemy', 'swarm'] },
  { id: 'PM', name: 'Proposal Mgr', fullName: 'Lisa Martinez', icon: 'ðŸ“‹', color: '#60a5fa', function: 'Proposal Manager', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'writer', 'hitl', 'launch', 'post_award', 'orals'] },
  { id: 'SA', name: 'Solution Arch', fullName: 'Sarah Chen', icon: 'ðŸ”§', color: '#22d3ee', function: 'Technical Lead', access: ['writer', 'compliance', 'contracts', 'orals', 'swarm', 'dashboard'] },
  { id: 'FIN', name: 'Pricing', fullName: 'Jennifer Park', icon: 'ðŸ’°', color: '#34d399', function: 'Volume Lead', access: ['pricing', 'contracts', 'launch', 'swarm', 'dashboard'] },
  { id: 'CON', name: 'Contracts', fullName: 'Robert Williams', icon: 'âš–ï¸', color: '#a78bfa', function: 'Contracts/Compliance', access: ['compliance', 'contracts', 'swarm', 'hitl', 'dashboard'] },
  { id: 'DEL', name: 'Delivery', fullName: 'Amanda Foster', icon: 'ðŸ‘¥', color: '#fb7185', function: 'Delivery/Staffing', access: ['swarm', 'writer', 'post_award', 'orals', 'dashboard'] },
  { id: 'QA', name: 'QA Lead', fullName: 'James Thompson', icon: 'âœ…', color: '#2dd4bf', function: 'Quality Assurance', access: ['hitl', 'compliance', 'swarm', 'writer', 'dashboard'] },
  { id: 'Partner', name: 'Partner', fullName: 'External Partner', icon: 'ðŸ¤', color: '#94a3b8', function: 'Teaming Partner', access: ['frenemy', 'swarm'], restricted: true },
  { id: 'Admin', name: 'Admin', fullName: 'System Admin', icon: 'âš™ï¸', color: '#cbd5e1', function: 'System Admin', access: ['admin', 'audit', 'dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'contracts', 'writer', 'blackhat', 'pricing', 'hitl', 'orals', 'frenemy', 'launch', 'post_award', 'playbook'] }
];

// ============================================================
// 16 MODULES
// ============================================================
const MODULES = [
  { id: 'dashboard', name: 'Mission Control', icon: 'ðŸ“Š', color: '#facc15', category: 'Command', description: 'Executive Dashboard', scene: 0 },
  { id: 'pipeline', name: 'Pipeline Intel', icon: 'ðŸ”', color: '#60a5fa', category: 'Strategy', description: 'Opportunity Tracking', scene: 1 },
  { id: 'warroom', name: 'War Room', icon: 'âš”ï¸', color: '#818cf8', category: 'Strategy', description: 'Pursuit Strategy', scene: 7 },
  { id: 'swarm', name: 'Agent Swarm', icon: 'ðŸ¤–', color: '#2dd4bf', category: 'Strategy', description: 'AI Assistants', scene: 0 },
  { id: 'compliance', name: 'RFP Shredder', icon: 'ðŸ“„', color: '#f87171', category: 'Intelligence', description: 'Compliance Matrix', scene: 2 },
  { id: 'contracts', name: 'Contract Scanner', icon: 'âš–ï¸', color: '#a78bfa', category: 'Intelligence', description: 'Risk Analysis', scene: 2 },
  { id: 'writer', name: 'Iron Dome', icon: 'âœï¸', color: '#c084fc', category: 'Intelligence', description: 'AI Writing Suite', scene: 4 },
  { id: 'blackhat', name: 'Black Hat', icon: 'ðŸŽ­', color: '#fbbf24', category: 'Intelligence', description: 'Competitive Intel', badge: 'PRIVATE', scene: 7 },
  { id: 'pricing', name: 'Pricing Engine', icon: 'ðŸ’µ', color: '#4ade80', category: 'Delivery', description: 'LCAT & BOE', badge: 'CUI', scene: 3 },
  { id: 'hitl', name: 'HITL Queue', icon: 'ðŸ‘ï¸', color: '#fb923c', category: 'Delivery', description: 'Review Queue', scene: 7 },
  { id: 'orals', name: 'Orals Studio', icon: 'ðŸŽ¤', color: '#f472b6', category: 'Delivery', description: 'Presentation Prep', scene: 6 },
  { id: 'frenemy', name: 'Frenemy Protocol', icon: 'ðŸ›¡ï¸', color: '#22d3ee', category: 'Delivery', description: 'Partner Access', scene: 5 },
  { id: 'launch', name: 'Launch & ROI', icon: 'ðŸš€', color: '#e879f9', category: 'Command', description: 'Submission', scene: 8 },
  { id: 'post_award', name: 'Post-Award', icon: 'ðŸ“¦', color: '#a78bfa', category: 'Command', description: 'Transition', scene: 9 },
  { id: 'playbook', name: 'Playbook', icon: 'ðŸ“š', color: '#fbbf24', category: 'Admin', description: 'Golden Examples', scene: 0 },
  { id: 'admin', name: 'Admin', icon: 'âš™ï¸', color: '#cbd5e1', category: 'Admin', description: 'Settings', badge: 'ADMIN', scene: 0 }
];

// ============================================================
// 9-SCENE DEMO FLOW
// ============================================================
const DEMO_SCENES = [
  { id: 1, title: 'Parking Lot Intel', subtitle: 'Voice capture after customer meeting', icon: 'ðŸŽ¤', module: 'pipeline', color: '#00E5FA', description: 'Capture critical intel from customer conversations instantly' },
  { id: 2, title: 'Instant Compliance', subtitle: 'RFP shredding & matrix generation', icon: 'ðŸ“„', module: 'compliance', color: '#8B5CF6', description: 'AI extracts requirements and builds compliance matrix' },
  { id: 3, title: 'Green Team Miracle', subtitle: 'LCAT mapping & pricing', icon: 'ðŸ’°', module: 'pricing', color: '#10B981', description: 'Automated labor category mapping and BOE generation' },
  { id: 4, title: 'Iron Dome Drafter', subtitle: 'CUI-aware AI writing', icon: 'âœï¸', module: 'writer', color: '#EF4444', description: 'AI generates compliant proposal sections' },
  { id: 5, title: 'Frenemy View', subtitle: 'Partner data masking', icon: 'ðŸ›¡ï¸', module: 'frenemy', color: '#F59E0B', description: 'Secure partner collaboration with dynamic masking' },
  { id: 6, title: 'Orals Studio', subtitle: 'Presentation generation', icon: 'ðŸŽ¤', module: 'orals', color: '#A855F7', description: 'AI-powered slide decks and talking points' },
  { id: 7, title: 'Crisis Room', subtitle: 'EN/Amendment response', icon: 'âš ï¸', module: 'warroom', color: '#EC4899', description: 'Rapid response to government amendments' },
  { id: 8, title: 'Launch Sequence', subtitle: 'Final submission', icon: 'ðŸš€', module: 'launch', color: '#F97316', description: 'Countdown to submission with final checks' },
  { id: 9, title: 'The Handoff', subtitle: 'Post-award transition', icon: 'ðŸ¤', module: 'post_award', color: '#14B8A6', description: 'Seamless transition from BD to delivery' }
];

// ============================================================
// AI AGENTS
// ============================================================
const AI_AGENTS = [
  { id: 'capture', name: 'Capture Agent', icon: 'ðŸŽ¯', color: '#f472b6', description: 'Win strategy & positioning' },
  { id: 'strategy', name: 'Strategy Agent', icon: 'â™Ÿï¸', color: '#818cf8', description: 'Competitive analysis' },
  { id: 'blackhat', name: 'Black Hat Agent', icon: 'ðŸŽ­', color: '#fbbf24', description: 'Competitor simulation', restricted: true },
  { id: 'pricing', name: 'Pricing Agent', icon: 'ðŸ’µ', color: '#4ade80', description: 'Cost modeling & BOE' },
  { id: 'compliance', name: 'Compliance Agent', icon: 'ðŸ“‹', color: '#f87171', description: 'FAR/DFARS guidance' },
  { id: 'writer', name: 'Writer Agent', icon: 'âœï¸', color: '#c084fc', description: 'Section drafting' },
  { id: 'contracts', name: 'Contracts Agent', icon: 'âš–ï¸', color: '#a78bfa', description: 'T&C analysis' },
  { id: 'orals', name: 'Orals Coach', icon: 'ðŸŽ¤', color: '#f472b6', description: 'Presentation prep' }
];

const CATEGORIES = ['Strategy', 'Intelligence', 'Delivery', 'Command', 'Admin'];

// ============================================================
// AUTH CHECK
// ============================================================
function checkAuth() {
  const session = localStorage.getItem('MP_SESSION');
  const user = localStorage.getItem('MP_USER');
  if (!session || !user) {
    window.location.href = CONFIG.LOGIN_PAGE;
    return null;
  }
  try { return JSON.parse(user); } 
  catch { return { email: 'demo@mmt.com', role: 'CEO', name: 'Demo User' }; }
}

// ============================================================
// ICONS
// ============================================================
const Icons = {
  menu: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
  close: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
  chevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
  chevronRight: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
  logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
  shield: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
  send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
  bot: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
  play: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>,
};

// ============================================================
// SIDEBAR
// ============================================================
function Sidebar({ collapsed, setCollapsed, activeModule, setActiveModule, currentRole, demoMode, setDemoMode }) {
  const roleAccess = ROLES.find(r => r.id === currentRole)?.access || [];
  const hasAccess = (id) => currentRole === 'Admin' || roleAccess.includes(id);

  return (
    <aside className={`fixed left-0 top-0 h-full bg-slate-900/95 border-r border-slate-700/50 transition-all duration-300 z-40 flex flex-col ${collapsed ? 'w-16' : 'w-64'}`}>
      {/* Logo */}
      <div className="h-16 flex items-center justify-between px-4 border-b border-slate-700/50 flex-shrink-0">
        {!collapsed && (
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center text-white">
              <Icons.shield />
            </div>
            <div>
              <span className="font-bold text-white">MissionPulse</span>
              <span className="text-xs text-cyan-400 ml-1">v12</span>
            </div>
          </div>
        )}
        {collapsed && (
          <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center text-white mx-auto">
            <Icons.shield />
          </div>
        )}
      </div>

      {/* Demo Mode Toggle */}
      {!collapsed && (
        <div className="p-3 border-b border-slate-700/50">
          <button
            onClick={() => setDemoMode(!demoMode)}
            className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition ${
              demoMode ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'bg-slate-800 text-slate-400 hover:text-white'
            }`}
          >
            <Icons.play />
            <span>Demo Mode</span>
            {demoMode && <span className="ml-auto text-xs bg-cyan-500 text-black px-1.5 py-0.5 rounded">ON</span>}
          </button>
        </div>
      )}

      {/* Navigation */}
      <nav className="flex-1 p-2 overflow-y-auto">
        {CATEGORIES.map(category => {
          const modules = MODULES.filter(m => m.category === category && hasAccess(m.id));
          if (!modules.length) return null;
          
          return (
            <div key={category} className="mb-3">
              {!collapsed && <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase">{category}</div>}
              {modules.map(m => (
                <button
                  key={m.id}
                  onClick={() => setActiveModule(m.id)}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition mb-1 ${
                    activeModule === m.id ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white'
                  }`}
                  title={collapsed ? m.name : ''}
                >
                  <span className="text-lg">{m.icon}</span>
                  {!collapsed && (
                    <>
                      <span className="flex-1 text-left text-sm font-medium">{m.name}</span>
                      {m.badge && (
                        <span className={`px-1.5 py-0.5 text-[10px] font-bold rounded ${
                          m.badge === 'PRIVATE' ? 'bg-amber-500/20 text-amber-400' :
                          m.badge === 'CUI' ? 'bg-red-500/20 text-red-400' : 'bg-slate-600 text-slate-300'
                        }`}>{m.badge}</span>
                      )}
                    </>
                  )}
                </button>
              ))}
            </div>
          );
        })}
      </nav>

      {/* Collapse Toggle */}
      <button
        onClick={() => setCollapsed(!collapsed)}
        className="p-4 border-t border-slate-700/50 text-slate-400 hover:text-white flex items-center justify-center"
      >
        <span className={`transform transition ${collapsed ? '' : 'rotate-180'}`}><Icons.chevronRight /></span>
      </button>
    </aside>
  );
}

// ============================================================
// HEADER
// ============================================================
function Header({ user, currentRole, setCurrentRole, sidebarCollapsed, activeModule }) {
  const [roleDropdown, setRoleDropdown] = useState(false);
  const role = ROLES.find(r => r.id === currentRole);
  const module = MODULES.find(m => m.id === activeModule);

  const handleLogout = () => {
    localStorage.clear();
    window.location.href = CONFIG.LOGIN_PAGE;
  };

  return (
    <header className={`fixed top-0 right-0 h-16 bg-slate-900/90 backdrop-blur border-b border-slate-700/50 z-30 transition-all ${sidebarCollapsed ? 'left-16' : 'left-64'}`}>
      <div className="h-full px-6 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <span className="text-2xl">{module?.icon}</span>
          <div>
            <h1 className="text-lg font-semibold text-white">{module?.name || 'Mission Control'}</h1>
            <p className="text-xs text-slate-400">{module?.description}</p>
          </div>
        </div>

        <div className="flex items-center gap-4">
          {/* Role Switcher */}
          <div className="relative">
            <button onClick={() => setRoleDropdown(!roleDropdown)} className="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 hover:border-cyan-500/50">
              <span className="text-lg">{role?.icon}</span>
              <div className="text-left hidden sm:block">
                <div className="text-sm font-medium text-white">{role?.name}</div>
                <div className="text-xs text-slate-400">{role?.function}</div>
              </div>
              <Icons.chevronDown />
            </button>
            
            {roleDropdown && (
              <div className="absolute right-0 mt-2 w-72 bg-slate-800 border border-slate-700 rounded-xl shadow-2xl py-2 max-h-96 overflow-y-auto animate-fadeIn">
                <div className="px-3 py-2 text-xs font-semibold text-slate-500 uppercase">Switch Role</div>
                {ROLES.map(r => (
                  <button
                    key={r.id}
                    onClick={() => { setCurrentRole(r.id); setRoleDropdown(false); }}
                    className={`w-full flex items-center gap-3 px-3 py-2 hover:bg-slate-700 ${currentRole === r.id ? 'bg-cyan-500/10' : ''}`}
                  >
                    <span className="text-xl">{r.icon}</span>
                    <div className="flex-1 text-left">
                      <div className="text-sm font-medium text-white">{r.name}</div>
                      <div className="text-xs text-slate-400">{r.function}</div>
                    </div>
                    {currentRole === r.id && <span className="text-cyan-400">âœ“</span>}
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* User */}
          <div className="flex items-center gap-2 pl-4 border-l border-slate-700">
            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center text-white font-bold text-sm">
              {user?.name?.[0] || user?.email?.[0] || 'U'}
            </div>
            <button onClick={handleLogout} className="p-2 text-slate-400 hover:text-red-400 rounded-lg" title="Sign Out">
              <Icons.logout />
            </button>
          </div>
        </div>
      </div>
    </header>
  );
}

// ============================================================
// DEMO FLOW PANEL
// ============================================================
function DemoFlowPanel({ currentScene, setCurrentScene, setActiveModule }) {
  return (
    <div className="glass rounded-2xl p-4 mb-6 animate-fadeIn">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-semibold text-white flex items-center gap-2">
          <Icons.play /> Demo Flow - 9 Scenes
        </h3>
        <span className="text-sm text-cyan-400">Scene {currentScene + 1} of 9</span>
      </div>
      
      <div className="flex gap-2 overflow-x-auto pb-2">
        {DEMO_SCENES.map((scene, idx) => (
          <button
            key={scene.id}
            onClick={() => {
              setCurrentScene(idx);
              setActiveModule(scene.module);
            }}
            className={`flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg transition ${
              currentScene === idx
                ? 'bg-cyan-500 text-black font-medium'
                : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
            }`}
          >
            <span>{scene.icon}</span>
            <span className="text-sm whitespace-nowrap">{scene.title}</span>
          </button>
        ))}
      </div>

      {/* Current Scene Info */}
      <div className="mt-4 p-4 rounded-xl" style={{ backgroundColor: DEMO_SCENES[currentScene]?.color + '15' }}>
        <div className="flex items-start gap-4">
          <div className="text-4xl">{DEMO_SCENES[currentScene]?.icon}</div>
          <div>
            <h4 className="font-semibold text-white">{DEMO_SCENES[currentScene]?.title}</h4>
            <p className="text-sm text-slate-400">{DEMO_SCENES[currentScene]?.subtitle}</p>
            <p className="text-sm text-slate-300 mt-2">{DEMO_SCENES[currentScene]?.description}</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// AI CHAT WIDGET
// ============================================================
function AIChatWidget({ activeAgent, setActiveAgent }) {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    if (activeAgent) {
      setMessages([{ role: 'assistant', content: `Hello! I'm the ${activeAgent.name}. ${activeAgent.description}. How can I help you today?` }]);
      setIsOpen(true);
    }
  }, [activeAgent]);

  const sendMessage = async () => {
    if (!input.trim() || loading) return;
    
    const userMsg = { role: 'user', content: input };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setLoading(true);

    try {
      const response = await fetch(`${CONFIG.API_URL}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: input,
          agent: activeAgent?.id || 'capture',
          context: { module: 'dashboard' }
        })
      });

      if (response.ok) {
        const data = await response.json();
        setMessages(prev => [...prev, { role: 'assistant', content: data.response || data.message }]);
      } else {
        // Simulate response if API unavailable
        setTimeout(() => {
          setMessages(prev => [...prev, { 
            role: 'assistant', 
            content: `Thank you for your question about "${input}". As the ${activeAgent?.name || 'AI Assistant'}, I can help you with ${activeAgent?.description || 'proposal development'}. Let me analyze this for you...\n\n*This is a demo response. Connect to the API for full AI capability.*` 
          }]);
        }, 1000);
      }
    } catch (err) {
      setTimeout(() => {
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: `I understand you're asking about "${input}". In a production environment, I would provide detailed guidance on this topic.\n\n*Demo mode - API connection pending*` 
        }]);
      }, 800);
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) {
    return (
      <button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-white hover:scale-105 transition z-50"
      >
        <Icons.bot />
      </button>
    );
  }

  return (
    <div className="fixed bottom-6 right-6 w-96 h-[500px] glass rounded-2xl shadow-2xl flex flex-col z-50 animate-slideIn">
      {/* Header */}
      <div className="p-4 border-b border-slate-700/50 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center text-xl">
            {activeAgent?.icon || 'ðŸ¤–'}
          </div>
          <div>
            <h3 className="font-semibold text-white">{activeAgent?.name || 'AI Assistant'}</h3>
            <p className="text-xs text-slate-400">{activeAgent?.description || 'Ready to help'}</p>
          </div>
        </div>
        <button onClick={() => setIsOpen(false)} className="p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-700">
          <Icons.close />
        </button>
      </div>

      {/* Agent Selector */}
      <div className="p-2 border-b border-slate-700/50 flex gap-1 overflow-x-auto">
        {AI_AGENTS.filter(a => !a.restricted).map(agent => (
          <button
            key={agent.id}
            onClick={() => setActiveAgent(agent)}
            className={`flex-shrink-0 px-2 py-1 rounded-lg text-xs transition ${
              activeAgent?.id === agent.id ? 'bg-cyan-500/20 text-cyan-400' : 'text-slate-400 hover:bg-slate-700'
            }`}
          >
            {agent.icon}
          </button>
        ))}
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[80%] p-3 rounded-2xl chat-bubble ${
              msg.role === 'user' 
                ? 'bg-cyan-500 text-white rounded-br-md' 
                : 'bg-slate-700 text-slate-200 rounded-bl-md'
            }`}>
              <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
            </div>
          </div>
        ))}
        {loading && (
          <div className="flex justify-start">
            <div className="bg-slate-700 p-3 rounded-2xl rounded-bl-md">
              <div className="flex gap-1">
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse"></div>
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></div>
                <div className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></div>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input */}
      <div className="p-4 border-t border-slate-700/50">
        <div className="flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
            placeholder="Ask me anything..."
            className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white text-sm focus:outline-none focus:border-cyan-500"
          />
          <button
            onClick={sendMessage}
            disabled={!input.trim() || loading}
            className="p-2 bg-cyan-500 rounded-xl text-white hover:bg-cyan-400 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <Icons.send />
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// DASHBOARD MODULE
// ============================================================
function DashboardModule({ opportunities, loading, demoMode, currentScene, setCurrentScene, setActiveModule }) {
  const formatCurrency = (val) => {
    if (val >= 1e9) return `$${(val/1e9).toFixed(1)}B`;
    if (val >= 1e6) return `$${(val/1e6).toFixed(0)}M`;
    return `$${(val || 0).toLocaleString()}`;
  };

  const stats = {
    totalValue: opportunities.reduce((sum, o) => sum + (parseFloat(o.ceiling) || 0), 0),
    count: opportunities.length,
    avgPwin: 72
  };

  return (
    <div className="space-y-6 animate-fadeIn">
      {/* Demo Flow Panel */}
      {demoMode && (
        <DemoFlowPanel 
          currentScene={currentScene} 
          setCurrentScene={setCurrentScene}
          setActiveModule={setActiveModule}
        />
      )}

      {/* Welcome */}
      <div className="glass rounded-2xl p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10 glow">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-white mb-1">Welcome to MissionPulse</h2>
            <p className="text-slate-400">AI-powered proposal management for federal contractors</p>
            <p className="text-cyan-400 text-sm mt-2">Mission. Technology. Transformation.</p>
          </div>
          <div className="text-6xl">ðŸŽ¯</div>
        </div>
      </div>

      {/* KPIs */}
      <div className="grid grid-cols-4 gap-4">
        {[
          { label: 'Pipeline Value', value: formatCurrency(stats.totalValue), change: 'â†‘ 12%', color: 'emerald' },
          { label: 'Active Pursuits', value: stats.count, change: `${Math.ceil(stats.count * 0.3)} hot`, color: 'cyan' },
          { label: 'Avg Win Probability', value: `${stats.avgPwin}%`, change: 'Above target', color: 'amber' },
          { label: 'Hours Saved', value: '340+', change: 'Per proposal', color: 'purple' }
        ].map((kpi, i) => (
          <div key={i} className="glass rounded-xl p-5 hover:border-cyan-500/30 transition">
            <div className="text-slate-400 text-sm mb-1">{kpi.label}</div>
            <div className="text-2xl font-bold text-white">{kpi.value}</div>
            <div className={`text-${kpi.color}-400 text-xs mt-1`}>{kpi.change}</div>
          </div>
        ))}
      </div>

      {/* Pipeline Table */}
      <div className="glass rounded-2xl overflow-hidden">
        <div className="p-4 border-b border-slate-700/50 flex items-center justify-between">
          <h3 className="font-semibold text-white">Active Pipeline</h3>
          <span className="text-sm text-slate-400">{opportunities.length} opportunities</span>
        </div>
        
        {loading ? (
          <div className="p-8 text-center">
            <div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
            <p className="text-slate-400">Loading...</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-800/50">
                <tr>
                  <th className="text-left p-4 text-xs font-semibold text-slate-400 uppercase">Opportunity</th>
                  <th className="text-left p-4 text-xs font-semibold text-slate-400 uppercase">Agency</th>
                  <th className="text-left p-4 text-xs font-semibold text-slate-400 uppercase">Value</th>
                  <th className="text-left p-4 text-xs font-semibold text-slate-400 uppercase">Phase</th>
                  <th className="text-left p-4 text-xs font-semibold text-slate-400 uppercase">Win Probability</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-700/50">
                {opportunities.map(opp => (
                  <tr key={opp.id} className="hover:bg-slate-800/30 cursor-pointer transition">
                    <td className="p-4">
                      <div className="font-medium text-white">{opp.nickname || opp.title}</div>
                      <div className="text-xs text-slate-500 truncate max-w-xs">{opp.title}</div>
                    </td>
                    <td className="p-4 text-slate-300">{opp.agency || 'Federal'}</td>
                    <td className="p-4 text-emerald-400 font-medium">{formatCurrency(parseFloat(opp.ceiling))}</td>
                    <td className="p-4">
                      <span className="px-2 py-1 rounded-full text-xs font-medium bg-cyan-500/20 text-cyan-400">
                        {opp.phase || 'Capture'}
                      </span>
                    </td>
                    <td className="p-4">
                      <div className="flex items-center gap-2">
                        <div className="w-20 h-2 bg-slate-700 rounded-full overflow-hidden">
                          <div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500" style={{ width: `${opp.pwin || 70}%` }}></div>
                        </div>
                        <span className="text-sm text-slate-300">{opp.pwin || 70}%</span>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* AI Agents Quick Launch */}
      <div className="glass rounded-2xl p-6">
        <h3 className="font-semibold text-white mb-4">ðŸ¤– AI Agent Swarm</h3>
        <div className="grid grid-cols-4 gap-3">
          {AI_AGENTS.filter(a => !a.restricted).map(agent => (
            <button key={agent.id} className="p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700 hover:border-cyan-500/30 transition text-left group">
              <div className="text-2xl mb-2">{agent.icon}</div>
              <div className="font-medium text-white text-sm group-hover:text-cyan-400">{agent.name}</div>
              <div className="text-xs text-slate-500">{agent.description}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// PIPELINE MODULE
// ============================================================
function PipelineModule({ opportunities, loading }) {
  const [filter, setFilter] = useState('all');
  
  const phases = ['Qualify', 'Capture', 'Proposal', 'Submitted', 'Won', 'Lost'];
  const filtered = filter === 'all' ? opportunities : opportunities.filter(o => o.phase === filter);

  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-bold text-white">Pipeline Intelligence</h2>
          <p className="text-slate-400 text-sm">Track and analyze opportunities</p>
        </div>
        <button className="px-4 py-2 bg-cyan-500 text-white rounded-lg font-medium hover:bg-cyan-400">
          + New Opportunity
        </button>
      </div>

      {/* Filters */}
      <div className="flex gap-2 overflow-x-auto pb-2">
        <button
          onClick={() => setFilter('all')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
            filter === 'all' ? 'bg-cyan-500 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'
          }`}
        >
          All ({opportunities.length})
        </button>
        {phases.map(phase => {
          const count = opportunities.filter(o => o.phase === phase).length;
          return (
            <button
              key={phase}
              onClick={() => setFilter(phase)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap ${
                filter === phase ? 'bg-cyan-500 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'
              }`}
            >
              {phase} ({count})
            </button>
          );
        })}
      </div>

      {/* Cards Grid */}
      <div className="grid grid-cols-3 gap-4">
        {filtered.map(opp => (
          <div key={opp.id} className="glass rounded-xl p-4 hover:border-cyan-500/30 cursor-pointer transition">
            <div className="flex items-start justify-between mb-3">
              <span className="px-2 py-1 rounded text-xs font-medium bg-cyan-500/20 text-cyan-400">{opp.phase || 'Capture'}</span>
              <span className="text-emerald-400 font-semibold">${((parseFloat(opp.ceiling) || 0) / 1e6).toFixed(0)}M</span>
            </div>
            <h4 className="font-semibold text-white mb-1">{opp.nickname || opp.title}</h4>
            <p className="text-sm text-slate-400 mb-3 line-clamp-2">{opp.description || opp.title}</p>
            <div className="flex items-center justify-between">
              <span className="text-xs text-slate-500">{opp.agency || 'Federal'}</span>
              <div className="flex items-center gap-1">
                <div className="w-12 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                  <div className="h-full bg-cyan-500" style={{ width: `${opp.pwin || 70}%` }}></div>
                </div>
                <span className="text-xs text-slate-400">{opp.pwin || 70}%</span>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// AGENT SWARM MODULE
// ============================================================
function AgentSwarmModule({ setActiveAgent }) {
  return (
    <div className="space-y-6 animate-fadeIn">
      <div>
        <h2 className="text-xl font-bold text-white">AI Agent Swarm</h2>
        <p className="text-slate-400 text-sm">Your proposal intelligence team</p>
      </div>

      <div className="grid grid-cols-2 gap-4">
        {AI_AGENTS.map(agent => (
          <button
            key={agent.id}
            onClick={() => setActiveAgent(agent)}
            disabled={agent.restricted}
            className={`glass rounded-xl p-6 text-left hover:border-cyan-500/30 transition group ${agent.restricted ? 'opacity-50 cursor-not-allowed' : ''}`}
          >
            <div className="flex items-start gap-4">
              <div className="text-4xl">{agent.icon}</div>
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <h3 className="font-semibold text-white group-hover:text-cyan-400">{agent.name}</h3>
                  {agent.restricted && <span className="px-1.5 py-0.5 text-xs bg-amber-500/20 text-amber-400 rounded">PRIVATE</span>}
                </div>
                <p className="text-sm text-slate-400 mt-1">{agent.description}</p>
                {!agent.restricted && (
                  <div className="mt-3 text-xs text-cyan-400 flex items-center gap-1">
                    Launch Chat <Icons.chevronRight />
                  </div>
                )}
              </div>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// GENERIC MODULE
// ============================================================
function GenericModule({ module, setActiveAgent }) {
  const relatedAgent = AI_AGENTS.find(a => a.id === module.id || module.name.toLowerCase().includes(a.id));
  
  return (
    <div className="space-y-6 animate-fadeIn">
      <div className="glass rounded-2xl p-8 text-center">
        <div className="text-6xl mb-4">{module.icon}</div>
        <h2 className="text-2xl font-bold text-white mb-2">{module.name}</h2>
        <p className="text-slate-400 mb-4">{module.description}</p>
        {module.badge && (
          <span className={`px-3 py-1 rounded-full text-sm font-medium ${
            module.badge === 'PRIVATE' ? 'bg-amber-500/20 text-amber-400' :
            module.badge === 'CUI' ? 'bg-red-500/20 text-red-400' : 'bg-slate-600 text-slate-300'
          }`}>
            {module.badge === 'PRIVATE' && 'ðŸ”’ '}{module.badge}
          </span>
        )}
      </div>

      {/* Module-specific content based on scene */}
      {module.scene > 0 && (
        <div className="glass rounded-xl p-6">
          <h3 className="font-semibold text-white mb-4">
            Demo Scene {module.scene}: {DEMO_SCENES[module.scene - 1]?.title}
          </h3>
          <p className="text-slate-400">{DEMO_SCENES[module.scene - 1]?.description}</p>
        </div>
      )}

      {/* Launch AI Agent */}
      {relatedAgent && !relatedAgent.restricted && (
        <button
          onClick={() => setActiveAgent(relatedAgent)}
          className="w-full glass rounded-xl p-4 flex items-center gap-4 hover:border-cyan-500/30 transition"
        >
          <div className="text-3xl">{relatedAgent.icon}</div>
          <div className="flex-1 text-left">
            <h4 className="font-semibold text-white">Launch {relatedAgent.name}</h4>
            <p className="text-sm text-slate-400">{relatedAgent.description}</p>
          </div>
          <div className="text-cyan-400"><Icons.chevronRight /></div>
        </button>
      )}

      <div className="glass rounded-xl p-6 text-center text-slate-500">
        <p>Full module functionality coming in next release</p>
      </div>
    </div>
  );
}

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const [user, setUser] = useState(null);
  const [currentRole, setCurrentRole] = useState('CEO');
  const [activeModule, setActiveModule] = useState('dashboard');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [opportunities, setOpportunities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [demoMode, setDemoMode] = useState(true);
  const [currentScene, setCurrentScene] = useState(0);
  const [activeAgent, setActiveAgent] = useState(null);

  useEffect(() => {
    const userData = checkAuth();
    if (userData) {
      setUser(userData);
      setCurrentRole(userData.role || 'CEO');
    }
  }, []);

  useEffect(() => {
    async function fetchData() {
      setLoading(true);
      try {
        const { data, error } = await supabaseClient.from('opportunities').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        setOpportunities(data || []);
      } catch {
        setOpportunities([
          { id: 1, nickname: 'DHA EHR Mod', title: 'Electronic Health Record Modernization', agency: 'DHA', ceiling: 125000000, phase: 'Capture', pwin: 72, description: 'Modernize EHR systems across military treatment facilities' },
          { id: 2, nickname: 'VA Claims AI', title: 'Veterans Benefits Claims Processing', agency: 'VA', ceiling: 89000000, phase: 'Proposal', pwin: 65, description: 'AI-powered claims processing automation' },
          { id: 3, nickname: 'CMS Analytics', title: 'Medicare Data Analytics Platform', agency: 'CMS', ceiling: 156000000, phase: 'Qualify', pwin: 78, description: 'Advanced analytics for Medicare/Medicaid data' },
          { id: 4, nickname: 'IHS Telehealth', title: 'Indian Health Service Telehealth', agency: 'IHS', ceiling: 45000000, phase: 'Capture', pwin: 68, description: 'Expand telehealth to rural tribal communities' },
          { id: 5, nickname: 'SSA Legacy', title: 'Social Security Modernization', agency: 'SSA', ceiling: 200000000, phase: 'Qualify', pwin: 55, description: 'Legacy system modernization program' }
        ]);
      }
      setLoading(false);
    }
    fetchData();
  }, []);

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#00050F]">
        <div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  const moduleData = MODULES.find(m => m.id === activeModule);

  const renderModule = () => {
    switch (activeModule) {
      case 'dashboard':
        return <DashboardModule opportunities={opportunities} loading={loading} demoMode={demoMode} currentScene={currentScene} setCurrentScene={setCurrentScene} setActiveModule={setActiveModule} />;
      case 'pipeline':
        return <PipelineModule opportunities={opportunities} loading={loading} />;
      case 'swarm':
        return <AgentSwarmModule setActiveAgent={setActiveAgent} />;
      default:
        return <GenericModule module={moduleData} setActiveAgent={setActiveAgent} />;
    }
  };

  return (
    <div className="min-h-screen bg-[#00050F]">
      <Sidebar 
        collapsed={sidebarCollapsed} 
        setCollapsed={setSidebarCollapsed}
        activeModule={activeModule}
        setActiveModule={setActiveModule}
        currentRole={currentRole}
        demoMode={demoMode}
        setDemoMode={setDemoMode}
      />
      
      <Header 
        user={user}
        currentRole={currentRole}
        setCurrentRole={setCurrentRole}
        sidebarCollapsed={sidebarCollapsed}
        activeModule={activeModule}
      />

      <main className={`pt-20 pb-16 px-6 min-h-screen transition-all ${sidebarCollapsed ? 'ml-16' : 'ml-64'}`}>
        {renderModule()}
      </main>

      <footer className={`fixed bottom-0 right-0 left-0 p-3 text-xs bg-slate-900/80 border-t border-slate-800 transition-all ${sidebarCollapsed ? 'ml-16' : 'ml-64'}`}>
        <div className="flex items-center justify-between">
          <span className="text-slate-600">Â© 2026 Mission Meets Tech</span>
          <span className="text-amber-500 font-medium">AI GENERATED - REQUIRES HUMAN REVIEW</span>
          <span className="text-slate-600">Shield & Pulse UX v8.0</span>
        </div>
      </footer>

      <AIChatWidget activeAgent={activeAgent} setActiveAgent={setActiveAgent} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
