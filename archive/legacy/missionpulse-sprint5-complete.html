<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse v12 | AI Proposal Command Center</title>
    <link rel="icon" type="image/png" href="MMT_icon_32px.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
      :root { --mmt-cyan: #00E5FA; --mmt-navy: #00050F; }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Inter', sans-serif; background: var(--mmt-navy); color: #e2e8f0; min-height: 100vh; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #0a1628; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(0, 229, 250, 0.12); border-radius: 12px; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
      .animate-pulse { animation: pulse 2s infinite; }
      .progress-bar { transition: width 0.8s ease-out; }
      .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
      .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0, 229, 250, 0.15); }
      .live-indicator { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 8px #22c55e; }
      .risk-red { border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.05); }
      .risk-yellow { border-left: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.05); }
      .risk-green { border-left: 3px solid #22c55e; background: rgba(34, 197, 94, 0.05); }
    </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="overflow-hidden">
    <div id="root"></div>
    <script type="text/babel">
// ============================================================
// MISSIONPULSE v12 - SPRINT 5: IRON DOME + PRICING STUDIO
// Â© 2026 Mission Meets Tech
// ============================================================
const { useState, useEffect, useMemo, createContext, useContext } = React;

// SUPABASE
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';
let supabaseClient = null;
const getSupabaseClient = () => { if (!supabaseClient && window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); return supabaseClient; };

// MAPPING
const SHIPLEY_PHASES = { 'gate_1': { name: 'Gate 1', color: '#94a3b8' }, 'blue_team': { name: 'Blue Team', color: '#60a5fa' }, 'pink_team': { name: 'Pink Team', color: '#f472b6' }, 'red_team': { name: 'Red Team', color: '#ef4444' }, 'gold_team': { name: 'Gold Team', color: '#fbbf24' }, 'submitted': { name: 'Submitted', color: '#22c55e' } };
const mapOpp = r => r ? { id: r.id, name: r.title || r.name || 'Unnamed', agency: r.agency || 'TBD', ceiling: r.ceiling || 0, priority: r.priority || 'P-1', phase: SHIPLEY_PHASES[r.shipley_phase]?.name || 'Gate 1', pWin: r.win_probability || 50, daysRemaining: 90 } : null;
const mapComp = r => r ? { id: r.id, name: r.name, threat: r.threat_level || 'MEDIUM', pWin: r.estimated_pwin || 50, strength: r.strength || '', weakness: r.weakness || '', isIncumbent: r.is_incumbent, color: r.color || '#64748b' } : null;
const mapReq = r => r ? { id: r.id, pwsRef: r.pws_ref, title: r.title, text: r.requirement_text, status: r.status, riskLevel: r.risk_level, owner: r.assigned_owner, volume: r.section_volume } : null;
const mapMember = r => r ? { id: r.id, name: r.name, laborCat: r.labor_category, role: r.role, hourlyRate: r.hourly_rate, salary: r.annual_salary, clearance: r.clearance_level, isKey: r.is_key_personnel, years: r.years_experience, certs: r.certifications } : null;

// FALLBACKS
const DEMO_OPPS = [{ id: 'D1', name: 'DHA MHS GENESIS Cloud Migration', agency: 'DHA', ceiling: 98450210, priority: 'P-0', phase: 'Pink Team', pWin: 72 }];
const DEMO_COMPS = [{ id: 'C1', name: 'Leidos Health', threat: 'HIGH', pWin: 68, strength: 'Strong VA presence', weakness: 'Limited DHA', isIncumbent: false, color: '#EF4444' }];
const DEMO_REQS = [
  { id: 'R1', pwsRef: 'PWS 4.3.1', title: 'Health Data Interoperability', text: 'HL7 FHIR R4 compliance', status: 'HIGH_RISK', riskLevel: 'RED', owner: 'James Wong', volume: 'Vol II' },
  { id: 'R2', pwsRef: 'PWS 4.3.2', title: 'FedRAMP Authorization', text: 'FedRAMP High required', status: 'COMPLIANT', riskLevel: 'GREEN', owner: 'Sarah Chen', volume: 'Vol II' },
  { id: 'R3', pwsRef: 'PWS 5.1.1', title: 'Key Personnel', text: 'PM 10+ years experience', status: 'COMPLIANT', riskLevel: 'GREEN', owner: 'Lisa Martinez', volume: 'Vol III' },
  { id: 'R4', pwsRef: 'PWS 8.1.1', title: 'Cost Proposal Format', text: 'SF1411 format', status: 'PARTIAL', riskLevel: 'YELLOW', owner: 'Jennifer Park', volume: 'Vol VI' },
];
const DEMO_TEAM = [
  { id: 'T1', name: 'Dr. Angela Reyes', laborCat: 'Program Manager III', role: 'PM', hourlyRate: 185, salary: 385000, clearance: 'TS/SCI', isKey: true, years: 18, certs: 'PMP, ITIL' },
  { id: 'T2', name: 'James Wong', laborCat: 'Solutions Architect III', role: 'Tech Lead', hourlyRate: 165, salary: 343000, clearance: 'Secret', isKey: true, years: 15, certs: 'AWS Pro' },
  { id: 'T3', name: 'Sarah Mitchell', laborCat: 'Senior Engineer', role: 'Lead Dev', hourlyRate: 145, salary: 302000, clearance: 'Secret', isKey: true, years: 12, certs: 'CISSP' },
];

// CONTEXT & ROLES
const RoleContext = createContext(null);
const ROLES = [
  { id: 'CEO', name: 'CEO', fullName: 'Mary Womack', icon: 'crown', color: '#fbbf24', bgColor: 'rgba(251, 191, 36, 0.2)', access: ['dashboard', 'pipeline', 'warroom', 'frenemy', 'compliance', 'pricing', 'launch_roi', 'orals', 'post_award'] },
  { id: 'PM', name: 'Proposal Mgr', fullName: 'Lisa Martinez', icon: 'clipboard', color: '#60a5fa', bgColor: 'rgba(96, 165, 250, 0.2)', access: ['dashboard', 'pipeline', 'warroom', 'compliance', 'writer', 'hitl', 'orals'] },
  { id: 'SA', name: 'Solution Arch', fullName: 'Sarah Chen', icon: 'cpu', color: '#22d3ee', bgColor: 'rgba(34, 211, 238, 0.2)', access: ['compliance', 'writer', 'contracts', 'orals'] },
  { id: 'FIN', name: 'Pricing', fullName: 'Jennifer Park', icon: 'calculator', color: '#a855f7', bgColor: 'rgba(168, 85, 247, 0.2)', access: ['pricing', 'contracts', 'launch_roi'] },
  { id: 'CAP', name: 'Capture', fullName: 'Michael Torres', icon: 'target', color: '#f472b6', bgColor: 'rgba(244, 114, 182, 0.2)', access: ['dashboard', 'pipeline', 'blackhat', 'warroom', 'frenemy'] },
  { id: 'CON', name: 'Contracts', fullName: 'Robert Kim', icon: 'scale', color: '#22c55e', bgColor: 'rgba(34, 197, 94, 0.2)', access: ['contracts', 'compliance', 'pricing', 'post_award'] },
];
const MODULES = [
  { id: 'dashboard', name: 'Dashboard', icon: 'home' },
  { id: 'pipeline', name: 'Pipeline Intel', icon: 'activity' },
  { id: 'warroom', name: 'War Room', icon: 'users' },
  { id: 'frenemy', name: 'Frenemy Intel', icon: 'target' },
  { id: 'compliance', name: 'Iron Dome', icon: 'shield' },
  { id: 'pricing', name: 'Pricing Studio', icon: 'dollar-sign' },
  { id: 'writer', name: 'AI Writer', icon: 'edit' },
  { id: 'contracts', name: 'Contracts', icon: 'file-text' },
  { id: 'hitl', name: 'HITL Review', icon: 'check-square' },
  { id: 'orals', name: 'Orals Coach', icon: 'mic' },
  { id: 'launch_roi', name: 'Launch ROI', icon: 'rocket' },
  { id: 'agents', name: 'Agent Hub', icon: 'bot' },
];

// UI COMPONENTS
const Card = ({ children, className = '', onClick }) => <div className={`glass-panel p-4 hover-lift ${className}`} onClick={onClick}>{children}</div>;
const Badge = ({ children, color = '#00E5FA' }) => <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" style={{ backgroundColor: `${color}20`, color, border: `1px solid ${color}40` }}>{children}</span>;
const Button = ({ children, variant = 'default', size = 'sm', icon, onClick }) => {
  const v = { default: 'bg-slate-700 hover:bg-slate-600 text-white', primary: 'bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400' };
  return <button onClick={onClick} className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${v[variant]}`}>{icon && <Icon name={icon} size={14} />}{children}</button>;
};
const Icon = ({ name, size = 18, className = '' }) => {
  const paths = {
    'home': 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10',
    'activity': 'M22 12h-4l-3 9L9 3l-3 9H2',
    'users': 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0 8 4 4 0 0 0 0-8z',
    'target': 'M12 12m-10 0a10 10 0 1 0 20 0a10 10 0 1 0-20 0 M12 12m-6 0a6 6 0 1 0 12 0a6 6 0 1 0-12 0 M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0-4 0',
    'shield': 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z',
    'dollar-sign': 'M12 1v22 M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6',
    'edit': 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z',
    'file-text': 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6',
    'check-square': 'M9 11l3 3L22 4 M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11',
    'mic': 'M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z M19 10v2a7 7 0 0 1-14 0v-2',
    'rocket': 'M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z',
    'bot': 'M12 2a2 2 0 0 1 2 2v2h4a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4V4a2 2 0 0 1 2-2z',
    'crown': 'M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z',
    'clipboard': 'M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2',
    'cpu': 'M4 4h16v16H4z M9 1v3 M15 1v3 M9 20v3 M15 20v3',
    'calculator': 'M4 2h16a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z M8 6h8v4H8V6z',
    'scale': 'M12 3v18 M5 8l7-5 7 5 M5 8v8l7 5 7-5V8',
    'menu': 'M3 12h18 M3 6h18 M3 18h18',
    'alert': 'M12 9v4 M12 17h.01 M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z',
    'check': 'M20 6L9 17l-5-5',
    'plus': 'M12 5v14 M5 12h14',
  };
  return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={paths[name] || paths.home} /></svg>;
};
const DataIndicator = ({ isLive, count, table }) => (
  <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${isLive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
    <div className={isLive ? 'live-indicator animate-pulse' : 'w-2 h-2 rounded-full bg-amber-500'} />
    {isLive ? `Live ${table} (${count})` : `Demo ${table}`}
  </div>
);
const Loading = ({ text }) => <div className="flex items-center justify-center h-64"><div className="text-center"><div className="animate-spin w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full mx-auto mb-4"></div><p className="text-slate-400">{text}</p></div></div>;
const formatCurrency = v => v >= 1e9 ? `$${(v/1e9).toFixed(1)}B` : v >= 1e6 ? `$${(v/1e6).toFixed(1)}M` : v >= 1e3 ? `$${(v/1e3).toFixed(0)}K` : `$${v?.toLocaleString() || 0}`;

// ============================================================
// M1: PIPELINE INTEL
// ============================================================
const M1_Pipeline = () => {
  const [opps, setOpps] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isLive, setIsLive] = useState(false);
  useEffect(() => {
    (async () => {
      try {
        const c = getSupabaseClient(); if (!c) throw new Error();
        const { data, error } = await c.from('opportunities').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        setOpps((data || []).map(mapOpp)); setIsLive(true);
      } catch { setOpps(DEMO_OPPS); }
      setLoading(false);
    })();
  }, []);
  const stats = useMemo(() => ({ count: opps.length, value: opps.reduce((s,o) => s + (o.ceiling||0), 0), pWin: opps.length ? Math.round(opps.reduce((s,o) => s + o.pWin, 0) / opps.length) : 0 }), [opps]);
  if (loading) return <Loading text="Loading pipeline..." />;
  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-white">Pipeline Intelligence</h2><DataIndicator isLive={isLive} count={stats.count} table="opportunities" /></div>
      <div className="grid grid-cols-4 gap-4">
        <Card><p className="text-xs text-slate-400 mb-1">Active Pursuits</p><p className="text-2xl font-bold text-white">{stats.count}</p></Card>
        <Card><p className="text-xs text-slate-400 mb-1">Pipeline Value</p><p className="text-2xl font-bold text-emerald-400">{formatCurrency(stats.value)}</p></Card>
        <Card><p className="text-xs text-slate-400 mb-1">Avg Win Prob</p><p className="text-2xl font-bold text-cyan-400">{stats.pWin}%</p></Card>
        <Card><p className="text-xs text-slate-400 mb-1">Status</p><p className="text-lg font-bold" style={{color: isLive ? '#22c55e' : '#f59e0b'}}>{isLive ? 'LIVE' : 'DEMO'}</p></Card>
      </div>
      <Card>
        <h3 className="text-lg font-semibold text-white mb-4">Opportunities</h3>
        <div className="space-y-2">
          {opps.slice(0, 8).map(o => (
            <div key={o.id} className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
              <div><p className="text-sm font-medium text-white">{o.name}</p><p className="text-xs text-slate-500">{o.agency} â€¢ {o.phase}</p></div>
              <div className="flex items-center gap-4">
                <span className="text-sm text-emerald-400 font-mono">{formatCurrency(o.ceiling)}</span>
                <Badge color={o.priority === 'P-0' ? '#ef4444' : '#f59e0b'}>{o.priority}</Badge>
                <span className="text-sm text-cyan-400">{o.pWin}%</span>
              </div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// M2: WAR ROOM
// ============================================================
const M2_WarRoom = () => {
  const [comps, setComps] = useState([]);
  const [opps, setOpps] = useState([]);
  const [loading, setLoading] = useState(true);
  const [live, setLive] = useState({ comps: false, opps: false });
  useEffect(() => {
    (async () => {
      const c = getSupabaseClient();
      try { const { data } = await c?.from('opportunities').select('*').limit(5) || {}; setOpps((data || []).map(mapOpp)); setLive(l => ({...l, opps: !!data})); } catch { setOpps(DEMO_OPPS); }
      try { const { data } = await c?.from('competitors').select('*') || {}; setComps((data || []).map(mapComp)); setLive(l => ({...l, comps: !!data})); } catch { setComps(DEMO_COMPS); }
      setLoading(false);
    })();
  }, []);
  if (loading) return <Loading text="Loading War Room..." />;
  const threatColors = { HIGH: '#ef4444', MEDIUM: '#f59e0b', LOW: '#22c55e' };
  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-white">War Room</h2><div className="flex gap-2"><DataIndicator isLive={live.opps} count={opps.length} table="opps" /><DataIndicator isLive={live.comps} count={comps.length} table="competitors" /></div></div>
      <div className="grid grid-cols-2 gap-6">
        <Card><h3 className="text-lg font-semibold text-white mb-4">Competitor Intel</h3>
          <div className="space-y-3">{comps.map(c => (
            <div key={c.id} className="p-3 bg-slate-800/50 rounded-lg" style={{borderLeft: `3px solid ${threatColors[c.threat]}`}}>
              <div className="flex justify-between mb-2"><span className="text-sm font-semibold text-white">{c.name}</span><Badge color={threatColors[c.threat]}>{c.threat}</Badge></div>
              <div className="text-xs text-slate-400"><span className="text-emerald-400">+</span> {c.strength}</div>
              <div className="text-xs text-slate-400"><span className="text-red-400">-</span> {c.weakness}</div>
            </div>
          ))}</div>
        </Card>
        <Card><h3 className="text-lg font-semibold text-white mb-4">Priority Pursuits</h3>
          <div className="space-y-3">{opps.slice(0,4).map(o => (
            <div key={o.id} className="p-3 bg-slate-800/50 rounded-lg flex justify-between items-center">
              <div><p className="text-sm font-medium text-white">{o.name}</p><p className="text-xs text-slate-500">{o.agency}</p></div>
              <Badge color={o.priority === 'P-0' ? '#ef4444' : '#f59e0b'}>{o.priority}</Badge>
            </div>
          ))}</div>
        </Card>
      </div>
    </div>
  );
};

// ============================================================
// M6: IRON DOME - COMPLIANCE MATRIX (SPRINT 5)
// ============================================================
const M6_IronDome = () => {
  const [reqs, setReqs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isLive, setIsLive] = useState(false);
  const [filter, setFilter] = useState('ALL');
  
  useEffect(() => {
    (async () => {
      try {
        const c = getSupabaseClient(); if (!c) throw new Error();
        const { data, error } = await c.from('compliance_requirements').select('*').order('pws_ref');
        if (error) throw error;
        setReqs((data || []).map(mapReq)); setIsLive(true);
      } catch (e) { console.log('[IronDome] Using demo:', e); setReqs(DEMO_REQS); }
      setLoading(false);
    })();
  }, []);
  
  const stats = useMemo(() => ({
    total: reqs.length,
    compliant: reqs.filter(r => r.status === 'COMPLIANT').length,
    partial: reqs.filter(r => r.status === 'PARTIAL').length,
    highRisk: reqs.filter(r => r.status === 'HIGH_RISK').length,
    pending: reqs.filter(r => r.status === 'PENDING').length,
  }), [reqs]);
  
  const filtered = useMemo(() => {
    if (filter === 'ALL') return reqs;
    return reqs.filter(r => r.riskLevel === filter || r.status === filter);
  }, [reqs, filter]);
  
  const compliancePercent = stats.total ? Math.round((stats.compliant / stats.total) * 100) : 0;
  
  if (loading) return <Loading text="Loading compliance matrix..." />;
  
  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-xl font-bold text-white">Iron Dome - Compliance Matrix</h2>
          <p className="text-sm text-slate-400">AI-extracted requirements from solicitation</p>
        </div>
        <DataIndicator isLive={isLive} count={stats.total} table="requirements" />
      </div>
      
      {/* Stats */}
      <div className="grid grid-cols-5 gap-4">
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Total Requirements</p>
          <p className="text-2xl font-bold text-white">{stats.total}</p>
        </Card>
        <Card className="text-center border-l-2 border-emerald-500">
          <p className="text-xs text-slate-400 mb-1">Compliant</p>
          <p className="text-2xl font-bold text-emerald-400">{stats.compliant}</p>
        </Card>
        <Card className="text-center border-l-2 border-amber-500">
          <p className="text-xs text-slate-400 mb-1">Partial</p>
          <p className="text-2xl font-bold text-amber-400">{stats.partial}</p>
        </Card>
        <Card className="text-center border-l-2 border-red-500">
          <p className="text-xs text-slate-400 mb-1">High Risk</p>
          <p className="text-2xl font-bold text-red-400">{stats.highRisk}</p>
        </Card>
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Compliance Score</p>
          <p className="text-2xl font-bold text-cyan-400">{compliancePercent}%</p>
        </Card>
      </div>
      
      {/* Compliance Bar */}
      <Card>
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm font-medium text-white">Overall Compliance</span>
          <span className="text-sm text-cyan-400 font-mono">{compliancePercent}%</span>
        </div>
        <div className="h-4 bg-slate-700 rounded-full overflow-hidden flex">
          <div className="h-full bg-emerald-500" style={{ width: `${(stats.compliant / stats.total) * 100}%` }} />
          <div className="h-full bg-amber-500" style={{ width: `${(stats.partial / stats.total) * 100}%` }} />
          <div className="h-full bg-red-500" style={{ width: `${(stats.highRisk / stats.total) * 100}%` }} />
        </div>
        <div className="flex justify-between mt-2 text-xs text-slate-400">
          <span className="text-emerald-400">â–  Compliant</span>
          <span className="text-amber-400">â–  Partial</span>
          <span className="text-red-400">â–  High Risk</span>
          <span>â–  Pending</span>
        </div>
      </Card>
      
      {/* Filter Tabs */}
      <div className="flex gap-2">
        {['ALL', 'RED', 'YELLOW', 'GREEN'].map(f => (
          <button key={f} onClick={() => setFilter(f)}
                  className={`px-4 py-2 rounded-lg text-xs font-medium transition-all ${filter === f ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>
            {f === 'ALL' ? 'All' : f === 'RED' ? 'ðŸ”´ High Risk' : f === 'YELLOW' ? 'ðŸŸ¡ Partial' : 'ðŸŸ¢ Compliant'}
          </button>
        ))}
      </div>
      
      {/* Requirements List */}
      <Card>
        <h3 className="text-lg font-semibold text-white mb-4">Requirements ({filtered.length})</h3>
        <div className="space-y-2">
          {filtered.map(req => (
            <div key={req.id} className={`p-4 rounded-lg risk-${req.riskLevel.toLowerCase()}`}>
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-1">
                    <span className="text-xs font-mono text-cyan-400">{req.pwsRef}</span>
                    <span className="text-sm font-semibold text-white">{req.title}</span>
                  </div>
                  <p className="text-xs text-slate-400 mb-2">{req.text}</p>
                  <div className="flex items-center gap-4 text-xs">
                    <span className="text-slate-500">Owner: <span className="text-slate-300">{req.owner}</span></span>
                    <span className="text-slate-500">Volume: <span className="text-slate-300">{req.volume}</span></span>
                  </div>
                </div>
                <Badge color={req.riskLevel === 'RED' ? '#ef4444' : req.riskLevel === 'YELLOW' ? '#f59e0b' : '#22c55e'}>
                  {req.status.replace('_', ' ')}
                </Badge>
              </div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// M8: PRICING STUDIO (SPRINT 5)
// ============================================================
const M8_PricingStudio = () => {
  const [team, setTeam] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isLive, setIsLive] = useState(false);
  
  useEffect(() => {
    (async () => {
      try {
        const c = getSupabaseClient(); if (!c) throw new Error();
        const { data, error } = await c.from('team_members').select('*').order('hourly_rate', { ascending: false });
        if (error) throw error;
        setTeam((data || []).map(mapMember)); setIsLive(true);
      } catch (e) { console.log('[Pricing] Using demo:', e); setTeam(DEMO_TEAM); }
      setLoading(false);
    })();
  }, []);
  
  const stats = useMemo(() => ({
    headcount: team.length,
    keyPersonnel: team.filter(t => t.isKey).length,
    avgRate: team.length ? Math.round(team.reduce((s, t) => s + (t.hourlyRate || 0), 0) / team.length) : 0,
    totalLabor: team.reduce((s, t) => s + (t.salary || 0), 0),
    blendedRate: team.length ? Math.round(team.reduce((s, t) => s + (t.hourlyRate || 0), 0) / team.length) : 0,
  }), [team]);
  
  // Simulate BOE calculation (2080 hours/year, 5-year contract)
  const boeCalc = useMemo(() => {
    const annualHours = 2080;
    const years = 5;
    const directLabor = team.reduce((s, t) => s + ((t.hourlyRate || 0) * annualHours), 0) * years;
    const overhead = directLabor * 0.35; // 35% overhead
    const gna = (directLabor + overhead) * 0.08; // 8% G&A
    const profit = (directLabor + overhead + gna) * 0.10; // 10% profit
    const total = directLabor + overhead + gna + profit;
    return { directLabor, overhead, gna, profit, total, years };
  }, [team]);
  
  if (loading) return <Loading text="Loading pricing data..." />;
  
  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-xl font-bold text-white">Pricing Studio</h2>
          <p className="text-sm text-slate-400">Basis of Estimate & Labor Rate Management</p>
        </div>
        <DataIndicator isLive={isLive} count={stats.headcount} table="team members" />
      </div>
      
      {/* Stats */}
      <div className="grid grid-cols-5 gap-4">
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Team Size</p>
          <p className="text-2xl font-bold text-white">{stats.headcount}</p>
        </Card>
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Key Personnel</p>
          <p className="text-2xl font-bold text-amber-400">{stats.keyPersonnel}</p>
        </Card>
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Blended Rate</p>
          <p className="text-2xl font-bold text-cyan-400">${stats.blendedRate}/hr</p>
        </Card>
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">Annual Labor</p>
          <p className="text-2xl font-bold text-emerald-400">{formatCurrency(stats.totalLabor)}</p>
        </Card>
        <Card className="text-center">
          <p className="text-xs text-slate-400 mb-1">{boeCalc.years}yr BOE Total</p>
          <p className="text-2xl font-bold text-purple-400">{formatCurrency(boeCalc.total)}</p>
        </Card>
      </div>
      
      {/* BOE Breakdown */}
      <Card>
        <h3 className="text-lg font-semibold text-white mb-4">Basis of Estimate Breakdown ({boeCalc.years}-Year)</h3>
        <div className="grid grid-cols-5 gap-4">
          {[
            { label: 'Direct Labor', value: boeCalc.directLabor, color: '#60a5fa', pct: ((boeCalc.directLabor / boeCalc.total) * 100).toFixed(0) },
            { label: 'Overhead (35%)', value: boeCalc.overhead, color: '#f472b6', pct: ((boeCalc.overhead / boeCalc.total) * 100).toFixed(0) },
            { label: 'G&A (8%)', value: boeCalc.gna, color: '#fbbf24', pct: ((boeCalc.gna / boeCalc.total) * 100).toFixed(0) },
            { label: 'Profit (10%)', value: boeCalc.profit, color: '#22c55e', pct: ((boeCalc.profit / boeCalc.total) * 100).toFixed(0) },
            { label: 'Total Price', value: boeCalc.total, color: '#00E5FA', pct: '100' },
          ].map(item => (
            <div key={item.label} className="text-center p-3 bg-slate-800/50 rounded-lg">
              <p className="text-xs text-slate-400 mb-1">{item.label}</p>
              <p className="text-lg font-bold" style={{ color: item.color }}>{formatCurrency(item.value)}</p>
              <p className="text-xs text-slate-500">{item.pct}%</p>
            </div>
          ))}
        </div>
      </Card>
      
      {/* Team Table */}
      <Card>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold text-white">Labor Categories & Rates</h3>
          <Button variant="primary" icon="plus">Add Resource</Button>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-slate-800/50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Name</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Labor Category</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Clearance</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Rate</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Exp</th>
                <th className="px-4 py-3 text-left text-xs font-semibold text-slate-400 uppercase">Key</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-700/50">
              {team.map(m => (
                <tr key={m.id} className="hover:bg-slate-800/30">
                  <td className="px-4 py-3">
                    <p className="text-sm font-medium text-white">{m.name}</p>
                    <p className="text-xs text-slate-500">{m.role}</p>
                  </td>
                  <td className="px-4 py-3 text-sm text-slate-300">{m.laborCat}</td>
                  <td className="px-4 py-3"><Badge color={m.clearance?.includes('TS') ? '#ef4444' : '#22c55e'}>{m.clearance}</Badge></td>
                  <td className="px-4 py-3 text-sm text-emerald-400 font-mono">${m.hourlyRate}/hr</td>
                  <td className="px-4 py-3 text-sm text-slate-400">{m.years} yrs</td>
                  <td className="px-4 py-3">{m.isKey && <Badge color="#fbbf24">KEY</Badge>}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// DASHBOARD
// ============================================================
const Dashboard = ({ role }) => (
  <div className="p-6 space-y-6 animate-fadeIn">
    <div className="flex justify-between items-center">
      <div><h2 className="text-2xl font-bold text-white">Welcome to MissionPulse</h2><p className="text-slate-400">AI-Powered Proposal Command Center â€¢ Sprint 5</p></div>
    </div>
    <div className="grid grid-cols-4 gap-4">
      <Card className="text-center p-6 bg-gradient-to-br from-cyan-500/10 to-blue-500/10"><p className="text-3xl font-bold text-cyan-400">12</p><p className="text-xs text-slate-400">Opportunities</p></Card>
      <Card className="text-center p-6 bg-gradient-to-br from-emerald-500/10 to-green-500/10"><p className="text-3xl font-bold text-emerald-400">$847M</p><p className="text-xs text-slate-400">Pipeline</p></Card>
      <Card className="text-center p-6 bg-gradient-to-br from-amber-500/10 to-orange-500/10"><p className="text-3xl font-bold text-amber-400">15</p><p className="text-xs text-slate-400">Requirements</p></Card>
      <Card className="text-center p-6 bg-gradient-to-br from-purple-500/10 to-pink-500/10"><p className="text-3xl font-bold text-purple-400">10</p><p className="text-xs text-slate-400">Team Members</p></Card>
    </div>
    <Card><h3 className="text-lg font-semibold text-white mb-4">Sprint Status</h3>
      <div className="space-y-2">{[
        { name: 'Sprint 0-2: Database + Client', status: 'DONE', color: '#22c55e' },
        { name: 'Sprint 3: Pipeline Intel', status: 'DONE', color: '#22c55e' },
        { name: 'Sprint 4: War Room + Frenemy', status: 'DONE', color: '#22c55e' },
        { name: 'Sprint 5: Iron Dome + Pricing', status: 'LIVE', color: '#00e5fa' },
        { name: 'Sprint 6: Final QA + Polish', status: 'NEXT', color: '#f59e0b' },
      ].map(s => (
        <div key={s.name} className="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
          <span className="text-sm text-white">{s.name}</span><Badge color={s.color}>{s.status}</Badge>
        </div>
      ))}</div>
    </Card>
  </div>
);

const Placeholder = ({ name }) => <div className="p-6 flex items-center justify-center h-64"><div className="text-center"><p className="text-xl font-semibold text-slate-400">{name}</p><p className="text-sm text-slate-500 mt-2">Coming in Sprint 6</p></div></div>;

// ============================================================
// SIDEBAR
// ============================================================
const Sidebar = ({ current, setCurrent, role, collapsed, setCollapsed }) => (
  <div className={`h-full bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all ${collapsed ? 'w-16' : 'w-56'}`}>
    <div className="p-4 border-b border-slate-800 flex items-center justify-between">
      {!collapsed && <div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center"><span className="text-white text-xs font-bold">MP</span></div><div><h1 className="text-sm font-bold text-white">MissionPulse</h1><p className="text-[10px] text-cyan-400">v12.0 â€¢ Sprint 5</p></div></div>}
      <button onClick={() => setCollapsed(!collapsed)} className="p-1.5 hover:bg-slate-800 rounded"><Icon name="menu" size={16} className="text-slate-400" /></button>
    </div>
    <nav className="flex-1 p-2 space-y-1 overflow-y-auto">
      {MODULES.filter(m => role.access.includes(m.id) || m.id === 'dashboard').map(m => (
        <button key={m.id} onClick={() => setCurrent(m.id)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all ${current === m.id ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-slate-400 hover:bg-slate-800'}`}>
          <Icon name={m.icon} size={18} />{!collapsed && <span className="text-sm font-medium">{m.name}</span>}
        </button>
      ))}
    </nav>
    {!collapsed && <div className="p-3 border-t border-slate-800"><div className="flex items-center gap-2 px-2 py-1.5 rounded-lg" style={{backgroundColor: role.bgColor}}><div className="w-6 h-6 rounded-full flex items-center justify-center" style={{backgroundColor: role.color}}><Icon name={role.icon} size={12} className="text-slate-900" /></div><div><p className="text-xs font-semibold" style={{color: role.color}}>{role.name}</p><p className="text-[10px] text-slate-500">{role.fullName}</p></div></div></div>}
  </div>
);

// ============================================================
// APP
// ============================================================
function App() {
  const [role, setRole] = useState(ROLES[0]);
  const [current, setCurrent] = useState('dashboard');
  const [collapsed, setCollapsed] = useState(false);
  const render = () => {
    switch (current) {
      case 'dashboard': return <Dashboard role={role} />;
      case 'pipeline': return <M1_Pipeline />;
      case 'warroom': return <M2_WarRoom />;
      case 'frenemy': return <M2_WarRoom />; // Reuse for now
      case 'compliance': return <M6_IronDome />;
      case 'pricing': return <M8_PricingStudio />;
      default: return <Placeholder name={MODULES.find(m => m.id === current)?.name || 'Module'} />;
    }
  };
  return (
    <RoleContext.Provider value={role}>
      <div className="h-screen flex">
        <Sidebar current={current} setCurrent={setCurrent} role={role} collapsed={collapsed} setCollapsed={setCollapsed} />
        <div className="flex-1 flex flex-col overflow-hidden">
          <div className="h-14 bg-slate-900/95 border-b border-slate-800 flex items-center justify-between px-6">
            <h2 className="text-lg font-semibold text-white">{MODULES.find(m => m.id === current)?.name || 'Dashboard'}</h2>
            <select value={role.id} onChange={e => setRole(ROLES.find(r => r.id === e.target.value) || ROLES[0])} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-white">
              {ROLES.map(r => <option key={r.id} value={r.id}>{r.name} - {r.fullName}</option>)}
            </select>
          </div>
          <div className="flex-1 overflow-y-auto bg-slate-950">{render()}</div>
        </div>
      </div>
      <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-50">
        <span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW â€¢ MissionPulse v12.0 Sprint 5 â€¢ Â© 2026 Mission Meets Tech</span>
      </div>
    </RoleContext.Provider>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
