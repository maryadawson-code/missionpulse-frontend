<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 - Production</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#00050F;min-height:100vh}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn 0.3s ease-out}
    .animate-pulse{animation:pulse 2s ease-in-out infinite}
    .animate-spin{animation:spin 1s linear infinite}
    .glass{background:rgba(30,41,59,0.5);backdrop-filter:blur(8px);border:1px solid rgba(71,85,105,0.3);border-radius:12px}
    .hover-lift{transition:transform 0.2s,box-shadow 0.2s}
    .hover-lift:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,229,250,0.1)}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
    .drag-over{background:rgba(0,229,250,0.1)!important;border-color:rgba(0,229,250,0.5)!important}
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body>
<div id="root"></div>
<script src="supabase-client.js"></script>
<script type="text/babel">
const{useState,useEffect,useCallback}=React;

// ============================================================
// CONFIGURATION
// ============================================================
const RENDER_API_URL='https://missionpulse-api.onrender.com';

// ============================================================
// AUTH HELPERS
// ============================================================
function checkAuth(){
  const session=localStorage.getItem('MP_SESSION');
  const user=localStorage.getItem('MP_USER');
  if(!session||!user){window.location.href='login.html';return null}
  try{
    const parsed=JSON.parse(user);
    const sess=JSON.parse(session);
    if(sess.expires&&new Date(sess.expires)<new Date()){localStorage.clear();window.location.href='login.html';return null}
    return parsed;
  }catch{return{email:'demo@mmt.com',name:'Demo User',role:'CEO'}}
}
function handleLogout(){localStorage.removeItem('MP_SESSION');localStorage.removeItem('MP_USER');window.location.href='login.html'}

// ============================================================
// ROLES & MODULES
// ============================================================
const ROLES=[
  {id:'CEO',name:'CEO',fullName:'Mary Womack',icon:'üëë',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']},
  {id:'COO',name:'COO',fullName:'David Chen',icon:'üíº',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','pricing','hitl','frenemy','launch','post_award','playbook','training']},
  {id:'CAP',name:'Capture',fullName:'Michael Torres',icon:'üéØ',access:['dashboard','pipeline','warroom','swimlane','blackhat','frenemy','playbook']},
  {id:'PM',name:'Proposal Mgr',fullName:'Lisa Martinez',icon:'üìã',access:['dashboard','pipeline','warroom','swimlane','compliance','writer','hitl','orals','launch','post_award','playbook']},
  {id:'SA',name:'Solution Arch',fullName:'Sarah Chen',icon:'üíª',access:['dashboard','writer','compliance','contracts','orals','playbook']},
  {id:'FIN',name:'Pricing',fullName:'Jennifer Park',icon:'üí∞',access:['dashboard','pricing','contracts','launch','playbook']},
  {id:'CON',name:'Contracts',fullName:'Robert Williams',icon:'‚öñÔ∏è',access:['dashboard','compliance','contracts','hitl','playbook']},
  {id:'DEL',name:'Delivery',fullName:'Amanda Foster',icon:'üë•',access:['dashboard','writer','post_award','orals','playbook']},
  {id:'Admin',name:'Admin',fullName:'System Admin',icon:'‚öôÔ∏è',access:['dashboard','pipeline','warroom','swimlane','compliance','contracts','writer','blackhat','pricing','hitl','orals','frenemy','launch','post_award','playbook','admin','training','audit']}
];

const MODULES=[
  {id:'dashboard',name:'Mission Control',icon:'‚ö°',cat:'Command'},
  {id:'pipeline',name:'Pipeline Intel',icon:'üìä',cat:'Strategy'},
  {id:'warroom',name:'War Room',icon:'‚öîÔ∏è',cat:'Strategy'},
  {id:'swimlane',name:'Swimlane Board',icon:'üìã',cat:'Strategy'},
  {id:'compliance',name:'RFP Shredder',icon:'üìÑ',cat:'Intel'},
  {id:'contracts',name:'Contract Scanner',icon:'‚öñÔ∏è',cat:'Intel'},
  {id:'writer',name:'Iron Dome',icon:'‚úèÔ∏è',cat:'Intel'},
  {id:'blackhat',name:'Black Hat',icon:'üé≠',cat:'Intel',badge:'PRIVATE'},
  {id:'pricing',name:'Pricing Engine',icon:'üíµ',cat:'Delivery',badge:'CUI'},
  {id:'hitl',name:'HITL Queue',icon:'üëÅÔ∏è',cat:'Delivery'},
  {id:'orals',name:'Orals Studio',icon:'üé§',cat:'Delivery'},
  {id:'frenemy',name:'Frenemy Protocol',icon:'üõ°Ô∏è',cat:'Delivery'},
  {id:'launch',name:'Launch & ROI',icon:'üöÄ',cat:'Command'},
  {id:'post_award',name:'Post-Award',icon:'üì¶',cat:'Command'},
  {id:'playbook',name:'Playbook',icon:'‚≠ê',cat:'Admin'},
  {id:'admin',name:'Admin',icon:'‚öôÔ∏è',cat:'Admin',badge:'ADMIN'},
  {id:'training',name:'Training Hub',icon:'üéì',cat:'Admin'},
  {id:'audit',name:'Audit Log',icon:'üìú',cat:'Admin',badge:'ADMIN'}
];

const SHIPLEY_PHASES=[
  {key:'qualify',name:'Qualify',color:'#64748b'},
  {key:'capture',name:'Capture',color:'#8b5cf6'},
  {key:'blue_team',name:'Blue Team',color:'#3b82f6'},
  {key:'pink_team',name:'Pink Team',color:'#ec4899'},
  {key:'red_team',name:'Red Team',color:'#ef4444'},
  {key:'gold_team',name:'Gold Team',color:'#f59e0b'},
  {key:'white_glove',name:'White Glove',color:'#10b981'},
  {key:'submitted',name:'Submitted',color:'#22d3ee'}
];

// ============================================================
// AI SERVICE
// ============================================================
const AIService={
  status:'checking',
  async checkConnection(){try{const c=new AbortController();setTimeout(()=>c.abort(),5000);const r=await fetch(`${RENDER_API_URL}/`,{signal:c.signal});this.status=r.ok?'connected':'offline'}catch{this.status='offline'}return this.status},
  async chat(agent,message,context={}){
    if(this.status==='connected'){try{const r=await fetch(`${RENDER_API_URL}/api/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent,message,context})});if(r.ok){const d=await r.json();return{success:true,response:d.response||d.content||d,source:'api'}}}catch{}}
    return{success:true,response:this.getMockResponse(agent,message,context),source:'mock'}
  },
  getMockResponse(agent,message,context){
    const responses={
      blackhat:`## Competitive Analysis: ${context.competitor?.name||'Competitor'}\n\n**Threat Assessment:** ${context.competitor?.threat?.toUpperCase()||'MEDIUM'}\n\n### Ghosting Strategy:\n${context.competitor?.ghostStrategy||'Focus on differentiation through technical innovation.'}\n\n### Attack Vectors:\n1. **Price** - Position 5-10% below\n2. **Technical** - Modern cloud-native vs legacy\n3. **Personnel** - Stability and experience\n4. **Past Performance** - Quantified outcomes\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      writer:`## Generated: ${context.sectionType||'Content'}\n\n${message}\n\n**Key Themes:**\n- Mission alignment\n- Proven past performance\n- Technical innovation\n- Experienced personnel\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      compliance:`## Compliance Analysis\n\n**Summary:** 85% compliant, 10% partial, 5% risk\n\n**Actions:**\n1. Address Section L gaps\n2. Verify certifications\n3. Update pricing alignment\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      orals:`## Orals Slide: ${context.slideTitle||'Overview'}\n\n**Key Points:**\n‚Ä¢ Lead with discriminator\n‚Ä¢ Support with evidence\n‚Ä¢ Connect to evaluation criteria\n‚Ä¢ Anticipate questions\n\n**Talking Points:**\n1. Open with impact statement\n2. Present proof points\n3. Close with commitment\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`,
      assistant:`Based on Shipley methodology:\n\n1. **Compliance first** - Meet all requirements\n2. **Win themes** - What makes you unique?\n3. **Ghost competition** - Address weaknesses indirectly\n4. **Quantify claims** - Use metrics\n\n‚ö†Ô∏è AI GENERATED - REQUIRES HUMAN REVIEW`
    };
    return responses[agent]||responses.assistant;
  }
};

// ============================================================
// DEMO DATA
// ============================================================
const DEMO_OPPS=[
  {id:'1',name:'DHA MHS GENESIS Cloud Migration',nickname:'DHA EHR Mod',agency:'DHA',contractValue:98450210,shipleyPhase:'pink_team',winProbability:72,days:37,priority:'P-0',dueDate:'2026-03-01'},
  {id:'2',name:'VA Enterprise Claims Modernization',nickname:'VA Claims AI',agency:'VA',contractValue:67500000,shipleyPhase:'blue_team',winProbability:58,days:82,priority:'P-1',dueDate:'2026-04-15'},
  {id:'3',name:'CMS Quality Analytics Platform',nickname:'CMS Analytics',agency:'CMS',contractValue:125000000,shipleyPhase:'red_team',winProbability:68,days:21,priority:'P-0',dueDate:'2026-02-15'},
  {id:'4',name:'IHS Telehealth Expansion',nickname:'IHS Telehealth',agency:'IHS',contractValue:32000000,shipleyPhase:'capture',winProbability:55,days:156,priority:'P-1',dueDate:'2026-06-30'},
  {id:'5',name:'SSA Fraud Detection ML Platform',nickname:'SSA Fraud ML',agency:'SSA',contractValue:89000000,shipleyPhase:'gold_team',winProbability:81,days:14,priority:'P-0',dueDate:'2026-02-05'},
  {id:'6',name:'CDC Disease Surveillance System',nickname:'CDC Surveillance',agency:'CDC',contractValue:78000000,shipleyPhase:'qualify',winProbability:42,days:120,priority:'P-2',dueDate:'2026-08-01'}
];
const DEMO_COMPETITORS=[
  {id:'1',name:'Booz Allen Hamilton',threat:'high',strengths:['Incumbent','500+ staff','DHA relationships'],weaknesses:['Premium pricing','Slow adoption','High turnover'],ghostStrategy:'Emphasize agility and modern tech. Ghost their overhead.'},
  {id:'2',name:'Deloitte Federal',threat:'high',strengths:['Brand recognition','Healthcare expertise','Global delivery'],weaknesses:['Cost overruns','Heavy subcontracting','VA issues'],ghostStrategy:'Reference VA delays. Emphasize direct delivery.'},
  {id:'3',name:'GDIT',threat:'high',strengths:['Technical depth','Clearances','CMMC L3'],weaknesses:['Merger issues','Communication','Layoffs'],ghostStrategy:'Focus on healthcare expertise. Ghost merger challenges.'}
];
const DEMO_PARTNERS=[
  {id:'1',name:'CloudFirst Solutions',status:'Active',capabilities:['AWS','Azure','GCP','FedRAMP'],trustScore:92,socio:'SDVOSB',assigned:['DHA MHS GENESIS','VA Claims']},
  {id:'2',name:'DataSecure Inc',status:'Active',capabilities:['Cybersecurity','FedRAMP','CMMC'],trustScore:88,socio:'8(a)',assigned:['CMS Analytics']},
  {id:'3',name:'HealthTech Partners',status:'Pending',capabilities:['EHR','HL7 FHIR','Telehealth'],trustScore:75,socio:'WOSB',assigned:[]}
];
const DEMO_COMPLIANCE=[
  {id:'1',ref:'L.1.1',title:'Technical Approach - Cloud Architecture',section:'L',status:'compliant',owner:'Sarah Chen',confidence:95},
  {id:'2',ref:'L.1.2',title:'Technical Approach - Data Migration',section:'L',status:'compliant',owner:'Sarah Chen',confidence:92},
  {id:'3',ref:'L.2.1',title:'Management Approach - Program Management',section:'L',status:'compliant',owner:'Lisa Martinez',confidence:88},
  {id:'4',ref:'L.3.1',title:'Past Performance - Reference 1',section:'L',status:'compliant',owner:'Michael Torres',confidence:96},
  {id:'5',ref:'L.4.1',title:'Staffing Plan - Key Personnel',section:'L',status:'partial',owner:'Amanda Foster',confidence:68},
  {id:'6',ref:'M.1.1',title:'Price Proposal - Labor Categories',section:'M',status:'compliant',owner:'Jennifer Park',confidence:93},
  {id:'7',ref:'M.2.1',title:'Cost Volume - Basis of Estimate',section:'M',status:'risk',owner:'Jennifer Park',confidence:42},
  {id:'8',ref:'C.1.1',title:'FAR 52.212-4 Contract Terms',section:'C',status:'compliant',owner:'Robert Williams',confidence:98}
];
const DEMO_CONTRACTS=[
  {id:'1',vehicle:'GSA MAS',type:'IDIQ',risk:'low',clauses:12,findings:0,expiry:'2028-09-30'},
  {id:'2',vehicle:'CIO-SP3 SB',type:'GWAC',risk:'medium',clauses:28,findings:2,expiry:'2027-05-15'},
  {id:'3',vehicle:'SEWP V',type:'GWAC',risk:'low',clauses:15,findings:0,expiry:'2029-04-30'},
  {id:'4',vehicle:'VA T4NG',type:'BPA',risk:'high',clauses:34,findings:5,expiry:'2026-12-31'}
];
const DEMO_SUBMISSIONS=[
  {id:'1',name:'DHA MHS GENESIS Phase 1',status:'Won',value:45000000,submitted:'2025-08-15',result:'2025-11-01',roi:847},
  {id:'2',name:'VA Claims Pilot',status:'Won',value:18500000,submitted:'2025-06-01',result:'2025-08-15',roi:523},
  {id:'3',name:'CMS Quality Dashboard',status:'Pending',value:67000000,submitted:'2026-01-10',result:null,roi:null},
  {id:'4',name:'IHS Telehealth Phase 1',status:'Lost',value:12000000,submitted:'2025-09-20',result:'2025-12-01',roi:-125},
  {id:'5',name:'SSA Identity Platform',status:'Won',value:34000000,submitted:'2025-07-01',result:'2025-10-15',roi:672}
];
const DEMO_PLAYBOOK=[
  {id:'1',title:'Executive Summary - DHA Win',category:'Writing',score:96,uses:47,content:'Mission Meets Tech brings proven healthcare IT expertise...'},
  {id:'2',title:'Technical Innovation Theme',category:'Strategy',score:94,uses:38,content:'Unlike legacy approaches that require...'},
  {id:'3',title:'Past Performance Narrative',category:'Writing',score:92,uses:52,content:'[Contract Name] for [Agency] demonstrates...'},
  {id:'4',title:'Ghosting the Incumbent',category:'Strategy',score:91,uses:33,content:'The Government has experienced...'},
  {id:'5',title:'FedRAMP Authorization Boilerplate',category:'Compliance',score:95,uses:41,content:'Mission Meets Tech maintains FedRAMP High...'}
];
const DEMO_LCATS=[
  {id:'1',title:'Program Manager',rate:195,hours:2080,wrap:1.85},
  {id:'2',title:'Sr. Software Engineer',rate:165,hours:4160,wrap:1.85},
  {id:'3',title:'Software Engineer',rate:135,hours:6240,wrap:1.85},
  {id:'4',title:'Cloud Architect',rate:185,hours:1040,wrap:1.85},
  {id:'5',title:'Data Scientist',rate:155,hours:2080,wrap:1.85},
  {id:'6',title:'QA Analyst',rate:95,hours:4160,wrap:1.85}
];
const DEMO_HITL=[
  {id:'1',type:'Content',title:'Executive Summary Draft',author:'Sarah Chen',status:'pending',created:'2026-01-27'},
  {id:'2',type:'Pricing',title:'LCAT Rate Approval',author:'Jennifer Park',status:'pending',created:'2026-01-27'},
  {id:'3',type:'Compliance',title:'Section L.3 Review',author:'Robert Williams',status:'approved',created:'2026-01-26'},
  {id:'4',type:'Content',title:'Technical Approach v2',author:'Sarah Chen',status:'rejected',created:'2026-01-25'}
];
const DEMO_AUDIT=[
  {id:'1',action:'LOGIN',user:'Mary Womack',role:'CEO',ts:'2026-01-28T10:00:00Z'},
  {id:'2',action:'VIEW_BLACKHAT',user:'Michael Torres',role:'Capture',ts:'2026-01-28T09:45:00Z'},
  {id:'3',action:'EXPORT_PRICING',user:'Jennifer Park',role:'Pricing',ts:'2026-01-28T09:30:00Z'},
  {id:'4',action:'APPROVE_SECTION',user:'Lisa Martinez',role:'PM',ts:'2026-01-28T09:00:00Z'},
  {id:'5',action:'GENERATE_CONTENT',user:'Sarah Chen',role:'Solution Arch',ts:'2026-01-28T08:30:00Z'}
];

// Helpers
const fmt=v=>v>=1e9?`$${(v/1e9).toFixed(1)}B`:v>=1e6?`$${(v/1e6).toFixed(1)}M`:`$${(v||0).toLocaleString()}`;
const phaseName=p=>SHIPLEY_PHASES.find(s=>s.key===p)?.name||p;
const phaseColor=p=>SHIPLEY_PHASES.find(s=>s.key===p)?.color||'#64748b';

// ============================================================
// DATA HOOK
// ============================================================
function useData(fetchFn,fallback,deps=[]){
  const[data,setData]=useState(fallback);
  const[loading,setLoading]=useState(true);
  const load=useCallback(async()=>{
    setLoading(true);
    try{if(typeof MissionPulse!=='undefined'&&fetchFn){const r=await fetchFn();if(r?.data&&r.data.length>0){setData(r.data)}else{setData(fallback)}}else{setData(fallback)}}catch{setData(fallback)}
    setLoading(false);
  },[]);
  useEffect(()=>{load()},[...deps]);
  return{data,loading,refresh:load,setData};
}

// ============================================================
// ICONS
// ============================================================
const Icon=({name,className='w-5 h-5'})=>{
  const icons={
    chevronLeft:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>,
    chevronRight:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7"/></svg>,
    chevronDown:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7"/></svg>,
    x:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12"/></svg>,
    check:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7"/></svg>,
    send:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>,
    logout:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>,
    refresh:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    search:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>,
    plus:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4"/></svg>,
    upload:<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>,
  };
  return icons[name]||<span>‚óè</span>;
};

// Status Bar Component
const StatusBar=({dbStatus,aiStatus})=>{
  const c={connected:'bg-emerald-500',offline:'bg-red-500',checking:'bg-amber-500 animate-pulse'};
  return(<div className="flex items-center gap-4 text-xs"><div className="flex items-center gap-1.5"><div className={`w-2 h-2 rounded-full ${c[dbStatus]}`}/><span className="text-slate-400">DB</span></div><div className="flex items-center gap-1.5"><div className={`w-2 h-2 rounded-full ${c[aiStatus]}`}/><span className="text-slate-400">AI</span></div></div>);
};

// ============================================================
// MODULE: DASHBOARD
// ============================================================
function ModuleDashboard({dbStatus}){
  const{data:opps,loading}=useData(()=>MissionPulse?.getOpportunities(),DEMO_OPPS);
  const total=opps.reduce((s,o)=>s+(o.contractValue||o.ceiling||0),0);
  const avgPwin=opps.length?Math.round(opps.reduce((s,o)=>s+(o.winProbability||o.pWin||0),0)/opps.length):0;
  const urgent=opps.filter(o=>(o.days||999)<=7).length;
  
  if(loading)return<div className="flex items-center justify-center h-64"><div className="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;
  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="glass p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10">
        <div className="flex justify-between items-center">
          <div><h2 className="text-2xl font-bold text-white">Mission Control</h2><p className="text-slate-400">AI-Powered Proposal Command Center</p></div>
          <div className="flex items-center gap-4">
            <div className={`px-3 py-1 rounded-full text-xs font-medium ${dbStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>{dbStatus==='connected'?'üü¢ Live':'üü° Demo'}</div>
            <div className="text-5xl">üéØ</div>
          </div>
        </div>
      </div>
      <div className="grid grid-cols-4 gap-4">
        {[{l:'Pipeline Value',v:fmt(total),c:'text-emerald-400'},{l:'Active Pursuits',v:opps.length,c:'text-cyan-400'},{l:'Avg Win Prob',v:`${avgPwin}%`,c:'text-amber-400'},{l:'Due This Week',v:urgent,c:urgent>0?'text-red-400':'text-slate-400'}].map((s,i)=><div key={i} className="glass p-4 hover-lift"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}
      </div>
      <div className="glass overflow-hidden">
        <div className="p-4 border-b border-slate-700/50"><h3 className="font-semibold text-white">Active Pipeline</h3></div>
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{opps.slice(0,6).map(o=>(<tr key={o.id} className="hover:bg-slate-800/30"><td className="p-3 font-medium text-white text-sm">{o.nickname||o.name}</td><td className="p-3 text-sm text-slate-300">{o.agency}</td><td className="p-3 text-sm text-emerald-400 font-medium">{fmt(o.contractValue||o.ceiling)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:`${phaseColor(o.shipleyPhase)}20`,color:phaseColor(o.shipleyPhase)}}>{phaseName(o.shipleyPhase)}</span></td><td className="p-3"><div className="flex items-center gap-2"><div className="w-16 h-1.5 bg-slate-700 rounded-full"><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full" style={{width:`${o.winProbability||o.pWin||50}%`}}/></div><span className="text-xs text-slate-300">{o.winProbability||o.pWin||50}%</span></div></td><td className="p-3"><span className={`text-sm ${(o.days||999)<=7?'text-red-400 font-bold':(o.days||999)<=30?'text-amber-400':'text-slate-400'}`}>{o.days||'‚Äî'}d</span></td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: PIPELINE INTEL
// ============================================================
function ModulePipeline(){
  const{data:opps,loading,refresh}=useData(()=>MissionPulse?.getOpportunities(),DEMO_OPPS);
  const[search,setSearch]=useState('');
  const[phaseFilter,setPhaseFilter]=useState('all');
  const[sortBy,setSortBy]=useState('days');
  
  const filtered=opps.filter(o=>{
    const matchSearch=!search||(o.name||'').toLowerCase().includes(search.toLowerCase())||(o.agency||'').toLowerCase().includes(search.toLowerCase());
    const matchPhase=phaseFilter==='all'||o.shipleyPhase===phaseFilter;
    return matchSearch&&matchPhase;
  }).sort((a,b)=>{
    if(sortBy==='days')return(a.days||999)-(b.days||999);
    if(sortBy==='value')return(b.contractValue||0)-(a.contractValue||0);
    if(sortBy==='pwin')return(b.winProbability||0)-(a.winProbability||0);
    return 0;
  });

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div><h2 className="text-xl font-bold text-white">Pipeline Intel</h2><p className="text-slate-400 text-sm">Track and manage all opportunities</p></div>
        <button onClick={refresh} className="p-2 glass hover:bg-slate-700"><Icon name="refresh" className="w-4 h-4 text-slate-400"/></button>
      </div>
      <div className="flex gap-3">
        <div className="flex-1 relative"><Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"/><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search opportunities..." className="w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"/></div>
        <select value={phaseFilter} onChange={e=>setPhaseFilter(e.target.value)} className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="all">All Phases</option>{SHIPLEY_PHASES.map(p=><option key={p.key} value={p.key}>{p.name}</option>)}</select>
        <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm"><option value="days">Sort: Days Left</option><option value="value">Sort: Value</option><option value="pwin">Sort: Win Prob</option></select>
      </div>
      <div className="glass overflow-hidden">
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Opportunity','Agency','Value','Phase','pWin','Days','Priority'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{filtered.map(o=>(<tr key={o.id} className="hover:bg-slate-800/30 cursor-pointer"><td className="p-3"><div className="font-medium text-white text-sm">{o.nickname||o.name?.slice(0,30)}</div><div className="text-xs text-slate-500">{o.solicitationNumber||'‚Äî'}</div></td><td className="p-3 text-sm text-slate-300">{o.agency}</td><td className="p-3 text-sm text-emerald-400 font-medium">{fmt(o.contractValue||o.ceiling)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:`${phaseColor(o.shipleyPhase)}20`,color:phaseColor(o.shipleyPhase)}}>{phaseName(o.shipleyPhase)}</span></td><td className="p-3 text-sm text-cyan-400">{o.winProbability||o.pWin||50}%</td><td className="p-3"><span className={`text-sm font-medium ${(o.days||999)<=7?'text-red-400':(o.days||999)<=30?'text-amber-400':'text-slate-400'}`}>{o.days||'‚Äî'}</span></td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${o.priority==='P-0'?'bg-red-500/20 text-red-400':o.priority==='P-1'?'bg-amber-500/20 text-amber-400':'bg-slate-500/20 text-slate-400'}`}>{o.priority||'P-2'}</span></td></tr>))}</tbody>
        </table>
        {filtered.length===0&&<div className="p-8 text-center text-slate-400">No opportunities match your filters</div>}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: WAR ROOM
// ============================================================
function ModuleWarRoom(){
  const{data:opps}=useData(()=>MissionPulse?.getOpportunities(),DEMO_OPPS);
  const p0=opps.filter(o=>o.priority==='P-0').sort((a,b)=>(a.days||999)-(b.days||999));
  const focus=p0[0];

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div><h2 className="text-xl font-bold text-white">‚öîÔ∏è War Room</h2><p className="text-slate-400 text-sm">P-0 Priority Focus</p></div>
        <span className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">{p0.length} CRITICAL</span>
      </div>
      {focus?(
        <div className="glass p-6 border-red-500/30 bg-gradient-to-r from-red-500/5 to-transparent">
          <div className="flex justify-between items-start mb-6">
            <div><span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold mb-2 inline-block">üî• TOP PRIORITY</span><h3 className="text-2xl font-bold text-white">{focus.nickname||focus.name}</h3><p className="text-slate-400">{focus.agency} ‚Ä¢ {focus.solicitationNumber||'TBD'}</p></div>
            <div className="text-right"><div className="text-4xl font-bold text-red-400">{focus.days||'‚Äî'}</div><div className="text-xs text-slate-400">days left</div></div>
          </div>
          <div className="grid grid-cols-4 gap-4 mb-6">
            {[{l:'Value',v:fmt(focus.contractValue||focus.ceiling),c:'text-emerald-400'},{l:'Win Probability',v:`${focus.winProbability||focus.pWin||50}%`,c:'text-cyan-400'},{l:'Phase',v:phaseName(focus.shipleyPhase),c:'text-purple-400'},{l:'Due Date',v:focus.dueDate||'TBD',c:'text-amber-400'}].map((s,i)=><div key={i} className="bg-slate-800/50 p-3 rounded-lg"><p className="text-xs text-slate-400">{s.l}</p><p className={`text-lg font-bold ${s.c}`}>{s.v}</p></div>)}
          </div>
          <div className="grid grid-cols-3 gap-4">
            {['Review Compliance Matrix','Update Win Themes','Schedule Color Review'].map((a,i)=><button key={i} className="p-3 bg-slate-800/50 rounded-lg text-sm text-white hover:bg-slate-700 transition text-left">{['üìã','üéØ','üìÖ'][i]} {a}</button>)}
          </div>
        </div>
      ):<div className="glass p-8 text-center"><div className="text-4xl mb-2">üéâ</div><p className="text-white">No P-0 priorities!</p></div>}
      
      {p0.length>1&&(
        <div className="glass p-4">
          <h4 className="font-semibold text-white mb-3">Other P-0 Priorities</h4>
          <div className="space-y-2">{p0.slice(1).map(o=>(<div key={o.id} className="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg"><div><span className="font-medium text-white">{o.nickname||o.name}</span><span className="text-slate-400 text-sm ml-2">{o.agency}</span></div><span className="text-red-400 font-bold">{o.days}d</span></div>))}</div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// MODULE: SWIMLANE BOARD
// ============================================================
function ModuleSwimlane(){
  const{data:opps,setData}=useData(()=>MissionPulse?.getOpportunities(),DEMO_OPPS);
  const[draggedId,setDraggedId]=useState(null);

  const handleDragStart=(e,id)=>{setDraggedId(id);e.dataTransfer.effectAllowed='move'};
  const handleDragOver=(e)=>{e.preventDefault();e.currentTarget.classList.add('drag-over')};
  const handleDragLeave=(e)=>{e.currentTarget.classList.remove('drag-over')};
  const handleDrop=(e,phaseKey)=>{
    e.preventDefault();e.currentTarget.classList.remove('drag-over');
    if(!draggedId)return;
    setData(opps.map(o=>o.id===draggedId?{...o,shipleyPhase:phaseKey}:o));
    if(typeof MissionPulse!=='undefined')MissionPulse.updateOpportunity(draggedId,{shipleyPhase:phaseKey});
    setDraggedId(null);
  };

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üìã Swimlane Board</h2><p className="text-slate-400 text-sm">Drag opportunities across Shipley phases</p></div>
      <div className="flex gap-3 overflow-x-auto pb-4">
        {SHIPLEY_PHASES.map(phase=>{
          const phaseOpps=opps.filter(o=>o.shipleyPhase===phase.key);
          return(
            <div key={phase.key} className="flex-shrink-0 w-64" onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={e=>handleDrop(e,phase.key)}>
              <div className="flex items-center gap-2 mb-2 px-2"><div className="w-3 h-3 rounded-full" style={{background:phase.color}}/><span className="font-medium text-white text-sm">{phase.name}</span><span className="text-xs text-slate-400">({phaseOpps.length})</span></div>
              <div className="glass p-2 min-h-[400px] space-y-2">
                {phaseOpps.map(o=>(
                  <div key={o.id} draggable onDragStart={e=>handleDragStart(e,o.id)} className="p-3 bg-slate-800 rounded-lg cursor-grab hover:bg-slate-700 transition border border-transparent hover:border-cyan-500/30">
                    <div className="font-medium text-white text-sm mb-1">{o.nickname||o.name?.slice(0,20)}</div>
                    <div className="flex justify-between text-xs"><span className="text-slate-400">{o.agency}</span><span className="text-emerald-400">{fmt(o.contractValue||o.ceiling)}</span></div>
                    <div className="flex justify-between text-xs mt-1"><span className="text-cyan-400">{o.winProbability||o.pWin||50}%</span><span className={`${(o.days||999)<=7?'text-red-400':'text-slate-400'}`}>{o.days||'‚Äî'}d</span></div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: RFP SHREDDER (Compliance)
// ============================================================
function ModuleCompliance(){
  const{data:reqs}=useData(()=>MissionPulse?.getComplianceRequirements(),DEMO_COMPLIANCE);
  const[filter,setFilter]=useState('all');
  const filtered=filter==='all'?reqs:reqs.filter(r=>r.status===filter);
  const stats={compliant:reqs.filter(r=>r.status==='compliant').length,partial:reqs.filter(r=>r.status==='partial').length,risk:reqs.filter(r=>r.status==='risk').length};
  const avgConf=reqs.length?Math.round(reqs.reduce((s,r)=>s+(r.confidence||0),0)/reqs.length):0;

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center">
        <div><h2 className="text-xl font-bold text-white">üìÑ RFP Shredder</h2><p className="text-slate-400 text-sm">Compliance matrix with confidence scoring</p></div>
        <button className="px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg text-sm flex items-center gap-2 hover:bg-cyan-500/30"><Icon name="upload" className="w-4 h-4"/>Upload RFP</button>
      </div>
      <div className="grid grid-cols-4 gap-4">
        {[{l:'Compliant',v:stats.compliant,c:'text-emerald-400',bg:'bg-emerald-500/20'},{l:'Partial',v:stats.partial,c:'text-amber-400',bg:'bg-amber-500/20'},{l:'At Risk',v:stats.risk,c:'text-red-400',bg:'bg-red-500/20'},{l:'Avg Confidence',v:`${avgConf}%`,c:'text-cyan-400',bg:'bg-cyan-500/20'}].map((s,i)=><div key={i} className={`glass p-4 ${s.bg}`}><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}
      </div>
      <div className="flex gap-2">
        {['all','compliant','partial','risk'].map(f=><button key={f} onClick={()=>setFilter(f)} className={`px-3 py-1 rounded text-sm ${filter===f?'bg-cyan-500 text-white':'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{f==='all'?'All':f.charAt(0).toUpperCase()+f.slice(1)}</button>)}
      </div>
      <div className="glass overflow-hidden">
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Ref','Requirement','Section','Owner','Status','Confidence'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{filtered.map(r=>(<tr key={r.id} className="hover:bg-slate-800/30"><td className="p-3 font-mono text-sm text-cyan-400">{r.ref}</td><td className="p-3 text-sm text-white">{r.title}</td><td className="p-3 text-sm text-slate-400">{r.section}</td><td className="p-3 text-sm text-slate-300">{r.owner}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${r.status==='compliant'?'bg-emerald-500/20 text-emerald-400':r.status==='partial'?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400'}`}>{r.status}</span></td><td className="p-3"><div className="flex items-center gap-2"><div className="w-16 h-1.5 bg-slate-700 rounded-full"><div className={`h-full rounded-full ${r.confidence>=80?'bg-emerald-500':r.confidence>=60?'bg-amber-500':'bg-red-500'}`} style={{width:`${r.confidence}%`}}/></div><span className="text-xs text-slate-400">{r.confidence}%</span></div></td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: CONTRACT SCANNER
// ============================================================
function ModuleContracts(){
  const{data:contracts}=useData(()=>MissionPulse?.getContracts(),DEMO_CONTRACTS);
  const riskColors={low:'bg-emerald-500/20 text-emerald-400',medium:'bg-amber-500/20 text-amber-400',high:'bg-red-500/20 text-red-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">‚öñÔ∏è Contract Scanner</h2><p className="text-slate-400 text-sm">Vehicle analysis and risk assessment</p></div>
      <div className="grid grid-cols-2 gap-4">
        {contracts.map(c=>(
          <div key={c.id} className="glass p-4 hover-lift">
            <div className="flex justify-between items-start mb-3">
              <div><h3 className="font-semibold text-white">{c.vehicle}</h3><p className="text-xs text-slate-400">{c.type}</p></div>
              <span className={`px-2 py-1 rounded text-xs font-bold ${riskColors[c.risk]}`}>{c.risk?.toUpperCase()}</span>
            </div>
            <div className="grid grid-cols-3 gap-2 text-center">
              <div className="bg-slate-800/50 p-2 rounded"><div className="text-lg font-bold text-white">{c.clauses}</div><div className="text-[10px] text-slate-400">Clauses</div></div>
              <div className="bg-slate-800/50 p-2 rounded"><div className={`text-lg font-bold ${c.findings>0?'text-red-400':'text-emerald-400'}`}>{c.findings}</div><div className="text-[10px] text-slate-400">Findings</div></div>
              <div className="bg-slate-800/50 p-2 rounded"><div className="text-lg font-bold text-cyan-400">{c.expiry?.slice(0,7)||'‚Äî'}</div><div className="text-[10px] text-slate-400">Expiry</div></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: IRON DOME WRITER
// ============================================================
function ModuleWriter({aiStatus}){
  const[prompt,setPrompt]=useState('');
  const[output,setOutput]=useState('');
  const[generating,setGenerating]=useState(false);
  const[source,setSource]=useState('');
  const[sectionType,setSectionType]=useState('executive');
  const sections=[{id:'executive',name:'Executive Summary',icon:'üìã'},{id:'technical',name:'Technical Approach',icon:'üíª'},{id:'management',name:'Management Plan',icon:'üë•'},{id:'past_perf',name:'Past Performance',icon:'üìà'},{id:'staffing',name:'Staffing Plan',icon:'üßë‚Äçüíº'}];

  const generate=async()=>{if(!prompt.trim())return;setGenerating(true);setOutput('');const r=await AIService.chat('writer',prompt,{sectionType});setOutput(r.response);setSource(r.source);setGenerating(false)};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">‚úèÔ∏è Iron Dome Drafter</h2><p className="text-slate-400 text-sm">AI content generation</p></div><span className={`px-2 py-1 rounded text-xs ${aiStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>AI: {aiStatus==='connected'?'Live':'Mock'}</span></div>
      <div className="grid grid-cols-5 gap-2">{sections.map(s=><button key={s.id} onClick={()=>setSectionType(s.id)} className={`p-3 rounded-lg text-center transition ${sectionType===s.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="text-2xl mb-1">{s.icon}</div><div className="text-xs text-white">{s.name}</div></button>)}</div>
      <div className="glass p-4"><label className="text-sm text-slate-400 mb-2 block">Content Prompt</label><textarea value={prompt} onChange={e=>setPrompt(e.target.value)} rows={3} placeholder="Describe what you need..." className="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-cyan-500 resize-none"/><div className="flex justify-end mt-3"><button onClick={generate} disabled={generating||!prompt.trim()} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-2">{generating?<><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"/>Generating...</>:<>‚ú® Generate</>}</button></div></div>
      {output&&<div className="glass p-4"><div className="flex justify-between items-center mb-3"><h4 className="font-semibold text-white">Generated Content</h4><div className="flex gap-2"><span className={`text-xs px-2 py-1 rounded ${source==='api'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>{source==='api'?'Live':'Mock'}</span><button onClick={()=>navigator.clipboard.writeText(output)} className="px-3 py-1 bg-slate-700 text-white rounded text-sm hover:bg-slate-600">Copy</button></div></div><div className="bg-slate-800/50 rounded-lg p-4 text-sm text-slate-300 whitespace-pre-wrap">{output}</div></div>}
    </div>
  );
}

// ============================================================
// MODULE: BLACK HAT
// ============================================================
function ModuleBlackHat({aiStatus}){
  const{data:competitors}=useData(()=>MissionPulse?.getCompetitors(),DEMO_COMPETITORS);
  const[selected,setSelected]=useState(null);
  const[analyzing,setAnalyzing]=useState(false);
  const[analysis,setAnalysis]=useState('');
  const[source,setSource]=useState('');
  useEffect(()=>{if(competitors.length&&!selected)setSelected(competitors[0])},[competitors]);
  const runAnalysis=async()=>{if(!selected)return;setAnalyzing(true);setAnalysis('');const r=await AIService.chat('blackhat',`Analyze: ${selected.name}`,{competitor:selected});setAnalysis(r.response);setSource(r.source);setAnalyzing(false)};
  const threatColors={high:'bg-red-500/20 text-red-400',medium:'bg-amber-500/20 text-amber-400',low:'bg-emerald-500/20 text-emerald-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center"><div className="flex items-center gap-3"><h2 className="text-xl font-bold text-white">üé≠ Black Hat Analysis</h2><span className="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">üîí PRIVATE</span></div><span className={`px-2 py-1 rounded text-xs ${aiStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>AI: {aiStatus==='connected'?'Live':'Mock'}</span></div>
      <div className="glass p-3 bg-amber-500/5 border-amber-500/20"><p className="text-xs text-amber-400">‚ö†Ô∏è Confidential - Do not share with partners</p></div>
      <div className="grid grid-cols-3 gap-4">
        <div className="space-y-2">{competitors.map(c=><button key={c.id} onClick={()=>{setSelected(c);setAnalysis('')}} className={`w-full text-left p-4 rounded-lg transition ${selected?.id===c.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="flex justify-between items-center"><span className="font-medium text-white">{c.name}</span><span className={`px-2 py-0.5 rounded text-xs font-bold ${threatColors[c.threat]}`}>{c.threat?.toUpperCase()}</span></div></button>)}</div>
        <div className="col-span-2 glass p-6">{selected&&(<><div className="flex justify-between items-center mb-6"><div><h3 className="text-xl font-bold text-white">{selected.name}</h3><span className={`px-2 py-1 rounded text-xs font-bold ${threatColors[selected.threat]}`}>Threat: {selected.threat?.toUpperCase()}</span></div><button onClick={runAnalysis} disabled={analyzing} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50 flex items-center gap-2">{analyzing?<><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"/>Analyzing...</>:<>ü§ñ AI Analysis</>}</button></div><div className="grid grid-cols-2 gap-4 mb-4"><div><h4 className="text-sm font-semibold text-emerald-400 mb-2">üí™ Strengths</h4><ul className="space-y-1">{selected.strengths?.map((s,i)=><li key={i} className="text-sm text-slate-300">‚Ä¢ {s}</li>)}</ul></div><div><h4 className="text-sm font-semibold text-red-400 mb-2">‚ö° Weaknesses</h4><ul className="space-y-1">{selected.weaknesses?.map((w,i)=><li key={i} className="text-sm text-slate-300">‚Ä¢ {w}</li>)}</ul></div></div>{analysis?<div className="p-4 bg-slate-800/50 rounded-lg"><div className="flex justify-between items-center mb-2"><h4 className="text-sm font-semibold text-cyan-400">ü§ñ AI Analysis</h4><span className={`text-xs px-2 py-0.5 rounded ${source==='api'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>{source==='api'?'Live':'Mock'}</span></div><div className="text-sm text-slate-300 whitespace-pre-wrap">{analysis}</div></div>:<div className="p-4 bg-slate-800/50 rounded-lg"><h4 className="text-sm font-semibold text-cyan-400 mb-2">üëª Ghost Strategy</h4><p className="text-sm text-slate-300">{selected.ghostStrategy}</p></div>}</>)}</div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: PRICING ENGINE
// ============================================================
function ModulePricing(){
  const{data:lcats}=useData(()=>MissionPulse?.getTeamMembers?.(),DEMO_LCATS);
  const totalCost=lcats.reduce((s,l)=>(l.rate||0)*(l.hours||0)*(l.wrap||1.85)+s,0);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">üíµ Pricing Engine</h2><p className="text-slate-400 text-sm">BOE Builder with wrap rate calculations</p></div><span className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">CUI</span></div>
      <div className="grid grid-cols-3 gap-4">
        <div className="glass p-4"><p className="text-slate-400 text-xs">Total LCATs</p><p className="text-2xl font-bold text-cyan-400">{lcats.length}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Total Hours</p><p className="text-2xl font-bold text-amber-400">{lcats.reduce((s,l)=>s+(l.hours||0),0).toLocaleString()}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Loaded Cost</p><p className="text-2xl font-bold text-emerald-400">{fmt(totalCost)}</p></div>
      </div>
      <div className="glass overflow-hidden">
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Labor Category','Hourly Rate','Hours','Wrap Rate','Loaded Cost'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{lcats.map(l=>(<tr key={l.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm font-medium text-white">{l.title}</td><td className="p-3 text-sm text-emerald-400">${l.rate}</td><td className="p-3 text-sm text-slate-300">{(l.hours||0).toLocaleString()}</td><td className="p-3 text-sm text-cyan-400">{l.wrap}x</td><td className="p-3 text-sm font-medium text-amber-400">{fmt((l.rate||0)*(l.hours||0)*(l.wrap||1.85))}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: HITL QUEUE
// ============================================================
function ModuleHITL(){
  const[items,setItems]=useState(DEMO_HITL);
  const pending=items.filter(i=>i.status==='pending');
  const handleApprove=(id)=>setItems(items.map(i=>i.id===id?{...i,status:'approved'}:i));
  const handleReject=(id)=>setItems(items.map(i=>i.id===id?{...i,status:'rejected'}:i));
  const statusColors={pending:'bg-amber-500/20 text-amber-400',approved:'bg-emerald-500/20 text-emerald-400',rejected:'bg-red-500/20 text-red-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">üëÅÔ∏è HITL Review Queue</h2><p className="text-slate-400 text-sm">Human-in-the-loop approval workflow</p></div><span className="px-3 py-1 bg-amber-500/20 text-amber-400 rounded text-xs font-bold">{pending.length} PENDING</span></div>
      <div className="space-y-3">
        {items.map(item=>(
          <div key={item.id} className={`glass p-4 ${item.status==='pending'?'border-amber-500/30':''}`}>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-4">
                <span className={`px-2 py-1 rounded text-xs ${statusColors[item.status]}`}>{item.status.toUpperCase()}</span>
                <div><h4 className="font-medium text-white">{item.title}</h4><p className="text-xs text-slate-400">{item.type} ‚Ä¢ {item.author} ‚Ä¢ {item.created}</p></div>
              </div>
              {item.status==='pending'&&<div className="flex gap-2"><button onClick={()=>handleApprove(item.id)} className="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded text-sm hover:bg-emerald-500/30">‚úì Approve</button><button onClick={()=>handleReject(item.id)} className="px-3 py-1 bg-red-500/20 text-red-400 rounded text-sm hover:bg-red-500/30">‚úó Reject</button></div>}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// MODULE: ORALS STUDIO
// ============================================================
function ModuleOrals({aiStatus}){
  const[slides,setSlides]=useState(['Opening','Technical Approach','Past Performance','Key Personnel','Q&A']);
  const[selected,setSelected]=useState(0);
  const[generating,setGenerating]=useState(false);
  const[content,setContent]=useState('');

  const generateSlide=async()=>{setGenerating(true);const r=await AIService.chat('orals',`Generate slide content`,{slideTitle:slides[selected]});setContent(r.response);setGenerating(false)};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div className="flex justify-between items-center"><div><h2 className="text-xl font-bold text-white">üé§ Orals Studio</h2><p className="text-slate-400 text-sm">Presentation deck generator</p></div><span className={`px-2 py-1 rounded text-xs ${aiStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>AI: {aiStatus==='connected'?'Live':'Mock'}</span></div>
      <div className="grid grid-cols-4 gap-4">
        <div className="space-y-2">{slides.map((s,i)=><button key={i} onClick={()=>{setSelected(i);setContent('')}} className={`w-full text-left p-3 rounded-lg transition ${selected===i?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><span className="text-slate-400 text-xs">Slide {i+1}</span><div className="font-medium text-white text-sm">{s}</div></button>)}</div>
        <div className="col-span-3 glass p-6">
          <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-white">Slide {selected+1}: {slides[selected]}</h3><button onClick={generateSlide} disabled={generating} className="px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg text-sm font-medium disabled:opacity-50">{generating?'Generating...':'‚ú® Generate Content'}</button></div>
          <div className="aspect-video bg-slate-800 rounded-lg flex items-center justify-center mb-4">{content?<div className="p-6 text-sm text-slate-300 whitespace-pre-wrap overflow-auto max-h-full">{content}</div>:<div className="text-slate-500">Click generate to create slide content</div>}</div>
          <div className="flex gap-2"><button className="px-3 py-1 bg-slate-700 text-white rounded text-sm">‚Üê Previous</button><button className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Next ‚Üí</button><button className="ml-auto px-3 py-1 bg-cyan-500 text-white rounded text-sm">Export PPTX</button></div>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: FRENEMY PROTOCOL
// ============================================================
function ModuleFrenemy(){
  const{data:partners}=useData(()=>MissionPulse?.getPartners(),DEMO_PARTNERS);
  const[selected,setSelected]=useState(null);
  useEffect(()=>{if(partners.length&&!selected)setSelected(partners[0])},[partners]);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üõ°Ô∏è Frenemy Protocol</h2><p className="text-slate-400 text-sm">Partner access control</p></div>
      <div className="grid grid-cols-3 gap-4">{[{l:'Active',v:partners.filter(p=>p.status==='Active').length,c:'text-emerald-400'},{l:'Avg Trust',v:`${partners.length?Math.round(partners.reduce((s,p)=>s+(p.trustScore||0),0)/partners.length):0}%`,c:'text-cyan-400'},{l:'Pending',v:partners.filter(p=>p.status==='Pending').length,c:'text-amber-400'}].map((s,i)=><div key={i} className="glass p-4"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}</div>
      <div className="grid grid-cols-3 gap-4">
        <div className="space-y-2">{partners.map(p=><button key={p.id} onClick={()=>setSelected(p)} className={`w-full text-left p-4 rounded-lg transition ${selected?.id===p.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="flex justify-between items-center"><span className="font-medium text-white">{p.name}</span><span className={`px-2 py-0.5 rounded text-xs font-bold ${p.status==='Active'?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>{p.status}</span></div><div className="text-xs text-slate-400 mt-1">{p.socio} ‚Ä¢ {p.trustScore}%</div></button>)}</div>
        <div className="col-span-2 glass p-6">{selected&&(<><div className="flex justify-between items-center mb-6"><div><h3 className="text-xl font-bold text-white">{selected.name}</h3><div className="flex gap-2 mt-2"><span className={`px-2 py-1 rounded text-xs font-bold ${selected.status==='Active'?'bg-emerald-500/20 text-emerald-400':'bg-amber-500/20 text-amber-400'}`}>{selected.status}</span><span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs">{selected.socio}</span></div></div><div className="text-right"><div className="text-3xl font-bold text-cyan-400">{selected.trustScore}%</div><div className="text-xs text-slate-400">Trust Score</div></div></div><div className="mb-4"><h4 className="text-sm font-semibold text-white mb-2">Capabilities</h4><div className="flex flex-wrap gap-2">{selected.capabilities?.map((c,i)=><span key={i} className="px-2 py-1 bg-slate-700 rounded text-xs text-white">{c}</span>)}</div></div><div><h4 className="text-sm font-semibold text-white mb-2">Assigned</h4>{selected.assigned?.length>0?<div className="space-y-2">{selected.assigned.map((a,i)=><div key={i} className="p-2 bg-slate-800/50 rounded flex justify-between items-center"><span className="text-sm text-white">{a}</span><button className="text-xs text-red-400">Revoke</button></div>)}</div>:<p className="text-sm text-slate-500">None assigned</p>}</div></>)}</div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: LAUNCH & ROI
// ============================================================
function ModuleLaunch(){
  const{data:subs}=useData(()=>MissionPulse?.getSubmissions(),DEMO_SUBMISSIONS);
  const wins=subs.filter(s=>s.status==='Won');
  const winRate=subs.filter(s=>s.status!=='Pending').length?Math.round(wins.length/subs.filter(s=>s.status!=='Pending').length*100):0;
  const totalWon=wins.reduce((s,w)=>s+(w.value||0),0);
  const avgROI=wins.length?Math.round(wins.reduce((s,w)=>s+(w.roi||0),0)/wins.length):0;

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üöÄ Launch & ROI</h2><p className="text-slate-400 text-sm">Submission tracking and analytics</p></div>
      <div className="grid grid-cols-4 gap-4">
        {[{l:'Win Rate',v:`${winRate}%`,c:'text-emerald-400'},{l:'Total Won',v:fmt(totalWon),c:'text-cyan-400'},{l:'Avg ROI',v:`${avgROI}%`,c:'text-amber-400'},{l:'Pending',v:subs.filter(s=>s.status==='Pending').length,c:'text-purple-400'}].map((s,i)=><div key={i} className="glass p-4"><p className="text-slate-400 text-xs">{s.l}</p><p className={`text-2xl font-bold ${s.c}`}>{s.v}</p></div>)}
      </div>
      <div className="glass overflow-hidden">
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Submission','Value','Submitted','Status','ROI'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{subs.map(s=>(<tr key={s.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm font-medium text-white">{s.name}</td><td className="p-3 text-sm text-emerald-400">{fmt(s.value)}</td><td className="p-3 text-sm text-slate-400">{s.submitted}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${s.status==='Won'?'bg-emerald-500/20 text-emerald-400':s.status==='Lost'?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}`}>{s.status}</span></td><td className="p-3 text-sm"><span className={s.roi>0?'text-emerald-400':s.roi<0?'text-red-400':'text-slate-400'}>{s.roi!=null?`${s.roi}%`:'‚Äî'}</span></td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: POST-AWARD
// ============================================================
function ModulePostAward(){
  const[checklist]=useState([{id:'1',task:'Contract signed',done:true},{id:'2',task:'Kickoff scheduled',done:true},{id:'3',task:'Key personnel onboarded',done:false},{id:'4',task:'Systems access provisioned',done:false},{id:'5',task:'Transition plan approved',done:false}]);
  const progress=Math.round(checklist.filter(c=>c.done).length/checklist.length*100);

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üì¶ Post-Award</h2><p className="text-slate-400 text-sm">Transition and program execution</p></div>
      <div className="glass p-4"><div className="flex justify-between mb-2"><span className="text-sm text-white">Transition Progress</span><span className="text-sm text-cyan-400">{progress}%</span></div><div className="h-3 bg-slate-700 rounded-full"><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full transition-all" style={{width:`${progress}%`}}/></div></div>
      <div className="glass p-4"><h3 className="font-semibold text-white mb-3">Transition Checklist</h3><div className="space-y-2">{checklist.map(c=><div key={c.id} className="flex items-center gap-3 p-2 bg-slate-800/50 rounded"><div className={`w-5 h-5 rounded flex items-center justify-center ${c.done?'bg-emerald-500':'bg-slate-700'}`}>{c.done&&<Icon name="check" className="w-3 h-3 text-white"/>}</div><span className={`text-sm ${c.done?'text-slate-400 line-through':'text-white'}`}>{c.task}</span></div>)}</div></div>
    </div>
  );
}

// ============================================================
// MODULE: PLAYBOOK
// ============================================================
function ModulePlaybook(){
  const{data:lessons}=useData(()=>MissionPulse?.getPlaybookLessons(),DEMO_PLAYBOOK);
  const[selected,setSelected]=useState(null);
  const categories=[...new Set(lessons.map(l=>l.category))];

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">‚≠ê Lessons Playbook</h2><p className="text-slate-400 text-sm">Golden examples and templates</p></div>
      <div className="flex gap-2">{categories.map(c=><span key={c} className="px-3 py-1 bg-slate-800 text-slate-300 rounded text-sm">{c} ({lessons.filter(l=>l.category===c).length})</span>)}</div>
      <div className="grid grid-cols-3 gap-4">
        <div className="space-y-2">{lessons.map(l=><button key={l.id} onClick={()=>setSelected(l)} className={`w-full text-left p-3 rounded-lg transition ${selected?.id===l.id?'bg-cyan-500/20 border border-cyan-500/30':'glass hover:bg-slate-700/50'}`}><div className="font-medium text-white text-sm">{l.title}</div><div className="flex justify-between text-xs mt-1"><span className="text-slate-400">{l.category}</span><span className="text-cyan-400">‚≠ê {l.score}</span></div></button>)}</div>
        <div className="col-span-2 glass p-6">{selected?(<><h3 className="text-xl font-bold text-white mb-2">{selected.title}</h3><div className="flex gap-4 mb-4"><span className="text-sm text-slate-400">{selected.category}</span><span className="text-sm text-cyan-400">Quality: {selected.score}%</span><span className="text-sm text-emerald-400">Used: {selected.uses}x</span></div><div className="p-4 bg-slate-800/50 rounded-lg text-sm text-slate-300">{selected.content}</div><div className="flex gap-2 mt-4"><button className="px-3 py-1 bg-cyan-500 text-white rounded text-sm">Use Template</button><button className="px-3 py-1 bg-slate-700 text-white rounded text-sm">Copy</button></div></>):<div className="text-center text-slate-500">Select a lesson to view</div>}</div>
      </div>
    </div>
  );
}

// ============================================================
// MODULE: ADMIN
// ============================================================
function ModuleAdmin(){
  const[tokenUsage]=useState({used:45230,limit:100000,cost:2.26});

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">‚öôÔ∏è Admin Panel</h2><p className="text-slate-400 text-sm">System settings and usage</p></div>
      <div className="grid grid-cols-3 gap-4">
        <div className="glass p-4"><p className="text-slate-400 text-xs">Tokens Used</p><p className="text-2xl font-bold text-cyan-400">{tokenUsage.used.toLocaleString()}</p><div className="h-2 bg-slate-700 rounded-full mt-2"><div className="h-full bg-cyan-500 rounded-full" style={{width:`${tokenUsage.used/tokenUsage.limit*100}%`}}/></div></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Token Limit</p><p className="text-2xl font-bold text-slate-300">{tokenUsage.limit.toLocaleString()}</p></div>
        <div className="glass p-4"><p className="text-slate-400 text-xs">Est. Cost</p><p className="text-2xl font-bold text-emerald-400">${tokenUsage.cost.toFixed(2)}</p></div>
      </div>
      <div className="glass p-4"><h3 className="font-semibold text-white mb-3">Quick Settings</h3><div className="space-y-3">{['Enable AI Streaming','Auto-save drafts','Email notifications'].map((s,i)=><div key={i} className="flex justify-between items-center"><span className="text-sm text-slate-300">{s}</span><div className={`w-10 h-5 rounded-full ${i<2?'bg-cyan-500':'bg-slate-700'} relative cursor-pointer`}><div className={`absolute w-4 h-4 bg-white rounded-full top-0.5 transition ${i<2?'right-0.5':'left-0.5'}`}/></div></div>)}</div></div>
    </div>
  );
}

// ============================================================
// MODULE: TRAINING HUB
// ============================================================
function ModuleTraining(){
  const courses=[{id:'1',title:'Shipley Fundamentals',progress:100,duration:'2h'},{id:'2',title:'Win Theme Development',progress:75,duration:'1.5h'},{id:'3',title:'Pricing Strategies',progress:30,duration:'2h'},{id:'4',title:'Orals Presentation',progress:0,duration:'1h'}];

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üéì Training Hub</h2><p className="text-slate-400 text-sm">Learning resources and tutorials</p></div>
      <div className="grid grid-cols-2 gap-4">{courses.map(c=><div key={c.id} className="glass p-4 hover-lift"><div className="flex justify-between items-start mb-3"><h3 className="font-medium text-white">{c.title}</h3><span className="text-xs text-slate-400">{c.duration}</span></div><div className="flex justify-between mb-1"><span className="text-xs text-slate-400">Progress</span><span className="text-xs text-cyan-400">{c.progress}%</span></div><div className="h-2 bg-slate-700 rounded-full"><div className={`h-full rounded-full ${c.progress===100?'bg-emerald-500':'bg-cyan-500'}`} style={{width:`${c.progress}%`}}/></div><button className="mt-3 w-full py-2 bg-slate-800 text-white rounded text-sm hover:bg-slate-700">{c.progress===100?'Review':'Continue'}</button></div>)}</div>
    </div>
  );
}

// ============================================================
// MODULE: AUDIT LOG
// ============================================================
function ModuleAudit(){
  const{data:logs}=useData(()=>MissionPulse?.getActivityLog(),DEMO_AUDIT);
  const actionColors={LOGIN:'bg-emerald-500/20 text-emerald-400',VIEW_BLACKHAT:'bg-amber-500/20 text-amber-400',EXPORT_PRICING:'bg-red-500/20 text-red-400',APPROVE_SECTION:'bg-cyan-500/20 text-cyan-400',GENERATE_CONTENT:'bg-purple-500/20 text-purple-400'};

  return(
    <div className="space-y-4 animate-fadeIn">
      <div><h2 className="text-xl font-bold text-white">üìú Audit Log</h2><p className="text-slate-400 text-sm">Activity tracking and compliance</p></div>
      <div className="glass overflow-hidden">
        <table className="w-full"><thead className="bg-slate-800/50"><tr>{['Timestamp','Action','User','Role'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold text-slate-400 uppercase">{h}</th>)}</tr></thead>
          <tbody className="divide-y divide-slate-700/50">{logs.map(l=>(<tr key={l.id} className="hover:bg-slate-800/30"><td className="p-3 text-sm text-slate-400 font-mono">{new Date(l.ts).toLocaleString()}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${actionColors[l.action]||'bg-slate-500/20 text-slate-400'}`}>{l.action}</span></td><td className="p-3 text-sm text-white">{l.user}</td><td className="p-3 text-sm text-slate-400">{l.role}</td></tr>))}</tbody>
        </table>
      </div>
    </div>
  );
}

// ============================================================
// AI CHAT WIDGET
// ============================================================
function AIChatWidget({aiStatus}){
  const[open,setOpen]=useState(false);
  const[messages,setMessages]=useState([{role:'assistant',content:'Hello! I\'m your MissionPulse AI assistant. How can I help?'}]);
  const[input,setInput]=useState('');
  const[loading,setLoading]=useState(false);
  const send=async()=>{if(!input.trim()||loading)return;setMessages(m=>[...m,{role:'user',content:input}]);const msg=input;setInput('');setLoading(true);const r=await AIService.chat('assistant',msg,{});setMessages(m=>[...m,{role:'assistant',content:r.response}]);setLoading(false)};
  if(!open)return<button onClick={()=>setOpen(true)} className="fixed bottom-10 right-4 w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition z-50">ü§ñ</button>;
  return(<div className="fixed bottom-10 right-4 w-96 h-[500px] glass shadow-2xl flex flex-col z-50 animate-fadeIn"><div className="p-3 border-b border-slate-700/50 flex justify-between items-center"><div className="flex items-center gap-2"><span className="font-semibold text-white">ü§ñ AI Assistant</span><span className={`text-xs px-1.5 py-0.5 rounded ${aiStatus==='connected'?'bg-emerald-500/20 text-emerald-400':'bg-purple-500/20 text-purple-400'}`}>{aiStatus==='connected'?'Live':'Mock'}</span></div><button onClick={()=>setOpen(false)} className="p-1 text-slate-400 hover:text-white"><Icon name="x"/></button></div><div className="flex-1 overflow-y-auto p-3 space-y-3">{messages.map((m,i)=><div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-xl text-sm ${m.role==='user'?'bg-cyan-500 text-white':'bg-slate-700 text-slate-200'}`}><div className="whitespace-pre-wrap">{m.content}</div></div></div>)}{loading&&<div className="flex justify-start"><div className="bg-slate-700 p-3 rounded-xl"><div className="flex gap-1">{[0,1,2].map(i=><div key={i} className="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style={{animationDelay:`${i*0.2}s`}}/>)}</div></div></div>}</div><div className="p-3 border-t border-slate-700/50 flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder="Ask anything..." className="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-cyan-500"/><button onClick={send} disabled={!input.trim()||loading} className="p-2 bg-cyan-500 rounded-lg text-white disabled:opacity-50"><Icon name="send"/></button></div></div>);
}

// ============================================================
// SIDEBAR
// ============================================================
function Sidebar({role,setRole,active,setActive,user,dbStatus,aiStatus}){
  const[collapsed,setCollapsed]=useState(false);
  const[showRoles,setShowRoles]=useState(false);
  const currentRole=ROLES.find(r=>r.id===role)||ROLES[0];
  const accessible=MODULES.filter(m=>currentRole.access.includes(m.id));
  return(<aside className={`h-screen bg-slate-900/95 border-r border-slate-800 flex flex-col transition-all ${collapsed?'w-16':'w-64'}`}><div className="p-4 border-b border-slate-800 flex items-center justify-between">{!collapsed&&<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div><div className="text-sm font-bold text-white">MissionPulse</div><div className="text-[10px] text-slate-500">v12</div></div></div>}<button onClick={()=>setCollapsed(!collapsed)} className="p-1 text-slate-400 hover:text-white"><Icon name={collapsed?'chevronRight':'chevronLeft'} className="w-4 h-4"/></button></div>{!collapsed&&<div className="p-3 border-b border-slate-800"><button onClick={()=>setShowRoles(!showRoles)} className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-slate-800"><span className="text-xl">{currentRole.icon}</span><div className="flex-1 text-left"><div className="text-sm font-medium text-white">{currentRole.fullName}</div><div className="text-xs text-slate-400">{currentRole.name}</div></div><Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition ${showRoles?'rotate-180':''}`}/></button>{showRoles&&<div className="mt-2 p-2 bg-slate-800/50 rounded-lg max-h-48 overflow-y-auto">{ROLES.map(r=><button key={r.id} onClick={()=>{setRole(r.id);setShowRoles(false)}} className={`w-full flex items-center gap-2 p-2 rounded hover:bg-slate-700 ${role===r.id?'bg-cyan-500/20':''}`}><span>{r.icon}</span><span className="text-sm text-white">{r.name}</span></button>)}</div>}</div>}<nav className="flex-1 overflow-y-auto p-2">{['Command','Strategy','Intel','Delivery','Admin'].map(cat=>{const mods=accessible.filter(m=>m.cat===cat);if(!mods.length)return null;return(<div key={cat} className="mb-3">{!collapsed&&<div className="text-[10px] uppercase text-slate-500 font-semibold px-2 mb-1">{cat}</div>}{mods.map(m=><button key={m.id} onClick={()=>setActive(m)} className={`w-full flex items-center gap-2 p-2 rounded-lg mb-0.5 transition ${active?.id===m.id?'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30':'text-slate-400 hover:bg-slate-800 hover:text-white'}`} title={collapsed?m.name:''}><span>{m.icon}</span>{!collapsed&&<><span className="flex-1 text-left text-sm">{m.name}</span>{m.badge&&<span className={`px-1 py-0.5 text-[9px] font-bold rounded ${m.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</>}</button>)}</div>)})}</nav>{!collapsed&&<div className="p-3 border-t border-slate-800"><StatusBar dbStatus={dbStatus} aiStatus={aiStatus}/>{user&&<div className="flex items-center justify-between mt-3"><div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white text-xs font-bold">{user.name?.[0]||'U'}</div><div className="text-xs text-white truncate max-w-[100px]">{user.name||user.email}</div></div><button onClick={handleLogout} className="p-1.5 rounded hover:bg-red-500/20 text-slate-400 hover:text-red-400" title="Logout"><Icon name="logout" className="w-4 h-4"/></button></div>}</div>}</aside>);
}

// ============================================================
// MAIN APP
// ============================================================
function App(){
  const[user,setUser]=useState(null);
  const[role,setRole]=useState('CEO');
  const[active,setActive]=useState(null);
  const[dbStatus,setDbStatus]=useState('checking');
  const[aiStatus,setAiStatus]=useState('checking');

  useEffect(()=>{
    const u=checkAuth();if(u){setUser(u);if(u.role)setRole(u.role)}
    if(typeof MissionPulse!=='undefined'){MissionPulse.getOpportunities().then(r=>setDbStatus(r.error?'offline':'connected')).catch(()=>setDbStatus('offline'))}else{setDbStatus('offline')}
    AIService.checkConnection().then(s=>setAiStatus(s));
  },[]);

  const renderModule=()=>{
    if(!active)return<div className="flex-1 flex items-center justify-center"><div className="text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><h2 className="text-xl font-bold text-white mb-2">Welcome to MissionPulse</h2><p className="text-slate-400">Select a module to begin</p></div></div>;
    switch(active.id){
      case 'dashboard':return<ModuleDashboard dbStatus={dbStatus}/>;
      case 'pipeline':return<ModulePipeline/>;
      case 'warroom':return<ModuleWarRoom/>;
      case 'swimlane':return<ModuleSwimlane/>;
      case 'compliance':return<ModuleCompliance/>;
      case 'contracts':return<ModuleContracts/>;
      case 'writer':return<ModuleWriter aiStatus={aiStatus}/>;
      case 'blackhat':return<ModuleBlackHat aiStatus={aiStatus}/>;
      case 'pricing':return<ModulePricing/>;
      case 'hitl':return<ModuleHITL/>;
      case 'orals':return<ModuleOrals aiStatus={aiStatus}/>;
      case 'frenemy':return<ModuleFrenemy/>;
      case 'launch':return<ModuleLaunch/>;
      case 'post_award':return<ModulePostAward/>;
      case 'playbook':return<ModulePlaybook/>;
      case 'admin':return<ModuleAdmin/>;
      case 'training':return<ModuleTraining/>;
      case 'audit':return<ModuleAudit/>;
      default:return<div className="glass p-12 text-center"><div className="text-6xl mb-4">{active.icon}</div><h2 className="text-xl font-bold text-white">{active.name}</h2></div>;
    }
  };

  if(!user)return<div className="h-screen flex items-center justify-center bg-[#00050F]"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;
  return(<div className="h-screen flex bg-[#00050F] overflow-hidden"><Sidebar role={role} setRole={setRole} active={active} setActive={setActive} user={user} dbStatus={dbStatus} aiStatus={aiStatus}/><div className="flex-1 flex flex-col overflow-hidden">{active&&<header className="bg-slate-900/90 border-b border-slate-800 px-6 py-3"><div className="flex items-center gap-3"><span className="text-xl">{active.icon}</span><h1 className="font-semibold text-white">{active.name}</h1>{active.badge&&<span className={`px-2 py-0.5 rounded text-xs font-bold ${active.badge==='PRIVATE'?'bg-amber-500/20 text-amber-400':active.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{active.badge}</span>}</div></header>}<main className="flex-1 overflow-y-auto p-6">{renderModule()}</main></div><div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/95 border-t border-slate-800 flex items-center justify-center z-40"><span className="text-[10px] text-slate-500">AI GENERATED - REQUIRES HUMAN REVIEW ‚Ä¢ MissionPulse v12 ‚Ä¢ ¬© 2026 Mission Meets Tech</span></div><AIChatWidget aiStatus={aiStatus}/></div>);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
