<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MissionPulse | AI-Powered Proposal Command Center</title>
    <meta name="description" content="Enterprise proposal management platform with AI agents, Shipley methodology, and 11-role RBAC">
    <meta name="author" content="Mission Meets Tech">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/maryadawson-code/missionpulse-frontend/main/MMT_icon_32px.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');
      
      :root { --mmt-cyan: #00E5FA; --mmt-navy: #00050F; --mmt-slate: #1e293b; --mmt-text: #e2e8f0; }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--mmt-navy); color: var(--mmt-text); min-height: 100vh; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #0a1628; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(0, 229, 250, 0.15); border-radius: 16px; }
      .glass-panel-light { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(8px); border: 1px solid rgba(0, 229, 250, 0.1); border-radius: 12px; }
      
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
      @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 229, 250, 0.3); } 50% { box-shadow: 0 0 40px rgba(0, 229, 250, 0.6); } }
      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      
      .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
      .animate-slideIn { animation: slideIn 0.3s ease-out; }
      .animate-slideUp { animation: slideUp 0.6s ease-out; }
      .animate-pulse { animation: pulse 2s infinite; }
      .animate-glow { animation: glow 3s infinite; }
      .animate-float { animation: float 6s ease-in-out infinite; }
      
      .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
      .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
      .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 12px 30px -8px rgba(0, 229, 250, 0.2); }
      .typing-dot { animation: pulse 1.4s infinite; }
      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }
      
      .gradient-text { background: linear-gradient(135deg, #00E5FA 0%, #8B5CF6 50%, #EC4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
      .gradient-border { position: relative; }
      .gradient-border::before { content: ''; position: absolute; inset: -2px; background: linear-gradient(135deg, #00E5FA, #8B5CF6, #EC4899); border-radius: inherit; z-index: -1; opacity: 0.5; }
      
      .tooltip { position: relative; }
      .tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); padding: 6px 12px; background: #1e293b; border: 1px solid #334155; border-radius: 8px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; z-index: 100; }
      .tooltip:hover::after { opacity: 1; transform: translateX(-50%) translateY(-8px); }
      
      @media print { .no-print { display: none !important; } body { background: white !important; color: black !important; } }
    </style>
  <script src="rbac-guard.js"></script>
</head>
<body class="overflow-hidden">
    <div id="root"></div>
    
    <script type="text/babel">
// ============================================================
// MISSIONPULSE v12 - SPRINT 13: POLISH & DEMO
// Final MVP | Client-Ready | Demo Mode
// © 2026 Mission Meets Tech
// ============================================================

const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

// ============================================================
// CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzQ2NDMsImV4cCI6MjA1MzUxMDY0M30.Yx8OZQH5Fxx5Ts9DmNoO0aPWF_fFQmQJWSFIohHcA';
const API_BASE_URL = 'https://missionpulse-api.onrender.com';
const APP_VERSION = '12.0.0';

const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_KEY);

// Demo data fallback
const DEMO_OPPORTUNITIES = [
  { id: 1, title: 'DHA EHR Modernization', nickname: 'Project Aurora', agency: 'DHA', ceiling: 125000000, win_probability: 72, shipley_phase: 'Phase 2', priority: 'High', description: 'Electronic Health Record modernization for Military Health System' },
  { id: 2, title: 'VA Claims Processing AI', nickname: 'ClaimsBot', agency: 'VA', ceiling: 89000000, win_probability: 65, shipley_phase: 'Phase 1', priority: 'High', description: 'AI-powered claims adjudication system' },
  { id: 3, title: 'CMS Data Analytics Platform', nickname: 'MediInsight', agency: 'CMS', ceiling: 156000000, win_probability: 58, shipley_phase: 'Phase 3', priority: 'Medium', description: 'Healthcare data analytics and reporting platform' },
  { id: 4, title: 'IHS Telehealth Expansion', nickname: 'TeleHealth+', agency: 'IHS', ceiling: 67000000, win_probability: 81, shipley_phase: 'Phase 2', priority: 'High', description: 'Rural telehealth infrastructure deployment' },
  { id: 5, title: 'FDA Drug Safety Monitoring', nickname: 'SafeRx', agency: 'FDA', ceiling: 94000000, win_probability: 45, shipley_phase: 'Phase 0', priority: 'Medium', description: 'Real-time adverse event detection system' },
  { id: 6, title: 'NIH Grant Management System', nickname: 'GrantFlow', agency: 'NIH', ceiling: 78000000, win_probability: 70, shipley_phase: 'Phase 1', priority: 'Medium', description: 'End-to-end grant lifecycle management' },
  { id: 7, title: 'CDC Outbreak Response Platform', nickname: 'EpiWatch', agency: 'CDC', ceiling: 112000000, win_probability: 62, shipley_phase: 'Phase 2', priority: 'Critical', description: 'Disease surveillance and response coordination' },
  { id: 8, title: 'SAMHSA Treatment Locator', nickname: 'FindHelp', agency: 'SAMHSA', ceiling: 34000000, win_probability: 78, shipley_phase: 'Phase 3', priority: 'Medium', description: 'Substance abuse treatment facility directory' }
];

// ============================================================
// EXPORT UTILITIES
// ============================================================
const ExportUtils = {
  toCSV: (data, columns) => {
    if (!data || data.length === 0) return '';
    const headers = columns.map(c => c.label).join(',');
    const rows = data.map(row => columns.map(c => {
      let val = row[c.key] ?? '';
      if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) val = `"${val.replace(/"/g, '""')}"`;
      return val;
    }).join(',')).join('\n');
    return `${headers}\n${rows}`;
  },
  downloadCSV: (data, columns, filename) => {
    const csv = ExportUtils.toCSV(data, columns);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  },
  formatCurrency: (val) => {
    if (!val) return '$0';
    const num = typeof val === 'string' ? parseFloat(val) : val;
    if (num >= 1e9) return `$${(num/1e9).toFixed(1)}B`;
    if (num >= 1e6) return `$${(num/1e6).toFixed(1)}M`;
    if (num >= 1e3) return `$${(num/1e3).toFixed(0)}K`;
    return `$${num.toFixed(0)}`;
  },
  formatDate: (date) => date ? new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'
};

// ============================================================
// 8 AI AGENTS
// ============================================================
const AI_AGENTS = [
  { id: 'capture', name: 'Capture Intelligence', description: '12-factor win probability', icon: 'target', color: '#00E5FA', isRestricted: false, examplePrompts: ["What's our win probability?", "Go/No-Go recommendation?"] },
  { id: 'strategy', name: 'Strategy Advisor', description: 'Win themes & discriminators', icon: 'activity', color: '#8B5CF6', isRestricted: true, examplePrompts: ["Generate win themes", "Key discriminators?"] },
  { id: 'compliance', name: 'Compliance Guardian', description: 'FAR/DFARS validation', icon: 'shield', color: '#10B981', isRestricted: false, examplePrompts: ["Check compliance gaps", "Extract requirements"] },
  { id: 'writer', name: 'Proposal Writer', description: 'Shipley-compliant drafting', icon: 'penTool', color: '#3B82F6', isRestricted: false, examplePrompts: ["Draft technical approach", "Improve this section"] },
  { id: 'pricing', name: 'Pricing Analyst', description: 'BOE & price-to-win', icon: 'calculator', color: '#F59E0B', isRestricted: true, examplePrompts: ["Generate BOE", "Price-to-win analysis"] },
  { id: 'blackhat', name: 'Competitive Intel', description: 'Ghost team simulation', icon: 'ghost', color: '#EF4444', isRestricted: true, examplePrompts: ["Black hat review", "Competitor strategy?"] },
  { id: 'contracts', name: 'Contracts Advisor', description: 'Clause analysis & T&C', icon: 'scale', color: '#6366F1', isRestricted: false, examplePrompts: ["Review Section H", "Flag risky clauses"] },
  { id: 'orals', name: 'Orals Coach', description: 'Q&A simulation', icon: 'mic', color: '#EC4899', isRestricted: false, examplePrompts: ["Simulate tough questions", "Coach presentation"] }
];

// ============================================================
// CONTEXTS
// ============================================================
const AppContext = createContext(null);

// ============================================================
// 11 SHIPLEY ROLES
// ============================================================
const ROLES = [
  { id: 'CEO', name: 'CEO', fullName: 'Mary Womack', icon: 'crown', color: '#fbbf24', bgColor: 'rgba(251, 191, 36, 0.15)', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'launch_roi', 'orals', 'frenemy', 'post_award'], agentAccess: ['capture', 'compliance', 'writer', 'contracts', 'orals'], canExport: true },
  { id: 'COO', name: 'COO', fullName: 'David Chen', icon: 'briefcase', color: '#f97316', bgColor: 'rgba(249, 115, 22, 0.15)', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'hitl', 'frenemy', 'launch_roi', 'post_award', 'pricing'], agentAccess: ['capture', 'strategy', 'compliance', 'writer', 'pricing', 'contracts', 'orals'], canExport: true },
  { id: 'CAP', name: 'Capture Mgr', fullName: 'Michael Torres', icon: 'target', color: '#f472b6', bgColor: 'rgba(244, 114, 182, 0.15)', access: ['dashboard', 'pipeline', 'blackhat', 'strategy', 'warroom', 'frenemy', 'swarm'], agentAccess: ['capture', 'strategy', 'blackhat', 'compliance', 'writer', 'contracts'], canExport: true },
  { id: 'PM', name: 'Proposal Mgr', fullName: 'Lisa Martinez', icon: 'clipboard', color: '#60a5fa', bgColor: 'rgba(96, 165, 250, 0.15)', access: ['dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'writer', 'hitl', 'launch_roi', 'post_award', 'orals'], agentAccess: ['capture', 'compliance', 'writer', 'contracts', 'orals'], canExport: true },
  { id: 'SA', name: 'Solution Arch', fullName: 'Sarah Chen', icon: 'cpu', color: '#22d3ee', bgColor: 'rgba(34, 211, 238, 0.15)', access: ['writer', 'compliance', 'contracts', 'orals', 'swarm'], agentAccess: ['compliance', 'writer', 'contracts', 'orals'], canExport: false },
  { id: 'FIN', name: 'Pricing Lead', fullName: 'Jennifer Park', icon: 'dollarSign', color: '#34d399', bgColor: 'rgba(52, 211, 153, 0.15)', access: ['pricing', 'contracts', 'launch_roi', 'swarm'], agentAccess: ['pricing', 'contracts'], canExport: true },
  { id: 'CON', name: 'Compliance', fullName: 'Robert Williams', icon: 'scale', color: '#a78bfa', bgColor: 'rgba(167, 139, 250, 0.15)', access: ['compliance', 'contracts', 'swarm', 'hitl'], agentAccess: ['compliance', 'contracts'], canExport: false },
  { id: 'DEL', name: 'Delivery Lead', fullName: 'Amanda Foster', icon: 'users', color: '#fb7185', bgColor: 'rgba(251, 113, 133, 0.15)', access: ['swarm', 'writer', 'post_award', 'orals'], agentAccess: ['writer', 'orals'], canExport: false },
  { id: 'QA', name: 'QA Lead', fullName: 'James Thompson', icon: 'checkCircle', color: '#2dd4bf', bgColor: 'rgba(45, 212, 191, 0.15)', access: ['hitl', 'compliance', 'swarm', 'writer'], agentAccess: ['compliance', 'writer'], canExport: false },
  { id: 'Partner', name: 'Partner', fullName: 'External Partner', icon: 'handshake', color: '#94a3b8', bgColor: 'rgba(148, 163, 184, 0.15)', access: ['swarm', 'writer'], agentAccess: ['writer'], canExport: false, isExternal: true },
  { id: 'Admin', name: 'Admin', fullName: 'System Admin', icon: 'settings', color: '#cbd5e1', bgColor: 'rgba(203, 213, 225, 0.15)', access: ['admin', 'audit', 'dashboard', 'pipeline', 'warroom', 'swarm', 'compliance', 'contracts', 'writer', 'blackhat', 'pricing', 'hitl', 'orals', 'frenemy', 'launch_roi', 'post_award'], agentAccess: ['capture', 'strategy', 'compliance', 'writer', 'pricing', 'blackhat', 'contracts', 'orals'], canExport: true }
];

// ============================================================
// MODULES
// ============================================================
const MODULES = [
  { id: 'dashboard', name: 'Mission Control', icon: 'activity', color: '#facc15', category: 'Command', description: 'Executive dashboard with pipeline metrics' },
  { id: 'pipeline', name: 'Pipeline Intel', icon: 'filter', color: '#60a5fa', category: 'Strategy', description: 'Opportunity tracking and qualification' },
  { id: 'warroom', name: 'War Room', icon: 'swords', color: '#818cf8', category: 'Strategy', description: 'Capture strategy development' },
  { id: 'swarm', name: 'Swimlane Board', icon: 'kanban', color: '#2dd4bf', category: 'Strategy', description: 'Shipley phase task management' },
  { id: 'compliance', name: 'RFP Shredder', icon: 'fileCheck', color: '#f87171', category: 'Intelligence', description: 'Requirement extraction and analysis' },
  { id: 'contracts', name: 'Contract Scanner', icon: 'scale', color: '#a78bfa', category: 'Intelligence', description: 'Clause analysis and risk flagging' },
  { id: 'writer', name: 'Iron Dome', icon: 'penTool', color: '#c084fc', category: 'Intelligence', description: 'AI-assisted proposal drafting' },
  { id: 'blackhat', name: 'Black Hat', icon: 'ghost', color: '#fbbf24', category: 'Intelligence', badge: 'PRIVATE', description: 'Competitive intelligence hub' },
  { id: 'pricing', name: 'Pricing Engine', icon: 'calculator', color: '#4ade80', category: 'Delivery', badge: 'CUI', description: 'BOE and price-to-win modeling' },
  { id: 'hitl', name: 'HITL Gauntlet', icon: 'eye', color: '#fb923c', category: 'Delivery', description: 'Human-in-the-loop review workflow' },
  { id: 'orals', name: 'Orals Studio', icon: 'mic', color: '#f472b6', category: 'Delivery', description: 'Presentation prep and Q&A simulation' },
  { id: 'frenemy', name: 'Frenemy Protocol', icon: 'shield', color: '#22d3ee', category: 'Delivery', description: 'Teaming partner management' },
  { id: 'launch_roi', name: 'Launch & ROI', icon: 'rocket', color: '#e879f9', category: 'Command', description: 'Submission tracking and ROI analysis' },
  { id: 'post_award', name: 'Post-Award', icon: 'archive', color: '#a78bfa', category: 'Command', description: 'Transition and lessons learned' },
  { id: 'admin', name: 'Export Center', icon: 'download', color: '#cbd5e1', category: 'Admin', description: 'Data exports and report generation' },
  { id: 'audit', name: 'Audit Log', icon: 'list', color: '#64748b', category: 'Admin', badge: 'ADMIN', description: 'System activity tracking' }
];

const MODULE_CATEGORIES = [
  { id: 'Command', name: 'Command Center', icon: 'activity' },
  { id: 'Strategy', name: 'Strategy Phase', icon: 'target' },
  { id: 'Intelligence', name: 'Intelligence Phase', icon: 'eye' },
  { id: 'Delivery', name: 'Delivery Phase', icon: 'rocket' },
  { id: 'Admin', name: 'Administration', icon: 'settings' }
];

// ============================================================
// ICONS
// ============================================================
const Icon = ({ name, className = 'w-5 h-5', style }) => {
  const icons = {
    crown: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3l3.5 7L12 6l3.5 4L19 3m-14 8v8h14v-8M5 15h14" /></svg>,
    briefcase: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
    target: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
    clipboard: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>,
    cpu: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>,
    dollarSign: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    scale: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>,
    users: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
    checkCircle: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    handshake: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    settings: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    filter: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
    swords: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 6l6 6m0 0l6-6m-6 6v12M4 4l16 16M20 4L4 20" /></svg>,
    kanban: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>,
    fileCheck: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    penTool: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>,
    ghost: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    calculator: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
    eye: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
    mic: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>,
    shield: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
    activity: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
    rocket: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
    archive: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
    list: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>,
    download: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
    chevronDown: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
    chevronRight: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
    chevronLeft: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>,
    x: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
    logOut: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
    messageSquare: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
    send: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
    sparkles: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
    check: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
    info: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    zap: <svg className={className} style={style} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
  };
  return icons[name] || <span className={className}>?</span>;
};

// ============================================================
// UI COMPONENTS
// ============================================================
const Card = ({ children, className = '', glow }) => (
  <div className={`glass-panel p-5 hover-lift ${glow ? 'animate-glow' : ''} ${className}`}>{children}</div>
);

const Badge = ({ children, color = '#00E5FA', size = 'md' }) => {
  const sizes = { sm: 'px-1.5 py-0.5 text-[10px]', md: 'px-2 py-0.5 text-xs', lg: 'px-3 py-1 text-sm' };
  return <span className={`inline-flex items-center font-semibold rounded-full ${sizes[size]}`} style={{ backgroundColor: `${color}20`, color, border: `1px solid ${color}40` }}>{children}</span>;
};

const Button = ({ children, variant = 'default', size = 'md', icon, onClick, disabled, className = '' }) => {
  const variants = {
    default: 'bg-slate-700/80 hover:bg-slate-600 text-white border-slate-600',
    primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-400 hover:to-teal-400 text-white border-transparent shadow-lg shadow-cyan-500/20',
    success: 'bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 border-emerald-500/30',
    ghost: 'bg-transparent hover:bg-slate-800/50 text-slate-400 border-transparent'
  };
  const sizes = { sm: 'px-3 py-1.5 text-xs', md: 'px-4 py-2 text-sm', lg: 'px-6 py-3 text-base' };
  return (
    <button onClick={onClick} disabled={disabled} className={`inline-flex items-center gap-2 font-medium rounded-xl border transition-all ${variants[variant]} ${sizes[size]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}>
      {icon && <Icon name={icon} className="w-4 h-4" />}
      {children}
    </button>
  );
};

const Skeleton = ({ className = '' }) => <div className={`skeleton rounded-lg ${className}`}></div>;

// ============================================================
// WELCOME SCREEN
// ============================================================
const WelcomeScreen = ({ currentRole, onSelectModule, accessibleModules }) => {
  const quickActions = [
    { module: 'dashboard', label: 'View Dashboard', icon: 'activity', color: '#facc15' },
    { module: 'pipeline', label: 'Check Pipeline', icon: 'filter', color: '#60a5fa' },
    { module: 'swarm', label: 'Task Board', icon: 'kanban', color: '#2dd4bf' }
  ].filter(a => accessibleModules.find(m => m.id === a.module));

  return (
    <div className="h-full flex items-center justify-center p-8 animate-fadeIn">
      <div className="max-w-2xl text-center">
        <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center animate-float">
          <Icon name="zap" className="w-10 h-10 text-white" />
        </div>
        
        <h1 className="text-4xl font-bold mb-3">
          <span className="gradient-text">Welcome back, {currentRole.fullName.split(' ')[0]}</span>
        </h1>
        
        <p className="text-slate-400 text-lg mb-8">
          You have access to <span className="text-cyan-400 font-semibold">{accessibleModules.length} modules</span> and{' '}
          <span className="text-purple-400 font-semibold">{currentRole.agentAccess?.length || 0} AI agents</span>
        </p>
        
        <div className="flex flex-wrap justify-center gap-3 mb-8">
          {quickActions.map(action => (
            <button key={action.module} onClick={() => onSelectModule(MODULES.find(m => m.id === action.module))}
              className="flex items-center gap-3 px-5 py-3 rounded-xl bg-slate-800/50 border border-slate-700 hover:border-cyan-500/50 hover:bg-slate-800 transition-all group">
              <div className="w-10 h-10 rounded-lg flex items-center justify-center transition-transform group-hover:scale-110" style={{ backgroundColor: `${action.color}20` }}>
                <Icon name={action.icon} className="w-5 h-5" style={{ color: action.color }} />
              </div>
              <span className="font-medium text-white">{action.label}</span>
            </button>
          ))}
        </div>
        
        <div className="flex items-center justify-center gap-6 text-sm text-slate-500">
          <div className="flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            <span>All systems operational</span>
          </div>
          <div className="flex items-center gap-2">
            <Icon name="sparkles" className="w-4 h-4 text-cyan-400" />
            <span>AI agents ready</span>
          </div>
        </div>
      </div>
    </div>
  );
};

// ============================================================
// DASHBOARD MODULE
// ============================================================
const DashboardModule = ({ opportunities, currentRole }) => {
  const stats = useMemo(() => {
    const totalValue = opportunities.reduce((sum, o) => sum + (parseFloat(o.ceiling) || 0), 0);
    const avgWin = opportunities.length > 0 ? opportunities.reduce((sum, o) => sum + (o.win_probability || 0), 0) / opportunities.length : 0;
    const phases = [...new Set(opportunities.map(o => o.shipley_phase).filter(Boolean))];
    const highPriority = opportunities.filter(o => o.priority === 'High' || o.priority === 'Critical').length;
    return { count: opportunities.length, totalValue, avgWin: avgWin.toFixed(0), phases: phases.length, highPriority };
  }, [opportunities]);

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex items-center justify-between mb-2">
        <div>
          <h2 className="text-2xl font-bold text-white">Mission Control</h2>
          <p className="text-slate-400">Real-time pipeline intelligence</p>
        </div>
        {currentRole.canExport && (
          <Button variant="default" size="sm" icon="download" onClick={() => ExportUtils.downloadCSV(opportunities, [{key:'title',label:'Title'},{key:'agency',label:'Agency'},{key:'ceiling',label:'Value'},{key:'win_probability',label:'Win%'}], 'pipeline')}>
            Export
          </Button>
        )}
      </div>

      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {[
          { label: 'Active Proposals', value: stats.count, color: '#60a5fa', icon: 'filter' },
          { label: 'Pipeline Value', value: ExportUtils.formatCurrency(stats.totalValue), color: '#10B981', icon: 'dollarSign' },
          { label: 'Avg Win Probability', value: `${stats.avgWin}%`, color: '#00E5FA', icon: 'target' },
          { label: 'High Priority', value: stats.highPriority, color: '#EF4444', icon: 'zap' }
        ].map((stat, i) => (
          <Card key={i}>
            <div className="flex items-start justify-between">
              <div>
                <p className="text-xs text-slate-400 uppercase tracking-wider mb-1">{stat.label}</p>
                <p className="text-3xl font-bold" style={{ color: stat.color }}>{stat.value}</p>
              </div>
              <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: `${stat.color}15` }}>
                <Icon name={stat.icon} className="w-5 h-5" style={{ color: stat.color }} />
              </div>
            </div>
          </Card>
        ))}
      </div>

      <Card>
        <h3 className="font-semibold text-white mb-4 flex items-center gap-2">
          <Icon name="activity" className="w-5 h-5 text-cyan-400" />
          Pipeline Overview
        </h3>
        <div className="space-y-3">
          {opportunities.slice(0, 6).map((opp, idx) => (
            <div key={idx} className="flex items-center justify-between p-3 bg-slate-800/30 rounded-xl hover:bg-slate-800/50 transition-colors">
              <div className="flex items-center gap-4">
                <div className="w-2 h-10 rounded-full" style={{ backgroundColor: opp.win_probability >= 70 ? '#10B981' : opp.win_probability >= 50 ? '#F59E0B' : '#EF4444' }}></div>
                <div>
                  <p className="font-medium text-white">{opp.title || opp.nickname}</p>
                  <p className="text-xs text-slate-400">{opp.agency} • {opp.shipley_phase || 'Phase 0'}</p>
                </div>
              </div>
              <div className="text-right">
                <p className="font-mono text-emerald-400">{ExportUtils.formatCurrency(opp.ceiling)}</p>
                <p className="text-xs text-slate-500">{opp.win_probability}% win</p>
              </div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
};

// ============================================================
// PIPELINE MODULE
// ============================================================
const PipelineModule = ({ opportunities, currentRole }) => {
  const [filter, setFilter] = useState('all');
  
  const filtered = useMemo(() => {
    if (filter === 'all') return opportunities;
    if (filter === 'high') return opportunities.filter(o => o.win_probability >= 70);
    if (filter === 'medium') return opportunities.filter(o => o.win_probability >= 50 && o.win_probability < 70);
    return opportunities.filter(o => o.win_probability < 50);
  }, [opportunities, filter]);

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-white">Pipeline Intelligence</h2>
          <p className="text-slate-400">{opportunities.length} opportunities tracked</p>
        </div>
        <div className="flex items-center gap-2">
          {['all', 'high', 'medium', 'low'].map(f => (
            <button key={f} onClick={() => setFilter(f)} className={`px-3 py-1.5 text-xs font-medium rounded-lg transition-colors ${filter === f ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'text-slate-400 hover:text-white'}`}>
              {f === 'all' ? 'All' : f === 'high' ? '≥70%' : f === 'medium' ? '50-69%' : '<50%'}
            </button>
          ))}
        </div>
      </div>

      <div className="grid gap-4">
        {filtered.map((opp, idx) => (
          <Card key={idx}>
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <h3 className="font-semibold text-white text-lg">{opp.title || opp.nickname}</h3>
                  <Badge color={opp.priority === 'Critical' ? '#EF4444' : opp.priority === 'High' ? '#F59E0B' : '#60a5fa'} size="sm">
                    {opp.priority || 'Medium'}
                  </Badge>
                </div>
                <p className="text-sm text-slate-400 mb-3">{opp.description || 'No description available'}</p>
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-slate-500">{opp.agency}</span>
                  <span className="text-slate-600">•</span>
                  <Badge color="#60a5fa" size="sm">{opp.shipley_phase || 'Phase 0'}</Badge>
                </div>
              </div>
              <div className="text-right ml-6">
                <p className="text-2xl font-bold text-emerald-400">{ExportUtils.formatCurrency(opp.ceiling)}</p>
                <div className="flex items-center justify-end gap-2 mt-2">
                  <div className="w-20 h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div className="h-full rounded-full transition-all" style={{ width: `${opp.win_probability}%`, backgroundColor: opp.win_probability >= 70 ? '#10B981' : opp.win_probability >= 50 ? '#F59E0B' : '#EF4444' }}></div>
                  </div>
                  <span className="text-sm font-semibold" style={{ color: opp.win_probability >= 70 ? '#10B981' : opp.win_probability >= 50 ? '#F59E0B' : '#EF4444' }}>{opp.win_probability}%</span>
                </div>
              </div>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
};

// ============================================================
// EXPORT CENTER
// ============================================================
const ExportCenter = ({ opportunities, currentRole }) => {
  const exports = [
    { id: 'pipeline', name: 'Pipeline Report', icon: 'filter', color: '#60a5fa', columns: [{key:'title',label:'Opportunity'},{key:'agency',label:'Agency'},{key:'ceiling',label:'Value'},{key:'win_probability',label:'Win%'},{key:'shipley_phase',label:'Phase'}], getData: () => opportunities },
    { id: 'compliance', name: 'Compliance Matrix', icon: 'shield', color: '#10B981', columns: [{key:'requirement',label:'Requirement'},{key:'status',label:'Status'},{key:'assignee',label:'Assignee'}], getData: () => [{requirement:'FAR 52.212-1',status:'Complete',assignee:'Lisa'},{requirement:'DFARS 252.204-7012',status:'In Progress',assignee:'Robert'}] },
    { id: 'pricing', name: 'Pricing Summary', icon: 'calculator', color: '#F59E0B', restricted: true, columns: [{key:'category',label:'Category'},{key:'amount',label:'Amount'}], getData: () => [{category:'Labor',amount:'$3.75M'},{category:'ODCs',amount:'$480K'}] }
  ];

  return (
    <div className="p-6 space-y-6 animate-fadeIn">
      <div>
        <h2 className="text-2xl font-bold text-white">Export Center</h2>
        <p className="text-slate-400">Download reports and data exports</p>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {exports.filter(e => !e.restricted || currentRole.canExport).map(exp => (
          <Card key={exp.id}>
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 rounded-xl flex items-center justify-center" style={{ backgroundColor: `${exp.color}20` }}>
                <Icon name={exp.icon} className="w-6 h-6" style={{ color: exp.color }} />
              </div>
              <div>
                <h3 className="font-semibold text-white">{exp.name}</h3>
                <p className="text-xs text-slate-400">{exp.columns.length} columns</p>
              </div>
            </div>
            <Button variant="primary" size="sm" icon="download" onClick={() => ExportUtils.downloadCSV(exp.getData(), exp.columns, `missionpulse_${exp.id}`)} className="w-full">
              Download CSV
            </Button>
          </Card>
        ))}
      </div>
    </div>
  );
};

// ============================================================
// GENERIC MODULE
// ============================================================
const GenericModule = ({ module }) => (
  <div className="p-6 animate-fadeIn">
    <Card>
      <div className="flex items-center gap-4 mb-6">
        <div className="w-14 h-14 rounded-2xl flex items-center justify-center" style={{ backgroundColor: `${module.color}20` }}>
          <Icon name={module.icon} className="w-7 h-7" style={{ color: module.color }} />
        </div>
        <div>
          <h2 className="text-2xl font-bold text-white">{module.name}</h2>
          <p className="text-slate-400">{module.description}</p>
        </div>
      </div>
      <div className="bg-slate-800/30 rounded-xl p-6 border border-slate-700/50">
        <div className="flex items-center gap-3 text-cyan-400">
          <Icon name="sparkles" className="w-5 h-5" />
          <p>Click the AI chat button to get started with this module.</p>
        </div>
      </div>
    </Card>
  </div>
);

// ============================================================
// AI CHAT PANEL
// ============================================================
const AIChatPanel = ({ isOpen, onClose, currentRole }) => {
  const [agent, setAgent] = useState(null);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const ref = useRef(null);

  const agents = useMemo(() => AI_AGENTS.filter(a => currentRole.agentAccess?.includes(a.id)), [currentRole]);
  
  useEffect(() => { ref.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const send = async () => {
    if (!input.trim() || !agent || loading) return;
    setMessages(prev => [...prev, { role: 'user', content: input }]);
    setInput('');
    setLoading(true);
    
    setTimeout(() => {
      const responses = {
        capture: "Based on 12-factor analysis: 68% win probability. Strengths: incumbent knowledge, past performance. Key risks: pricing pressure, staffing timeline. Recommend proceeding with caution.",
        strategy: "Three win themes recommended: 1) Proven Mission Understanding - leverage healthcare IT expertise. 2) Technical Innovation - AI-driven modernization. 3) Cost-Effective Delivery - 15% below IGCE.",
        compliance: "Analyzed RFP requirements: 47 L/M items identified. 12 high-risk compliance areas flagged. Recommend immediate attention to DFARS 252.204-7012 cybersecurity requirements.",
        writer: "I can help draft your technical approach. Would you like me to start with the Understanding section using our healthcare IT experience, or the Solution Overview?",
        pricing: "BOE estimate for 5 FTEs over 3 years: $4.2M total. Wrap rate: 2.8x. This positions us 12% below IGCE - competitive but sustainable margins.",
        blackhat: "Ghost team analysis complete. Incumbent (Leidos) will emphasize: transition advantage, existing clearances, agency relationships. Our counter: highlight innovation debt and modernization expertise.",
        contracts: "Section H analysis: 3 high-risk clauses identified - unlimited liability (H.5), IP assignment (H.12), key personnel restrictions (H.18). Recommend negotiation before award.",
        orals: "Here are 5 tough evaluator questions to prepare for: 1) How will you manage schedule risk? 2) What's your staffing contingency? 3) How do you handle scope creep?"
      };
      setMessages(prev => [...prev, { role: 'assistant', content: responses[agent.id] || "I'm ready to help with your proposal.", agent }]);
      setLoading(false);
    }, 1500);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed right-0 top-0 bottom-6 w-[400px] bg-slate-900/98 border-l border-slate-700/50 flex flex-col z-40 animate-slideIn no-print">
      <div className="p-4 border-b border-slate-700/50 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
            <Icon name="sparkles" className="w-5 h-5 text-white" />
          </div>
          <div>
            <h3 className="font-semibold text-white">AI Assistant</h3>
            <p className="text-xs text-slate-400">{agents.length} agents available</p>
          </div>
        </div>
        <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400"><Icon name="x" className="w-5 h-5" /></button>
      </div>

      {!agent ? (
        <div className="flex-1 overflow-y-auto p-4">
          <p className="text-sm text-slate-400 mb-4">Select an AI agent to get started:</p>
          <div className="space-y-2">
            {agents.map(a => (
              <button key={a.id} onClick={() => { setAgent(a); setMessages([{ role: 'assistant', content: `Hi! I'm the ${a.name}. ${a.description}. Try asking: "${a.examplePrompts[0]}"`, agent: a }]); }}
                className="w-full p-4 rounded-xl border border-slate-700 hover:border-cyan-500/50 hover:bg-slate-800/50 transition-all text-left group">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-xl flex items-center justify-center transition-transform group-hover:scale-105" style={{ backgroundColor: `${a.color}20` }}>
                    <Icon name={a.icon} className="w-6 h-6" style={{ color: a.color }} />
                  </div>
                  <div>
                    <p className="font-semibold text-white">{a.name}</p>
                    <p className="text-xs text-slate-400">{a.description}</p>
                  </div>
                </div>
              </button>
            ))}
          </div>
        </div>
      ) : (
        <>
          <div className="p-3 border-b border-slate-700/50 bg-slate-800/30">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-lg flex items-center justify-center" style={{ backgroundColor: `${agent.color}20` }}>
                  <Icon name={agent.icon} className="w-4 h-4" style={{ color: agent.color }} />
                </div>
                <span className="font-medium text-white">{agent.name}</span>
              </div>
              <button onClick={() => { setAgent(null); setMessages([]); }} className="text-xs text-cyan-400 hover:text-cyan-300">Switch</button>
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((m, i) => (
              <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] rounded-2xl p-4 ${m.role === 'user' ? 'bg-cyan-500/20 border border-cyan-500/30' : 'bg-slate-800 border border-slate-700'}`}>
                  <p className="text-sm text-slate-200 whitespace-pre-wrap">{m.content}</p>
                </div>
              </div>
            ))}
            {loading && <div className="flex justify-start"><div className="bg-slate-800 border border-slate-700 rounded-2xl p-4"><div className="flex gap-1"><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div><div className="w-2 h-2 bg-cyan-400 rounded-full typing-dot"></div></div></div></div>}
            <div ref={ref} />
          </div>
          <div className="p-4 border-t border-slate-700/50">
            <div className="flex gap-2">
              <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && send()} placeholder={`Ask ${agent.name}...`} className="flex-1 bg-slate-800/80 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50" />
              <button onClick={send} disabled={!input.trim() || loading} className="p-3 bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-400 hover:to-teal-400 disabled:opacity-50 rounded-xl transition-all">
                <Icon name="send" className="w-5 h-5 text-white" />
              </button>
            </div>
            <p className="text-[10px] text-slate-500 mt-2 text-center">AI GENERATED - REQUIRES HUMAN REVIEW</p>
          </div>
        </>
      )}
    </div>
  );
};

// ============================================================
// SIDEBAR
// ============================================================
const Sidebar = ({ currentRole, activeModule, onModuleSelect, onRoleChange, onSignOut, userEmail }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [showRoles, setShowRoles] = useState(false);
  const [expanded, setExpanded] = useState(['Command', 'Strategy', 'Intelligence', 'Delivery']);

  const accessible = useMemo(() => MODULES.filter(m => currentRole.access.includes(m.id)), [currentRole]);
  const byCategory = useMemo(() => {
    const g = {};
    MODULE_CATEGORIES.forEach(c => { g[c.id] = accessible.filter(m => m.category === c.id); });
    return g;
  }, [accessible]);

  return (
    <aside className={`flex-shrink-0 h-screen bg-slate-900/95 border-r border-slate-800/50 flex flex-col transition-all duration-300 no-print ${collapsed ? 'w-16' : 'w-64'}`}>
      <div className="p-4 border-b border-slate-800/50">
        <div className="flex items-center justify-between">
          {!collapsed && (
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <span className="text-white font-bold">MP</span>
              </div>
              <div>
                <h1 className="font-bold text-white">MissionPulse</h1>
                <p className="text-[10px] text-slate-500">v{APP_VERSION} • MVP</p>
              </div>
            </div>
          )}
          <button onClick={() => setCollapsed(!collapsed)} className="p-2 rounded-lg hover:bg-slate-800 text-slate-400">
            <Icon name={collapsed ? 'chevronRight' : 'chevronLeft'} className="w-4 h-4" />
          </button>
        </div>
      </div>

      <div className={`p-3 border-b border-slate-800/50 ${collapsed ? 'text-center' : ''}`}>
        <button onClick={() => setShowRoles(!showRoles)} className="w-full flex items-center gap-3 p-2 rounded-xl hover:bg-slate-800/50 transition-colors">
          <div className="w-9 h-9 rounded-xl flex items-center justify-center flex-shrink-0" style={{ backgroundColor: currentRole.bgColor }}>
            <Icon name={currentRole.icon} className="w-4 h-4" style={{ color: currentRole.color }} />
          </div>
          {!collapsed && (
            <>
              <div className="flex-1 text-left">
                <p className="text-sm font-medium text-white">{currentRole.fullName}</p>
                <p className="text-[10px] text-slate-400">{currentRole.name}</p>
              </div>
              <Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition-transform ${showRoles ? 'rotate-180' : ''}`} />
            </>
          )}
        </button>
        {showRoles && !collapsed && (
          <div className="mt-2 p-2 glass-panel-light max-h-64 overflow-y-auto animate-fadeIn">
            <p className="text-[10px] uppercase text-slate-500 font-semibold mb-2 px-2">Switch Role (Demo)</p>
            {ROLES.map(role => (
              <button key={role.id} onClick={() => { onRoleChange(role); setShowRoles(false); }}
                className={`w-full flex items-center gap-2 p-2 rounded-lg transition-colors ${currentRole.id === role.id ? 'bg-cyan-500/20 border border-cyan-500/30' : 'hover:bg-slate-700/50'}`}>
                <div className="w-7 h-7 rounded-lg flex items-center justify-center" style={{ backgroundColor: role.bgColor }}>
                  <Icon name={role.icon} className="w-3.5 h-3.5" style={{ color: role.color }} />
                </div>
                <span className="flex-1 text-left text-xs font-medium text-white">{role.name}</span>
                {role.isExternal && <Badge color="#94a3b8" size="sm">EXT</Badge>}
              </button>
            ))}
          </div>
        )}
      </div>

      <nav className="flex-1 overflow-y-auto p-3">
        {MODULE_CATEGORIES.map(cat => {
          const mods = byCategory[cat.id] || [];
          if (mods.length === 0) return null;
          const isExpanded = expanded.includes(cat.id);
          return (
            <div key={cat.id} className="mb-3">
              {!collapsed && (
                <button onClick={() => setExpanded(prev => prev.includes(cat.id) ? prev.filter(c => c !== cat.id) : [...prev, cat.id])}
                  className="w-full flex items-center justify-between px-2 py-1.5 text-[10px] uppercase font-semibold text-slate-500 hover:text-slate-300">
                  <span>{cat.name}</span>
                  <Icon name={isExpanded ? 'chevronDown' : 'chevronRight'} className="w-3 h-3" />
                </button>
              )}
              {(isExpanded || collapsed) && (
                <div className="space-y-1 mt-1">
                  {mods.map(mod => {
                    const active = activeModule?.id === mod.id;
                    return (
                      <button key={mod.id} onClick={() => onModuleSelect(mod)}
                        className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all ${active ? 'bg-gradient-to-r from-cyan-500/20 to-transparent border-l-2 border-cyan-400' : 'hover:bg-slate-800/50'}`}>
                        <div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style={{ backgroundColor: active ? `${mod.color}25` : `${mod.color}10` }}>
                          <Icon name={mod.icon} className="w-4 h-4" style={{ color: mod.color }} />
                        </div>
                        {!collapsed && <span className={`flex-1 text-left text-sm font-medium ${active ? 'text-white' : 'text-slate-300'}`}>{mod.name}</span>}
                      </button>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </nav>

      <div className={`p-3 border-t border-slate-800/50 ${collapsed ? 'text-center' : ''}`}>
        {!collapsed && userEmail && <p className="text-[10px] text-slate-500 truncate mb-2 px-2">{userEmail}</p>}
        <button onClick={onSignOut} className="w-full flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition-colors">
          <Icon name="logOut" className="w-4 h-4" />
          {!collapsed && <span className="text-sm">Sign Out</span>}
        </button>
      </div>

      <div className={`p-3 border-t border-slate-800/50 ${collapsed ? 'text-center' : ''}`}>
        <div className="flex items-center gap-2 px-2">
          <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
          {!collapsed && <span className="text-[10px] text-slate-400">System Online</span>}
        </div>
      </div>
    </aside>
  );
};

// ============================================================
// MAIN CONTENT
// ============================================================
const MainContent = ({ activeModule, currentRole, opportunities, onSelectModule }) => {
  const accessible = useMemo(() => MODULES.filter(m => currentRole.access.includes(m.id)), [currentRole]);

  const render = () => {
    if (!activeModule) return <WelcomeScreen currentRole={currentRole} onSelectModule={onSelectModule} accessibleModules={accessible} />;
    switch (activeModule.id) {
      case 'dashboard': return <DashboardModule opportunities={opportunities} currentRole={currentRole} />;
      case 'pipeline': return <PipelineModule opportunities={opportunities} currentRole={currentRole} />;
      case 'admin': return <ExportCenter opportunities={opportunities} currentRole={currentRole} />;
      default: return <GenericModule module={activeModule} />;
    }
  };

  return (
    <div className="flex-1 flex flex-col overflow-hidden">
      <header className="h-16 bg-slate-900/95 border-b border-slate-800/50 flex items-center justify-between px-6 no-print">
        <div className="flex items-center gap-4">
          {activeModule ? (
            <>
              <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: `${activeModule.color}20` }}>
                <Icon name={activeModule.icon} className="w-5 h-5" style={{ color: activeModule.color }} />
              </div>
              <div>
                <h1 className="text-lg font-semibold text-white">{activeModule.name}</h1>
                <p className="text-xs text-slate-400">{activeModule.description}</p>
              </div>
            </>
          ) : (
            <h1 className="text-lg font-semibold text-white">Welcome to MissionPulse</h1>
          )}
        </div>
        <div className="flex items-center gap-3">
          <Badge color={currentRole.color}>{currentRole.name}</Badge>
          <Badge color="#8B5CF6">{currentRole.agentAccess?.length || 0} AI Agents</Badge>
        </div>
      </header>
      <main className="flex-1 overflow-auto bg-gradient-to-br from-[#00050F] to-[#0a1628]">{render()}</main>
    </div>
  );
};

// ============================================================
// APP
// ============================================================
function App() {
  const [role, setRole] = useState(ROLES[0]);
  const [module, setModule] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [chat, setChat] = useState(false);
  const [opps, setOpps] = useState(DEMO_OPPORTUNITIES);

  useEffect(() => {
    const init = async () => {
      if (supabase) {
        const { data: { session } } = await supabase.auth.getSession();
        setUser(session?.user || null);
        
        try {
          const { data } = await supabase.from('opportunities').select('*').order('created_at', { ascending: false });
          if (data?.length) setOpps(data);
        } catch (e) { console.log('Using demo data'); }
      }
      setLoading(false);
    };
    init();

    if (supabase) {
      const { data: { subscription } } = supabase.auth.onAuthStateChange((_, session) => {
        setUser(session?.user || null);
        if (!session) window.location.href = 'login.html';
      });
      return () => subscription?.unsubscribe();
    }
  }, []);

  useEffect(() => {
    const r = localStorage.getItem('mp_role');
    const m = localStorage.getItem('mp_module');
    if (r) { const found = ROLES.find(x => x.id === r); if (found) setRole(found); }
    if (m) { const found = MODULES.find(x => x.id === m); if (found) setModule(found); }
  }, []);

  useEffect(() => { localStorage.setItem('mp_role', role.id); }, [role]);
  useEffect(() => { if (module) localStorage.setItem('mp_module', module.id); }, [module]);

  const changeRole = (newRole) => {
    setRole(newRole);
    if (module && !newRole.access.includes(module.id)) {
      setModule(MODULES.find(m => newRole.access.includes(m.id)) || null);
    }
  };

  const selectModule = (mod) => { if (role.access.includes(mod.id)) setModule(mod); };

  const signOut = async () => {
    if (supabase) await supabase.auth.signOut();
    localStorage.removeItem('mp_role');
    localStorage.removeItem('mp_module');
    window.location.href = 'login.html';
  };

  if (loading) return (
    <div className="h-screen flex items-center justify-center bg-[#00050F]">
      <div className="text-center">
        <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center mx-auto mb-4 animate-glow">
          <Icon name="zap" className="w-8 h-8 text-white" />
        </div>
        <p className="text-slate-400">Loading MissionPulse...</p>
      </div>
    </div>
  );

  return (
    <AppContext.Provider value={{ role, opps }}>
      <div className="h-screen flex bg-[#00050F] overflow-hidden">
        <Sidebar currentRole={role} activeModule={module} onModuleSelect={selectModule} onRoleChange={changeRole} onSignOut={signOut} userEmail={user?.email} />
        <MainContent activeModule={module} currentRole={role} opportunities={opps} onSelectModule={selectModule} />
      </div>
      <AIChatPanel isOpen={chat} onClose={() => setChat(false)} currentRole={role} />
      {!chat && (
        <button onClick={() => setChat(true)} className="fixed bottom-10 right-6 w-14 h-14 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-2xl shadow-lg shadow-cyan-500/30 flex items-center justify-center transition-all hover:scale-110 hover:shadow-cyan-500/50 z-30 no-print animate-glow">
          <Icon name="messageSquare" className="w-6 h-6 text-white" />
        </button>
      )}
      <div className="fixed bottom-0 left-0 right-0 h-6 bg-slate-900/98 border-t border-slate-800/50 flex items-center justify-center z-50 no-print">
        <span className="text-[10px] text-slate-500 tracking-wider">AI GENERATED - REQUIRES HUMAN REVIEW • MissionPulse v{APP_VERSION} • © 2026 Mission Meets Tech</span>
      </div>
    </AppContext.Provider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
