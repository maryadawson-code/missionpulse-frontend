<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse | Accept Invitation</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="mp-responsive.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; color: #e2e8f0; }
    .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(0, 229, 250, 0.15); border-radius: 16px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 10px;
      color: #fff;
      font-size: 0.9375rem;
      transition: all 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: #00E5FA;
      box-shadow: 0 0 0 3px rgba(0, 229, 250, 0.15);
    }
    .btn-primary {
      width: 100%;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #00E5FA 0%, #00BDAE 100%);
      color: #00050F;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 25px -5px rgba(0, 229, 250, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .bg-pattern {
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(ellipse at 20% 30%, rgba(0, 229, 250, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(0, 189, 174, 0.06) 0%, transparent 50%);
      pointer-events: none;
    }
  </style>
  </head>
<body>
  <div class="bg-pattern"></div>
  
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md animate-fadeIn">
      
      <!-- Logo -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-cyan-500 to-teal-500 mb-4 shadow-2xl">
          <svg class="w-9 h-9 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-white mb-1">Join Your Team</h1>
        <p class="text-slate-400 text-sm">Complete your account setup</p>
      </div>
      
      <!-- States Container -->
      <div id="content">
        <!-- Loading State -->
        <div id="loading-state" class="glass-panel p-8 text-center">
          <div class="w-12 h-12 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-slate-400">Validating invitation...</p>
        </div>
        
        <!-- Invalid Token State (hidden) -->
        <div id="invalid-state" class="glass-panel p-8 text-center hidden">
          <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">Invalid Invitation</h3>
          <p class="text-slate-400 text-sm mb-6" id="invalid-message">
            This invitation link is invalid or has expired.
          </p>
          <a href="/login.html" class="btn-primary inline-block">Go to Login</a>
        </div>
        
        <!-- Accept Form (hidden) -->
        <div id="accept-form-state" class="glass-panel p-8 hidden">
          <div class="text-center mb-6">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-full text-sm font-medium mb-4">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <span id="company-name">Loading...</span>
            </div>
            <p class="text-slate-400 text-sm">
              You've been invited to join as <strong id="invite-role" class="text-white">Team Member</strong>
            </p>
          </div>
          
          <form id="accept-form" onsubmit="handleAccept(event)">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Full Name</label>
                <input type="text" id="full-name" class="form-input" placeholder="Your full name" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Email</label>
                <input type="email" id="email" class="form-input" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Create Password</label>
                <input type="password" id="password" class="form-input" placeholder="Min 8 characters" required minlength="8">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Confirm Password</label>
                <input type="password" id="confirm-password" class="form-input" placeholder="Re-enter password" required minlength="8">
              </div>
              
              <div id="form-error" class="hidden p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-red-400 text-sm"></div>
              
              <button type="submit" id="accept-btn" class="btn-primary mt-4">
                <span id="btn-text">Create Account & Join</span>
                <svg id="btn-spinner" class="w-5 h-5 animate-spin hidden inline ml-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
            </div>
          </form>
        </div>
        
        <!-- Success State (hidden) -->
        <div id="success-state" class="glass-panel p-8 text-center hidden">
          <div class="w-16 h-16 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-white mb-2">Welcome to the Team!</h3>
          <p class="text-slate-400 text-sm mb-6">Your account has been created. Redirecting to dashboard...</p>
          <div class="w-8 h-8 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto"></div>
        </div>
      </div>
      
      <!-- Footer -->
      <p class="text-xs text-slate-600 text-center mt-6">
        © 2026 Mission Meets Tech • MissionPulse v12.0
      </p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzQ0NDIsImV4cCI6MjA1MzQxMDQ0Mn0.gMzJAb3GkUNJBnfoDSpWPbKDnJBATkTNwdB2D1kMiFo';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let inviteData = null;
    
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    // Validate invitation on load
    async function validateInvitation() {
      if (!token) {
        showInvalidState('No invitation token provided.');
        return;
      }

      try {
        // Find invitation
        const { data: invite, error } = await supabase
          .from('invitations')
          .select(`
            *,
            companies (name)
          `)
          .eq('token', token)
          .eq('status', 'pending')
          .single();

        if (error || !invite) {
          showInvalidState('This invitation link is invalid or has already been used.');
          return;
        }

        // Check expiration
        if (new Date(invite.expires_at) < new Date()) {
          showInvalidState('This invitation has expired. Please request a new one.');
          return;
        }

        // Store invite data and show form
        inviteData = invite;
        showAcceptForm(invite);

      } catch (err) {
        console.error('Validation error:', err);
        showInvalidState('Failed to validate invitation. Please try again.');
      }
    }

    function showInvalidState(message) {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('invalid-message').textContent = message;
      document.getElementById('invalid-state').classList.remove('hidden');
    }

    function showAcceptForm(invite) {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('company-name').textContent = invite.companies?.name || 'Your Team';
      document.getElementById('invite-role').textContent = invite.role;
      document.getElementById('email').value = invite.email;
      document.getElementById('accept-form-state').classList.remove('hidden');
    }

    function showError(message) {
      const errorDiv = document.getElementById('form-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('form-error').classList.add('hidden');
    }

    function setLoading(isLoading) {
      const btn = document.getElementById('accept-btn');
      const btnText = document.getElementById('btn-text');
      const spinner = document.getElementById('btn-spinner');
      
      btn.disabled = isLoading;
      if (isLoading) {
        btnText.textContent = 'Creating account...';
        spinner.classList.remove('hidden');
      } else {
        btnText.textContent = 'Create Account & Join';
        spinner.classList.add('hidden');
      }
    }

    async function handleAccept(event) {
      event.preventDefault();
      hideError();
      
      const fullName = document.getElementById('full-name').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      // Validate passwords match
      if (password !== confirmPassword) {
        showError('Passwords do not match.');
        return;
      }

      if (password.length < 8) {
        showError('Password must be at least 8 characters.');
        return;
      }

      setLoading(true);

      try {
        // 1. Create auth user
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: inviteData.email,
          password: password,
          options: {
            data: {
              full_name: fullName
            }
          }
        });

        if (authError) throw authError;

        if (authData.user) {
          // 2. Create user profile with company link
          const { error: profileError } = await supabase
            .from('users')
            .insert({
              id: authData.user.id,
              email: inviteData.email,
              full_name: fullName,
              role: inviteData.role,
              company_id: inviteData.company_id,
              is_active: true
            });

          if (profileError) {
            console.warn('Profile creation warning:', profileError);
          }

          // 3. Mark invitation as accepted
          await supabase
            .from('invitations')
            .update({
              status: 'accepted',
              accepted_at: new Date().toISOString()
            })
            .eq('id', inviteData.id);

          // 4. Show success and redirect
          document.getElementById('accept-form-state').classList.add('hidden');
          document.getElementById('success-state').classList.remove('hidden');

          // Auto-login might already be done, redirect to dashboard
          setTimeout(() => {
            window.location.href = '/index.html';
          }, 2000);
        }

      } catch (err) {
        console.error('Accept error:', err);
        showError(err.message || 'Failed to create account. Please try again.');
        setLoading(false);
      }
    }

    // Initialize
    validateInvitation();
  </script>
</body>
</html>


