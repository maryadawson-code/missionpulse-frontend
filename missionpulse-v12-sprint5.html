<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#00050F">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MissionPulse">
  <meta name="description" content="AI-Powered Federal Proposal Command Center">
  <title>MissionPulse v12 | Sprint 5</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#00050F;--card:rgba(15,23,42,0.8);--text:#e2e8f0;--muted:#94a3b8;--border:rgba(0,229,250,0.15);--cyan:#00E5FA}
    [data-theme="light"]{--bg:#f8fafc;--card:rgba(255,255,255,0.9);--text:#0f172a;--muted:#475569;--border:rgba(0,0,0,0.1)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:all 0.3s}
    .glass{background:var(--card);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:12px}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .animate-fadeIn{animation:fadeIn 0.3s}
    .animate-slideUp{animation:slideUp 0.3s}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect}=React;
const CONFIG={SUPABASE_URL:'https://djuviwarqdvlbgcfuupa.supabase.co',SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ'};
const supabase=window.supabase?.createClient(CONFIG.SUPABASE_URL,CONFIG.SUPABASE_KEY);
const PHASE_MAP={'gate_1':'Qualify','capture':'Capture','blue_team':'Blue Team','pink_team':'Pink Team','red_team':'Red Team','gold_team':'Gold Team','white_glove':'White Glove','submitted':'Submitted'};
const PHASE_COLORS={'Qualify':'#64748b','Capture':'#8b5cf6','Blue Team':'#3b82f6','Pink Team':'#ec4899','Red Team':'#ef4444','Gold Team':'#f59e0b','White Glove':'#10b981','Submitted':'#22d3ee'};
const ROLES=[
  {id:'CEO',name:'CEO',fullName:'Mary Womack',icon:'üëë',access:['dashboard','pipeline','analytics','pricing','users','settings','demo'],canCRUD:true,canPrice:true,canManageUsers:true,canViewAnalytics:true},
  {id:'COO',name:'COO',fullName:'David Chen',icon:'üíº',access:['dashboard','pipeline','analytics','pricing','settings'],canCRUD:true,canPrice:true,canViewAnalytics:true},
  {id:'PM',name:'Proposal Mgr',fullName:'Lisa Martinez',icon:'üìã',access:['dashboard','pipeline','analytics','settings'],canCRUD:true,canViewAnalytics:true},
  {id:'FIN',name:'Pricing',fullName:'Jennifer Park',icon:'üí∞',access:['dashboard','pricing','analytics','settings'],canPrice:true,canViewAnalytics:true},
  {id:'Admin',name:'Admin',fullName:'System Admin',icon:'‚öôÔ∏è',access:['dashboard','pipeline','analytics','pricing','users','settings','demo'],canCRUD:true,canPrice:true,canManageUsers:true,canViewAnalytics:true}
];
const MODULES=[
  {id:'dashboard',name:'Mission Control',icon:'‚ö°',cat:'Command'},
  {id:'pipeline',name:'Pipeline Intel',icon:'üìä',cat:'Strategy'},
  {id:'analytics',name:'Analytics',icon:'üìà',cat:'Strategy',badge:'NEW'},
  {id:'pricing',name:'Pricing Engine',icon:'üíµ',cat:'Delivery',badge:'CUI'},
  {id:'users',name:'User Management',icon:'üë§',cat:'Admin',badge:'ADMIN'},
  {id:'settings',name:'Settings',icon:'‚öôÔ∏è',cat:'Admin'},
  {id:'demo',name:'Demo Mode',icon:'üé¨',cat:'Admin'}
];
const DEMO_OPPS=[
  {id:1,nickname:'DHA EHR Mod',agency:'DHA',contractValue:98450210,phase:'Pink Team',winProbability:72,daysRemaining:37,priority:'P-0'},
  {id:2,nickname:'VA Claims AI',agency:'VA',contractValue:45000000,phase:'Blue Team',winProbability:58,daysRemaining:82,priority:'P-1'},
  {id:3,nickname:'CMS Analytics',agency:'CMS',contractValue:125000000,phase:'Red Team',winProbability:68,daysRemaining:21,priority:'P-0'},
  {id:4,nickname:'IHS Telehealth',agency:'IHS',contractValue:32000000,phase:'Capture',winProbability:55,daysRemaining:156,priority:'P-1'},
  {id:5,nickname:'CDC Platform',agency:'CDC',contractValue:67000000,phase:'Qualify',winProbability:45,daysRemaining:200,priority:'P-2'},
  {id:6,nickname:'NIH Research',agency:'NIH',contractValue:89000000,phase:'Gold Team',winProbability:82,daysRemaining:14,priority:'P-0'}
];
const DEMO_USERS=[
  {id:1,email:'mary@mmt.com',name:'Mary Womack',role:'CEO',status:'active'},
  {id:2,email:'david@mmt.com',name:'David Chen',role:'COO',status:'active'},
  {id:3,email:'lisa@mmt.com',name:'Lisa Martinez',role:'PM',status:'active'}
];
const fmt=v=>v>=1e6?`$${(v/1e6).toFixed(1)}M`:`$${(v/1e3).toFixed(0)}K`;
const checkAuth=()=>{const s=localStorage.getItem('MP_SESSION');if(!s){window.location.href='login.html';return null}return JSON.parse(localStorage.getItem('MP_USER')||'{}')};
const handleLogout=()=>{localStorage.clear();window.location.href='login.html'};
const useIsMobile=()=>{const[m,setM]=useState(window.innerWidth<768);useEffect(()=>{const h=()=>setM(window.innerWidth<768);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h)},[]);return m};

const Icon=({name,className='w-5 h-5'})=>{
  const d={menu:'M4 6h16M4 12h16M4 18h16',x:'M6 18L18 6M6 6l12 12',chevronLeft:'M15 19l-7-7 7-7',chevronRight:'M9 5l7 7-7 7',plus:'M12 4v16m8-8H4',search:'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z',bell:'M15 17h5l-1.4-1.4A2 2 0 0118 14.2V11a6 6 0 00-4-5.7V5a2 2 0 10-4 0v.3A6 6 0 006 11v3.2c0 .5-.2 1-.6 1.4L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9',logout:'M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1',sun:'M12 3v1m0 16v1m9-9h-1M4 12H3m15.4 6.4l-.7-.7M6.3 6.3l-.7-.7m12.7 0l-.7.7M6.3 17.7l-.7.7M16 12a4 4 0 11-8 0 4 4 0 018 0z',moon:'M20.4 15.4A9 9 0 018.6 3.6 9 9 0 0012 21a9 9 0 008.4-5.6z',download:'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4',trendUp:'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6',users:'M12 4.4a4 4 0 110 5.3M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.2M13 7a4 4 0 11-8 0 4 4 0 018 0z',play:'M14.8 11.2l-3.2-2.1A1 1 0 0010 9.9v4.3a1 1 0 001.6.8l3.2-2.1a1 1 0 000-1.7z'};
  return <svg className={className} fill="none" stroke="currentColor" strokeWidth={2} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d={d[name]||'M12 12h.01'}/></svg>;
};

function Toast({message,type,onClose}){
  useEffect(()=>{const t=setTimeout(onClose,3000);return()=>clearTimeout(t)},[]);
  const c={success:'bg-emerald-500/20 border-emerald-500/30 text-emerald-400',error:'bg-red-500/20 border-red-500/30 text-red-400',info:'bg-cyan-500/20 border-cyan-500/30 text-cyan-400'};
  return <div className={`fixed top-4 right-4 px-4 py-3 rounded-lg border animate-fadeIn z-50 ${c[type]||c.info}`}>{message}</div>;
}

function PWAPrompt(){
  const[show,setShow]=useState(false);
  useEffect(()=>{if(!localStorage.getItem('MP_PWA_DISMISSED'))setTimeout(()=>setShow(true),3000)},[]);
  const dismiss=()=>{setShow(false);localStorage.setItem('MP_PWA_DISMISSED','1')};
  if(!show)return null;
  return <div className="fixed bottom-20 md:bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-80 glass p-4 animate-slideUp z-50">
    <div className="flex gap-3"><div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div className="flex-1"><p className="font-semibold text-sm" style={{color:'var(--text)'}}>Install MissionPulse</p><p className="text-xs" style={{color:'var(--muted)'}}>Add to home screen</p></div><button onClick={dismiss} style={{color:'var(--muted)'}}><Icon name="x" className="w-4 h-4"/></button></div>
    <div className="flex gap-2 mt-3"><button onClick={dismiss} className="flex-1 px-3 py-2 rounded-lg text-sm" style={{background:'var(--border)',color:'var(--muted)'}}>Not now</button><button onClick={dismiss} className="flex-1 px-3 py-2 bg-cyan-500 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-1"><Icon name="download" className="w-4 h-4"/>Install</button></div>
  </div>;
}

function CommandPalette({open,onClose,modules,role,setActive}){
  const[q,setQ]=useState('');
  const filtered=modules.filter(m=>role.access.includes(m.id)&&m.name.toLowerCase().includes(q.toLowerCase()));
  useEffect(()=>{if(open)setQ('')},[open]);
  useEffect(()=>{const h=e=>{if(e.key==='Escape')onClose()};if(open)document.addEventListener('keydown',h);return()=>document.removeEventListener('keydown',h)},[open]);
  if(!open)return null;
  return <div className="fixed inset-0 bg-black/60 z-50 flex items-start justify-center pt-[20vh]" onClick={onClose}>
    <div className="w-full max-w-lg mx-4 glass animate-fadeIn" onClick={e=>e.stopPropagation()}>
      <div className="flex items-center gap-3 p-4 border-b" style={{borderColor:'var(--border)'}}><Icon name="search" className="w-5 h-5" style={{color:'var(--muted)'}}/><input autoFocus value={q} onChange={e=>setQ(e.target.value)} placeholder="Search modules..." className="flex-1 bg-transparent outline-none" style={{color:'var(--text)'}}/><kbd className="px-2 py-1 rounded text-xs" style={{background:'var(--border)',color:'var(--muted)'}}>ESC</kbd></div>
      <div className="max-h-60 overflow-y-auto p-2">{filtered.map(m=><button key={m.id} onClick={()=>{setActive(m);onClose()}} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-cyan-500/10"><span className="text-xl">{m.icon}</span><span style={{color:'var(--text)'}}>{m.name}</span>{m.badge&&<span className={`ml-auto px-1.5 py-0.5 rounded text-[10px] font-bold ${m.badge==='NEW'?'bg-emerald-500/20 text-emerald-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</button>)}</div>
    </div>
  </div>;
}

function MobileNav({active,setActive,role,onMore}){
  const nav=[{id:'dashboard',icon:'‚ö°'},{id:'pipeline',icon:'üìä'},{id:'analytics',icon:'üìà'},{id:'pricing',icon:'üíµ'}].filter(n=>role.access.includes(n.id));
  return <div className="fixed bottom-0 left-0 right-0 border-t z-40 md:hidden" style={{background:'var(--card)',borderColor:'var(--border)'}}>
    <div className="flex justify-around items-center h-16">{nav.map(n=><button key={n.id} onClick={()=>setActive(MODULES.find(m=>m.id===n.id))} className={`flex flex-col items-center flex-1 h-full justify-center ${active?.id===n.id?'text-cyan-400':'text-slate-400'}`}><span className="text-xl">{n.icon}</span></button>)}<button onClick={onMore} className="flex flex-col items-center flex-1 h-full justify-center text-slate-400"><Icon name="menu" className="w-5 h-5"/></button></div>
  </div>;
}

function MobileMore({role,setActive,onClose}){
  const mods=MODULES.filter(m=>role.access.includes(m.id));
  return <div className="fixed inset-0 bg-black/80 z-50" onClick={onClose}>
    <div className="absolute bottom-0 left-0 right-0 rounded-t-2xl max-h-[70vh] overflow-y-auto animate-slideUp" style={{background:'var(--card)'}} onClick={e=>e.stopPropagation()}>
      <div className="flex justify-center py-3"><div className="w-12 h-1 bg-slate-600 rounded-full"/></div>
      <div className="px-4 pb-8 grid grid-cols-3 gap-3">{mods.map(m=><button key={m.id} onClick={()=>{setActive(m);onClose()}} className="flex flex-col items-center p-4 rounded-xl" style={{background:'var(--border)'}}><span className="text-2xl mb-1">{m.icon}</span><span className="text-xs" style={{color:'var(--muted)'}}>{m.name}</span></button>)}</div>
    </div>
  </div>;
}

function ModuleAnalytics({opps,role}){
  if(!role?.canViewAnalytics)return <div className="glass p-8 text-center"><div className="text-4xl mb-4">üîí</div><p style={{color:'var(--text)'}}>Access required</p></div>;
  const total=opps.reduce((s,o)=>s+(o.contractValue||0),0);
  const weighted=opps.reduce((s,o)=>s+((o.contractValue||0)*(o.winProbability||0)/100),0);
  const avgPwin=opps.length?Math.round(opps.reduce((s,o)=>s+(o.winProbability||0),0)/opps.length):0;
  const phases=Object.entries(opps.reduce((a,o)=>{a[o.phase]=(a[o.phase]||0)+1;return a},{}));
  const agencies=Object.entries(opps.reduce((a,o)=>{a[o.agency]=(a[o.agency]||0)+o.contractValue;return a},{})).sort((a,b)=>b[1]-a[1]);
  const maxP=Math.max(...phases.map(([_,v])=>v));
  const maxA=Math.max(...agencies.map(([_,v])=>v));
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <div className="flex items-center gap-2"><h2 className="text-xl font-bold" style={{color:'var(--text)'}}>Analytics</h2><span className="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs font-bold">NEW</span></div>
    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div className="glass p-4"><p className="text-xs" style={{color:'var(--muted)'}}>Pipeline</p><p className="text-xl font-bold text-emerald-400">{fmt(total)}</p><div className="flex items-center gap-1 mt-1 text-emerald-400 text-xs"><Icon name="trendUp" className="w-3 h-3"/>+12%</div></div>
      <div className="glass p-4"><p className="text-xs" style={{color:'var(--muted)'}}>Weighted</p><p className="text-xl font-bold text-cyan-400">{fmt(weighted)}</p></div>
      <div className="glass p-4"><p className="text-xs" style={{color:'var(--muted)'}}>Avg pWin</p><p className="text-xl font-bold text-amber-400">{avgPwin}%</p></div>
      <div className="glass p-4"><p className="text-xs" style={{color:'var(--muted)'}}>Active</p><p className="text-xl font-bold text-purple-400">{opps.length}</p></div>
    </div>
    <div className="grid md:grid-cols-2 gap-4">
      <div className="glass p-4"><h3 className="font-medium mb-4" style={{color:'var(--text)'}}>By Phase</h3><div className="space-y-3">{phases.map(([p,c])=><div key={p}><div className="flex justify-between text-sm mb-1"><span style={{color:'var(--muted)'}}>{p}</span><span style={{color:'var(--text)'}}>{c}</span></div><div className="h-3 rounded-full" style={{background:'var(--border)'}}><div className="h-full rounded-full transition-all" style={{width:`${(c/maxP)*100}%`,background:PHASE_COLORS[p]}}/></div></div>)}</div></div>
      <div className="glass p-4"><h3 className="font-medium mb-4" style={{color:'var(--text)'}}>By Agency</h3><div className="space-y-3">{agencies.slice(0,5).map(([a,v])=><div key={a}><div className="flex justify-between text-sm mb-1"><span style={{color:'var(--muted)'}}>{a}</span><span className="text-emerald-400">{fmt(v)}</span></div><div className="h-3 rounded-full" style={{background:'var(--border)'}}><div className="h-full rounded-full bg-gradient-to-r from-cyan-500 to-emerald-500 transition-all" style={{width:`${(v/maxA)*100}%`}}/></div></div>)}</div></div>
    </div>
    <div className="glass p-4"><h3 className="font-medium mb-4" style={{color:'var(--text)'}}>Top Opportunities</h3><div className="space-y-2">{opps.sort((a,b)=>b.contractValue-a.contractValue).slice(0,5).map((o,i)=><div key={o.id} className="flex items-center gap-3 p-2 rounded-lg" style={{background:'var(--border)'}}><span className="w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-xs font-bold">{i+1}</span><div className="flex-1"><p className="text-sm" style={{color:'var(--text)'}}>{o.nickname}</p><p className="text-xs" style={{color:'var(--muted)'}}>{o.agency}</p></div><span className="text-emerald-400 font-medium">{fmt(o.contractValue)}</span></div>)}</div></div>
  </div>;
}

function ModuleDashboard({opps,dbStatus,isMobile}){
  const total=opps.reduce((s,o)=>s+(o.contractValue||0),0);
  const avgPwin=opps.length?Math.round(opps.reduce((s,o)=>s+(o.winProbability||0),0)/opps.length):0;
  const due=opps.filter(o=>o.daysRemaining<=7).length;
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <div className="glass p-4 md:p-6 bg-gradient-to-r from-cyan-500/10 to-teal-500/10">
      <div className="flex justify-between items-start">
        <div><h2 className="text-xl md:text-2xl font-bold" style={{color:'var(--text)'}}>Mission Control</h2><p className="text-sm" style={{color:'var(--muted)'}}>Sprint 5: PWA + Analytics</p></div>
        <div className={`px-2 py-1 rounded-lg border text-xs ${dbStatus==='connected'?'bg-emerald-500/20 border-emerald-500/30 text-emerald-400':'bg-amber-500/20 border-amber-500/30 text-amber-400'}`}>{dbStatus==='connected'?'Live':'Demo'}</div>
      </div>
    </div>
    {due>0&&<div className="glass p-3 bg-red-500/10 border-red-500/30 flex items-center gap-2"><span>üö®</span><span style={{color:'var(--text)'}}>{due} due this week</span></div>}
    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div className="glass p-3"><p className="text-xs" style={{color:'var(--muted)'}}>Pipeline</p><p className="text-lg md:text-2xl font-bold text-emerald-400">{fmt(total)}</p></div>
      <div className="glass p-3"><p className="text-xs" style={{color:'var(--muted)'}}>Active</p><p className="text-lg md:text-2xl font-bold text-cyan-400">{opps.length}</p></div>
      <div className="glass p-3"><p className="text-xs" style={{color:'var(--muted)'}}>Avg pWin</p><p className="text-lg md:text-2xl font-bold text-amber-400">{avgPwin}%</p></div>
      <div className="glass p-3"><p className="text-xs" style={{color:'var(--muted)'}}>Due Soon</p><p className={`text-lg md:text-2xl font-bold ${due>0?'text-red-400':'text-purple-400'}`}>{due}</p></div>
    </div>
    {isMobile?<div className="space-y-3">{opps.slice(0,4).map(o=><div key={o.id} className="glass p-4"><div className="flex justify-between mb-2"><div><p className="font-medium" style={{color:'var(--text)'}}>{o.nickname}</p><p className="text-xs" style={{color:'var(--muted)'}}>{o.agency}</p></div><span className={`px-2 py-0.5 rounded text-xs ${o.daysRemaining<=7?'bg-red-500/20 text-red-400':'bg-cyan-500/20 text-cyan-400'}`}>{o.daysRemaining}d</span></div><div className="flex justify-between items-center"><span className="text-emerald-400 font-medium">{fmt(o.contractValue)}</span><span className="text-xs" style={{color:'var(--muted)'}}>{o.winProbability}%</span></div></div>)}</div>:<div className="glass overflow-hidden"><table className="w-full"><thead style={{background:'var(--border)'}}><tr>{['Opportunity','Agency','Value','Phase','pWin','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold uppercase" style={{color:'var(--muted)'}}>{h}</th>)}</tr></thead><tbody>{opps.map(o=><tr key={o.id} className="border-t" style={{borderColor:'var(--border)'}}><td className="p-3 font-medium" style={{color:'var(--text)'}}>{o.nickname}</td><td className="p-3" style={{color:'var(--muted)'}}>{o.agency}</td><td className="p-3 text-emerald-400 font-medium">{fmt(o.contractValue)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:PHASE_COLORS[o.phase]+'20',color:PHASE_COLORS[o.phase]}}>{o.phase}</span></td><td className="p-3" style={{color:'var(--muted)'}}>{o.winProbability}%</td><td className="p-3"><span className={o.daysRemaining<=7?'text-red-400 font-bold':''}>{o.daysRemaining}d</span></td></tr>)}</tbody></table></div>}
  </div>;
}

function ModulePipeline({opps,setOpps,role,showToast,isMobile}){
  const[search,setSearch]=useState('');const[showAdd,setShowAdd]=useState(false);
  const filtered=opps.filter(o=>o.nickname.toLowerCase().includes(search.toLowerCase()));
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
      <div><h2 className="text-xl font-bold" style={{color:'var(--text)'}}>Pipeline Intel</h2><p className="text-sm" style={{color:'var(--muted)'}}>{filtered.length} opps ‚Ä¢ {fmt(filtered.reduce((s,o)=>s+o.contractValue,0))}</p></div>
      {role?.canCRUD&&<button onClick={()=>setShowAdd(true)} className="w-full md:w-auto px-4 py-2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg font-medium flex items-center justify-center gap-2"><Icon name="plus" className="w-4 h-4"/>Add</button>}
    </div>
    <div className="relative"><Icon name="search" className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style={{color:'var(--muted)'}}/><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search..." className="w-full rounded-lg pl-10 pr-4 py-3 border" style={{background:'var(--card)',borderColor:'var(--border)',color:'var(--text)'}}/></div>
    {isMobile?<div className="space-y-3">{filtered.map(o=><div key={o.id} className="glass p-4"><div className="flex justify-between mb-2"><p className="font-medium" style={{color:'var(--text)'}}>{o.nickname}</p><span className={`px-2 py-0.5 rounded text-xs font-bold ${o.priority==='P-0'?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}`}>{o.priority}</span></div><div className="grid grid-cols-3 gap-2 text-sm"><div><p className="text-xs" style={{color:'var(--muted)'}}>Agency</p><p>{o.agency}</p></div><div><p className="text-xs" style={{color:'var(--muted)'}}>Value</p><p className="text-emerald-400">{fmt(o.contractValue)}</p></div><div><p className="text-xs" style={{color:'var(--muted)'}}>Days</p><p className={o.daysRemaining<=7?'text-red-400':''}>{o.daysRemaining}d</p></div></div></div>)}</div>:<div className="glass overflow-hidden"><table className="w-full"><thead style={{background:'var(--border)'}}><tr>{['Opportunity','Agency','Value','Phase','pWin','Priority','Days'].map(h=><th key={h} className="text-left p-3 text-xs font-semibold uppercase" style={{color:'var(--muted)'}}>{h}</th>)}</tr></thead><tbody>{filtered.map(o=><tr key={o.id} className="border-t" style={{borderColor:'var(--border)'}}><td className="p-3 font-medium" style={{color:'var(--text)'}}>{o.nickname}</td><td className="p-3" style={{color:'var(--muted)'}}>{o.agency}</td><td className="p-3 text-emerald-400 font-semibold">{fmt(o.contractValue)}</td><td className="p-3"><span className="px-2 py-1 rounded text-xs" style={{background:PHASE_COLORS[o.phase]+'20',color:PHASE_COLORS[o.phase]}}>{o.phase}</span></td><td className="p-3" style={{color:'var(--muted)'}}>{o.winProbability}%</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${o.priority==='P-0'?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}`}>{o.priority}</span></td><td className="p-3" style={{color:o.daysRemaining<=7?'#f87171':'var(--muted)'}}>{o.daysRemaining}d</td></tr>)}</tbody></table></div>}
    {showAdd&&<div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50" onClick={()=>setShowAdd(false)}><div className="glass w-full max-w-md mx-4 p-6" onClick={e=>e.stopPropagation()}><h3 className="text-lg font-bold mb-4" style={{color:'var(--text)'}}>Add Opportunity</h3><form onSubmit={e=>{e.preventDefault();const fd=new FormData(e.target);setOpps([...opps,{id:Date.now(),nickname:fd.get('nickname'),agency:'DHA',contractValue:+fd.get('value'),phase:'Qualify',winProbability:50,daysRemaining:90,priority:'P-1'}]);setShowAdd(false);showToast('Created','success')}} className="space-y-3"><input name="nickname" placeholder="Nickname" required className="w-full rounded-lg px-4 py-3 border" style={{background:'var(--card)',borderColor:'var(--border)',color:'var(--text)'}}/><input name="value" type="number" placeholder="Value ($)" required className="w-full rounded-lg px-4 py-3 border" style={{background:'var(--card)',borderColor:'var(--border)',color:'var(--text)'}}/><div className="flex gap-2"><button type="button" onClick={()=>setShowAdd(false)} className="flex-1 px-4 py-3 rounded-lg" style={{background:'var(--border)',color:'var(--text)'}}>Cancel</button><button type="submit" className="flex-1 px-4 py-3 bg-cyan-500 text-white rounded-lg font-medium">Create</button></div></form></div></div>}
  </div>;
}

function ModulePricing({role,showToast}){
  const[rates,setRates]=useState({oh:15,ga:8,fee:10});
  const labor=[{title:'PM',rate:122.56,hours:2080},{title:'Tech Lead',rate:120.62,hours:2080},{title:'Data Sci',rate:154.38,hours:4160}];
  const direct=labor.reduce((s,l)=>s+l.rate*l.hours,0);const oh=direct*rates.oh/100;const ga=(direct+oh)*rates.ga/100;const cost=direct+oh+ga;const fee=cost*rates.fee/100;const total=cost+fee;
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <div className="flex items-center gap-2"><h2 className="text-xl font-bold" style={{color:'var(--text)'}}>Pricing Engine</h2><span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-bold">CUI</span></div>
    <div className="grid grid-cols-2 gap-3"><div className="glass p-4"><p className="text-xs" style={{color:'var(--muted)'}}>Direct Labor</p><p className="text-xl font-bold" style={{color:'var(--text)'}}>{fmt(direct)}</p></div><div className="glass p-4 bg-gradient-to-r from-cyan-500/10 to-emerald-500/10"><p className="text-xs" style={{color:'var(--muted)'}}>Total Price</p><p className="text-xl font-bold text-emerald-400">{fmt(total)}</p></div></div>
    <div className="glass p-4"><h3 className="font-medium mb-3" style={{color:'var(--text)'}}>Indirect Rates</h3><div className="space-y-3">{[{k:'oh',l:'OH'},{k:'ga',l:'G&A'},{k:'fee',l:'Fee'}].map(r=><div key={r.k} className="flex items-center gap-3"><span className="text-sm w-12" style={{color:'var(--muted)'}}>{r.l}</span><input type="range" min="0" max="30" value={rates[r.k]} onChange={e=>setRates({...rates,[r.k]:+e.target.value})} className="flex-1 accent-cyan-500"/><span className="text-cyan-400 w-12 text-right">{rates[r.k]}%</span></div>)}</div></div>
    <div className="glass p-4"><h3 className="font-medium mb-3" style={{color:'var(--text)'}}>Waterfall</h3><div className="space-y-2">{[{l:'Direct',v:direct},{l:`+ OH (${rates.oh}%)`,v:oh,c:'text-amber-400'},{l:`+ G&A (${rates.ga}%)`,v:ga,c:'text-purple-400'},{l:'= Cost',v:cost},{l:`+ Fee (${rates.fee}%)`,v:fee,c:'text-cyan-400'}].map((r,i)=><div key={i} className="flex justify-between p-2 rounded" style={{background:'var(--border)'}}><span style={{color:'var(--muted)'}}>{r.l}</span><span className={r.c||''} style={{color:r.c?undefined:'var(--text)'}}>{fmt(r.v)}</span></div>)}<div className="flex justify-between p-3 bg-gradient-to-r from-cyan-500/20 to-emerald-500/20 rounded-lg border border-cyan-500/30"><span className="font-bold" style={{color:'var(--text)'}}>TOTAL</span><span className="text-xl font-bold text-emerald-400">{fmt(total)}</span></div></div></div>
    {role?.canPrice&&<button onClick={()=>showToast('BOE exported','success')} className="w-full px-4 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg font-medium">Export BOE</button>}
  </div>;
}

function ModuleUsers({role,showToast,isMobile}){
  const[users,setUsers]=useState(DEMO_USERS);
  if(!role?.canManageUsers)return <div className="glass p-8 text-center"><div className="text-4xl mb-4">üîí</div><p style={{color:'var(--text)'}}>Admin required</p></div>;
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <div className="flex items-center gap-2"><h2 className="text-xl font-bold" style={{color:'var(--text)'}}>User Management</h2><span className="px-2 py-1 bg-purple-500/20 text-purple-400 rounded text-xs font-bold">ADMIN</span></div>
    <div className="glass p-3 flex items-center gap-3"><Icon name="users" className="w-5 h-5 text-cyan-400"/><span style={{color:'var(--text)'}}>{users.filter(u=>u.status==='active').length} active</span></div>
    <div className="space-y-3">{users.map(u=><div key={u.id} className="glass p-4 flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">{u.name[0]}</div><div className="flex-1"><p className="font-medium" style={{color:'var(--text)'}}>{u.name}</p><p className="text-xs" style={{color:'var(--muted)'}}>{u.email}</p></div><span className={`px-2 py-1 rounded text-xs ${u.status==='active'?'bg-emerald-500/20 text-emerald-400':'bg-slate-500/20 text-slate-400'}`}>{u.status}</span></div>)}</div>
  </div>;
}

function ModuleSettings({theme,setTheme,showToast}){
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <h2 className="text-xl font-bold" style={{color:'var(--text)'}}>Settings</h2>
    <div className="glass p-4"><h3 className="font-medium mb-4" style={{color:'var(--text)'}}>Appearance</h3><div className="flex items-center justify-between"><div><p style={{color:'var(--text)'}}>Theme</p><p className="text-sm" style={{color:'var(--muted)'}}>Dark or light mode</p></div><button onClick={()=>{const n=theme==='dark'?'light':'dark';setTheme(n);localStorage.setItem('MP_THEME',n);showToast(`${n} mode`,'info')}} className="flex items-center gap-2 px-4 py-2 rounded-lg border" style={{borderColor:'var(--border)'}}><Icon name={theme==='dark'?'moon':'sun'} className="w-5 h-5" style={{color:'var(--text)'}}/><span style={{color:'var(--text)'}}>{theme==='dark'?'Dark':'Light'}</span></button></div></div>
    <div className="glass p-4"><h3 className="font-medium mb-4" style={{color:'var(--text)'}}>Shortcuts</h3><div className="space-y-2">{[{keys:['‚åò','K'],desc:'Command palette'},{keys:['ESC'],desc:'Close'}].map((s,i)=><div key={i} className="flex items-center justify-between p-2 rounded" style={{background:'var(--border)'}}><span style={{color:'var(--muted)'}}>{s.desc}</span><div className="flex gap-1">{s.keys.map((k,j)=><kbd key={j} className="px-2 py-1 rounded text-xs" style={{background:'var(--card)',color:'var(--text)'}}>{k}</kbd>)}</div></div>)}</div></div>
    <div className="glass p-4"><p className="text-sm" style={{color:'var(--muted)'}}>MissionPulse v12 Sprint 5 ‚Ä¢ ¬© 2026 Mission Meets Tech</p></div>
  </div>;
}

function ModuleDemo(){
  const[s,setS]=useState(0);const scenes=[{phase:'GATE 1',persona:'Capture',problem:'Intel not formalized',agent:'Capture Strategist'},{phase:'BLUE TEAM',persona:'PM',problem:'100+ pages',agent:'Compliance Checker'},{phase:'PINK TEAM',persona:'Writer',problem:'Engineer-speak',agent:'Proposal Writer'},{phase:'RED TEAM',persona:'COO',problem:'Pull punches',agent:'Black Hat Analyst'},{phase:'GOLD TEAM',persona:'CEO',problem:'Cannot read all',agent:'Strategy Coach'}];
  const sc=scenes[s];
  return <div className="space-y-4 animate-fadeIn pb-20 md:pb-0">
    <h2 className="text-xl font-bold" style={{color:'var(--text)'}}>Demo Mode</h2>
    <div className="glass p-3"><div className="flex justify-between mb-2"><span style={{color:'var(--muted)'}}>Scene {s+1}/{scenes.length}</span><span className="text-cyan-400">{sc.phase}</span></div><div className="h-2 rounded-full" style={{background:'var(--border)'}}><div className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full transition-all" style={{width:`${((s+1)/scenes.length)*100}%`}}/></div></div>
    <div className="glass p-6"><div className="flex items-center gap-3 mb-4"><div className="w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center text-2xl">{s+1}</div><div><p className="font-semibold" style={{color:'var(--text)'}}>{sc.persona}</p><p className="text-sm" style={{color:'var(--muted)'}}>{sc.phase}</p></div></div><div className="space-y-3"><div><p className="text-xs uppercase" style={{color:'var(--muted)'}}>Problem</p><p style={{color:'var(--text)'}}>{sc.problem}</p></div><div><p className="text-xs uppercase" style={{color:'var(--muted)'}}>Agent</p><div className="flex items-center gap-2"><span>ü§ñ</span><span style={{color:'var(--text)'}}>{sc.agent}</span></div></div></div></div>
    <div className="flex justify-between"><button onClick={()=>setS(Math.max(0,s-1))} disabled={s===0} className="px-4 py-2 rounded-lg disabled:opacity-50" style={{background:'var(--border)',color:'var(--text)'}}><Icon name="chevronLeft" className="w-4 h-4"/></button><div className="flex gap-1">{scenes.map((_,i)=><button key={i} onClick={()=>setS(i)} className={`w-2 h-2 rounded-full ${i===s?'bg-cyan-400 w-6':'bg-slate-600'}`}/>)}</div><button onClick={()=>setS(Math.min(scenes.length-1,s+1))} disabled={s===scenes.length-1} className="px-4 py-2 bg-cyan-500 text-white rounded-lg disabled:opacity-50"><Icon name="chevronRight" className="w-4 h-4"/></button></div>
  </div>;
}

function ModuleGeneric({mod}){return <div className="glass p-8 text-center"><div className="text-5xl mb-4">{mod.icon}</div><p className="text-lg" style={{color:'var(--text)'}}>{mod.name}</p><p style={{color:'var(--muted)'}}>Coming soon</p></div>;}

function Sidebar({role,setRole,active,setActive,collapsed,setCollapsed,theme,setTheme}){
  const[showRoles,setShowRoles]=useState(false);
  const mods=MODULES.filter(m=>role.access.includes(m.id));
  return <aside className={`hidden md:flex h-screen border-r flex-col transition-all ${collapsed?'w-16':'w-64'}`} style={{background:'var(--card)',borderColor:'var(--border)'}}>
    <div className="p-4 border-b flex items-center justify-between" style={{borderColor:'var(--border)'}}>{!collapsed&&<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold">MP</div><div><div className="text-sm font-bold" style={{color:'var(--text)'}}>MissionPulse</div><div className="text-[10px]" style={{color:'var(--muted)'}}>v12 Sprint 5</div></div></div>}<button onClick={()=>setCollapsed(!collapsed)} style={{color:'var(--muted)'}}><Icon name={collapsed?'chevronRight':'chevronLeft'} className="w-4 h-4"/></button></div>
    <div className="p-3 border-b" style={{borderColor:'var(--border)'}}><button onClick={()=>setShowRoles(!showRoles)} className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-cyan-500/10"><span className="text-xl">{role.icon}</span>{!collapsed&&<><div className="flex-1 text-left"><div className="text-sm font-medium" style={{color:'var(--text)'}}>{role.fullName}</div><div className="text-xs" style={{color:'var(--muted)'}}>{role.name}</div></div></>}</button>{showRoles&&!collapsed&&<div className="mt-2 p-2 rounded-lg" style={{background:'var(--border)'}}>{ROLES.map(r=><button key={r.id} onClick={()=>{setRole(r);setShowRoles(false)}} className={`w-full flex items-center gap-2 p-2 rounded ${role.id===r.id?'bg-cyan-500/20':''}`}><span>{r.icon}</span><span className="text-sm" style={{color:'var(--text)'}}>{r.name}</span></button>)}</div>}</div>
    <nav className="flex-1 overflow-y-auto p-2">{mods.map(m=><button key={m.id} onClick={()=>setActive(m)} className={`w-full flex items-center gap-2 p-2 rounded-lg mb-1 ${active?.id===m.id?'bg-cyan-500/20 text-cyan-400':''}`} style={{color:active?.id===m.id?undefined:'var(--muted)'}} title={collapsed?m.name:''}><span>{m.icon}</span>{!collapsed&&<><span className="flex-1 text-left text-sm">{m.name}</span>{m.badge&&<span className={`px-1 py-0.5 text-[9px] font-bold rounded ${m.badge==='NEW'?'bg-emerald-500/20 text-emerald-400':m.badge==='CUI'?'bg-red-500/20 text-red-400':'bg-purple-500/20 text-purple-400'}`}>{m.badge}</span>}</>}</button>)}</nav>
    {!collapsed&&<div className="p-3 border-t flex justify-between" style={{borderColor:'var(--border)'}}><button onClick={()=>{const n=theme==='dark'?'light':'dark';setTheme(n);localStorage.setItem('MP_THEME',n)}} style={{color:'var(--muted)'}}><Icon name={theme==='dark'?'moon':'sun'} className="w-5 h-5"/></button><button onClick={handleLogout} style={{color:'var(--muted)'}}><Icon name="logout" className="w-5 h-5"/></button></div>}
  </aside>;
}

function App(){
  const isMobile=useIsMobile();
  const[theme,setTheme]=useState(()=>localStorage.getItem('MP_THEME')||'dark');
  const[user,setUser]=useState(null);
  const[role,setRole]=useState(ROLES[0]);
  const[active,setActive]=useState(null);
  const[opps,setOpps]=useState([]);
  const[dbStatus,setDbStatus]=useState('checking');
  const[toast,setToast]=useState(null);
  const[loading,setLoading]=useState(true);
  const[collapsed,setCollapsed]=useState(false);
  const[showMore,setShowMore]=useState(false);
  const[showCmd,setShowCmd]=useState(false);
  
  const showToast=(m,t='success')=>setToast({message:m,type:t,key:Date.now()});
  useEffect(()=>{document.documentElement.setAttribute('data-theme',theme)},[theme]);
  useEffect(()=>{const h=e=>{if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();setShowCmd(true)}};document.addEventListener('keydown',h);return()=>document.removeEventListener('keydown',h)},[]);
  useEffect(()=>{const u=checkAuth();if(u){setUser(u);loadOpps()}},[]);
  
  const loadOpps=async()=>{
    setLoading(true);
    try{if(supabase){const{data,error}=await supabase.from('opportunities').select('*').order('due_date',{ascending:true});if(!error&&data?.length>0){setOpps(data.map(d=>({...d,nickname:d.name?.substring(0,15)||'Opp',contractValue:d.contract_value,phase:PHASE_MAP[d.shipley_phase]||'Qualify',winProbability:d.win_probability,daysRemaining:d.due_date?Math.ceil((new Date(d.due_date)-new Date())/(1000*60*60*24)):999,priority:d.priority||'P-1'})));setDbStatus('connected')}else{setOpps(DEMO_OPPS);setDbStatus('demo')}}else{setOpps(DEMO_OPPS);setDbStatus('demo')}}catch{setOpps(DEMO_OPPS);setDbStatus('demo')}
    setLoading(false);
  };
  
  const render=()=>{
    if(!active)return <div className="flex-1 flex items-center justify-center pb-20 md:pb-0"><div className="text-center"><div className="text-6xl mb-4">üõ°Ô∏è</div><h2 className="text-xl font-bold mb-2" style={{color:'var(--text)'}}>MissionPulse</h2><p style={{color:'var(--muted)'}}>Press <kbd className="px-2 py-1 rounded text-xs mx-1" style={{background:'var(--border)'}}>‚åòK</kbd></p></div></div>;
    switch(active.id){
      case 'dashboard':return <ModuleDashboard opps={opps} dbStatus={dbStatus} isMobile={isMobile}/>;
      case 'pipeline':return <ModulePipeline opps={opps} setOpps={setOpps} role={role} showToast={showToast} isMobile={isMobile}/>;
      case 'analytics':return <ModuleAnalytics opps={opps} role={role}/>;
      case 'pricing':return <ModulePricing role={role} showToast={showToast}/>;
      case 'users':return <ModuleUsers role={role} showToast={showToast} isMobile={isMobile}/>;
      case 'settings':return <ModuleSettings theme={theme} setTheme={setTheme} showToast={showToast}/>;
      case 'demo':return <ModuleDemo/>;
      default:return <ModuleGeneric mod={active}/>;
    }
  };
  
  if(!user)return <div className="h-screen flex items-center justify-center" style={{background:'var(--bg)'}}><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>;
  
  return <div className="h-screen flex overflow-hidden" style={{background:'var(--bg)'}}>
    <Sidebar role={role} setRole={setRole} active={active} setActive={setActive} collapsed={collapsed} setCollapsed={setCollapsed} theme={theme} setTheme={setTheme}/>
    <div className="flex-1 flex flex-col overflow-hidden">
      <header className="border-b px-4 md:px-6 py-3 flex items-center justify-between" style={{background:'var(--card)',borderColor:'var(--border)'}}>
        <div className="flex items-center gap-3">{isMobile&&<div className="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-teal-400 flex items-center justify-center text-white font-bold text-sm">MP</div>}{active&&<><span className="text-xl">{active.icon}</span><h1 className="font-semibold" style={{color:'var(--text)'}}>{active.name}</h1></>}</div>
        <div className="flex items-center gap-2"><button onClick={()=>setShowCmd(true)} className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg border text-sm" style={{borderColor:'var(--border)',color:'var(--muted)'}}><Icon name="search" className="w-4 h-4"/>‚åòK</button>{!isMobile&&<button onClick={()=>{setTheme(theme==='dark'?'light':'dark');localStorage.setItem('MP_THEME',theme==='dark'?'light':'dark')}} style={{color:'var(--muted)'}}><Icon name={theme==='dark'?'moon':'sun'} className="w-5 h-5"/></button>}</div>
      </header>
      <main className="flex-1 overflow-y-auto p-4 md:p-6">{loading?<div className="flex items-center justify-center h-full"><div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"/></div>:render()}</main>
    </div>
    {isMobile&&<MobileNav active={active} setActive={setActive} role={role} onMore={()=>setShowMore(true)}/>}
    {showMore&&<MobileMore role={role} setActive={setActive} onClose={()=>setShowMore(false)}/>}
    <CommandPalette open={showCmd} onClose={()=>setShowCmd(false)} modules={MODULES} role={role} setActive={setActive}/>
    <PWAPrompt/>
    {!isMobile&&<div className="fixed bottom-0 left-0 right-0 h-6 border-t flex items-center justify-center z-40" style={{background:'var(--card)',borderColor:'var(--border)'}}><span className="text-[10px]" style={{color:'var(--muted)'}}>AI GENERATED - REQUIRES HUMAN REVIEW ‚Ä¢ MissionPulse v12 Sprint 5</span></div>}
    {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} key={toast.key}/>}
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
