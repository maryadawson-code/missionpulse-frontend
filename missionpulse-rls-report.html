<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse â€” RLS Policy Report</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Space Grotesk',sans-serif;background:#00050F;min-height:100vh}.font-mono{font-family:'JetBrains Mono',monospace}@keyframes slideIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.animate-slide-in{animation:slideIn .4s ease-out forwards}.animate-pulse{animation:pulse 2s ease-in-out infinite}.glass-card{background:linear-gradient(135deg,rgba(15,23,42,.9) 0%,rgba(15,23,42,.7) 100%);backdrop-filter:blur(10px);border:1px solid rgba(0,229,250,.15)}.glass-card:hover{border-color:rgba(0,229,250,.3)}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0a1628}::-webkit-scrollbar-thumb{background:rgba(0,229,250,.3);border-radius:3px}pre{font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.6}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect}=React;
    const SB_URL='https://qdrtpnpnhkxvfmvfziop.supabase.co';const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MjMwMTgsImV4cCI6MjA1MzM5OTAxOH0.gFHBoGjPMWjCGuJNdxMGPOBmGMHBp0jSTbxxcFKqkPQ';
    var sbClient;try{sbClient=supabase.createClient(SB_URL,SB_KEY)}catch(e){sbClient=null}

    const TABLES=[
      {name:'opportunities',schema:'public',rlsEnabled:true,policies:[
        {name:'opportunities_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
        {name:'opportunities_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
        {name:'opportunities_update_auth',cmd:'UPDATE',roles:['authenticated'],using:'auth.role() = \'authenticated\'',check:'auth.role() = \'authenticated\''},
      ],columns:12,rows:12,cuiData:false,gaps:[]},
      {name:'team_assignments',schema:'public',rlsEnabled:true,policies:[
        {name:'team_assignments_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
        {name:'team_assignments_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
      ],columns:8,rows:42,cuiData:false,gaps:[]},
      {name:'competitors',schema:'public',rlsEnabled:true,policies:[
        {name:'competitors_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
      ],columns:10,rows:18,cuiData:false,gaps:['Missing INSERT/UPDATE policies for authenticated users']},
      {name:'pricing_items',schema:'public',rlsEnabled:true,policies:[
        {name:'pricing_items_select_auth',cmd:'SELECT',roles:['authenticated'],using:'auth.role() = \'authenticated\'',check:null},
        {name:'pricing_items_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
        {name:'pricing_items_update_auth',cmd:'UPDATE',roles:['authenticated'],using:'auth.role() = \'authenticated\'',check:'auth.role() = \'authenticated\''},
      ],columns:14,rows:85,cuiData:true,gaps:[]},
      {name:'compliance_clauses',schema:'public',rlsEnabled:true,policies:[
        {name:'compliance_clauses_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
      ],columns:9,rows:124,cuiData:false,gaps:[]},
      {name:'contract_clauses',schema:'public',rlsEnabled:true,policies:[
        {name:'contract_clauses_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
      ],columns:11,rows:67,cuiData:false,gaps:[]},
      {name:'ai_approvals',schema:'public',rlsEnabled:true,policies:[
        {name:'ai_approvals_select_auth',cmd:'SELECT',roles:['authenticated'],using:'auth.role() = \'authenticated\'',check:null},
        {name:'ai_approvals_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
      ],columns:10,rows:38,cuiData:false,gaps:[]},
      {name:'orals_decks',schema:'public',rlsEnabled:true,policies:[
        {name:'orals_decks_select_auth',cmd:'SELECT',roles:['authenticated'],using:'auth.role() = \'authenticated\'',check:null},
        {name:'orals_decks_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
      ],columns:8,rows:15,cuiData:false,gaps:[]},
      {name:'playbook_items',schema:'public',rlsEnabled:true,policies:[
        {name:'playbook_items_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
        {name:'playbook_items_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
      ],columns:9,rows:52,cuiData:false,gaps:[]},
      {name:'partner_access',schema:'public',rlsEnabled:true,policies:[
        {name:'partner_access_select_scoped',cmd:'SELECT',roles:['authenticated'],using:'auth.uid() = user_id',check:null},
        {name:'partner_access_insert_admin',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.jwt()->\'role\' = \'admin\''},
      ],columns:7,rows:4,cuiData:false,gaps:[]},
      {name:'launch_checklists',schema:'public',rlsEnabled:true,policies:[
        {name:'launch_checklists_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
      ],columns:8,rows:28,cuiData:false,gaps:['Missing INSERT/UPDATE policies']},
      {name:'post_award_actions',schema:'public',rlsEnabled:true,policies:[
        {name:'post_award_select_all',cmd:'SELECT',roles:['anon','authenticated'],using:'true',check:null},
        {name:'post_award_insert_auth',cmd:'INSERT',roles:['authenticated'],using:null,check:'auth.role() = \'authenticated\''},
      ],columns:10,rows:22,cuiData:false,gaps:[]},
      {name:'audit_logs',schema:'public',rlsEnabled:true,policies:[
        {name:'audit_logs_select_admin',cmd:'SELECT',roles:['authenticated'],using:'auth.jwt()->\'app_role\' IN (\'CEO\',\'COO\',\'Admin\')',check:null},
        {name:'audit_logs_insert_system',cmd:'INSERT',roles:['service_role'],using:null,check:'true'},
      ],columns:12,rows:1247,cuiData:false,gaps:[]},
      {name:'user_profiles',schema:'public',rlsEnabled:false,policies:[],columns:9,rows:10,cuiData:false,gaps:['RLS NOT ENABLED â€” critical security gap','No policies defined','User PII exposed to anonymous access']},
    ];

    const genFix=(table)=>{
      const fixes=[];
      if(!table.rlsEnabled){
        fixes.push(`ALTER TABLE public.${table.name} ENABLE ROW LEVEL SECURITY;`);
        fixes.push(`CREATE POLICY "${table.name}_select_auth" ON public.${table.name} FOR SELECT TO authenticated USING (auth.role() = 'authenticated');`);
        fixes.push(`CREATE POLICY "${table.name}_insert_auth" ON public.${table.name} FOR INSERT TO authenticated WITH CHECK (auth.role() = 'authenticated');`);
      }
      table.gaps.forEach(g=>{
        if(g.includes('INSERT/UPDATE')){
          fixes.push(`CREATE POLICY "${table.name}_insert_auth" ON public.${table.name} FOR INSERT TO authenticated WITH CHECK (auth.role() = 'authenticated');`);
          fixes.push(`CREATE POLICY "${table.name}_update_auth" ON public.${table.name} FOR UPDATE TO authenticated USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');`);
        }
      });
      return fixes;
    };

    const ConnectionIndicator=({connected})=>(
      <div className="flex items-center gap-2 px-3 py-1 rounded-full text-xs font-mono" style={{background:connected?'rgba(0,255,136,0.1)':'rgba(255,184,0,0.1)',border:`1px solid ${connected?'rgba(0,255,136,0.3)':'rgba(255,184,0,0.3)'}`}}>
        <div className={`w-2 h-2 rounded-full ${connected?'bg-green-400':'bg-amber-400 animate-pulse'}`}/>
        <span style={{color:connected?'#00ff88':'#ffb800'}}>{connected?'LIVE':'DEMO'}</span>
      </div>
    );

    const App=()=>{
      const[connected,setConnected]=useState(false);
      const[userRole]=useState('CEO');
      const[expanded,setExpanded]=useState(null);
      const[showFix,setShowFix]=useState(null);
      const[filter,setFilter]=useState('all');

      useEffect(()=>{const a=['CEO','Admin'];if(!a.includes(userRole))return},[userRole]);
      useEffect(()=>{if(!sbClient)return;(async()=>{try{const{data}=await sbClient.from('opportunities').select('id').limit(1);if(data)setConnected(true)}catch(e){}})()},[]);

      const total=TABLES.length;
      const rlsOn=TABLES.filter(t=>t.rlsEnabled).length;
      const gapped=TABLES.filter(t=>t.gaps.length>0).length;
      const totalPolicies=TABLES.reduce((s,t)=>s+t.policies.length,0);
      const cuiTables=TABLES.filter(t=>t.cuiData).length;
      const coverage=Math.round((rlsOn/total)*100);

      const filtered=filter==='all'?TABLES:filter==='pass'?TABLES.filter(t=>t.rlsEnabled&&t.gaps.length===0):filter==='gap'?TABLES.filter(t=>t.gaps.length>0):TABLES.filter(t=>t.cuiData);

      const CheckIcon=({ok})=>ok?<div className="w-5 h-5 rounded-full bg-green-500/20 border border-green-500/40 flex items-center justify-center shrink-0"><svg className="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7"/></svg></div>:<div className="w-5 h-5 rounded-full bg-red-500/20 border border-red-500/40 flex items-center justify-center shrink-0"><svg className="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12"/></svg></div>;

      return(
        <div className="min-h-screen" style={{background:'#00050F'}}>
          <div className="max-w-7xl mx-auto p-6">
            <div className="flex items-center justify-between mb-6">
              <div><div className="flex items-center gap-3 mb-1"><h1 className="text-2xl font-bold text-white">RLS Policy Report</h1><ConnectionIndicator connected={connected}/></div>
              <p className="text-sm text-slate-400">Supabase Row Level Security audit â€” policy status, gap detection & SQL fixes</p></div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
              {[{l:'Tables',v:total,c:'#00E5FA'},{l:'RLS Enabled',v:rlsOn,c:'#00ff88'},{l:'Coverage',v:`${coverage}%`,c:coverage===100?'#00ff88':'#ff4444'},{l:'Gaps',v:gapped,c:gapped>0?'#ff4444':'#00ff88'},{l:'Total Policies',v:totalPolicies,c:'#a78bfa'}].map((k,i)=>(
                <div key={i} className="glass-card rounded-xl p-4 animate-slide-in" style={{animationDelay:`${i*.05}s`}}>
                  <span className="text-xs text-slate-500 font-mono uppercase">{k.l}</span>
                  <div className="text-2xl font-mono font-bold mt-1" style={{color:k.c}}>{k.v}</div>
                </div>
              ))}
            </div>

            {/* Coverage bar */}
            <div className="glass-card rounded-xl p-4 mb-6">
              <div className="flex items-center justify-between mb-2"><span className="text-xs font-mono text-slate-500">RLS ENFORCEMENT</span><span className="text-xs font-mono" style={{color:coverage===100?'#00ff88':'#ff4444'}}>{rlsOn}/{total} tables secured</span></div>
              <div className="h-3 rounded-full bg-slate-700/30 overflow-hidden flex">
                <div className="h-full bg-green-500/50 transition-all" style={{width:`${(rlsOn/total)*100}%`}}/>
                <div className="h-full bg-red-500/40 transition-all" style={{width:`${((total-rlsOn)/total)*100}%`}}/>
              </div>
            </div>

            <div className="flex items-center gap-2 mb-4">
              {[{k:'all',l:'All'},{k:'pass',l:'Secured'},{k:'gap',l:'Gaps'},{k:'cui',l:'CUI Tables'}].map(f=>(
                <button key={f.k} onClick={()=>setFilter(f.k)} className={`px-3 py-1 rounded-md text-xs font-mono font-bold transition ${filter===f.k?'bg-cyan-500/20 text-cyan-400':'text-slate-500 hover:text-slate-300 bg-slate-800/30'}`}>{f.l}</button>
              ))}
            </div>

            <div className="space-y-2">
              {filtered.map((t,i)=>{
                const isExp=expanded===t.name;const fixes=genFix(t);const hasGap=t.gaps.length>0;
                return(
                  <div key={t.name} className={`glass-card rounded-xl overflow-hidden animate-slide-in ${!t.rlsEnabled?'border-red-500/30':hasGap?'border-amber-500/20':''}`} style={{animationDelay:`${i*.04}s`}}>
                    <div onClick={()=>setExpanded(isExp?null:t.name)} className="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-800/20 transition">
                      <div className="flex items-center gap-3">
                        <CheckIcon ok={t.rlsEnabled&&!hasGap}/>
                        <div>
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-white font-mono font-bold">{t.schema}.{t.name}</span>
                            {t.cuiData&&<span className="px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-amber-500/10 text-amber-400">ðŸ›¡ CUI</span>}
                            {!t.rlsEnabled&&<span className="px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-red-500/10 text-red-400">RLS OFF</span>}
                            {hasGap&&t.rlsEnabled&&<span className="px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-amber-500/10 text-amber-400">GAP</span>}
                          </div>
                          <span className="text-xs text-slate-500">{t.columns} cols Â· {t.rows} rows Â· {t.policies.length} policies</span>
                        </div>
                      </div>
                      <span className="text-slate-600">{isExp?'â–¾':'â–¸'}</span>
                    </div>
                    {isExp&&(
                      <div className="border-t border-slate-700/20 p-4">
                        {/* Policies */}
                        {t.policies.length>0&&(
                          <div className="mb-4">
                            <h4 className="text-xs font-mono font-bold text-cyan-400 mb-2">POLICIES ({t.policies.length})</h4>
                            <div className="space-y-1.5">
                              {t.policies.map((p,j)=>(
                                <div key={j} className="flex items-center gap-3 p-2 rounded-lg bg-slate-800/20 text-xs">
                                  <span className={`px-1.5 py-0.5 rounded font-mono font-bold ${p.cmd==='SELECT'?'bg-cyan-500/10 text-cyan-400':p.cmd==='INSERT'?'bg-green-500/10 text-green-400':p.cmd==='UPDATE'?'bg-purple-500/10 text-purple-400':'bg-red-500/10 text-red-400'}`}>{p.cmd}</span>
                                  <span className="font-mono text-slate-300">{p.name}</span>
                                  <span className="text-slate-600">â†’</span>
                                  <span className="font-mono text-slate-500">{p.roles.join(', ')}</span>
                                  {p.using&&<span className="font-mono text-green-400/60 ml-auto truncate max-w-xs">USING: {p.using}</span>}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        {/* Gaps */}
                        {hasGap&&(
                          <div className="mb-4">
                            <h4 className="text-xs font-mono font-bold text-red-400 mb-2">âš  GAPS</h4>
                            {t.gaps.map((g,j)=><div key={j} className="text-xs text-red-400 p-2 rounded-lg bg-red-500/5 border border-red-500/15 mb-1">â€¢ {g}</div>)}
                          </div>
                        )}
                        {/* SQL fix */}
                        {fixes.length>0&&(
                          <div>
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="text-xs font-mono font-bold text-green-400">SUGGESTED FIX</h4>
                              <button onClick={()=>setShowFix(showFix===t.name?null:t.name)} className="text-xs font-mono text-cyan-400 hover:underline">{showFix===t.name?'Hide SQL':'Show SQL'}</button>
                            </div>
                            {showFix===t.name&&(
                              <div className="p-3 rounded-lg bg-slate-900/60 border border-slate-700/30 overflow-x-auto">
                                <pre className="text-green-400/80">{`-- FIX: ${t.name}\n-- Run in Supabase Dashboard â†’ SQL Editor\n\n${fixes.join('\n\n')}`}</pre>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* NIST mapping */}
            <div className="glass-card rounded-xl p-4 mt-6">
              <div className="flex items-center gap-6">
                {[{ctrl:'AC-3',desc:'Access Enforcement'},{ctrl:'AC-6',desc:'Least Privilege'},{ctrl:'SC-4',desc:'Info in Shared Resources'},{ctrl:'AC-21',desc:'Information Sharing'}].map((c,i)=>(
                  <div key={i} className="flex items-center gap-1.5"><span className="px-1.5 py-0.5 rounded text-xs font-mono font-bold bg-green-500/10 text-green-400">{c.ctrl}</span><span className="text-xs text-slate-500">{c.desc}</span></div>
                ))}
              </div>
            </div>

            <div className="mt-6 text-center"><div className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-500/5 border border-amber-500/20"><svg className="w-3.5 h-3.5 text-amber-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg><span className="text-xs text-amber-500/80 font-mono">AI GENERATED â€” REQUIRES HUMAN REVIEW</span></div></div>
          </div>
        </div>
      );
    };
    ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
