<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Checklist | MissionPulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-cyan: #00E5FA; --deep-navy: #00050F; }
        body { background: linear-gradient(135deg, #00050F 0%, #001a2c 50%, #00050F 100%); min-height: 100vh; }
        .glass-card { background: rgba(0, 229, 250, 0.03); border: 1px solid rgba(0, 229, 250, 0.2); backdrop-filter: blur(10px); }
        .glass-card:hover { border-color: rgba(0, 229, 250, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #00E5FA, #00b8d4); color: #00050F; font-weight: 600; }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
        .priority-critical { background: rgba(239, 68, 68, 0.2); color: #f87171; border-left: 3px solid #ef4444; }
        .priority-high { background: rgba(249, 115, 22, 0.2); color: #fb923c; border-left: 3px solid #f97316; }
        .priority-medium { background: rgba(234, 179, 8, 0.2); color: #facc15; border-left: 3px solid #eab308; }
        .priority-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-left: 3px solid #22c55e; }
        .status-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; white-space: nowrap; }
        .status-not-started { background: rgba(107, 114, 128, 0.3); color: #9ca3af; }
        .status-in-progress { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .status-draft-complete { background: rgba(168, 85, 247, 0.3); color: #c084fc; }
        .status-reviewed { background: rgba(234, 179, 8, 0.3); color: #facc15; }
        .status-compliant { background: rgba(34, 197, 94, 0.3); color: #4ade80; }
        .status-non-compliant { background: rgba(239, 68, 68, 0.3); color: #f87171; }
        .status-na { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .progress-ring { transform: rotate(-90deg); }
        .section-l { border-left: 3px solid #00E5FA; }
        .section-m { border-left: 3px solid #a855f7; }
        .section-c { border-left: 3px solid #22c55e; }
        .section-h { border-left: 3px solid #f97316; }
    </style>
</head>
<body class="text-white font-sans">
    <!-- Header -->
    <header class="border-b border-cyan-500/20 bg-black/40 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-cyan-400 hover:text-cyan-300"><i class="fas fa-arrow-left"></i></a>
                <div>
                    <h1 class="text-xl font-bold text-cyan-400"><i class="fas fa-clipboard-check mr-2"></i>Compliance Checklist</h1>
                    <p class="text-xs text-gray-400">Section L/M Requirements Tracker</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="connectionStatus" class="text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400">
                    <i class="fas fa-circle text-[8px] mr-1"></i> Connecting...
                </span>
                <span id="userRole" class="text-xs text-gray-400"></span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Opportunity Selector & Stats -->
        <div class="flex flex-wrap items-center gap-4 mb-6">
            <select id="opportunitySelect" onchange="loadChecklists()" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm min-w-[250px]">
                <option value="">Select Opportunity...</option>
            </select>
            <button onclick="openChecklistModal()" class="btn-primary px-4 py-2 rounded text-sm">
                <i class="fas fa-plus mr-2"></i>New Checklist
            </button>
            <button onclick="parseRFPRequirements()" class="px-4 py-2 border border-cyan-500/50 text-cyan-400 rounded text-sm hover:bg-cyan-500/10">
                <i class="fas fa-magic mr-2"></i>AI Extract from RFP
            </button>
        </div>

        <!-- Compliance Score Cards -->
        <div id="scoreCards" class="grid md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-cyan-400" id="overallScore">--</div>
                <div class="text-xs text-gray-400">Overall Compliance</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-cyan-400" id="totalItems">0</div>
                <div class="text-xs text-gray-400">Total Requirements</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-green-400" id="compliantItems">0</div>
                <div class="text-xs text-gray-400">Compliant</div>
            </div>
            <div class="glass-card rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-red-400" id="criticalItems">0</div>
                <div class="text-xs text-gray-400">Critical Gaps</div>
            </div>
        </div>

        <!-- Checklists Container -->
        <div id="checklistsContainer" class="space-y-6">
            <div class="glass-card rounded-lg p-8 text-center text-gray-500">
                <i class="fas fa-clipboard-list text-4xl mb-4 opacity-50"></i>
                <p>Select an opportunity to view compliance checklists</p>
            </div>
        </div>
    </main>

    <!-- Checklist Modal -->
    <div id="checklistModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-folder-plus mr-2"></i>New Checklist</h3>
                <button onclick="closeChecklistModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="checklistForm" onsubmit="saveChecklist(event)" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Checklist Name</label>
                    <input type="text" id="checklistName" required class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., Section L Instructions">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">RFP Section</label>
                    <select id="checklistSection" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                        <option value="Section L">Section L - Instructions</option>
                        <option value="Section M">Section M - Evaluation Criteria</option>
                        <option value="Section C">Section C - SOW/PWS</option>
                        <option value="Section H">Section H - Special Clauses</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeChecklistModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="itemModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass-card rounded-xl max-w-2xl w-full p-6 my-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-tasks mr-2"></i><span id="itemModalTitle">Add Requirement</span></h3>
                <button onclick="closeItemModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <form id="itemForm" onsubmit="saveItem(event)" class="space-y-4">
                <input type="hidden" id="itemId">
                <input type="hidden" id="itemChecklistId">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Requirement Text <span class="text-red-400">*</span></label>
                    <textarea id="itemRequirement" required rows="3" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Enter the requirement from the RFP..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">RFP Reference</label>
                        <input type="text" id="itemRef" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., L.5.2.1">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Proposal Section</label>
                        <input type="text" id="itemProposalSection" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., Vol II, Tab A">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Priority</label>
                        <select id="itemPriority" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Status</label>
                        <select id="itemStatus" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Draft Complete">Draft Complete</option>
                            <option value="Reviewed">Reviewed</option>
                            <option value="Compliant">Compliant</option>
                            <option value="Non-Compliant">Non-Compliant</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Page Limit</label>
                        <input type="number" id="itemPageLimit" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="e.g., 5">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Assigned To</label>
                        <select id="itemAssigned" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Due Date</label>
                        <input type="date" id="itemDueDate" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Evidence / Compliance Notes</label>
                    <textarea id="itemEvidence" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Document how this requirement is addressed..."></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Reviewer Notes</label>
                    <textarea id="itemReviewerNotes" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2" placeholder="Notes from compliance review..."></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeItemModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="flex-1 btn-primary px-4 py-2 rounded">Save Requirement</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Extract Modal -->
    <div id="aiExtractModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-card rounded-xl max-w-2xl w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-cyan-400"><i class="fas fa-magic mr-2"></i>AI Extract Requirements</h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-gray-400">Paste RFP text (Section L or M) to automatically extract requirements:</p>
                <textarea id="rfpText" rows="10" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm" placeholder="Paste Section L or Section M text here..."></textarea>
                <select id="extractSection" class="w-full bg-gray-800 border border-gray-600 rounded px-4 py-2">
                    <option value="Section L">Section L - Instructions</option>
                    <option value="Section M">Section M - Evaluation Criteria</option>
                </select>
                <div class="flex gap-3">
                    <button type="button" onclick="closeAIModal()" class="flex-1 px-4 py-2 border border-gray-600 rounded hover:bg-gray-700">Cancel</button>
                    <button onclick="runAIExtraction()" class="flex-1 btn-primary px-4 py-2 rounded">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i>Extract Requirements
                    </button>
                </div>
                <div id="extractionResults" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg">
                    <h4 class="text-sm font-medium text-cyan-400 mb-2">Extracted Requirements:</h4>
                    <div id="extractedItems" class="space-y-2 text-sm max-h-60 overflow-y-auto"></div>
                    <button onclick="importExtracted()" class="mt-4 w-full btn-primary px-4 py-2 rounded text-sm">
                        <i class="fas fa-file-import mr-2"></i>Import All to Checklist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-cyan-500/10 mt-12 py-6 text-center text-xs text-gray-500">
        <p>AI GENERATED CONTENT - REQUIRES HUMAN REVIEW</p>
        <p class="mt-1">MissionPulse v2.0 | Mission Meets Tech | Shield & Pulse UX v8.0</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0MTc0NjMsImV4cCI6MjA1Mjk5MzQ2M30.GXfKRTONeK0kCHk9WJzJzeG3sEaH15uPlFwczw4MXCg';
        const API_URL = 'https://missionpulse-api.onrender.com';
        
        let supabase, currentUser = null;
        let opportunities = [], profiles = [], checklists = [], items = [];
        let extractedRequirements = [];

        // Demo Data
        const demoOpportunities = [
            { id: 'o1', title: 'VA EHR Modernization', stage: 'Proposal' },
            { id: 'o2', title: 'DHA Cybersecurity Support', stage: 'Capture' },
            { id: 'o3', title: 'CMS Data Analytics', stage: 'Pursuit' }
        ];
        const demoProfiles = [
            { id: 'u1', full_name: 'Mary Womack', email: 'mary@mmt.com', role: 'CEO' },
            { id: 'u2', full_name: 'Sarah Miller', email: 'sarah@mmt.com', role: 'Capture Manager' },
            { id: 'u3', full_name: 'Mike Torres', email: 'mike@mmt.com', role: 'Solution Architect' }
        ];
        const demoChecklists = [
            { id: 'cl1', opportunity_id: 'o1', name: 'Section L - Proposal Instructions', rfp_section: 'Section L', total_items: 8, completed_items: 5 },
            { id: 'cl2', opportunity_id: 'o1', name: 'Section M - Evaluation Factors', rfp_section: 'Section M', total_items: 6, completed_items: 2 }
        ];
        const demoItems = [
            { id: 'i1', checklist_id: 'cl1', requirement_text: 'Technical Approach shall not exceed 30 pages', requirement_ref: 'L.5.2.1', priority: 'Critical', status: 'Compliant', proposal_section: 'Vol II', page_limit: 30 },
            { id: 'i2', checklist_id: 'cl1', requirement_text: 'Include organizational chart showing key personnel', requirement_ref: 'L.5.2.3', priority: 'High', status: 'Draft Complete', proposal_section: 'Vol II, Tab B', assigned_to: 'u2' },
            { id: 'i3', checklist_id: 'cl1', requirement_text: 'Past Performance volume limited to 5 pages per reference', requirement_ref: 'L.5.3.1', priority: 'High', status: 'In Progress', proposal_section: 'Vol III', page_limit: 5 },
            { id: 'i4', checklist_id: 'cl1', requirement_text: 'Cost/Price volume shall include BOE for all labor categories', requirement_ref: 'L.5.4.2', priority: 'Critical', status: 'Compliant', proposal_section: 'Vol IV' },
            { id: 'i5', checklist_id: 'cl1', requirement_text: 'Submit SF-33 as cover page', requirement_ref: 'L.4.1', priority: 'Medium', status: 'Compliant', proposal_section: 'Vol I' },
            { id: 'i6', checklist_id: 'cl1', requirement_text: 'All volumes must use 12pt Times New Roman', requirement_ref: 'L.3.2', priority: 'Medium', status: 'Compliant', proposal_section: 'All' },
            { id: 'i7', checklist_id: 'cl1', requirement_text: 'Include Section 508 compliance statement', requirement_ref: 'L.5.2.8', priority: 'Low', status: 'Not Started', proposal_section: 'Vol II' },
            { id: 'i8', checklist_id: 'cl1', requirement_text: 'Provide transition plan for incumbent takeover', requirement_ref: 'L.5.2.6', priority: 'High', status: 'Compliant', proposal_section: 'Vol II, Tab D' },
            { id: 'i9', checklist_id: 'cl2', requirement_text: 'Technical Approach - Understanding of Requirements (25%)', requirement_ref: 'M.2.1', priority: 'Critical', status: 'In Progress', proposal_section: 'Vol II' },
            { id: 'i10', checklist_id: 'cl2', requirement_text: 'Management Approach - Staffing Plan (20%)', requirement_ref: 'M.2.2', priority: 'Critical', status: 'Draft Complete', proposal_section: 'Vol II, Tab B' },
            { id: 'i11', checklist_id: 'cl2', requirement_text: 'Past Performance - Relevancy and Quality (30%)', requirement_ref: 'M.2.3', priority: 'Critical', status: 'Not Started', proposal_section: 'Vol III' },
            { id: 'i12', checklist_id: 'cl2', requirement_text: 'Price - Reasonableness and Realism (25%)', requirement_ref: 'M.2.4', priority: 'Critical', status: 'Not Started', proposal_section: 'Vol IV' },
            { id: 'i13', checklist_id: 'cl2', requirement_text: 'Small Business Participation Plan', requirement_ref: 'M.3.1', priority: 'Medium', status: 'Compliant', proposal_section: 'Vol I' },
            { id: 'i14', checklist_id: 'cl2', requirement_text: 'Security Clearance Verification', requirement_ref: 'M.3.2', priority: 'High', status: 'Compliant', proposal_section: 'Vol I' }
        ];

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data: { session } } = await supabase.auth.getSession();
                if (session?.user) {
                    currentUser = session.user;
                    const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
                    if (profile) document.getElementById('userRole').textContent = `${profile.full_name || profile.email} (${profile.role || 'User'})`;
                }
                await loadSupabaseData();
                updateStatus('connected', 'Live');
            } catch (e) {
                console.log('Demo mode:', e.message);
                useDemoData();
                updateStatus('demo', 'Demo Mode');
            }
            populateOpportunities();
            populateAssignees();
        }

        async function loadSupabaseData() {
            const [opRes, profRes] = await Promise.all([
                supabase.from('opportunities').select('id, title, stage').order('title'),
                supabase.from('profiles').select('id, full_name, email, role').order('full_name')
            ]);
            opportunities = opRes.data?.length ? opRes.data : demoOpportunities;
            profiles = profRes.data?.length ? profRes.data : demoProfiles;
        }

        function useDemoData() {
            opportunities = demoOpportunities;
            profiles = demoProfiles;
            checklists = demoChecklists;
            items = demoItems;
        }

        function updateStatus(type, text) {
            const el = document.getElementById('connectionStatus');
            el.className = type === 'connected' 
                ? 'text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400'
                : 'text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            el.innerHTML = `<i class="fas fa-circle text-[8px] mr-1"></i> ${text}`;
        }

        function populateOpportunities() {
            const select = document.getElementById('opportunitySelect');
            opportunities.forEach(o => {
                select.innerHTML += `<option value="${o.id}">${o.title}</option>`;
            });
        }

        function populateAssignees() {
            const select = document.getElementById('itemAssigned');
            profiles.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.full_name || p.email}</option>`;
            });
        }

        async function loadChecklists() {
            const oppId = document.getElementById('opportunitySelect').value;
            if (!oppId) {
                document.getElementById('checklistsContainer').innerHTML = `
                    <div class="glass-card rounded-lg p-8 text-center text-gray-500">
                        <i class="fas fa-clipboard-list text-4xl mb-4 opacity-50"></i>
                        <p>Select an opportunity to view compliance checklists</p>
                    </div>`;
                updateScoreCards([]);
                return;
            }

            try {
                const { data: clData } = await supabase.from('compliance_checklists').select('*').eq('opportunity_id', oppId);
                checklists = clData?.length ? clData : demoChecklists.filter(c => c.opportunity_id === oppId);
                
                const checklistIds = checklists.map(c => c.id);
                if (checklistIds.length) {
                    const { data: itemData } = await supabase.from('compliance_checklist_items').select('*').in('checklist_id', checklistIds);
                    items = itemData?.length ? itemData : demoItems.filter(i => checklistIds.includes(i.checklist_id));
                } else {
                    items = demoItems.filter(i => demoChecklists.filter(c => c.opportunity_id === oppId).map(c => c.id).includes(i.checklist_id));
                }
            } catch (e) {
                checklists = demoChecklists.filter(c => c.opportunity_id === oppId);
                items = demoItems.filter(i => checklists.map(c => c.id).includes(i.checklist_id));
            }

            renderChecklists();
            updateScoreCards(items);
        }

        function updateScoreCards(allItems) {
            const total = allItems.length;
            const compliant = allItems.filter(i => i.status === 'Compliant').length;
            const critical = allItems.filter(i => i.priority === 'Critical' && i.status !== 'Compliant' && i.status !== 'N/A').length;
            const score = total ? Math.round((compliant / total) * 100) : 0;

            document.getElementById('overallScore').textContent = total ? `${score}%` : '--';
            document.getElementById('totalItems').textContent = total;
            document.getElementById('compliantItems').textContent = compliant;
            document.getElementById('criticalItems').textContent = critical;
        }

        function renderChecklists() {
            const container = document.getElementById('checklistsContainer');
            if (!checklists.length) {
                container.innerHTML = `
                    <div class="glass-card rounded-lg p-8 text-center text-gray-500">
                        <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                        <p>No checklists yet. Create one to start tracking compliance.</p>
                    </div>`;
                return;
            }

            container.innerHTML = checklists.map(cl => {
                const clItems = items.filter(i => i.checklist_id === cl.id);
                const compliant = clItems.filter(i => i.status === 'Compliant').length;
                const score = clItems.length ? Math.round((compliant / clItems.length) * 100) : 0;
                const sectionClass = cl.rfp_section?.includes('L') ? 'section-l' : cl.rfp_section?.includes('M') ? 'section-m' : cl.rfp_section?.includes('C') ? 'section-c' : 'section-h';

                return `
                    <div class="glass-card rounded-lg overflow-hidden ${sectionClass}">
                        <div class="p-4 bg-cyan-500/5 flex items-center justify-between">
                            <div>
                                <h3 class="font-medium text-white">${cl.name}</h3>
                                <p class="text-xs text-gray-400">${cl.rfp_section || 'General'} â€¢ ${clItems.length} requirements</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <div class="text-xl font-bold ${score >= 80 ? 'text-green-400' : score >= 50 ? 'text-yellow-400' : 'text-red-400'}">${score}%</div>
                                    <div class="text-xs text-gray-500">${compliant}/${clItems.length} compliant</div>
                                </div>
                                <button onclick="openItemModal('${cl.id}')" class="btn-primary px-3 py-1 rounded text-xs">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                                <button onclick="deleteChecklist('${cl.id}')" class="text-red-400 hover:text-red-300 text-sm"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="divide-y divide-gray-700/30">
                            ${clItems.length ? clItems.map(item => renderItem(item)).join('') : '<div class="p-4 text-center text-gray-500 text-sm">No requirements added yet</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderItem(item) {
            const priorityClass = `priority-${item.priority.toLowerCase()}`;
            const statusClass = `status-${item.status.toLowerCase().replace(/\s+/g, '-')}`;
            const assignee = profiles.find(p => p.id === item.assigned_to);
            
            return `
                <div class="p-4 hover:bg-cyan-500/5 ${priorityClass}" onclick="editItem('${item.id}')">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs text-cyan-400 font-mono">${item.requirement_ref || '-'}</span>
                                <span class="status-badge ${statusClass}">${item.status}</span>
                                ${item.page_limit ? `<span class="text-xs text-gray-500">${item.page_limit} pg limit</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-200 line-clamp-2">${item.requirement_text}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                ${item.proposal_section ? `<span><i class="fas fa-file-alt mr-1"></i>${item.proposal_section}</span>` : ''}
                                ${assignee ? `<span><i class="fas fa-user mr-1"></i>${assignee.full_name || assignee.email}</span>` : ''}
                                ${item.due_date ? `<span><i class="fas fa-calendar mr-1"></i>${item.due_date}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); quickStatus('${item.id}')" class="text-cyan-400 hover:text-cyan-300" title="Change Status">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal Functions
        function openChecklistModal() {
            if (!document.getElementById('opportunitySelect').value) {
                alert('Please select an opportunity first');
                return;
            }
            document.getElementById('checklistModal').classList.remove('hidden');
        }

        function closeChecklistModal() {
            document.getElementById('checklistModal').classList.add('hidden');
        }

        async function saveChecklist(e) {
            e.preventDefault();
            const oppId = document.getElementById('opportunitySelect').value;
            const data = {
                opportunity_id: oppId,
                name: document.getElementById('checklistName').value,
                rfp_section: document.getElementById('checklistSection').value,
                total_items: 0,
                completed_items: 0
            };

            try {
                const { data: newCl } = await supabase.from('compliance_checklists').insert([data]).select().single();
                if (newCl) checklists.push(newCl);
                else checklists.push({ id: 'cl' + Date.now(), ...data });
            } catch (e) {
                checklists.push({ id: 'cl' + Date.now(), ...data });
            }

            closeChecklistModal();
            document.getElementById('checklistForm').reset();
            renderChecklists();
        }

        async function deleteChecklist(id) {
            if (!confirm('Delete this checklist and all its items?')) return;
            try {
                await supabase.from('compliance_checklists').delete().eq('id', id);
            } catch (e) {}
            checklists = checklists.filter(c => c.id !== id);
            items = items.filter(i => i.checklist_id !== id);
            renderChecklists();
            updateScoreCards(items);
        }

        function openItemModal(checklistId) {
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemChecklistId').value = checklistId;
            document.getElementById('itemModalTitle').textContent = 'Add Requirement';
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.add('hidden');
        }

        function editItem(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemChecklistId').value = item.checklist_id;
            document.getElementById('itemRequirement').value = item.requirement_text;
            document.getElementById('itemRef').value = item.requirement_ref || '';
            document.getElementById('itemProposalSection').value = item.proposal_section || '';
            document.getElementById('itemPriority').value = item.priority;
            document.getElementById('itemStatus').value = item.status;
            document.getElementById('itemPageLimit').value = item.page_limit || '';
            document.getElementById('itemAssigned').value = item.assigned_to || '';
            document.getElementById('itemDueDate').value = item.due_date || '';
            document.getElementById('itemEvidence').value = item.evidence_notes || '';
            document.getElementById('itemReviewerNotes').value = item.reviewer_notes || '';
            document.getElementById('itemModalTitle').textContent = 'Edit Requirement';
            document.getElementById('itemModal').classList.remove('hidden');
        }

        async function saveItem(e) {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const data = {
                checklist_id: document.getElementById('itemChecklistId').value,
                requirement_text: document.getElementById('itemRequirement').value,
                requirement_ref: document.getElementById('itemRef').value || null,
                proposal_section: document.getElementById('itemProposalSection').value || null,
                priority: document.getElementById('itemPriority').value,
                status: document.getElementById('itemStatus').value,
                page_limit: parseInt(document.getElementById('itemPageLimit').value) || null,
                assigned_to: document.getElementById('itemAssigned').value || null,
                due_date: document.getElementById('itemDueDate').value || null,
                evidence_notes: document.getElementById('itemEvidence').value || null,
                reviewer_notes: document.getElementById('itemReviewerNotes').value || null,
                updated_at: new Date().toISOString()
            };

            if (data.status === 'Compliant') data.completed_at = new Date().toISOString();

            try {
                if (id) {
                    await supabase.from('compliance_checklist_items').update(data).eq('id', id);
                    const idx = items.findIndex(i => i.id === id);
                    if (idx >= 0) items[idx] = { ...items[idx], ...data };
                } else {
                    const { data: newItem } = await supabase.from('compliance_checklist_items').insert([data]).select().single();
                    if (newItem) items.push(newItem);
                    else items.push({ id: 'i' + Date.now(), ...data });
                }
            } catch (e) {
                if (id) {
                    const idx = items.findIndex(i => i.id === id);
                    if (idx >= 0) items[idx] = { ...items[idx], ...data };
                } else {
                    items.push({ id: 'i' + Date.now(), ...data });
                }
            }

            closeItemModal();
            renderChecklists();
            updateScoreCards(items);
        }

        async function quickStatus(id) {
            event.stopPropagation();
            const item = items.find(i => i.id === id);
            if (!item) return;
            const statusOrder = ['Not Started', 'In Progress', 'Draft Complete', 'Reviewed', 'Compliant'];
            const currentIdx = statusOrder.indexOf(item.status);
            const nextStatus = statusOrder[(currentIdx + 1) % statusOrder.length];
            
            try {
                await supabase.from('compliance_checklist_items').update({ status: nextStatus }).eq('id', id);
            } catch (e) {}
            item.status = nextStatus;
            renderChecklists();
            updateScoreCards(items);
        }

        // AI Extraction
        function parseRFPRequirements() {
            if (!document.getElementById('opportunitySelect').value) {
                alert('Please select an opportunity first');
                return;
            }
            document.getElementById('aiExtractModal').classList.remove('hidden');
        }

        function closeAIModal() {
            document.getElementById('aiExtractModal').classList.add('hidden');
            document.getElementById('extractionResults').classList.add('hidden');
            document.getElementById('rfpText').value = '';
        }

        async function runAIExtraction() {
            const text = document.getElementById('rfpText').value.trim();
            if (!text) { alert('Please paste RFP text'); return; }

            const section = document.getElementById('extractSection').value;
            const resultsDiv = document.getElementById('extractedItems');
            resultsDiv.innerHTML = '<div class="text-cyan-400"><i class="fas fa-spinner fa-spin mr-2"></i>Analyzing RFP text...</div>';
            document.getElementById('extractionResults').classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Extract all compliance requirements from this ${section} text. Return as JSON array with objects containing: requirement_text, requirement_ref (if found), priority (Critical/High/Medium/Low), page_limit (if mentioned). Text:\n\n${text}`,
                        context: 'compliance_extraction'
                    })
                });
                const data = await response.json();
                
                // Try to parse JSON from response
                const jsonMatch = data.response?.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    extractedRequirements = JSON.parse(jsonMatch[0]);
                    resultsDiv.innerHTML = extractedRequirements.map((r, i) => `
                        <div class="p-2 bg-gray-700/50 rounded text-xs">
                            <span class="text-cyan-400">${r.requirement_ref || `#${i+1}`}</span>: ${r.requirement_text}
                            <span class="text-gray-500 ml-2">[${r.priority}]</span>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<div class="text-yellow-400">Could not parse requirements. Try with cleaner text.</div>';
                }
            } catch (e) {
                // Demo extraction
                extractedRequirements = [
                    { requirement_text: 'Technical volume shall not exceed 50 pages', requirement_ref: 'L.5.1', priority: 'Critical', page_limit: 50 },
                    { requirement_text: 'Include transition plan in Section 3', requirement_ref: 'L.5.2', priority: 'High' },
                    { requirement_text: 'Past performance references must be within 5 years', requirement_ref: 'L.6.1', priority: 'High' }
                ];
                resultsDiv.innerHTML = extractedRequirements.map((r, i) => `
                    <div class="p-2 bg-gray-700/50 rounded text-xs">
                        <span class="text-cyan-400">${r.requirement_ref || `#${i+1}`}</span>: ${r.requirement_text}
                        <span class="text-gray-500 ml-2">[${r.priority}]</span>
                    </div>
                `).join('') + '<div class="text-yellow-400 mt-2 text-xs">(Demo extraction - API unavailable)</div>';
            }
        }

        async function importExtracted() {
            if (!extractedRequirements.length) return;
            
            const section = document.getElementById('extractSection').value;
            const oppId = document.getElementById('opportunitySelect').value;
            
            // Find or create checklist
            let checklist = checklists.find(c => c.rfp_section === section);
            if (!checklist) {
                checklist = { id: 'cl' + Date.now(), opportunity_id: oppId, name: `${section} Requirements`, rfp_section: section };
                checklists.push(checklist);
                try {
                    const { data: newCl } = await supabase.from('compliance_checklists').insert([checklist]).select().single();
                    if (newCl) checklist = newCl;
                } catch (e) {}
            }

            // Add items
            for (const req of extractedRequirements) {
                const item = {
                    id: 'i' + Date.now() + Math.random().toString(36).substr(2, 5),
                    checklist_id: checklist.id,
                    requirement_text: req.requirement_text,
                    requirement_ref: req.requirement_ref,
                    priority: req.priority || 'Medium',
                    page_limit: req.page_limit,
                    status: 'Not Started'
                };
                items.push(item);
                try {
                    await supabase.from('compliance_checklist_items').insert([item]);
                } catch (e) {}
            }

            closeAIModal();
            renderChecklists();
            updateScoreCards(items);
        }

        init();
    </script>
</body>
</html>
