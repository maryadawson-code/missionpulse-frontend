<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v2.1 | AI Proposal Command Center</title>
  <meta name="description" content="Federal proposal management platform with 16 modules, 11-role RBAC, Shipley methodology, and AI agents">
  
  <!-- React & Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* === DESIGN TOKENS === */
    :root {
      --deep-navy: #00050F;
      --navy-900: #0A1628;
      --navy-800: #111C2E;
      --navy-700: #1A2942;
      --primary-cyan: #00E5FA;
      --primary-cyan-glow: rgba(0, 229, 250, 0.25);
      --success-teal: #00BDAE;
      --warning-amber: #F59E0B;
      --risk-coral: #EF4444;
      --text-primary: #FFFFFF;
      --text-secondary: #94A3B8;
      --text-tertiary: #64748B;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Space Grotesk', 'Inter', -apple-system, sans-serif;
      background: var(--deep-navy);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
    }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    .font-display { font-family: 'Space Grotesk', sans-serif; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
    ::-webkit-scrollbar-thumb { background: rgba(0, 229, 250, 0.3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0, 229, 250, 0.5); }
    
    /* Glass Panel */
    .glass-panel { 
      background: linear-gradient(135deg, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 229, 250, 0.15);
      border-radius: 12px;
    }
    .glass-card {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 229, 250, 0.12);
      border-radius: 12px;
    }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 5px var(--primary-cyan-glow); } 50% { box-shadow: 0 0 20px var(--primary-cyan-glow); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    .animate-slideInLeft { animation: slideInLeft 0.3s ease-out; }
    .animate-slideInRight { animation: slideInRight 0.3s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-pulseGlow { animation: pulseGlow 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-timerPulse { animation: timerPulse 1s ease-in-out infinite; }
    
    .shimmer {
      background: linear-gradient(90deg, transparent 0%, rgba(0,229,250,0.1) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    
    /* Sidebar */
    .sidebar-item {
      transition: all 0.2s ease;
    }
    .sidebar-item:hover {
      background: rgba(0, 229, 250, 0.1);
      border-left: 3px solid var(--primary-cyan);
    }
    .sidebar-item.active {
      background: rgba(0, 229, 250, 0.15);
      border-left: 3px solid var(--primary-cyan);
    }
    
    /* Status Indicators */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-live { background: var(--success-teal); box-shadow: 0 0 8px var(--success-teal); }
    .status-warning { background: var(--warning-amber); }
    .status-risk { background: var(--risk-coral); }
    
    /* Threat Level Badges */
    .threat-high { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; }
    .threat-medium { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; }
    .threat-low { background: linear-gradient(135deg, #22C55E, #16A34A); color: white; }
    
    /* Timer Display */
    .timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-shadow: 0 0 20px rgba(0, 229, 250, 0.5);
    }
    .timer-warning { color: #F59E0B; text-shadow: 0 0 20px rgba(245, 158, 11, 0.5); }
    .timer-critical { color: #EF4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
    
    /* AI Chat Widget */
    .chat-widget-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00E5FA, #00BDAE);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 229, 250, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .chat-widget-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(0, 229, 250, 0.6);
    }
    
    .chat-panel {
      position: fixed;
      bottom: 90px;
      right: 24px;
      width: 380px;
      height: 500px;
      background: var(--navy-900);
      border: 1px solid rgba(0, 229, 250, 0.2);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Pricing Calculator Styles */
    .rate-input {
      background: rgba(0, 229, 250, 0.05);
      border: 1px solid rgba(0, 229, 250, 0.2);
      border-radius: 6px;
      padding: 8px 12px;
      color: white;
      font-family: 'JetBrains Mono', monospace;
      width: 100%;
    }
    .rate-input:focus {
      outline: none;
      border-color: var(--primary-cyan);
      box-shadow: 0 0 0 2px rgba(0, 229, 250, 0.2);
    }
    
    /* Orals Studio Slide Preview */
    .slide-preview {
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #1E293B, #0F172A);
      border: 2px solid rgba(0, 229, 250, 0.2);
      border-radius: 12px;
      overflow: hidden;
    }
    .slide-preview.active {
      border-color: var(--primary-cyan);
      box-shadow: 0 0 20px rgba(0, 229, 250, 0.3);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar { 
        position: fixed;
        left: -280px;
        transition: left 0.3s ease;
        z-index: 100;
      }
      .sidebar.open { left: 0; }
      .chat-panel {
        width: calc(100vw - 32px);
        right: 16px;
        bottom: 80px;
        height: 60vh;
      }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
// ============================================================
// MISSIONPULSE v2.1 SPRINT 17 - ENHANCED MODULES
// 16 Modules | 11 Shipley Roles | Full RBAC | Supabase Integration
// Enhanced: M7 Black Hat, M8 Pricing Calculator, M10 Orals Studio
// Â© 2026 Mission Meets Tech
// ============================================================

const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

// ============================================================
// SUPABASE CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://qlbvbfaprymzdqywcsiq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsYnZiZmFwcnltemRxeXdjc2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NjQ4NjcsImV4cCI6MjA1MzM0MDg2N30.QEnpsflnMM9i9xvYPHJlJO7wGPazPTvTWSFIohHcA';
const API_URL = 'https://missionpulse-api.onrender.com';

let supabaseClient = null;
try {
  if (window.supabase) {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }
} catch (e) { console.warn('Supabase init failed, using demo data'); }

// ============================================================
// AUTHENTICATION CHECK
// ============================================================
const checkAuth = () => {
  const session = localStorage.getItem('MP_SESSION');
  const user = localStorage.getItem('MP_USER');
  if (!session || !user) {
    window.location.href = 'login.html';
    return null;
  }
  try {
    return JSON.parse(user);
  } catch {
    return null;
  }
};

const logout = () => {
  localStorage.removeItem('MP_SESSION');
  localStorage.removeItem('MP_USER');
  localStorage.removeItem('MP_USER_ROLE');
  if (supabaseClient) {
    supabaseClient.auth.signOut();
  }
  window.location.href = 'login.html';
};

// ============================================================
// RBAC MATRIX - 11 SHIPLEY ROLES
// ============================================================
const RBAC_MATRIX = {
  CEO:     ['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12','M13','M14','M15','M16'],
  COO:     ['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12','M13','M14','M15'],
  CAP:     ['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12','M15'],
  PM:      ['M2','M3','M4','M9','M12','M14','M15'],
  SA:      ['M2','M3','M4','M6','M9','M15'],
  FIN:     ['M2','M5','M8','M9','M13','M15'],
  CON:     ['M2','M4','M5','M9','M15'],
  DEL:     ['M2','M3','M14','M15'],
  QA:      ['M2','M4','M9','M12','M15'],
  Partner: ['M2','M3','M4'],
  Admin:   ['M1','M2','M3','M4','M5','M6','M7','M8','M9','M10','M11','M12','M13','M14','M15','M16']
};

const ROLES_CONFIG = [
  { id: 'CEO', name: 'CEO', fullName: 'Mary Womack', icon: 'ðŸ‘‘', color: '#fbbf24', shipley: 'Executive Approver' },
  { id: 'COO', name: 'COO', fullName: 'David Chen', icon: 'ðŸ“Š', color: '#f97316', shipley: 'Capture Oversight' },
  { id: 'CAP', name: 'Capture', fullName: 'Michael Torres', icon: 'ðŸŽ¯', color: '#f472b6', shipley: 'Capture Manager' },
  { id: 'PM', name: 'Proposal Mgr', fullName: 'Lisa Martinez', icon: 'ðŸ“‹', color: '#60a5fa', shipley: 'Proposal Manager' },
  { id: 'SA', name: 'Solution Arch', fullName: 'Sarah Chen', icon: 'ðŸ”§', color: '#22d3ee', shipley: 'Technical Lead' },
  { id: 'FIN', name: 'Pricing', fullName: 'Jennifer Park', icon: 'ðŸ’°', color: '#34d399', shipley: 'Volume Lead (Pricing)' },
  { id: 'CON', name: 'Compliance', fullName: 'Robert Williams', icon: 'âš–ï¸', color: '#a78bfa', shipley: 'Contracts/Compliance' },
  { id: 'DEL', name: 'Delivery', fullName: 'Amanda Foster', icon: 'ðŸš€', color: '#fb7185', shipley: 'Delivery/Staffing' },
  { id: 'QA', name: 'QA Lead', fullName: 'James Thompson', icon: 'âœ…', color: '#2dd4bf', shipley: 'Quality Assurance' },
  { id: 'Partner', name: 'Partner', fullName: 'External Team', icon: 'ðŸ¤', color: '#94a3b8', shipley: 'Teaming Partner' },
  { id: 'Admin', name: 'Admin', fullName: 'System Admin', icon: 'âš™ï¸', color: '#8b5cf6', shipley: 'System Admin' }
];

// ============================================================
// MODULE CONFIGURATION - 16 MODULES
// ============================================================
const MODULES = [
  { id: 'M1', key: 'pipeline', name: 'Pipeline Intelligence', icon: 'ðŸ“¡', desc: 'Opportunity radar, pWin scoring' },
  { id: 'M2', key: 'warroom', name: 'War Room', icon: 'ðŸŽ–ï¸', desc: 'Go/No-Go dashboard, capture status' },
  { id: 'M3', key: 'swimlane', name: 'Swimlane Board', icon: 'ðŸ“Š', desc: 'Kanban workflow tracking' },
  { id: 'M4', key: 'compliance', name: 'Compliance Matrix', icon: 'âœ…', desc: 'Section L/M requirements' },
  { id: 'M5', key: 'contracts', name: 'Contracts Intelligence', icon: 'ðŸ“œ', desc: 'FAR/DFARS analyzer' },
  { id: 'M6', key: 'irondome', name: 'Iron Dome', icon: 'ðŸ›¡ï¸', desc: 'Compliance shield, gap detection' },
  { id: 'M7', key: 'blackhat', name: 'Black Hat', icon: 'ðŸ•µï¸', desc: 'Competitor analysis' },
  { id: 'M8', key: 'pricing', name: 'Pricing Calculator', icon: 'ðŸ’µ', desc: 'BOE builder, labor rates' },
  { id: 'M9', key: 'hitl', name: 'HITL Review', icon: 'ðŸ‘¤', desc: 'Human-in-the-loop approval' },
  { id: 'M10', key: 'orals', name: 'Orals Studio', icon: 'ðŸŽ¤', desc: 'Presentation prep, Q&A sim' },
  { id: 'M11', key: 'frenemy', name: 'Frenemy Protocol', icon: 'ðŸ¤', desc: 'Teaming partner management' },
  { id: 'M12', key: 'launch', name: 'Launch Control', icon: 'ðŸš€', desc: 'Pre-submission checklist' },
  { id: 'M13', key: 'roi', name: 'ROI Calculator', icon: 'ðŸ“ˆ', desc: 'Pipeline analytics' },
  { id: 'M14', key: 'postaward', name: 'Post-Award', icon: 'ðŸ†', desc: 'Handoff checklist' },
  { id: 'M15', key: 'lessons', name: 'Lessons Playbook', icon: 'ðŸ“š', desc: 'Knowledge base' },
  { id: 'M16', key: 'admin', name: 'Admin Panel', icon: 'âš™ï¸', desc: 'User management, audit log' }
];

// ============================================================
// DEMO DATA (Offline Fallback)
// ============================================================
const DEMO_OPPORTUNITIES = [
  { id: 'OPP-001', name: 'DHA MHS GENESIS Cloud Migration', agency: 'Defense Health Agency', ceiling: 98450210, pWin: 72, phase: 'Blue Team', dueDate: '2026-03-01', setAside: 'Total SB', naics: '541512', priority: 'P-0' },
  { id: 'OPP-002', name: 'VA VistA Modernization Phase 3', agency: 'Veterans Affairs', ceiling: 156000000, pWin: 65, phase: 'Pink Team', dueDate: '2026-04-15', setAside: 'SDVOSB', naics: '541512', priority: 'P-1' },
  { id: 'OPP-003', name: 'CMS HCBS Quality Analytics', agency: 'Centers for Medicare', ceiling: 45200000, pWin: 58, phase: 'Gate 1', dueDate: '2026-05-20', setAside: '8(a)', naics: '541519', priority: 'P-2' },
  { id: 'OPP-004', name: 'IHS Telehealth Expansion', agency: 'Indian Health Service', ceiling: 78300000, pWin: 71, phase: 'Red Team', dueDate: '2026-02-28', setAside: 'HUBZone', naics: '541512', priority: 'P-0' },
  { id: 'OPP-005', name: 'CDC Data Modernization Initiative', agency: 'CDC', ceiling: 124500000, pWin: 48, phase: 'Gate 1', dueDate: '2026-06-30', setAside: 'Full & Open', naics: '541511', priority: 'P-3' },
  { id: 'OPP-006', name: 'HRSA Health IT Infrastructure', agency: 'HRSA', ceiling: 67800000, pWin: 62, phase: 'Pink Team', dueDate: '2026-04-01', setAside: 'WOSB', naics: '541512', priority: 'P-1' }
];

const DEMO_TEAM = [
  { id: 'T1', name: 'Mary Womack', role: 'CEO', status: 'active', avatar: 'ðŸ‘‘' },
  { id: 'T2', name: 'David Chen', role: 'COO', status: 'active', avatar: 'ðŸ“Š' },
  { id: 'T3', name: 'Michael Torres', role: 'CAP', status: 'active', avatar: 'ðŸŽ¯' },
  { id: 'T4', name: 'Lisa Martinez', role: 'PM', status: 'active', avatar: 'ðŸ“‹' },
  { id: 'T5', name: 'Sarah Chen', role: 'SA', status: 'busy', avatar: 'ðŸ”§' },
  { id: 'T6', name: 'Jennifer Park', role: 'FIN', status: 'active', avatar: 'ðŸ’°' },
  { id: 'T7', name: 'Robert Williams', role: 'CON', status: 'active', avatar: 'âš–ï¸' },
  { id: 'T8', name: 'Amanda Foster', role: 'DEL', status: 'away', avatar: 'ðŸš€' }
];

const COMPLIANCE_LIBRARY = [
  { ref: 'PWS 4.3.1', title: 'Health Data Interoperability', status: 'HIGH RISK', owner: 'SA' },
  { ref: 'PWS 5.1.2', title: 'Continuous ATO Framework', status: 'COMPLIANT', owner: 'CON' },
  { ref: 'PWS 6.2.4', title: 'Zero Trust Architecture', status: 'COMPLIANT', owner: 'SA' },
  { ref: 'PWS 3.7.1', title: 'Section 508 Accessibility', status: 'PARTIAL', owner: 'SA' },
  { ref: 'PWS 8.1.3', title: 'CUI Handling & Marking', status: 'HIGH RISK', owner: 'CON' }
];

// ============================================================
// M7 BLACK HAT DATA
// ============================================================
const DEMO_COMPETITORS = [
  {
    id: 'COMP-001',
    name: 'Leidos Health',
    threatLevel: 'HIGH',
    pWinEstimate: 72,
    strengths: [
      'Largest federal health IT contractor',
      'Incumbent on 3 DHA contracts',
      'Deep VA relationships',
      'Strong FHIR R4 expertise'
    ],
    weaknesses: [
      'High labor rates (GSA Ceiling)',
      'Recent GAO protest on similar contract',
      'Key PM left in Q3 2025',
      'No 8(a) status'
    ],
    ghostThemes: [
      'Unlike large primes with high overhead, MMT delivers agile, cost-effective solutions',
      'Our dedicated team provides continuity - no revolving door of personnel',
      'Small business agility means faster implementation without bureaucratic delays'
    ],
    recentWins: ['MHS GENESIS Wave 5', 'VA EHR Optimization'],
    recentLosses: ['IHS Telehealth RFP', 'CMS Quality Platform']
  },
  {
    id: 'COMP-002',
    name: 'Accenture Federal',
    threatLevel: 'HIGH',
    pWinEstimate: 68,
    strengths: [
      'Global consulting brand recognition',
      'Massive bench of healthcare consultants',
      'Strong analytics/AI capabilities',
      'Deep commercial healthcare experience'
    ],
    weaknesses: [
      'Limited small business teaming history',
      'High rates often non-competitive',
      'Perceived as "too big" for this scope',
      'Recent audit findings on timekeeping'
    ],
    ghostThemes: [
      'Mission-focused contractor vs. global conglomerate priorities',
      'GovCon-native understanding of FAR/DFARS compliance',
      'Direct executive access - not a small account in a large portfolio'
    ],
    recentWins: ['CMS Data Platform', 'HHS Modernization'],
    recentLosses: ['DHA Analytics', 'VA Mobile Health']
  },
  {
    id: 'COMP-003',
    name: 'Booz Allen Hamilton',
    threatLevel: 'MEDIUM',
    pWinEstimate: 55,
    strengths: [
      'Strong federal health track record',
      'Deep cybersecurity expertise',
      'Good HHS relationships',
      'Robust past performance'
    ],
    weaknesses: [
      'Overcommitted on current contracts',
      'Limited cloud-native health solutions',
      'Higher indirect rates',
      'Team often spread thin'
    ],
    ghostThemes: [
      'Dedicated team commitment - not competing for resources across contracts',
      'Cloud-native solutions from day one, not retrofitted legacy approaches',
      'Competitive pricing through efficient operations'
    ],
    recentWins: ['NIH Data Platform'],
    recentLosses: ['CDC Modernization', 'HRSA Analytics']
  },
  {
    id: 'COMP-004',
    name: 'CACI International',
    threatLevel: 'MEDIUM',
    pWinEstimate: 48,
    strengths: [
      'Strong federal presence',
      'Good small business teaming',
      'Solid technical capabilities',
      'Competitive pricing model'
    ],
    weaknesses: [
      'Limited health IT specialization',
      'No FHIR R4 implementations on record',
      'Key SME recently departed',
      'Stretched across too many bids'
    ],
    ghostThemes: [
      'Healthcare IT specialists vs. general federal contractors',
      'Proven FHIR R4 and interoperability expertise',
      'Stable team with deep domain knowledge'
    ],
    recentWins: ['DoD Health Analytics'],
    recentLosses: ['VA Telehealth', 'IHS EHR']
  },
  {
    id: 'COMP-005',
    name: 'General Dynamics IT',
    threatLevel: 'LOW',
    pWinEstimate: 35,
    strengths: [
      'Large contractor stability',
      'Good infrastructure experience',
      'Strong security credentials'
    ],
    weaknesses: [
      'Health IT not a focus area',
      'No recent federal health wins',
      'Heavy defense orientation',
      'Limited cloud health experience'
    ],
    ghostThemes: [
      'Healthcare mission expertise vs. general IT services',
      'Agile health solutions vs. traditional waterfall approaches',
      'Proven federal health outcomes, not theoretical capabilities'
    ],
    recentWins: [],
    recentLosses: ['Multiple HHS opportunities']
  }
];

// ============================================================
// M8 PRICING DATA (Based on BOE Model)
// ============================================================
const LABOR_CATEGORIES = [
  { id: 'PM-5', family: 'Program Management', level: 'Director', gsaLcat: 'Program Manager II', minRate: 129.35, targetRate: 168.55, maxRate: 207.75 },
  { id: 'PM-4', family: 'Program Management', level: 'Sr Manager', gsaLcat: 'Program Manager I', minRate: 103.48, targetRate: 122.56, maxRate: 141.65 },
  { id: 'PM-3', family: 'Program Management', level: 'Manager', gsaLcat: 'Project Manager II', minRate: 77.61, targetRate: 95.46, maxRate: 113.32 },
  { id: 'AC-3', family: 'Analytics/Cloud', level: 'Manager', gsaLcat: 'Data Scientist III', minRate: 129.35, targetRate: 154.38, maxRate: 179.42 },
  { id: 'AC-2', family: 'Analytics/Cloud', level: 'Sr Associate', gsaLcat: 'Data Scientist II', minRate: 86.23, targetRate: 118.66, maxRate: 151.09 },
  { id: 'TC-3', family: 'Technical/Cloud', level: 'Manager', gsaLcat: 'Systems Engineer III', minRate: 103.48, targetRate: 137.96, maxRate: 172.45 },
  { id: 'TC-2', family: 'Technical/Cloud', level: 'Sr Associate', gsaLcat: 'Systems Engineer II', minRate: 65.16, targetRate: 86.92, maxRate: 108.67 },
  { id: 'CI-3', family: 'Clinical Informatics', level: 'Manager', gsaLcat: 'Clinical Analyst III', minRate: 90.30, targetRate: 120.40, maxRate: 150.50 },
  { id: 'CI-2', family: 'Clinical Informatics', level: 'Sr Associate', gsaLcat: 'Clinical Analyst II', minRate: 72.24, targetRate: 96.32, maxRate: 120.40 }
];

const DEFAULT_INDIRECT_RATES = {
  fringe: 0.32,
  overhead: 0.15,
  gAndA: 0.08,
  fee: 0.10
};

const CONTRACT_PERIODS = [
  { id: 'trans', name: 'Transition', months: 3, hours: 513 },
  { id: 'base', name: 'Base Year', months: 12, hours: 2080 },
  { id: 'oy1', name: 'Option Year 1', months: 12, hours: 2080, escalation: 1.03 },
  { id: 'oy2', name: 'Option Year 2', months: 12, hours: 2080, escalation: 1.0609 },
  { id: 'oy3', name: 'Option Year 3', months: 12, hours: 2080, escalation: 1.092727 },
  { id: 'oy4', name: 'Option Year 4', months: 12, hours: 2080, escalation: 1.12550881 }
];

// ============================================================
// M10 ORALS DATA
// ============================================================
const ORALS_SLIDES = [
  { id: 1, title: 'Executive Summary', subtitle: 'Mission Overview & Value Proposition', duration: 180, notes: 'Lead with mission alignment, emphasize understanding of requirements' },
  { id: 2, title: 'Technical Approach', subtitle: 'Solution Architecture & Innovation', duration: 300, notes: 'FHIR R4 compliance, cloud-native design, interoperability' },
  { id: 3, title: 'Management Approach', subtitle: 'Program Governance & Risk Mitigation', duration: 240, notes: 'Shipley methodology, risk register, communication plan' },
  { id: 4, title: 'Key Personnel', subtitle: 'Team Expertise & Relevant Experience', duration: 180, notes: 'Highlight certifications, past performance on similar contracts' },
  { id: 5, title: 'Past Performance', subtitle: 'Proven Results & Client References', duration: 240, notes: 'Specific metrics, lessons learned, continuous improvement' },
  { id: 6, title: 'Q&A Session', subtitle: 'Evaluator Questions', duration: 600, notes: 'Prepare for technical deep-dives, pricing justification, staffing' }
];

const QA_QUESTIONS = [
  { id: 1, category: 'Technical', question: 'How will you ensure FHIR R4 compliance across legacy system integrations?', difficulty: 'hard' },
  { id: 2, category: 'Technical', question: 'Describe your approach to maintaining continuous ATO during the transition period.', difficulty: 'hard' },
  { id: 3, category: 'Management', question: 'How will you handle key personnel changes during contract performance?', difficulty: 'medium' },
  { id: 4, category: 'Management', question: 'What is your escalation path for critical issues?', difficulty: 'easy' },
  { id: 5, category: 'Pricing', question: 'Justify your labor mix - why this ratio of senior to junior staff?', difficulty: 'hard' },
  { id: 6, category: 'Past Performance', question: 'Describe a situation where you had to pivot your technical approach mid-project.', difficulty: 'medium' },
  { id: 7, category: 'Technical', question: 'How do you ensure Section 508 compliance in your healthcare analytics dashboards?', difficulty: 'medium' },
  { id: 8, category: 'Security', question: 'Walk us through your CUI handling procedures.', difficulty: 'hard' },
  { id: 9, category: 'Transition', question: 'What is your day-one readiness plan?', difficulty: 'medium' },
  { id: 10, category: 'Staffing', question: 'How will you ensure knowledge transfer if a key team member becomes unavailable?', difficulty: 'medium' }
];

const SCORING_RUBRIC = {
  categories: ['Technical Understanding', 'Communication Clarity', 'Confidence', 'Time Management', 'Q&A Responsiveness'],
  levels: [
    { score: 5, label: 'Outstanding', color: '#22C55E' },
    { score: 4, label: 'Good', color: '#00BDAE' },
    { score: 3, label: 'Acceptable', color: '#F59E0B' },
    { score: 2, label: 'Marginal', color: '#FB923C' },
    { score: 1, label: 'Unacceptable', color: '#EF4444' }
  ]
};

// ============================================================
// CONTEXT PROVIDERS
// ============================================================
const AppContext = createContext(null);

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
const formatCurrency = (value) => {
  if (!value) return '$0';
  if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
  if (value >= 1e6) return `$${(value / 1e6).toFixed(1)}M`;
  if (value >= 1e3) return `$${(value / 1e3).toFixed(0)}K`;
  return `$${value.toLocaleString()}`;
};

const formatTime = (seconds) => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
};

const getPwinColor = (pwin) => {
  if (pwin >= 70) return '#00BDAE';
  if (pwin >= 50) return '#F59E0B';
  return '#EF4444';
};

const getPhaseColor = (phase) => {
  const colors = {
    'Gate 1': '#6B7280',
    'Blue Team': '#3B82F6',
    'Pink Team': '#EC4899',
    'Red Team': '#EF4444',
    'Gold Team': '#F59E0B',
    'Submitted': '#10B981',
    'Awarded': '#8B5CF6'
  };
  return colors[phase] || '#6B7280';
};

const getThreatColor = (level) => {
  const colors = { HIGH: '#EF4444', MEDIUM: '#F59E0B', LOW: '#22C55E' };
  return colors[level] || '#6B7280';
};

// ============================================================
// ICONS
// ============================================================
const Icons = {
  menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
  x: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
  search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
  refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
  download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
  play: () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>,
  pause: () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" /></svg>,
  stop: () => <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z" /></svg>,
  chat: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
  send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
  check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
  alert: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
  arrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
  user: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
  settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
  logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
  database: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3M21 5v14c0 1.66-4 3-9 3s-9-1.34-9-3V5" /></svg>,
  target: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>,
  shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
  calculator: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
  mic: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
};

// ============================================================
// HEADER COMPONENT
// ============================================================
const Header = ({ sidebarOpen, setSidebarOpen, currentRole, setCurrentRole, opportunities, user }) => {
  const totalPipeline = opportunities.reduce((sum, o) => sum + (o.ceiling || 0), 0);
  
  return (
    <header className="h-16 bg-navy-900 border-b border-cyan-500/20 flex items-center justify-between px-4 lg:px-6" style={{ background: '#0A1628' }}>
      <div className="flex items-center gap-4">
        <button 
          onClick={() => setSidebarOpen(!sidebarOpen)}
          className="lg:hidden p-2 hover:bg-white/10 rounded-lg"
        >
          {sidebarOpen ? <Icons.x /> : <Icons.menu />}
        </button>
        
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center text-xl font-bold">
            M
          </div>
          <div className="hidden sm:block">
            <h1 className="font-display font-bold text-lg text-white">MissionPulse</h1>
            <p className="text-xs text-slate-400">AI Proposal Command Center</p>
          </div>
        </div>
      </div>
      
      <div className="flex items-center gap-4">
        {/* Pipeline Value */}
        <div className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
          <span className="text-xs text-slate-400">Pipeline</span>
          <span className="font-mono font-semibold text-cyan-400">{formatCurrency(totalPipeline)}</span>
        </div>
        
        {/* Supabase Status */}
        <div className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
          <Icons.database />
          <span className={`status-dot ${supabaseClient ? 'status-live' : 'status-warning'}`}></span>
          <span className="text-xs text-slate-400 hidden sm:inline">
            {supabaseClient ? 'Live' : 'Demo'}
          </span>
        </div>
        
        {/* Role Selector */}
        <select 
          value={currentRole}
          onChange={(e) => setCurrentRole(e.target.value)}
          className="bg-white/10 border border-white/20 rounded-lg px-3 py-1.5 text-sm text-white cursor-pointer hover:bg-white/20"
        >
          {ROLES_CONFIG.map(r => (
            <option key={r.id} value={r.id} className="bg-slate-800">
              {r.icon} {r.name}
            </option>
          ))}
        </select>
        
        {/* User Info & Logout */}
        <div className="flex items-center gap-2">
          <span className="hidden md:inline text-sm text-slate-300">{user?.email?.split('@')[0] || 'User'}</span>
          <button 
            onClick={logout}
            className="p-2 hover:bg-red-500/20 rounded-lg text-slate-400 hover:text-red-400 transition-colors"
            title="Logout"
          >
            <Icons.logout />
          </button>
        </div>
      </div>
    </header>
  );
};

// ============================================================
// SIDEBAR COMPONENT
// ============================================================
const Sidebar = ({ isOpen, currentModule, setCurrentModule, currentRole }) => {
  const allowedModules = RBAC_MATRIX[currentRole] || [];
  const visibleModules = MODULES.filter(m => allowedModules.includes(m.id));
  
  return (
    <aside className={`sidebar fixed lg:static w-64 h-[calc(100vh-64px)] border-r border-cyan-500/10 overflow-y-auto transition-all z-50 ${isOpen ? 'left-0' : '-left-64'} lg:left-0`} style={{ background: 'rgba(10, 22, 40, 0.95)' }}>
      <nav className="p-4 space-y-1">
        {visibleModules.map((module) => (
          <button
            key={module.id}
            onClick={() => setCurrentModule(module.id)}
            className={`sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-all ${
              currentModule === module.id 
                ? 'active bg-cyan-500/15 border-l-3 border-cyan-500' 
                : 'hover:bg-white/5 border-l-3 border-transparent'
            }`}
          >
            <span className="text-xl">{module.icon}</span>
            <div className="flex-1 min-w-0">
              <span className={`block text-sm font-medium ${currentModule === module.id ? 'text-cyan-400' : 'text-slate-300'}`}>
                {module.name}
              </span>
              <span className="block text-xs text-slate-500 truncate">{module.desc}</span>
            </div>
          </button>
        ))}
      </nav>
      
      {/* Role Info */}
      <div className="p-4 border-t border-white/10 mt-4">
        <div className="glass-card p-3">
          <div className="flex items-center gap-3">
            <span className="text-2xl">{ROLES_CONFIG.find(r => r.id === currentRole)?.icon}</span>
            <div>
              <p className="text-sm font-medium text-white">{ROLES_CONFIG.find(r => r.id === currentRole)?.fullName}</p>
              <p className="text-xs text-slate-400">{ROLES_CONFIG.find(r => r.id === currentRole)?.shipley}</p>
            </div>
          </div>
          <p className="text-xs text-slate-500 mt-2">
            {visibleModules.length} of 16 modules accessible
          </p>
        </div>
      </div>
    </aside>
  );
};

// ============================================================
// M1: PIPELINE MODULE
// ============================================================
const PipelineModule = ({ opportunities, onRefresh, loading }) => {
  return (
    <div className="animate-fadeIn">
      {/* Stats Row */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div className="glass-card p-4">
          <p className="text-xs text-slate-400 mb-1">Total Opportunities</p>
          <p className="text-2xl font-bold text-white">{opportunities.length}</p>
        </div>
        <div className="glass-card p-4">
          <p className="text-xs text-slate-400 mb-1">Pipeline Value</p>
          <p className="text-2xl font-bold text-cyan-400">{formatCurrency(opportunities.reduce((s,o) => s + (o.ceiling||0), 0))}</p>
        </div>
        <div className="glass-card p-4">
          <p className="text-xs text-slate-400 mb-1">Avg Win Probability</p>
          <p className="text-2xl font-bold text-teal-400">{Math.round(opportunities.reduce((s,o) => s + (o.pWin||50), 0) / (opportunities.length || 1))}%</p>
        </div>
        <div className="glass-card p-4">
          <p className="text-xs text-slate-400 mb-1">Active Pursuits</p>
          <p className="text-2xl font-bold text-amber-400">{opportunities.filter(o => o.phase !== 'Awarded' && o.phase !== 'Lost').length}</p>
        </div>
      </div>
      
      {/* Refresh Button */}
      <div className="flex justify-end mb-4">
        <button 
          onClick={onRefresh}
          disabled={loading}
          className="flex items-center gap-2 px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition-colors disabled:opacity-50"
        >
          <span className={loading ? 'animate-spin' : ''}><Icons.refresh /></span>
          {loading ? 'Loading...' : 'Refresh Data'}
        </button>
      </div>
      
      {/* Opportunities Table */}
      <div className="glass-panel overflow-hidden">
        <table className="w-full">
          <thead className="bg-white/5">
            <tr>
              <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">Opportunity</th>
              <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400 hidden md:table-cell">Agency</th>
              <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">Value</th>
              <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400">Win Prob</th>
              <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400 hidden lg:table-cell">Phase</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {opportunities.map((opp) => (
              <tr key={opp.id} className="hover:bg-white/5 cursor-pointer">
                <td className="px-4 py-3">
                  <p className="text-sm font-medium text-white">{opp.name}</p>
                  <p className="text-xs text-slate-500">{opp.id}</p>
                </td>
                <td className="px-4 py-3 text-sm text-slate-400 hidden md:table-cell">{opp.agency}</td>
                <td className="px-4 py-3 text-right font-mono text-sm text-cyan-400">{formatCurrency(opp.ceiling)}</td>
                <td className="px-4 py-3 text-center">
                  <span className="inline-flex items-center gap-1">
                    <span 
                      className="w-2 h-2 rounded-full" 
                      style={{ backgroundColor: getPwinColor(opp.pWin) }}
                    ></span>
                    <span className="font-mono text-sm" style={{ color: getPwinColor(opp.pWin) }}>{opp.pWin}%</span>
                  </span>
                </td>
                <td className="px-4 py-3 text-center hidden lg:table-cell">
                  <span 
                    className="px-2 py-1 text-xs font-medium rounded-full"
                    style={{ backgroundColor: `${getPhaseColor(opp.phase)}20`, color: getPhaseColor(opp.phase) }}
                  >
                    {opp.phase}
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// ============================================================
// M2: WAR ROOM MODULE
// ============================================================
const WarRoomModule = ({ opportunities }) => {
  const priorityOpps = opportunities.filter(o => o.priority === 'P-0' || o.priority === 'P-1');
  
  return (
    <div className="animate-fadeIn">
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Priority Opportunities */}
        <div className="lg:col-span-2 glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            ðŸŽ¯ Priority Pursuits
            <span className="px-2 py-0.5 text-xs bg-red-500/20 text-red-400 rounded">P-0/P-1</span>
          </h3>
          <div className="space-y-4">
            {priorityOpps.map(opp => (
              <div key={opp.id} className="bg-white/5 rounded-lg p-4 hover:bg-white/10 transition-colors">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h4 className="font-medium text-white">{opp.name}</h4>
                    <p className="text-sm text-slate-400">{opp.agency}</p>
                  </div>
                  <span className={`px-2 py-1 text-xs rounded ${opp.priority === 'P-0' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}`}>
                    {opp.priority}
                  </span>
                </div>
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-cyan-400 font-mono">{formatCurrency(opp.ceiling)}</span>
                  <span style={{ color: getPwinColor(opp.pWin) }}>{opp.pWin}% pWin</span>
                  <span className="text-slate-500">Due: {opp.dueDate}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
        
        {/* Team Status */}
        <div className="glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-4">Team Status</h3>
          <div className="space-y-3">
            {DEMO_TEAM.map(member => (
              <div key={member.id} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{member.avatar}</span>
                  <div>
                    <p className="text-sm font-medium text-white">{member.name}</p>
                    <p className="text-xs text-slate-400">{ROLES_CONFIG.find(r => r.id === member.role)?.shipley}</p>
                  </div>
                </div>
                <span className={`status-dot ${member.status === 'active' ? 'status-live' : member.status === 'busy' ? 'status-warning' : 'status-risk'}`}></span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

// ============================================================
// M3: SWIMLANE BOARD MODULE
// ============================================================
const SwimlaneModule = () => {
  const columns = ['Backlog', 'In Progress', 'Review', 'Complete'];
  const tasks = [
    { id: 1, title: 'Draft Executive Summary', col: 'In Progress', owner: 'PM', priority: 'high' },
    { id: 2, title: 'Technical Approach Vol 2', col: 'In Progress', owner: 'SA', priority: 'high' },
    { id: 3, title: 'Past Performance citations', col: 'Review', owner: 'CAP', priority: 'medium' },
    { id: 4, title: 'Pricing worksheet', col: 'Backlog', owner: 'FIN', priority: 'high' },
    { id: 5, title: 'Compliance matrix update', col: 'Complete', owner: 'CON', priority: 'medium' },
    { id: 6, title: 'Key personnel resumes', col: 'Review', owner: 'DEL', priority: 'low' }
  ];
  
  return (
    <div className="animate-fadeIn">
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 min-h-[500px]">
        {columns.map(col => (
          <div key={col} className="glass-panel p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-semibold text-white">{col}</h3>
              <span className="text-xs bg-white/10 px-2 py-1 rounded-full text-slate-400">
                {tasks.filter(t => t.col === col).length}
              </span>
            </div>
            <div className="space-y-3">
              {tasks.filter(t => t.col === col).map(task => (
                <div key={task.id} className="bg-white/5 rounded-lg p-3 hover:bg-white/10 cursor-move transition-colors">
                  <p className="text-sm font-medium text-white mb-2">{task.title}</p>
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-slate-400">{task.owner}</span>
                    <span className={`px-2 py-0.5 text-xs rounded ${
                      task.priority === 'high' ? 'bg-red-500/20 text-red-400' :
                      task.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                      'bg-slate-500/20 text-slate-400'
                    }`}>
                      {task.priority}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ============================================================
// M4: COMPLIANCE MATRIX MODULE
// ============================================================
const ComplianceModule = () => {
  return (
    <div className="animate-fadeIn space-y-6">
      <div className="grid grid-cols-3 gap-4">
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-teal-400">231</p>
          <p className="text-xs text-slate-400">Compliant</p>
        </div>
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-amber-400">12</p>
          <p className="text-xs text-slate-400">Partial</p>
        </div>
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-red-400">4</p>
          <p className="text-xs text-slate-400">High Risk</p>
        </div>
      </div>
      
      <div className="glass-panel overflow-hidden">
        <table className="w-full">
          <thead className="bg-white/5">
            <tr>
              <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">PWS Ref</th>
              <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">Requirement</th>
              <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400">Status</th>
              <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400">Owner</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/5">
            {COMPLIANCE_LIBRARY.map((req, idx) => (
              <tr key={idx} className="hover:bg-white/5">
                <td className="px-4 py-3 font-mono text-sm text-cyan-400">{req.ref}</td>
                <td className="px-4 py-3 text-sm text-white">{req.title}</td>
                <td className="px-4 py-3 text-center">
                  <span className={`px-2 py-1 text-xs font-medium rounded ${
                    req.status === 'COMPLIANT' ? 'bg-teal-500/20 text-teal-400' :
                    req.status === 'PARTIAL' ? 'bg-amber-500/20 text-amber-400' :
                    'bg-red-500/20 text-red-400'
                  }`}>
                    {req.status}
                  </span>
                </td>
                <td className="px-4 py-3 text-center text-sm text-slate-400">{req.owner}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

// ============================================================
// M7: BLACK HAT MODULE (ENHANCED)
// ============================================================
const BlackHatModule = () => {
  const [selectedCompetitor, setSelectedCompetitor] = useState(DEMO_COMPETITORS[0]);
  const [viewMode, setViewMode] = useState('cards'); // cards | matrix | ghost
  const [generatingGhost, setGeneratingGhost] = useState(false);
  
  const generateGhostText = async () => {
    setGeneratingGhost(true);
    // Simulate AI generation
    await new Promise(resolve => setTimeout(resolve, 1500));
    setGeneratingGhost(false);
  };
  
  return (
    <div className="animate-fadeIn space-y-6">
      {/* Header Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-red-400">{DEMO_COMPETITORS.filter(c => c.threatLevel === 'HIGH').length}</p>
          <p className="text-xs text-slate-400">High Threat</p>
        </div>
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-amber-400">{DEMO_COMPETITORS.filter(c => c.threatLevel === 'MEDIUM').length}</p>
          <p className="text-xs text-slate-400">Medium Threat</p>
        </div>
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-teal-400">{DEMO_COMPETITORS.filter(c => c.threatLevel === 'LOW').length}</p>
          <p className="text-xs text-slate-400">Low Threat</p>
        </div>
        <div className="glass-card p-4 text-center">
          <p className="text-3xl font-bold text-cyan-400">{DEMO_COMPETITORS.length}</p>
          <p className="text-xs text-slate-400">Total Tracked</p>
        </div>
      </div>
      
      {/* View Toggle */}
      <div className="flex gap-2">
        {[
          { id: 'cards', label: 'Competitor Cards', icon: 'ðŸŽ´' },
          { id: 'matrix', label: 'SWOT Matrix', icon: 'ðŸ“Š' },
          { id: 'ghost', label: 'Ghost Text', icon: 'ðŸ‘»' }
        ].map(view => (
          <button
            key={view.id}
            onClick={() => setViewMode(view.id)}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              viewMode === view.id 
                ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' 
                : 'bg-white/5 text-slate-400 hover:bg-white/10'
            }`}
          >
            {view.icon} {view.label}
          </button>
        ))}
      </div>
      
      {/* Competitor Cards View */}
      {viewMode === 'cards' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {DEMO_COMPETITORS.map(competitor => (
            <div 
              key={competitor.id}
              onClick={() => setSelectedCompetitor(competitor)}
              className={`glass-panel p-5 cursor-pointer transition-all hover:scale-[1.02] ${
                selectedCompetitor?.id === competitor.id ? 'ring-2 ring-cyan-500' : ''
              }`}
            >
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h3 className="font-semibold text-white text-lg">{competitor.name}</h3>
                  <p className="text-sm text-slate-400">Est. pWin: {competitor.pWinEstimate}%</p>
                </div>
                <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                  competitor.threatLevel === 'HIGH' ? 'threat-high' :
                  competitor.threatLevel === 'MEDIUM' ? 'threat-medium' : 'threat-low'
                }`}>
                  {competitor.threatLevel}
                </span>
              </div>
              
              <div className="space-y-3">
                <div>
                  <p className="text-xs text-teal-400 font-medium mb-1">Top Strengths</p>
                  <ul className="text-xs text-slate-300 space-y-1">
                    {competitor.strengths.slice(0, 2).map((s, i) => (
                      <li key={i} className="flex items-start gap-2">
                        <span className="text-teal-400">+</span> {s}
                      </li>
                    ))}
                  </ul>
                </div>
                <div>
                  <p className="text-xs text-red-400 font-medium mb-1">Key Weaknesses</p>
                  <ul className="text-xs text-slate-300 space-y-1">
                    {competitor.weaknesses.slice(0, 2).map((w, i) => (
                      <li key={i} className="flex items-start gap-2">
                        <span className="text-red-400">-</span> {w}
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
              
              <div className="mt-4 pt-3 border-t border-white/10 flex justify-between text-xs">
                <span className="text-teal-400">Wins: {competitor.recentWins.length}</span>
                <span className="text-red-400">Losses: {competitor.recentLosses.length}</span>
              </div>
            </div>
          ))}
        </div>
      )}
      
      {/* SWOT Matrix View */}
      {viewMode === 'matrix' && selectedCompetitor && (
        <div className="glass-panel p-6">
          <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-3">
            <Icons.target />
            {selectedCompetitor.name} - SWOT Analysis
            <span className={`px-3 py-1 text-xs font-bold rounded-full ${
              selectedCompetitor.threatLevel === 'HIGH' ? 'threat-high' :
              selectedCompetitor.threatLevel === 'MEDIUM' ? 'threat-medium' : 'threat-low'
            }`}>
              {selectedCompetitor.threatLevel} THREAT
            </span>
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Strengths */}
            <div className="bg-teal-500/10 border border-teal-500/30 rounded-lg p-4">
              <h4 className="text-teal-400 font-semibold mb-3 flex items-center gap-2">
                <span className="w-6 h-6 rounded bg-teal-500/20 flex items-center justify-center text-xs">S</span>
                Strengths
              </h4>
              <ul className="space-y-2">
                {selectedCompetitor.strengths.map((s, i) => (
                  <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                    <span className="text-teal-400 mt-1">âœ“</span> {s}
                  </li>
                ))}
              </ul>
            </div>
            
            {/* Weaknesses */}
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
              <h4 className="text-red-400 font-semibold mb-3 flex items-center gap-2">
                <span className="w-6 h-6 rounded bg-red-500/20 flex items-center justify-center text-xs">W</span>
                Weaknesses
              </h4>
              <ul className="space-y-2">
                {selectedCompetitor.weaknesses.map((w, i) => (
                  <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                    <span className="text-red-400 mt-1">âœ—</span> {w}
                  </li>
                ))}
              </ul>
            </div>
            
            {/* Recent Performance */}
            <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
              <h4 className="text-cyan-400 font-semibold mb-3 flex items-center gap-2">
                <span className="w-6 h-6 rounded bg-cyan-500/20 flex items-center justify-center text-xs">O</span>
                Recent Wins
              </h4>
              <ul className="space-y-2">
                {selectedCompetitor.recentWins.length > 0 ? selectedCompetitor.recentWins.map((w, i) => (
                  <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                    <span className="text-cyan-400 mt-1">ðŸ†</span> {w}
                  </li>
                )) : (
                  <li className="text-sm text-slate-500">No recent wins tracked</li>
                )}
              </ul>
            </div>
            
            {/* Recent Losses */}
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4">
              <h4 className="text-amber-400 font-semibold mb-3 flex items-center gap-2">
                <span className="w-6 h-6 rounded bg-amber-500/20 flex items-center justify-center text-xs">T</span>
                Recent Losses
              </h4>
              <ul className="space-y-2">
                {selectedCompetitor.recentLosses.length > 0 ? selectedCompetitor.recentLosses.map((l, i) => (
                  <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                    <span className="text-amber-400 mt-1">ðŸ“‰</span> {l}
                  </li>
                )) : (
                  <li className="text-sm text-slate-500">No recent losses tracked</li>
                )}
              </ul>
            </div>
          </div>
        </div>
      )}
      
      {/* Ghost Text Generator View */}
      {viewMode === 'ghost' && selectedCompetitor && (
        <div className="glass-panel p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="text-xl font-bold text-white flex items-center gap-3">
              ðŸ‘» Ghost Text Generator
              <span className="text-sm font-normal text-slate-400">Counter-positioning vs {selectedCompetitor.name}</span>
            </h3>
            <button
              onClick={generateGhostText}
              disabled={generatingGhost}
              className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg transition-all disabled:opacity-50"
            >
              {generatingGhost ? (
                <>
                  <span className="animate-spin">âš¡</span> Generating...
                </>
              ) : (
                <>ðŸª„ Generate New Themes</>
              )}
            </button>
          </div>
          
          <div className="space-y-4">
            {selectedCompetitor.ghostThemes.map((theme, i) => (
              <div key={i} className="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <span className="text-2xl">ðŸ’¬</span>
                  <div className="flex-1">
                    <p className="text-white italic">"{theme}"</p>
                    <div className="mt-3 flex gap-2">
                      <button className="text-xs px-3 py-1 bg-white/10 hover:bg-white/20 rounded text-slate-300 transition-colors">
                        Copy to Clipboard
                      </button>
                      <button className="text-xs px-3 py-1 bg-cyan-500/20 hover:bg-cyan-500/30 rounded text-cyan-400 transition-colors">
                        Add to Proposal
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
          
          <div className="mt-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg">
            <p className="text-xs text-amber-400 flex items-start gap-2">
              <span>âš ï¸</span>
              <span>Ghost text should highlight your strengths without explicitly naming competitors. Always review for compliance with FAR provisions before inclusion in proposals.</span>
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// M8: PRICING CALCULATOR MODULE (ENHANCED)
// ============================================================
const PricingModule = () => {
  const [laborRows, setLaborRows] = useState([
    { id: 1, lcatId: 'PM-5', role: 'Program Manager', rate: 168.55, ftes: { trans: 0.5, base: 1, oy1: 1, oy2: 1, oy3: 1, oy4: 1 } },
    { id: 2, lcatId: 'AC-3', role: 'Technical Lead', rate: 154.38, ftes: { trans: 0.5, base: 1, oy1: 1, oy2: 1, oy3: 1, oy4: 1 } },
    { id: 3, lcatId: 'AC-2', role: 'Data Scientist Sr', rate: 118.66, ftes: { trans: 0.5, base: 2, oy1: 2, oy2: 2, oy3: 2, oy4: 2 } },
    { id: 4, lcatId: 'CI-3', role: 'Clinical Analyst', rate: 120.40, ftes: { trans: 0.25, base: 0.5, oy1: 0.5, oy2: 0.5, oy3: 0.5, oy4: 0.5 } }
  ]);
  
  const [indirectRates, setIndirectRates] = useState(DEFAULT_INDIRECT_RATES);
  const [activeTab, setActiveTab] = useState('labor');
  
  // Calculate costs
  const calculatePeriodCost = (period, periodConfig) => {
    const hours = periodConfig.hours;
    const escalation = periodConfig.escalation || 1;
    
    let directLabor = 0;
    laborRows.forEach(row => {
      const fte = row.ftes[period.id] || 0;
      directLabor += row.rate * hours * fte * escalation;
    });
    
    const overhead = directLabor * indirectRates.overhead;
    const totalWithOH = directLabor + overhead;
    const gAndA = totalWithOH * indirectRates.gAndA;
    const totalCost = totalWithOH + gAndA;
    const fee = totalCost * indirectRates.fee;
    const totalPrice = totalCost + fee;
    
    return { directLabor, overhead, gAndA, totalCost, fee, totalPrice };
  };
  
  const periodCosts = CONTRACT_PERIODS.map(p => ({
    ...p,
    costs: calculatePeriodCost(p, p)
  }));
  
  const totalPrice = periodCosts.reduce((sum, p) => sum + p.costs.totalPrice, 0);
  const totalCost = periodCosts.reduce((sum, p) => sum + p.costs.totalCost, 0);
  const totalDirectLabor = periodCosts.reduce((sum, p) => sum + p.costs.directLabor, 0);
  
  const updateLaborRow = (id, field, value) => {
    setLaborRows(prev => prev.map(row => {
      if (row.id === id) {
        if (field.startsWith('fte_')) {
          const period = field.replace('fte_', '');
          return { ...row, ftes: { ...row.ftes, [period]: parseFloat(value) || 0 } };
        }
        return { ...row, [field]: value };
      }
      return row;
    }));
  };
  
  const addLaborRow = () => {
    const newId = Math.max(...laborRows.map(r => r.id)) + 1;
    setLaborRows([...laborRows, {
      id: newId,
      lcatId: 'TC-2',
      role: 'New Position',
      rate: 86.92,
      ftes: { trans: 0, base: 1, oy1: 1, oy2: 1, oy3: 1, oy4: 1 }
    }]);
  };
  
  const removeLaborRow = (id) => {
    if (laborRows.length > 1) {
      setLaborRows(laborRows.filter(r => r.id !== id));
    }
  };
  
  const exportCSV = () => {
    let csv = 'Role,Rate ID,Hourly Rate,Transition FTE,Base FTE,OY1 FTE,OY2 FTE,OY3 FTE,OY4 FTE\n';
    laborRows.forEach(row => {
      csv += `"${row.role}",${row.lcatId},${row.rate},${row.ftes.trans},${row.ftes.base},${row.ftes.oy1},${row.ftes.oy2},${row.ftes.oy3},${row.ftes.oy4}\n`;
    });
    csv += '\nSummary\n';
    csv += `Total Evaluated Price,${totalPrice.toFixed(2)}\n`;
    csv += `Total Cost,${totalCost.toFixed(2)}\n`;
    csv += `Total Direct Labor,${totalDirectLabor.toFixed(2)}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'MissionPulse_BOE_Export.csv';
    a.click();
  };
  
  return (
    <div className="animate-fadeIn space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="glass-card p-4 text-center border-l-4 border-cyan-500">
          <p className="text-xs text-slate-400 mb-1">Total Evaluated Price</p>
          <p className="text-2xl font-bold text-cyan-400 font-mono">{formatCurrency(totalPrice)}</p>
        </div>
        <div className="glass-card p-4 text-center border-l-4 border-teal-500">
          <p className="text-xs text-slate-400 mb-1">Total Cost</p>
          <p className="text-2xl font-bold text-teal-400 font-mono">{formatCurrency(totalCost)}</p>
        </div>
        <div className="glass-card p-4 text-center border-l-4 border-amber-500">
          <p className="text-xs text-slate-400 mb-1">Fee/Profit</p>
          <p className="text-2xl font-bold text-amber-400 font-mono">{formatCurrency(totalPrice - totalCost)}</p>
        </div>
        <div className="glass-card p-4 text-center border-l-4 border-purple-500">
          <p className="text-xs text-slate-400 mb-1">Fee % of Price</p>
          <p className="text-2xl font-bold text-purple-400 font-mono">{((1 - totalCost/totalPrice) * 100).toFixed(1)}%</p>
        </div>
      </div>
      
      {/* Tab Navigation */}
      <div className="flex gap-2 border-b border-white/10 pb-2">
        {['labor', 'indirect', 'summary'].map(tab => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${
              activeTab === tab ? 'bg-cyan-500/20 text-cyan-400' : 'text-slate-400 hover:text-white'
            }`}
          >
            {tab === 'labor' ? 'ðŸ‘¥ Labor Categories' : tab === 'indirect' ? 'ðŸ“Š Indirect Rates' : 'ðŸ“‹ Price Summary'}
          </button>
        ))}
        <div className="flex-1"></div>
        <button
          onClick={exportCSV}
          className="flex items-center gap-2 px-4 py-2 bg-teal-500/20 hover:bg-teal-500/30 text-teal-400 rounded-lg text-sm transition-colors"
        >
          <Icons.download /> Export CSV
        </button>
      </div>
      
      {/* Labor Tab */}
      {activeTab === 'labor' && (
        <div className="glass-panel overflow-x-auto">
          <table className="w-full min-w-[800px]">
            <thead className="bg-white/5">
              <tr>
                <th className="text-left px-3 py-3 text-xs font-semibold text-slate-400">Role</th>
                <th className="text-center px-3 py-3 text-xs font-semibold text-slate-400">LCAT</th>
                <th className="text-right px-3 py-3 text-xs font-semibold text-slate-400">Rate/Hr</th>
                {CONTRACT_PERIODS.map(p => (
                  <th key={p.id} className="text-center px-2 py-3 text-xs font-semibold text-slate-400">{p.name}</th>
                ))}
                <th className="w-10"></th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {laborRows.map(row => (
                <tr key={row.id} className="hover:bg-white/5">
                  <td className="px-3 py-2">
                    <input
                      type="text"
                      value={row.role}
                      onChange={(e) => updateLaborRow(row.id, 'role', e.target.value)}
                      className="rate-input text-sm w-40"
                    />
                  </td>
                  <td className="px-3 py-2 text-center">
                    <select
                      value={row.lcatId}
                      onChange={(e) => {
                        const lcat = LABOR_CATEGORIES.find(l => l.id === e.target.value);
                        updateLaborRow(row.id, 'lcatId', e.target.value);
                        if (lcat) updateLaborRow(row.id, 'rate', lcat.targetRate);
                      }}
                      className="rate-input text-xs w-20"
                    >
                      {LABOR_CATEGORIES.map(l => (
                        <option key={l.id} value={l.id}>{l.id}</option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-2">
                    <input
                      type="number"
                      step="0.01"
                      value={row.rate}
                      onChange={(e) => updateLaborRow(row.id, 'rate', parseFloat(e.target.value))}
                      className="rate-input text-sm w-24 text-right"
                    />
                  </td>
                  {CONTRACT_PERIODS.map(p => (
                    <td key={p.id} className="px-2 py-2 text-center">
                      <input
                        type="number"
                        step="0.25"
                        min="0"
                        value={row.ftes[p.id]}
                        onChange={(e) => updateLaborRow(row.id, `fte_${p.id}`, e.target.value)}
                        className="rate-input text-sm w-16 text-center"
                      />
                    </td>
                  ))}
                  <td className="px-2 py-2">
                    <button
                      onClick={() => removeLaborRow(row.id)}
                      className="text-red-400 hover:text-red-300 text-lg"
                    >
                      Ã—
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="p-4 border-t border-white/10">
            <button
              onClick={addLaborRow}
              className="px-4 py-2 bg-white/5 hover:bg-white/10 text-slate-300 rounded-lg text-sm transition-colors"
            >
              + Add Labor Category
            </button>
          </div>
        </div>
      )}
      
      {/* Indirect Rates Tab */}
      {activeTab === 'indirect' && (
        <div className="glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-6">Indirect Cost Build-Up</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {[
              { key: 'fringe', label: 'Fringe Benefits', icon: 'ðŸ‘¤' },
              { key: 'overhead', label: 'Overhead (OH)', icon: 'ðŸ¢' },
              { key: 'gAndA', label: 'G&A', icon: 'ðŸ“‹' },
              { key: 'fee', label: 'Fee/Profit', icon: 'ðŸ’°' }
            ].map(item => (
              <div key={item.key} className="bg-white/5 rounded-lg p-4">
                <label className="block text-sm text-slate-400 mb-2">{item.icon} {item.label}</label>
                <div className="flex items-center gap-2">
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    max="1"
                    value={indirectRates[item.key]}
                    onChange={(e) => setIndirectRates(prev => ({ ...prev, [item.key]: parseFloat(e.target.value) || 0 }))}
                    className="rate-input text-lg font-mono w-24"
                  />
                  <span className="text-2xl font-bold text-cyan-400">{(indirectRates[item.key] * 100).toFixed(0)}%</span>
                </div>
              </div>
            ))}
          </div>
          
          <div className="mt-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg">
            <p className="text-xs text-amber-400">
              âš ï¸ <strong>INTERNAL USE ONLY</strong> - Do not share indirect rates with teaming partners or competitors. 
              Rates should align with your approved provisional billing rates.
            </p>
          </div>
        </div>
      )}
      
      {/* Summary Tab */}
      {activeTab === 'summary' && (
        <div className="glass-panel overflow-x-auto">
          <table className="w-full">
            <thead className="bg-white/5">
              <tr>
                <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">Period</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">Direct Labor</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">Overhead</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">G&A</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">Total Cost</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-slate-400">Fee</th>
                <th className="text-right px-4 py-3 text-xs font-semibold text-cyan-400 font-bold">Total Price</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {periodCosts.map(p => (
                <tr key={p.id} className="hover:bg-white/5">
                  <td className="px-4 py-3 text-sm text-white font-medium">{p.name}</td>
                  <td className="px-4 py-3 text-sm text-slate-300 font-mono text-right">{formatCurrency(p.costs.directLabor)}</td>
                  <td className="px-4 py-3 text-sm text-slate-300 font-mono text-right">{formatCurrency(p.costs.overhead)}</td>
                  <td className="px-4 py-3 text-sm text-slate-300 font-mono text-right">{formatCurrency(p.costs.gAndA)}</td>
                  <td className="px-4 py-3 text-sm text-slate-300 font-mono text-right">{formatCurrency(p.costs.totalCost)}</td>
                  <td className="px-4 py-3 text-sm text-amber-400 font-mono text-right">{formatCurrency(p.costs.fee)}</td>
                  <td className="px-4 py-3 text-sm text-cyan-400 font-mono font-bold text-right">{formatCurrency(p.costs.totalPrice)}</td>
                </tr>
              ))}
              <tr className="bg-cyan-500/10 font-bold">
                <td className="px-4 py-3 text-sm text-white">TOTAL</td>
                <td className="px-4 py-3 text-sm text-white font-mono text-right">{formatCurrency(totalDirectLabor)}</td>
                <td className="px-4 py-3 text-sm text-white font-mono text-right">{formatCurrency(periodCosts.reduce((s,p) => s + p.costs.overhead, 0))}</td>
                <td className="px-4 py-3 text-sm text-white font-mono text-right">{formatCurrency(periodCosts.reduce((s,p) => s + p.costs.gAndA, 0))}</td>
                <td className="px-4 py-3 text-sm text-white font-mono text-right">{formatCurrency(totalCost)}</td>
                <td className="px-4 py-3 text-sm text-amber-400 font-mono text-right">{formatCurrency(totalPrice - totalCost)}</td>
                <td className="px-4 py-3 text-sm text-cyan-400 font-mono text-right">{formatCurrency(totalPrice)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

// ============================================================
// M10: ORALS STUDIO MODULE (ENHANCED)
// ============================================================
const OralsModule = () => {
  const [currentSlide, setCurrentSlide] = useState(0);
  const [timerRunning, setTimerRunning] = useState(false);
  const [timeRemaining, setTimeRemaining] = useState(ORALS_SLIDES[0].duration);
  const [totalTime, setTotalTime] = useState(0);
  const [mode, setMode] = useState('slides'); // slides | qa | scoring
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [answeredQuestions, setAnsweredQuestions] = useState([]);
  const [scores, setScores] = useState({});
  const timerRef = useRef(null);
  
  // Timer logic
  useEffect(() => {
    if (timerRunning && timeRemaining > 0) {
      timerRef.current = setInterval(() => {
        setTimeRemaining(prev => {
          if (prev <= 1) {
            // Auto-advance to next slide
            if (currentSlide < ORALS_SLIDES.length - 1) {
              setCurrentSlide(prev => prev + 1);
              return ORALS_SLIDES[currentSlide + 1].duration;
            }
            setTimerRunning(false);
            return 0;
          }
          return prev - 1;
        });
        setTotalTime(prev => prev + 1);
      }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [timerRunning, currentSlide, timeRemaining]);
  
  const startTimer = () => setTimerRunning(true);
  const pauseTimer = () => setTimerRunning(false);
  const resetTimer = () => {
    setTimerRunning(false);
    setTimeRemaining(ORALS_SLIDES[currentSlide].duration);
    setTotalTime(0);
  };
  
  const selectSlide = (index) => {
    setCurrentSlide(index);
    setTimeRemaining(ORALS_SLIDES[index].duration);
    setTimerRunning(false);
  };
  
  const generateQuestion = () => {
    const unanswered = QA_QUESTIONS.filter(q => !answeredQuestions.includes(q.id));
    if (unanswered.length > 0) {
      const random = unanswered[Math.floor(Math.random() * unanswered.length)];
      setCurrentQuestion(random);
    } else {
      setCurrentQuestion(null);
    }
  };
  
  const markAnswered = (questionId) => {
    setAnsweredQuestions(prev => [...prev, questionId]);
    setCurrentQuestion(null);
  };
  
  const updateScore = (category, score) => {
    setScores(prev => ({ ...prev, [category]: score }));
  };
  
  const getTimerClass = () => {
    const percentRemaining = timeRemaining / ORALS_SLIDES[currentSlide].duration;
    if (percentRemaining < 0.25) return 'timer-critical animate-timerPulse';
    if (percentRemaining < 0.5) return 'timer-warning';
    return 'text-cyan-400';
  };
  
  const averageScore = Object.keys(scores).length > 0 
    ? (Object.values(scores).reduce((a,b) => a+b, 0) / Object.keys(scores).length).toFixed(1)
    : 'N/A';
  
  return (
    <div className="animate-fadeIn space-y-6">
      {/* Mode Toggle */}
      <div className="flex gap-2">
        {[
          { id: 'slides', label: 'Presentation', icon: 'ðŸŽ¬' },
          { id: 'qa', label: 'Q&A Simulator', icon: 'â“' },
          { id: 'scoring', label: 'Scoring Rubric', icon: 'ðŸ“' }
        ].map(m => (
          <button
            key={m.id}
            onClick={() => setMode(m.id)}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              mode === m.id 
                ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' 
                : 'bg-white/5 text-slate-400 hover:bg-white/10'
            }`}
          >
            {m.icon} {m.label}
          </button>
        ))}
      </div>
      
      {/* Slides Mode */}
      {mode === 'slides' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Main Slide View */}
          <div className="lg:col-span-2 space-y-4">
            {/* Timer Display */}
            <div className="glass-panel p-6 text-center">
              <p className={`timer-display ${getTimerClass()}`}>
                {formatTime(timeRemaining)}
              </p>
              <p className="text-sm text-slate-400 mt-2">
                Slide {currentSlide + 1} of {ORALS_SLIDES.length} â€¢ Total: {formatTime(totalTime)}
              </p>
              
              <div className="flex justify-center gap-4 mt-4">
                {!timerRunning ? (
                  <button
                    onClick={startTimer}
                    className="flex items-center gap-2 px-6 py-3 bg-teal-500 hover:bg-teal-400 text-white rounded-lg transition-colors"
                  >
                    <Icons.play /> Start
                  </button>
                ) : (
                  <button
                    onClick={pauseTimer}
                    className="flex items-center gap-2 px-6 py-3 bg-amber-500 hover:bg-amber-400 text-white rounded-lg transition-colors"
                  >
                    <Icons.pause /> Pause
                  </button>
                )}
                <button
                  onClick={resetTimer}
                  className="flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                >
                  <Icons.stop /> Reset
                </button>
              </div>
            </div>
            
            {/* Current Slide Preview */}
            <div className="slide-preview active p-8 flex flex-col justify-center items-center">
              <span className="text-5xl mb-4">ðŸŽ¤</span>
              <h2 className="text-2xl font-bold text-white mb-2">{ORALS_SLIDES[currentSlide].title}</h2>
              <p className="text-slate-400">{ORALS_SLIDES[currentSlide].subtitle}</p>
            </div>
            
            {/* Speaker Notes */}
            <div className="glass-card p-4">
              <h4 className="text-xs font-semibold text-cyan-400 mb-2">SPEAKER NOTES</h4>
              <p className="text-sm text-slate-300">{ORALS_SLIDES[currentSlide].notes}</p>
            </div>
          </div>
          
          {/* Slide Navigator */}
          <div className="glass-panel p-4">
            <h3 className="text-sm font-semibold text-white mb-4">Slide Navigator</h3>
            <div className="space-y-2">
              {ORALS_SLIDES.map((slide, idx) => (
                <button
                  key={slide.id}
                  onClick={() => selectSlide(idx)}
                  className={`w-full p-3 rounded-lg text-left transition-all ${
                    currentSlide === idx 
                      ? 'bg-cyan-500/20 border border-cyan-500/30' 
                      : 'bg-white/5 hover:bg-white/10'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <span className={`text-sm font-medium ${currentSlide === idx ? 'text-cyan-400' : 'text-white'}`}>
                      {slide.title}
                    </span>
                    <span className="text-xs text-slate-500">{formatTime(slide.duration)}</span>
                  </div>
                  <p className="text-xs text-slate-500 mt-1">{slide.subtitle}</p>
                </button>
              ))}
            </div>
          </div>
        </div>
      )}
      
      {/* Q&A Simulator Mode */}
      {mode === 'qa' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="glass-panel p-6">
            <h3 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
              â“ Question Simulator
              <span className="text-xs bg-white/10 px-2 py-1 rounded-full text-slate-400">
                {answeredQuestions.length}/{QA_QUESTIONS.length} answered
              </span>
            </h3>
            
            {currentQuestion ? (
              <div className="space-y-4">
                <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 rounded-lg p-6">
                  <div className="flex items-start gap-3">
                    <span className="text-3xl">ðŸ’­</span>
                    <div>
                      <span className={`text-xs px-2 py-0.5 rounded mb-2 inline-block ${
                        currentQuestion.difficulty === 'hard' ? 'bg-red-500/20 text-red-400' :
                        currentQuestion.difficulty === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                        'bg-teal-500/20 text-teal-400'
                      }`}>
                        {currentQuestion.difficulty.toUpperCase()} â€¢ {currentQuestion.category}
                      </span>
                      <p className="text-white text-lg mt-2">"{currentQuestion.question}"</p>
                    </div>
                  </div>
                </div>
                
                <div className="flex gap-3">
                  <button
                    onClick={() => markAnswered(currentQuestion.id)}
                    className="flex-1 px-4 py-3 bg-teal-500 hover:bg-teal-400 text-white rounded-lg transition-colors"
                  >
                    âœ“ Mark Answered
                  </button>
                  <button
                    onClick={generateQuestion}
                    className="px-4 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                  >
                    Skip â†’
                  </button>
                </div>
              </div>
            ) : (
              <div className="text-center py-8">
                <span className="text-5xl mb-4 block">ðŸŽ¯</span>
                <p className="text-slate-400 mb-4">
                  {answeredQuestions.length === QA_QUESTIONS.length 
                    ? 'All questions completed! Great practice session.' 
                    : 'Ready to practice? Click below to get a random question.'}
                </p>
                {answeredQuestions.length < QA_QUESTIONS.length && (
                  <button
                    onClick={generateQuestion}
                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg transition-all"
                  >
                    ðŸŽ² Generate Question
                  </button>
                )}
              </div>
            )}
          </div>
          
          <div className="glass-panel p-6">
            <h3 className="text-lg font-semibold text-white mb-4">Question Bank</h3>
            <div className="space-y-2 max-h-[500px] overflow-y-auto">
              {QA_QUESTIONS.map(q => (
                <div 
                  key={q.id}
                  className={`p-3 rounded-lg ${
                    answeredQuestions.includes(q.id) 
                      ? 'bg-teal-500/10 border border-teal-500/20' 
                      : 'bg-white/5'
                  }`}
                >
                  <div className="flex items-start justify-between gap-2">
                    <p className="text-sm text-white flex-1">{q.question}</p>
                    {answeredQuestions.includes(q.id) && (
                      <span className="text-teal-400 text-lg">âœ“</span>
                    )}
                  </div>
                  <div className="flex items-center gap-2 mt-2">
                    <span className="text-xs bg-white/10 px-2 py-0.5 rounded text-slate-400">{q.category}</span>
                    <span className={`text-xs px-2 py-0.5 rounded ${
                      q.difficulty === 'hard' ? 'bg-red-500/20 text-red-400' :
                      q.difficulty === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                      'bg-teal-500/20 text-teal-400'
                    }`}>
                      {q.difficulty}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
      
      {/* Scoring Mode */}
      {mode === 'scoring' && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 glass-panel p-6">
            <h3 className="text-lg font-semibold text-white mb-6">Evaluator Scoring Rubric</h3>
            
            <div className="space-y-6">
              {SCORING_RUBRIC.categories.map(category => (
                <div key={category} className="bg-white/5 rounded-lg p-4">
                  <h4 className="text-sm font-medium text-white mb-3">{category}</h4>
                  <div className="flex gap-2">
                    {SCORING_RUBRIC.levels.map(level => (
                      <button
                        key={level.score}
                        onClick={() => updateScore(category, level.score)}
                        className={`flex-1 py-3 rounded-lg text-sm font-medium transition-all ${
                          scores[category] === level.score
                            ? 'ring-2 ring-white'
                            : 'hover:opacity-80'
                        }`}
                        style={{ 
                          backgroundColor: `${level.color}20`, 
                          color: level.color,
                          borderColor: scores[category] === level.score ? level.color : 'transparent',
                          borderWidth: 2
                        }}
                      >
                        {level.score} - {level.label}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
          
          <div className="glass-panel p-6">
            <h3 className="text-lg font-semibold text-white mb-4">Score Summary</h3>
            
            <div className="text-center py-6 mb-6 bg-gradient-to-br from-cyan-500/20 to-teal-500/20 rounded-lg border border-cyan-500/30">
              <p className="text-xs text-slate-400 mb-1">Average Score</p>
              <p className="text-5xl font-bold text-cyan-400">{averageScore}</p>
              <p className="text-sm text-slate-400 mt-2">of 5.0</p>
            </div>
            
            <div className="space-y-3">
              {SCORING_RUBRIC.categories.map(cat => (
                <div key={cat} className="flex items-center justify-between">
                  <span className="text-sm text-slate-400">{cat}</span>
                  <span className="font-mono text-white">{scores[cat] || '-'}</span>
                </div>
              ))}
            </div>
            
            <button
              onClick={() => setScores({})}
              className="w-full mt-6 px-4 py-2 bg-white/5 hover:bg-white/10 text-slate-400 rounded-lg text-sm transition-colors"
            >
              Reset Scores
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// GENERIC MODULE PLACEHOLDER
// ============================================================
const GenericModule = ({ module }) => (
  <div className="animate-fadeIn">
    <div className="glass-panel p-8 text-center">
      <span className="text-6xl mb-4 block">{module.icon}</span>
      <h2 className="text-2xl font-bold text-white mb-2">{module.name}</h2>
      <p className="text-slate-400 mb-6">{module.desc}</p>
      <div className="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg">
        <span className="status-dot status-live"></span>
        Module Active
      </div>
    </div>
  </div>
);

// ============================================================
// M16: ADMIN PANEL
// ============================================================
const AdminModule = ({ opportunities }) => {
  const [activeTab, setActiveTab] = useState('users');
  
  return (
    <div className="animate-fadeIn space-y-6">
      <div className="flex gap-2 border-b border-white/10 pb-2">
        {['users', 'audit', 'tokens', 'settings'].map(tab => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${
              activeTab === tab ? 'bg-cyan-500/20 text-cyan-400' : 'text-slate-400 hover:text-white'
            }`}
          >
            {tab.charAt(0).toUpperCase() + tab.slice(1)}
          </button>
        ))}
      </div>
      
      {activeTab === 'users' && (
        <div className="glass-panel overflow-hidden">
          <table className="w-full">
            <thead className="bg-white/5">
              <tr>
                <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">User</th>
                <th className="text-left px-4 py-3 text-xs font-semibold text-slate-400">Role</th>
                <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400">Status</th>
                <th className="text-center px-4 py-3 text-xs font-semibold text-slate-400">Last Active</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {DEMO_TEAM.map(user => (
                <tr key={user.id} className="hover:bg-white/5">
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-3">
                      <span className="text-xl">{user.avatar}</span>
                      <span className="text-white">{user.name}</span>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-slate-400">{user.role}</td>
                  <td className="px-4 py-3 text-center">
                    <span className={`px-2 py-1 text-xs rounded ${user.status === 'active' ? 'bg-teal-500/20 text-teal-400' : 'bg-slate-500/20 text-slate-400'}`}>
                      {user.status}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center text-sm text-slate-400">Just now</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      
      {activeTab === 'audit' && (
        <div className="glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-4">Recent Activity</h3>
          <div className="space-y-3">
            {[
              { action: 'Login', user: 'Mary Womack', time: '2 min ago', ip: '192.168.1.1' },
              { action: 'Updated opportunity', user: 'Michael Torres', time: '15 min ago', ip: '192.168.1.2' },
              { action: 'Exported CSV', user: 'Lisa Martinez', time: '1 hr ago', ip: '192.168.1.3' },
              { action: 'Role changed', user: 'System', time: '2 hrs ago', ip: 'Internal' }
            ].map((log, idx) => (
              <div key={idx} className="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                <div>
                  <p className="text-sm text-white">{log.action}</p>
                  <p className="text-xs text-slate-500">{log.user} â€¢ {log.ip}</p>
                </div>
                <span className="text-xs text-slate-400">{log.time}</span>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {activeTab === 'tokens' && (
        <div className="glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-4">Token Usage</h3>
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-white/5 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-cyan-400">125,430</p>
              <p className="text-xs text-slate-400">Tokens Used (Today)</p>
            </div>
            <div className="bg-white/5 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-white">$3.76</p>
              <p className="text-xs text-slate-400">Estimated Cost</p>
            </div>
            <div className="bg-white/5 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-teal-400">874,570</p>
              <p className="text-xs text-slate-400">Remaining Quota</p>
            </div>
          </div>
        </div>
      )}
      
      {activeTab === 'settings' && (
        <div className="glass-panel p-6">
          <h3 className="text-lg font-semibold text-white mb-4">System Settings</h3>
          <div className="space-y-4">
            <div className="flex items-center justify-between p-4 bg-white/5 rounded-lg">
              <div>
                <p className="text-white">Dark Mode</p>
                <p className="text-xs text-slate-400">Always enabled</p>
              </div>
              <div className="w-12 h-6 bg-cyan-500 rounded-full relative">
                <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
              </div>
            </div>
            <div className="flex items-center justify-between p-4 bg-white/5 rounded-lg">
              <div>
                <p className="text-white">Email Notifications</p>
                <p className="text-xs text-slate-400">Gate review reminders</p>
              </div>
              <div className="w-12 h-6 bg-cyan-500 rounded-full relative">
                <div className="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// AI CHAT WIDGET
// ============================================================
const AIChatWidget = ({ currentModule }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState([
    { role: 'assistant', content: 'Hello! I\'m your MissionPulse AI assistant. How can I help with your proposal today?' }
  ]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const messagesEndRef = useRef(null);
  
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };
  
  useEffect(() => {
    scrollToBottom();
  }, [messages]);
  
  const sendMessage = async () => {
    if (!input.trim() || loading) return;
    
    const userMessage = input.trim();
    setInput('');
    setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
    setLoading(true);
    
    try {
      const response = await fetch(`${API_URL}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: userMessage,
          context: { module: currentModule }
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        setMessages(prev => [...prev, { role: 'assistant', content: data.response || data.message }]);
      } else {
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: `I understand you're asking about "${userMessage}". As your AI proposal assistant, I can help analyze opportunities, draft content, review compliance, and provide strategic guidance. What specific aspect would you like to explore?` 
        }]);
      }
    } catch (err) {
      setMessages(prev => [...prev, { 
        role: 'assistant', 
        content: 'I\'m currently operating in offline mode. I can still help you think through proposal strategy, compliance approaches, and win themes. What would you like to discuss?' 
      }]);
    }
    
    setLoading(false);
  };
  
  return (
    <>
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="chat-widget-btn flex items-center justify-center"
        title="AI Assistant"
      >
        {isOpen ? <Icons.x /> : <Icons.chat />}
      </button>
      
      {isOpen && (
        <div className="chat-panel animate-slideInRight">
          <div className="p-4 border-b border-cyan-500/20 bg-gradient-to-r from-cyan-500/10 to-teal-500/10">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-teal-500 flex items-center justify-center">
                <span className="text-lg">ðŸ¤–</span>
              </div>
              <div>
                <h3 className="font-semibold text-white">MissionPulse AI</h3>
                <p className="text-xs text-slate-400">Proposal Intelligence Assistant</p>
              </div>
            </div>
          </div>
          
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[80%] rounded-lg px-4 py-2 ${
                  msg.role === 'user' 
                    ? 'bg-cyan-500 text-white' 
                    : 'bg-white/10 text-slate-200'
                }`}>
                  <p className="text-sm">{msg.content}</p>
                </div>
              </div>
            ))}
            {loading && (
              <div className="flex justify-start">
                <div className="bg-white/10 rounded-lg px-4 py-2">
                  <div className="flex gap-1">
                    <span className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
                    <span className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse" style={{ animationDelay: '0.2s' }}></span>
                    <span className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse" style={{ animationDelay: '0.4s' }}></span>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>
          
          <div className="p-4 border-t border-white/10">
            <div className="flex gap-2">
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                placeholder="Ask about your proposal..."
                className="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500/50"
              />
              <button 
                onClick={sendMessage}
                disabled={loading}
                className="p-2 bg-cyan-500 hover:bg-cyan-400 disabled:bg-slate-600 rounded-lg transition-colors"
              >
                <Icons.send />
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

// ============================================================
// MAIN APP COMPONENT
// ============================================================
const App = () => {
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [currentModule, setCurrentModule] = useState('M1');
  const [currentRole, setCurrentRole] = useState(() => localStorage.getItem('MP_USER_ROLE') || 'CEO');
  const [opportunities, setOpportunities] = useState(DEMO_OPPORTUNITIES);
  const [loading, setLoading] = useState(false);
  const [user, setUser] = useState(null);
  
  // Check authentication on load
  useEffect(() => {
    const userData = checkAuth();
    if (userData) {
      setUser(userData);
      // Set role from user profile if available
      if (userData.role) {
        setCurrentRole(userData.role);
      }
    }
  }, []);
  
  // Save role preference
  useEffect(() => {
    localStorage.setItem('MP_USER_ROLE', currentRole);
  }, [currentRole]);
  
  // Fetch from Supabase
  const fetchOpportunities = async () => {
    if (!supabaseClient) return;
    
    setLoading(true);
    try {
      const { data, error } = await supabaseClient
        .from('opportunities')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (data && data.length > 0) {
        const mapped = data.map(opp => ({
          id: opp.id,
          name: opp.title || opp.name,
          agency: opp.company_id || 'Federal Agency',
          ceiling: opp.ceiling || 0,
          pWin: opp.win_probability || 50,
          phase: opp.shipley_phase || 'Gate 1',
          dueDate: opp.due_date || new Date().toISOString(),
          setAside: opp.set_aside || 'Full & Open',
          naics: opp.naics_code || '541512',
          priority: opp.priority || 'P-2'
        }));
        setOpportunities(mapped.length > 0 ? mapped : DEMO_OPPORTUNITIES);
      }
    } catch (err) {
      console.error('Fetch error:', err);
    }
    setLoading(false);
  };
  
  useEffect(() => {
    fetchOpportunities();
  }, []);
  
  // Validate module access
  useEffect(() => {
    const allowed = RBAC_MATRIX[currentRole] || [];
    if (!allowed.includes(currentModule)) {
      setCurrentModule(allowed[0] || 'M2');
    }
  }, [currentRole, currentModule]);
  
  const module = MODULES.find(m => m.id === currentModule);
  
  const renderModule = () => {
    switch (currentModule) {
      case 'M1': return <PipelineModule opportunities={opportunities} onRefresh={fetchOpportunities} loading={loading} />;
      case 'M2': return <WarRoomModule opportunities={opportunities} />;
      case 'M3': return <SwimlaneModule />;
      case 'M4': return <ComplianceModule />;
      case 'M7': return <BlackHatModule />;
      case 'M8': return <PricingModule />;
      case 'M10': return <OralsModule />;
      case 'M16': return <AdminModule opportunities={opportunities} />;
      default: return <GenericModule module={module} />;
    }
  };
  
  return (
    <div className="h-screen flex flex-col">
      <Header 
        sidebarOpen={sidebarOpen}
        setSidebarOpen={setSidebarOpen}
        currentRole={currentRole}
        setCurrentRole={setCurrentRole}
        opportunities={opportunities}
        user={user}
      />
      
      <div className="flex flex-1 overflow-hidden">
        <Sidebar 
          isOpen={sidebarOpen}
          currentModule={currentModule}
          setCurrentModule={setCurrentModule}
          currentRole={currentRole}
        />
        
        <main className="flex-1 overflow-y-auto p-4 lg:p-6">
          <div className="mb-6">
            <div className="flex items-center gap-3 mb-2">
              <span className="text-3xl">{module?.icon}</span>
              <h1 className="text-2xl font-bold text-white">{module?.name}</h1>
            </div>
            <p className="text-slate-400">{module?.desc}</p>
          </div>
          
          {renderModule()}
          
          {/* Footer */}
          <footer className="mt-8 pt-4 border-t border-white/10 text-center">
            <p className="text-xs text-slate-500">
              AI GENERATED - REQUIRES HUMAN REVIEW â€¢ MissionPulse v2.1 Â© 2026 Mission Meets Tech
            </p>
          </footer>
        </main>
      </div>
      
      <AIChatWidget currentModule={currentModule} />
    </div>
  );
};

// ============================================================
// RENDER
// ============================================================
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
