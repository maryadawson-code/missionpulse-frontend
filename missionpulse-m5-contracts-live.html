<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contracts & Clauses | MissionPulse</title>
  <link rel="icon" type="image/png" href="MMT_icon_32px.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }
    body { background: linear-gradient(135deg, #00050F 0%, #0a1628 50%, #00050F 100%); min-height: 100vh; }
    .glow-border { box-shadow: 0 0 20px rgba(0, 229, 250, 0.15); }
    .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #00b8d4 100%); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0, 229, 250, 0.4); }
    .risk-critical { background: rgba(239, 68, 68, 0.2); color: #f87171; border-color: #ef4444; }
    .risk-high { background: rgba(251, 146, 60, 0.2); color: #fb923c; border-color: #f97316; }
    .risk-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border-color: #eab308; }
    .risk-low { background: rgba(34, 197, 94, 0.2); color: #4ade80; border-color: #22c55e; }
    .status-compliant { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .status-non_compliant { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .status-waived { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
    .clause-card:hover { border-color: #00E5FA; }
  </style>
</head>
<body class="text-white">
  <!-- Header -->
  <header class="border-b border-slate-800 bg-slate-900/50 backdrop-blur sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="index.html" class="flex items-center gap-3">
          <img src="MMT_icon_64px.png" alt="MissionPulse" class="w-10 h-10">
          <div>
            <h1 class="text-xl font-bold text-white">MissionPulse</h1>
            <p class="text-xs text-cyan-400">M5: Contracts & Clauses</p>
          </div>
        </a>
      </div>
      <div class="flex items-center gap-4">
        <select id="opportunitySelect" class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm">
          <option value="">Select Opportunity...</option>
        </select>
        <a href="index.html" class="text-slate-400 hover:text-white text-sm">← Back to Dashboard</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Stats Row -->
    <div class="grid grid-cols-5 gap-4 mb-8">
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-white" id="statTotal">0</div>
        <div class="text-xs text-slate-400">Total Clauses</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-green-400" id="statCompliant">0</div>
        <div class="text-xs text-slate-400">Compliant</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-yellow-400" id="statPending">0</div>
        <div class="text-xs text-slate-400">Pending Review</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-red-400" id="statGaps">0</div>
        <div class="text-xs text-slate-400">Gaps Identified</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-cyan-400" id="statScore">--%</div>
        <div class="text-xs text-slate-400">Compliance Score</div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-3 gap-6">
      <!-- Clause Library (Left) -->
      <div class="col-span-1">
        <div class="bg-slate-800/30 rounded-xl border border-slate-700 p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-white">Clause Library</h2>
            <span class="text-xs text-slate-400" id="libraryCount">0 clauses</span>
          </div>
          
          <!-- Filters -->
          <div class="space-y-2 mb-4">
            <input type="text" id="searchClauses" placeholder="Search clauses..." 
              class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white placeholder-slate-500">
            <select id="filterType" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-white">
              <option value="">All Types</option>
              <option value="FAR">FAR</option>
              <option value="DFARS">DFARS</option>
              <option value="HHSAR">HHSAR</option>
              <option value="VAAR">VAAR</option>
            </select>
          </div>
          
          <!-- Clause List -->
          <div id="clauseLibrary" class="space-y-2 max-h-[600px] overflow-y-auto">
            <p class="text-slate-500 text-sm text-center py-4">Loading clauses...</p>
          </div>
        </div>
      </div>

      <!-- Opportunity Clauses (Right) -->
      <div class="col-span-2">
        <div class="bg-slate-800/30 rounded-xl border border-slate-700 p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-white">Opportunity Requirements</h2>
            <button onclick="openAddClauseModal()" class="btn-primary px-3 py-1.5 rounded text-xs text-slate-900 font-semibold">
              + Add Clause
            </button>
          </div>

          <div id="noOppSelected" class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p class="text-slate-400">Select an opportunity to view contract requirements</p>
          </div>

          <div id="oppClausesContainer" class="hidden">
            <!-- Critical Clauses -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-red-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-400"></span>
                Critical Compliance Items
              </h3>
              <div id="criticalClauses" class="space-y-2"></div>
            </div>

            <!-- High Risk Clauses -->
            <div class="mb-6">
              <h3 class="text-sm font-medium text-orange-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-orange-400"></span>
                High Risk Items
              </h3>
              <div id="highClauses" class="space-y-2"></div>
            </div>

            <!-- Other Clauses -->
            <div>
              <h3 class="text-sm font-medium text-slate-400 mb-3 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                Standard Requirements
              </h3>
              <div id="otherClauses" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Clause Modal -->
  <div id="addClauseModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/90" onclick="closeAddClauseModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
      <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
        <h3 class="text-lg font-bold text-white mb-4">Add Clause to Opportunity</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-1">Select Clause</label>
            <select id="modalClauseSelect" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white">
              <option value="">Choose a clause...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Initial Status</label>
            <select id="modalStatus" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white">
              <option value="pending">Pending Review</option>
              <option value="compliant">Compliant</option>
              <option value="non_compliant">Non-Compliant (Gap)</option>
              <option value="na">Not Applicable</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-slate-400 mb-1">Notes</label>
            <textarea id="modalNotes" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white"></textarea>
          </div>
          <div class="flex justify-end gap-3">
            <button onclick="closeAddClauseModal()" class="px-4 py-2 rounded bg-slate-700 text-white text-sm">Cancel</button>
            <button onclick="addClauseToOpp()" class="btn-primary px-4 py-2 rounded text-slate-900 font-semibold text-sm">Add Clause</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Clause Detail Modal -->
  <div id="clauseDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/90" onclick="closeClauseDetail()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
      <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
        <div class="flex items-start justify-between mb-4">
          <div>
            <span id="detailType" class="text-xs px-2 py-0.5 rounded bg-cyan-500/20 text-cyan-400 mb-2 inline-block">FAR</span>
            <h3 id="detailNumber" class="text-lg font-bold text-white">52.204-21</h3>
            <p id="detailTitle" class="text-slate-400">Basic Safeguarding</p>
          </div>
          <button onclick="closeClauseDetail()" class="text-slate-400 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-400 mb-1">Summary</label>
            <p id="detailSummary" class="text-white text-sm"></p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-400 mb-1">Risk Level</label>
              <span id="detailRisk" class="px-2 py-1 rounded text-xs font-medium"></span>
            </div>
            <div>
              <label class="block text-sm text-slate-400 mb-1">Flowdown Required</label>
              <span id="detailFlowdown" class="text-white text-sm"></span>
            </div>
          </div>
          <div id="detailStatusSection" class="border-t border-slate-700 pt-4 hidden">
            <label class="block text-sm text-slate-400 mb-2">Compliance Status</label>
            <select id="detailStatusSelect" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white mb-2">
              <option value="pending">Pending Review</option>
              <option value="compliant">Compliant</option>
              <option value="non_compliant">Non-Compliant (Gap)</option>
              <option value="waived">Waived</option>
              <option value="na">Not Applicable</option>
            </select>
            <textarea id="detailNotes" placeholder="Compliance notes..." rows="2" 
              class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm"></textarea>
            <button onclick="updateClauseStatus()" class="btn-primary px-4 py-2 rounded text-slate-900 font-semibold text-sm mt-2">
              Update Status
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-slate-800 mt-12 py-6">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <p class="text-xs text-slate-500">© 2026 Mission Meets Tech | MissionPulse v2.0</p>
      <p class="text-xs text-yellow-500 mt-1">AI GENERATED - REQUIRES HUMAN REVIEW</p>
    </div>
  </footer>

  <script>
    const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';
    
    let supabase;
    let allClauses = [];
    let opportunities = [];
    let selectedOppId = null;
    let oppClauses = [];
    let currentClauseDetail = null;

    async function init() {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      await Promise.all([loadClauses(), loadOpportunities()]);
      setupEventListeners();
    }

    async function loadClauses() {
      const { data, error } = await supabase
        .from('contract_clauses')
        .select('*')
        .order('clause_number');
      
      if (!error) {
        allClauses = data || [];
        renderClauseLibrary();
        populateClauseSelect();
      }
    }

    async function loadOpportunities() {
      const { data, error } = await supabase
        .from('opportunities')
        .select('id, name, agency')
        .order('name');
      
      if (!error) {
        opportunities = data || [];
        const select = document.getElementById('opportunitySelect');
        select.innerHTML = '<option value="">Select Opportunity...</option>' +
          opportunities.map(o => `<option value="${o.id}">${o.name} (${o.agency})</option>`).join('');
      }
    }

    async function loadOppClauses(oppId) {
      const { data, error } = await supabase
        .from('opportunity_clauses')
        .select('*, clause:contract_clauses(*)')
        .eq('opportunity_id', oppId);
      
      if (!error) {
        oppClauses = data || [];
        renderOppClauses();
        updateStats();
      }
    }

    function renderClauseLibrary() {
      const container = document.getElementById('clauseLibrary');
      const search = document.getElementById('searchClauses').value.toLowerCase();
      const typeFilter = document.getElementById('filterType').value;

      let filtered = allClauses.filter(c => {
        const matchSearch = !search || 
          c.clause_number.toLowerCase().includes(search) ||
          c.clause_title.toLowerCase().includes(search);
        const matchType = !typeFilter || c.clause_type === typeFilter;
        return matchSearch && matchType;
      });

      document.getElementById('libraryCount').textContent = `${filtered.length} clauses`;

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No clauses found</p>';
        return;
      }

      container.innerHTML = filtered.map(c => `
        <div class="clause-card bg-slate-900/50 rounded-lg p-3 border border-slate-700 cursor-pointer transition-colors"
          onclick="showClauseDetail('${c.id}')">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs px-1.5 py-0.5 rounded bg-slate-700 text-slate-300">${c.clause_type}</span>
                <span class="text-xs risk-${c.risk_level} px-1.5 py-0.5 rounded">${c.risk_level}</span>
              </div>
              <p class="text-sm font-medium text-white truncate">${c.clause_number}</p>
              <p class="text-xs text-slate-400 truncate">${c.clause_title}</p>
            </div>
            ${c.flowdown_required ? '<span class="text-xs text-yellow-400">↓</span>' : ''}
          </div>
        </div>
      `).join('');
    }

    function renderOppClauses() {
      const criticalEl = document.getElementById('criticalClauses');
      const highEl = document.getElementById('highClauses');
      const otherEl = document.getElementById('otherClauses');

      const critical = oppClauses.filter(oc => oc.clause?.risk_level === 'critical');
      const high = oppClauses.filter(oc => oc.clause?.risk_level === 'high');
      const other = oppClauses.filter(oc => !['critical', 'high'].includes(oc.clause?.risk_level));

      criticalEl.innerHTML = critical.length ? critical.map(renderOppClauseCard).join('') : 
        '<p class="text-slate-500 text-xs">No critical items</p>';
      highEl.innerHTML = high.length ? high.map(renderOppClauseCard).join('') : 
        '<p class="text-slate-500 text-xs">No high-risk items</p>';
      otherEl.innerHTML = other.length ? other.map(renderOppClauseCard).join('') : 
        '<p class="text-slate-500 text-xs">No standard items</p>';
    }

    function renderOppClauseCard(oc) {
      const c = oc.clause;
      return `
        <div class="bg-slate-900/50 rounded-lg p-3 border border-slate-700 flex items-center justify-between"
          onclick="showClauseDetail('${c.id}', '${oc.id}')">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 rounded bg-slate-700 text-slate-300">${c.clause_type}</span>
              <span class="font-medium text-white text-sm">${c.clause_number}</span>
            </div>
            <p class="text-xs text-slate-400 mt-1">${c.clause_title}</p>
          </div>
          <span class="status-${oc.status} px-2 py-1 rounded text-xs font-medium">
            ${formatStatus(oc.status)}
          </span>
        </div>
      `;
    }

    function formatStatus(status) {
      const map = {
        pending: 'Pending',
        compliant: 'Compliant',
        non_compliant: 'Gap',
        waived: 'Waived',
        na: 'N/A'
      };
      return map[status] || status;
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = oppClauses.length;
      document.getElementById('statCompliant').textContent = oppClauses.filter(oc => oc.status === 'compliant').length;
      document.getElementById('statPending').textContent = oppClauses.filter(oc => oc.status === 'pending').length;
      document.getElementById('statGaps').textContent = oppClauses.filter(oc => oc.status === 'non_compliant').length;
      
      const reviewable = oppClauses.filter(oc => oc.status !== 'na');
      const compliant = reviewable.filter(oc => oc.status === 'compliant' || oc.status === 'waived').length;
      const score = reviewable.length > 0 ? Math.round((compliant / reviewable.length) * 100) : 0;
      document.getElementById('statScore').textContent = `${score}%`;
    }

    function populateClauseSelect() {
      const select = document.getElementById('modalClauseSelect');
      select.innerHTML = '<option value="">Choose a clause...</option>' +
        allClauses.map(c => `<option value="${c.id}">${c.clause_number} - ${c.clause_title}</option>`).join('');
    }

    function showClauseDetail(clauseId, oppClauseId = null) {
      const clause = allClauses.find(c => c.id === clauseId);
      if (!clause) return;

      currentClauseDetail = { clauseId, oppClauseId };

      document.getElementById('detailType').textContent = clause.clause_type;
      document.getElementById('detailNumber').textContent = clause.clause_number;
      document.getElementById('detailTitle').textContent = clause.clause_title;
      document.getElementById('detailSummary').textContent = clause.summary || 'No summary available';
      
      const riskEl = document.getElementById('detailRisk');
      riskEl.textContent = clause.risk_level.toUpperCase();
      riskEl.className = `px-2 py-1 rounded text-xs font-medium risk-${clause.risk_level}`;
      
      document.getElementById('detailFlowdown').textContent = clause.flowdown_required ? 'Yes - must flow to subs' : 'No';

      const statusSection = document.getElementById('detailStatusSection');
      if (oppClauseId && selectedOppId) {
        statusSection.classList.remove('hidden');
        const oppClause = oppClauses.find(oc => oc.id === oppClauseId);
        if (oppClause) {
          document.getElementById('detailStatusSelect').value = oppClause.status;
          document.getElementById('detailNotes').value = oppClause.compliance_notes || '';
        }
      } else {
        statusSection.classList.add('hidden');
      }

      document.getElementById('clauseDetailModal').classList.remove('hidden');
    }

    function closeClauseDetail() {
      document.getElementById('clauseDetailModal').classList.add('hidden');
      currentClauseDetail = null;
    }

    async function updateClauseStatus() {
      if (!currentClauseDetail?.oppClauseId) return;

      const status = document.getElementById('detailStatusSelect').value;
      const notes = document.getElementById('detailNotes').value;

      const { error } = await supabase
        .from('opportunity_clauses')
        .update({ status, compliance_notes: notes })
        .eq('id', currentClauseDetail.oppClauseId);

      if (!error) {
        closeClauseDetail();
        await loadOppClauses(selectedOppId);
      }
    }

    function openAddClauseModal() {
      if (!selectedOppId) {
        alert('Please select an opportunity first');
        return;
      }
      document.getElementById('addClauseModal').classList.remove('hidden');
    }

    function closeAddClauseModal() {
      document.getElementById('addClauseModal').classList.add('hidden');
    }

    async function addClauseToOpp() {
      const clauseId = document.getElementById('modalClauseSelect').value;
      const status = document.getElementById('modalStatus').value;
      const notes = document.getElementById('modalNotes').value;

      if (!clauseId) {
        alert('Please select a clause');
        return;
      }

      const { error } = await supabase
        .from('opportunity_clauses')
        .insert({
          opportunity_id: selectedOppId,
          clause_id: clauseId,
          status,
          compliance_notes: notes
        });

      if (error) {
        if (error.code === '23505') {
          alert('This clause is already added to this opportunity');
        } else {
          alert('Error adding clause: ' + error.message);
        }
        return;
      }

      closeAddClauseModal();
      await loadOppClauses(selectedOppId);
    }

    function setupEventListeners() {
      document.getElementById('opportunitySelect').addEventListener('change', async (e) => {
        selectedOppId = e.target.value;
        if (selectedOppId) {
          document.getElementById('noOppSelected').classList.add('hidden');
          document.getElementById('oppClausesContainer').classList.remove('hidden');
          await loadOppClauses(selectedOppId);
        } else {
          document.getElementById('noOppSelected').classList.remove('hidden');
          document.getElementById('oppClausesContainer').classList.add('hidden');
          oppClauses = [];
          updateStats();
        }
      });

      document.getElementById('searchClauses').addEventListener('input', renderClauseLibrary);
      document.getElementById('filterType').addEventListener('change', renderClauseLibrary);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
