<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Company Setup â€” MissionPulse</title>
<link rel="icon" type="image/png" sizes="32x32" href="MMT_icon_32px.png">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="mp-responsive.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="mp-polish.js"></script>
<style>
  body { background: #00050F; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  .glow-border { border: 1px solid rgba(0,229,250,0.3); box-shadow: 0 0 20px rgba(0,229,250,0.05); }
  .pulse-btn { background: linear-gradient(135deg, #00E5FA 0%, #00B8D4 100%); transition: all 0.2s; }
  .pulse-btn:hover { box-shadow: 0 0 20px rgba(0,229,250,0.4); transform: translateY(-1px); }
  .pulse-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .input-field { background: #0A1628; border: 1px solid #334155; color: #F8FAFC; transition: border-color 0.2s; }
  .input-field:focus { border-color: #00E5FA; outline: none; box-shadow: 0 0 0 2px rgba(0,229,250,0.15); }
  .input-field::placeholder { color: #64748B; }
  .chip { background: #1E293B; border: 1px solid #334155; color: #94A3B8; cursor: pointer; transition: all 0.15s; }
  .chip:hover { border-color: #00E5FA; color: #F8FAFC; }
  .chip.selected { background: rgba(0,229,250,0.15); border-color: #00E5FA; color: #00E5FA; }
  .error-msg { color: #EF4444; font-size: 13px; margin-top: 6px; }
  .step-dot { width: 8px; height: 8px; border-radius: 50%; background: #334155; transition: all 0.2s; }
  .step-dot.active { background: #00E5FA; box-shadow: 0 0 6px rgba(0,229,250,0.5); }
  .step-dot.done { background: #10B981; }
  .invite-row { display: flex; gap: 8px; margin-bottom: 8px; }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-lg">
  <!-- Logo -->
  <div class="text-center mb-6">
    <div class="text-3xl font-bold text-cyan-400 tracking-tight">MISSIONPULSE</div>
    <div class="text-sm text-slate-500 mt-1">Set Up Your Workspace</div>
  </div>

  <!-- Progress -->
  <div class="flex items-center justify-center gap-3 mb-8">
    <div class="step-dot active" id="dot1"></div>
    <div class="w-12 h-px bg-slate-700"></div>
    <div class="step-dot" id="dot2"></div>
    <div class="w-12 h-px bg-slate-700"></div>
    <div class="step-dot" id="dot3"></div>
  </div>

  <div class="glow-border rounded-xl p-8 bg-[#0A1628]">

    <!-- STEP 1: Company Info -->
    <div id="step1">
      <h2 class="text-xl font-bold text-white mb-1">Your Company</h2>
      <p class="text-slate-400 text-sm mb-6">Tell us about your organization.</p>

      <div class="mb-4">
        <label class="block text-sm text-slate-300 mb-1.5">Company Name</label>
        <input type="text" id="companyName" placeholder="Acme Federal Solutions" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div class="mb-4">
        <label class="block text-sm text-slate-300 mb-1.5">Website (optional)</label>
        <input type="text" id="companyDomain" placeholder="acmefederal.com" 
          class="input-field w-full px-4 py-2.5 rounded-lg text-sm">
      </div>

      <div class="mb-6">
        <label class="block text-sm text-slate-300 mb-2">Contract Vehicles (select all that apply)</label>
        <div class="flex flex-wrap gap-2" id="vehicleChips">
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="SDVOSB">SDVOSB</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="WOSB">WOSB</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="8(a)">8(a)</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="HUBZone">HUBZone</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="Small Business">Small Business</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="GSA Schedule">GSA Schedule</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="OASIS+">OASIS+</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="SEWP V">SEWP V</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="Alliant 3">Alliant 3</div>
          <div class="chip px-3 py-1.5 rounded-lg text-xs font-medium" onclick="toggleChip(this)" data-value="CIO-SP4">CIO-SP4</div>
        </div>
      </div>

      <div id="step1Error" class="error-msg mb-4 hidden"></div>

      <button id="step1Btn" onclick="goToStep2()" 
        class="pulse-btn w-full py-2.5 rounded-lg text-sm font-semibold text-[#00050F]">
        Continue â†’
      </button>
    </div>

    <!-- STEP 2: Invite Team -->
    <div id="step2" class="hidden">
      <h2 class="text-xl font-bold text-white mb-1">Invite Your Team</h2>
      <p class="text-slate-400 text-sm mb-6">Add team members now or skip and do it later from Settings.</p>

      <div id="inviteList">
        <div class="invite-row">
          <input type="email" placeholder="colleague@company.com" 
            class="input-field flex-1 px-4 py-2.5 rounded-lg text-sm invite-email">
          <select class="input-field px-3 py-2.5 rounded-lg text-sm invite-role">
            <option value="COO">COO</option>
            <option value="CAP">Capture Manager</option>
            <option value="PM">Project Manager</option>
            <option value="SA">Solution Architect</option>
            <option value="FIN">Financial Analyst</option>
            <option value="CON">Contracts</option>
            <option value="DEL">Delivery</option>
            <option value="Viewer" selected>Viewer</option>
          </select>
        </div>
      </div>

      <button onclick="addInviteRow()" class="text-cyan-400 text-sm hover:text-cyan-300 mb-6 mt-2">
        + Add another
      </button>

      <div id="step2Error" class="error-msg mb-4 hidden"></div>

      <div class="flex gap-3">
        <button onclick="goToStep3(true)" 
          class="flex-1 py-2.5 rounded-lg text-sm font-semibold text-slate-400 border border-slate-600 hover:border-slate-400">
          Skip for now
        </button>
        <button id="step2Btn" onclick="goToStep3(false)" 
          class="flex-1 pulse-btn py-2.5 rounded-lg text-sm font-semibold text-[#00050F]">
          Send Invites â†’
        </button>
      </div>
    </div>

    <!-- STEP 3: Done -->
    <div id="step3" class="hidden text-center py-4">
      <div class="text-5xl mb-4">ðŸš€</div>
      <h2 class="text-xl font-bold text-white mb-2">You're all set!</h2>
      <p class="text-slate-400 text-sm mb-2">Your workspace is ready. We've added a sample opportunity to get you started.</p>
      <p class="text-slate-500 text-xs mb-6" id="inviteConfirm"></p>

      <button onclick="window.location.href='dashboard.html'" 
        class="pulse-btn px-8 py-2.5 rounded-lg text-sm font-semibold text-[#00050F]">
        Launch Dashboard â†’
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="text-center mt-6 text-xs text-slate-600">
    14-day free trial Â· No credit card required<br>
    AI GENERATED â€” REQUIRES HUMAN REVIEW
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://djuviwarqdvlbgcfuupa.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NDQ0NjUsImV4cCI6MjA4NTAyMDQ2NX0.3s8ufDDN2aWfkW0RBsAyJyacb2tjB7M550WSFIohHcA';
  var sbClient;
  try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON); } catch(e) { console.warn('Supabase init failed'); }

  let currentUser = null;
  let createdCompanyId = null;

  // Auth guard â€” must be logged in, must NOT already have a company
  (async () => {
    if (!sbClient) return;
    const { data: { session } } = await sbClient.auth.getSession();
    if (!session) {
      window.location.href = 'login.html';
      return;
    }
    currentUser = session.user;

    const { data: profile } = await sbClient.from('profiles').select('company_id').eq('id', currentUser.id).single();
    if (profile?.company_id) {
      // Already has a company â€” go to dashboard
      window.location.href = 'dashboard.html';
    }
  })();

  function toggleChip(el) {
    el.classList.toggle('selected');
  }

  function getSelectedVehicles() {
    return Array.from(document.querySelectorAll('#vehicleChips .chip.selected')).map(c => c.dataset.value);
  }

  function showStepError(step, msg) {
    const el = document.getElementById(`step${step}Error`);
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  function setStep(n) {
    document.getElementById('dot1').className = `step-dot ${n > 1 ? 'done' : 'active'}`;
    document.getElementById('dot2').className = `step-dot ${n > 2 ? 'done' : n === 2 ? 'active' : ''}`;
    document.getElementById('dot3').className = `step-dot ${n === 3 ? 'active' : ''}`;
  }

  async function goToStep2() {
    const name = document.getElementById('companyName').value.trim();
    if (!name) return showStepError(1, 'Company name is required.');

    const btn = document.getElementById('step1Btn');
    btn.disabled = true;
    btn.textContent = 'Creating workspace...';

    try {
      const domain = document.getElementById('companyDomain').value.trim();
      const vehicles = getSelectedVehicles();

      // Create company
      const { data: company, error: compErr } = await sbClient.from('companies').insert({
        name,
        domain: domain || null,
        subscription_tier: 'starter',
        max_users: 5,
        max_opportunities: 5,
        is_active: true,
        features: { contract_vehicles: vehicles }
      }).select().single();

      if (compErr) {
        btn.disabled = false;
        btn.textContent = 'Continue â†’';
        return showStepError(1, compErr.message);
      }

      createdCompanyId = company.id;

      // Link profile to company
      await sbClient.from('profiles').update({ company_id: createdCompanyId }).eq('id', currentUser.id);

      // Seed demo data
      try {
        await sbClient.rpc('seed_company_demo_data', { p_company_id: createdCompanyId });
      } catch(e) {
        console.warn('Demo seed skipped:', e);
      }

      // Show step 2
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      setStep(2);

    } catch (err) {
      console.error('Company creation error:', err);
      btn.disabled = false;
      btn.textContent = 'Continue â†’';
      showStepError(1, 'Something went wrong. Please try again.');
    }
  }

  function addInviteRow() {
    const row = document.createElement('div');
    row.className = 'invite-row';
    row.innerHTML = `
      <input type="email" placeholder="colleague@company.com" 
        class="input-field flex-1 px-4 py-2.5 rounded-lg text-sm invite-email">
      <select class="input-field px-3 py-2.5 rounded-lg text-sm invite-role">
        <option value="COO">COO</option>
        <option value="CAP">Capture Manager</option>
        <option value="PM">Project Manager</option>
        <option value="SA">Solution Architect</option>
        <option value="FIN">Financial Analyst</option>
        <option value="CON">Contracts</option>
        <option value="DEL">Delivery</option>
        <option value="Viewer" selected>Viewer</option>
      </select>
      <button onclick="this.parentElement.remove()" class="text-slate-500 hover:text-red-400 text-lg px-1">Ã—</button>
    `;
    document.getElementById('inviteList').appendChild(row);
  }

  async function goToStep3(skipped) {
    let inviteCount = 0;

    if (!skipped) {
      const emails = document.querySelectorAll('.invite-email');
      const roles = document.querySelectorAll('.invite-role');
      const invites = [];

      emails.forEach((el, i) => {
        const email = el.value.trim();
        if (email) {
          invites.push({ email, role: roles[i].value });
        }
      });

      if (invites.length > 0) {
        const btn = document.getElementById('step2Btn');
        btn.disabled = true;
        btn.textContent = 'Sending...';

        for (const inv of invites) {
          try {
            await sbClient.from('team_invitations').insert({
              company_id: createdCompanyId,
              email: inv.email,
              role: inv.role,
              invited_by: currentUser.id
            });
            inviteCount++;
          } catch(e) {
            console.warn('Invite failed for', inv.email, e);
          }
        }
      }
    }

    // Show step 3
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
    setStep(3);

    if (inviteCount > 0) {
      document.getElementById('inviteConfirm').textContent = 
        `${inviteCount} invitation${inviteCount > 1 ? 's' : ''} sent. They'll get an email to join your workspace.`;
    }
  }
</script>
</body>
</html>

