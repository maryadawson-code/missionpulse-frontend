<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse - Frenemy Protocol</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; color: #F8FAFC; }
    .card { background: #0d1f3c; border: 1px solid rgba(0, 229, 250, 0.3); border-radius: 12px; }
    .btn-primary { background: linear-gradient(135deg, #00E5FA 0%, #0891B2 100%); color: #00050F; font-weight: 600; }
    .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 229, 250, 0.4); }
    .glow-text { text-shadow: 0 0 10px rgba(0, 229, 250, 0.5); }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .relationship-ally { border-left: 4px solid #10B981; }
    .relationship-competitor { border-left: 4px solid #EF4444; }
    .relationship-frenemy { border-left: 4px solid #F59E0B; }
    .relationship-unknown { border-left: 4px solid #6B7280; }
  </style>
</head>
<body class="p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-4">
      <a href="index.html" class="text-gray-400 hover:text-cyan-400">‚Üê Dashboard</a>
      <h1 class="text-2xl font-bold"><span class="text-cyan-400 glow-text">Frenemy</span> Protocol</h1>
    </div>
    <div class="flex items-center gap-4">
      <div id="connectionStatus" class="flex items-center gap-2 text-sm">
        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
        <span class="text-gray-400">Connecting...</span>
      </div>
      <select id="opportunityFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm">
        <option value="">All Opportunities</option>
      </select>
      <button onclick="openAddModal()" class="btn-primary px-4 py-2 rounded-lg">+ Add Entity</button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-5 gap-4 mb-6">
    <div class="card p-4 text-center">
      <div id="statTotal" class="text-3xl font-bold text-cyan-400">0</div>
      <div class="text-gray-400 text-sm">Total Entities</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statAllies" class="text-3xl font-bold text-green-400">0</div>
      <div class="text-gray-400 text-sm">Allies</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statCompetitors" class="text-3xl font-bold text-red-400">0</div>
      <div class="text-gray-400 text-sm">Competitors</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statFrenemies" class="text-3xl font-bold text-amber-400">0</div>
      <div class="text-gray-400 text-sm">Frenemies</div>
    </div>
    <div class="card p-4 text-center">
      <div id="statThreatScore" class="text-3xl font-bold text-purple-400">0</div>
      <div class="text-gray-400 text-sm">Avg Threat Score</div>
    </div>
  </div>

  <!-- Search & Filters -->
  <div class="card p-4 mb-6">
    <div class="flex gap-4">
      <input type="text" id="searchInput" placeholder="Search entities..."
             class="flex-1 bg-slate-800 border border-slate-600 rounded px-4 py-2" oninput="filterEntities()">
      <select id="relationshipFilter" class="bg-slate-800 border border-slate-600 rounded px-3 py-2" onchange="filterEntities()">
        <option value="">All Relationships</option>
        <option value="ally">Allies</option>
        <option value="competitor">Competitors</option>
        <option value="frenemy">Frenemies</option>
        <option value="unknown">Unknown</option>
      </select>
    </div>
  </div>

  <!-- Entities Grid -->
  <div id="entitiesContainer" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
    <div class="card p-8 text-center text-gray-500 col-span-full">Loading entities...</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="entityModal" class="modal hidden">
    <div class="card p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="text-xl font-bold text-cyan-400">Add Entity</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <form id="entityForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="entityId">
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Entity Name *</label>
            <input type="text" id="entityName" required class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Relationship *</label>
            <select id="entityRelationship" required class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="unknown">Unknown</option>
              <option value="ally">Ally</option>
              <option value="competitor">Competitor</option>
              <option value="frenemy">Frenemy</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">CAGE Code</label>
            <input type="text" id="cageCode" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Set-Aside Status</label>
            <select id="setAsideStatus" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
              <option value="">None</option>
              <option value="SDVOSB">SDVOSB</option>
              <option value="8(a)">8(a)</option>
              <option value="WOSB">WOSB</option>
              <option value="HUBZone">HUBZone</option>
              <option value="Small Business">Small Business</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Threat Score (1-10)</label>
            <input type="number" id="threatScore" min="1" max="10" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Win Rate vs Us (%)</label>
            <input type="number" id="winRate" min="0" max="100" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Capabilities</label>
          <textarea id="capabilities" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Strengths</label>
          <textarea id="strengths" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Weaknesses</label>
          <textarea id="weaknesses" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-sm text-gray-400 mb-1">Intel Notes</label>
          <textarea id="intelNotes" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contact Name</label>
            <input type="text" id="contactName" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Contact Email</label>
            <input type="email" id="contactEmail" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2">
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-slate-700 rounded-lg hover:bg-slate-600">Cancel</button>
          <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Entity</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-8 text-center text-xs text-gray-500">
    AI GENERATED - REQUIRES HUMAN REVIEW | MissionPulse ¬© 2026
  </div>

  <script>
    // ========== SUPABASE CONFIG ==========
    const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MTcyNjUsImV4cCI6MjA1MjI5MzI2NX0.DACT1xnVtJeHx5tL7_K8y1hOx9NyJE7B6UBhPqwHHx8';
    
    let supabase;
    let allEntities = [];
    let opportunities = [];
    let editingId = null;

    function initSupabase() {
      if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        updateConnectionStatus(true);
        return true;
      }
      return false;
    }

    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      status.innerHTML = connected 
        ? `<span class="w-2 h-2 rounded-full bg-green-400"></span><span class="text-green-400">Connected</span>`
        : `<span class="w-2 h-2 rounded-full bg-red-400"></span><span class="text-red-400">Disconnected</span>`;
    }

    // ========== DATA LOADING ==========
    async function loadOpportunities() {
      try {
        const { data, error } = await supabase.from('opportunities').select('id, title, name').order('title');
        if (error) throw error;
        opportunities = data || [];
        const select = document.getElementById('opportunityFilter');
        select.innerHTML = `<option value="">All Opportunities</option>` + 
          opportunities.map(o => `<option value="${o.id}">${o.title || o.name}</option>`).join('');
      } catch (err) {
        console.error('Failed to load opportunities:', err);
      }
    }

    async function loadEntities() {
      try {
        const oppFilter = document.getElementById('opportunityFilter').value;
        let query = supabase.from('frenemy_entities').select('*').order('entity_name');
        if (oppFilter) query = query.eq('opportunity_id', oppFilter);
        
        const { data, error } = await query;
        if (error) throw error;
        
        allEntities = data || [];
        filterEntities();
        updateStats();
      } catch (err) {
        console.error('Failed to load entities:', err);
        showEmptyState('Failed to load entities');
      }
    }

    function filterEntities() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const relFilter = document.getElementById('relationshipFilter').value;
      
      const filtered = allEntities.filter(e => {
        const matchesSearch = !search || 
          e.entity_name?.toLowerCase().includes(search) ||
          e.capabilities?.toLowerCase().includes(search);
        const matchesRel = !relFilter || e.relationship === relFilter;
        return matchesSearch && matchesRel;
      });
      renderEntities(filtered);
    }

    function renderEntities(entities) {
      const container = document.getElementById('entitiesContainer');
      if (entities.length === 0) {
        showEmptyState('No entities found');
        return;
      }
      
      container.innerHTML = entities.map(e => `
        <div class="card p-4 relationship-${e.relationship || 'unknown'} hover:border-cyan-400/50 cursor-pointer"
             onclick="openEditModal('${e.id}')">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h3 class="font-semibold">${e.entity_name || 'Unknown'}</h3>
              <span class="text-xs text-gray-500">${e.cage_code ? 'CAGE: ' + e.cage_code : ''}</span>
            </div>
            <span class="text-xs px-2 py-1 rounded ${getRelationshipClass(e.relationship)}">
              ${(e.relationship || 'unknown').toUpperCase()}
            </span>
          </div>
          
          ${e.set_aside_status ? `<div class="text-xs text-cyan-400 mb-2">${e.set_aside_status}</div>` : ''}
          
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div class="bg-slate-800 rounded p-2 text-center">
              <div class="text-lg font-bold ${getThreatColor(e.threat_score)}">${e.threat_score || '-'}</div>
              <div class="text-xs text-gray-500">Threat</div>
            </div>
            <div class="bg-slate-800 rounded p-2 text-center">
              <div class="text-lg font-bold text-amber-400">${e.win_rate || '-'}%</div>
              <div class="text-xs text-gray-500">Win Rate</div>
            </div>
          </div>
          
          ${e.capabilities ? `<p class="text-xs text-gray-400 mb-2 line-clamp-2">üìã ${e.capabilities}</p>` : ''}
          
          <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-700">
            <span class="text-xs text-gray-500">${formatDate(e.updated_at)}</span>
            <button onclick="event.stopPropagation(); deleteEntity('${e.id}')" class="text-red-400 hover:text-red-300 text-xs">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function showEmptyState(message) {
      document.getElementById('entitiesContainer').innerHTML = `
        <div class="card p-8 text-center text-gray-500 col-span-full">
          <p>${message}</p>
          <button onclick="openAddModal()" class="btn-primary px-4 py-2 rounded-lg mt-4">Add First Entity</button>
        </div>`;
    }

    function getRelationshipClass(rel) {
      const classes = { ally: 'bg-green-500/20 text-green-400', competitor: 'bg-red-500/20 text-red-400', frenemy: 'bg-amber-500/20 text-amber-400', unknown: 'bg-gray-500/20 text-gray-400' };
      return classes[rel] || classes.unknown;
    }

    function getThreatColor(score) {
      if (!score) return 'text-gray-400';
      if (score >= 8) return 'text-red-400';
      if (score >= 5) return 'text-amber-400';
      return 'text-green-400';
    }

    function formatDate(date) {
      if (!date) return 'N/A';
      return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function updateStats() {
      const allies = allEntities.filter(e => e.relationship === 'ally').length;
      const competitors = allEntities.filter(e => e.relationship === 'competitor').length;
      const frenemies = allEntities.filter(e => e.relationship === 'frenemy').length;
      const avgThreat = allEntities.length > 0 
        ? Math.round(allEntities.reduce((sum, e) => sum + (e.threat_score || 0), 0) / allEntities.length) : 0;
      
      document.getElementById('statTotal').textContent = allEntities.length;
      document.getElementById('statAllies').textContent = allies;
      document.getElementById('statCompetitors').textContent = competitors;
      document.getElementById('statFrenemies').textContent = frenemies;
      document.getElementById('statThreatScore').textContent = avgThreat;
    }

    // ========== MODAL HANDLERS ==========
    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Entity';
      document.getElementById('entityForm').reset();
      document.getElementById('entityModal').classList.remove('hidden');
    }

    function openEditModal(id) {
      const entity = allEntities.find(e => e.id === id);
      if (!entity) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Entity';
      document.getElementById('entityId').value = id;
      document.getElementById('entityName').value = entity.entity_name || '';
      document.getElementById('entityRelationship').value = entity.relationship || 'unknown';
      document.getElementById('cageCode').value = entity.cage_code || '';
      document.getElementById('setAsideStatus').value = entity.set_aside_status || '';
      document.getElementById('threatScore').value = entity.threat_score || '';
      document.getElementById('winRate').value = entity.win_rate || '';
      document.getElementById('capabilities').value = entity.capabilities || '';
      document.getElementById('strengths').value = entity.strengths || '';
      document.getElementById('weaknesses').value = entity.weaknesses || '';
      document.getElementById('intelNotes').value = entity.intel_notes || '';
      document.getElementById('contactName').value = entity.contact_name || '';
      document.getElementById('contactEmail').value = entity.contact_email || '';
      document.getElementById('entityModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('entityModal').classList.add('hidden');
      editingId = null;
    }

    async function handleSubmit(event) {
      event.preventDefault();
      
      const entityData = {
        entity_name: document.getElementById('entityName').value,
        relationship: document.getElementById('entityRelationship').value,
        cage_code: document.getElementById('cageCode').value || null,
        set_aside_status: document.getElementById('setAsideStatus').value || null,
        threat_score: parseInt(document.getElementById('threatScore').value) || null,
        win_rate: parseInt(document.getElementById('winRate').value) || null,
        capabilities: document.getElementById('capabilities').value || null,
        strengths: document.getElementById('strengths').value || null,
        weaknesses: document.getElementById('weaknesses').value || null,
        intel_notes: document.getElementById('intelNotes').value || null,
        contact_name: document.getElementById('contactName').value || null,
        contact_email: document.getElementById('contactEmail').value || null,
        opportunity_id: document.getElementById('opportunityFilter').value || null,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingId) {
          const { error } = await supabase.from('frenemy_entities').update(entityData).eq('id', editingId);
          if (error) throw error;
        } else {
          entityData.created_at = new Date().toISOString();
          const { error } = await supabase.from('frenemy_entities').insert([entityData]);
          if (error) throw error;
        }
        closeModal();
        await loadEntities();
      } catch (err) {
        console.error('Failed to save entity:', err);
        alert('Failed to save: ' + err.message);
      }
    }

    async function deleteEntity(id) {
      if (!confirm('Delete this entity?')) return;
      try {
        const { error } = await supabase.from('frenemy_entities').delete().eq('id', id);
        if (error) throw error;
        await loadEntities();
      } catch (err) {
        console.error('Failed to delete:', err);
      }
    }

    // ========== REAL-TIME ==========
    function subscribeToChanges() {
      supabase.channel('frenemy_changes').on('postgres_changes', { event: '*', schema: 'public', table: 'frenemy_entities' }, () => loadEntities()).subscribe();
    }

    // ========== EVENT LISTENERS ==========
    document.getElementById('opportunityFilter').addEventListener('change', loadEntities);

    // ========== INIT ==========
    async function init() {
      if (!initSupabase()) { updateConnectionStatus(false); return; }
      await loadOpportunities();
      await loadEntities();
      subscribeToChanges();
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  </script>
</body>
</html>
