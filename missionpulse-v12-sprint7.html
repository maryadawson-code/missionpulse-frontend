<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse v12 Sprint 7 - Pipeline Board with Search & Filters</title>
  <meta name="description" content="Federal proposal pipeline management with Supabase integration">
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Local Supabase Client Module -->
  <script src="supabase-client.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'pulse-cyan': '#00E5FA',
            'shield-navy': '#00050F',
            'shield-dark': '#0a0f1a',
            'shield-panel': '#0d1526',
          }
        }
      }
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; }
    
    /* Animations */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-shimmer { 
      background: linear-gradient(90deg, transparent, rgba(0,229,250,0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
    .animate-slideOut { animation: slideOut 0.2s ease-in forwards; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
    .animate-toastSlideIn { animation: toastSlideIn 0.3s ease-out; }
    
    /* Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #00E5FA; }
    
    /* Drag and Drop */
    .drag-handle { cursor: grab; }
    .drag-handle:active { cursor: grabbing; }
    .drop-zone-active { 
      background: rgba(0, 229, 250, 0.1); 
      border: 2px dashed #00E5FA !important;
    }
    .dragging { opacity: 0.5; }
    
    /* Range Slider Custom Styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      background: #334155;
      height: 6px;
      border-radius: 3px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      margin-top: -5px;
      background-color: #00E5FA;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      border: 2px solid #00050F;
    }
    input[type="range"]:focus::-webkit-slider-thumb {
      box-shadow: 0 0 0 3px rgba(0, 229, 250, 0.3);
    }
    
    /* Multi-select dropdown */
    .multi-select-dropdown {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
// ============================================================
// MISSIONPULSE v12 SPRINT 7 - PIPELINE BOARD
// Sprint 6 Foundation + Task 7.1 Search & Filter Bar
// © 2026 Mission Meets Tech
// ============================================================

const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;

// ============================================================
// ICONS
// ============================================================
const Icons = {
  grip: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" /></svg>,
  chevronRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>,
  chevronDown: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
  check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
  clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2" /></svg>,
  users: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
  target: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><circle cx="12" cy="12" r="6" strokeWidth={2}/><circle cx="12" cy="12" r="2" strokeWidth={2}/></svg>,
  shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
  dollar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
  alert: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
  arrowRight: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
  x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
  edit: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
  trash: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
  plus: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
  refresh: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
  search: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
  filter: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
  calendar: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
  wifi: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.14 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>,
  wifiOff: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" /></svg>,
  activity: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
  table: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
  grid: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
  chart: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
  download: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
  sortAsc: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>,
  sortDesc: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4" /></svg>,
};

const Icon = ({ name, className = "w-4 h-4" }) => {
  const IconComponent = Icons[name];
  return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
};

// ============================================================
// TOAST CONTEXT & COMPONENT
// ============================================================
const ToastContext = createContext(null);

const ToastProvider = ({ children }) => {
  const [toasts, setToasts] = useState([]);
  
  const addToast = useCallback((message, type = 'success', duration = 4000) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, duration);
  }, []);
  
  return (
    <ToastContext.Provider value={{ addToast }}>
      {children}
      <div className="fixed top-4 right-4 z-50 space-y-2">
        {toasts.map(toast => (
          <div 
            key={toast.id}
            className={`animate-toastSlideIn px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] ${
              toast.type === 'success' ? 'bg-emerald-600' :
              toast.type === 'error' ? 'bg-red-600' :
              toast.type === 'warning' ? 'bg-amber-600' :
              'bg-slate-700'
            }`}
          >
            <Icon 
              name={toast.type === 'success' ? 'check' : toast.type === 'error' ? 'alert' : 'activity'} 
              className="w-5 h-5 text-white" 
            />
            <span className="text-white text-sm">{toast.message}</span>
          </div>
        ))}
      </div>
    </ToastContext.Provider>
  );
};

const useToast = () => useContext(ToastContext);

// ============================================================
// CONNECTION STATUS COMPONENT
// ============================================================
const ConnectionStatus = ({ status }) => {
  const isConnected = status === 'connected';
  
  return (
    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium ${
      isConnected ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'
    }`}>
      <Icon name={isConnected ? 'wifi' : 'wifiOff'} className="w-3.5 h-3.5" />
      <span>{isConnected ? 'Live' : 'Disconnected'}</span>
      {isConnected && <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse" />}
    </div>
  );
};

// ============================================================
// LOADING STATE COMPONENTS
// ============================================================
const LoadingState = ({ message = "Loading..." }) => (
  <div className="flex items-center justify-center py-12">
    <div className="text-center">
      <div className="w-12 h-12 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4" />
      <p className="text-slate-400">{message}</p>
    </div>
  </div>
);

const ErrorState = ({ message, onRetry }) => (
  <div className="flex items-center justify-center py-12">
    <div className="text-center">
      <Icon name="alert" className="w-12 h-12 text-red-400 mx-auto mb-4" />
      <p className="text-red-400 mb-4">{message}</p>
      {onRetry && (
        <Button variant="secondary" onClick={onRetry}>
          <Icon name="refresh" className="w-4 h-4 mr-2" />
          Try Again
        </Button>
      )}
    </div>
  </div>
);

const SkeletonCard = () => (
  <div className="bg-slate-800/50 rounded-xl p-4 animate-shimmer">
    <div className="h-4 bg-slate-700 rounded w-3/4 mb-3" />
    <div className="h-3 bg-slate-700/50 rounded w-1/2 mb-2" />
    <div className="h-3 bg-slate-700/50 rounded w-2/3" />
  </div>
);

// ============================================================
// BUTTON COMPONENT
// ============================================================
const Button = ({ 
  children, 
  variant = 'primary', 
  size = 'md', 
  loading = false, 
  disabled = false,
  className = '',
  ...props 
}) => {
  const baseStyles = "inline-flex items-center justify-center font-medium rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 disabled:opacity-50 disabled:cursor-not-allowed";
  
  const variants = {
    primary: "bg-cyan-500 hover:bg-cyan-600 text-white focus:ring-cyan-500",
    secondary: "bg-slate-700 hover:bg-slate-600 text-white focus:ring-slate-500",
    danger: "bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",
    ghost: "bg-transparent hover:bg-slate-700/50 text-slate-300 focus:ring-slate-500",
  };
  
  const sizes = {
    sm: "px-3 py-1.5 text-xs",
    md: "px-4 py-2 text-sm",
    lg: "px-6 py-3 text-base",
  };
  
  return (
    <button
      className={`${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`}
      disabled={disabled || loading}
      {...props}
    >
      {loading && (
        <svg className="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
      )}
      {children}
    </button>
  );
};

// ============================================================
// MODAL COMPONENT
// ============================================================
const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
  if (!isOpen) return null;
  
  const sizes = {
    sm: 'max-w-sm',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
  };
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose} />
      <div className={`relative bg-slate-900 border border-slate-700 rounded-xl shadow-2xl ${sizes[size]} w-full mx-4 animate-slideUp`}>
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700">
          <h3 className="text-lg font-semibold text-white">{title}</h3>
          <button 
            onClick={onClose}
            className="p-1 hover:bg-slate-700 rounded-lg transition-colors"
          >
            <Icon name="x" className="w-5 h-5 text-slate-400" />
          </button>
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};

// ============================================================
// MULTI-SELECT DROPDOWN COMPONENT
// ============================================================
const MultiSelectDropdown = ({ 
  label, 
  options, 
  selected, 
  onChange, 
  placeholder = "Select...",
  className = "" 
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef(null);
  
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  const toggleOption = (value) => {
    if (selected.includes(value)) {
      onChange(selected.filter(s => s !== value));
    } else {
      onChange([...selected, value]);
    }
  };
  
  return (
    <div className={`relative ${className}`} ref={dropdownRef}>
      {label && <label className="block text-xs text-slate-400 mb-1">{label}</label>}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white hover:border-slate-500 focus:outline-none focus:border-cyan-500"
      >
        <span className={selected.length === 0 ? 'text-slate-500' : ''}>
          {selected.length === 0 ? placeholder : `${selected.length} selected`}
        </span>
        <Icon name="chevronDown" className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>
      
      {isOpen && (
        <div className="absolute z-20 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl multi-select-dropdown">
          {options.map(option => (
            <label
              key={option.value}
              className="flex items-center gap-2 px-3 py-2 hover:bg-slate-700 cursor-pointer"
            >
              <input
                type="checkbox"
                checked={selected.includes(option.value)}
                onChange={() => toggleOption(option.value)}
                className="rounded border-slate-600 bg-slate-700 text-cyan-500 focus:ring-cyan-500"
              />
              <span className="text-sm text-white">{option.label}</span>
              {option.color && (
                <span 
                  className="w-2 h-2 rounded-full ml-auto"
                  style={{ backgroundColor: option.color }}
                />
              )}
            </label>
          ))}
        </div>
      )}
    </div>
  );
};

// ============================================================
// SHIPLEY PHASES CONSTANT
// ============================================================
const SHIPLEY_PHASES = [
  { key: 'gate_1', name: 'Gate 1', color: '#94a3b8', order: 1 },
  { key: 'blue_team', name: 'Blue Team', color: '#60a5fa', order: 2 },
  { key: 'pink_team', name: 'Pink Team', color: '#f472b6', order: 3 },
  { key: 'red_team', name: 'Red Team', color: '#ef4444', order: 4 },
  { key: 'gold_team', name: 'Gold Team', color: '#fbbf24', order: 5 },
  { key: 'submitted', name: 'Submitted', color: '#22c55e', order: 6 },
  { key: 'awarded', name: 'Awarded', color: '#8b5cf6', order: 7 },
  { key: 'lost', name: 'Lost', color: '#64748b', order: 8 },
];

const PRIORITIES = [
  { value: 'P-0', label: 'P-0 (Critical)', color: '#ef4444' },
  { value: 'P-1', label: 'P-1 (High)', color: '#f97316' },
  { value: 'P-2', label: 'P-2 (Medium)', color: '#eab308' },
  { value: 'P-3', label: 'P-3 (Low)', color: '#22c55e' },
];

// ============================================================
// SEARCH & FILTER BAR COMPONENT (SPRINT 7 - TASK 7.1)
// ============================================================
const SearchFilterBar = ({ 
  filters, 
  onFiltersChange, 
  agencies = [],
  onClearAll 
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  
  const activeFilterCount = useMemo(() => {
    let count = 0;
    if (filters.search) count++;
    if (filters.agencies.length > 0) count++;
    if (filters.priorities.length > 0) count++;
    if (filters.phases.length > 0) count++;
    if (filters.pWinMin > 0 || filters.pWinMax < 100) count++;
    if (filters.dueDateFrom || filters.dueDateTo) count++;
    return count;
  }, [filters]);
  
  const handleSearchChange = (e) => {
    onFiltersChange({ ...filters, search: e.target.value });
  };
  
  const handlePWinChange = (type, value) => {
    const numValue = parseInt(value, 10);
    if (type === 'min') {
      onFiltersChange({ ...filters, pWinMin: Math.min(numValue, filters.pWinMax) });
    } else {
      onFiltersChange({ ...filters, pWinMax: Math.max(numValue, filters.pWinMin) });
    }
  };
  
  const handleDateChange = (type, value) => {
    onFiltersChange({ ...filters, [type]: value });
  };
  
  const phaseOptions = SHIPLEY_PHASES.map(p => ({ value: p.key, label: p.name, color: p.color }));
  const priorityOptions = PRIORITIES.map(p => ({ value: p.value, label: p.label, color: p.color }));
  const agencyOptions = agencies.map(a => ({ value: a, label: a }));
  
  return (
    <div className="bg-slate-900/80 border-b border-slate-700/50">
      {/* Main Search Bar */}
      <div className="px-6 py-3 flex items-center gap-4">
        {/* Search Input */}
        <div className="relative flex-1 max-w-md">
          <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
          <input
            type="text"
            value={filters.search}
            onChange={handleSearchChange}
            placeholder="Search by name, agency, or solicitation..."
            className="w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500"
          />
        </div>
        
        {/* Toggle Advanced Filters */}
        <Button 
          variant="ghost" 
          size="sm"
          onClick={() => setIsExpanded(!isExpanded)}
          className="flex items-center gap-2"
        >
          <Icon name="filter" className="w-4 h-4" />
          <span>Filters</span>
          {activeFilterCount > 0 && (
            <span className="px-2 py-0.5 bg-cyan-500 text-white text-xs rounded-full">
              {activeFilterCount}
            </span>
          )}
          <Icon name="chevronDown" className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
        </Button>
        
        {/* Clear All */}
        {activeFilterCount > 0 && (
          <Button variant="ghost" size="sm" onClick={onClearAll}>
            <Icon name="x" className="w-4 h-4 mr-1" />
            Clear All
          </Button>
        )}
      </div>
      
      {/* Expanded Filter Options */}
      {isExpanded && (
        <div className="px-6 py-4 border-t border-slate-700/50 bg-slate-800/50 animate-slideUp">
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            {/* Agency Multi-Select */}
            <MultiSelectDropdown
              label="Agency"
              options={agencyOptions}
              selected={filters.agencies}
              onChange={(value) => onFiltersChange({ ...filters, agencies: value })}
              placeholder="All agencies"
            />
            
            {/* Priority Multi-Select */}
            <MultiSelectDropdown
              label="Priority"
              options={priorityOptions}
              selected={filters.priorities}
              onChange={(value) => onFiltersChange({ ...filters, priorities: value })}
              placeholder="All priorities"
            />
            
            {/* Phase Multi-Select */}
            <MultiSelectDropdown
              label="Phase"
              options={phaseOptions}
              selected={filters.phases}
              onChange={(value) => onFiltersChange({ ...filters, phases: value })}
              placeholder="All phases"
            />
            
            {/* pWin Range */}
            <div>
              <label className="block text-xs text-slate-400 mb-1">Win Probability</label>
              <div className="flex items-center gap-2">
                <span className="text-xs text-cyan-400 w-8">{filters.pWinMin}%</span>
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={filters.pWinMin}
                  onChange={(e) => handlePWinChange('min', e.target.value)}
                  className="flex-1"
                />
                <input
                  type="range"
                  min="0"
                  max="100"
                  value={filters.pWinMax}
                  onChange={(e) => handlePWinChange('max', e.target.value)}
                  className="flex-1"
                />
                <span className="text-xs text-cyan-400 w-8">{filters.pWinMax}%</span>
              </div>
            </div>
            
            {/* Due Date From */}
            <div>
              <label className="block text-xs text-slate-400 mb-1">Due From</label>
              <input
                type="date"
                value={filters.dueDateFrom}
                onChange={(e) => handleDateChange('dueDateFrom', e.target.value)}
                className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:outline-none focus:border-cyan-500"
              />
            </div>
            
            {/* Due Date To */}
            <div>
              <label className="block text-xs text-slate-400 mb-1">Due To</label>
              <input
                type="date"
                value={filters.dueDateTo}
                onChange={(e) => handleDateChange('dueDateTo', e.target.value)}
                className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:outline-none focus:border-cyan-500"
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================
// OPPORTUNITY FORM COMPONENT
// ============================================================
const OpportunityForm = ({ opportunity, onSave, onCancel, loading = false, initialPhase = 'gate_1' }) => {
  const [formData, setFormData] = useState({
    name: opportunity?.name || '',
    agency: opportunity?.agency || '',
    contractValue: opportunity?.contractValue || '',
    priority: opportunity?.priority || 'P-1',
    shipleyPhase: opportunity?.shipleyPhase || initialPhase,
    winProbability: opportunity?.winProbability || 50,
    dueDate: opportunity?.dueDate ? new Date(opportunity.dueDate).toISOString().split('T')[0] : '',
    solicitationNumber: opportunity?.solicitationNumber || '',
    description: opportunity?.description || '',
  });
  
  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({
      ...formData,
      contractValue: parseInt(formData.contractValue, 10) || 0,
      winProbability: parseInt(formData.winProbability, 10) || 0,
    });
  };
  
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div className="col-span-2">
          <label className="block text-sm text-slate-400 mb-1">Opportunity Name *</label>
          <input
            type="text"
            value={formData.name}
            onChange={(e) => handleChange('name', e.target.value)}
            required
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
            placeholder="e.g., DHA Healthcare Data Platform"
          />
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Agency *</label>
          <input
            type="text"
            value={formData.agency}
            onChange={(e) => handleChange('agency', e.target.value)}
            required
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
            placeholder="e.g., DHA"
          />
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Contract Value ($)</label>
          <input
            type="number"
            value={formData.contractValue}
            onChange={(e) => handleChange('contractValue', e.target.value)}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
            placeholder="e.g., 50000000"
          />
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Priority</label>
          <select
            value={formData.priority}
            onChange={(e) => handleChange('priority', e.target.value)}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
          >
            {PRIORITIES.map(p => (
              <option key={p.value} value={p.value}>{p.label}</option>
            ))}
          </select>
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Phase</label>
          <select
            value={formData.shipleyPhase}
            onChange={(e) => handleChange('shipleyPhase', e.target.value)}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
          >
            {SHIPLEY_PHASES.map(p => (
              <option key={p.key} value={p.key}>{p.name}</option>
            ))}
          </select>
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Win Probability (%)</label>
          <input
            type="range"
            min="0"
            max="100"
            value={formData.winProbability}
            onChange={(e) => handleChange('winProbability', e.target.value)}
            className="w-full"
          />
          <span className="text-sm text-cyan-400">{formData.winProbability}%</span>
        </div>
        
        <div>
          <label className="block text-sm text-slate-400 mb-1">Due Date</label>
          <input
            type="date"
            value={formData.dueDate}
            onChange={(e) => handleChange('dueDate', e.target.value)}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
          />
        </div>
        
        <div className="col-span-2">
          <label className="block text-sm text-slate-400 mb-1">Solicitation Number</label>
          <input
            type="text"
            value={formData.solicitationNumber}
            onChange={(e) => handleChange('solicitationNumber', e.target.value)}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
            placeholder="e.g., FA8075-24-R-0001"
          />
        </div>
        
        <div className="col-span-2">
          <label className="block text-sm text-slate-400 mb-1">Description</label>
          <textarea
            value={formData.description}
            onChange={(e) => handleChange('description', e.target.value)}
            rows={3}
            className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500 resize-none"
            placeholder="Brief description of the opportunity..."
          />
        </div>
      </div>
      
      <div className="flex justify-end gap-3 pt-4 border-t border-slate-700">
        <Button variant="secondary" type="button" onClick={onCancel}>
          Cancel
        </Button>
        <Button variant="primary" type="submit" loading={loading}>
          {opportunity ? 'Save Changes' : 'Create Opportunity'}
        </Button>
      </div>
    </form>
  );
};

// ============================================================
// DELETE CONFIRM MODAL
// ============================================================
const DeleteConfirmModal = ({ isOpen, onClose, onConfirm, itemName, loading }) => (
  <Modal isOpen={isOpen} onClose={onClose} title="Confirm Delete" size="sm">
    <div className="text-center">
      <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
        <Icon name="trash" className="w-8 h-8 text-red-400" />
      </div>
      <p className="text-slate-300 mb-6">
        Are you sure you want to delete <strong className="text-white">{itemName}</strong>?
        This action cannot be undone.
      </p>
      <div className="flex justify-center gap-3">
        <Button variant="secondary" onClick={onClose}>Cancel</Button>
        <Button variant="danger" onClick={onConfirm} loading={loading}>Delete</Button>
      </div>
    </div>
  </Modal>
);

// ============================================================
// ACTIVITY LOG COMPONENT
// ============================================================
const ActivityLog = ({ opportunityId }) => {
  const [activities, setActivities] = useState([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const fetchActivities = async () => {
      if (!opportunityId || typeof MissionPulse === 'undefined') return;
      
      setLoading(true);
      const { data, error } = await MissionPulse.getActivities(opportunityId, { limit: 20 });
      if (!error && data) {
        setActivities(data);
      }
      setLoading(false);
    };
    
    fetchActivities();
  }, [opportunityId]);
  
  const getActionIcon = (action) => {
    switch (action) {
      case 'created': return 'plus';
      case 'updated': return 'edit';
      case 'phase_changed': return 'arrowRight';
      case 'deleted': return 'trash';
      default: return 'activity';
    }
  };
  
  const getActionColor = (action) => {
    switch (action) {
      case 'created': return 'text-emerald-400 bg-emerald-400/20';
      case 'updated': return 'text-blue-400 bg-blue-400/20';
      case 'phase_changed': return 'text-purple-400 bg-purple-400/20';
      case 'deleted': return 'text-red-400 bg-red-400/20';
      default: return 'text-slate-400 bg-slate-400/20';
    }
  };
  
  const formatTime = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  };
  
  if (loading) {
    return <div className="py-4 text-center text-slate-500 text-sm">Loading activity...</div>;
  }
  
  if (activities.length === 0) {
    return <div className="py-4 text-center text-slate-500 text-sm">No activity recorded</div>;
  }
  
  return (
    <div className="space-y-3">
      {activities.map(activity => (
        <div key={activity.id} className="flex items-start gap-3">
          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${getActionColor(activity.action)}`}>
            <Icon name={getActionIcon(activity.action)} className="w-4 h-4" />
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-sm text-white capitalize">
              {activity.action.replace('_', ' ')}
              {activity.fieldChanged && (
                <span className="text-slate-400"> • {activity.fieldChanged}</span>
              )}
            </p>
            {activity.newValue && (
              <p className="text-xs text-slate-500 truncate">
                {activity.oldValue && <span className="line-through mr-1">{activity.oldValue}</span>}
                → {activity.newValue}
              </p>
            )}
            <p className="text-xs text-slate-600 mt-0.5">{formatTime(activity.createdAt)}</p>
          </div>
        </div>
      ))}
    </div>
  );
};

// ============================================================
// OPPORTUNITY DRAWER
// ============================================================
const OpportunityDrawer = ({ 
  opportunity, 
  onClose, 
  onEdit, 
  onDelete, 
  onPhaseChange 
}) => {
  if (!opportunity) return null;
  
  const phase = SHIPLEY_PHASES.find(p => p.key === opportunity.shipleyPhase) || SHIPLEY_PHASES[0];
  const priority = PRIORITIES.find(p => p.value === opportunity.priority) || PRIORITIES[1];
  
  const formatCurrency = (value) => {
    if (!value) return '$0';
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value.toLocaleString()}`;
  };
  
  const getDaysRemaining = () => {
    if (!opportunity.dueDate) return null;
    const due = new Date(opportunity.dueDate);
    const now = new Date();
    const diff = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
    return diff;
  };
  
  const days = getDaysRemaining();
  
  return (
    <div className="fixed inset-y-0 right-0 w-full max-w-md z-40 flex">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="relative ml-auto h-full w-full max-w-md bg-slate-900 border-l border-slate-700 animate-slideIn overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-slate-900 border-b border-slate-700 px-6 py-4 z-10">
          <div className="flex items-start justify-between">
            <div className="flex-1 min-w-0">
              <h2 className="text-lg font-semibold text-white truncate">{opportunity.name}</h2>
              <p className="text-sm text-slate-400">{opportunity.agency}</p>
            </div>
            <button onClick={onClose} className="p-1 hover:bg-slate-700 rounded-lg">
              <Icon name="x" className="w-5 h-5 text-slate-400" />
            </button>
          </div>
        </div>
        
        {/* Content */}
        <div className="p-6 space-y-6">
          {/* Quick Stats */}
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-slate-800/50 rounded-lg p-4">
              <p className="text-xs text-slate-500 mb-1">Contract Value</p>
              <p className="text-xl font-bold text-emerald-400">{formatCurrency(opportunity.contractValue)}</p>
            </div>
            <div className="bg-slate-800/50 rounded-lg p-4">
              <p className="text-xs text-slate-500 mb-1">Win Probability</p>
              <p className="text-xl font-bold text-cyan-400">{opportunity.winProbability || 0}%</p>
            </div>
          </div>
          
          {/* Phase Dropdown */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Current Phase</label>
            <select
              value={opportunity.shipleyPhase}
              onChange={(e) => onPhaseChange(e.target.value)}
              className="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-cyan-500"
              style={{ borderLeftColor: phase.color, borderLeftWidth: '4px' }}
            >
              {SHIPLEY_PHASES.map(p => (
                <option key={p.key} value={p.key}>{p.name}</option>
              ))}
            </select>
          </div>
          
          {/* Details */}
          <div className="space-y-3">
            <div className="flex justify-between py-2 border-b border-slate-700/50">
              <span className="text-sm text-slate-400">Priority</span>
              <span className="text-sm font-medium" style={{ color: priority.color }}>{priority.value}</span>
            </div>
            
            {opportunity.solicitationNumber && (
              <div className="flex justify-between py-2 border-b border-slate-700/50">
                <span className="text-sm text-slate-400">Solicitation #</span>
                <span className="text-sm text-white font-mono">{opportunity.solicitationNumber}</span>
              </div>
            )}
            
            {opportunity.dueDate && (
              <div className="flex justify-between py-2 border-b border-slate-700/50">
                <span className="text-sm text-slate-400">Due Date</span>
                <span className={`text-sm font-medium ${days !== null && days <= 3 ? 'text-red-400' : 'text-white'}`}>
                  {new Date(opportunity.dueDate).toLocaleDateString()}
                  {days !== null && (
                    <span className="ml-2 text-xs text-slate-500">
                      ({days === 0 ? 'Today' : days === 1 ? '1 day' : `${days} days`})
                    </span>
                  )}
                </span>
              </div>
            )}
          </div>
          
          {/* Description */}
          {opportunity.description && (
            <div>
              <p className="text-sm text-slate-400 mb-2">Description</p>
              <p className="text-sm text-slate-300 bg-slate-800/50 rounded-lg p-3">
                {opportunity.description}
              </p>
            </div>
          )}
          
          {/* Actions */}
          <div className="flex gap-3">
            <Button variant="primary" className="flex-1" onClick={onEdit}>
              <Icon name="edit" className="w-4 h-4 mr-2" />
              Edit
            </Button>
            <Button variant="danger" onClick={onDelete}>
              <Icon name="trash" className="w-4 h-4" />
            </Button>
          </div>
          
          {/* Activity Log */}
          <div>
            <h3 className="text-sm font-medium text-white mb-3 flex items-center gap-2">
              <Icon name="activity" className="w-4 h-4 text-cyan-400" />
              Activity Log
            </h3>
            <ActivityLog opportunityId={opportunity.id} />
          </div>
        </div>
      </div>
    </div>
  );
};

// ============================================================
// OPPORTUNITY CARD
// ============================================================
const OpportunityCard = ({ opportunity, onClick, isDragging, onDragStart, onDragEnd }) => {
  const priority = PRIORITIES.find(p => p.value === opportunity.priority) || PRIORITIES[1];
  
  const formatCurrency = (value) => {
    if (!value) return '$0';
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value.toLocaleString()}`;
  };
  
  const getDaysRemaining = () => {
    if (!opportunity.dueDate) return null;
    const due = new Date(opportunity.dueDate);
    const now = new Date();
    return Math.ceil((due - now) / (1000 * 60 * 60 * 24));
  };
  
  const days = getDaysRemaining();
  const pWin = opportunity.winProbability || opportunity.pWin || 0;
  
  return (
    <div
      draggable
      onDragStart={(e) => onDragStart(e, opportunity)}
      onDragEnd={onDragEnd}
      onClick={() => onClick(opportunity)}
      className={`bg-slate-800/70 hover:bg-slate-800 border border-slate-700/50 hover:border-slate-600 rounded-xl p-4 cursor-pointer transition-all mb-3 ${
        isDragging ? 'opacity-50 dragging' : ''
      }`}
    >
      {/* Header */}
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1 min-w-0">
          <h4 className="text-sm font-medium text-white truncate">{opportunity.name}</h4>
          <p className="text-xs text-slate-500">{opportunity.agency}</p>
        </div>
        <span 
          className="px-2 py-0.5 text-xs font-semibold rounded"
          style={{ backgroundColor: `${priority.color}20`, color: priority.color }}
        >
          {priority.value}
        </span>
      </div>
      
      {/* Value & Due Date */}
      <div className="flex items-center justify-between mb-3">
        <span className="text-sm font-semibold text-emerald-400">
          {formatCurrency(opportunity.contractValue)}
        </span>
        {days !== null && (
          <span className={`text-xs flex items-center gap-1 ${
            days <= 0 ? 'text-red-400' : days <= 3 ? 'text-amber-400' : 'text-slate-400'
          }`}>
            <Icon name="clock" className="w-3 h-3" />
            {days <= 0 ? 'Overdue' : days === 1 ? '1 day' : `${days}d`}
          </span>
        )}
      </div>
      
      {/* pWin Progress Bar */}
      <div>
        <div className="flex items-center justify-between text-xs mb-1">
          <span className="text-slate-500">Win Prob</span>
          <span className="text-cyan-400 font-medium">{pWin}%</span>
        </div>
        <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
          <div 
            className="h-full rounded-full transition-all duration-500"
            style={{ 
              width: `${pWin}%`,
              backgroundColor: pWin >= 70 ? '#22c55e' : pWin >= 40 ? '#eab308' : '#ef4444'
            }}
          />
        </div>
      </div>
    </div>
  );
};

// ============================================================
// PHASE COLUMN
// ============================================================
const PhaseColumn = ({ 
  phase, 
  opportunities, 
  onCardClick, 
  onAddClick,
  onDrop,
  draggedItem 
}) => {
  const [isDragOver, setIsDragOver] = useState(false);
  
  const phaseOpps = opportunities.filter(o => o.shipleyPhase === phase.key);
  const totalValue = phaseOpps.reduce((sum, o) => sum + (o.contractValue || 0), 0);
  
  const handleDragOver = (e) => {
    e.preventDefault();
    if (draggedItem && draggedItem.shipleyPhase !== phase.key) {
      setIsDragOver(true);
    }
  };
  
  const handleDragLeave = () => {
    setIsDragOver(false);
  };
  
  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragOver(false);
    if (draggedItem && draggedItem.shipleyPhase !== phase.key) {
      onDrop(draggedItem, phase.key);
    }
  };
  
  const formatValue = (value) => {
    if (!value) return '$0';
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value.toLocaleString()}`;
  };
  
  return (
    <div className="flex-shrink-0 w-72 flex flex-col">
      {/* Column Header */}
      <div 
        className="bg-slate-800/50 border border-slate-700/30 rounded-t-xl p-4"
        style={{ borderTopColor: phase.color, borderTopWidth: '3px' }}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-sm font-semibold text-white">{phase.name}</span>
            <span className="px-2 py-0.5 text-xs bg-slate-700 text-slate-300 rounded-full">
              {phaseOpps.length}
            </span>
          </div>
        </div>
        {phaseOpps.length > 0 && (
          <div className="mt-2 flex items-center gap-1 text-xs">
            <Icon name="dollar" className="w-3 h-3 text-emerald-400" />
            <span className="text-emerald-400 font-semibold">{formatValue(totalValue)}</span>
            <span className="text-slate-500">pipeline</span>
          </div>
        )}
      </div>
      
      {/* Cards Container */}
      <div 
        className={`flex-1 bg-slate-900/30 border-x border-slate-700/30 p-3 overflow-y-auto scrollbar-thin min-h-[400px] transition-colors ${
          isDragOver ? 'drop-zone-active' : ''
        }`}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
      >
        {phaseOpps.length === 0 ? (
          <div className="h-full flex items-center justify-center">
            <div className="text-center p-4">
              <div 
                className="w-10 h-10 rounded-full mx-auto mb-2 flex items-center justify-center opacity-30"
                style={{ backgroundColor: `${phase.color}30` }}
              >
                <Icon name="target" className="w-5 h-5" style={{ color: phase.color }} />
              </div>
              <p className="text-xs text-slate-600">No opportunities</p>
            </div>
          </div>
        ) : (
          phaseOpps.map(opp => (
            <OpportunityCard 
              key={opp.id} 
              opportunity={opp}
              onClick={onCardClick}
              isDragging={draggedItem?.id === opp.id}
              onDragStart={() => {}}
              onDragEnd={() => {}}
            />
          ))
        )}
      </div>
      
      {/* Column Footer */}
      <div className="bg-slate-800/50 border border-slate-700/30 border-t-0 rounded-b-xl p-2">
        <button 
          onClick={() => onAddClick(phase.key)}
          className="w-full py-2 text-xs text-slate-500 hover:text-cyan-400 hover:bg-slate-700/30 rounded-lg transition-all flex items-center justify-center gap-1"
        >
          <Icon name="plus" className="w-3 h-3" />
          Add Opportunity
        </button>
      </div>
    </div>
  );
};

// ============================================================
// TABLE VIEW
// ============================================================
const TableView = ({ opportunities, onRowClick, onSort, sortConfig }) => {
  const formatCurrency = (value) => {
    if (!value) return '$0';
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value.toLocaleString()}`;
  };
  
  const getPhaseInfo = (phaseKey) => {
    return SHIPLEY_PHASES.find(p => p.key === phaseKey) || SHIPLEY_PHASES[0];
  };
  
  const getPriorityInfo = (priorityValue) => {
    return PRIORITIES.find(p => p.value === priorityValue) || PRIORITIES[1];
  };
  
  const columns = [
    { key: 'name', label: 'Opportunity', sortable: true },
    { key: 'agency', label: 'Agency', sortable: true },
    { key: 'priority', label: 'Priority', sortable: true },
    { key: 'shipleyPhase', label: 'Phase', sortable: true },
    { key: 'contractValue', label: 'Value', sortable: true },
    { key: 'winProbability', label: 'pWin', sortable: true },
    { key: 'dueDate', label: 'Due Date', sortable: true },
  ];
  
  const handleSort = (key) => {
    if (!onSort) return;
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    onSort({ key, direction });
  };
  
  return (
    <div className="overflow-x-auto">
      <table className="w-full">
        <thead>
          <tr className="border-b border-slate-700">
            {columns.map(col => (
              <th 
                key={col.key}
                onClick={() => col.sortable && handleSort(col.key)}
                className={`px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider ${
                  col.sortable ? 'cursor-pointer hover:text-white' : ''
                }`}
              >
                <div className="flex items-center gap-1">
                  {col.label}
                  {col.sortable && sortConfig.key === col.key && (
                    <Icon 
                      name={sortConfig.direction === 'asc' ? 'sortAsc' : 'sortDesc'} 
                      className="w-4 h-4" 
                    />
                  )}
                </div>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {opportunities.map((opp, index) => {
            const phase = getPhaseInfo(opp.shipleyPhase);
            const priority = getPriorityInfo(opp.priority);
            
            return (
              <tr 
                key={opp.id}
                onClick={() => onRowClick(opp)}
                className={`border-b border-slate-700/50 hover:bg-slate-800/50 cursor-pointer transition-colors ${
                  index % 2 === 0 ? 'bg-slate-900/30' : ''
                }`}
              >
                <td className="px-4 py-3">
                  <div>
                    <p className="text-sm font-medium text-white">{opp.name}</p>
                    {opp.solicitationNumber && (
                      <p className="text-xs text-slate-500 font-mono">{opp.solicitationNumber}</p>
                    )}
                  </div>
                </td>
                <td className="px-4 py-3 text-sm text-slate-300">{opp.agency}</td>
                <td className="px-4 py-3">
                  <span 
                    className="px-2 py-0.5 text-xs font-semibold rounded"
                    style={{ backgroundColor: `${priority.color}20`, color: priority.color }}
                  >
                    {priority.value}
                  </span>
                </td>
                <td className="px-4 py-3">
                  <span 
                    className="px-2 py-1 text-xs rounded flex items-center gap-1.5 w-fit"
                    style={{ backgroundColor: `${phase.color}20`, color: phase.color }}
                  >
                    <span 
                      className="w-2 h-2 rounded-full"
                      style={{ backgroundColor: phase.color }}
                    />
                    {phase.name}
                  </span>
                </td>
                <td className="px-4 py-3 text-sm font-medium text-emerald-400">
                  {formatCurrency(opp.contractValue)}
                </td>
                <td className="px-4 py-3">
                  <div className="flex items-center gap-2">
                    <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                      <div 
                        className="h-full rounded-full"
                        style={{ 
                          width: `${opp.winProbability || 0}%`,
                          backgroundColor: (opp.winProbability || 0) >= 70 ? '#22c55e' : (opp.winProbability || 0) >= 40 ? '#eab308' : '#ef4444'
                        }}
                      />
                    </div>
                    <span className="text-xs text-cyan-400">{opp.winProbability || 0}%</span>
                  </div>
                </td>
                <td className="px-4 py-3 text-sm text-slate-300">
                  {opp.dueDate ? new Date(opp.dueDate).toLocaleDateString() : '-'}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
      
      {opportunities.length === 0 && (
        <div className="py-12 text-center">
          <Icon name="search" className="w-12 h-12 text-slate-600 mx-auto mb-4" />
          <p className="text-slate-500">No opportunities match your filters</p>
        </div>
      )}
    </div>
  );
};

// ============================================================
// MAIN SHIPLEY SWIMLANE BOARD COMPONENT
// ============================================================
const ShipleySwimLaneBoard = () => {
  // State
  const [opportunities, setOpportunities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [connectionStatus, setConnectionStatus] = useState('disconnected');
  const [activeView, setActiveView] = useState('board'); // board | table
  
  // Filter State
  const [filters, setFilters] = useState({
    search: '',
    agencies: [],
    priorities: [],
    phases: [],
    pWinMin: 0,
    pWinMax: 100,
    dueDateFrom: '',
    dueDateTo: '',
  });
  const [uniqueAgencies, setUniqueAgencies] = useState([]);
  
  // Modal State
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [selectedOpportunity, setSelectedOpportunity] = useState(null);
  const [editingOpportunity, setEditingOpportunity] = useState(null);
  const [initialPhase, setInitialPhase] = useState('gate_1');
  const [saving, setSaving] = useState(false);
  
  // Drag State
  const [draggedItem, setDraggedItem] = useState(null);
  
  // Sort State (for table view)
  const [sortConfig, setSortConfig] = useState({ key: 'dueDate', direction: 'asc' });
  
  const { addToast } = useToast();
  const scrollRef = useRef(null);
  
  // Fetch opportunities
  const fetchOpportunities = useCallback(async () => {
    if (typeof MissionPulse === 'undefined') {
      setError('MissionPulse client not loaded');
      setLoading(false);
      return;
    }
    
    const { data, error: fetchError } = await MissionPulse.getOpportunities();
    
    if (fetchError) {
      setError(fetchError.message);
      addToast('Failed to load opportunities', 'error');
    } else {
      setOpportunities(data || []);
      
      // Extract unique agencies
      const agencies = [...new Set((data || []).map(d => d.agency).filter(Boolean))].sort();
      setUniqueAgencies(agencies);
    }
    
    setLoading(false);
  }, [addToast]);
  
  // Initial load and subscription
  useEffect(() => {
    fetchOpportunities();
    
    if (typeof MissionPulse !== 'undefined') {
      const unsubscribe = MissionPulse.subscribeToOpportunities(() => {
        fetchOpportunities();
      });
      
      const unsubscribeConnection = MissionPulse.onConnectionChange((status) => {
        setConnectionStatus(status);
      });
      
      return () => {
        unsubscribe();
        unsubscribeConnection();
      };
    }
  }, [fetchOpportunities]);
  
  // Apply filters to opportunities
  const filteredOpportunities = useMemo(() => {
    let result = [...opportunities];
    
    // Search filter (name, agency, solicitation number)
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      result = result.filter(opp => 
        (opp.name && opp.name.toLowerCase().includes(searchLower)) ||
        (opp.agency && opp.agency.toLowerCase().includes(searchLower)) ||
        (opp.solicitationNumber && opp.solicitationNumber.toLowerCase().includes(searchLower))
      );
    }
    
    // Agency filter
    if (filters.agencies.length > 0) {
      result = result.filter(opp => filters.agencies.includes(opp.agency));
    }
    
    // Priority filter
    if (filters.priorities.length > 0) {
      result = result.filter(opp => filters.priorities.includes(opp.priority));
    }
    
    // Phase filter
    if (filters.phases.length > 0) {
      result = result.filter(opp => filters.phases.includes(opp.shipleyPhase));
    }
    
    // pWin range filter
    result = result.filter(opp => {
      const pWin = opp.winProbability || 0;
      return pWin >= filters.pWinMin && pWin <= filters.pWinMax;
    });
    
    // Due date range filter
    if (filters.dueDateFrom) {
      const fromDate = new Date(filters.dueDateFrom);
      result = result.filter(opp => {
        if (!opp.dueDate) return false;
        return new Date(opp.dueDate) >= fromDate;
      });
    }
    if (filters.dueDateTo) {
      const toDate = new Date(filters.dueDateTo);
      toDate.setHours(23, 59, 59, 999);
      result = result.filter(opp => {
        if (!opp.dueDate) return false;
        return new Date(opp.dueDate) <= toDate;
      });
    }
    
    // Sort for table view
    if (activeView === 'table' && sortConfig.key) {
      result.sort((a, b) => {
        let aVal = a[sortConfig.key];
        let bVal = b[sortConfig.key];
        
        // Handle different types
        if (sortConfig.key === 'contractValue' || sortConfig.key === 'winProbability') {
          aVal = aVal || 0;
          bVal = bVal || 0;
        } else if (sortConfig.key === 'dueDate') {
          aVal = aVal ? new Date(aVal).getTime() : Infinity;
          bVal = bVal ? new Date(bVal).getTime() : Infinity;
        } else {
          aVal = (aVal || '').toLowerCase();
          bVal = (bVal || '').toLowerCase();
        }
        
        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    return result;
  }, [opportunities, filters, activeView, sortConfig]);
  
  // Clear all filters
  const handleClearFilters = () => {
    setFilters({
      search: '',
      agencies: [],
      priorities: [],
      phases: [],
      pWinMin: 0,
      pWinMax: 100,
      dueDateFrom: '',
      dueDateTo: '',
    });
  };
  
  // Card click handler
  const handleCardClick = (opp) => {
    setSelectedOpportunity(opp);
  };
  
  // Add opportunity
  const handleAddClick = (phaseKey) => {
    setInitialPhase(phaseKey);
    setShowAddModal(true);
  };
  
  const handleCreate = async (data) => {
    if (typeof MissionPulse === 'undefined') return;
    
    setSaving(true);
    const { data: newOpp, error } = await MissionPulse.createOpportunity(data);
    setSaving(false);
    
    if (error) {
      addToast('Failed to create opportunity', 'error');
    } else {
      addToast('Opportunity created successfully', 'success');
      setShowAddModal(false);
      fetchOpportunities();
      
      // Log activity
      if (newOpp?.id) {
        MissionPulse.logActivity({
          opportunityId: newOpp.id,
          action: 'created',
          newValue: newOpp.name
        });
      }
    }
  };
  
  // Edit opportunity
  const handleEdit = () => {
    setEditingOpportunity(selectedOpportunity);
    setShowEditModal(true);
  };
  
  const handleUpdate = async (data) => {
    if (typeof MissionPulse === 'undefined' || !editingOpportunity) return;
    
    setSaving(true);
    const { error } = await MissionPulse.updateOpportunity(editingOpportunity.id, data);
    setSaving(false);
    
    if (error) {
      addToast('Failed to update opportunity', 'error');
    } else {
      addToast('Opportunity updated successfully', 'success');
      setShowEditModal(false);
      setEditingOpportunity(null);
      setSelectedOpportunity(null);
      fetchOpportunities();
    }
  };
  
  // Delete opportunity
  const handleDelete = () => {
    setShowDeleteModal(true);
  };
  
  const handleConfirmDelete = async () => {
    if (typeof MissionPulse === 'undefined' || !selectedOpportunity) return;
    
    setSaving(true);
    const { error } = await MissionPulse.deleteOpportunity(selectedOpportunity.id);
    setSaving(false);
    
    if (error) {
      addToast('Failed to delete opportunity', 'error');
    } else {
      addToast('Opportunity deleted', 'success');
      setShowDeleteModal(false);
      setSelectedOpportunity(null);
      fetchOpportunities();
    }
  };
  
  // Phase change (from drawer)
  const handlePhaseChange = async (newPhase) => {
    if (typeof MissionPulse === 'undefined' || !selectedOpportunity) return;
    
    const oldPhase = selectedOpportunity.shipleyPhase;
    const { error } = await MissionPulse.updateOpportunity(selectedOpportunity.id, { shipleyPhase: newPhase });
    
    if (error) {
      addToast('Failed to update phase', 'error');
    } else {
      addToast('Phase updated', 'success');
      
      // Log phase change activity
      const oldPhaseName = SHIPLEY_PHASES.find(p => p.key === oldPhase)?.name || oldPhase;
      const newPhaseName = SHIPLEY_PHASES.find(p => p.key === newPhase)?.name || newPhase;
      MissionPulse.logActivity({
        opportunityId: selectedOpportunity.id,
        action: 'phase_changed',
        fieldChanged: 'phase',
        oldValue: oldPhaseName,
        newValue: newPhaseName
      });
      
      fetchOpportunities();
    }
  };
  
  // Drag and drop handlers
  const handleDragStart = (e, opp) => {
    setDraggedItem(opp);
    e.dataTransfer.effectAllowed = 'move';
  };
  
  const handleDragEnd = () => {
    setDraggedItem(null);
  };
  
  const handleDrop = async (opp, newPhaseKey) => {
    if (typeof MissionPulse === 'undefined') return;
    
    const oldPhase = opp.shipleyPhase;
    const { error } = await MissionPulse.updateOpportunity(opp.id, { shipleyPhase: newPhaseKey });
    
    if (error) {
      addToast('Failed to move opportunity', 'error');
    } else {
      addToast('Moved to ' + (SHIPLEY_PHASES.find(p => p.key === newPhaseKey)?.name || newPhaseKey), 'success');
      
      // Log activity
      const oldPhaseName = SHIPLEY_PHASES.find(p => p.key === oldPhase)?.name || oldPhase;
      const newPhaseName = SHIPLEY_PHASES.find(p => p.key === newPhaseKey)?.name || newPhaseKey;
      MissionPulse.logActivity({
        opportunityId: opp.id,
        action: 'phase_changed',
        fieldChanged: 'phase',
        oldValue: oldPhaseName,
        newValue: newPhaseName
      });
      
      fetchOpportunities();
    }
    
    setDraggedItem(null);
  };
  
  // Calculate stats
  const stats = useMemo(() => {
    const totalValue = opportunities.reduce((sum, o) => sum + (o.contractValue || 0), 0);
    const urgentCount = opportunities.filter(o => {
      if (!o.dueDate) return false;
      const days = Math.ceil((new Date(o.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
      return days >= 0 && days <= 3;
    }).length;
    
    return { totalValue, urgentCount, count: opportunities.length };
  }, [opportunities]);
  
  const formatCurrency = (value) => {
    if (!value) return '$0';
    if (value >= 1000000000) return `$${(value / 1000000000).toFixed(1)}B`;
    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;
    return `$${value.toLocaleString()}`;
  };
  
  if (loading) {
    return (
      <div className="min-h-screen bg-[#00050F] flex items-center justify-center">
        <LoadingState message="Loading pipeline..." />
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="min-h-screen bg-[#00050F] flex items-center justify-center">
        <ErrorState message={error} onRetry={fetchOpportunities} />
      </div>
    );
  }
  
  return (
    <div className="min-h-screen bg-[#00050F]">
      {/* Header */}
      <header className="bg-slate-900/80 border-b border-slate-700/50 px-6 py-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
              <Icon name="shield" className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-white">Pipeline Board</h1>
              <p className="text-sm text-slate-400">
                {stats.count} opportunities • {formatCurrency(stats.totalValue)} total pipeline
              </p>
            </div>
          </div>
          
          {/* Right side controls */}
          <div className="flex items-center gap-4">
            <ConnectionStatus status={connectionStatus} />
            
            {stats.urgentCount > 0 && (
              <div className="flex items-center gap-2 px-3 py-1.5 bg-red-500/20 border border-red-500/30 rounded-lg">
                <Icon name="alert" className="w-4 h-4 text-red-400" />
                <span className="text-red-400 text-sm font-semibold">{stats.urgentCount} urgent</span>
              </div>
            )}
            
            {/* View Toggle */}
            <div className="flex items-center gap-1 bg-slate-800 rounded-lg p-1">
              <button
                onClick={() => setActiveView('board')}
                className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${
                  activeView === 'board' 
                    ? 'bg-cyan-500 text-white' 
                    : 'text-slate-400 hover:text-white hover:bg-slate-700'
                }`}
              >
                <Icon name="grid" className="w-3.5 h-3.5" />
                Board
              </button>
              <button
                onClick={() => setActiveView('table')}
                className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5 ${
                  activeView === 'table' 
                    ? 'bg-cyan-500 text-white' 
                    : 'text-slate-400 hover:text-white hover:bg-slate-700'
                }`}
              >
                <Icon name="table" className="w-3.5 h-3.5" />
                Table
              </button>
            </div>
            
            <Button variant="primary" size="sm" onClick={() => handleAddClick('gate_1')}>
              <Icon name="plus" className="w-4 h-4 mr-1" />
              Add Opportunity
            </Button>
          </div>
        </div>
      </header>
      
      {/* Search & Filter Bar */}
      <SearchFilterBar 
        filters={filters}
        onFiltersChange={setFilters}
        agencies={uniqueAgencies}
        onClearAll={handleClearFilters}
      />
      
      {/* Main Content */}
      {activeView === 'board' ? (
        <>
          {/* Phase Legend */}
          <div className="bg-slate-800/30 border-b border-slate-700/30 px-6 py-3">
            <div className="flex items-center gap-2 overflow-x-auto scrollbar-thin">
              <span className="text-xs text-slate-500 mr-2">Phases:</span>
              {SHIPLEY_PHASES.map((phase, i) => (
                <React.Fragment key={phase.key}>
                  <div className="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-slate-800/50">
                    <div 
                      className="w-2 h-2 rounded-full"
                      style={{ backgroundColor: phase.color }}
                    />
                    <span className="text-xs text-slate-300 whitespace-nowrap">{phase.name}</span>
                  </div>
                  {i < SHIPLEY_PHASES.length - 1 && (
                    <Icon name="chevronRight" className="w-3 h-3 text-slate-600 flex-shrink-0" />
                  )}
                </React.Fragment>
              ))}
            </div>
          </div>
          
          {/* Swimlane Board */}
          <div 
            ref={scrollRef}
            className="flex gap-4 p-6 overflow-x-auto scrollbar-thin"
            style={{ minHeight: 'calc(100vh - 280px)' }}
            onDragOver={(e) => e.preventDefault()}
          >
            {SHIPLEY_PHASES.map((phase) => (
              <PhaseColumn
                key={phase.key}
                phase={phase}
                opportunities={filteredOpportunities}
                onCardClick={handleCardClick}
                onAddClick={handleAddClick}
                onDrop={handleDrop}
                draggedItem={draggedItem}
              />
            ))}
          </div>
        </>
      ) : (
        /* Table View */
        <div className="p-6">
          <div className="bg-slate-900/50 border border-slate-700/50 rounded-xl overflow-hidden">
            <TableView 
              opportunities={filteredOpportunities}
              onRowClick={handleCardClick}
              sortConfig={sortConfig}
              onSort={setSortConfig}
            />
          </div>
        </div>
      )}
      
      {/* Footer */}
      <footer className="fixed bottom-0 left-0 right-0 bg-slate-900/95 border-t border-slate-700/50 px-6 py-2">
        <div className="flex items-center justify-between">
          <span className="text-xs text-slate-500">MissionPulse v12 Sprint 7 • {filteredOpportunities.length} of {opportunities.length} shown</span>
          <span className="text-xs text-slate-600">AI GENERATED - REQUIRES HUMAN REVIEW</span>
        </div>
      </footer>
      
      {/* Opportunity Drawer */}
      {selectedOpportunity && !showEditModal && (
        <OpportunityDrawer
          opportunity={selectedOpportunity}
          onClose={() => setSelectedOpportunity(null)}
          onEdit={handleEdit}
          onDelete={handleDelete}
          onPhaseChange={handlePhaseChange}
        />
      )}
      
      {/* Add Modal */}
      <Modal isOpen={showAddModal} onClose={() => setShowAddModal(false)} title="Add Opportunity" size="lg">
        <OpportunityForm 
          onSave={handleCreate}
          onCancel={() => setShowAddModal(false)}
          loading={saving}
          initialPhase={initialPhase}
        />
      </Modal>
      
      {/* Edit Modal */}
      <Modal isOpen={showEditModal} onClose={() => { setShowEditModal(false); setEditingOpportunity(null); }} title="Edit Opportunity" size="lg">
        <OpportunityForm 
          opportunity={editingOpportunity}
          onSave={handleUpdate}
          onCancel={() => { setShowEditModal(false); setEditingOpportunity(null); }}
          loading={saving}
        />
      </Modal>
      
      {/* Delete Confirmation Modal */}
      <DeleteConfirmModal 
        isOpen={showDeleteModal}
        onClose={() => setShowDeleteModal(false)}
        onConfirm={handleConfirmDelete}
        itemName={selectedOpportunity?.name}
        loading={saving}
      />
    </div>
  );
};

// ============================================================
// APP ROOT
// ============================================================
const App = () => (
  <ToastProvider>
    <ShipleySwimLaneBoard />
  </ToastProvider>
);

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
