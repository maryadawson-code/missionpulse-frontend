<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MissionPulse - HITL Review Queue</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #00050F; min-height: 100vh; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-ping { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
  </style>
  <script src="rbac-guard.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ============================================================================
    // SUPABASE CLIENT
    // ============================================================================
    const SUPABASE_URL = 'https://qdrtpnpnhkxvfmvfziop.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcnRwbnBuaGt4dmZtdmZ6aW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MjMwMzcsImV4cCI6MjA1MzM5OTAzN30.sGmvSPxaAjOjFkFkqU3MRajBSFjHlxgNQSeS07l0bH0';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================================================
    // RBAC CONFIGURATION
    // ============================================================================
    const ALLOWED_ROLES = ['CEO', 'COO', 'QA', 'PM', 'SA', 'CAP', 'Admin'];
    
    const checkAccess = (userRole) => {
      return ALLOWED_ROLES.includes(userRole);
    };

    // ============================================================================
    // DESIGN TOKENS
    // ============================================================================
    const TOKENS = {
      colors: {
        primary: '#00E5FA',
        secondary: '#0891B2',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        navy: '#00050F',
        surface: 'rgba(15, 23, 42, 0.8)',
        border: 'rgba(51, 65, 85, 0.5)'
      }
    };

    // ============================================================================
    // ICONS
    // ============================================================================
    const Icons = {
      shield: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      check: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      x: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      pencil: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>,
      eye: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      clock: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6l4 2" /></svg>,
      user: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      filter: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
      clipboard: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
      cpu: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>,
      activity: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M22 12h-4l-3 9L9 3l-3 9H2" /></svg>,
      zap: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
      alertTriangle: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      fileText: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      refresh: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      list: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>,
      arrowUp: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>,
      arrowLeft: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
      database: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3" strokeWidth={2}/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path strokeWidth={2} d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
      save: () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
    };

    const Icon = ({ name, className = "w-4 h-4" }) => {
      const IconComponent = Icons[name];
      return IconComponent ? <span className={`inline-block ${className}`}><IconComponent /></span> : null;
    };

    // ============================================================================
    // UI COMPONENTS
    // ============================================================================
    const Card = ({ children, className = '', glow = false, onClick }) => (
      <div 
        onClick={onClick} 
        className={`
          bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl 
          transition-all duration-300 
          ${onClick ? 'cursor-pointer hover:border-cyan-500/50 hover:bg-slate-800/70' : ''} 
          ${glow ? 'shadow-lg shadow-cyan-500/20 border-cyan-500/30' : ''} 
          ${className}
        `}
      >
        {children}
      </div>
    );

    const Button = ({ children, variant = 'primary', size = 'md', icon, className = '', disabled = false, pulse = false, ...props }) => {
      const variants = { 
        primary: 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white hover:from-cyan-400 hover:to-teal-400 shadow-lg shadow-cyan-500/25', 
        secondary: 'bg-slate-700 text-white hover:bg-slate-600 border border-slate-600', 
        success: 'bg-emerald-500 text-white hover:bg-emerald-400 shadow-lg shadow-emerald-500/25', 
        danger: 'bg-red-500 text-white hover:bg-red-400 shadow-lg shadow-red-500/25',
        warning: 'bg-amber-500 text-white hover:bg-amber-400 shadow-lg shadow-amber-500/25',
        ghost: 'bg-transparent text-slate-400 hover:text-white hover:bg-slate-700/50', 
        gold: 'bg-gradient-to-r from-amber-400 to-yellow-500 text-slate-900 hover:from-amber-300 hover:to-yellow-400 shadow-lg shadow-amber-500/25' 
      };
      const sizes = { xs: 'px-2 py-1 text-xs', sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2 text-sm', lg: 'px-6 py-3 text-base' };
      return (
        <button 
          className={`
            inline-flex items-center justify-center gap-2 font-semibold rounded-lg 
            transition-all duration-200 
            ${variants[variant]} 
            ${sizes[size]} 
            ${disabled ? 'opacity-50 cursor-not-allowed' : ''} 
            ${pulse ? 'animate-pulse' : ''} 
            ${className}
          `} 
          disabled={disabled} 
          {...props}
        >
          {icon && <Icon name={icon} className="w-4 h-4" />}{children}
        </button>
      );
    };

    const Badge = ({ children, variant = 'default', size = 'sm', icon }) => {
      const variants = { 
        default: 'bg-slate-700 text-slate-300', 
        primary: 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30', 
        success: 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30', 
        warning: 'bg-amber-500/20 text-amber-400 border border-amber-500/30', 
        danger: 'bg-red-500/20 text-red-400 border border-red-500/30',
        purple: 'bg-purple-500/20 text-purple-400 border border-purple-500/30'
      };
      const sizes = { xs: 'px-1.5 py-0.5 text-xs', sm: 'px-2 py-1 text-xs', md: 'px-3 py-1.5 text-sm' };
      return (
        <span className={`inline-flex items-center gap-1.5 rounded-full font-medium ${variants[variant]} ${sizes[size]}`}>
          {icon && <Icon name={icon} className="w-3 h-3" />}{children}
        </span>
      );
    };

    const Checkbox = ({ checked, onChange, indeterminate = false }) => (
      <button 
        onClick={() => onChange(!checked)}
        className={`
          w-5 h-5 rounded border-2 flex items-center justify-center transition-all
          ${checked || indeterminate 
            ? 'bg-cyan-500 border-cyan-500' 
            : 'border-slate-500 hover:border-cyan-400'}
        `}
      >
        {checked && <Icon name="check" className="w-3 h-3 text-white" />}
        {indeterminate && !checked && <div className="w-2.5 h-0.5 bg-white rounded" />}
      </button>
    );

    // ============================================================================
    // CONFIDENCE GAUGE COMPONENT
    // ============================================================================
    const ConfidenceGauge = ({ score, size = 'md' }) => {
      const getColor = (s) => {
        if (s >= 85) return { ring: 'stroke-emerald-500', bg: 'bg-emerald-500', text: 'text-emerald-400', label: 'Auto-Approvable' };
        if (s >= 70) return { ring: 'stroke-amber-500', bg: 'bg-amber-500', text: 'text-amber-400', label: 'Needs Review' };
        return { ring: 'stroke-red-500', bg: 'bg-red-500', text: 'text-red-400', label: 'Requires Revision' };
      };
      const colors = getColor(score);
      const radius = size === 'lg' ? 40 : 24;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (score / 100) * circumference;
      
      return (
        <div className="relative flex items-center justify-center">
          <svg className={size === 'lg' ? 'w-24 h-24' : 'w-14 h-14'} viewBox="0 0 100 100">
            <circle cx="50" cy="50" r={radius} fill="none" stroke="#334155" strokeWidth="6" />
            <circle 
              cx="50" cy="50" r={radius} fill="none" 
              className={colors.ring}
              strokeWidth="6" 
              strokeLinecap="round"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              transform="rotate(-90 50 50)"
            />
          </svg>
          <div className="absolute flex flex-col items-center">
            <span className={`font-bold ${size === 'lg' ? 'text-xl' : 'text-sm'} ${colors.text}`}>{score}%</span>
          </div>
        </div>
      );
    };

    // ============================================================================
    // DEMO DATA FALLBACK
    // ============================================================================
    const DEMO_QUEUE = [
      { id: 'demo-1', section: 'Technical Approach', section_ref: 'L.4.1.3', content_type: 'Zero Trust Architecture', ai_output: 'Our Zero Trust implementation leverages FedRAMP High authorized infrastructure with continuous verification at every access point.', confidence_score: 92, evidence_coverage: 97, status: 'pending', agent_source: 'Proposal Writer', priority: 'high', created_at: new Date().toISOString() },
      { id: 'demo-2', section: 'Compliance Matrix', section_ref: 'M.3.2', content_type: 'NIST 800-171 Controls', ai_output: 'All 110 NIST 800-171 controls are mapped to our existing security framework. CUI handling procedures follow DFARS 7012 requirements.', confidence_score: 88, evidence_coverage: 95, status: 'pending', agent_source: 'Compliance Checker', priority: 'high', created_at: new Date().toISOString() },
      { id: 'demo-3', section: 'Win Theme', section_ref: 'Executive Summary', content_type: 'Cost Discriminator', ai_output: 'FedRAMP High Authorization eliminates $8.2M in government ATO costs and reduces time-to-deploy from 18 months to 90 days.', confidence_score: 85, evidence_coverage: 92, status: 'pending', agent_source: 'Strategy Coach', priority: 'critical', created_at: new Date().toISOString() },
      { id: 'demo-4', section: 'Ghost Statement', section_ref: 'L.4.2.1', content_type: 'Incumbent Weakness', ai_output: 'Legacy middleware architecture lacks modern API integration capabilities, requiring manual data synchronization.', confidence_score: 78, evidence_coverage: 85, status: 'pending', agent_source: 'Black Hat Reviewer', priority: 'normal', created_at: new Date().toISOString() },
      { id: 'demo-5', section: 'Technical Approach', section_ref: 'L.4.4.1', content_type: 'AI/ML Pipeline Design', ai_output: 'Predictive analytics pipeline utilizes DoD-approved models from the Joint AI Center catalog.', confidence_score: 61, evidence_coverage: 65, status: 'pending', agent_source: 'Proposal Writer', priority: 'critical', created_at: new Date().toISOString() },
    ];

    const DEMO_AUDIT = [
      { id: 1, action: 'approved', reviewer_name: 'M. Womack', created_at: new Date(Date.now() - 3600000).toISOString(), review_notes: 'Strong evidence chain' },
      { id: 2, action: 'revised', reviewer_name: 'K. Thompson', created_at: new Date(Date.now() - 7200000).toISOString(), review_notes: 'Updated citation format' },
      { id: 3, action: 'rejected', reviewer_name: 'M. Womack', created_at: new Date(Date.now() - 10800000).toISOString(), review_notes: 'Insufficient evidence coverage' },
    ];

    // ============================================================================
    // MAIN HITL QUEUE COMPONENT
    // ============================================================================
    const HITLQueue = () => {
      // State
      const [queue, setQueue] = useState([]);
      const [auditTrail, setAuditTrail] = useState([]);
      const [loading, setLoading] = useState(true);
      const [dbConnected, setDbConnected] = useState(false);
      const [selectedItems, setSelectedItems] = useState([]);
      const [filterType, setFilterType] = useState('all');
      const [filterConfidence, setFilterConfidence] = useState('all');
      const [filterStatus, setFilterStatus] = useState('pending');
      const [filterPriority, setFilterPriority] = useState('all');
      const [expandedItem, setExpandedItem] = useState(null);
      const [showAuditPanel, setShowAuditPanel] = useState(false);
      const [editMode, setEditMode] = useState(null);
      const [editContent, setEditContent] = useState('');
      const [reviewNotes, setReviewNotes] = useState('');
      const [currentUser, setCurrentUser] = useState({ name: 'M. Womack', role: 'CEO' });
      const [reviewStartTime, setReviewStartTime] = useState(null);

      // Load data from Supabase
      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        setLoading(true);
        try {
          // Load queue items
          const { data: queueData, error: queueError } = await supabase
            .from('hitl_queue')
            .select('*')
            .order('created_at', { ascending: false });

          if (queueError) throw queueError;

          // Load audit trail
          const { data: auditData, error: auditError } = await supabase
            .from('hitl_reviews')
            .select(`
              *,
              profiles:reviewer_id (full_name)
            `)
            .order('created_at', { ascending: false })
            .limit(50);

          if (auditError) throw auditError;

          setQueue(queueData || []);
          setAuditTrail((auditData || []).map(a => ({
            ...a,
            reviewer_name: a.profiles?.full_name || 'Unknown'
          })));
          setDbConnected(true);
        } catch (err) {
          console.warn('Supabase error, using demo data:', err);
          setQueue(DEMO_QUEUE);
          setAuditTrail(DEMO_AUDIT);
          setDbConnected(false);
        }
        setLoading(false);
      };

      // Get confidence color based on thresholds
      const getConfidenceColor = (confidence) => {
        if (confidence >= 85) return { bg: 'bg-emerald-500', text: 'text-emerald-400', label: 'Auto-Approvable' };
        if (confidence >= 70) return { bg: 'bg-amber-500', text: 'text-amber-400', label: 'Needs Review' };
        return { bg: 'bg-red-500', text: 'text-red-400', label: 'Requires Revision' };
      };

      // Type badge colors
      const getTypeBadge = (type) => {
        const types = {
          'Technical Approach': 'primary',
          'Compliance Matrix': 'success',
          'Win Theme': 'warning',
          'Ghost Statement': 'danger',
          'Pricing Narrative': 'purple',
          'Past Performance': 'default',
          'Risk Mitigation': 'warning',
          'Staffing Plan': 'primary',
          'Quality Assurance': 'success'
        };
        return types[type] || 'default';
      };

      // Priority badge
      const getPriorityBadge = (priority) => {
        const priorities = {
          'critical': { variant: 'danger', label: 'ðŸ”´ Critical' },
          'high': { variant: 'warning', label: 'ðŸŸ  High' },
          'normal': { variant: 'primary', label: 'ðŸ”µ Normal' },
          'low': { variant: 'default', label: 'âšª Low' }
        };
        return priorities[priority] || priorities.normal;
      };

      // Filter queue
      const filteredQueue = useMemo(() => {
        return queue.filter(item => {
          if (filterType !== 'all' && item.section !== filterType) return false;
          if (filterStatus !== 'all' && item.status !== filterStatus) return false;
          if (filterPriority !== 'all' && item.priority !== filterPriority) return false;
          if (filterConfidence !== 'all') {
            if (filterConfidence === 'green' && item.confidence_score < 85) return false;
            if (filterConfidence === 'amber' && (item.confidence_score < 70 || item.confidence_score >= 85)) return false;
            if (filterConfidence === 'red' && item.confidence_score >= 70) return false;
          }
          return true;
        });
      }, [queue, filterType, filterConfidence, filterStatus, filterPriority]);

      // Statistics
      const stats = useMemo(() => {
        const total = queue.length;
        const reviewed = queue.filter(i => i.status !== 'pending').length;
        const approved = queue.filter(i => i.status === 'approved').length;
        const revised = queue.filter(i => i.status === 'revised').length;
        const rejected = queue.filter(i => i.status === 'rejected').length;
        const pending = queue.filter(i => i.status === 'pending').length;
        const critical = queue.filter(i => i.priority === 'critical' && i.status === 'pending').length;
        const avgConfidence = queue.length > 0 ? Math.round(queue.reduce((sum, i) => sum + i.confidence_score, 0) / queue.length) : 0;
        return { total, reviewed, approved, revised, rejected, pending, critical, avgConfidence, progress: total > 0 ? Math.round((reviewed / total) * 100) : 0 };
      }, [queue]);

      // Unique types for filter
      const uniqueTypes = [...new Set(queue.map(i => i.section))];

      // Select all visible
      const selectAllVisible = () => {
        if (selectedItems.length === filteredQueue.filter(i => i.status === 'pending').length) {
          setSelectedItems([]);
        } else {
          setSelectedItems(filteredQueue.filter(i => i.status === 'pending').map(i => i.id));
        }
      };

      const isAllSelected = selectedItems.length > 0 && 
        selectedItems.length === filteredQueue.filter(i => i.status === 'pending').length;
      const isSomeSelected = selectedItems.length > 0 && !isAllSelected;

      // Handle review action
      const handleAction = async (id, action, revisedContent = null) => {
        const item = queue.find(i => i.id === id);
        const timeSpent = reviewStartTime ? Math.round((Date.now() - reviewStartTime) / 1000) : null;

        try {
          if (dbConnected) {
            // Update queue item
            await supabase
              .from('hitl_queue')
              .update({ status: action, updated_at: new Date().toISOString() })
              .eq('id', id);

            // Create audit record
            await supabase.from('hitl_reviews').insert({
              queue_item_id: id,
              action: action,
              original_content: item.ai_output,
              revised_content: revisedContent,
              review_notes: reviewNotes || null,
              time_spent_seconds: timeSpent
            });
          }

          // Update local state
          setQueue(prev => prev.map(i => i.id === id ? { ...i, status: action } : i));
          setAuditTrail(prev => [{
            id: Date.now(),
            queue_item_id: id,
            action,
            reviewer_name: currentUser.name,
            created_at: new Date().toISOString(),
            review_notes: reviewNotes || null
          }, ...prev]);

          setExpandedItem(null);
          setEditMode(null);
          setEditContent('');
          setReviewNotes('');
          setReviewStartTime(null);
        } catch (err) {
          console.error('Error saving review:', err);
        }
      };

      // Bulk actions
      const handleBulkAction = async (action) => {
        for (const id of selectedItems) {
          await handleAction(id, action);
        }
        setSelectedItems([]);
      };

      // Format timestamp
      const formatTime = (ts) => {
        const date = new Date(ts);
        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      };

      // Action colors
      const getActionColor = (action) => {
        const colors = { approved: 'text-emerald-400', rejected: 'text-red-400', revised: 'text-amber-400', escalated: 'text-purple-400' };
        return colors[action] || 'text-slate-400';
      };

      // ========================================================================
      // RENDER
      // ========================================================================
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 text-white p-6">
          {/* Header */}
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-4">
                <a href="index.html" className="p-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors">
                  <Icon name="arrowLeft" className="w-5 h-5 text-slate-400" />
                </a>
                <div>
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center">
                      <Icon name="clipboard" className="w-5 h-5 text-white" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold">HITL Review Queue</h1>
                      <p className="text-sm text-slate-400">Human-in-the-Loop AI Output Validation</p>
                    </div>
                  </div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <Badge variant={dbConnected ? 'success' : 'warning'} icon="database">
                  {dbConnected ? 'Live' : 'Demo Mode'}
                </Badge>
                <Button variant="ghost" size="sm" icon="refresh" onClick={loadData}>Refresh</Button>
                <Button 
                  variant={showAuditPanel ? 'primary' : 'secondary'} 
                  size="sm" 
                  icon="list"
                  onClick={() => setShowAuditPanel(!showAuditPanel)}
                >
                  Audit Trail
                </Button>
              </div>
            </div>

            {/* Stats Bar */}
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Total Items</div>
                <div className="text-2xl font-bold text-white">{stats.total}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Pending</div>
                <div className="text-2xl font-bold text-amber-400">{stats.pending}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">ðŸ”´ Critical</div>
                <div className="text-2xl font-bold text-red-400">{stats.critical}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Approved</div>
                <div className="text-2xl font-bold text-emerald-400">{stats.approved}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Revised</div>
                <div className="text-2xl font-bold text-amber-400">{stats.revised}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Rejected</div>
                <div className="text-2xl font-bold text-red-400">{stats.rejected}</div>
              </Card>
              <Card className="p-4">
                <div className="text-xs text-slate-400 mb-1">Avg Confidence</div>
                <div className="text-2xl font-bold text-cyan-400">{stats.avgConfidence}%</div>
              </Card>
            </div>

            {/* Progress Bar */}
            <Card className="p-4 mb-6">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium">Review Progress</span>
                <span className="text-sm text-cyan-400">{stats.progress}% Complete</span>
              </div>
              <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-cyan-500 to-teal-500 transition-all duration-500"
                  style={{ width: `${stats.progress}%` }}
                />
              </div>
            </Card>

            {/* Main Content */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Queue List */}
              <div className={showAuditPanel ? 'lg:col-span-2' : 'lg:col-span-3'}>
                {/* Filters */}
                <Card className="p-4 mb-4">
                  <div className="flex flex-wrap items-center gap-4">
                    <div className="flex items-center gap-2">
                      <Icon name="filter" className="w-4 h-4 text-slate-400" />
                      <span className="text-sm text-slate-400">Filters:</span>
                    </div>
                    
                    <select 
                      value={filterStatus} 
                      onChange={(e) => setFilterStatus(e.target.value)}
                      className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:border-cyan-500 outline-none"
                    >
                      <option value="all">All Status</option>
                      <option value="pending">Pending</option>
                      <option value="approved">Approved</option>
                      <option value="revised">Revised</option>
                      <option value="rejected">Rejected</option>
                    </select>

                    <select 
                      value={filterPriority} 
                      onChange={(e) => setFilterPriority(e.target.value)}
                      className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:border-cyan-500 outline-none"
                    >
                      <option value="all">All Priority</option>
                      <option value="critical">ðŸ”´ Critical</option>
                      <option value="high">ðŸŸ  High</option>
                      <option value="normal">ðŸ”µ Normal</option>
                      <option value="low">âšª Low</option>
                    </select>

                    <select 
                      value={filterConfidence} 
                      onChange={(e) => setFilterConfidence(e.target.value)}
                      className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:border-cyan-500 outline-none"
                    >
                      <option value="all">All Confidence</option>
                      <option value="green">ðŸŸ¢ â‰¥85% (Auto-Approve)</option>
                      <option value="amber">ðŸŸ¡ 70-84% (Review)</option>
                      <option value="red">ðŸ”´ &lt;70% (Revision)</option>
                    </select>

                    <select 
                      value={filterType} 
                      onChange={(e) => setFilterType(e.target.value)}
                      className="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm focus:border-cyan-500 outline-none"
                    >
                      <option value="all">All Sections</option>
                      {uniqueTypes.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>

                    <div className="flex-1" />
                    
                    <span className="text-sm text-slate-400">{filteredQueue.length} items</span>
                  </div>
                </Card>

                {/* Bulk Actions */}
                {selectedItems.length > 0 && (
                  <Card className="p-4 mb-4 border-cyan-500/30 bg-cyan-500/5">
                    <div className="flex items-center justify-between">
                      <span className="text-sm">{selectedItems.length} items selected</span>
                      <div className="flex gap-2">
                        <Button variant="success" size="sm" icon="check" onClick={() => handleBulkAction('approved')}>
                          Approve All
                        </Button>
                        <Button variant="warning" size="sm" icon="pencil" onClick={() => handleBulkAction('revised')}>
                          Mark for Revision
                        </Button>
                        <Button variant="danger" size="sm" icon="x" onClick={() => handleBulkAction('rejected')}>
                          Reject All
                        </Button>
                        <Button variant="ghost" size="sm" onClick={() => setSelectedItems([])}>
                          Clear
                        </Button>
                      </div>
                    </div>
                  </Card>
                )}

                {/* Queue Items */}
                {loading ? (
                  <Card className="p-8 text-center">
                    <div className="animate-spin w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full mx-auto mb-4" />
                    <p className="text-slate-400">Loading queue items...</p>
                  </Card>
                ) : filteredQueue.length === 0 ? (
                  <Card className="p-8 text-center">
                    <Icon name="clipboard" className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                    <p className="text-slate-400">No items match current filters</p>
                  </Card>
                ) : (
                  <div className="space-y-3">
                    {/* Select All Header */}
                    <div className="flex items-center gap-3 px-4 py-2">
                      <Checkbox 
                        checked={isAllSelected} 
                        indeterminate={isSomeSelected}
                        onChange={selectAllVisible} 
                      />
                      <span className="text-sm text-slate-400">Select all pending</span>
                    </div>

                    {filteredQueue.map((item) => {
                      const confColor = getConfidenceColor(item.confidence_score);
                      const isExpanded = expandedItem === item.id;
                      const priorityBadge = getPriorityBadge(item.priority);

                      return (
                        <Card 
                          key={item.id} 
                          className={`overflow-hidden transition-all ${isExpanded ? 'ring-2 ring-cyan-500/50' : ''}`}
                        >
                          {/* Item Header */}
                          <div 
                            className="p-4 cursor-pointer hover:bg-slate-800/50"
                            onClick={() => {
                              setExpandedItem(isExpanded ? null : item.id);
                              if (!isExpanded) setReviewStartTime(Date.now());
                            }}
                          >
                            <div className="flex items-start gap-4">
                              {item.status === 'pending' && (
                                <div onClick={(e) => e.stopPropagation()}>
                                  <Checkbox 
                                    checked={selectedItems.includes(item.id)} 
                                    onChange={(checked) => {
                                      setSelectedItems(prev => 
                                        checked ? [...prev, item.id] : prev.filter(id => id !== item.id)
                                      );
                                    }} 
                                  />
                                </div>
                              )}
                              
                              <ConfidenceGauge score={item.confidence_score} />
                              
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                  <Badge variant={getTypeBadge(item.section)}>{item.section}</Badge>
                                  <Badge variant={priorityBadge.variant} size="xs">{priorityBadge.label}</Badge>
                                  {item.status !== 'pending' && (
                                    <Badge variant={item.status === 'approved' ? 'success' : item.status === 'rejected' ? 'danger' : 'warning'}>
                                      {item.status}
                                    </Badge>
                                  )}
                                </div>
                                <p className="text-sm text-white font-medium mb-1">{item.content_type}</p>
                                <p className="text-sm text-slate-400 line-clamp-2">{item.ai_output}</p>
                                <div className="flex items-center gap-4 mt-2 text-xs text-slate-500">
                                  <span className="flex items-center gap-1">
                                    <Icon name="cpu" className="w-3 h-3" />
                                    {item.agent_source}
                                  </span>
                                  <span className="flex items-center gap-1">
                                    <Icon name="fileText" className="w-3 h-3" />
                                    {item.section_ref}
                                  </span>
                                  <span className="flex items-center gap-1">
                                    <Icon name="activity" className="w-3 h-3" />
                                    Evidence: {item.evidence_coverage}%
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Expanded Detail */}
                          {isExpanded && (
                            <div className="border-t border-slate-700 p-4 bg-slate-900/50 animate-fade-in">
                              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {/* AI Output */}
                                <div>
                                  <h4 className="text-sm font-medium text-slate-300 mb-2">AI Generated Content</h4>
                                  {editMode === item.id ? (
                                    <textarea
                                      value={editContent}
                                      onChange={(e) => setEditContent(e.target.value)}
                                      className="w-full h-40 bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm text-white focus:border-cyan-500 outline-none resize-none"
                                    />
                                  ) : (
                                    <div className="bg-slate-800 rounded-lg p-3 text-sm text-slate-300">
                                      {item.ai_output}
                                    </div>
                                  )}
                                </div>

                                {/* Metrics & Actions */}
                                <div>
                                  <h4 className="text-sm font-medium text-slate-300 mb-2">Quality Metrics</h4>
                                  <div className="grid grid-cols-2 gap-3 mb-4">
                                    <div className="bg-slate-800 rounded-lg p-3">
                                      <div className="text-xs text-slate-400">Confidence</div>
                                      <div className={`text-xl font-bold ${confColor.text}`}>{item.confidence_score}%</div>
                                      <div className="text-xs text-slate-500">{confColor.label}</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-lg p-3">
                                      <div className="text-xs text-slate-400">Evidence Coverage</div>
                                      <div className="text-xl font-bold text-cyan-400">{item.evidence_coverage}%</div>
                                      <div className="text-xs text-slate-500">{item.evidence_coverage >= 95 ? 'Complete' : 'Partial'}</div>
                                    </div>
                                  </div>

                                  <h4 className="text-sm font-medium text-slate-300 mb-2">Review Notes (Optional)</h4>
                                  <textarea
                                    value={reviewNotes}
                                    onChange={(e) => setReviewNotes(e.target.value)}
                                    placeholder="Add notes for the audit trail..."
                                    className="w-full h-20 bg-slate-800 border border-slate-600 rounded-lg p-3 text-sm text-white focus:border-cyan-500 outline-none resize-none mb-4"
                                  />

                                  {/* Action Buttons */}
                                  {item.status === 'pending' && (
                                    <div className="flex flex-wrap gap-2">
                                      {editMode === item.id ? (
                                        <>
                                          <Button 
                                            variant="success" 
                                            size="sm" 
                                            icon="save"
                                            onClick={() => handleAction(item.id, 'revised', editContent)}
                                          >
                                            Save Revision
                                          </Button>
                                          <Button 
                                            variant="ghost" 
                                            size="sm"
                                            onClick={() => {
                                              setEditMode(null);
                                              setEditContent('');
                                            }}
                                          >
                                            Cancel
                                          </Button>
                                        </>
                                      ) : (
                                        <>
                                          <Button 
                                            variant="success" 
                                            size="sm" 
                                            icon="check"
                                            onClick={() => handleAction(item.id, 'approved')}
                                          >
                                            Approve
                                          </Button>
                                          <Button 
                                            variant="warning" 
                                            size="sm" 
                                            icon="pencil"
                                            onClick={() => {
                                              setEditMode(item.id);
                                              setEditContent(item.ai_output);
                                            }}
                                          >
                                            Edit & Revise
                                          </Button>
                                          <Button 
                                            variant="danger" 
                                            size="sm" 
                                            icon="x"
                                            onClick={() => handleAction(item.id, 'rejected')}
                                          >
                                            Reject
                                          </Button>
                                          <Button 
                                            variant="ghost" 
                                            size="sm" 
                                            icon="arrowUp"
                                            onClick={() => handleAction(item.id, 'escalated')}
                                          >
                                            Escalate
                                          </Button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          )}
                        </Card>
                      );
                    })}
                  </div>
                )}
              </div>

              {/* Audit Trail Panel */}
              {showAuditPanel && (
                <div className="lg:col-span-1">
                  <Card className="p-4 sticky top-6">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="font-semibold flex items-center gap-2">
                        <Icon name="list" className="w-4 h-4 text-cyan-400" />
                        Audit Trail
                      </h3>
                      <Badge variant="primary">{auditTrail.length} records</Badge>
                    </div>
                    
                    <div className="space-y-3 max-h-[600px] overflow-y-auto">
                      {auditTrail.map((entry, idx) => (
                        <div 
                          key={entry.id || idx}
                          className="p-3 bg-slate-800/50 rounded-lg border border-slate-700/50 animate-slide-in"
                          style={{ animationDelay: `${idx * 50}ms` }}
                        >
                          <div className="flex items-center justify-between mb-1">
                            <span className={`text-sm font-medium capitalize ${getActionColor(entry.action)}`}>
                              {entry.action}
                            </span>
                            <span className="text-xs text-slate-500">{formatTime(entry.created_at)}</span>
                          </div>
                          <div className="text-xs text-slate-400">
                            by {entry.reviewer_name}
                          </div>
                          {entry.review_notes && (
                            <div className="text-xs text-slate-500 mt-1 italic">
                              "{entry.review_notes}"
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </Card>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="mt-8 text-center text-xs text-slate-500">
              AI GENERATED CONTENT - REQUIRES HUMAN REVIEW | MissionPulse v12 | HITL Queue Sprint 19
            </div>
          </div>
        </div>
      );
    };

    // Render
    ReactDOM.render(<HITLQueue />, document.getElementById('root'));
  </script>
</body>
</html>
