<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MissionPulse ‚Äî Admin: Access Requests</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:#00050F;min-height:100vh}@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}.fade-in{animation:fadeIn .4s ease-out forwards}</style>
  <script src="rbac-guard.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const SB_URL='https://djuviwarqdvlbgcfuupa.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqdXZpd2FycWR2bGJnY2Z1dXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MzUyMjQsImV4cCI6MjA1MzQxMTIyNH0.pBPL9l2zL7LLd_A5I--hPBzw5YwG3ajPMtbYsqsxIgQ';
var sbClient=null;let connected=false;
try{sbClient=supabase.createClient(SB_URL,SB_KEY);connected=true}catch(e){}

const ALLOWED=['CEO','COO','Admin'];
const DEMO_REQUESTS=[
  {id:'1',email:'mike.chen@company.com',full_name:'Mike Chen',organization:'TechForce LLC',requested_role:'SA',justification:'Solution architect for DHA EHR opportunity',status:'pending',created_at:'2026-02-17T10:00:00Z'},
  {id:'2',email:'sarah.j@govwin.com',full_name:'Sarah Johnson',organization:'GovWin Partners',requested_role:'Partner',justification:'Teaming partner for VA EHRM bridge',status:'pending',created_at:'2026-02-16T14:30:00Z'},
  {id:'3',email:'tom.garcia@mmt.com',full_name:'Tom Garcia',organization:'Mission Meets Tech',requested_role:'QA',justification:'Assigned QA for Q2 proposals',status:'approved',created_at:'2026-02-14T09:00:00Z',reviewed_at:'2026-02-14T11:00:00Z'},
  {id:'4',email:'lisa.brown@ext.com',full_name:'Lisa Brown',organization:'External Corp',requested_role:'FIN',justification:'Need pricing access',status:'denied',created_at:'2026-02-13T16:00:00Z',reviewed_at:'2026-02-13T17:00:00Z',deny_reason:'No NDA on file'},
  {id:'5',email:'james.w@mmt.com',full_name:'James Wilson',organization:'Mission Meets Tech',requested_role:'CAP',justification:'Lead capture for CMS opportunity',status:'pending',created_at:'2026-02-18T08:00:00Z'},
];

const ROLES=['CEO','COO','Admin','CAP','PM','SA','FIN','CON','DEL','QA','Partner'];

function App(){
  const user=JSON.parse(localStorage.getItem('mp_user')||'{"role":"CEO"}');
  const authorized=ALLOWED.includes(user.role);
  const[requests,setRequests]=React.useState(DEMO_REQUESTS);
  const[filter,setFilter]=React.useState('pending');
  const[expanded,setExpanded]=React.useState(null);
  const[toast,setToast]=React.useState('');

  React.useEffect(()=>{
    if(!authorized)return;
    if(connected){
      sbClient.from('user_profiles').select('*').order('created_at',{ascending:false}).then(({data})=>{if(data?.length)setRequests(data)});
    }
  },[]);

  if(!authorized)return(
    <div className="min-h-screen flex items-center justify-center"><div className="text-center"><div className="text-5xl mb-4">üîí</div><h1 className="text-xl font-bold text-white mb-2">Access Restricted</h1><p className="text-gray-500 text-sm">CEO, COO, or Admin role required.</p><a href="index.html" className="inline-block mt-4 text-cyan-400 text-sm hover:underline">‚Üê Dashboard</a></div></div>
  );

  const filtered=filter==='all'?requests:requests.filter(r=>r.status===filter);
  const counts={pending:requests.filter(r=>r.status==='pending').length,approved:requests.filter(r=>r.status==='approved').length,denied:requests.filter(r=>r.status==='denied').length};

  const handleAction=async(id,action,roleOverride,reason)=>{
    const updated=requests.map(r=>{
      if(r.id===id)return{...r,status:action,role:action==='approved'?(roleOverride||r.requested_role):r.role,reviewed_at:new Date().toISOString(),reviewed_by:user.email,deny_reason:reason||null};
      return r;
    });
    setRequests(updated);
    if(connected){
      const upd={status:action,reviewed_at:new Date().toISOString(),reviewed_by:user.email};
      if(action==='approved')upd.role=roleOverride||requests.find(r=>r.id===id)?.requested_role;
      if(reason)upd.deny_reason=reason;
      await sbClient.from('user_profiles').update(upd).eq('id',id);
    }
    setToast(`Request ${action}`);setTimeout(()=>setToast(''),2500);
  };

  const statusColor={pending:'text-amber-400 bg-amber-500/10',approved:'text-green-400 bg-green-500/10',denied:'text-red-400 bg-red-500/10'};

  return(
    <div className="min-h-screen p-6 max-w-5xl mx-auto">
      <div className="flex items-center justify-between mb-8">
        <div><a href="index.html" className="text-cyan-400 text-xs hover:underline mb-2 inline-block">‚Üê Dashboard</a><h1 className="text-2xl font-extrabold text-white">Access Requests</h1><p className="text-sm text-gray-500">Manage user registration and role assignments</p></div>
        <span className={`px-3 py-1 rounded-full text-xs font-mono font-semibold ${connected?'bg-green-500/10 text-green-400':'bg-red-500/10 text-red-400'}`}>{connected?'LIVE':'DEMO'}</span>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        {[['Pending',counts.pending,'amber'],['Approved',counts.approved,'green'],['Denied',counts.denied,'red']].map(([l,c,col])=>(
          <div key={l} className="bg-[#0a1628] border border-gray-800 rounded-lg p-4 text-center">
            <div className={`text-2xl font-extrabold text-${col}-400`}>{c}</div>
            <div className="text-xs text-gray-500 mt-1">{l}</div>
          </div>
        ))}
      </div>

      {/* Filters */}
      <div className="flex gap-2 mb-6">
        {['pending','approved','denied','all'].map(f=>(
          <button key={f} onClick={()=>setFilter(f)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold capitalize transition ${filter===f?'bg-cyan-500/15 text-cyan-400 border border-cyan-500/30':'bg-[#0a1628] text-gray-500 border border-gray-800 hover:border-gray-600'}`}>{f} {f!=='all'&&<span className="ml-1 opacity-60">({f==='pending'?counts.pending:f==='approved'?counts.approved:counts.denied})</span>}</button>
        ))}
      </div>

      {/* Request cards */}
      <div className="space-y-3">
        {filtered.map(req=>(
          <div key={req.id} className="bg-[#0a1628] border border-gray-800 rounded-xl overflow-hidden fade-in">
            <div className="flex items-center justify-between px-5 py-4 cursor-pointer hover:bg-gray-800/20" onClick={()=>setExpanded(expanded===req.id?null:req.id)}>
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 rounded-full bg-cyan-500/10 flex items-center justify-center text-sm font-bold text-cyan-400">{req.full_name?.[0]||'?'}</div>
                <div><div className="text-white font-semibold text-sm">{req.full_name||req.email}</div><div className="text-xs text-gray-500">{req.email} ¬∑ {req.organization}</div></div>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-xs font-mono text-purple-400 bg-purple-500/10 px-2 py-0.5 rounded">{req.requested_role}</span>
                <span className={`text-xs font-semibold px-2 py-0.5 rounded capitalize ${statusColor[req.status]}`}>{req.status}</span>
                <span className="text-gray-600">{expanded===req.id?'‚ñ≤':'‚ñº'}</span>
              </div>
            </div>
            {expanded===req.id&&(
              <div className="px-5 pb-4 border-t border-gray-800 pt-3 fade-in">
                <div className="grid grid-cols-2 gap-4 text-xs mb-4">
                  <div><span className="text-gray-500">Requested:</span> <span className="text-gray-300">{new Date(req.created_at).toLocaleDateString()}</span></div>
                  {req.reviewed_at&&<div><span className="text-gray-500">Reviewed:</span> <span className="text-gray-300">{new Date(req.reviewed_at).toLocaleDateString()}</span></div>}
                  {req.justification&&<div className="col-span-2"><span className="text-gray-500">Justification:</span> <span className="text-gray-300">{req.justification}</span></div>}
                  {req.deny_reason&&<div className="col-span-2"><span className="text-gray-500">Deny reason:</span> <span className="text-red-400">{req.deny_reason}</span></div>}
                </div>
                {req.status==='pending'&&(
                  <div className="flex gap-2 items-center">
                    <select defaultValue={req.requested_role} id={`role-${req.id}`} className="bg-[#00050F] border border-gray-700 rounded-lg px-2 py-1.5 text-xs text-white">
                      {ROLES.map(r=><option key={r} value={r}>{r}</option>)}
                    </select>
                    <button onClick={()=>handleAction(req.id,'approved',document.getElementById(`role-${req.id}`).value)} className="px-4 py-1.5 bg-green-500/15 text-green-400 rounded-lg text-xs font-semibold hover:bg-green-500/25">‚úì Approve</button>
                    <button onClick={()=>{const r=prompt('Denial reason:');if(r)handleAction(req.id,'denied',null,r)}} className="px-4 py-1.5 bg-red-500/15 text-red-400 rounded-lg text-xs font-semibold hover:bg-red-500/25">‚úï Deny</button>
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
        {filtered.length===0&&<div className="text-center py-12 text-gray-600">No {filter} requests</div>}
      </div>

      {/* Toast */}
      {toast&&<div className="fixed bottom-6 right-6 bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 px-4 py-2 rounded-lg text-sm font-semibold fade-in">{toast}</div>}

      <p className="text-center text-[10px] text-gray-600 mt-8 font-mono">‚ö†Ô∏è AI GENERATED ‚Äî REQUIRES HUMAN REVIEW | MissionPulse v12.0 ‚Äî Mission Meets Tech</p>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
